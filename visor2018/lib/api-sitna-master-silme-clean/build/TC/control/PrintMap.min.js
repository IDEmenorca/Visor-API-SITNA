TC.control=TC.control||{};TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control");TC.control.PrintMap=function(){TC.Control.apply(this,arguments)};TC.inherit(TC.control.PrintMap,TC.Control);!function(){var t=TC.control.PrintMap.prototype;t.CLASS="tc-ctl-printMap";t.template={};TC.isDebug?t.template[t.CLASS]=TC.apiLocation+"TC/templates/PrintMap.html":t.template[t.CLASS]=function(){dust.register(t.CLASS,i);function i(t,i){return t.w("<h2>").h("i18n",i,{},{$key:"print"}).w('</h2><div><div class="tc-ctl-printMap-div"><div class="tc-group tc-ctl-printMap-cnt"><label>').h("i18n",i,{},{$key:"title"}).w(':</label><input type="text" class="tc-ctl-printMap-title tc-textbox" maxlength="30" placeholder="').h("i18n",i,{},{$key:"mapTitle"}).w('" /></div><div class="tc-group tc-ctl-printMap-cnt"><label>').h("i18n",i,{},{$key:"layout"}).w(':</label><select id="print-design" class="tc-combo"><option value="landscape">').h("i18n",i,{},{$key:"landscape"}).w('</option><option value="portrait">').h("i18n",i,{},{$key:"portrait"}).w('</option></select></div><div class="tc-group tc-ctl-printMap-cnt"><label>').h("i18n",i,{},{$key:"size"}).w(':</label><select id="print-size" class="tc-combo"><option value="a4">A4</option><option value="a3">A3</option></select></div><div class="tc-group tc-ctl-printMap-cnt"><button class="tc-ctl-printMap-btn tc-button tc-icon-button" title="').h("i18n",i,{},{$key:"printMap"}).w('">').h("i18n",i,{},{$key:"print"}).w("</button></div></div></div>")}i.__dustBody=!0;return i};t.register=function(t){var i=this;TC.Control.prototype.register.call(i,t);i._$div.on("click",".tc-ctl-printMap-btn",function(){var n,e="?";$.isEmptyObject(TC.Util.getQueryStringParams(window.location.href))||(e="&");e+="layout=layout/print&orientation="+$("#print-design").val()+"&title="+$("input.tc-ctl-printMap-title").val()+"&size="+$("#print-size").val();n=window.location.hash?window.location.href.replace(window.location.hash,e+window.location.hash):window.location.href+e;i.printWindow&&void 0!==i.printWindow&&i.printWindow.close();TC.printPreview={};TC.printPreview.refererMap=t;for(var o,r=[],a=0;a<t.workLayers.length;a++)if(((o=t.workLayers[a]).type===TC.Consts.layerType.VECTOR||o.type===TC.Consts.layerType.WFS)&&o.getVisibility()&&o.features.length>0)for(var l=o.features,p=0;p<l.length;p++){var c=l[p],s={};if(!(TC.feature.Marker&&c instanceof TC.feature.Marker&&c.options.noPrint)){if(c.layer.styles){var y=void 0==c.layer.styles[c.STYLETYPE]?c.layer.styles["polyline"===c.STYLETYPE?"line":c.STYLETYPE]:c.layer.styles["multipolygon"===c.STYLETYPE?"polygon":c.STYLETYPE];for(var d in y)s[d]="function"==typeof y[d]?y[d](c):y[d]}var u=function(t){return t>1?"pixels":"fraction"},h=c.getStyle(),C=$.isEmptyObject(h)?c.options:h;if(C.anchor&&$.isArray(C.anchor))var T={anchorXUnits:u(C.anchor[0]),anchorYUnits:u(C.anchor[1])};r.push({geometry:c.geometry,CLASSNAME:c.CLASSNAME,options:$.extend({},s,C,T,{layer:null})})}}TC.printPreview.mapFeatures=r;i.printWindow=window.open(n,"print");i.printWindow.onbeforeunload=function(){delete this.printWindow}.bind(this)})}}();