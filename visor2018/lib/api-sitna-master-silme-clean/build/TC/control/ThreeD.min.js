TC.control=TC.control||{};TC.control.MapContents||TC.syncLoadJS(TC.apiLocation+"TC/Control");!function(){for(var e=0,t=["ms","moz","webkit","o"],i=!(!window.performance||!window.performance.now),a=0,r=t.length;a<r&&!window.requestAnimationFrame;a+=1){window.requestAnimationFrame=window[t[a]+"RequestAnimationFrame"];window.cancelAnimationFrame=window[t[a]+"CancelAnimationFrame"]||window[t[a]+"CancelRequestAnimationFrame"]}window.requestAnimationFrame||(window.requestAnimationFrame=function(t,i){var a=(new Date).getTime(),r=Math.max(0,16-(a-e)),o=window.setTimeout(function(){t(a+r)},r);e=a+r;return o});window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)});if(!i){var o=window.requestAnimationFrame,n=+new Date;window.requestAnimationFrame=function(e,t){o(function(t){return e(t<1e12?t:t-n)},t)}}}();!function(){TC.Consts.classes.THREED=TC.Consts.classes.THREED||"tc-threed";TC.Consts.classes.THREED_HIDDEN=TC.Consts.classes.THREED_HIDDEN||"tc-threed-hidden";TC.Consts.event.TERRAINLOADED=TC.Consts.event.TERRAINLOADED||"terrainloaded.tc.threed";TC.Consts.event.TERRAINRECEIVING=TC.Consts.event.TERRAINRECEIVING||"terrainreceiving.tc.threed";TC.Consts.event.TERRAIN404=TC.Consts.event.TERRAIN404||"terrain404.tc.threed";TC.control.ThreeD=function(){TC.Control.apply(this,arguments);this.$events=$(this);this._manageResultsPanel={};this.selectors={divThreedMap:this.options.divMap};this.Consts={BLANK_BASE:"blank",DEFAULT_TILE_SIZE:256,TERRAIN_URL:"https://pmpwvinet18.tcsa.local/customcesiumterrain/qm"};this.options.terrainURL&&(this.Consts.TERRAIN_URL=this.options.terrainURL);this.options.isDebug&&(TC.Consts.url.CESIUM=TC.apiLocation+"lib/cesium/debug/Cesium.js")};TC.inherit(TC.control.ThreeD,TC.Control);var e=TC.control.ThreeD.prototype;e.CLASS="tc-ctl-threed";e.classes={MAPTHREED:"tc-map-threed",LOADING:"tc-loading",BTNACTIVE:"active",CAMERACTRARROWDISABLED:"disabled-arrow",BETA:"tc-beta-button",FOCUS:"focus",HIGHLIGHTED:"highlighted",DISABLED:"disabled",OUTFOCUS:"outfocus",COORDSTHREEDMARKER:"tc-ctl-coords-threed"};e.direction={TO_TWO_D:"two_d",TO_THREE_D:"three_d"};e.allowedControls=["search","attribution","basemapSelector","workLayerManager","tabContainer","externalWMS","fileImport","layerCatalog","click","fullScreen","loadingIndicator","navBar","overviewMap","legend","fullScreen","threeD","coordinates","geolocation","resultsPanel","share"];e.template={};if(TC.isDebug){e.template[e.CLASS]=TC.apiLocation+"TC/templates/ThreeD.html";e.template[e.CLASS+"-overlay"]=TC.apiLocation+"TC/templates/ThreeDOverlay.html";e.template[e.CLASS+"-cm-ctls"]=TC.apiLocation+"TC/templates/ThreeDCameraControls.html"}else{e.template[e.CLASS+"-cm-ctls"]=function(){dust.register(e.CLASS+"-cm-ctls",t);function t(e,t){return e.w('<div><svg xmlns:dc="http://purl.org/dc/elements/1.1/"xmlns:cc="http://creativecommons.org/ns#"xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"xmlns:svg="http://www.w3.org/2000/svg"xmlns="http://www.w3.org/2000/svg"xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd"xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"width="220"height="135"viewBox="0 0 63.40233 35.531682"version="1.1"id="threedControls"><g inkscape:groupmode="layer"id="backgroundLayer"inkscape:label="backgroundLayer"transform="translate(-2.3693123,-42.387899)"><path style="fill:#ffffff;fill-opacity:0.23999999;stroke:none;stroke-width:0.2;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:4;stroke-dasharray:none;stroke-dashoffset:0;stroke-opacity:0.3169643;paint-order:stroke fill markers"d="M 48.005285,42.387899 A 17.766048,17.766048 0 0 0 34.067635,49.16888 17.754217,17.754217 0 0 0 20.123267,42.399784 17.754217,17.754217 0 0 0 2.3693123,60.153739 a 17.754217,17.754217 0 0 0 17.7539547,17.75447 17.754217,17.754217 0 0 0 13.923699,-6.76961 17.766048,17.766048 0 0 0 13.958319,6.78098 17.766048,17.766048 0 0 0 17.766357,-17.76584 17.766048,17.766048 0 0 0 -17.766357,-17.76584 z"id="background"inkscape:connector-curvature="0" /></g><g inkscape:label="tiltLayer"inkscape:groupmode="layer"id="tiltLayer"transform="translate(-26.69084,-42.254264)"style="display:inline"><g class="tc-ctl-threed-cm-tilt-indicator"><path class="tc-ctl-threed-cm-tilt-inner"id="tiltInner"d="m 44.44423,52.861576 c 3.959106,0 7.167321,3.203889 7.167321,7.168124 0,3.964234 -3.208215,7.174892 -7.167321,7.174892 -3.959106,0 -7.160559,-3.210658 -7.160559,-7.174892 0,-3.964235 3.201453,-7.168124 7.160559,-7.168124 z"inkscape:connector-curvature="0"><title>').h("i18n",t,{},{$key:"threed.tilt.reset"}).w('</title></path><path class="tc-ctl-threed-cm-tilt-inner-image"d="m 40.116095,64.124648 c -0.12075,-0.119221 -0.171366,-0.928328 -0.171366,-2.739326 0,-2.143319 0.03709,-2.606753 0.223349,-2.79065 0.19727,-0.194769 0.269957,-0.196719 0.622509,-0.01671 0.219537,0.112088 0.761654,0.542242 1.204705,0.955894 l 0.805547,0.752098 v 0.939855 c 0,0.51692 -0.06955,1.085596 -0.154558,1.263727 -0.173436,0.363428 -1.919571,1.804317 -2.186551,1.804317 -0.09475,0 -0.249383,-0.07614 -0.343635,-0.169192 z m 3.287741,-0.05029 c -0.307698,-0.212789 -0.317387,-0.295835 -0.317387,-2.721198 0,-1.757783 0.05096,-2.552024 0.171366,-2.670904 0.120776,-0.119243 0.941399,-0.169194 2.779684,-0.169194 2.432612,0 2.618273,0.01838 2.756146,0.27272 0.08484,0.156511 0.147831,1.267987 0.147831,2.608402 0,3.088986 0.189068,2.899662 -2.895738,2.899662 -1.872744,0 -2.3862,-0.04266 -2.641902,-0.219488 z m 0.586357,-6.180807 c -0.314529,-0.267117 -0.397432,-0.458143 -0.397432,-0.915756 0,-0.785501 0.427643,-1.207722 1.223233,-1.207722 1.162181,0 1.675866,1.23538 0.851939,2.048861 -0.522115,0.515494 -1.126934,0.542392 -1.67774,0.07462 z m 2.780604,-0.09201 c -0.374474,-0.369724 -0.423284,-0.501051 -0.3506,-0.943285 0.118405,-0.72038 0.53618,-1.088187 1.236028,-1.088187 0.699848,0 1.117624,0.367807 1.236028,1.088187 0.07269,0.442234 0.02388,0.573561 -0.3506,0.943285 -0.300932,0.297119 -0.573881,0.429526 -0.885428,0.429526 -0.311544,0 -0.584496,-0.132407 -0.885428,-0.429526 z"id="tiltImage"inkscape:connector-curvature="0"><title>').h("i18n",t,{},{$key:"threed.tilt.reset"}).w('</title></path><path class="tc-ctl-threed-cm-tilt-outer tc-ctl-threed-cm-tilt-outer-circle"id="tiltOuter"d="m 44.44423,48.705554 c -6.246102,0 -11.312196,5.070128 -11.312196,11.324146 0,6.254017 5.066094,11.330914 11.312196,11.330914 6.246102,0 11.312196,-5.076897 11.312196,-11.330914 0,-6.254018 -5.066094,-11.324146 -11.312196,-11.324146 z m 0,4.156022 c 3.959106,0 7.167321,3.203889 7.167321,7.168124 0,3.964234 -3.208215,7.174892 -7.167321,7.174892 -3.959106,0 -7.160559,-3.210658 -7.160559,-7.174892 0,-3.964235 3.201453,-7.168124 7.160559,-7.168124 z"inkscape:connector-curvature="0"><title>').h("i18n",t,{},{$key:"threed.tilt.drag"}).w('</title></path><path class="tc-ctl-threed-cm-tilt-outer tc-ctl-threed-cm-tilt-outer-shell-circle"sodipodi:nodetypes="ssssssccccsccccssccsssccscccccccsccssscsssssccccccccccccccc"inkscape:connector-curvature="0"id="tiltShell"d="m 44.44423,48.705554 c -6.246102,0 -11.312196,5.070128 -11.312196,11.324146 0,6.254017 5.066094,11.330914 11.312196,11.330914 6.246102,0 11.312196,-5.076897 11.312196,-11.330914 0,-6.254018 -5.066094,-11.324146 -11.312196,-11.324146 z m 0,0.379051 c 2.995132,0 5.705501,1.203885 7.681205,3.154245 l -2.386853,2.382605 0.135232,0.135376 2.386853,-2.382606 c 1.930016,1.972963 3.12387,4.674054 3.12387,7.655475 0,2.981421 -1.193854,5.680844 -3.12387,7.655474 l -2.386853,-2.382605 -0.135232,0.135375 2.386853,2.382606 c -1.975664,1.951759 -4.686314,3.161013 -7.681205,3.161013 -1.94179,0 -3.766282,-0.506879 -5.347316,-1.395323 -0.850442,-0.477894 -1.630441,-1.06619 -2.320365,-1.745384 l 2.407138,-2.402912 c 1.358381,1.325983 3.214811,2.145699 5.260543,2.145699 4.163407,0 7.545972,-3.385283 7.545972,-7.553943 0,-4.168661 -3.382565,-7.547175 -7.545972,-7.547175 -2.045732,0 -3.902162,0.81461 -5.260543,2.13893 l -2.407138,-2.402912 c 1.972594,-1.940536 4.681097,-3.133938 7.667681,-3.133938 z m -0.189325,0.182756 v 3.01887 h 0.378651 v -3.01887 z m -7.606826,3.086558 2.400376,2.402912 C 37.721509,56.11715 36.90502,57.97796 36.90502,60.0297 c 0,2.05174 0.816489,3.910884 2.143435,5.272869 l -2.400376,2.402912 c -0.435151,-0.44326 -0.832923,-0.923297 -1.188195,-1.435068 -0.462681,-0.666492 -0.853281,-1.386809 -1.160484,-2.149815 -0.508689,-1.263436 -0.788715,-2.64392 -0.788715,-4.090898 0,-2.99182 1.197141,-5.70104 3.137394,-7.675781 z m 7.796151,0.507657 c 3.959106,0 7.167321,3.203889 7.167321,7.168124 0,3.964234 -3.208215,7.174892 -7.167321,7.174892 -3.959106,0 -7.160559,-3.210658 -7.160559,-7.174892 0,-3.964235 3.201453,-7.168124 7.160559,-7.168124 z m -10.744219,6.978598 v 0.379051 h 3.022445 v -0.379051 z m 18.513325,0 v 0.379051 h 3.029207 v -0.379051 z m -7.931385,7.932994 v 3.01887 h 0.37189 v -3.01887 z"><title>').h("i18n",t,{},{$key:"threed.tilt.drag"}).w('</title></path></g></g><g id="rotateLayer"inkscape:groupmode="layer"inkscape:label="rotateLayer"style="display:inline"transform="translate(-2.3693123,-42.387899)"><path class="tc-ctl-threed-cm-rotate-right"sodipodi:nodetypes="cccccccc"inkscape:connector-curvature="0"id="right"d="m 53.241331,72.907368 0.900176,1.930847 c 3.602027,-1.827343 6.291427,-4.493353 8.092762,-8.066897 l 0.969844,0.452626 -0.663464,-4.788009 -3.222445,2.974451 0.983506,0.459005 c -1.447339,3.107391 -3.949649,5.598011 -7.060379,7.037977 z"><title>').h("i18n",t,{},{$key:"threed.rotate.right"}).w('</title></path><path class="tc-ctl-threed-cm-rotate-left"sodipodi:nodetypes="cccccccc"inkscape:connector-curvature="0"id="left"d="m 42.795431,72.906221 -0.900176,1.930846 c -3.602027,-1.827342 -6.291427,-4.493352 -8.092762,-8.066896 l -0.969844,0.452626 0.663465,-4.788009 3.222444,2.974451 -0.983506,0.459005 c 1.44734,3.107391 3.949649,5.598011 7.060379,7.037977 z"><title>').h("i18n",t,{},{$key:"threed.rotate.left"}).w('</title></path><path class="tc-ctl-threed-cm-tilt-up"sodipodi:nodetypes="cccccccc"inkscape:connector-curvature="0"id="up"d="M 7.737296,54.610066 5.80645,53.70989 c 1.827342,-3.602027 4.493352,-6.291427 8.066896,-8.092762 l -0.452626,-0.969844 4.788009,0.663465 -2.974451,3.222444 -0.459005,-0.983506 c -3.107391,1.44734 -5.598011,3.949649 -7.037977,7.060379 z"><title>').h("i18n",t,{},{$key:"threed.tilt.left"}).w('</title></path><path class="tc-ctl-threed-cm-tilt-down"sodipodi:nodetypes="cccccccc"inkscape:connector-curvature="0"id="down"d="m 7.684579,65.708846 -1.930847,0.900176 c 1.827343,3.602027 4.493353,6.291427 8.066897,8.092762 l -0.452626,0.969844 4.788009,-0.663464 -2.974451,-3.222445 -0.459005,0.983506 C 11.615165,71.321886 9.124545,68.819576 7.684579,65.708846 Z"><title>').h("i18n",t,{},{$key:"threed.tilt.right"}).w('</title></path><g class="tc-ctl-threed-cm-rotate-indicator"><path class="tc-ctl-threed-cm-rotate-inner"inkscape:connector-curvature="0"d="m 48.010487,52.995444 c 3.959106,0 7.167321,3.203889 7.167321,7.168124 0,3.964234 -3.208215,7.174892 -7.167321,7.174892 -3.959106,0 -7.160559,-3.210658 -7.160559,-7.174892 0,-3.964235 3.201453,-7.168124 7.160559,-7.168124 z"id="rotateInner"><title>').h("i18n",t,{},{$key:"threed.rotate.reset"}).w('</title></path><path class="tc-ctl-threed-cm-rotate-inner-image"d="m 45.461645,60.604061 c 0.860585,-1.857231 1.777009,-3.864779 2.036499,-4.461218 0.471802,-1.084433 0.471802,-1.084433 0.66474,-0.667935 2.070474,4.46957 3.86201,8.443545 3.825603,8.485934 -0.02561,0.02982 -0.943964,-0.165127 -2.040793,-0.433206 -1.994234,-0.487419 -1.994234,-0.487419 -3.881098,-0.01711 -1.037775,0.258673 -1.950491,0.470314 -2.028258,0.470314 -0.07777,0 0.562721,-1.519553 1.423307,-3.376784 z m 1.23418,2.027617 c 1.353421,-0.310159 1.353421,-0.310159 1.353421,-2.998288 0,-1.534227 -0.05572,-2.627602 -0.129797,-2.547123 -0.101525,0.110295 -2.316061,4.831583 -2.659547,5.670031 -0.09645,0.23543 -0.15884,0.240844 1.435923,-0.12462 z"id="rotateImage"inkscape:connector-curvature="0"><title>').h("i18n",t,{},{$key:"threed.rotate.reset"}).w('</title></path><path class="tc-ctl-threed-cm-rotate-outer tc-ctl-threed-cm-rotate-outer-circle"inkscape:connector-curvature="0"d="m 48.010487,48.839422 c -6.246102,0 -11.312196,5.070128 -11.312196,11.324146 0,6.254017 5.066094,11.330914 11.312196,11.330914 6.246102,0 11.312196,-5.076897 11.312196,-11.330914 0,-6.254018 -5.066094,-11.324146 -11.312196,-11.324146 z m 0,4.156022 c 3.959106,0 7.167321,3.203889 7.167321,7.168124 0,3.964234 -3.208215,7.174892 -7.167321,7.174892 -3.959106,0 -7.160559,-3.210658 -7.160559,-7.174892 0,-3.964235 3.201453,-7.168124 7.160559,-7.168124 z"id="rotateOuter"><title>').h("i18n",t,{},{$key:"threed.rotate.drag"}).w('</title></path><path class="tc-ctl-threed-cm-rotate-outer tc-ctl-threed-cm-rotate-outer-shell-circle"d="m 48.010487,48.839422 c -6.246102,0 -11.312196,5.070128 -11.312196,11.324146 0,6.254017 5.066094,11.330914 11.312196,11.330914 6.246102,0 11.312196,-5.076897 11.312196,-11.330914 0,-6.254018 -5.066094,-11.324146 -11.312196,-11.324146 z m 0,0.379051 c 2.995132,0 5.705501,1.203885 7.681205,3.154245 l -2.386853,2.382605 0.135232,0.135376 2.386853,-2.382606 c 1.930016,1.972963 3.12387,4.674054 3.12387,7.655475 0,2.981421 -1.193854,5.680844 -3.12387,7.655474 l -2.386853,-2.382605 -0.135232,0.135375 2.386853,2.382606 c -1.975664,1.951759 -4.686314,3.161013 -7.681205,3.161013 -1.94179,0 -3.766282,-0.506879 -5.347316,-1.395323 -0.850442,-0.477894 -1.630441,-1.06619 -2.320365,-1.745384 l 2.407138,-2.402912 c 1.358381,1.325983 3.214811,2.145699 5.260543,2.145699 4.163407,0 7.545972,-3.385283 7.545972,-7.553943 0,-4.168661 -3.382565,-7.547175 -7.545972,-7.547175 -2.045732,0 -3.902162,0.81461 -5.260543,2.13893 l -2.407138,-2.402912 c 1.972594,-1.940536 4.681097,-3.133938 7.667681,-3.133938 z m -0.189325,0.182756 v 3.01887 h 0.378651 v -3.01887 z m -7.606826,3.086558 2.400376,2.402912 c -1.326946,1.360319 -2.143435,3.221129 -2.143435,5.272869 0,2.05174 0.816489,3.910884 2.143435,5.272869 l -2.400376,2.402912 c -0.435151,-0.44326 -0.832923,-0.923297 -1.188195,-1.435068 -0.462681,-0.666492 -0.853281,-1.386809 -1.160484,-2.149815 -0.508689,-1.263436 -0.788715,-2.64392 -0.788715,-4.090898 0,-2.99182 1.197141,-5.70104 3.137394,-7.675781 z m 7.796151,0.507657 c 3.959106,0 7.167321,3.203889 7.167321,7.168124 0,3.964234 -3.208215,7.174892 -7.167321,7.174892 -3.959106,0 -7.160559,-3.210658 -7.160559,-7.174892 0,-3.964235 3.201453,-7.168124 7.160559,-7.168124 z m -10.744219,6.978598 v 0.379051 h 3.022445 v -0.379051 z m 18.513325,0 v 0.379051 H 58.8088 v -0.379051 z m -7.931385,7.932994 v 3.01887 h 0.37189 v -3.01887 z"id="rotateShell"inkscape:connector-curvature="0"sodipodi:nodetypes="ssssssccccsccccssccsssccscccccccsccssscsssssccccccccccccccc"><title>').h("i18n",t,{},{$key:"threed.rotate.drag"}).w("</title></path></g></g></svg></div>")}t.__dustBody=!0;return t};e.template[e.CLASS+"-overlay"]=function(){dust.register(e.CLASS+"-overlay",t);function t(e,t){return e.w('<div class="tc-ctl-threed-overlay" hidden><svg class="tc-ctl-threed-overlay-svg"><defs><filter id="fGaussian" x="0" y="0"><feGaussianBlur in="SourceGraphic" stdDeviation="3" /></filter></defs><rect width="100%" height="100%" fill="white" fill-opacity="0.5" filter="url(#fGaussian)" /> </svg> </div>')}t.__dustBody=!0;return t};e.template[e.CLASS]=function(){dust.register(e.CLASS,t);function t(e,t){return e.w('<button class="tc-ctl-threed-btn tc-beta-button" title="').h("i18n",t,{},{$key:"threed.tip"}).w('"></button>')}t.__dustBody=!0;return t}}e.viewer;e.mapView;e.terrainProvider;e.register=function(e){var t=this;TC.Control.prototype.register.call(t,e);t.mapView=new i(e,t);e.on(TC.Consts.event.PROJECTIONCHANGE,function(e){t.mapView.metersPerUnit=t.map.getMetersPerUnit()})};var t=function(e,t){var i=this;i.waiting||(i.waiting=i.map.getLoadingIndicator().addWait());for(var a=[],r=0,o=i.allowedControls.length;r<o;r++){var n=i.allowedControls[r];n=n.substr(0,1).toUpperCase()+n.substr(1);a=a.concat(i.map.getControlsByClass("TC.control."+n))}i.ctrlsToMng=a;if(i.mapIs3D){i.deactivate();i.map3D.cameraControls.resetRotation({duration:1e3}).then(function(){var e=m(i.viewer.scene),t=Cesium.Matrix4.fromTranslation(e),a=d(i.viewer.scene,e);i.map3D.rotateAroundAxis(i.viewer.scene.camera,-a,i.viewer.scene.camera.right,t,{duration:1500,callback:function(){i.mapIs3D=!1;i.map._$div.removeClass(TC.Consts.classes.THREED);i.$button.attr("title",i.getLocaleString("threed.tip"));i.map3D.destroy.call(i);i.map3D.setViewFromCameraView.call(i).then(function(){i.$divThreedMap.removeClass(i.classes.MAPTHREED);i.$divThreedMap.removeClass("tc-ctl-threed-divMap-fadeIn").addClass("tc-ctl-threed-divMap-fadeOut");$(i.mapView.viewHTML).removeClass("tc-ctl-threed-divMap-fadeOut").addClass("tc-ctl-threed-divMap-fadeIn");i.viewer.destroy();i.viewer=null;i.$button.removeAttr("disabled");i.$button.toggleClass(i.classes.BTNACTIVE);i.map.getLoadingIndicator().removeWait(i.waiting);delete i.waiting});i.mapView.setRotation(0);i._ovMap.wrap.draw3DCamera(null)}})});i.map.activeControl=i.map.previousActiveControl;i.map.activeControl.activate();i.map.previousActiveControl=i}else{i.activate();if(i.browserSupportWebGL.call(i)||!i.browserSupportWebGL.call(i)){i.mapIs3D=!0;i.overlay.removeAttr("hidden");i.overlay.appendTo(i.map._$div.parent());i.map._$div.addClass(TC.Consts.classes.THREED);i.$divThreedMap=$("#"+i.selectors.divThreedMap);i.$divThreedMap.addClass(i.classes.MAPTHREED);i.$divThreedMap.addClass(i.classes.LOADING);i.$button.attr("title",i.getLocaleString("threed.two.tip"));i.$button.removeClass(i.classes.BETA);i.map3D.loadViewer.call(i).then(function(){i.$divThreedMap.removeClass("tc-ctl-threed-divMap-fadeOut").addClass("tc-ctl-threed-divMap-fadeIn");$(i.mapView.viewHTML).removeClass("tc-ctl-threed-divMap-fadeIn").addClass("tc-ctl-threed-divMap-fadeOut");i.$divThreedMap.removeClass(i.classes.LOADING);i.$button.toggleClass(i.classes.BTNACTIVE);i.map3D.setCameraFromMapView.call(i);i.map3D.setBaseLayer.call(i,i.map.baseLayer);i.map.workLayers.filter(function(e){return e.type===TC.Consts.layerType.WMTS||e.type===TC.Consts.layerType.WMS}).reverse().forEach(function(e){i.map3D.addLayer.call(i,e)});$.when(i.viewer.readyPromise).then(function(){i.map3D.cameraControls?i.map3D.cameraControls.render.call(i.map3D.cameraControls):i.map3D.cameraControls=new C(i);if(t){i.map3D.cameraControls.getCamera().flyTo({destination:Cesium.Cartesian3.fromRadians(t.cp[0],t.cp[1],t.cp[2]),orientation:{heading:t.chpr[0],pitch:t.chpr[1],roll:t.chpr[2]},complete:function(){i.$button.removeAttr("disabled");i.overlay.attr("hidden","hidden");i.map.getLoadingIndicator().removeWait(i.waiting);delete i.waiting}})}else if(e){var a=Cesium.Math.toRadians(50),r=m(i.viewer.scene);r=Cesium.Matrix4.fromTranslation(r);i.map3D.rotateAroundAxis(i.viewer.scene.camera,-a,i.viewer.scene.camera.right,r,{duration:2e3,callback:function(){Cesium.Camera.DEFAULT_VIEW_RECTANGLE=i.map3D.initialRectangle=i.viewer.camera.computeViewRectangle();Cesium.Camera.DEFAULT_VIEW_FACTOR=0;i.$button.removeAttr("disabled");i.overlay.attr("hidden","hidden");i.map.getLoadingIndicator().removeWait(i.waiting);delete i.waiting}})}else{i.$button.removeAttr("disabled");i.overlay.attr("hidden","hidden");i.map.getLoadingIndicator().removeWait(i.waiting);delete i.waiting}i.$events.on(TC.Consts.event.TERRAINLOADED,function(){if(i.viewer.billboardCollection){for(var e=0;e<i.viewer.billboardCollection.length;e++){var t=Cesium.Ellipsoid.WGS84.cartesianToCartographic(i.viewer.billboardCollection.get(e).position),a=i.viewer.scene.globe.getHeight(t),r={longitude:t.longitude,latitude:t.latitude,height:t.height+a};i.viewer.billboardCollection.get(e).position=Cesium.Ellipsoid.WGS84.cartographicToCartesian(r)}i.viewer.scene.requestRender()}})}.bind(i))})}}};e.renderData=function(e,i){var a=this;TC.Control.prototype.renderData.call(a,e,function(){a.getRenderedHtml(a.CLASS+"-overlay",{},function(e){a.overlay=$(e)});a.$button=a._$div.find("."+a.CLASS+"-btn");a.$button.on(TC.Consts.event.CLICK,function(){a.$button.attr("disabled","disabled");t.call(a,!0)})});$.isFunction(i)&&i()};e.activate=function(){if(TC.Util.detectIE()){var e=document.createEvent("UIEvents");e.initUIEvent("resize",!0,!1,window,0);window.dispatchEvent(e)}else window.dispatchEvent(new Event("resize"));TC.Control.prototype.activate.call(this)};e.deactivate=function(){window.dispatchEvent(new Event("resize"));TC.Control.prototype.deactivate.call(this)};e.setMapState=function(e){this.map.toast(this.getLocaleString("threed.apply3DState"),{type:TC.Consts.msgType.INFO});t.call(this,!1,e)};var i=function(e,t){var i=this;i.map=e;i.parent=t;$.when(i.map.getViewHTML()).then(function(e){i.viewHTML=e}.bind(i));i.metersPerUnit=e.getMetersPerUnit();i.maxResolution;i._oldMapSetCenter=e.setCenter;e.setCenter=function(a,r){t.mapIs3D?t.map3D.flyToMapCoordinates.call(t,a):i._oldMapSetCenter.call(e,a,r)}};i.prototype.getCenter=function(){return this.map.getCenter()};i.prototype.getExtent=function(){return this.map.getExtent()};i.prototype.getResolution=function(){return this.map.getResolution()};i.prototype.getRotation=function(){return this.map.getRotation()};i.prototype.getMaxResolution=function(){if(this.maxResolution)return this.maxResolution;if(null!==this.map.getResolutions())this.maxResolution=this.map.getResolutions()[0];else{var e=this.map.options.baselayerExtent;this.maxResolution=(e[2]-e[0])/this.parent.Consts.DEFAULT_TILE_SIZE}return this.maxResolution};i.prototype.getPixelFromCoordinate=function(e){return this.map.getPixelFromCoordinate(e)};i.prototype.setCenter=function(e){this._oldMapSetCenter.call(this.map,e)};i.prototype.setExtent=function(e){this.map.setExtent(e)};i.prototype.setResolution=function(e){this.map.setResolution(e)};i.prototype.setRotation=function(e){this.map.setRotation(e)};var a=function(e,t){return e.type===TC.Consts.layerType.WMTS?e.wrap.getCompatibleMatrixSets(t).length>0:e.isCompatible(t)},r=function(e,t){var i=t[0]-e[0],a=t[1]-e[1];return i*i+a*a},o=function(e){if((e=e||{}).nearMapCoords){var t=e.bottomPixel.clone();t.y=Math.round(9*t.y/10);var i=n.call(this,t);if(i){var a=[e.nearMapCoords,i].sort(function(t,i){return r(e.cameraPosition,t)-r(e.cameraPosition,i)});return function(e,t){var i=t[0]-e[0],a=t[1]-e[1],r=Math.atan(a/i);i<0&&(r+=Math.PI);return[e[0]+1e6*Math.cos(r),e[1]+1e6*Math.sin(r)]}.apply(this,a)}}return null},n=function(e){var t=c(this.viewer.scene,e);if(t){t=Cesium.Cartographic.fromCartesian(t);return TC.Util.reproject([Cesium.Math.toDegrees(t.longitude),Cesium.Math.toDegrees(t.latitude)],this.map3D.crs,this.map.crs)}return null},s=function(e,t){var i=this.viewer.scene.canvas,a=this.viewer.camera.frustum.fovy,r=2*e*Math.tan(a/2),o=Math.cos(Math.abs(t)),n=r/this.mapView.metersPerUnit/o/i.clientHeight,s=this.map.getResolutions();if(null==s)for(var l=0,c=(s=new Array(22)).length;l<c;++l)s[l]=this.mapView.getMaxResolution()/Math.pow(2,l);for(l=0;l<s.length;l++){if(s[l]<Math.abs(n)){n=s[l-1];break}if(s[l]===Math.abs(n)){n=s[l];break}l===s.length-1&&(n=s[l])}return n},l=function(e,t,i,a,r){var o,n=Cesium.Math.clamp,s=Cesium.defaultValue,l=r||{},c=s(l.duration,500),u=s(l.easing,function(e){return e}),m=l.callback,p=0,h=new Cesium.Matrix4,d=new $.Deferred;requestAnimationFrame(function r(s){o||(o=s);var l=u(n((s-o)/c,0,1));e.transform.clone(h);var C=(l-p)*t;p=l;e.lookAtTransform(a);e.rotate(i,C);e.lookAtTransform(h);if(l<1)requestAnimationFrame(r);else{m&&m();d.resolve()}});return d},c=function(e,t){var i=e.camera.getPickRay(t);return e.globe.pick(i,e)||e.camera.pickEllipsoid(t)},u=function(e){var t=e.canvas,i=new Cesium.Cartesian2(t.clientWidth/2,t.clientHeight/2);return c(e,i)},m=function(e){var t=e.canvas,i=new Cesium.Cartesian2(t.clientWidth/2,t.clientHeight);return c(e,i)},p=function(e,t,i,a){var r=e.camera,o=d(e,i),n=r.right,s=Cesium.Quaternion.fromAxisAngle(n,o),c=Cesium.Matrix3.fromQuaternion(s),u=new Cesium.Cartesian3;Cesium.Cartesian3.subtract(r.position,i,u);var m=new Cesium.Cartesian3;Cesium.Matrix3.multiplyByVector(c,u,m);Cesium.Cartesian3.add(m,i,m);var p=Cesium.Matrix4.fromTranslation(m);l(r,t,m,p,a)},h=function(e,t,i){var a=new Cesium.Cartesian3,r=new Cesium.Cartesian3,o=new Cesium.Cartesian3;Cesium.Cartesian3.normalize(e,a);Cesium.Cartesian3.normalize(t,r);Cesium.Cartesian3.cross(a,r,o);var n=Cesium.Cartesian3.dot(a,r),s=Cesium.Cartesian3.magnitude(o),l=Cesium.Cartesian3.dot(i,o),c=Math.atan2(s,n);return l>=0?c:-c},d=function(e,t){var i=e.camera,a=i.frustum.fovy/2,r=function(e){var t=e.camera,i=t.frustum.fovy/2,a=t.direction,r=Cesium.Quaternion.fromAxisAngle(t.right,i),o=Cesium.Matrix3.fromQuaternion(r),n=new Cesium.Cartesian3;Cesium.Matrix3.multiplyByVector(o,a,n);return new Cesium.Ray(t.position,n)}(e),o=Cesium.Cartesian3.clone(r.direction);Cesium.Cartesian3.negate(o,o);var n=new Cesium.Cartesian3;Cesium.Ellipsoid.WGS84.geocentricSurfaceNormal(t,n);var s=new Cesium.Cartesian3;Cesium.Cartesian3.negate(i.right,s);return h(n,o,s)+a},C=function(e){this.parent=e;var t=function(e,t){var i=$(e)[0].getBBox();value="rotate("+Cesium.Math.toDegrees(t)+" "+(i.x+i.width/2)+" "+(i.y+i.height/2)+")";document.getElementsByClassName(e[0].className.baseVal)[0].setAttribute("transform",value)};this.outControlsEvents=TC.Util.detectMouse()?"mouseleave":"touchleave, touchend";this.outControls=function(e){this.isFocusingCameraCtrls=!1}.bind(this);this.inControlsEvents=TC.Util.detectMouse()?"mouseenter":"touchmove, touchstart";this.inControls=function(){this.isFocusingCameraCtrls=!0;this.lastFocused=performance.now();if(this.$div.hasClass(this.parent.classes.OUTFOCUS)){this.$div.removeClass(this.parent.classes.OUTFOCUS);this.$tiltIndicatorOuterCircle.attr("class",this.$tiltIndicatorOuterCircle.attr("class").replace(this.parent.classes.OUTFOCUS,""));this.$tiltIndicatorOuterShellCircle.attr("class",this.$tiltIndicatorOuterShellCircle.attr("class").replace(this.parent.classes.OUTFOCUS,""));this.$rotateIndicatorOuterCircle.attr("class",this.$rotateIndicatorOuterCircle.attr("class").replace(this.parent.classes.OUTFOCUS,""));this.$rotateIndicatorOuterShellCircle.attr("class",this.$rotateIndicatorOuterShellCircle.attr("class").replace(this.parent.classes.OUTFOCUS,""))}}.bind(this);this.moveStart=function(){this.moving=!0}.bind(this);this.moveEnd=function(){this.moving=!1}.bind(this);this.postRender=function(){var e=this.parent;this.parent.map3D.isLoadingTiles.call(this.parent)&&this.customCollisionDetection();var i=this.getCamera(),a=i.positionCartographic;if(this.moving){t(this.$tiltIndicator,i.pitch);t(this.$rotateIndicator,-i.heading);this.disableRotate();this.disableTilt(5);this._coordsXY=TC.Util.reproject([Cesium.Math.toDegrees(a.longitude),Cesium.Math.toDegrees(a.latitude)],e.map3D.crs,e.map.crs);e.mapView.setCenter(this._coordsXY);e.mapView.setResolution(s.call(e,a.height,a.latitude))}if(this._coordsXY){e._ovMap=e._ovMap||e.map.getControlsByClass("TC.control.OverviewMap")[0];if(e._ovMap){var r=e.viewer.scene.canvas,l=new Cesium.Cartesian2(0,r.clientHeight-1),c=new Cesium.Cartesian2(r.clientWidth-1,r.clientHeight-1),u=[l,c,new Cesium.Cartesian2(r.clientWidth-1,0),new Cesium.Cartesian2(0,0)].map(function(t){return n.call(e,t)}).filter(function(e){return null!==e});if(u.length&&u.length<4){var m=o.call(e,{nearMapCoords:u[0],bottomPixel:l,cameraPosition:this._coordsXY}),p=o.call(e,{nearMapCoords:u[1],bottomPixel:c,cameraPosition:this._coordsXY});if(m&&p){u[2]=p;u[3]=m}}e._ovMap.wrap.draw3DCamera({position:this._coordsXY,heading:i.heading,fov:u})}}}.bind(this);this.selectors={tilt:"-cm-tilt",rotate:"-cm-rotate",indicator:"-indicator",leftArrow:"-left",rightArrow:"-right",downArrow:"-down",upArrow:"-up"};this.MIN_TILT=Cesium.Math.toRadians(-89);this.MAX_TILT=Cesium.Math.toRadians(-1);this.render()};C.prototype.bind=function(){var e=this;e.getCamera().moveStart.addEventListener(e.moveStart);e.getCamera().moveEnd.addEventListener(e.moveEnd);e.parent.viewer.scene.postRender.addEventListener(e.postRender);e.$div.on(e.outControlsEvents,e.outControls);e.$div.on(e.inControlsEvents,e.inControls);e.rAFInOutControls=requestAnimationFrame(function t(){e.lastFocused||(e.lastFocused=performance.now());if(performance.now()-e.lastFocused>5e3&&!0!==e.isFocusingCameraCtrls&&!e.$div.hasClass(e.parent.classes.OUTFOCUS)){e.$div.addClass(e.parent.classes.OUTFOCUS);e.$tiltIndicatorOuterCircle.attr("class",e.$tiltIndicatorOuterCircle.attr("class")+" "+e.parent.classes.OUTFOCUS);e.$tiltIndicatorOuterShellCircle.attr("class",e.$tiltIndicatorOuterShellCircle.attr("class")+" "+e.parent.classes.OUTFOCUS);e.$rotateIndicatorOuterCircle.attr("class",e.$rotateIndicatorOuterCircle.attr("class")+" "+e.parent.classes.OUTFOCUS);e.$rotateIndicatorOuterShellCircle.attr("class",e.$rotateIndicatorOuterShellCircle.attr("class")+" "+e.parent.classes.OUTFOCUS)}e.rAFInOutControls=requestAnimationFrame(t)})};C.prototype.unbind=function(){this.$div.addClass(TC.Consts.classes.HIDDEN);this.getCamera().moveStart.removeEventListener(this.moveStart);this.getCamera().moveEnd.removeEventListener(this.moveEnd);this.parent.viewer.scene.postRender.removeEventListener(this.postRender);this.$div.off(this.outControlsEvents,this.outControls);this.$div.off(this.inControlsEvents,this.inControls);window.cancelAnimationFrame(this.rAFInOutControls);this.lastFocused=void 0;this.rAFInOutControls=void 0};C.prototype.getCamera=function(){return this.parent.viewer.scene.camera};C.prototype.getCameraState=function(){if(this.parent.viewer){var e=this.parent.viewer.scene.camera,t=e.positionCartographic,i=m(this.parent.viewer.scene),a=Cesium.Cartesian3.distance(e.position,i);return{cp:[t.longitude,t.latitude,t.height],chpr:[e.heading,e.pitch,e.roll],bcpd:a}}};C.prototype.render=function(){var e=this;if(e.$div){e.$div.removeClass(TC.Consts.classes.HIDDEN);e.bind()}else e.parent.getRenderedHtml(e.parent.CLASS+"-cm-ctls",{},function(t){e.$div=$('<div class="'+e.parent.CLASS+'-cm-ctls"></div>');e.$div.appendTo(e.parent.map._$div);$(t).appendTo(e.$div);var i="."+e.parent.CLASS+e.selectors.tilt;e.$tiltIndicatorInner=e.$div.find("[class^="+i.replace(".","")+"-inner]");e.$tiltIndicatorInner.on(TC.Consts.event.CLICK,e.resetTilt.bind(e));e.$tiltIndicator=e.$div.find(i+"-indicator");e.$tiltIndicatorOuterCircle=e.$div.find(i+"-outer-circle");e.$tiltIndicatorOuterShellCircle=e.$div.find(i+"-outer-shell-circle");e.$tiltIndicatorCircle=e.$div.find("[class^="+i.replace(".","")+"-outer]");e.$tiltIndicatorCircle.on("mousedown",function(e){e.stopPropagation&&e.stopPropagation();e.preventDefault&&e.preventDefault();var t=new Cesium.Cartesian2,i=e.currentTarget,a=e.currentTarget.getBoundingClientRect(),r=new Cesium.Cartesian2((a.right-a.left)/2,(a.bottom-a.top)/2),o=new Cesium.Cartesian2(e.clientX-a.left,e.clientY-a.top),n=Cesium.Cartesian2.subtract(o,r,t);this.draggingTilt.call(this,i,n);e.cancelBubble=!0;e.returnValue=!1;return!1}.bind(e));e.$tiltUp=e.$div.find(i+e.selectors.upArrow);e.$tiltUp.on(TC.Util.detectMouse()?"mousedown":"touchstart",function(t){if(void 0!==$(t.target).attr("disabled")){t.stopPropagation&&t.stopPropagation();t.preventDefault&&t.preventDefault();t.cancelBubble=!0;t.returnValue=!1;return!1}t.stopPropagation&&t.stopPropagation();t.preventDefault&&t.preventDefault();e.inControls(t);var i=TC.Util.detectMouse()?"mouseup":"touchend";document.removeEventListener(i,e.tiltUpMouseUpFunction,!1);e.tiltUpMouseUpFunction=void 0;e.tilt.call(e,5);e.tiltUpInterval=setInterval(function(){e.isTiltUpDisabled?e.tiltUpMouseUpFunction():e.tilt.call(e,5)}.bind(e),101);e.tiltUpMouseUpFunction=function(){clearInterval(e.tiltUpInterval);e.tiltUpInterval=void 0;document.removeEventListener(i,e.tiltUpMouseUpFunction,!1);e.tiltUpMouseUpFunction=void 0};document.addEventListener(i,e.tiltUpMouseUpFunction,!1);t.cancelBubble=!0;t.returnValue=!1;return!1}.bind(e));e.$tiltDown=e.$div.find(i+e.selectors.downArrow);e.$tiltDown.on(TC.Util.detectMouse()?"mousedown":"touchstart",function(t){if(void 0!==$(t.target).attr("disabled")){t.stopPropagation&&t.stopPropagation();t.preventDefault&&t.preventDefault();t.cancelBubble=!0;t.returnValue=!1;return!1}t.stopPropagation&&t.stopPropagation();t.preventDefault&&t.preventDefault();e.inControls(t);var i=TC.Util.detectMouse()?"mouseup":"touchend";document.removeEventListener(i,e.tiltDownMouseUpFunction,!1);e.tiltDownMouseUpFunction=void 0;e.tilt.call(e,-5);e.tiltDownInterval=setInterval(function(){e.isTiltDownDisabled?e.tiltDownMouseUpFunction():e.tilt.call(e,-5)}.bind(e),101);e.tiltDownMouseUpFunction=function(){clearInterval(e.tiltDownInterval);e.tiltDownInterval=void 0;document.removeEventListener(i,e.tiltDownMouseUpFunction,!1);e.tiltDownMouseUpFunction=void 0};document.addEventListener(i,e.tiltDownMouseUpFunction,!1);t.cancelBubble=!0;t.returnValue=!1;return!1}.bind(e));var a="."+e.parent.CLASS+e.selectors.rotate;e.$rotateIndicatorInner=e.$div.find("[class^="+a.replace(".","")+"-inner]");e.$rotateIndicatorInner.on(TC.Consts.event.CLICK,e.resetRotation.bind(e));e.$rotateIndicator=e.$div.find(a+"-indicator");e.$rotateIndicatorOuterCircle=e.$div.find(a+"-outer-circle");e.$rotateIndicatorOuterShellCircle=e.$div.find(a+"-outer-shell-circle");e.$rotateIndicatorCircle=e.$div.find("[class^="+a.replace(".","")+"-outer]");e.$rotateIndicatorCircle.on("mousedown",function(e){e.stopPropagation&&e.stopPropagation();e.preventDefault&&e.preventDefault();var t=new Cesium.Cartesian2,i=e.currentTarget,a=e.currentTarget.getBoundingClientRect(),r=new Cesium.Cartesian2((a.right-a.left)/2,(a.bottom-a.top)/2),o=new Cesium.Cartesian2(e.clientX-a.left,e.clientY-a.top),n=Cesium.Cartesian2.subtract(o,r,t);this.draggingRotate.call(this,i,n);e.cancelBubble=!0;e.returnValue=!1;return!1}.bind(e));e.$rotateLeft=e.$div.find(a+e.selectors.leftArrow);e.$rotateLeft.on(TC.Util.detectMouse()?"mousedown":"touchstart",function(t){t.stopPropagation&&t.stopPropagation();t.preventDefault&&t.preventDefault();e.inControls(t);var i=TC.Util.detectMouse()?"mouseup":"touchend";document.removeEventListener(i,e.rotateLeftMouseUpFunction,!1);e.rotateLeftMouseUpFunction=void 0;e.rotate.call(e,-15);e.rotateLeftInterval=setInterval(function(){e.rotate.call(e,-15)}.bind(e),101);e.rotateLeftMouseUpFunction=function(){clearInterval(e.rotateLeftInterval);e.rotateLeftInterval=void 0;document.removeEventListener(i,e.rotateLeftMouseUpFunction,!1);e.rotateLeftMouseUpFunction=void 0};document.addEventListener(i,e.rotateLeftMouseUpFunction,!1);t.cancelBubble=!0;t.returnValue=!1;return!1}.bind(e));e.$rotateRight=e.$div.find(a+e.selectors.rightArrow);e.$rotateRight.on(TC.Util.detectMouse()?"mousedown":"touchstart",function(t){t.stopPropagation&&t.stopPropagation();t.preventDefault&&t.preventDefault();e.inControls(t);var i=TC.Util.detectMouse()?"mouseup":"touchend";document.removeEventListener(i,e.rotateRightMouseUpFunction,!1);e.rotateRightMouseUpFunction=void 0;e.rotate.call(e,15);e.rotateRightInterval=setInterval(function(){e.rotate.call(e,15)}.bind(e),101);e.rotateRightMouseUpFunction=function(){clearInterval(e.rotateRightInterval);e.rotateRightInterval=void 0;document.removeEventListener(i,e.rotateRightMouseUpFunction,!1);e.rotateRightMouseUpFunction=void 0};document.addEventListener(i,e.rotateRightMouseUpFunction,!1);t.cancelBubble=!0;t.returnValue=!1;return!1}.bind(e));e.bind()}.bind(this))};C.prototype.disableTilt=function(e){var t=Cesium.Math.toRadians(e),i=this.getCamera().pitch;this.isTiltDownDisabled=i+-t<this.MIN_TILT;this.isTiltUpDisabled=i+t>this.MAX_TILT;this.$tiltUp.attr("disabled",this.isTiltUpDisabled);this.isTiltUpDisabled?-1==this.$tiltUp.attr("class").indexOf(this.parent.classes.CAMERACTRARROWDISABLED)&&this.$tiltUp.attr("class",this.$tiltUp.attr("class")+" "+this.parent.classes.CAMERACTRARROWDISABLED):this.$tiltUp.attr("class",this.$tiltUp.attr("class").replace(" "+this.parent.classes.CAMERACTRARROWDISABLED,""));this.$tiltDown.attr("disabled",this.isTiltDownDisabled);this.isTiltDownDisabled?-1==this.$tiltDown.attr("class").indexOf(this.parent.classes.CAMERACTRARROWDISABLED)&&this.$tiltDown.attr("class",this.$tiltDown.attr("class")+" "+this.parent.classes.CAMERACTRARROWDISABLED):this.$tiltDown.attr("class",this.$tiltDown.attr("class").replace(" "+this.parent.classes.CAMERACTRARROWDISABLED,""))};C.prototype.disableRotate=function(){var e=!0,t=this.parent.viewer.scene.canvas,i=[new Cesium.Cartesian2(0,t.clientHeight-1),new Cesium.Cartesian2(t.clientWidth-1,t.clientHeight-1),new Cesium.Cartesian2(t.clientWidth-1,0),new Cesium.Cartesian2(0,0)].map(function(e){return n.call(this,e)}.bind(this.parent)).filter(function(e){return null!==e});i.length&&i.length>=2&&(e=!1);this.$rotateIndicatorInner.attr("disabled",e);this.$rotateLeft.attr("disabled",e);e?-1==this.$rotateLeft.attr("class").indexOf(this.parent.classes.CAMERACTRARROWDISABLED)&&this.$rotateLeft.attr("class",this.$rotateLeft.attr("class")+" "+this.parent.classes.CAMERACTRARROWDISABLED):this.$rotateLeft.attr("class",this.$rotateLeft.attr("class").replace(" "+this.parent.classes.CAMERACTRARROWDISABLED,""));this.$rotateRight.attr("disabled",e);e?-1==this.$rotateRight.attr("class").indexOf(this.parent.classes.CAMERACTRARROWDISABLED)&&this.$rotateRight.attr("class",this.$rotateRight.attr("class")+" "+this.parent.classes.CAMERACTRARROWDISABLED):this.$rotateRight.attr("class",this.$rotateRight.attr("class").replace(" "+this.parent.classes.CAMERACTRARROWDISABLED,""));return e};C.prototype.tilt=function(e){this.disableTilt(e);if(this.parent.viewer&&this.parent.viewer.trackedEntity)this.getCamera().rotateUp(Cesium.Math.toRadians(e));else{void 0==u(this.parent.viewer.scene)&&(e>0?this.getCamera().lookUp():this.getCamera().lookDown());if(e>=Cesium.Math.PI_OVER_TWO&&this.isTiltUpDisabled||e<=-Cesium.Math.PI_OVER_TWO&&this.isTiltDownDisabled)return;var t=Cesium.Math.toRadians(e),i=u(this.parent.viewer.scene);if(i){var a=Cesium.Matrix4.fromTranslation(i);this.parent.map3D.rotateAroundAxis(this.getCamera(),-t,this.getCamera().right,a,{duration:100})}}};C.prototype.rotate=function(e){e=Cesium.Math.toRadians(e);if(this.parent.viewer&&this.parent.viewer.trackedEntity)this.getCamera().rotateRight(-e);else{var t=m(this.parent.viewer.scene);t&&p(this.parent.viewer.scene,e,t,{duration:100})}};C.prototype.draggingTilt=function(e,t){var i=this;i.$tiltIndicatorOuterCircle.attr("class",i.$tiltIndicatorOuterCircle.attr("class")+" "+i.parent.classes.HIGHLIGHTED);var a=new Cesium.Matrix4,r=new Cesium.Matrix4,o=new Cesium.Cartesian2;document.removeEventListener("mousemove",i.tiltMouseMoveFunction,!1);document.removeEventListener("mouseup",i.tiltMouseUpFunction,!1);i.tiltMouseMoveFunction=void 0;i.tiltMouseUpFunction=void 0;i.isTilting=!0;var n=i.parent.viewer.scene,s=n.camera,l=u(n);if(l){i.tiltFrame=Cesium.Transforms.northUpEastToFixedFrame(l,Cesium.Ellipsoid.WGS84,r);i.tiltIsLook=!1}else{i.tiltFrame=Cesium.Transforms.northUpEastToFixedFrame(s.positionWC,Cesium.Ellipsoid.WGS84,r);i.tiltIsLook=!0}i.startCursorAngle=Math.atan2(-t.y,t.x);var c=Cesium.Matrix4.clone(s.transform,a);s.lookAtTransform(i.tiltFrame);i.initialCameraAngle=Math.atan2(s.position.y,s.position.x);s.lookAtTransform(c);i.tiltMouseMoveFunction=function(t){n=this.parent.viewer.scene;s=n.camera;var i=e.getBoundingClientRect();center=new Cesium.Cartesian2((i.right-i.left)/2,(i.bottom-i.top)/2);var r=new Cesium.Cartesian2(t.clientX-i.left,t.clientY-i.top),l=Cesium.Cartesian2.subtract(r,center,o);console.log("Entra: "+l.toString());var u=Math.atan2(-l.y,l.x)-this.startCursorAngle,m=Cesium.Math.zeroToTwoPi(this.initialCameraAngle-u);try{c=Cesium.Matrix4.clone(s.transform,a);s.lookAtTransform(this.tiltFrame);var p=m-Math.atan2(s.position.y,s.position.x),h=s.pitch;(h+=p)<this.MIN_TILT?s.rotate(s.right,s.pitch-this.MIN_TILT):h>this.MAX_TILT?s.rotate(s.right,s.pitch-this.MAX_TILT):s.rotate(s.right,-p);this.disableTilt(5);s.lookAtTransform(c)}catch(t){this.tiltMouseUpFunction()}}.bind(i);i.tiltMouseUpFunction=function(e){i.$tiltIndicatorOuterCircle.attr("class",i.$tiltIndicatorOuterCircle.attr("class").replace(i.parent.classes.HIGHLIGHTED,""));i.isTilting=!1;document.removeEventListener("mousemove",i.tiltMouseMoveFunction,!1);document.removeEventListener("mouseup",i.tiltMouseUpFunction,!1);i.tiltMouseMoveFunction=void 0;i.tiltMouseUpFunction=void 0};document.addEventListener("mousemove",i.tiltMouseMoveFunction,!1);document.addEventListener("mouseup",i.tiltMouseUpFunction,!1)};C.prototype.draggingRotate=function(e,t){var i=this;document.removeEventListener("mousemove",i.rotateMouseMoveFunction,!1);document.removeEventListener("mouseup",i.rotateMouseUpFunction,!1);i.rotateMouseMoveFunction=void 0;i.rotateMouseUpFunction=void 0;i.rotateMouseMoveFunction=function(t){var r=e.getBoundingClientRect(),s=new Cesium.Cartesian2((r.right-r.left)/2,(r.bottom-r.top)/2),c=new Cesium.Cartesian2(t.clientX-r.left,t.clientY-r.top),u=Cesium.Cartesian2.subtract(c,s,o),m=Math.atan2(-u.y,u.x)-i.rotateInitialCursorAngle,p=Cesium.Math.zeroToTwoPi(i.rotateInitialCameraAngle-m);n=i.parent.viewer.scene.camera;try{l=Cesium.Matrix4.clone(n.transform,a);n.lookAtTransform(i.rotateFrame);var h=Math.atan2(n.position.y,n.position.x);n.rotateRight(p-h);n.lookAtTransform(l)}catch(t){i.rotateMouseUpFunction()}};i.rotateMouseUpFunction=function(e){i.isRotating=!1;i.$rotateIndicatorOuterCircle.attr("class",i.$rotateIndicatorOuterCircle.attr("class").replace(i.parent.classes.HIGHLIGHTED,""));document.removeEventListener("mousemove",i.rotateMouseMoveFunction,!1);document.removeEventListener("mouseup",i.rotateMouseUpFunction,!1);i.rotateMouseMoveFunction=void 0;i.rotateMouseUpFunction=void 0};if(i.disableRotate())i.rotateMouseUpFunction();else{i.$rotateIndicatorOuterCircle.attr("class",i.$rotateIndicatorOuterCircle.attr("class")+" "+i.parent.classes.HIGHLIGHTED);var a=new Cesium.Matrix4,r=new Cesium.Matrix4,o=new Cesium.Cartesian2;i.isRotating=!0;i.rotateInitialCursorAngle=Math.atan2(-t.y,t.x);var n=i.parent.viewer.scene.camera,s=u(i.parent.viewer.scene);if(null==s||void 0==s)if(null==(s=m(i.parent.viewer.scene))||void 0==s){i.rotateFrame=Cesium.Transforms.eastNorthUpToFixedFrame(n.positionWC,Cesium.Ellipsoid.WGS84,r);i.rotateIsLook=!0}else{i.rotateFrame=Cesium.Transforms.eastNorthUpToFixedFrame(s,Cesium.Ellipsoid.WGS84,r);i.rotateIsLook=!1}else{i.rotateFrame=Cesium.Transforms.eastNorthUpToFixedFrame(s,Cesium.Ellipsoid.WGS84,r);i.rotateIsLook=!1}try{var l=Cesium.Matrix4.clone(n.transform,a);n.lookAtTransform(i.rotateFrame);i.rotateInitialCameraAngle=Math.atan2(n.position.y,n.position.x);i.rotateInitialCameraDistance=Cesium.Cartesian3.magnitude(new Cesium.Cartesian3(n.position.x,n.position.y,0));n.lookAtTransform(l)}catch(e){i.rotateMouseUpFunction()}document.addEventListener("mousemove",i.rotateMouseMoveFunction,!1);document.addEventListener("mouseup",i.rotateMouseUpFunction,!1)}};C.prototype.resetTilt=function(){var e=-this.getCamera().pitch-Cesium.Math.toRadians(50);this.tilt(Cesium.Math.toDegrees(e))};C.prototype.resetRotation=function(e){var t,i=new $.Deferred;t=-this.getCamera().heading;for(;t<-Math.PI;)t+=2*Math.PI;for(;t>Math.PI;)t-=2*Math.PI;e?e.callback=function(){i.resolve()}:i.resolve();if(this.parent.viewer&&this.parent.viewer.trackedEntity){this.getCamera().rotate(Cesium.Cartesian3.fromDegrees(0,90),t)}else{var a=m(this.parent.viewer.scene);a&&p(this.parent.viewer.scene,t,a,e)}return i};C.prototype.customCollisionDetection=function(){var e,t,i=new Cesium.Matrix4,a=new Cesium.Cartographic,r=this.parent.viewer.scene,o=this.parent.viewer.scene.camera,n=r.screenSpaceCameraController,s=(n.enableCollisionDetection,n.minimumCollisionTerrainHeight),l=n.minimumZoomDistance,c=r.globe,u=c.ellipsoid;r.mapProjection;if(!Cesium.Matrix4.equals(o.transform,Cesium.Matrix4.IDENTITY)){e=Cesium.Matrix4.clone(o.transform,i);t=Cesium.Cartesian3.magnitude(o.position);o._setTransform(Cesium.Matrix4.IDENTITY)}var m=a;u.cartesianToCartographic(o.position,m);var p=!1;if(m.height<s){var h=c.getHeight(m);if(void 0!==h&&null!==h){h+=l;if(m.height<h){m.height=h;u.cartographicToCartesian(m,o.position);p=!0}}}if(void 0!==e&&null!==e){o._setTransform(e);if(p){Cesium.Cartesian3.normalize(o.position,o.position);Cesium.Cartesian3.negate(o.position,o.direction);Cesium.Cartesian3.multiplyByScalar(o.position,Math.max(t,l),o.position);Cesium.Cartesian3.normalize(o.direction,o.direction);Cesium.Cartesian3.cross(o.direction,o.up,o.right);Cesium.Cartesian3.cross(o.right,o.direction,o.up)}}};C.prototype.limitCameraToInitExtent=function(){var e=this.viewer.camera.positionCartographic.clone();if(!(e.longitude>=this.initExtent.west&&e.longitude<=this.initExtent.east&&e.latitude>=this.initExtent.south&&e.latitude<=this.initExtent.north)){var t=this.viewer.scene.screenSpaceCameraController.maximumZoomDistance,i=.05*e.height/t;e.longitude=Math.max(this.initExtent.west-i,e.longitude);e.latitude=Math.max(this.initExtent.south-i,e.latitude);e.longitude=Math.min(this.initExtent.east+i,e.longitude);e.latitude=Math.min(this.initExtent.north+i,e.latitude);this.viewer.camera.setView({destination:Cesium.Ellipsoid.WGS84.cartographicToCartesian(e),orientation:{heading:this.viewer.camera.heading,pitch:this.viewer.camera.pitch}})}this.viewer.scene.screenSpaceCameraController.minimumZoomDistance=e.height>1800?400:200};var v=function(e,t,i){this.map2D=e;this.listentTo=[TC.Consts.event.LAYERADD,TC.Consts.event.LAYERORDER,TC.Consts.event.LAYERREMOVE,TC.Consts.event.LAYEROPACITY,TC.Consts.event.LAYERVISIBILITY,TC.Consts.event.ZOOM,TC.Consts.event.BASELAYERCHANGE,TC.Consts.event.FEATUREADD,TC.Consts.event.FEATUREREMOVE,TC.Consts.event.LAYERUPDATE,TC.Consts.event.TERRAINLOADED,TC.Consts.event.ZOOMTO].join(" ");this.map3D=t;this.scene_=this.map3D.scene;this.verboseRendering=i;this._boundNotifyRepaintRequired=this.notifyRepaintRequired.bind(this);this.lastCameraViewMatrix_=new Cesium.Matrix4;this.lastCameraMoveTime_=0;this.stoppedRendering=!1;this._removeTileLoadProgressListener=this.scene_.globe.tileLoadProgressEvent.addEventListener(function(e){this.tilesWaiting=0!==e}.bind(this));this._removePostRenderListener=this.scene_.postRender.addEventListener(this.postRender.bind(this));this._wheelEvent="";"onwheel"in this.scene_.canvas?this._wheelEvent="wheel":document.onmousewheel?this._wheelEvent="mousewheel":this._wheelEvent="DOMMouseScroll";this._originalLoadWithXhr=Cesium.loadWithXhr.load;this._originalScheduleTask=Cesium.TaskProcessor.prototype.scheduleTask;this._originalCameraSetView=Cesium.Camera.prototype.setView;this._originalCameraMove=Cesium.Camera.prototype.move;this._originalCameraRotate=Cesium.Camera.prototype.rotate;this._originalCameraLookAt=Cesium.Camera.prototype.lookAt;this._originalCameraFlyTo=Cesium.Camera.prototype.flyTo;this.enable()};v.prototype.repaintOn_=function(e,t){this.scene_.canvas.addEventListener(e,this._boundNotifyRepaintRequired,t)};v.prototype.removeRepaintOn_=function(e,t){this.scene_.canvas.removeEventListener(e,this._boundNotifyRepaintRequired,t)};v.prototype.enable=function(){this.repaintOn_("mousemove",!1);this.repaintOn_("mousedown",!1);this.repaintOn_("mouseup",!1);this.repaintOn_("touchstart",!1);this.repaintOn_("touchend",!1);this.repaintOn_("touchmove",!1);if(window.PointerEvent){this.repaintOn_("pointerdown",!1);this.repaintOn_("pointerup",!1);this.repaintOn_("pointermove",!1)}this.repaintOn_(this._wheelEvent,!1);window.addEventListener("resize",this._boundNotifyRepaintRequired,!1);var e=this;Cesium.loadWithXhr.load=function(t,i,a,r,o,n,s,l,c){n.promise.always(e._boundNotifyRepaintRequired);e._originalLoadWithXhr(t,i,a,r,o,n,s,l,c)};Cesium.TaskProcessor.prototype.scheduleTask=function(t,i){var a=e._originalScheduleTask.call(this,t,i),r=this;if(!r._originalWorkerMessageSinkRepaint){var o=r._worker;r._originalWorkerMessageSinkRepaint=o.onmessage;o.onmessage=function(t){r._originalWorkerMessageSinkRepaint(t);e.notifyRepaintRequired()}}return a};Cesium.Camera.prototype.setView=function(){e._originalCameraSetView.apply(this,arguments);e.notifyRepaintRequired()};Cesium.Camera.prototype.move=function(){e._originalCameraMove.apply(this,arguments);e.notifyRepaintRequired()};Cesium.Camera.prototype.rotate=function(){e._originalCameraRotate.apply(this,arguments);e.notifyRepaintRequired()};Cesium.Camera.prototype.lookAt=function(){e._originalCameraLookAt.apply(this,arguments);e.notifyRepaintRequired()};Cesium.Camera.prototype.flyTo=function(){e._originalCameraFlyTo.apply(this,arguments);e.notifyRepaintRequired()};this.map2D.on(this.listentTo,this._boundNotifyRepaintRequired)};v.prototype.disable=function(){if(this._removePostRenderListener){this._removePostRenderListener();this._removePostRenderListener=void 0}if(this._removeTileLoadProgressListener){this._removeTileLoadProgressListener();this._removeTileLoadProgressListener=void 0}this.removeRepaintOn_("mousemove",!1);this.removeRepaintOn_("mousedown",!1);this.removeRepaintOn_("mouseup",!1);this.removeRepaintOn_("touchstart",!1);this.removeRepaintOn_("touchend",!1);this.removeRepaintOn_("touchmove",!1);if(window.PointerEvent){this.removeRepaintOn_("pointerdown",!1);this.removeRepaintOn_("pointerup",!1);this.removeRepaintOn_("pointermove",!1)}this.removeRepaintOn_(this._wheelEvent,!1);window.removeEventListener("resize",this._boundNotifyRepaintRequired,!1);Cesium.loadWithXhr.load=this._originalLoadWithXhr;Cesium.TaskProcessor.prototype.scheduleTask=this._originalScheduleTask;Cesium.Camera.prototype.setView=this._originalCameraSetView;Cesium.Camera.prototype.move=this._originalCameraMove;Cesium.Camera.prototype.rotate=this._originalCameraRotate;Cesium.Camera.prototype.lookAt=this._originalCameraLookAt;Cesium.Camera.prototype.flyTo=this._originalCameraFlyTo;this.map2D.off(this.listentTo,this._boundNotifyRepaintRequired)};v.prototype.postRender=function(e){var t=Date.now(),i=this.scene_,a=i.camera;Cesium.Matrix4.equalsEpsilon(this.lastCameraViewMatrix_,a.viewMatrix,1e-5)||(this.lastCameraMoveTime_=t);var r=t-this.lastCameraMoveTime_<3e3,o=i.tweens;if(!r&&!this.tilesWaiting&&0==o.length){this.verboseRendering&&console.log("stopping rendering @ "+Date.now());this.parent.setBlockRendering(!0);this.stoppedRendering=!0}Cesium.Matrix4.clone(a.viewMatrix,this.lastCameraViewMatrix_)};v.prototype.restart=function(){this.notifyRepaintRequired()};v.prototype.notifyRepaintRequired=function(){this.verboseRendering&&this.stoppedRendering&&console.log("starting rendering @ "+Date.now());this.lastCameraMoveTime_=Date.now();this.parent.setBlockRendering(!1);this.stoppedRendering=!1};v.prototype.setDebug=function(e){this.verboseRendering=e};var f=function(e,t,i){this.idRequestAnimationFrame=null;this._blockRendering=!1;this._canvasClientWidth=0;this._canvasClientHeight=0;this._resolutionScale=1;this._viewer=t;this._canvas=t.scene.canvas;this._clock=t.clock||new Cesium.Clock;this._handleResize=function(e){var t=this._canvas.clientWidth,i=this._canvas.clientHeight;if(!(0===t|0===i||t===this._canvasClientWidth&&i===this._canvasClientHeight)){var a=this._resolutionScale;this._canvasClientWidth=t;this._canvasClientHeight=i;t*=a;i*=a;this._canvas.width=t;this._canvas.height=i;e.scene.camera.frustum.aspectRatio=t/i}};this._renderingAnimation=function(){this.idRequestAnimationFrame=requestAnimationFrame(function e(){if(!this._blockRendering){this._viewer.scene.initializeFrame();this._handleResize(this._viewer);var t=this._clock.tick()||Cesium.JulianDate.now();this._viewer.scene.render(t)}this.idRequestAnimationFrame=requestAnimationFrame(e.bind(this))}.bind(this))};i&&(this._resolutionScale=.5);this.renderLoop=new v(e,t,!1);this.renderLoop.parent=this};f.prototype.start=function(e){this.renderLoop.setDebug(e||!1);this._renderingAnimation()};f.prototype.stop=function(){window.cancelAnimationFrame(this.idRequestAnimationFrame)};f.prototype.restart=function(){this.renderLoop.restart()};f.prototype.setBlockRendering=function(e){this._blockRendering=e};f.prototype.getCanvas=function(){return this._canvas};var g,w,y,T,D,R,b,L,M,A,k=function(e){var t,i=!1,a=null,r=null,o=null,n=e.map.getResolution,s=function(){var t=new $.Deferred;if(r)t.resolve();else{TC.control.ResultsPanel||TC.syncLoadJS(TC.apiLocation+"TC/control/ResultsPanel");const i=e.map.getControlsByClass(TC.control.ResultsPanel).filter(function(e){return"chart"===e.options.content})[0],a=i?i._$div:$("<div>").appendTo(e.map._$div);e.map.addControl("ResultsPanel",{div:a,content:"table",titles:{main:e.getLocaleString("threed.rs.panel.gfi"),max:e.getLocaleString("threed.rs.panel.gfi")}}).then(function(i){r=i;e.ctlResultsPanel=r;t.resolve()})}return t},l=function(){e.map3D.removeFeature.call(e,a);a=null};if(o=e.map.getControlsByClass(TC.control.FeatureInfo)[0]){t=o.displayMode;$.when(s()).then(function(){o.setDisplayMode(TC.control.FeatureInfoCommons.displayMode.RESULTS_PANEL);e.map.on(TC.Consts.event.RESULTSPANELCLOSE,function(e){e.control===o.getDisplayControl()&&(o.querying||l())})})}this.clear=function(){o.closeResults();l();e.ctlResultsPanel.close()};this.reset=function(){this.clear();o.setDisplayMode(t);e.map.getResolution=n};this.send=function(t){var r=new $.Deferred;i=!0;o.displayMode!==TC.control.FeatureInfoCommons.displayMode.RESULTS_PANEL&&o.setDisplayMode(TC.control.FeatureInfoCommons.displayMode.RESULTS_PANEL);o.resultsPanel&&o.resultsPanel.close();e.waiting||(e.waiting=e.map.getLoadingIndicator().addWait());!function(t){if(a)a.position=t;else{TC.control.FeatureInfoCommons.prototype.markerStyle;var i={position:t,billboard:{image:TC.Util.getBackgroundUrlFromCss(e.CLASS+"-marker"),eyeOffset:new Cesium.Cartesian3(0,0,-100),verticalOrigin:Cesium.VerticalOrigin.BOTTOM,heightReference:Cesium.HeightReference.CLAMP_TO_GROUND}};a=e.map3D.addNativeFeature.call(e,i)}e.viewer.scene.requestRender()}(t);$.when(s()).then(function(){for(var a,n=Cesium.Ellipsoid.WGS84.cartesianToCartographic(t),s=TC.Util.reproject([Cesium.Math.toDegrees(n.longitude),Cesium.Math.toDegrees(n.latitude)],e.map3D.crs,e.map.crs),l=(e.map.options.pixelTolerance||TC.Cfg.pixelTolerance,e.viewer.scene.globe._surface._tilesToRender),c=0;!a&&c<l.length;++c){var u=l[c];Cesium.Rectangle.contains(u.rectangle,n)&&(a=u)}if(!a)return r;for(var m=a.data.imagery,p=m.length-1;p>=0;--p){if(!m[p].readyImagery)return r}var h=a.tilingScheme.tileXYToNativeRectangle(a.x,a.y,a.level),d=(m.filter(function(e){return e.readyImagery.imageryLayer.isBaseLayer()})[0]||{}).readyImagery;e.map.getResolution=function(){var t=TC.Util.reproject([h.west,h.south],e.map3D.crs,e.map.crs),i=TC.Util.reproject([h.east,h.north],e.map3D.crs,e.map.crs),a=(i[0]-t[0])/(d&&d.imageryLayer.imageryProvider.tileWidth||256),r=(i[1]-t[1])/(d&&d.imageryLayer.imageryProvider.tileHeight||256);return Math.max(a,r)}.bind(e,d,h);var C=e;e.map.one(TC.Consts.event.NOFEATUREINFO,function(e){i=!1;C.map3D.linked2DControls.geolocation.track&&C.map3D.linked2DControls.geolocation.track.$info.addClass(TC.Consts.classes.HIDDEN);C.map3D.linked2DControls.geolocation.resultsPanelChart&&C.map3D.linked2DControls.geolocation.resultsPanelChart.close();r.resolve(e)});e.map.one(TC.Consts.event.FEATUREINFO,function(e){i=!1;C.map3D.linked2DControls.geolocation.track&&C.map3D.linked2DControls.geolocation.track.$info.addClass(TC.Consts.classes.HIDDEN);C.map3D.linked2DControls.geolocation.resultsPanelChart&&C.map3D.linked2DControls.geolocation.resultsPanelChart.close();r.resolve(e)});o.isActive;o.isActive=!0;o.beforeRequest({xy:[0,0]});o.callback(s)});return r};this.get2DMarker=function(){return o.filterFeature};this.isPending=function(){return i}},S=function(e){this.layerCrs=null;var t,i=["Contents","TileMatrixSet"],a=function(e,t,i){if(i<t.length-1)return e.hasOwnProperty(t[i])?a(e[t[i]],t,++i):null;if(e instanceof Array){for(var r=[],o=0;o<e.length;o++)e[o].hasOwnProperty(t[i])&&r.push(e[o][t[i]]);return r}return e[t[i]]},r=function(e){var r=new $.Deferred,o=function(e,t){if((capsURL=TC.Util.isOnCapabilities(e.url))&&(caps=TC.capabilities[capsURL]))for(var r=a(caps,i,0),o=0;o<r.length;o++)if(r[o].Identifier===t)return a(r[o],["TileMatrix","Identifier"],0);return null}(e,this.layerCrs),n={url:new t({url:e.options.urlPattern},e),layer:e.layerNames,style:"default",format:e.format||e.options.format,tileMatrixSetID:this.layerCrs,tileMatrixLabels:o,tilingScheme:new Cesium.GeographicTilingScheme};r.resolve(new Cesium.WebMapTileServiceImageryProvider(n));return r},o=function(){try{var e=new XMLHttpRequest;e.open("GET","#",!0);e.responseType="blob";return"blob"===e.responseType}catch(e){return!1}}();function n(e,t){var i=e.request;i.url=e.url;i.requestFunction=function(){var i=e.url,a=!1;e.isDataUri||e.isBlobUri||(a=e.isCrossOriginUrl);var r=Cesium.when.defer();!function(e,t,i,a){var r=function(e){var t=new Image;t.onload=function(){a.resolve(t)};t.onerror=function(e){a.reject(e)};i&&(Cesium.TrustedServers.contains(e)?t.crossOrigin="use-credentials":t.crossOrigin="");t.src=e};e.getWebGLUrl===TC.layer.Raster.prototype.getWebGLUrl?e.getWebGLUrl.call(e,t).then(r):r(e.getWebGLUrl(t))}(e.layer,i,a&&t,r);return r.promise};var a=Cesium.RequestScheduler.request(i);if(Cesium.defined(a))return a.otherwise(function(a){return i.state!==Cesium.RequestState.FAILED?Cesium.when.reject(a):e.retryOnError(a).then(function(r){if(r){i.state=Cesium.RequestState.UNISSUED;i.deferred=void 0;return n(e,t)}return Cesium.when.reject(a)})})}var s=function(e,t){Cesium.defined(t)&&Cesium.deprecationWarning("Resource.fetchImage.allowCrossOrigin","The allowCrossOrigin parameter has been deprecated and will be removed in Cesium 1.44. It no longer needs to be specified.");e=Cesium.defaultValue(e,!1);t=Cesium.defaultValue(t,!0);!function(e){if(e.state===Cesium.RequestState.ISSUED||e.state===Cesium.RequestState.ACTIVE)throw new Cesium.RuntimeError("The Resource is already being fetched.");e.state=Cesium.RequestState.UNISSUED;e.deferred=void 0}(this.request);if(!o||this.isDataUri||this.isBlobUri||!this.hasHeaders&&!e)return n(this,t);var i=this.fetchBlob();if(Cesium.defined(i)){var a,r;return i.then(function(e){if(Cesium.defined(e)){r=e;var t=window.URL.createObjectURL(e);return n(a=new Cesium.Resource({url:t}))}}).then(function(e){if(Cesium.defined(e)){window.URL.revokeObjectURL(a.url);e.blob=r;return e}}).otherwise(function(e){Cesium.defined(a)&&window.URL.revokeObjectURL(a.url);return Cesium.when.reject(e)})}};this.convert=function(e,i){this.layerCrs=i;t||function(){(t=function(e,t){Cesium.Resource.call(this,e);this.layer=t}).prototype.constructor=t;t.prototype=Object.create(Cesium.Resource.prototype,{});t.prototype.clone=function(e){var i=Cesium.Resource.prototype.clone.call(this,e);Cesium.defined(e)||(e=new t({url:this._url},this.layer));e._url=i._url;e._queryParameters=i._queryParameters;e._templateValues=i._templateValues;e.headers=i.headers;e.proxy=i.proxy;e.retryCallback=i.retryCallback;e.retryAttempts=i.retryAttempts;e._retryCount=0;e.request=i.request;return e};t.prototype.fetchImage=s}();switch(!0){case TC.Consts.layerType.WMTS==e.type:return r.call(this,e);case TC.Consts.layerType.WMS==e.type:return function(e){var i=new $.Deferred,a={url:new t({url:e.url},e),layers:e.layerNames,parameters:{version:"1.3.0",transparent:!0,format:e.format||e.options.format}};i.resolve(new Cesium.WebMapServiceImageryProvider(a));return i}.call(this,e)}}},O=function(){var e=null,t=function(e,t){e instanceof Array&&(e="rgba("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")");var i=Cesium.Color.fromCssColorString(e);return t?i.withAlpha(t):i},i=function(e,t,i){for(var a in t){var r=e[t[a].prop];if(r)if("function"==typeof r){var o=r(i);o&&(t[a].val=o)}else t[a].val=r}},a=function(e){var t;t=void 0==(t=e.layer.hasOwnProperty("styles")?e.layer.styles:TC.Defaults.styles)[e.STYLETYPE]?t["polyline"===e.STYLETYPE?"line":e.STYLETYPE]:t["multipolygon"===e.STYLETYPE?"polygon":e.STYLETYPE];return t=$.extend({},t,e.options,e.getStyle())};function r(e){return Cesium.sampleTerrainMostDetailed(this.provider,e.map(function(e){return Cesium.Cartographic.fromCartesian(e)}))}function o(e,t,i,a){a(new Cesium.Entity({id:e,polyline:{positions:Cesium.Ellipsoid.WGS84.cartographicArrayToCartesianArray(t),material:i.material,width:i.width,granularity:Cesium.Math.toRadians(.1)}}))}var n=function(e){var n={},s=a(e);n.options=function(){var a,r={},o={color:{prop:"fillColor"},opacity:{prop:"fillOpacity"},outlineColor:{prop:"strokeColor"},outlineOpacity:{prop:"strokeOpacity"},width:{prop:"strokeWidth"}};i(s,o,e);o.color.hasOwnProperty("val")&&(a=o.opacity.hasOwnProperty("val")?t(o.color.val,o.opacity.val):t(o.color.val));r.color=Cesium.ColorGeometryInstanceAttribute.fromColor(a);o.outlineColor.hasOwnProperty("val")&&(a=o.outlineOpacity.hasOwnProperty("val")?t(o.outlineColor.val,o.outlineOpacity.val):t(o.outlineColor.val));r.outlineColor=a;o.width.hasOwnProperty("val")&&(r.width=o.width.val);return r};TC.feature.MultiPolygon&&e instanceof TC.feature.MultiPolygon?n.geometryType=function(t,i){for(var a,n=new $.Deferred,s=[],l=[],c=[],u=function(t){var a=new $.Deferred;Cesium.when(r.call(this,t),function(t){o(e.id+"outLine"+c.length,t,{material:i.outlineColor,width:i.width},function(e){c.push(e);a.resolve()})});return a},m=0;m<t.length;m++){for(var p=0;p<t[m].length;p++){var h;if(0==p){s.push(u.call(this,t[m][0]));h=new Cesium.PolygonHierarchy(t[m][0])}else{s.push(u.call(this,t[m][p]));h.holes.push(new Cesium.PolygonHierarchy(t[m][p]))}}l.push((a=h,new Cesium.GeometryInstance({id:e.id,geometry:new Cesium.PolygonGeometry({polygonHierarchy:a}),attributes:{color:i.color}})))}$.when.apply($,s).then(function(){s=[];n.resolve([new Cesium.GroundPrimitive({geometryInstances:l}),c])});return n}:TC.feature.Polygon&&e instanceof TC.feature.Polygon&&(n.geometryType=function(t,i){var a=new $.Deferred;$.isArray(t)&&1===t.length&&$.isArray(t[0])&&(t=t[0]);Cesium.when(r.call(this,t),function(r){o(e.id+"outLine",r,{material:i.outlineColor,width:i.width},function(r){a.resolve([new Cesium.GroundPrimitive({geometryInstances:new Cesium.GeometryInstance({id:e.id,geometry:new Cesium.PolygonGeometry({polygonHierarchy:new Cesium.PolygonHierarchy(t)}),attributes:{color:i.color}})}),r])})});return a});return n},s=function(n){var s={},l=a(n);s.options=function(){var e,a={},r={color:{prop:"strokeColor"},opacity:{prop:"strokeOpacity"},width:{prop:"strokeWidth"}};i(l,r,n);r.width.hasOwnProperty("val")&&(a.width=r.width.val);r.color.hasOwnProperty("val")&&(e=r.opacity.hasOwnProperty("val")?t(r.color.val,r.opacity.val):t(r.color.val));a.color=e;return a};TC.feature.MultiPolyline&&n instanceof TC.feature.MultiPolyline?s.geometryType=function(t,i){var a=[],s=new $.Deferred,l=[];if(1==t.length){t=t[0];var c=new $.Deferred;l.push(c);Cesium.when(r.call(this,t),function(e){o(n.id,e,{material:i.color,width:i.width},function(e){a.push(e);c.resolve()})})}else{(function(t){var i;if(1==t.length){var a,r,o,n,s=t[0];a=new Cesium.Cartesian3(s.x-1e3,s.y,s.z);r=new Cesium.Cartesian3(s.x,s.y-1e3,s.z);o=new Cesium.Cartesian3(s.x+1e3,s.y,s.z);n=new Cesium.Cartesian3(s.x,s.y+1e3,s.z);i=Cesium.Rectangle.fromCartesianArray([a,r,o,n],Cesium.Ellipsoid.WGS84)}else i=Cesium.Rectangle.fromCartesianArray(t,Cesium.Ellipsoid.WGS84);var l=e.camera.getRectangleCameraCoordinates(i),c=Cesium.Cartesian3.distance(l,Cesium.BoundingSphere.fromPoints(t).center),u=e.camera.frustum.getPixelDimensions(e.drawingBufferWidth,e.drawingBufferHeight,c,new Cesium.Cartesian2);u=Math.max(u.x,u.y);Math.round(u)})((t=t.sort(function(e,t){return e.length>t.length?-1:e.length<t.length?1:0}))[0]);for(var u=0;u<t.length;u++){c=new $.Deferred;l.push(c);Cesium.when(r.call(this,t[u]),function(e){o(n.id,e,{material:i.color,width:i.width},function(e){a.push(e);c.resolve()})})}}$.when.apply($,l).then(function(){l=[];s.resolve(a)});return s}:TC.feature.Polyline&&n instanceof TC.feature.Polyline&&(s.geometryType=function(e,t){var i=new $.Deferred;Cesium.when(r.call(this,e),function(e){o(n.id,e,{material:t.color,width:t.width},function(e){i.resolve(e)})});return i});return s},l=function(e){var r={},o=a(e);r.options=function(){var a={},r={rotation:{prop:"angle"},label:{prop:"label"},fontSize:{prop:"fontSize"},fontColor:{prop:"fontColor"},outlineLabelColor:{prop:"labelOutlineColor"},outlineLabelWidth:{prop:"labelOutlineWidth"},anchor:{prop:"anchor"},height:{prop:"height"},width:{prop:"width"},url:{prop:"url"},color:{prop:"fillColor"},opacity:{prop:"fillOpacity"},outlineColor:{prop:"strokeColor"},outlineOpacity:{prop:"strokeOpacity"},outlineWidth:{prop:"strokeWidth"},radius:{prop:"radius"}};i(o,r,e);if(r.anchor.hasOwnProperty("val")){!r.url.hasOwnProperty("val")&&e.options.url?a.url=e.options.url:a.url=r.url.val;a.anchor=r.anchor.val}r.height.hasOwnProperty("val")&&(a.height=r.height.val);r.width.hasOwnProperty("val")&&(a.width=r.width.val);r.rotation.hasOwnProperty("val")&&(a.rotation=r.rotation.val);r.label.hasOwnProperty("val")&&(a.label=r.label.val);r.fontSize.hasOwnProperty("val")&&(a.fontSize=r.fontSize.val);r.fontColor.hasOwnProperty("val")&&(a.fontColor=t(r.fontColor.val));r.outlineLabelColor.hasOwnProperty("val")&&(a.outlineLabelColor=t(r.outlineLabelColor.val));r.outlineLabelWidth.hasOwnProperty("val")&&(a.outlineLabelWidth=r.outlineLabelWidth.val);r.color.hasOwnProperty("val")&&(r.opacity.hasOwnProperty("val")?a.color=t(r.color.val,r.opacity.val):a.color=t(r.color.val));r.outlineColor.hasOwnProperty("val")&&(r.outlineOpacity.hasOwnProperty("val")?a.outlineColor=t(r.outlineColor.val,r.outlineOpacity.val):a.outlineColor=t(r.outlineColor.val));r.outlineWidth.hasOwnProperty("val")&&(a.outlineWidth=r.outlineWidth.val);r.radius.hasOwnProperty("val")&&(a.radius=r.radius.val);return a};if(TC.feature.Marker&&e instanceof TC.feature.Marker)r.geometryType=function(t,i){var a={id:e.id,name:e.id,position:t[0],billboard:{image:i.url,width:i.width,height:i.height,eyeOffset:new Cesium.Cartesian3(0,0,-100),pixelOffset:new Cesium.Cartesian2(i.anchor[0],i.anchor[1]),verticalOrigin:Cesium.VerticalOrigin.BOTTOM,heightReference:Cesium.HeightReference.CLAMP_TO_GROUND}};return i.label?[a,{id:e.id,name:e.id,position:t[0],label:{text:i.label,font:"14pt sans-serif",heightReference:Cesium.HeightReference.CLAMP_TO_GROUND,horizontalOrigin:Cesium.HorizontalOrigin.CENTER,verticalOrigin:Cesium.VerticalOrigin.BOTTOM,fillColor:i.fontColor,showBackground:!0,eyeOffset:new Cesium.Cartesian3(0,0,-100)}}]:a};else if(TC.feature.Point&&e instanceof TC.feature.Point){var n=new Cesium.PinBuilder;r.geometryType=function(t,i){var a=i.label;switch(!0){case a&&/^([A-Z])\w+$/gi.test(a):case a&&!/^[0-9]*\-{0,1}[a-z]{0,4}$/gi.test(a):return{id:e.id,name:e.id,position:t[0],label:{text:i.label,font:"14px san-serif Arial",showBackground:!0,eyeOffset:new Cesium.Cartesian3(0,0,-100),heightReference:Cesium.HeightReference.CLAMP_TO_GROUND,horizontalOrigin:Cesium.HorizontalOrigin.CENTER,verticalOrigin:Cesium.VerticalOrigin.BASELINE,fillColor:Cesium.Color.WHITE}};case/^[0-9]*\-{0,1}[a-z]{0,4}$/gi.test(a):return{id:e.id,name:e.id,position:t[0],billboard:{image:n.fromText(a,i.fontColor,48).toDataURL(),eyeOffset:new Cesium.Cartesian3(0,0,-100),verticalOrigin:Cesium.VerticalOrigin.BOTTOM,heightReference:Cesium.HeightReference.CLAMP_TO_GROUND}};default:return{id:e.id,name:e.id,position:t[0],billboard:{image:n.fromColor(e.options.fillColor?new Cesium.Color(e.options.fillColor):Cesium.Color.fromCssColorString(TC.Cfg.styles.point.fillColor),32).toDataURL(),eyeOffset:new Cesium.Cartesian3(0,0,-100),verticalOrigin:Cesium.VerticalOrigin.BOTTOM,horizontalOrigin:Cesium.HorizontalOrigin.CENTER,heightReference:Cesium.HeightReference.CLAMP_TO_GROUND}}}}}return r};this.convert=function(r,o,c,u){e=r;var m,p,h,d,C,v=!1,f=[],g=function(e,t){if($.isArray(e)){e=TC.Util.reproject(e,c,u);t.push(e.length>2?Cesium.Cartesian3.fromDegrees(e[0],e[1],e[2]):Cesium.Cartesian3.fromDegrees(e[0],e[1]))}},w=o.geometry,y=function(e,t){if($.isArray(e))for(var i=0;i<e.length;i++)g(e[i],t)},T=function(e,t){if($.isArray(e))for(var i=0;i<e.length;i++){t.push([]);y(e[i],t[t.length-1])}};switch(!0){case TC.feature.Circle&&o instanceof TC.feature.Circle:y(w,f);p=function(e){var r={},o=a(e);r.options=function(){var a,r={},n={color:{prop:"strokeColor"},opacity:{prop:"fillOpacity"},outlineColor:{prop:"fillColor"},outlineOpacity:{prop:"strokeOpacity"},width:{prop:"strokeWidth"}};i(o,n,e);n.color.hasOwnProperty("val")&&(a=n.opacity.hasOwnProperty("val")?t(n.color.val,n.opacity.val):t(n.color.val));r.color=Cesium.ColorGeometryInstanceAttribute.fromColor(a);n.outlineColor.hasOwnProperty("val")&&(a=n.outlineOpacity.hasOwnProperty("val")?t(n.outlineColor.val,n.outlineOpacity.val):t(n.outlineColor.val));r.outlineColor=Cesium.ColorGeometryInstanceAttribute.fromColor(a);n.width.hasOwnProperty("val")&&(r.width=n.width.val);return r};r.geometryType=function(t,i){return new Cesium.GroundPrimitive({geometryInstances:new Cesium.GeometryInstance({id:e.id,geometry:new Cesium.CircleGeometry({center:t[0],radius:e.geometry[1]}),attributes:{color:i.color}})})};return r}.call(self,o);break;case TC.feature.MultiPolygon&&o instanceof TC.feature.MultiPolygon:C=w;if($.isArray(C)){!function(e){if($.isArray(e))for(var t=0;t<e.length;t++){f.push([]);T(e[t],f[f.length-1])}}(C);p=n.call(self,o);v=!0}break;case TC.feature.Polygon&&o instanceof TC.feature.Polygon||TC.feature.MultiPolyline&&o instanceof TC.feature.MultiPolyline:d=w;if($.isArray(d)){T(d,f);if(o instanceof TC.feature.Polygon){p=n(o);v=!0}else if(o instanceof TC.feature.MultiPolyline){p=s(o);v=!0}}break;case TC.feature.Polyline&&o instanceof TC.feature.Polyline:h=w;if($.isArray(h)){y(h,f);p=s(o);v=!0}break;case TC.feature.Marker&&o instanceof TC.feature.Marker:case TC.feature.Point&&o instanceof TC.feature.Point:y(h=[w],f);p=l(o)}if(0==f.length)return null;(m={id:o.id,attributes:o.data,boundigSphere:Cesium.BoundingSphere.fromPoints(f)}).geometry=v?function(e){p.provider=e;return p.geometryType(f,p.options())}:p.geometryType(f,p.options());return m}};e.map3D=(g={baseMap:"",baseMaps:[],baseVector:""},w=new S(/(EPSG\:?4326)/i),y=new O,T=function(e){var t=e;switch(!0){case e instanceof Cesium.GroundPrimitive:this.viewer.scene.groundPrimitives.add(e);break;case e instanceof Object&&e.hasOwnProperty("billboard"):this.viewer.billboardCollection||(this.viewer.billboardCollection=this.viewer.scene.primitives.add(new Cesium.BillboardCollection({scene:this.viewer.scene})));t=this.viewer.billboardCollection.add({position:e.position,image:e.billboard.image,verticalOrigin:e.billboard.verticalOrigin,heightReference:e.billboard.heightReference});break;case e instanceof Object:t=this.viewer.entities.add(e)}this.viewer.scene.requestRender();return t},D=function(e,t,i){e.vector2DFeatures.hasOwnProperty(t)?e.vector2DFeatures[t].push(i):e.vector2DFeatures[t]=[i]},R=[TC.Consts.event.BEFOREBASELAYERCHANGE,TC.Consts.event.BASELAYERCHANGE,TC.Consts.event.LAYERADD,TC.Consts.event.LAYERREMOVE,TC.Consts.event.LAYERVISIBILITY,TC.Consts.event.LAYEROPACITY,TC.Consts.event.LAYERORDER,TC.Consts.event.FEATUREADD,TC.Consts.event.FEATUREREMOVE,TC.Consts.event.FEATURESCLEAR,TC.Consts.event.ZOOMTO],b=function(){if(!this.map3D.trackingEntity){var e=this.map3D.linked2DControls.geolocation,t=e.layerTracking.features.filter(function(e){return e instanceof TC.feature.Polyline});if(t&&t.length>0){var i=[],a=new Cesium.Entity({id:"trackingEntity",polyline:{positions:new Cesium.CallbackProperty(function(e,a){if(t[0].geometry.length>i.length){var r=t[0].geometry.slice(i.length).map(function(e){var t=TC.Util.reproject(e,this.map.crs,this.map3D.crs);return Cesium.Cartographic.fromDegrees(t[0],t[1],e[2])}.bind(this));Cesium.when(Cesium.sampleTerrainMostDetailed(this.viewer.scene.globe.terrainProvider,r),function(e){e=e instanceof Array?Cesium.Ellipsoid.WGS84.cartographicArrayToCartesianArray(e):[Cesium.Ellipsoid.WGS84.cartographicToCartesian(e)];return i=i.concat(e)})}return i}.bind(this),!1),width:3,material:new Cesium.PolylineDashMaterialProperty({color:new Cesium.CallbackProperty(function(t,i){return Cesium.Color.fromAlpha(new Cesium.Color(0,255,209),e.track.renderTrack.is(":checked")?1:0)}.bind(this),!1),gapColor:Cesium.Color.TRANSPARENT})}});this.map3D.trackingEntity=this.viewer.entities.add(a);this.viewer.scene.requestRender()}}},L=function(e){var t=this.map3D.linked2DControls.geolocation;switch(!0){case t.Const.Event.IMPORTEDTRACK.indexOf(e.type)>-1:case e.target.className.indexOf("draw")>-1&&$(e.target).parent().hasClass(t.Const.Classes.SELECTEDTRACK):case!$(e.target).parent().hasClass(t.Const.Classes.SELECTEDTRACK):case e.target.className.indexOf("stop")>-1:if(this.mapIs3D){this.viewer.clock.shouldAnimate=!1;this.viewer.clock.currentTime=Cesium.JulianDate.fromDate(new Date)}if(this.map3D.trackDataSource){if(this.map3D.trackDataSource.length>0){var i=this.map3D.trackDataSource.get(0).entities.values[0];this.viewer.entities.removeById(i.id)}this.map3D.trackDataSource.destroy();delete this.map3D.trackDataSource}t.chartProgressClear();e.custom&&t.getSelectedTrack().find(t.Const.Selector.STOP).click();break;case e.target.className.indexOf("play")>-1:this.viewer.clock.shouldAnimate=!1;break;case e.target.className.indexOf("pause")>-1:this.viewer.clock.shouldAnimate=!0;break;case e.target.className.indexOf("back")>-1:case e.target.className.indexOf("for")>-1:this.viewer.clock.multiplier=t.simulate_speed}},M=function(e){var t,i=this;i.map.controls.map(function(t){if(i.ctrlsToMng.indexOf(t)<0)switch(!0){case i.direction.TO_TWO_D==e:t.enable();break;case i.direction.TO_THREE_D==e:t.disable()}});switch(!0){case i.direction.TO_TWO_D==e:$("[data-no-3d]").removeClass(TC.Consts.classes.THREED_HIDDEN);i.ctrlsToMng.forEach(function(e){e._$div.removeClass(TC.Consts.classes.THREED)});break;case i.direction.TO_THREE_D==e:$("[data-no-3d]").addClass(TC.Consts.classes.THREED_HIDDEN);i.ctrlsToMng.forEach(function(e){e._$div.addClass(TC.Consts.classes.THREED)})}!i.map3D.linked2DControls.coordinates&&i.allowedControls.indexOf("coordinates")>-1&&(i.map3D.linked2DControls.coordinates=i.ctrlsToMng.filter(function(e){return e instanceof TC.control.Coordinates})[0]);if(t=i.map3D.linked2DControls.coordinates){$viewport=$(t.map.wrap.getViewport());if(i.direction.TO_THREE_D===e){$viewport.off(TC.Consts.event.MOUSEMOVE+".coords");t.isGeo=!0;t.crs=i.map3D.crs}else{t.isGeo=i.map.wrap.isGeo();t.crs=i.map.crs;$viewport.on(TC.Consts.event.MOUSEMOVE+".coords",function(e){t.onMouseMove(e)})}t.geoCrs=i.map3D.crs;t.render();new Cesium.ScreenSpaceEventHandler(i.viewer.scene.canvas,!1).setInputAction(function(e){if(i.viewer){var a=i.viewer.camera.getPickRay(e.endPosition||e.position),r=i.viewer.scene.globe.pick(a,i.viewer.scene);if(r){var o,n,s,l=Cesium.Ellipsoid.WGS84.cartesianToCartographic(r);o=Cesium.Math.toDegrees(l.latitude);n=Cesium.Math.toDegrees(l.longitude);var c=TC.Util.getMapLocale(i.map);s=Math.round(l.height).toLocaleString(c);if(TC.Util.detectMobile()){var u=TC.Util.reproject([n,o],i.map3D.crs,i.map.crs);s>0&&u.push(s);t.clear();t.coordsToClick({coordinate:u,cssClass:i.classes.COORDSTHREEDMARKER});t.latLon=[o,n];s>0&&t.latLon.push(s+" m");t.update()}else{t.latLon=[o,n];s>0&&t.latLon.push(s+" m");t.update()}}else t.clear()}},TC.Util.detectMobile()?Cesium.ScreenSpaceEventType.LEFT_CLICK:Cesium.ScreenSpaceEventType.MOUSE_MOVE);$("."+i.classes.MAPTHREED).on("mouseout.tc",function(e){t.isPointerOver(e)||t.clear()})}if(i.direction.TO_THREE_D===e){i.map3D.linked2DControls.legend=new function(e){var t=e.map.getControlsByClass(TC.control.Legend)[0];this.refresh=function(){t&&e.map3D.workLayers.length>0&&t.loadGraphics()}}(i);i.map3D.linked2DControls.featureInfo||(i.map3D.linked2DControls.featureInfo=new k(i));new Cesium.ScreenSpaceEventHandler(i.viewer.canvas,!1).setInputAction(function(e){if(!i.viewer.trackedEntity){var t=i.viewer.camera.getPickRay(e.position),a=i.viewer.scene.globe.pick(t,i.viewer.scene);a&&i.map3D.getInfoOnPickedPosition.call(i,a)}},Cesium.ScreenSpaceEventType.LEFT_CLICK)}!i.map3D.linked2DControls.geolocation&&i.allowedControls.indexOf("geolocation")>-1&&(i.map3D.linked2DControls.geolocation=i.ctrlsToMng.filter(function(e){return e instanceof TC.control.Geolocation})[0]);if(i.map3D.linked2DControls.geolocation){var a=i.map3D.linked2DControls.geolocation;if(i.direction.TO_THREE_D===e){a._CHART_SIZE=$.extend({},a.CHART_SIZE);a.CHART_SIZE.MIN_HEIGHT=80;a.CHART_SIZE.MIN_WIDTH=300;var r=[a.Const.Selector.STOP,a.Const.Selector.PAUSE,a.Const.Selector.BACKWARD,a.Const.Selector.FORWARD,a.Const.Selector.DRAW],o=L.bind(i);a.reset=function(){a.CHART_SIZE=a._CHART_SIZE;TC.wrap.control.Geolocation.prototype.setTracking=a._setTracking;TC.wrap.control.Geolocation.prototype.simulateTrack=a._wrap_simulateTrack;TC.wrap.control.Geolocation.prototype.showElevationMarker=a._wrap_showElevationMarker;TC.wrap.control.Geolocation.prototype.hideElevationMarker=a._wrap_hideElevationMarker;a.renderInfoNewPosition=a._renderInfoNewPosition;a.setFormatInfoNewPosition=a._setFormatInfoNewPosition;a.simulateTrack=a._simulateTrack;a.elevationTrack=a._elevationTrack;r.forEach(function(e){$(document).off("click",i.map3D.linked2DControls.geolocation._classSelector+" "+e,o)});a.$events.off(a.Const.Event.IMPORTEDTRACK,o)};r.forEach(function(e){$(document).on("click",i.map3D.linked2DControls.geolocation._classSelector+" "+e,o)});a.$events.on(a.Const.Event.IMPORTEDTRACK,o);var n,s=i,l=!1;a._setTracking=TC.wrap.control.Geolocation.prototype.setTracking;TC.wrap.control.Geolocation.prototype.setTracking=function(e){a._setTracking.call(a.wrap,e);if(e)a.$events.on(a.Const.Event.POSITIONCHANGE,b.bind(i));else{l=!1;a.$events.off(a.Const.Event.POSITIONCHANGE,b.bind(i));if(i.map3D.trackingEntity){i.viewer.entities.removeById(i.map3D.trackingEntity.id);delete i.map3D.trackingEntity}}};a._elevationTrack=a.elevationTrack;a.elevationTrack=function(e,t){s.map3D.linked2DControls.featureInfo&&s.map3D.linked2DControls.featureInfo.clear();s.map3D.linked2DControls.geolocation.track.$info.hasClass(TC.Consts.classes.HIDDEN);t&&L.call(i,{target:{className:"stop"},custom:!0});a._elevationTrack.call(a,e,t)};a.getSelectedTrack().length>0&&a.hasElevation&&a.elevationTrack.call(i,a.getSelectedTrack().first(),!0);a._simulateTrack=a.simulateTrack;a.simulateTrack=function(e){var t=this.map3D.linked2DControls.geolocation;t.map.toast(t.getLocaleString("threed.interactionSimulation"),{type:TC.Consts.msgType.INFO});if(this.viewer.clock.shouldAnimate&&this.map3D.trackDataSource){n();L.call(this,{target:{className:"stop"},custom:!0})}t.simulate_speed=1;t.drawTrack(e,!1);if(t.hasElevation){t.elevationTrack(e);t.chartProgressInit()}if(t.layerTrack&&t.layerTrack.features){var i=t.layerTrack.features.filter(function(e){return e instanceof TC.feature.Polyline})[0];i&&function(e,t,i,a,r,o){var n=$.Deferred(),s=e.map(function(e){var t=TC.Util.reproject(e,this.map.crs,this.map3D.crs);return Cesium.Cartographic.fromDegrees(t[0],t[1])}.bind(this));Cesium.when(Cesium.sampleTerrainMostDetailed(this.viewer.scene.globe.terrainProvider,s),function(r){var s,l,c=0;if(t===ol.geom.GeometryLayout.XYZM){s=e[0][3];l=e[e.length-1][3]}else if(t===ol.geom.GeometryLayout.XYM){s=e[0][2];l=e[e.length-1][2]}else{e[0][3]=r[0].time=Date.now();for(var u=1;u<r.length;u++){var m,p=[];r[u].time=0;p=u+1<r.length?r.slice(u-1,u+1):r.slice(u-1);c+=m=new Cesium.EllipsoidGeodesic(p[0],p[1]).surfaceDistance;e[u][3]=r[u].time=r[u-1].time+36e5*m/o}s=r[0].time;l=r[r.length-1].time}if(0===c)for(u=1;u<r.length;u++){p=[];p=u+1<r.length?r.slice(u-1,u+1):r.slice(u-1);c+=new Cesium.EllipsoidGeodesic(p[0],p[1]).surfaceDistance}s=new Date(s).toISOString();l=new Date(l).toISOString();var h=[{id:"document",name:"CZML Model",version:"1.0"},{id:"path",name:i,availability:s+"/"+l,position:{epoch:s,cartographicRadians:r.map(function(i,a){return t===ol.geom.GeometryLayout.XYZM?[new Date(e[a][3]).toISOString(),i.longitude,i.latitude,i.height]:t===ol.geom.GeometryLayout.XYM?[new Date(e[a][2]).toISOString(),i.longitude,i.latitude,i.height]:[new Date(i.time).toISOString(),i.longitude,i.latitude,i.height]}).reduce(function(e,t){return e.concat(t)})},point:{heightReference:"NONE",pixelSize:a.radius,color:{rgba:a.fillColor},outlineColor:{rgba:a.strokeColor},outlineWidth:a.strokeWidth}}];n.resolve(h,c,e)});return n}.call(this,i.geometry,i.wrap.feature.getGeometry().layout,"track",t.markerStyle,t.lineStyle,t.walkingSpeed).then(function(t,a,r){this.map3D.trackDataSource=new Cesium.DataSourceCollection;var o=new Cesium.DataSourceDisplay({scene:this.viewer.scene,dataSourceCollection:this.map3D.trackDataSource});this.viewer.scene.preRender.addEventListener(function(e,t){o.update(t)});this.map3D.trackDataSource.add(Cesium.CzmlDataSource.load(t)).then(function(t,i,r){this.viewer.clock.shouldAnimate=!1;var o,s;o=r.clock.startTime;s=r.clock.stopTime;this.viewer.clock.startTime=o.clone();this.viewer.clock.stopTime=s.clone();this.viewer.clock.currentTime=o.clone();this.viewer.clock.clockStep=Cesium.ClockStep.TICK_DEPENDENT;this.viewer.clock.clockRange=Cesium.ClockRange.CLAMPED;this.viewer.clock.multiplier=1;var l=r.entities.values[0];l.layout=t;l.tagLI=e;l.availability=new Cesium.TimeIntervalCollection([new Cesium.TimeInterval({start:o,stop:s})]);this.viewer.entities.add(l);this.viewer.flyTo(l).then(function(){this.viewer.trackedEntity=l;var e,t=0;n=this.viewer.scene.preUpdate.addEventListener(function(r,o){if(0===this.map3D.linked2DControls.geolocation.getSelectedTrack().length||this.map3D.linked2DControls.geolocation.getSelectedTrack().length>0&&this.map3D.linked2DControls.geolocation.getSelectedTrack()&&this.map3D.linked2DControls.geolocation.getSelectedTrack().attr("data-id")!==l.tagLI.attr("data-id")||Cesium.JulianDate.greaterThanOrEquals(o,l.availability.stop)){n();L.call(this,{target:{className:"stop"},custom:!0})}else if(this.viewer.clock.shouldAnimate&&l.isAvailable(o)){e||(e=Cesium.Cartographic.fromCartesian(Cesium.Property.getValueOrUndefined(l.position,l.availability.start)));currentPosition=Cesium.Cartographic.fromCartesian(Cesium.Property.getValueOrUndefined(l.position,o));if(this.map3D.linked2DControls.geolocation.hasElevation){l.layout===ol.geom.GeometryLayout.XYZM||(l.layout,ol.geom.GeometryLayout.XYM);this.map3D.linked2DControls.geolocation.chartSetProgress({p:[e.longitude,e.latitude,e.height],d:t},[currentPosition.longitude,currentPosition.latitude,function(e,t){for(var i,a=0,r=TC.Util.reproject(e[0],this.map.crs,this.map3D.crs),o=new Cesium.Cartographic.fromDegrees(r[0],r[1]),n=1;n<e.length;n++){r=TC.Util.reproject(e[n],this.map.crs,this.map3D.crs);var s=new Cesium.Cartographic.fromDegrees(r[0],r[1]);a+=new Cesium.EllipsoidGeodesic(o,s).surfaceDistance;o=s;if(a>t){i=e[n-1];break}}if(i){var c=l.layout===ol.geom.GeometryLayout.XYZM?2:l.layout===ol.geom.GeometryLayout.XYZ?2:-1;if(c>-1)return i[c]}return 0}.call(this,i,t)],a,(l.layout===ol.geom.GeometryLayout.XYZM||l.layout===ol.geom.GeometryLayout.XYM)&&this.map3D.linked2DControls.geolocation._getTime(Cesium.JulianDate.toDate(l.availability.start),Cesium.JulianDate.toDate(o)))}t+=new Cesium.EllipsoidGeodesic(e,currentPosition).surfaceDistance;e=currentPosition}}.bind(this));this.viewer.clock.shouldAnimate=!0}.bind(this));this.viewer.scene.requestRender()}.bind(this,i.wrap.feature.getGeometry().layout,r))}.bind(this))}}.bind(i);a._wrap_simulateTrack=TC.wrap.control.Geolocation.prototype.simulateTrack;TC.wrap.control.Geolocation.prototype.simulateTrack=function(){this.parent.hasElevation&&this.parent.chartProgressInit()};a._wrap_showElevationMarker=TC.wrap.control.Geolocation.prototype.showElevationMarker;TC.wrap.control.Geolocation.prototype.showElevationMarker=function(e){const t=this.map3D.linked2DControls.geolocation,i=t.chart.coordinates;if(t.layerTrack.getVisibility()&&t.layerTrack.getOpacity()>0){var a=this.viewer.camera,r=TC.Util.reproject(i[e[0].index],this.map.crs,this.map3D.crs);if(t.elevationMarker){t.elevationMarker.position=Cesium.Cartesian3.fromDegrees(r[0],r[1],a.positionCartographic.height);this.viewer.scene.requestRender()}else{var o=new Cesium.Entity({position:Cesium.Cartesian3.fromDegrees(r[0],r[1]),billboard:{image:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4AcdDDMq7Am38gAAAaFJREFUWMPtlj9rwkAYh3+R0lgKRSi4FCFmczBzp2i+gaMgmK0I3Tq0Y6HDDd0L0tJBSyGbAT9AxI+goFskumUUrDq9XVRi6WkS/xXquyRc7nie++XuOOBYx/rvJYQdqKoqNE1barMsC81mc/cCqqri+eWVfvt2f3sjBJE4CSMwn/kkXVpqj7bL0DQtUAqRTf9hhixkyAo9PnLoRbhWQNd1KIoSGqAoysrxkXXwh8cnMsw6McYCwxljMMw6GWadeBIrBSRJwnA0hivryOULgSQYY8jlC+TKOoajMWKx2Ga7wJV15OwKARCm06lv+FYX4TwJURS5fURR9A0PJBC3q0sSvH5eeLRd3t5BlEomALsKVy6CN7tJuoSJR3g4+tpeAt3eAKlkYpHEurRSycTmArVaDRfnZ7Poi74k5vBub4DT6zsAwFX8Eo7jBBdotVowjU8hbld8SXjhrlyctVXw8f4m8AR87+mO7VADWWogSx27T0S0eHrfO3bf088JdYAFkvDWzuB+JHYOXyWxNzhPYq9wfhJ7hP+UOAjc74XjWH++vgFLJ1bBWXZtUAAAAABJRU5ErkJggg==",eyeOffset:new Cesium.Cartesian3(0,0,-100),verticalOrigin:Cesium.VerticalOrigin.BOTTOM,heightReference:Cesium.HeightReference.CLAMP_TO_GROUND}});t.elevationMarker=this.map3D.addNativeFeature.call(this,o)}}}.bind(i);a._wrap_hideElevationMarker=TC.wrap.control.Geolocation.prototype.hideElevationMarker;TC.wrap.control.Geolocation.prototype.hideElevationMarker=function(){const e=this.map3D.linked2DControls.geolocation;this.map3D.removeFeature.call(this,e.elevationMarker);e.elevationMarker=null}.bind(i);a._renderInfoNewPosition=a.renderInfoNewPosition;a.renderInfoNewPosition=function(e){var t=this;t.getRenderedHtml(t.CLASS+"-tracking-toast",t.setFormatInfoNewPosition(e.pd),function(e){t.track.$info.find(".prpanel-body").html(e);t.trackingActive.set(!0);if(!l){s.map3D.linked2DControls.featureInfo&&s.map3D.linked2DControls.featureInfo.clear();s.map3D.linked2DControls.geolocation.track&&s.map3D.linked2DControls.geolocation.track.$info.removeClass(TC.Consts.classes.HIDDEN);s.map3D.linked2DControls.geolocation.resultsPanelChart&&s.map3D.linked2DControls.geolocation.resultsPanelChart.close()}l||(l=!0)})};a._setFormatInfoNewPosition=a.setFormatInfoNewPosition;a.setFormatInfoNewPosition=function(e){var t={},i=TC.Util.getMapLocale(this.map),a=TC.Util.reproject(e.position,this.map.crs,this.map3D.crs);t.x=a[0].toLocaleString(i);t.y=a[1].toLocaleString(i);t.z=Math.round(e.altitude).toLocaleString(i);t.accuracy=Math.round(e.accuracy).toLocaleString(i);t.speed=e.speed.toLocaleString(i,{minimumFractionDigits:1,maximumFractionDigits:1});var r=new Cesium.Cartographic(Cesium.Math.toRadians(a[0]),Cesium.Math.toRadians(a[1])),o=this.viewer.scene.globe.getHeight(r);o&&(t.mdt=Math.round(o).toLocaleString(i));t.isGeo=!0;return t}.bind(i)}else if(i.map3D.linked2DControls.geolocation.getSelectedTrack().length>0&&i.map3D.linked2DControls.geolocation.hasElevation){a.CHART_SIZE.MIN_HEIGHT=a._CHART_SIZE.MIN_HEIGHT;a.CHART_SIZE.MIN_WIDTH=a._CHART_SIZE.MIN_WIDTH;a._elevationTrack.call(i.map3D.linked2DControls.geolocation,i.map3D.linked2DControls.geolocation.getSelectedTrack().first(),!0)}}},A=function(e){var t,i,a,r=this,o=function(e){var t=new Cesium.Cartesian2(this.viewer.scene.canvas.clientWidth/2,this.viewer.scene.canvas.clientHeight/2);this.map3D.zoomToCartesian.call(this,{endPosition:t},e)};if(e){t=function(e){e.stopPropagation&&e.stopPropagation();e.preventDefault&&e.preventDefault();var t=TC.Util.reproject(this.map.options.initialExtent.slice(0,2),this.map.crs,this.map3D.crs),i=TC.Util.reproject(this.map.options.initialExtent.slice(2),this.map.crs,this.map3D.crs),a=Cesium.Rectangle.fromDegrees(t[0],t[1],i[0],i[1]);this.map3D.flyToRectangle.call(this,a,{duration:.1});return!1}.bind(r);i=function(e){o.call(r,200)}.bind(r);a=function(e){o.call(r,-200)}.bind(r);$("."+TC.control.NavBar.prototype.CLASS+"-btn-home").on("click",t);$("."+TC.control.NavBar.prototype.CLASS+"-btn-zoomin").on("click",i);$("."+TC.control.NavBar.prototype.CLASS+"-btn-zoomout").on("click",a)}else{$("."+TC.control.NavBar.prototype.CLASS+"-btn-home").off("click",t);$("."+TC.control.NavBar.prototype.CLASS+"-btn-zoomin").off("click",i);$("."+TC.control.NavBar.prototype.CLASS+"-btn-zoomout").off("click",a)}},{crs:"EPSG:4326",crsPattern:/(EPSG\:?4326)/i,customRender:null,baseLayer:null,workLayers:[],vector2DLayers:[],vector2DFeatures:{},linked2DControls:{},isLoadingTiles:function(){var e=this.viewer.scene.globe._surface;return!e._tileProvider.ready||e._tileLoadQueueHigh.length>0||e._tileLoadQueueMedium.length>0||e._tileLoadQueueLow.length>0||e._debug.tilesWaitingForChildren>0},loadViewer:function(){var e=this,t=new $.Deferred;e.viewer?t.resolve(e.viewer):TC.loadJS(!window.Cesium,TC.Consts.url.CESIUM,function(){var i=new Cesium.Globe;i.baseColor=Cesium.Color.WHITE;i.enableLighting=!0;i.tileCacheSize=1e3;i.maximumScreenSpaceError=5;e.viewer=e.map3D.viewer=new Cesium.Viewer(e.selectors.divThreedMap,{terrainProvider:new Cesium.CesiumTerrainProvider({url:e.Consts.TERRAIN_URL}),terrainExaggeration:1,terrainShadows:Cesium.ShadowMode.DISABLED,animation:!1,timeline:!1,fullscreenButton:!1,baseLayerPicker:!1,imageryProvider:!1,navigationInstructionsInitiallyVisible:!1,navigationHelpButton:!1,geocoder:!1,homeButton:!1,infoBox:!1,sceneModePicker:!1,selectionIndicator:!1,globe:i,requestRenderMode:!0,maximumRenderTimeChange:1/0});e.viewer.readyPromise=new $.Deferred;e.viewer.scene.backgroundColor=Cesium.Color.WHITE;e.viewer.scene.screenSpaceCameraController.enableCollisionDetection=!0;e.viewer.scene.screenSpaceCameraController.maximumZoomDistance=1e6;e.viewer.scene.globe.depthTestAgainstTerrain=!1;e.viewer.scene.imageryLayers.removeAll();e.viewer.terrainProvider.errorEvent.addEventListener(function(e){if(e.error)switch(e.error.statusCode){case 403:case 404:console.log("es un 404 de terreno")}},e);e.viewer.scene.renderError.addEventListener(function(e,t){if(t&&18===t.code);else{this.$divThreedMap.removeClass(this.classes.LOADING);this.map.toast(this.getLocaleString("fi.error"),{type:TC.Consts.msgType.ERROR});this.$button.click()}},e);e.map3D.tileLoadingHandler=new Cesium.EventHelper;e.map3D.tileLoadingHandler.add(e.viewer.scene.globe.tileLoadProgressEvent,function(t){e.waiting||(e.waiting=e.map.getLoadingIndicator().addWait());if(e.viewer.scene.terrainProvider.ready&&0===t){e.map.getLoadingIndicator().removeWait(e.waiting);delete e.waiting;e.viewer.readyPromise.resolve();e.$events.trigger(TC.Consts.event.TERRAINLOADED,{})}else e.$events.trigger(TC.Consts.event.TERRAINRECEIVING,{})}.bind(e));A.call(e,!0);$(".cesium-viewer-bottom").remove();e.map3D._event2DHandler=function(e){var t=e.type+".tc";switch(!0){case t==TC.Consts.event.BEFOREBASELAYERCHANGE:this.waiting||(this.waiting=this.map.getLoadingIndicator().addWait());break;case t==TC.Consts.event.BASELAYERCHANGE:this.map3D.setBaseLayer.call(this,e.layer);break;case t==TC.Consts.event.LAYERADD:this.map3D.addLayer.call(this,e.layer);break;case t==TC.Consts.event.LAYERREMOVE:this.map3D.removeLayer.call(this,e.layer);break;case t==TC.Consts.event.LAYERVISIBILITY:this.map3D.setRenderOptionsLayer.call(this,e.layer,{visibility:e.layer.getVisibility()});break;case t==TC.Consts.event.LAYEROPACITY:this.map3D.setRenderOptionsLayer.call(this,e.layer,{opacity:e.layer.getOpacity()});break;case t==TC.Consts.event.LAYERORDER:for(var i=0;i<this.map3D.workLayers.length;i++)if(this.map3D.workLayers[i].imageryProvider&&this.map3D.workLayers[i].imageryProvider.layers.join(",")===e.layer.names.join(",")){if(e.oldIndex>e.newIndex)for(var a=e.oldIndex-e.newIndex,r=0;r<a;r++)this.viewer.scene.imageryLayers.lower(this.map3D.workLayers[i]);else for(a=e.newIndex-e.oldIndex,r=0;r<a;r++)this.viewer.scene.imageryLayers.raise(this.map3D.workLayers[i]);this.map3D.workLayers.splice(e.newIndex,0,this.map3D.workLayers.splice(e.oldIndex,1)[0]);break}break;case t==TC.Consts.event.FEATUREADD:this.map3D.addFeature.call(this,e.feature);break;case t==TC.Consts.event.FEATUREREMOVE:case t==TC.Consts.event.FEATURESCLEAR:if(this.map3D.vector2DFeatures&&this.map3D.vector2DFeatures.hasOwnProperty(e.layer.id)){var o=this.map3D.vector2DFeatures[e.layer.id];for(i=0;i<o.length;i++)this.map3D.removeFeature.call(this,o[i]);delete this.map3D.vector2DFeatures[e.layer.id]}break;case t==TC.Consts.event.ZOOM:if(this.map3D.cameraControls&&!this.map3D.cameraControls.moving){var n=this.map3D.viewer.scene.canvas.clientWidth,s=this.map3D.viewer.scene.canvas.clientHeight;if(!this.map3D._canvasClientHeight||!this.map3D._canvasClientWidth||n!==this.map3D._canvasClientWidth||s!==this.map3D._canvasClientHeight){this.map3D._canvasClientWidth||(this.map3D._canvasClientWidth=this.map3D.viewer.scene.canvas.clientWidth);this.map3D._canvasClientHeight||(this.map3D._canvasClientHeight=this.map3D.viewer.scene.canvas.clientHeight);this.map3D._canvasClientWidth=n;this.map3D._canvasClientHeight=s;return}this.map3D.flyToMapCoordinates.call(this,this.mapView.getCenter())}break;case t==TC.Consts.event.ZOOMTO:if(this.lastZoom&&performance.now()-this.lastZoom<50)return;this.lastZoom=performance.now();var l=TC.Util.reproject(e.extent.slice(0,2),this.map.crs,this.map3D.crs),c=TC.Util.reproject(e.extent.slice(2),this.map.crs,this.map3D.crs),u=Cesium.Rectangle.fromDegrees(l[0],l[1],c[0],c[1]);this.map3D.flyToRectangle.call(this,u)}}.bind(e);e.map.on(R.join(" "),e.map3D._event2DHandler);M.call(e,e.direction.TO_THREE_D);(function(){var e=this;e.map.workLayers.filter(function(e){return e instanceof TC.layer.Vector}).forEach(function(t){t.features.forEach(function(t){e.map3D.addFeature.call(e,t)})})}).call(e);t.resolve(e.viewer)});return t},setBaseLayer:function(e){var t=this,i=function(e){if(!a(e,t.map3D.crs))if(null!==e.getFallbackLayer()&&a(e.getFallbackLayer(),t.map3D.crs))e=e.getFallbackLayer();else{t.map.toast(t.getLocaleString("threed.crsNoCompatible",{name:e.layerNames}));e=null}return e};if(t.map3D.baseLayer){if(t.map3D.baseLayer!==t.Consts.BLANK_BASE){t.viewer.scene.imageryLayers.raiseToTop(t.map3D.baseLayer);t.viewer.scene.imageryLayers.remove(t.map3D.baseLayer,!0)}if(e instanceof TC.layer.Vector){t.map3D.baseLayer=t.Consts.BLANK_BASE;t.map.getLoadingIndicator().removeWait(t.waiting);delete t.waiting}else if(e=i(e)){e.map=t.map;e.isBase=!0;t.map3D.addLayer.call(t,e)}}else{(function(e){var t=this,i=e.baseLayer instanceof TC.layer.Raster;if(i){if(!a(e.baseLayer,t.map3D.crs)){var r=e.baseLayer.getFallbackLayer();r&&!a(r,t.map3D.crs)&&e.toast(t.getLocaleString("threed.baseLayerNoCompatible",{name:e.baseLayer.layerNames}))}}else g.baseVector=e.baseLayer;if(0===g.baseMaps.length){var o=e.baseLayers.filter(function(e){return!a(e,t.map3D.crs)}).filter(function(e,i){return!e.getFallbackLayer()||!a(e.getFallbackLayer(),t.map3D.crs)});if(o.length>0)for(var n=0;n<e.baseLayers.length;n++)o.indexOf(e.baseLayers[n])>-1&&g.baseMaps.push({l:e.baseLayers[n],i:n})}g.baseMap=i?e.baseLayer:t.Consts.BLANK_BASE}).call(t,t.map);(function(e){var t=!1;if(g.baseMaps&&g.baseMaps.length){for(var i=0;i<g.baseMaps.length;i++)for(var a=0;a<e.baseLayers.length;a++)if(e.baseLayers[a]===g.baseMaps[i].l){g.baseMap==e.baseLayers[a]&&(t=!0);e.$events.trigger($.Event(TC.Consts.event.LAYERREMOVE,{layer:e.baseLayers[a]}));e.baseLayers.splice(a,1);break}if(t){e.baseLayer=e.baseLayers[0];e.$events.trigger($.Event(TC.Consts.event.BASELAYERCHANGE,{layer:e.baseLayer}))}}}).call(t,t.map);if(e.type===TC.Consts.layerType.WMTS||e.type===TC.Consts.layerType.WMS){if(e.options.relatedWMTS){t.map.baseLayer=e=t.map.getLayer(e.options.relatedWMTS);t.map.$events.trigger($.Event(TC.Consts.event.BASELAYERCHANGE,{layer:t.map.baseLayer}))}else if(e=i(e)){e.isBase||(e.isBase=!0);t.map3D.addLayer.call(t,e)}}else t.map3D.baseLayer=t.Consts.BLANK_BASE}g.baseMap=t.map.baseLayer},addLayer:function(e){var t=this;switch(!0){case TC.Consts.layerType.VECTOR==e.type:t.map3D.vector2DLayers.push(e);break;case TC.Consts.layerType.WMTS==e.type:case TC.Consts.layerType.WMS==e.type:e.isBase||e.isCompatible(t.map3D.crs)?w.convert(e,t.map3D.crs).then(function(i){if(i){if(void 0!==i.enablePickFeatures){i.enablePickFeatures=!1;i.tcLayer=e}var a=t.viewer.scene.imageryLayers.addImageryProvider(i);if(e.isBase){t.map3D.baseLayer=a;t.viewer.scene.imageryLayers.lowerToBottom(a)}else{a.show=e.getVisibility();a.alpha=e.getOpacity();t.map3D.workLayers.push(a);t.map3D.linked2DControls.legend.refresh()}}}):t.map.toast(t.getLocaleString("threed.crsNoCompatible",{name:e.layerNames}))}},removeLayer:function(e){switch(!0){case TC.Consts.layerType.VECTOR==e.type:if(this.map3D.vector2DFeatures&&this.map3D.vector2DFeatures.hasOwnProperty(e.id)){for(var t=this.map3D.vector2DFeatures[e.id],i=0;i<t.length;i++)this.map3D.removeFeature.call(this,t[i]);delete this.map3D.vector2DFeatures[e.id]}break;case TC.Consts.layerType.WMTS==e.type:case TC.Consts.layerType.WMS==e.type:for(i=0;i<this.map3D.workLayers.length;i++)if(e.names&&this.map3D.workLayers[i].imageryProvider.layers.join(",")===e.names.join(",")||e.title&&this.map3D.workLayers[i].imageryProvider.layers.join(",")===e.title){this.viewer.scene.imageryLayers.raiseToTop(this.map3D.workLayers[i]);this.viewer.scene.imageryLayers.remove(this.map3D.workLayers[i],!0);this.map3D.workLayers.splice(i,1);break}}},setRenderOptionsLayer:function(e,t){switch(!0){case TC.Consts.layerType.VECTOR==e.type:if(this.map3D.vector2DFeatures[e.id])for(var i=this.map3D.vector2DFeatures[e.id],a=0;a<i.length;a++)this.map3D.setRenderOptionsFeature(i[a],{show:e.getVisibility()});break;case TC.Consts.layerType.WMTS==e.type:case TC.Consts.layerType.WMS==e.type:for(a=0;a<this.map3D.workLayers.length;a++)if(e.names&&this.map3D.workLayers[a].imageryProvider.layers.join(",")===e.names.join(",")||e.title&&this.map3D.workLayers[a].imageryProvider.layers.join(",")===e.title){t.hasOwnProperty("visibility")&&(this.map3D.workLayers[a].show=t.visibility);t.hasOwnProperty("opacity")&&(this.map3D.workLayers[a].alpha=t.opacity);break}}},flyToMapCoordinates:function(e){var t=TC.Util.reproject(e,this.map.crs,this.map3D.crs),i=Cesium.Cartesian3.fromDegrees(t[0],t[1],this.viewer.camera.positionCartographic.height),a=this.viewer.camera;a.flyTo({destination:i,orientation:{heading:a.heading,pitch:a.pitch}})},flyToRectangle:function(e,t){var i=this;i.viewer.scene.camera.cancelFlight();var a=$.Deferred();t=t||{};var r=Cesium.Math.EPSILON3;if(e.east===e.west){e.east+=r;e.west-=r}if(e.north===e.south){e.north+=r;e.south-=r}var o=.2*e.width/2,n=.2*e.height/2;e.east-=o;e.west+=n;e.north+=n;e.south-=n;var s=i.viewer.scene,l=s.camera,c=l.getRectangleCameraCoordinates(e),u=Cesium.Ellipsoid.WGS84.cartesianToCartographic(c);Cesium.when(Cesium.sampleTerrainMostDetailed(s.globe.terrainProvider,[Cesium.Rectangle.center(e)]),function(e){var r={longitude:u.longitude,latitude:u.latitude,height:u.height+e[0].height};l.flyTo({duration:t.duration||1,destination:Cesium.Ellipsoid.WGS84.cartographicToCartesian(r),complete:function(){var e=Cesium.Math.toRadians(50),t=m(this.viewer.scene);t=Cesium.Matrix4.fromTranslation(t);this.map3D.rotateAroundAxis(this.viewer.scene.camera,-e,this.viewer.scene.camera.right,t,{duration:250,callback:function(){a.resolve()}})}.bind(i)})});return a},zoomToCartesian:function(e,t){var i=this,a=i.viewer.scene;if(!e||!e.endPosition){var r=a.canvas,o=new Cesium.Cartesian2(r.clientWidth/2,r.clientHeight/2);e={endPosition:o}}var n=a.camera.getPickRay(e.endPosition),s=a.globe.pick(n,a);if(s){var l=Cesium.Cartesian3.distance(n.origin,s);if(l<1)return;i.map3D._zoomTo||(i.map3D._zoomTo={amount:0});i.map3D._zoomTo.direction=t>0?1:0;i.map3D._zoomTo.amount+=5*l/100;i.map3D._zoomTo.endPosition=e.endPosition}setTimeout(function(){(function(t){var i=this.viewer.scene,a=i.camera.getPickRay(e.endPosition||t.endPosition),r=i.globe.pick(a,i);if(r){if(Cesium.Cartesian3.distance(a.origin,r)<1)return;var o=i.camera.position,n=(i.camera.direction,toGo=new Cesium.Cartesian3);Cesium.Cartesian3.multiplyByScalar(a.direction,1==t.direction?t.amount:-t.amount,n);Cesium.Cartesian3.add(o,n,toGo);var s=new Cesium.Ray(toGo,a.direction),l=i.globe.pick(s,i);l&&(Cesium.Cartesian3.distance(toGo,l)<1||Math.abs(Cesium.Ellipsoid.WGS84.cartesianToCartographic(toGo).height)<i.screenSpaceCameraController.minimumZoomDistance?function(){this.map3D._zoomTo={direction:1,amount:0,endPosition:{}}}.call(this):this.viewer.camera.flyTo({destination:toGo,orientation:{heading:i.camera.heading,pitch:i.camera.pitch,roll:i.camera.roll},duration:1,easingFunction:Cesium.EasingFunction.LINEAR_NONE,complete:function(e){this.map3D._zoomTo={direction:1,amount:0,endPosition:{}}}.bind(this,Cesium.Cartesian3.distance(toGo,l))}))}}).call(i,i.map3D._zoomTo)}.bind(i),50)},rotateAroundAxis:function(e,t,i,a,r){return l(e,t,i,a,r)},addFeature:function(e,t){var i=this,a=function(){var t=y.convert(i.viewer.scene,e,i.map.crs,i.map3D.crs);if(t)if("function"==typeof t.geometry)t.geometry(i.viewer.terrainProvider).then(function(t){if(t instanceof Array)t.forEach(function(t){if(t instanceof Array)t.forEach(function(t){t=T.call(i,t);D(i.map3D,e.layer.id,t)});else{t=T.call(i,t);D(i.map3D,e.layer.id,t)}});else{var a=T.call(i,t);D(i.map3D,e.layer.id,a)}});else if(t.geometry instanceof Array)t.geometry.forEach(function(t){t=T.call(i,t);D(i.map3D,e.layer.id,t)});else{var a=T.call(i,t.geometry);D(i.map3D,e.layer.id,a)}};if(!i.map3D.linked2DControls.coordinates||i.map3D.linked2DControls.coordinates.layer!=e.layer)if(i.map3D.linked2DControls.featureInfo&&i.map3D.linked2DControls.featureInfo.get2DMarker()===e||i.map3D.linked2DControls.featureInfo&&i.map3D.linked2DControls.featureInfo.isPending())setTimeout(function(){i.map3D.linked2DControls.featureInfo.get2DMarker()!==e&&a()},5);else{if(i.map3D.linked2DControls.geolocation&&i.map3D.linked2DControls.geolocation.layerTracking===e.layer&&e instanceof TC.feature.Polyline)return;a()}},removeFeature:function(e){if(e){switch(!0){case e instanceof Cesium.GroundPrimitive:this.viewer.scene.groundPrimitives.remove(e);break;case e instanceof Cesium.Billboard:this.viewer.billboardCollection.remove(e);break;case e instanceof Object:this.viewer.entities.removeById(e.id)}this.viewer.scene.requestRender()}},setRenderOptionsFeature:function(e,t){e&&(e.show=t.show)},addNativeFeature:function(e){return T.call(this,e)},setCameraFromMapView:function(){var e=this;e.viewer.scene.globe.terrainProvider.readyPromise.then(function(){var t=e.mapView.getCenter();if(t){var i=TC.Util.reproject(t,e.map.crs,e.map3D.crs),a=function(e,t){var i=this.viewer.camera.frustum.fovy,a=e*this.mapView.viewHTML.getBoundingClientRect().height,r=Math.cos(Math.abs(t));return a*this.mapView.metersPerUnit*r/2/Math.tan(i/2)}.call(e,e.mapView.getResolution()||0,Cesium.Math.toRadians(i[0])),r=(i=TC.Util.reproject(t,e.map.crs,e.map3D.crs),new Cesium.Cartographic(Cesium.Math.toRadians(i[0]),Cesium.Math.toRadians(i[1])));e.viewer.scene.globe&&(r.height=e.viewer.scene.globe.getHeight(r)||0);var o=function(){var t=Cesium.Ellipsoid.WGS84.cartographicToCartesian(r),i={pitch:Cesium.Math.toRadians(-90),heading:-e.mapView.getRotation(),roll:0};e.viewer.camera.setView({destination:t,orientation:i});e.viewer.camera.moveBackward(a)};0===r.height?TC.loadJS(!TC.tool||!TC.tool.Elevation,TC.apiLocation+"TC/tool/Elevation",function(){e.map3D.elevationTool=new TC.tool.Elevation;e.map3D.elevationTool.getElevation({crs:e.map3D.crs,coordinates:i}).then(function(e){r.height=e[0][2]?e[0][2]:0;o()})}):o()}})},setViewFromCameraView:function(){if(!this.setViewFromCameraViewInProgress||"resolved"==this.setViewFromCameraViewInProgress.state()){this.setViewFromCameraViewInProgress=new $.Deferred;var e=Cesium.Ellipsoid.WGS84,t=this.viewer.scene;target_=u(t);if(!target_){var i=this.viewer.scene.globe,a=this.viewer.camera.positionCartographic.clone(),r=i.getHeight(a);a.height=r||0;target_=Cesium.Ellipsoid.WGS84.cartographicToCartesian(a)}var o=Cesium.Cartesian3.distance(target_,this.viewer.camera.position),n=e.cartesianToCartographic(target_),l=TC.Util.reproject([Cesium.Math.toDegrees(n.longitude),Cesium.Math.toDegrees(n.latitude)],this.map3D.crs,this.map.crs);this.mapView.setCenter(l);this.mapView.setResolution(s.call(this,o,n?n.latitude:0));this.setViewFromCameraViewInProgress.resolve()}return this.setViewFromCameraViewInProgress},getInfoOnPickedPosition:function(e){var t=this;if(e){t.map.one(TC.Consts.event.DRAWTABLE,function(e){t.map.getLoadingIndicator().removeWait(t.waiting);delete t.waiting});t.map3D.linked2DControls.featureInfo.send.call(t,e).then(function(e){t.map.getLoadingIndicator().removeWait(t.waiting);delete t.waiting})}},destroy:function(){this.map3D.vector2DLayers=[];this.map3D.vector2DFeatures={};this.map.off(R.join(" "),this.map3D._event2DHandler);M.call(this,this.direction.TO_TWO_D);A.call(this,!1);(function(e){if(g.baseMaps&&g.baseMaps.length)for(var t=0;t<g.baseMaps.length;t++){this.map.$events.trigger($.Event(TC.Consts.event.LAYERADD,{layer:g.baseMaps[t].l}));this.map.baseLayers.splice(g.baseMaps[t].i,0,g.baseMaps[t].l)}}).call(this);this.map.baseLayer=g.baseMap==this.Consts.BLANK_BASE?g.baseVector:g.baseMap;this.map.$events.trigger($.Event(TC.Consts.event.BASELAYERCHANGE,{layer:this.map.baseLayer}));g.baseMap="";this.map3D.baseLayer=null;this.map3D.workLayers=[];this.map3D.cameraControls.unbind();this.map3D.linked2DControls.featureInfo&&this.map3D.linked2DControls.featureInfo.reset();this.map3D.linked2DControls.coordinates&&this.map3D.linked2DControls.coordinates.clear();if(this.map3D.linked2DControls.geolocation){this.map3D.linked2DControls.geolocation.isGeo=!1;this.map3D.linked2DControls.geolocation.reset()}this.map3D.tileLoadingHandler.removeAll();delete this.map3D.tileLoadingHandler}});e.browserSupportWebGL=function(){var e=!1;if(window.WebGLRenderingContext){var t=document.createElement("canvas"),i={alpha:!1,stencil:!1,failIfMajorPerformanceCaveat:!0};try{var a=t.getContext("webgl",i)||t.getContext("experimental-webgl",i)||t.getContext("webkit-3d",i)||t.getContext("moz-webgl",i);if(a)e=!0;else{i.failIfMajorPerformanceCaveat=!1;if(a=t.getContext("webgl",i)||t.getContext("experimental-webgl",i)||t.getContext("webkit-3d",i)||t.getContext("moz-webgl",i)){e="slow";this.isSlower=!0}else e=!1}}catch(e){console.log(E)}if("slow"===e||!e){var r="slow"===e?"threed.slowSupport.supported":"threed.not.supported";this.map.toast(this.getLocaleString(r),{type:TC.Consts.msgType.WARNING,duration:1e4})}return e}e=!1}}();