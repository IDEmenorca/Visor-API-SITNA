TC.control=TC.control||{};TC.control.ProjectionSelector||TC.syncLoadJS(TC.apiLocation+"TC/control/ProjectionSelector");!function(){TC.control.Coordinates=function(t){t=t||{};this.crs="";this.xy=[0,0,0];this.latLon=[0,0,0];this.x=0;this.y=0;this.lat=0;this.lon=0;this.units="m";this.isGeo=!1;TC.control.ProjectionSelector.apply(this,arguments);$.extend(this._cssClasses,{CRS:this.CLASS+"-crs",GEOCRS:this.CLASS+"-geocrs",X:this.CLASS+"-x",Y:this.CLASS+"-y",LAT:this.CLASS+"-lat",LON:this.CLASS+"-lon",ELEVATION:this.CLASS+"-elevation"});this.geoCrs=this.options.geoCrs||TC.Cfg.geoCrs;this.wrap=new TC.wrap.control.Coordinates(this)};TC.inherit(TC.control.Coordinates,TC.control.ProjectionSelector);var t=TC.control.Coordinates.prototype;t.CLASS="tc-ctl-coords";var s;t.template={};if(TC.isDebug){t.template[t.CLASS]=TC.apiLocation+"TC/templates/Coordinates.html";t.template[t.CLASS+"-dialog"]=TC.apiLocation+"TC/templates/CoordinatesDialog.html"}else{t.template[t.CLASS]=function(){dust.register(t.CLASS,s);function s(t,s){return t.w('<div>CRS: <span class="tc-ctl-coords-crs">').f(s.get(["crs"],!1),s,"h").w('</span><button class="tc-ctl-coords-crs" title="').h("i18n",s,{},{$key:"changeCRS"}).w('">').f(s.get(["crs"],!1),s,"h").w('</button></div><div class="tc-ctl-coords-xy">').x(s.get(["isGeo"],!1),s,{else:o,block:i},{}).w("</div>").x(s.get(["showGeo"],!1),s,{block:c},{}).w('<span class="close"></span>')}s.__dustBody=!0;function o(t,s){return t.w('x: <span class="tc-ctl-coords-x">').f(s.get(["x"],!1),s,"h").w('</span> y: <span class="tc-ctl-coords-y">').f(s.get(["y"],!1),s,"h").w("</span> ").x(s.get(["ele"],!1),s,{block:e},{})}o.__dustBody=!0;function e(t,s){return t.w(' z: <span class="tc-ctl-coords-elevation">').f(s.get(["ele"],!1),s,"h").w("</span> ")}e.__dustBody=!0;function i(t,s){return t.h("i18n",s,{},{$key:"lat"}).w(': <span class="tc-ctl-coords-lat">').f(s.get(["lat"],!1),s,"h").w("</span> ").h("i18n",s,{},{$key:"lon"}).w(': <span class="tc-ctl-coords-lon">').f(s.get(["lon"],!1),s,"h").w("</span> ").x(s.get(["ele"],!1),s,{block:n},{})}i.__dustBody=!0;function n(t,s){return t.w(" ").h("i18n",s,{},{$key:"ele"}).w(': <span class="tc-ctl-coords-elevation">').f(s.get(["ele"],!1),s,"h").w("</span> ")}n.__dustBody=!0;function c(t,s){return t.w('<div class="tc-ctl-coords-alt">CRS: <span class="tc-ctl-coords-geocrs">').f(s.get(["geoCrs"],!1),s,"h").w('</span></div><div class="tc-ctl-coords-xy">').h("i18n",s,{},{$key:"lat"}).w(': <span class="tc-ctl-coords-lat">').f(s.get(["lat"],!1),s,"h").w("</span> ").h("i18n",s,{},{$key:"lon"}).w(': <span class="tc-ctl-coords-lon">').f(s.get(["lon"],!1),s,"h").w("</span> ").x(s.get(["ele"],!1),s,{block:r},{}).w(" </div>")}c.__dustBody=!0;function r(t,s){return t.w(" ").h("i18n",s,{},{$key:"ele"}).w(': <span class="tc-ctl-coords-elevation">').f(s.get(["ele"],!1),s,"h").w("</span> ")}r.__dustBody=!0;return s};t.template[t.CLASS+"-dialog"]=function(){dust.register(t.CLASS+"-dialog",s);function s(t,s){return t.w('<div class="tc-ctl-coords-crs-dialog tc-modal"><div class="tc-modal-background tc-modal-close"></div><div class="tc-modal-window"><div class="tc-modal-header"><h3>').h("i18n",s,{},{$key:"changeCRS"}).w('</h3><div class="tc-ctl-popup-close tc-modal-close"></div></div><div class="tc-modal-body"><p>').h("i18n",s,{},{$key:"coords.currentProjection|h"}).w('</p><p class="tc-ctl-coords-no-change">').h("i18n",s,{},{$key:"coords.noCrs.warning|s"}).w('</p><div class="tc-ctl-coords-change"><p>').h("i18n",s,{},{$key:"coords.instructions|s"}).w('</p><p class="tc-msg-warning tc-hidden">').h("i18n",s,{},{$key:"coords.instructions.warning|s"}).w('</p></div><ul class="tc-ctl-coords-crs-list tc-crs-list"></ul></div><div class="tc-modal-footer"><button type="button" class="tc-button tc-modal-close">').h("i18n",s,{},{$key:"close"}).w("</button></div></div></div>")}s.__dustBody=!0;return s}}t.register=function(t){var s=this;TC.control.ProjectionSelector.prototype.register.call(s,t);s.crs=s.map.crs;s.clear();t.loaded(function(){s.wrap.register(t).then(function(){s.render(function(){s.clear()})});if(TC.Util.detectMobile()){s.getLayer();s.activateCoords()}t.on(TC.Consts.event.PROJECTIONCHANGE,function(o){s.isGeo=t.wrap.isGeo();s.crs=o.crs;s.render()});$.when(s.map.wrap.getViewport()).then(function(t){$(t).on(TC.Consts.event.MOUSEMOVE+".coords",function(t){s.onMouseMove(t)}).on(TC.Consts.event.MOUSELEAVE+".coords",function(t){s.onMouseLeave(t)})})})};t.render=function(t){var s=this;s.getRenderedHtml(s.CLASS+"-dialog",null,function(t){s._$dialogDiv.html(t)}).then(function(){TC.Control.prototype.renderData.call(s,{x:s.x,y:s.y,lat:s.lat,lon:s.lon,ele:s.isGeo&&s.latLon.length>2?s.latLon[2]:!s.isGeo&&s.xy.length>2?s.xy[2]:null,crs:s.crs,geoCrs:s.geoCrs,isGeo:s.isGeo,showGeo:!s.isGeo&&s.options.showGeo},function(){s.$crs=s._$div.find("."+s._cssClasses.CRS);s.$geoCrs=s._$div.find("."+s._cssClasses.GEOCRS);s.$x=s._$div.find("."+s._cssClasses.X);s.$y=s._$div.find("."+s._cssClasses.Y);s.$lat=s._$div.find("."+s._cssClasses.LAT);s.$lon=s._$div.find("."+s._cssClasses.LON);s.$ele=s._$div.find("."+s._cssClasses.ELEVATION);s.$crs.filter("button").on(TC.Consts.event.CLICK,function(t){s.showProjectionChangeDialog()});$.isFunction(t)&&t()})})};t.onMouseMove=function(t){this.wrap.onMouseMove(t)};t.onMouseLeave=function(t){var s=this;setTimeout(function(){s.div.getBoundingClientRect();if(!s.isPointerOver(t)){s._$div.css("visibility","hidden");s.clear()}},200)};t.isPointerOver=function(t){var s=this.div.getBoundingClientRect();return s.left<=t.clientX&&s.left+s.width>=t.clientX&&s.top<=t.clientY&&s.top+s.height>=t.clientY};t.formatCoord=function(t,s){var o;o=t.toFixed(s);s<=3&&(o=o.replace(/\B(?=(\d{3})+(?!\d))/g,"|"));return o=o.replace(".",",").replace(/\|/g,".")};t.update=function(){var t=this;!t.isGeo&&t.options.showGeo&&(t.latLon=TC.Util.reproject(t.xy,t.crs,t.geoCrs).reverse());if(!t.isGeo){t.x=t.formatCoord(t.xy[0],TC.Consts.METER_PRECISION);t.y=t.formatCoord(t.xy[1],TC.Consts.METER_PRECISION)}if(t.isGeo||t.options.showGeo){t.lat=t.formatCoord(t.latLon[0],TC.Consts.DEGREE_PRECISION);t.lon=t.formatCoord(t.latLon[1],TC.Consts.DEGREE_PRECISION)}t.render(function(){if(TC.Util.detectMobile()){t._$div.find("span.close").click(function(){t._$div.toggleClass(TC.Consts.classes.HIDDEN,!0);t.clear()});t._$div.find("span.close").show()}else{t._$div.removeClass(TC.Consts.classes.HIDDEN);t._$div.css("visibility","visible");t._$div.find("span.close").hide()}})};t.clear=function(){this._$div.addClass(TC.Consts.classes.HIDDEN);this._$div.css("visibility","hidden");delete this.currentCoordsMarker;this.getLayer().then(function(t){t.clearFeatures()})};t.deactivateCoords=function(){this._$div.toggleClass(TC.Consts.classes.HIDDEN,!0);this.clear();this.wrap.coordsDeactivate()};t.activateCoords=function(){this.wrap.coordsActivate()};t.getCoords=function(){var t=this.map.getControlsByClass(TC.control.Popup);if(t&&t.length>0&&t[0].isVisible())this.coordsToPopup(t[0]);else{this.updateCoordsCtrl([(this.map.getExtent()[0]+this.map.getExtent()[2])/2,(this.map.getExtent()[1]+this.map.getExtent()[3])/2]);this.coordsToClick.call(this,{coordinate:this.xy})}};t.coordsToPopup=function(t){t&&this.updateCoordsCtrl(t.wrap.popup.getPosition())};t.updateCoordsCtrl=function(t){if(t){if(!this.isGeo){this.x=t[0];this.y=t[1];this.xy=[this.x,this.y];t.length>2&&this.xy.push(t[2])}if(this.isGeo||this.options.showGeo){this.lat=t[0];this.lon=t[1];this.latLon=[this.lat,this.lon];t.length>2&&this.latLon.push(t[2])}this.update()}};t.coordsToClick=function(t){var o=this;if(!$(o.map._$div).hasClass("tc-ctl-sv-active "+TC.Consts.classes.COLLAPSED)){var e=o._$div[0].getBoundingClientRect();if(e.left<=t.clientX&&t.clientX<=e.right&&e.top<=t.clientY&&t.clientY<=e.bottom){o._$div.toggleClass(TC.Consts.classes.HIDDEN,!0);o.clear();return}$(o._$div).stop(!0,!0);s&&clearTimeout(s);o.updateCoordsCtrl(t.coordinate);o.coordsMarkerAdd(t.coordinate,t.cssClass);o._$div.removeClass(TC.Consts.classes.HIDDEN);o._$div.css("visibility","visible");$(o._$div).css({opacity:.7});s=setTimeout(function(){$(o._$div).animate({opacity:0},3e3,"linear",function(){o.clear()})},5e3)}};t.coordsMarkerAdd=function(t,s){var o=this;o.currentCoordsMarker?o.currentCoordsMarker.setCoords(t):o.getLayer().then(function(e){$.when(e.addMarker(t,{title:"Coord",showsPopup:!1,cssClass:s||TC.Consts.classes.POINT,anchor:[.5,.5]})).then(function(t){o.currentCoordsMarker=t})})};t.getLayer=function(){var t=this,s=new $.Deferred;void 0==t.layer?t.map.addLayer({id:t.getUID(),type:TC.Consts.layerType.VECTOR,stealth:!0,title:"Coordenadas"}).then(function(o){t.layer=o;t.layer.map.putLayerOnTop(t.layer);s.resolve(t.layer)}):s.resolve(t.layer);return s}}();