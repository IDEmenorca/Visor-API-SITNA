TC.control=TC.control||{};TC.control.ProjectionSelector||TC.syncLoadJS(TC.apiLocation+"TC/control/ProjectionSelector");!function(){TC.control.LayerCatalog=function(){var t=this;t.layers=[];t.searchInit=!1;TC.control.ProjectionSelector.apply(t,arguments);t._selectors={LAYER_ROOT:"div."+t.CLASS+"-tree > ul."+t.CLASS+"-branch > li."+t.CLASS+"-node"};t._readyDeferred=$.Deferred();TC.Consts.classes.SELECTABLE||(TC.Consts.classes.SELECTABLE="tc-selectable");TC.Consts.classes.INCOMPATIBLE||(TC.Consts.classes.INCOMPATIBLE="tc-incompatible");TC.Consts.classes.ACTIVE||(TC.Consts.classes.ACTIVE="tc-active");t._$div.on("mouseup.tc","li",function(e){var s=$(e.target);if(!s.hasClass(t.CLASS+"-leaf")){s.toggleClass(TC.Consts.classes.COLLAPSED);s.find("ul").first().toggleClass(TC.Consts.classes.COLLAPSED);e.stopPropagation()}})};TC.inherit(TC.control.LayerCatalog,TC.control.ProjectionSelector);var t=TC.control.LayerCatalog.prototype;t.CLASS="tc-ctl-lcat";t.template={};if(TC.isDebug){t.template[t.CLASS]=TC.apiLocation+"TC/templates/LayerCatalog.html";t.template[t.CLASS+"-branch"]=TC.apiLocation+"TC/templates/LayerCatalogBranch.html";t.template[t.CLASS+"-node"]=TC.apiLocation+"TC/templates/LayerCatalogNode.html";t.template[t.CLASS+"-info"]=TC.apiLocation+"TC/templates/LayerCatalogInfo.html";t.template[t.CLASS+"-results"]=TC.apiLocation+"TC/templates/LayerCatalogResults.html";t.template[t.CLASS+"-dialog"]=TC.apiLocation+"TC/templates/LayerCatalogDialog.html"}else{t.template[t.CLASS]=function(){dust.register(t.CLASS,e);function e(t,e){return t.w("<h2>").h("i18n",e,{},{$key:"availableLayers"}).x(e.get(["enableSearch"],!1),e,{block:s},{}).w('</h2><div class="tc-ctl-lcat-search tc-hidden tc-collapsed"><div class="tc-group"><input type="search" class="tc-ctl-lcat-input tc-textbox" placeholder="').h("i18n",e,{},{$key:"textToSearchInLayers"}).w('" /></div><ul></ul></div><div class="tc-ctl-lcat-tree">').x(e.get(["layerTrees"],!1),e,{else:n,block:r},{}).w('</div><div class="tc-ctl-lcat-info tc-hidden">').p("tc-ctl-lcat-info",e,e.rebase(e.getPath(!0,[])),{}).w("</div>")}e.__dustBody=!0;function s(t,e){return t.x(e.get(["layerTrees"],!1),e,{block:a},{})}s.__dustBody=!0;function a(t,e){return t.w('<button class="tc-ctl-lcat-btn-search" title="').h("i18n",e,{},{$key:"searchLayersbytext"}).w('"></button>')}a.__dustBody=!0;function n(t,e){return t.w('<div class="tc-ctl tc-ctl-lcat-loading"><span>').h("i18n",e,{},{$key:"loadingLayerTree"}).w("...</span></div>")}n.__dustBody=!0;function r(t,e){return t.w('<ul class="tc-ctl-lcat-branch">').s(e.get(["layerTrees"],!1),e,{block:o},{}).w("</ul>")}r.__dustBody=!0;function o(t,e){return t.p("tc-ctl-lcat-branch",e,e.rebase(e.getPath(!0,[])),{})}o.__dustBody=!0;return e};t.template[t.CLASS+"-branch"]=function(){dust.register(t.CLASS+"-branch",e);function e(t,e){return t.w("<li ").x(e.get(["children"],!1),e,{else:s,block:a},{}).w(' data-tc-layer-name="').f(e.get(["name"],!1),e,"h").w('" data-tc-layer-uid="').f(e.get(["uid"],!1),e,"h").w('"><span>').f(e.get(["title"],!1),e,"h").w('</span><ul class="tc-ctl-lcat-branch tc-collapsed">').s(e.get(["children"],!1),e,{block:n},{}).w("</ul></li>")}e.__dustBody=!0;function s(t,e){return t.w('class="tc-ctl-lcat-node tc-ctl-lcat-leaf"')}s.__dustBody=!0;function a(t,e){return t.w('class="tc-ctl-lcat-node tc-collapsed"')}a.__dustBody=!0;function n(t,e){return t.p("tc-ctl-lcat-node",e,e.rebase(e.getPath(!0,[])),{})}n.__dustBody=!0;return e};t.template[t.CLASS+"-node"]=function(){dust.register(t.CLASS+"-node",e);function e(t,e){return t.x(e.get(["isVisible"],!1),e,{block:s},{})}e.__dustBody=!0;function s(t,e){return t.w("<li ").x(e.get(["children"],!1),e,{else:a,block:n},{}).w(' data-tc-layer-name="').f(e.get(["name"],!1),e,"h").w('" data-tc-layer-uid="').f(e.get(["uid"],!1),e,"h").w('"><span data-tooltip="').x(e.get(["name"],!1),e,{block:r},{}).w('">').f(e.get(["title"],!1),e,"h").w("</span>").x(e.get(["name"],!1),e,{block:o},{}).w('<ul class="tc-ctl-lcat-branch tc-collapsed">').s(e.get(["children"],!1),e,{block:l},{}).w("</ul></li>")}s.__dustBody=!0;function a(t,e){return t.w('class="tc-ctl-lcat-node tc-ctl-lcat-leaf"')}a.__dustBody=!0;function n(t,e){return t.w('class="tc-ctl-lcat-node tc-collapsed"')}n.__dustBody=!0;function r(t,e){return t.h("i18n",e,{},{$key:"clickToAddToMap"})}r.__dustBody=!0;function o(t,e){return t.w('<button class="tc-ctl-lcat-btn-info"/>')}o.__dustBody=!0;function l(t,e){return t.p("tc-ctl-lcat-node",e,e.rebase(e.getPath(!0,[])),{})}l.__dustBody=!0;return e};t.template[t.CLASS+"-info"]=function(){dust.register(t.CLASS+"-info",e);function e(t,e){return t.w('<a class="tc-ctl-lcat-info-close"></a><h2>').h("i18n",e,{},{$key:"layerInfo"}).w('</h2><h3 class="tc-ctl-lcat-title">').f(e.get(["title"],!1),e,"h").w("</h3>").x(e.get(["abstract"],!1),e,{block:s},{}).x(e.get(["metadata"],!1),e,{block:a},{})}e.__dustBody=!0;function s(t,e){return t.w('<div class="tc-ctl-lcat-abstract"><h4>').h("i18n",e,{},{$key:"abstract"}).w("</h4><div>").f(e.get(["abstract"],!1),e,"h").w("</div></div>")}s.__dustBody=!0;function a(t,e){return t.w('<div class="tc-ctl-lcat-metadata"><h4>').h("i18n",e,{},{$key:"metadata"}).w("</h4><ul>").s(e.get(["metadata"],!1),e,{block:n},{}).w("</ul></div>")}a.__dustBody=!0;function n(t,e){return t.w('<li><a href="').f(e.get(["url"],!1),e,"h",["s"]).w('" type="').f(e.get(["format"],!1),e,"h").w('" title="').f(e.get(["formatDescription"],!1),e,"h").w('" target="_blank">').f(e.get(["formatDescription"],!1),e,"h").w("</a></li>")}n.__dustBody=!0;return e};t.template[t.CLASS+"-results"]=function(){dust.register(t.CLASS+"-results",e);function e(t,e){return t.s(e.get(["servicesFound"],!1),e,{else:s,block:a},{})}e.__dustBody=!0;function s(t,e){return t.w('<li class="tc-ctl-lcat-no-results"><h5>').h("i18n",e,{},{$key:"noMatches"}).w("</h5></li>")}s.__dustBody=!0;function a(t,e){return t.h("gt",e,{block:n},{key:e.get(["servicesLooked"],!1),value:1}).s(e.get(["founds"],!1),e,{block:o},{}).h("gt",e,{block:c},{key:e.get(["servicesLooked"],!1),value:1})}a.__dustBody=!0;function n(t,e){return t.w('<li class="tc-ctl-lcat-search-group ').x(e.getPath(!1,["service","isCollapsed"]),e,{block:r},{}).w('" data-tc-service-index="').f(e.getPath(!1,["service","index"]),e,"h").w('"><h5>').f(e.getPath(!1,["service","title"]),e,"h").w("</h5><ul>")}n.__dustBody=!0;function r(t,e){return t.w("tc-collapsed")}r.__dustBody=!0;function o(t,e){return t.w('<li data-tc-layer-name="').f(e.get(["Name"],!1),e,"h").w('" ').x(e.get(["alreadyAdded"],!1),e,{else:l,block:i},{}).w('><h5 class="tc-selectable">').f(e.get(["Title"],!1),e,"h").w('</h5><button class="tc-ctl-lcat-search-btn-info" /></li>')}o.__dustBody=!0;function l(t,e){return t.w(' data-tooltip="').h("i18n",e,{},{$key:"clickToAddToMap"}).w('" ')}l.__dustBody=!0;function i(t,e){return t.w(' data-tooltip="').h("i18n",e,{},{$key:"layerAlreadyAdded"}).w('" class="tc-checked" ')}i.__dustBody=!0;function c(t,e){return t.w("</ul></li>")}c.__dustBody=!0;return e};t.template[t.CLASS+"-dialog"]=function(){dust.register(t.CLASS+"-dialog",e);function e(t,e){return t.w('<div class="tc-ctl-lcat-crs-dialog tc-modal"><div class="tc-modal-background tc-modal-close"></div><div class="tc-modal-window"><div class="tc-modal-header"><h3>').h("i18n",e,{},{$key:"changeCRS"}).w('</h3><div class="tc-ctl-popup-close tc-modal-close"></div></div><div class="tc-modal-body"><p>').h("i18n",e,{},{$key:"wmsLayerNotCompatible.instructions|h"}).w('</p><ul class="tc-ctl-lcat-crs-list tc-crs-list"></ul></div><div class="tc-modal-footer"><button type="button" class="tc-button tc-modal-close">').h("i18n",e,{},{$key:"close"}).w("</button></div></div></div>")}e.__dustBody=!0;return e}}var e="tcLayer",s="tcLayerName",a="tcLayerInfo",n="tcServiceIndex";const r=function(t,e){t.showProjectionChangeDialog({layer:e,closeCallback:function(){$(t.getLayerNodes(e)).removeClass(TC.Consts.classes.LOADING).find("span").attr(o,t.getLocaleString("clickToAddToMap"))}})};var o="data-tooltip";t.register=function(t){var a=this;TC.control.ProjectionSelector.prototype.register.call(a,t);var n=function(){if($.isArray(a.options.layers)){for(var t=0;t<a.options.layers.length;t++){var e=a.options.layers[t];if(!e.type||e.type===TC.Consts.layerType.WMS){e.id||(e.id=TC.getUID());$.isPlainObject(e)&&(e=new TC.layer.Raster(e));a.layers.push(e)}}a.render(function(){a._readyDeferred.resolve()})}else a._readyDeferred.resolve()},r=function(e){if(e.layer===t.baseLayer){n();t.off(TC.Consts.event.LAYERUPDATE,r)}};t.loaded(function(){t.baseLayer.state&&t.baseLayer.state!==TC.Layer.state.IDLE?t.on(TC.Consts.event.LAYERUPDATE,r):n()});var l=function(){if("createEvent"in document){var t=document.createEvent("HTMLEvents");t.initEvent("keyup",!1,!0);a.$text&&a.$text[0].dispatchEvent(t)}else a.$text&&a.$text[0].fireEvent("keyup")},i=a.getLocaleString("layerAlreadyAdded"),c=a.getLocaleString("clickToAddToMap");t.on(TC.Consts.event.BEFORELAYERADD+" "+TC.Consts.event.BEFOREUPDATEPARAMS,function(t){const e=$(a.getLayerNodes(t.layer));e.hasClass(TC.Consts.classes.LOADING)||e.addClass(TC.Consts.classes.LOADING).find("span").removeAttr(o)}).on(TC.Consts.event.LAYERADD+" "+TC.Consts.event.UPDATEPARAMS,function(t){var e=t.layer;e.isBase||e.type!==TC.Consts.layerType.WMS||a._readyDeferred.then(function(){var t=$(a.getLayerRootNode(e)),s=function(){$(a.getLayerNodes(e)).removeClass(TC.Consts.classes.LOADING).addClass(TC.Consts.classes.CHECKED).find("span").attr(o,i);l()};if(t.length)s();else{for(var n=!1,r=0,c=a.layers.length;r<c;r++){var d=a.layers[r];if(d.type===e.type&&d.options.url===e.options.url){n=!0;break}}n||a.addLayer(new TC.layer.Raster({url:e.options.url,type:e.type,layerNames:[],title:e.title||e.wrap.getServiceTitle(),hideTitle:!0,hideTree:!1})).then(function(){t=$(a.getLayerRootNode(e));s()})}})}).on(TC.Consts.event.LAYERERROR,function(t){t.reason&&TC.alert(a.getLocaleString(t.reason,{url:t.layer.url}));$(a.getLayerNodes(t.layer)).removeClass(TC.Consts.classes.LOADING)}).on(TC.Consts.event.LAYERREMOVE,function(t){$(a.getLayerNodes(t.layer)).removeClass(TC.Consts.classes.CHECKED).find("span").attr(o,c);(function(t){var s=$();if(!t.isBase){var n=t.options.url;a.$list&&a.$list.find("li").each(function(a,r){var o=$(r),l=o.data(e);if(l&&l.type===t.type&&l.options.url===n)for(var i=0;i<t.names.length;i++)o.is('li[data-tc-layer-name="'+t.names[i]+'"]')&&(s=s.add(o))})}return s})(t.layer).removeClass(TC.Consts.classes.CHECKED).attr(o,c);!function(t){var e=a.map.getControlsByClass(TC.control.WorkLayers)[0];if(e)for(var s=e.layers,n=0;n<s.length;n++){var r=s[n];r!==t&&$(a.getLayerNodes(r)).addClass(TC.Consts.classes.CHECKED).find("span").attr(o,i)}}(t.layer);l()}).on(TC.Consts.event.EXTERNALSERVICEADDED,function(t){if(t&&t.layer){a.addLayer(t.layer);a._$div.removeClass("tc-collapsed")}}).on(TC.Consts.event.PROJECTIONCHANGE,function(t){a.update()});a._$div.on(TC.Consts.event.CLICK,"span",function(t){var n=$(t.target).parent();if(!n.hasClass(TC.Consts.classes.LOADING)&&!n.hasClass(TC.Consts.classes.CHECKED)){t.preventDefault;var r=n.data(s);r=void 0!==r?r.toString():"";var l=a._$roots.has(n).data(e);l||(l=n.data(e));if(l&&r){var i=1;/iPad/i.test(navigator.userAgent)?i=10:TC.Util.detectFirefox()&&(i=250);l.title||(l.title=l.getTree().title);n.addClass(TC.Consts.classes.LOADING).find("span").attr(o,"");(function(t){var e=new $.Deferred;setTimeout(function(){t[0].offsetHeight=t[0].offsetHeight;t[0].offsetWidth=t[0].offsetWidth;e.resolve()},i);return e.promise()})(n).then(function(){a.addLayerToMap(l,r);t.stopPropagation()})}}})};t.render=function(t){var l=this,i=$.map(l.layers,function(t){return t.wrap.getLayer()});$.when.apply(l,i).then(function(){var i=$.map(l.layers,function(t){var e=t.getTree();!function e(s){for(var a=!1,n=0;n<s.children.length;n++)e(s.children[n])&&(a=!0);s.hasOwnProperty("isVisible")&&(s.isVisible=!t.names||!t.names.length||a||s.isVisible);return s.isVisible}(e);return e});l.renderData({layerTrees:i,enableSearch:l.options.enableSearch},function(){var i=l.getLocaleString("layerAlreadyAdded");l._$roots=l._$div.find(l._selectors.LAYER_ROOT);l._$roots.each(function(t,n){var r=l.layers[t],c={};$(n).data(e,r).find("."+l.CLASS+"-btn-info").each(function(t,e){var n=$(e),d=n.parent().find("span").first(),C=n.parent().data(s).toString();if(C){d.addClass(TC.Consts.classes.SELECTABLE);var u=r.wrap.getInfo(C);if(u.hasOwnProperty("abstract")||u.hasOwnProperty("legend")||u.hasOwnProperty("metadata")){if(u.metadata)for(var f=0,h=u.metadata.length;f<h;f++){var y=u.metadata[f];y.formatDescription=c[y.format]=c[y.format]||l.getLocaleString(TC.Util.getSimpleMimeType(y.format))||l.getLocaleString("viewMetadata")}n.data(a,u);n.on(TC.Consts.event.CLICK,function(){if($(this).hasClass(TC.Consts.classes.CHECKED)){$(this).removeClass(TC.Consts.classes.CHECKED);l.hideLayerInfo()}else{l.showLayerInfo(r,C);$(this).addClass(TC.Consts.classes.CHECKED)}})}else n.remove();r.compatibleLayers&&r.compatibleLayers.indexOf(C)<0&&d.addClass(TC.Consts.classes.INCOMPATIBLE).attr("title",l.getLocaleString("reprojectionNeeded"));if(l.map)for(f=0,h=l.map.workLayers.length;f<h;f++){var p=l.map.workLayers[f];if(p.type===TC.Consts.layerType.WMS&&p.url===r.url&&1===p.names.length&&p.names[0]===C){d.parent().addClass(TC.Consts.classes.CHECKED);d.attr(o,i)}}}else{d.attr(o,"");n.remove()}})});l.getRenderedHtml(l.CLASS+"-dialog",null,function(t){l._$dialogDiv.html(t)});l.$text=l._$div.find("."+l.CLASS+"-input");l.$list=l._$div.find("."+l.CLASS+"-search ul");l.$text.on("mouseup",function(t){""!==l.$text.val()&&setTimeout(function(){""===l.$text.val()&&l.$list.empty()},1)});var c=[];TC._search=TC._search||{};TC._search.retryTimeout=null;TC.loadJS(!l.$text.autocomplete,[TC.apiLocation+"lib/jQuery/autocomplete.js"],function(){l.$text.autocomplete({link:"#",target:l.$list,minLength:0,source:function(t,e){c=[];l._$roots.find("li."+TC.Consts.classes.CHECKED).each(function(t,e){c.push($(e).data(s).toString())});if((t=t.trim()).length<3)l.$list.html("");else if(t.length>=3){TC._search.retryTimeout&&clearTimeout(TC._search.retryTimeout);TC._search.retryTimeout=setTimeout(function(){for(var s=[],a=0;a<l.layers.length;a++){var n=l.layers[a].searchSubLayers(t);n.length&&s.push({service:{index:a,title:l.layers[a].title||l.layers[a].id},founds:n})}e({servicesFound:s,servicesLooked:l.layers.length})},TC._search.interval)}},callback:function(t){l.$text.val(t.target.text||t.target.innerText);TC._search.lastPattern=l.$text.val();l.goToResult(unescape(t.target.hash).substring(1));l.$text.autocomplete("clear")},buildHTML:function(t){if(t.results&&t.results.servicesFound.length>0)for(var e=l.map.getLayerTree().workLayers,s=0;s<t.results.servicesFound.length;s++){for(var a=t.results.servicesFound[s].founds,n=0;n<a.length;n++){delete a[n].alreadyAdded;for(var r=0;r<e.length;r++)if(c.indexOf(a[n].Name)>=0){a[n].alreadyAdded=!0;break}if(!a[n].Name){a.splice(n,1);n--}}t.results.servicesFound[s].founds.length?t.results.servicesFound[s].service.isCollapsed=$(l._$div.find(".tc-ctl-lcat-search-group")[s]).hasClass(TC.Consts.classes.COLLAPSED):t.results.servicesFound.splice(s,1)}var o="";dust.render(l.CLASS+"-results",t.results,function(t,e){o=e});return o}})});if(!l.searchInit){l._$div.on("click","h2 button",function(){var t=l._$div.hasClass("tc-collapsed");l._$div.removeClass("tc-collapsed");var e=l._$div.find("."+l.CLASS+"-search"),s=l._$div.find("."+l.CLASS+"-tree"),a=l._$div.find("."+l.CLASS+"-info");if(e.hasClass(TC.Consts.classes.HIDDEN)||t){e.removeClass(TC.Consts.classes.HIDDEN);s.addClass(TC.Consts.classes.HIDDEN);l.$text[0].focus();$(this).addClass(l.CLASS+"-btn-tree");$(this).attr("title",l.getLocaleString("viewAvailableLayersTree"));$(this).removeClass(l.CLASS+"-btn-search");0===$(".tc-ctl-lcat-search li button.tc-checked").length&&a.addClass(TC.Consts.classes.HIDDEN)}else{e.addClass(TC.Consts.classes.HIDDEN);s.removeClass(TC.Consts.classes.HIDDEN);$(this).addClass(l.CLASS+"-btn-search");$(this).attr("title",l.getLocaleString("searchLayersByText"));$(this).removeClass(l.CLASS+"-btn-tree");$(".tc-ctl-lcat-tree li button.tc-checked").length>0&&a.removeClass(TC.Consts.classes.HIDDEN)}});l._$div.on("click","."+l.CLASS+"-search button."+l.CLASS+"-search-btn-info",function(t){t.stopPropagation();if($(this).hasClass(TC.Consts.classes.CHECKED)){$(this).removeClass(TC.Consts.classes.CHECKED);l.hideLayerInfo()}else{var e=$(this).parent();l.showLayerInfo(l.layers[e.parents("li").data(n)],e.data(s));$(this).addClass(TC.Consts.classes.CHECKED)}});l._$div.on("click",".tc-ctl-lcat-search li",function(t){t.stopPropagation();var a=$(this);if(!a.hasClass("tc-ctl-lcat-no-results"))if(a.hasClass("tc-ctl-lcat-search-group"))a.toggleClass(TC.Consts.classes.COLLAPSED);else{var c=a.data(s);c=void 0!==c?c.toString():"";if(!$(this).hasClass(TC.Consts.classes.CHECKED)){var d=a.parents("li.tc-ctl-lcat-search-group"),C=l.layers[0==d.length?0:d.data(n)].options.url,u=l.layers[0==d.length?0:d.data(n)].title;const t=new TC.layer.Raster({id:l.getUID(),url:C,title:u,hideTitle:!0,layerNames:[c]});if(t.isCompatible(l.map.crs)){l.map.addLayer(t,function(t){a.data(e,t);t.wrap.$events.on(TC.Consts.event.TILELOADERROR,function(t){var e=this.parent;401!==t.error.code&&403!==t.error.code||e.map.toast(t.error.text,{type:TC.Consts.msgType.ERROR});e.map.removeLayer(e)})});$(this).addClass(TC.Consts.classes.CHECKED);$(this).attr(o,i)}else r(l,t)}}});l.searchInit=!0}$.isFunction(t)&&t()})})};t.getLayerRootNode=function(t){const s=this;var a=null;if(!t.isBase){var n=t.options.url;s._$roots&&s._$roots.each(function(s,r){var o=$(r).data(e);o&&o.type===t.type&&o.options.url===n&&(a=r)})}return a};t.getLayerNodes=function(t){var e=[],s=$(this.getLayerRootNode(t));if(s.length)for(var a=0;a<t.names.length;a++){const n=s.find('li[data-tc-layer-name="'+t.names[a]+'"]');if(0!=n.length){e[e.length]=n[0];n.find("li").each(function(t,s){e[e.length]=s})}}return e};t.showLayerInfo=function(t,n){var r=this,o=null,l=r._$div.find("."+r.CLASS+"-info");r._$div.find("."+r.CLASS+"-btn-info, ."+r.CLASS+"-search-btn-info").removeClass(TC.Consts.classes.CHECKED);r._$roots.each(function(i,c){var d=$(c);if(d.data(e)===t){d.find("."+r.CLASS+"-btn-info").each(function(t,e){var i=$(e),c=i.parent().data(s).toString();if(c===n){var d=i.data(a);r._$div.find('li [data-tc-layer-name="'+c+'"] > button').toggleClass(TC.Consts.classes.CHECKED,function(t,e){var a=!1;l.data(s);if(e){a=!0;l.data(s,t);l.removeClass(TC.Consts.classes.HIDDEN);dust.render(r.CLASS+"-info",e,function(t,e){l.html(e);t&&TC.error(t);l.find("."+r.CLASS+"-info-close").on(TC.Consts.event.CLICK,function(){r.hideLayerInfo()})})}return a}(c,d));o=d;return!1}});return!1}});return o};t.update=function(){const t=this;t.layers.forEach(function(e){e.getCapabilitiesPromise().then(function(){e.compatibleLayers=e.wrap.getCompatibleLayers(t.map.crs);$(t.getLayerRootNode(e)).find("li[data-tc-layer-name]").each(function(a,n){const r=$(n),o=r.data(s),l=r.find("span."+TC.Consts.classes.SELECTABLE);e.compatibleLayers.indexOf(o)<0?l.addClass(TC.Consts.classes.INCOMPATIBLE).attr("title",t.getLocaleString("reprojectionNeeded")):l.removeClass(TC.Consts.classes.INCOMPATIBLE).attr("title",null)})})})};t.hideLayerInfo=function(){this._$div.find("."+this.CLASS+"-btn-info, ."+this.CLASS+"-search-btn-info").removeClass(TC.Consts.classes.CHECKED);this._$div.find("."+this.CLASS+"-info").addClass(TC.Consts.classes.HIDDEN)};t.addLayer=function(t){var e=$.Deferred(),s=this,a=[];s.options.layers&&s.options.layers.length&&(a=$.grep(s.options.layers,function(e){var s=TC.Util.reqGetMapOnCapabilities(e.url);return s&&s.replace(TC.Util.regex.PROTOCOL)==t.url.replace(TC.Util.regex.PROTOCOL)}));0==a.length&&(a=$.grep(s.layers,function(e){return e.url.replace(TC.Util.regex.PROTOCOL)==t.url.replace(TC.Util.regex.PROTOCOL)}));if(0==a.length){s.layers.push(t);t.getCapabilitiesPromise().then(function(){t.compatibleLayers=t.wrap.getCompatibleLayers(s.map.crs);t.title=t.title||t.wrap.getServiceTitle();s.render(function(){e.resolve()})})}else e.resolve();return e};t.addLayerToMap=function(t,e){const s=this,a=$.extend({},t.options);a.id=s.getUID();a.layerNames=[e];a.title=t.title;const n=new TC.layer.Raster(a);n.isCompatible(s.map.crs)?s.map.addLayer(a).then(function(t){t.wrap.$events.on(TC.Consts.event.TILELOADERROR,function(t){var e=this.parent;401!==t.error.code&&403!==t.error.code||e.map.toast(t.error.text,{type:TC.Consts.msgType.ERROR});e.map.removeLayer(e)})}):r(s,n)};t.loaded=function(){return this._readyDeferred.promise()};t.getAvailableCRS=function(t){t=t||{};return this.map.getCompatibleCRS({layers:this.map.workLayers.concat(this.map.baseLayer,t.layer),includeFallbacks:!0})};t.setProjection=function(t){const e=this;t=t||{};TC.loadProjDef({crs:t.crs,callback:function(){e.map.setProjection(t).then(function(){e._layerToAdd&&e.map.addLayer(e._layerToAdd);TC.Util.closeModal()})}})};t.showProjectionChangeDialog=function(t){this._layerToAdd=t.layer;TC.control.ProjectionSelector.prototype.showProjectionChangeDialog.call(this,t)}}();