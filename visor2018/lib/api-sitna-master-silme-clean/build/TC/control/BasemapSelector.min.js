TC.control=TC.control||{};TC.control.MapContents||TC.syncLoadJS(TC.apiLocation+"TC/control/MapContents");!function(){TC.control.BasemapSelector=function(){var t=this;TC.control.MapContents.apply(t,arguments);t._$dialogDiv=$(TC.Util.getDiv(t.options.dialogDiv));t.options.dialogDiv||t._$dialogDiv.appendTo("body");t._$dialogDiv.on(TC.Consts.event.CLICK,"button",function(a){TC.Util.closeModal();const o=$(a.target),n=o.data(e.PROJCODE),l=t._$dialogDiv.find("."+t.CLASS+"-crs-dialog").data(e.LAYER);if(l)if(n)TC.loadProjDef({crs:n,callback:function(){t.map.setProjection({crs:n,baseLayer:l})}});else{const a=o.data(e.FALLBACK_LAYER);a&&t.map.setBaseLayer(a)}})};TC.inherit(TC.control.BasemapSelector,TC.control.MapContents);var t=TC.control.BasemapSelector.prototype;t.CLASS="tc-ctl-bms";var e={LAYER:"tcLayer",FALLBACK_LAYER:"tcFallbackLayer",PROJCODE:"tcProjCode"};t.template={};if(TC.isDebug){t.template[t.CLASS]=TC.apiLocation+"TC/templates/BasemapSelector.html";t.template[t.CLASS+"-node"]=TC.apiLocation+"TC/templates/BasemapSelectorNode.html";t.template[t.CLASS+"-dialog"]=TC.apiLocation+"TC/templates/BasemapSelectorDialog.html"}else{t.template[t.CLASS]=function(){dust.register(t.CLASS,e);function e(t,e){return t.w("<h2>").h("i18n",e,{},{$key:"backgroundMaps"}).w('</h2><div class="tc-ctl-bms-tree"><form><ul class="tc-ctl-bms-branch">').s(e.get(["baseLayers"],!1),e,{block:a},{}).w("</ul></form></div>")}e.__dustBody=!0;function a(t,e){return t.p("tc-ctl-bms-node",e,e.rebase(e.getPath(!0,[])),{})}a.__dustBody=!0;return e};t.template[t.CLASS+"-node"]=function(){dust.register(t.CLASS+"-node",e);function e(t,e){return t.w('<li class="tc-ctl-bms-node" data-tc-layer-name="').f(e.get(["name"],!1),e,"h").w('" data-tc-layer-uid="').f(e.get(["uid"],!1),e,"h").w('"><label').x(e.get(["legend"],!1),e,{block:a},{}).w('><input type="radio" name="bms" value="').f(e.get(["name"],!1),e,"h").w('"').x(e.get(["mustReproject"],!1),e,{block:o},{}).w(" /><span>").f(e.get(["title"],!1),e,"h").w("</span></label></li>")}e.__dustBody=!0;function a(t,e){return t.w(' style="background-image: url(').f(e.getPath(!1,["legend","src"]),e,"h").w(')"')}a.__dustBody=!0;function o(t,e){return t.w(' class="tc-disabled"')}o.__dustBody=!0;return e};t.template[t.CLASS+"-dialog"]=function(){dust.register(t.CLASS+"-dialog",e);function e(t,e){return t.w('<div class="tc-ctl-bms-crs-dialog tc-modal"><div class="tc-modal-background tc-modal-close"></div><div class="tc-modal-window"><div class="tc-modal-header"><h3>').h("i18n",e,{},{$key:"baseLayerNotCompatible"}).w('</h3><div class="tc-ctl-popup-close tc-modal-close"></div></div><div class="tc-modal-body"><p>').h("i18n",e,{},{$key:"baseLayerNotCompatible.instructions|h"}).w('</p><ul class="tc-ctl-bms-crs-list tc-crs-list"></ul></div><div class="tc-modal-footer"><button type="button" class="tc-button tc-modal-close">').h("i18n",e,{},{$key:"close"}).w("</button></div></div></div>")}e.__dustBody=!0;return e}}t.register=function(t){var a=this;TC.control.MapContents.prototype.register.call(a,t);t.on(TC.Consts.event.BASELAYERCHANGE+" "+TC.Consts.event.PROJECTIONCHANGE,function(){a.update()});a._$div.on("change","input[type=radio]",function(t){var o=$(t.target).closest("li").data(e.LAYER);if(o!=o.map.getBaseLayer())if(o.mustReproject){a._$currentSelection.prop("checked",!0);const t={layer:o},e=o.getFallbackLayer();e?e._capabilitiesPromise.then(function(){e.isCompatible(a.map.crs)&&(t.fallbackLayer=e);a.showProjectionChangeDialog(t)}):a.showProjectionChangeDialog(t)}else o.map.setBaseLayer(o);t.stopPropagation()})};t.render=function(t){var e=this;TC.control.MapContents.prototype.render.call(e,t);e.getRenderedHtml(e.CLASS+"-dialog",null,function(t){e._$dialogDiv.html(t)})};t.update=function(){var t=this;t._$currentSelection=null;t._$div.find("ul."+t.CLASS+"-branch").children("li").each(function(a,o){var n=$(o),l=n.data(e.LAYER),i=n.find("input[type=radio]").first(),r=t.map.baseLayer===l||l.getFallbackLayer&&t.map.baseLayer===l.getFallbackLayer();i.prop("checked",r).toggleClass(TC.Consts.classes.DISABLED,l.mustReproject||!1);n.attr("title",l.mustReproject?t.getLocaleString("reprojectionNeeded"):null);r&&(t._$currentSelection=i)});t.updateScale()};t.updateLayerTree=function(t){var a=this;if(t.isBase&&!t.options.stealth){TC.control.MapContents.prototype.updateLayerTree.call(a,t);var o=a.CLASS+"-node";TC.loadJSInOrder(!window.dust,TC.url.templating,function(){dust.render(o,a.layerTrees[t.id],function(o,n){var l=$(n),i=l.data("tcLayerUid"),r=a._$div.find("."+a.CLASS+"-branch"),c=r.find('li[data-tc-layer-uid="'+i+'"]');if(1===c.length)c.html(l.html());else{l.data(e.LAYER,t);const o=a.map.baseLayers.reduce(function(e,o,n){return a.map.baseLayers[n].id===t.id?n:e},-1);if(o<0)r.append(l);else{o>=r.find("li").length?r.append(l):l.insertBefore(r.find("li").get(o))}}o&&TC.error(o)});a.update()})}};t.updateLayerOrder=function(t,e,a){};t.removeLayer=function(t){if(t.isBase){this._$div.find("."+this.CLASS+"-branch").children("li").each(function(a,o){var n=$(o);if(n.data(e.LAYER)===t){n.remove();return!1}})}};t.showProjectionChangeDialog=function(t){const a=this,o=(t=t||{}).layer,n=a._$dialogDiv.find("."+a.CLASS+"-crs-dialog");n.data(e.LAYER,o);const l=n.find("ul."+a.CLASS+"-crs-list").empty();a.map.loadProjections({crsList:a.map.getCompatibleCRS({layers:a.map.workLayers.concat(o)}),orderBy:"name"}).then(function(o){o.forEach(function(t){l.append($("<li>").append($("<button>").html(a.getLocaleString("changeMapToCrs",{crs:t.name+" ("+t.code+")"})).data(e.PROJCODE,t.code)))});t.fallbackLayer&&l.append($("<li>").append($("<button>").html(a.getLocaleString("reprojectOnTheFly")).data(e.FALLBACK_LAYER,t.fallbackLayer)))});n.find("."+a.CLASS+"-name").html(o.title||o.name);TC.Util.showModal(n)}}();