TC.control=TC.control||{};TC.control.MapContents||TC.syncLoadJS(TC.apiLocation+"TC/control/MapContents");TC.control.Legend=function(){TC.control.MapContents.apply(this,arguments)};TC.inherit(TC.control.Legend,TC.control.MapContents);!function(){var e=TC.control.Legend.prototype;e.CLASS="tc-ctl-legend";e.template={};if(TC.isDebug){e.template[e.CLASS]=TC.apiLocation+"TC/templates/Legend.html";e.template[e.CLASS+"-node"]=TC.apiLocation+"TC/templates/LegendNode.html"}else{e.template[e.CLASS]=function(){dust.register(e.CLASS,t);function t(e,t){return e.w("<h2>").h("i18n",t,{},{$key:"legend"}).w('</h2><div class="tc-ctl-legend-tree"><ul class="tc-ctl-legend-branch">').s(t.get(["workLayers"],!1),t,{else:n,block:i},{}).w("</ul></div>")}t.__dustBody=!0;function n(e,t){return e.w('<li class="tc-ctl-legend-empty">').h("i18n",t,{},{$key:"noData"}).w("</li>")}n.__dustBody=!0;function i(e,t){return e.p("tc-ctl-legend-node",t,t.rebase(t.getPath(!0,[])),{})}i.__dustBody=!0;return t};e.template[e.CLASS+"-node"]=function(){dust.register(e.CLASS+"-node",t);function t(e,t){return e.x(t.get(["customLegend"],!1),t,{else:n,block:h},{})}t.__dustBody=!0;function n(e,t){return e.w("<li ").x(t.get(["children"],!1),t,{else:i,block:l},{}).w(' data-tc-layer-name="').f(t.get(["name"],!1),t,"h").w('" data-tc-layer-uid="').f(t.get(["uid"],!1),t,"h").w('"><div class="tc-ctl-legend-title">').f(t.get(["title"],!1),t,"h").w("</div>").x(t.get(["legend"],!1),t,{block:d},{}).w('<ul class="tc-ctl-legend-branch">').s(t.get(["children"],!1),t,{block:u},{}).w("</ul></li>")}n.__dustBody=!0;function i(e,t){return e.w('class="tc-ctl-legend-node tc-ctl-legend-leaf" ')}i.__dustBody=!0;function l(e,t){return e.w('class="tc-ctl-legend-node" ')}l.__dustBody=!0;function d(e,t){return e.w('<div class="tc-ctl-legend-watch">').x(t.getPath(!1,["legend","src"]),t,{else:a,block:o},{}).w('</div><div class="tc-ctl-legend-nvr">').h("i18n",t,{},{$key:"notVisibleAtCurrentResolution"}).w("</div>")}d.__dustBody=!0;function a(e,t){return e.x(t.getPath(!1,["legend","width"]),t,{block:s},{})}a.__dustBody=!0;function s(e,t){return e.w('<div class="tc-ctl-legend-img" style="border:solid ').f(t.getPath(!1,["legend","strokeWidth"]),t,"h").w("px ").f(t.getPath(!1,["legend","strokeColor"]),t,"h").w(";background-color:").f(t.getPath(!1,["legend","fillColor"]),t,"h").x(t.getPath(!1,["legend","width"]),t,{block:r},{}).w('"></div>')}s.__dustBody=!0;function r(e,t){return e.w(";width:").f(t.getPath(!1,["legend","width"]),t,"h").w("px;height:").f(t.getPath(!1,["legend","height"]),t,"h").w("px;border-radius:50%")}r.__dustBody=!0;function o(e,t){return e.w('<img src="" data-tc-img="').f(t.getPath(!1,["legend","src"]),t,"h").w('" ').x(t.getPath(!1,["legend","width"]),t,{block:c},{}).w(" />")}o.__dustBody=!0;function c(e,t){return e.w('style="width:').f(t.getPath(!1,["legend","width"]),t,"h").w("px;height:").f(t.getPath(!1,["legend","height"]),t,"h").w('px;" ')}c.__dustBody=!0;function u(e,t){return e.p("tc-ctl-legend-node",t,t.rebase(t.getPath(!0,[])),{})}u.__dustBody=!0;function h(e,t){return e.f(t.get(["customLegend"],!1),t,"h",["s"])}h.__dustBody=!0;return t}}var t="tcLayer",n="tcLayerUid";e.register=function(e){TC.control.MapContents.prototype.register.call(this,e)};e.loadGraphics=function(){var e=this;e._$div.find("ul."+e.CLASS+"-branch").first().children("li").not("."+e.CLASS+"-empty").each(function(n,i){var l=$(i),d=l.data(t);d&&l.find("li.tc-ctl-legend-node-visible").each(function(t,n){var i=$(n).find("img").first();i&&void 0!=i.attr("src")&&0==i.attr("src").length&&e.styleLegendImage(i,d)})})};e.updateScale=function(){var e=this,i=e.CLASS+"-node-inscale",l=e.CLASS+"-node-outofscale";e._$div.find("ul."+e.CLASS+"-branch").first().children("li").not("."+e.CLASS+"-empty").each(function(d,a){var s=$(a),r=s.data(t);if(r){var o=!1;s.find("li").each(function(t,d){var a=$(d);if(a.hasClass(e.CLASS+"-node-visible")){var s=a.data(n);if(r.isVisibleByScale(s)){o=!0;a.removeClass(l).addClass(i);var c=a.find("img").first();c.length>0&&e.styleLegendImage(c,r)}else a.addClass(l).removeClass(i)}});s.toggleClass(i,o);s.toggleClass(l,!o)}})};e.update=function(){var e=this;e._$div.find("ul."+e.CLASS+"-branch").first().children("li").each(function(i,l){var d=$(l),a=d.data(t);if(a){a.getTree();d.find("li").each(function(t,i){var l=$(i),d=l.data(n),s=e.CLASS+"-node-visible",r=e.CLASS+"-node-notvisible",o=e.CLASS+"-node-hasvisible";switch(a._cache.visibilityStates[d]){case TC.Consts.visibility.NOT_VISIBLE:l.removeClass(s+" "+o).addClass(r);break;case TC.Consts.visibility.HAS_VISIBLE:l.removeClass(s+" "+r).addClass(o);break;default:l.removeClass(r+" "+o).addClass(s)}});e.updateLayerVisibility(a)}});e.updateScale()};e.updateLayerTree=function(e){var i=this;if(!e.isBase&&!e.options.stealth){TC.control.MapContents.prototype.updateLayerTree.call(i,e);i._$div.find("."+i.CLASS+"-empty").addClass(TC.Consts.classes.HIDDEN);TC.loadJSInOrder(!window.dust,TC.url.templating,function(){dust.render(i.CLASS+"-node",i.layerTrees[e.id],function(l,d){var a=$(d),s=a.data(n),r=i._$div.find("ul."+i.CLASS+"-branch").first(),o=r.find('li[data-tc-layer-uid="'+s+'"]');if(1===o.length)o.html(a.html());else{a.data(t,e);r.prepend(a)}l&&TC.error(l)});i.update()})}};e.removeLayer=function(e){var n=this,i=function(){return n._$div.find("."+n.CLASS+"-branch").first().children("li").not("."+n.CLASS+"-empty")};if(!e.isBase){var l=i();l.each(function(n,d){var a=$(d);if(a.data(t)===e){a.remove();l=i();return!1}});0===l.length&&n._$div.find("."+n.CLASS+"-empty").removeClass(TC.Consts.classes.HIDDEN)}};e.updateLayerVisibility=function(e){var n=this;n._$div.find("."+n.CLASS+"-branch").first().children("li").each(function(i,l){var d=$(l);if(d.data(t)===e){d.toggleClass(n.CLASS+"-node-notvisible",!e.getVisibility());return!1}})};e.getLayerUIElements=function(){return this._$div.find("ul."+this.CLASS+"-branch").first().children("li."+this.CLASS+"-node")}}();