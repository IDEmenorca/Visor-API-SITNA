TC.layer=TC.layer||{};TC.Layer||TC.syncLoadJS(TC.apiLocation+"TC/Layer");TC.layer.Vector=function(){TC.Layer.apply(this,arguments);this.type=this.options.type||TC.Consts.layerType.VECTOR;this.features=[];this.selectedFeatures=[];const e=function(e){var t=(e=e||"").indexOf("?");t>=0?e=e.substr(0,t):(t=e.indexOf("#"))>=0&&(e=e.substr(0,t));return e.substr(e.lastIndexOf(".")).toLowerCase()}(this.url),t=function(e){switch(e){case TC.Consts.mimeType.KML:return TC.Consts.format.KML;case TC.Consts.mimeType.GPX:return TC.Consts.format.GPX;case TC.Consts.mimeType.JSON:case TC.Consts.mimeType.GEOJSON:return TC.Consts.format.GEOJSON;case TC.Consts.mimeType.GML:return TC.Consts.format.GML;default:return null}}(this.options.format)||function(e){switch(e){case".kml":return TC.Consts.format.KML;case".gpx":return TC.Consts.format.GPX;case".json":case".geojson":return TC.Consts.format.GEOJSON;case".gml":return TC.Consts.format.GML;case".wkt":return TC.Consts.format.WKT;case".topojson":return TC.Consts.format.TOPOJSON;default:return null}}(e);if(t||this.type===TC.Consts.layerType.KML){t===TC.Consts.format.KML&&(this.type=TC.Consts.layerType.KML);this.title=this.options.title||function(t){for(var s=t=t||"",n=new RegExp("([^/]+"+e+")","i"),r=0;r<3;r++){t=decodeURIComponent(t);var i=n.exec(t);if(i.length>1){s=i[1];break}}return s}(this.url)}this.wrap=new TC.wrap.layer.Vector(this);var s=this.wrap.createVectorLayer();this.wrap.setLayer(s)};TC.inherit(TC.layer.Vector,TC.Layer);!function(){var e=TC.layer.Vector.prototype;e.getTree=function(){var e=null;if(!this.options.stealth){(e={}).children=[];for(var t=0;t<this.features.length;t++){var s=this.features[t].getPath();if(s.length){var n=TC.Util.addArrayToTree(s,e);n&&(n.legend=this.features[t].getLegend())}}e.name=this.name||e.name;e.customLegend=this.options.customLegend;e.title=this.title||e.title;e.uid=this.id}return e};var t=function(e,t,s,n){var r=new $.Deferred;$.when(t.call(e,[s],n)).then(function(t){r.resolve(t[0]);e.map&&e.map.$events.trigger($.Event(TC.Consts.event.FEATUREADD,{layer:e,feature:t[0]}))});return r},s=function(e,t,s,n,r){var i=new $.Deferred,o=e.options.styles&&e.options.styles[n]||TC.Cfg.styles[n],a=$.extend(!0,{},o,r);TC.loadJS(!TC.feature||TC.feature&&!TC.feature[s],[TC.apiLocation+"TC/feature/"+s],function(){for(var n=TC.feature[s],r=new Array(t.length),o=[],l=0,u=t.length;l<u;l++){var c,f=t[l];const s=TC.wrap.Feature.prototype.isNative(f);if(f instanceof n)c=f;else{a.layer=e;s&&(c=f._wrap&&f._wrap.parent);c||(c=new n(f,a))}c.layer=e;r[l]=c;e.features[e.features.length]=c;s||(o[o.length]=c.wrap.feature);c.options.showPopup&&c.showPopup()}o.length&&e.wrap.addFeatures(o);i.resolve(r)});return i};e.addPoint=function(e,s){return t(this,this.addPoints,e,s)};e.addPoints=function(e,t){return s(this,e,"Point",TC.Consts.geom.POINT,t)};e.addMarker=function(e,s){return t(this,this.addMarkers,e,s)};e.addMarkers=function(e,t){return s(this,e,"Marker","marker",t)};e.addPolyline=function(e,s){return t(this,this.addPolylines,e,s)};e.addPolylines=function(e,t){return s(this,e,"Polyline",TC.Consts.geom.POLYLINE,t)};e.addMultiPolyline=function(e,s){return t(this,this.addMultiPolylines,e,s)};e.addMultiPolylines=function(e,t){return s(this,e,"MultiPolyline",TC.Consts.geom.POLYLINE,t)};e.addPolygon=function(e,s){return t(this,this.addPolygons,e,s)};e.addPolygons=function(e,t){return s(this,e,"Polygon",TC.Consts.geom.POLYGON,t)};e.addMultiPolygon=function(e,s){return t(this,this.addMultiPolygons,e,s)};e.addMultiPolygons=function(e,t){return s(this,e,"MultiPolygon",TC.Consts.geom.POLYGON,t)};e.addCircle=function(e,s){return t(this,this.addCircles,e,s)};e.addCircles=function(e,t){return s(this,e,"Circle",TC.Consts.geom.POLYGON,t)};e.addFeature=function(e){var t;TC.feature&&(TC.feature.Point&&e instanceof TC.feature.Point?t=this.addPoint(e):TC.feature.Polyline&&e instanceof TC.feature.Polyline?t=this.addPolyline(e):TC.feature.Polygon&&e instanceof TC.feature.Polygon?t=this.addPolygon(e):TC.feature.MultiPolygon&&e instanceof TC.feature.MultiPolygon?t=this.addMultiPolygon(e):TC.feature.MultiPolyline&&e instanceof TC.feature.MultiPolyline?t=this.addMultiPolyline(e):TC.feature.Circle&&e instanceof TC.feature.Circle&&(t=this.addCircle(e)));return t};e.removeFeature=function(e){const t=this;if(t.map){t.map.getControlsByClass("TC.control.Popup").forEach(function(t){t.isVisible()&&t.currentFeature===e&&t.hide()})}t.wrap.removeFeature(e)};e.getFeatureById=function(e){var t=null,s=this.wrap.getFeatureById(e);s&&(t=s._wrap.parent);return t};e.clearFeatures=function(){var e=this;if(e.features&&e.wrap){if(e.map){e.map.getControlsByClass("TC.control.Popup").forEach(function(t){t.isVisible()&&e.features.indexOf(t.currentFeature)>=0&&t.hide()})}e.features.length=0;e.wrap.clearFeatures()}};e.describeFeatureType=function(e,t){var s=$.Deferred();$.ajax({url:this.wrap.getDescribeFeatureTypeUrl(),type:"GET",dataType:"xml"}).then(function(e){var t="http://www.w3.org/2001/XMLSchema",n=e.getElementsByTagNameNS(t,"complexType")[0];if(n){for(var r=n.getElementsByTagNameNS(t,"element"),i=new Array(r.length),o=0,a=r.length;o<a;o++){var l=r[o];i[o]={name:l.getAttribute("name"),type:l.getAttribute("type"),nillable:"true"===l.getAttribute("nillable"),minOccurs:parseInt(l.getAttribute("minOccurs")),maxOccurs:parseInt(l.getAttribute("maxOccurs"))}}s.resolve(i)}else{var u=e.getElementsByTagName("Exception")[0];u&&s.reject(u.getElementsByTagName("ExceptionText")[0].innerHTML)}},function(e,t,n){s.reject(n)});s.then(function(t){$.isFunction(e)&&e(t)},function(e){$.isFunction(t)&&t(e)});return s.promise()};e.import=function(e){this.wrap.import(e)};e.setNodeVisibility=function(e,t){this.state=TC.Layer.state.LOADING;this.map.$events.trigger($.Event(TC.Consts.event.BEFOREUPDATE));this.map.$events.trigger($.Event(TC.Consts.event.BEFORELAYERUPDATE,{layer:this}));this.tree||(this.tree=this.getTree());if(this.findNode(e,this.tree)===this.tree)this.setVisibility(t);else{this._cache.visibilityStates[e]=t?TC.Consts.visibility.VISIBLE:TC.Consts.visibility.NOT_VISIBLE;var s,n,r=!1;for(s=0;s<this.features.length;s++)if((n=this.features[s]).id==e){r=!0;n.setVisibility(t);break}if(!r)for(s=0;s<this.features.length;s++){void 0===(n=this.features[s])._path&&(n._path="/"+n.getPath().join("/"));n._path===e&&n.setVisibility(t)}}this.state=TC.Layer.state.IDLE;this.map.$events.trigger($.Event(TC.Consts.event.LAYERUPDATE,{layer:this}));this.map.$events.trigger($.Event(TC.Consts.event.UPDATE))};e.getNodeVisibility=function(e){var t=TC.Layer.prototype.getNodeVisibility.call(this,e);this.tree||(this.tree=this.getTree());if(this.findNode(e,this.tree)===this.tree)t=this.getVisibility()?TC.Consts.visibility.VISIBLE:TC.Consts.visibility.NOT_VISIBLE;else{var s=this._cache.visibilityStates[e];void 0!==s&&(t=s)}return t};e.setModifiable=function(e){this.wrap.setModifiable(e)};e.applyEdits=function(e,t,s){return this.wrap.sendTransaction(e,t,s)};e.refresh=function(){return this.wrap.reloadSource()};e.getFeaturesInCurrentExtent=function(e){var t=this.map.getExtent();return this.getFeaturesInExtent(t,e)};e.getFeaturesInExtent=function(e,t){return this.wrap.getFeaturesInExtent(e,t)};e.setProjection=function(e){const t=this;t.wrap.setProjection(e);if(e.crs&&e.oldCrs){t.map.$events.trigger($.Event(TC.Consts.event.BEFORELAYERUPDATE,{layer:t}));t.features.forEach(function(t){t.wrap.setGeometry(TC.Util.reproject(t.geometry,e.oldCrs,e.crs));t.geometry=t.wrap.getGeometry()});t.map.$events.trigger($.Event(TC.Consts.event.LAYERUPDATE,{layer:t}))}};const n=function(e){return $.isArray(e)?e.map(n):e};e.exportState=function(e){const t=this;e=e||{};const s={id:t.id};t.map&&t.map.crs!==t.map.options.crs&&(s.crs=t.map.crs);var r=Math.pow(10,(t.map.wrap.isGeo()?TC.Consts.DEGREE_PRECISION:TC.Consts.METER_PRECISION)+1);s.features=t.features.map(function(s){const i={};var o;switch(!0){case TC.feature.Point&&s instanceof TC.feature.Point:i.type=TC.Consts.geom.POINT;o=t.options.styles&&t.options.styles.point;break;case TC.feature.Marker&&s instanceof TC.feature.Marker:i.type=TC.Consts.geom.POINT;o=t.options.styles&&t.options.styles.marker;break;case TC.feature.Polyline&&s instanceof TC.feature.Polyline:i.type=TC.Consts.geom.POLYLINE;o=t.options.styles&&t.options.styles.line;break;case TC.feature.MultiPolyline&&s instanceof TC.feature.MultiPolyline:i.type=TC.Consts.geom.MULTIPOLYLINE;o=t.options.styles&&t.options.styles.line;break;case TC.feature.Polygon&&s instanceof TC.feature.Polygon:i.type=TC.Consts.geom.POLYGON;o=t.options.styles&&t.options.styles.polygon;break;case TC.feature.MultiPolygon&&s instanceof TC.feature.MultiPolygon:i.type=TC.Consts.geom.MULTIPOLYGON;o=t.options.styles&&t.options.styles.polygon;break;case TC.feature.Circle&&s instanceof TC.feature.Circle:i.type=TC.Consts.geom.CIRCLE;o=t.options.styles&&t.options.styles.polygon}i.id=s.id;i.geom=function(e,t){const s=[Number.MAX_VALUE,Number.MAX_VALUE],r=e.map(n),i=function(e,t){$.isArray(e)?e.forEach(i):0===t&&e<s[0]?s[0]=e:1===t&&e<s[1]&&(s[1]=e)};r.forEach(i);const o=function(e){return Math.round(e*t)/t};s[0]=o(s[0]);s[1]=o(s[1]);const a=function(e,t,n){if($.isArray(e))e.forEach(a);else{0===t&&(n[0]=o(e-s[0]));1===t&&(n[1]=o(e-s[1]))}};r.forEach(a);return{origin:s,geom:r}}(s.geometry,r);i.data=s.getData();i.showsPopup=s.showsPopup;if(void 0===e.exportStyles||e.exportStyles){o=$.extend({},o);for(var a in o){var l=o[a];$.isFunction(l)&&(o[a]=l(s))}i.style=$.extend(o,s.getStyle())}return i});return s};e.importState=function(e){const t=this,s=$.Deferred(),n=new Array(e.features.length);e.features.forEach(function(s,r){const i=$.extend(s.style,{data:s.data,id:s.id,showsPopup:s.showsPopup});var o;switch(s.type){case TC.Consts.geom.POLYGON:o=t.addPolygon;break;case TC.Consts.geom.MULTIPOLYGON:o=t.addMultiPolygon;break;case TC.Consts.geom.POLYLINE:o=t.addPolyline;break;case TC.Consts.geom.MULTIPOLYLINE:o=t.addMultiPolyline;break;case TC.Consts.geom.CIRCLE:o=t.addCircle;break;case TC.Consts.geom.POINT:o=s.style&&(s.style.url||s.style.className)?t.addMarker:t.addPoint}if(o){var a=function(e){const t=e.origin,s=function(e,n,r){if($.isArray(e))e.forEach(s);else{0===n&&(r[0]=e+t[0]);1===n&&(r[1]=e+t[1])}};e.geom.forEach(s);return e.geom}(s.geom);e.crs&&t.map.crs!==e.crs&&(a=TC.Util.reproject(a,e.crs,t.map.crs));n[r]=o.call(t,a,i)}});$.when.apply($,n).then(function(){s.resolve()},function(){s.reject()});return s.promise()}}();