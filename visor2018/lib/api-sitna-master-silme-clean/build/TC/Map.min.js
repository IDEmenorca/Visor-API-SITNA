var TC=TC||{};!function(){const e=function(e){return function(t,r,n){return r[e]?n:t}},t=function(e){return function(t,r,n,a){return r.id===e?n:t}},r={layers:[],contains:function(e){return this.layers.some(function(t){return t.id===e})},getIndex:function(e){return this.layers.reduce(t(e),-1)},add:function(e,t,n,a){var s;const o={id:e,deferred:t,isRaster:n,isBase:a};if(n){s=r.getRasterIndex();this.layers.splice(s,0,o)}else{s=this.layers.length;this.layers[s]=o}},remove:function(e){this.layers.splice(this.getIndex(e),1)},getMapLayers:function(){return this.layers.filter(function(e){return"resolved"===e.deferred.state()}).map(function(e){return e.mapLayer})},resolve:function(e,t,r){this.layers[this.getIndex(t.id)].mapLayer=t;e.layers=this.getMapLayers();r?e.baseLayers=e.layers.filter(function(e){return e.isBase}):e.workLayers=e.layers.filter(function(e){return!e.isBase})},getResolvedWorkLayerIndex:function(e,r){return this.layers.filter(function(e){return e.id===r||!e.isBase&&"pending"!==e.deferred.state()}).reduce(t(r),-1)},getResolvedVisibleLayerIndex:function(e,t){var r=this.getResolvedWorkLayerIndex(e,t);e.baseLayer&&(r+=1);return r},getRasterIndex:function(){return this.layers.reduce(e("isRaster"),-1)+1},checkMapLoad:function(e){const t=this;if(e.options.baseLayers.concat(e.options.workLayers).every(function(e){return t.contains(e.id||e)})&&!this.layers.some(function(e){return"pending"===e.deferred.state()})){const t=function(){if(!e.isLoaded){e.isLoaded=!0;e.$events.trigger($.Event(TC.Consts.event.MAPLOAD));e._$div.removeClass(TC.Consts.classes.LOADING)}};if(e.baseLayer)t();else{const r=e.baseLayers.filter(function(e){return!e.mustReproject})[0];e.wrap.setBaseLayer(r.wrap.getLayer());e.baseLayer=r;t()}}}},n=function(e){return(this instanceof TC.Map?this.options.availableBaseLayers:TC.Cfg.availableBaseLayers).filter(function(t){return t.id===e})[0]};TC.Map=TC.Map||function(e,t){var r=this;r.$events=$(r);r.isReady=!1;r.isLoaded=!1;r.controls=[];r.activeControl=null;r.layers=[];r.baseLayers=[];r.workLayers=[];r.baseLayer=null;r.vectors=null;var s=0;r.div=TC.Util.getDiv(e);r._$div=$(r.div);r._$div.addClass(TC.Consts.classes.LOADING);r._$div.data("map",r);r._$div.addClass(TC.Consts.classes.MAP);r._markerDeferreds=[];if(!TC.ready){TC.Cfg=$.extend({},TC.Defaults,TC.Cfg);TC.ready=!0}if(t&&t.controls&&t.controls.search&&t.controls.search.allowedSearchTypes)for(var l in TC.Cfg.controls.search.allowedSearchTypes)t.controls.search.allowedSearchTypes.hasOwnProperty(l)||(t.controls.search.allowedSearchTypes[l]=!1);t=t||{};o.call(r,t);var c=function(){TC.loadJS(r.options.stateful&&!window.jsonpack,[TC.apiLocation+TC.Consts.url.JSONPACK],function(){if(r.options.stateful){u();r.state=r.checkLocation()}r.options.layout&&r.$events.trigger($.Event(TC.Consts.event.LAYOUTLOAD,{map:r}));t&&void 0!==t.workLayers&&(r.options.workLayers=t.workLayers);t&&void 0!==t.baseLayers&&(r.options.baseLayers=t.baseLayers);if(r.options.zoomToFeatures){r.on(TC.Consts.event.FEATURESADD,function e(t){clearTimeout(r._zoomToFeaturesTimeout);r._zoomToFeaturesTimeout=setTimeout(function(){r.zoomToFeatures(t.layer.features,{animate:!1});r.off(TC.Consts.event.FEATURESADD,e)},100)})}else{r.on(TC.Consts.event.LAYERADD,function e(t){if(t.layer.isBase&&t.layer===r.baseLayer){void 0!==r.state&&(r.state.crs?r.loaded(function(){r.setProjection({crs:r.state.crs,extent:r.state.ext})}):r.setExtent(r.state.ext,{animate:!1}));r.off(TC.Consts.event.LAYERADD,e)}})}r.state&&r.state.vw3&&r.loaded(function(){r.getControlsByClass(TC.control.ThreeD)[0].setMapState(r.state.vw3)});r.crs=r.options.crs;r.initialExtent=r.options.initialExtent;r.maxExtent=r.options.maxExtent;r.wrap=new TC.wrap.Map(r);TC.loadJS(!(TC.isLegacy?window[TC.Consts.PROJ4JSOBJ_LEGACY]:window[TC.Consts.PROJ4JSOBJ]),[TC.url.proj4js],function(){TC.loadJSInOrder(!(TC.isLegacy?window[TC.Consts.OLNS_LEGACY]:window[TC.Consts.OLNS]),[TC.url.ol,TC.url.olConnector],function(){TC.loadProjDef({crs:r.options.crs,callback:function(){r.wrap.setMap();for(var e in r.options.controls){const t=r.options.controls[e];t&&r.addControl(e,"boolean"==typeof t?{}:t)}r.on(TC.Consts.event.BEFORELAYERUPDATE,T);r.on(TC.Consts.event.LAYERUPDATE,v);var t,a;for(t=0;t<r.options.baseLayers.length;t++){"string"==typeof(a=r.options.baseLayers[t])&&(a=n.call(r,a));r.addLayer($.extend({},a,{isBase:!0,map:r}))}var s=function(e){e.isRaster()&&!e.names&&e.setVisibility(!1)};r.options.workLayers.map(function(e){return $.extend({},e,{map:r})}).filter(function(e){return!r.state||!r.state.layers||!r.state.layers.some(function(t){const r=t.u===e.url&&e.layerNames.indexOf(t.n)>=0;r&&(t.id=e.id);return r})}).forEach(function(e){r.addLayer(e).then(s)});r.state&&r.state.layers&&r.state.layers.forEach(function(e){var t=e.o,n=e.v;r.addLayer({id:e.id||TC.getUID(),url:TC.Util.isOnCapabilities(e.u,e.u.indexOf(window.location.protocol)<0)||e.u,hideTitle:e.h,layerNames:e.n?e.n.split(","):"",renderOptions:{opacity:e.o,hide:!e.v}}).then(function(e){e.wrap.$events.on(TC.Consts.event.TILELOADERROR,function(e){var t=this.parent;401!==e.error.code&&403!==e.error.code||t.map.toast(e.error.text,{type:TC.Consts.msgType.ERROR});t.map.removeLayer(t)});var r=e.wrap.getRootLayerNode();e.title=r.Title||r.title;e.setOpacity(t);e.setVisibility(n)})});r.isReady=!0;r.$events.trigger($.Event(TC.Consts.event.MAPREADY));p(r._$div)}})})});r.on(TC.Consts.event.FEATURECLICK,function(e){r.activeControl&&r.activeControl.isExclusive()||e.feature.showPopup()});r.on(TC.Consts.event.NOFEATURECLICK,function(e){e.layer._noFeatureClicked=!0;for(var t=!0,n=0,a=r.workLayers.length;n<a;n++)if(!r.workLayers[n]._noFeatureClicked){t=!1;break}if(t){r.workLayers.forEach(function(e){delete e._noFeatureClicked});r.getControlsByClass(TC.control.Popup).forEach(function(e){e.hide()})}})})},u=function(){var e=[TC.Consts.event.LAYERADD,TC.Consts.event.LAYERORDER,TC.Consts.event.LAYERREMOVE,TC.Consts.event.LAYERVISIBILITY,TC.Consts.event.ZOOM,TC.Consts.event.BASELAYERCHANGE].join(" ");r.on(TC.Consts.event.MAPLOAD,function(){r.loaded(function(){r.replaceCurrent=!0;C();r.on(e,$.proxy(C,r));var t;r.on(TC.Consts.event.LAYEROPACITY,function(e){clearTimeout(t);t=setTimeout(function(){C(e)},500)});window.addEventListener("popstate",function(t){var n;n=r.loadingCtrl&&r.loadingCtrl.addWait();setTimeout(function(){if(t&&null!=t.state){r.off(e,$.proxy(C,r));$.when(h(t.state)).then(function(){setTimeout(function(){r.on(e,$.proxy(C,r))},200);r.loadingCtrl&&r.loadingCtrl.removeWait(n)})}},4)})})})},y=null,f=null,C=function(e){var t=d();if(r.replaceCurrent){window.history.replaceState(t,null,null);delete r.replaceCurrent}else{r.lastEventType=e.type;var n=function(){f=y;(y=TC.Util.utf8ToBase64(t))!==f&&window.history.pushState(t,null,window.location.href.split("#").shift()+"#"+y)};if(e)switch(!0){case e.type==TC.Consts.event.BASELAYERCHANGE.replace(".tc",""):case e.type==TC.Consts.event.LAYERORDER.replace(".tc",""):case e.type==TC.Consts.event.ZOOM.replace(".tc",""):n();break;case e.type.toLowerCase().indexOf("LAYER".toLowerCase())>-1:e.layer.type==TC.Consts.layerType.WMS&&n()}}},d=function(e){var t={};r.crs!==r.options.crs&&(t.crs=r.crs);for(var n,a,s=r.getExtent(),o=0;o<s.length;o++)Math.abs(s[o])>180&&(s[o]=Math.floor(1e3*s[o])/1e3);t.ext=s;t.base=r.getBaseLayer().id;t.layers=[];for(o=0;o<r.workLayers.length;o++)if("WMS"==(n=r.workLayers[o]).type&&!n.options.stateless&&n.layerNames&&n.layerNames.length){a={u:TC.Util.isOnCapabilities(n.url),n:$.isArray(n.names)?n.names.join(","):n.names,o:n.getOpacity(),v:n.getVisibility(),h:n.options.hideTitle};t.layers.push(a)}var i=r.getControlsByClass(TC.control.ThreeD);i.length>0&&i[0].mapIs3D&&i[0].map3D.cameraControls&&(t.vw3=i[0].map3D.cameraControls.getCameraState());window.jsonpack||TC.syncLoadJS(TC.apiLocation+TC.Consts.url.JSONPACK);e&&$.extend(t,e);return jsonpack.pack(t)},h=function(e){var t=new $.Deferred,n=[];r.loadingctrl||(r.loadingCtrl=r.getControlsByClass("TC.control.LoadingIndicator")[0]);r.hasWait||(r.hasWait=r.loadingCtrl&&r.loadingCtrl.addWait());var a;if("string"==typeof e)try{a=jsonpack.unpack(e)}catch(t){try{a=JSON.parse(e)}catch(e){TC.error(TC.Util.getLocaleString(r.options.locale,"mapStateNotValid"))}}else a=e;if(a){if(a.crs&&a.crs!==r.crs||void 0===a.crs&&r.crs!==r.options.crs)n.push(r.setProjection({crs:a.crs||r.options.crs,oldCrs:r.crs,extent:a.ext,baseLayer:r.getLayer(a.base)}));else{if(a.base!=r.getBaseLayer().id){r.getLayer(a.base)&&r.setBaseLayer(a.base);const e=r.baseLayers.filter(function(e){return e.options.fallbackLayer===a.base})[0];if(e){const t=r.addLayer(e.getFallbackLayer());n.push(t);t.then(function(e){r.setBaseLayer(e)})}}a.ext&&n.push(r.setExtent(a.ext,{animate:!1}))}!function(){var e=[];r.workLayers.forEach(function(t){t instanceof TC.layer.Vector||e.push(t)});for(var t=0;t<e.length;t++)r.removeLayer(e[t])}();a.layers=a.layers||a.capas||[];if(a.layers.length>0)for(var s=0;s<a.layers.length;s++){var o=a.layers[s],i=o.o,l=o.v,c=!1;for(j=0;j<r.options.workLayers.length;j++){var u=$.extend({},r.options.workLayers[j],{map:r});if(o.u===u.url&&u.layerNames.indexOf(o.n)>=0){c=!0;u.renderOptions={opacity:o.o,hide:!o.v};n.push(r.addLayer(u).then(function(e){e.setVisibility(l);e.setOpacity(i,!0)}))}}c||n.push(r.addLayer({id:TC.getUID(),url:TC.Util.isOnCapabilities(o.u,o.u.indexOf(window.location.protocol)<0)||o.u,hideTitle:o.h,layerNames:o.n?o.n.split(","):"",renderOptions:{opacity:o.o,hide:!o.v}}).then(function(e){var t=e.wrap.getRootLayerNode();e.title=t.Title||t.title;e.setOpacity(i,!0);e.setVisibility(l)}))}$.when.apply($,n).always(function(){!function(){r.loadingCtrl&&r.loadingCtrl.removeWait(r.hasWait);delete r.hasWait;t.resolve()}()})}return t};i.getMapState=function(e){var t=d(e);return TC.Util.utf8ToBase64(t)};i.getPreviousMapState=function(){return f};i.checkLocation=function(){var e=window.location.hash;if(e&&e.length>1){e=e.substr(1);var t;try{t=jsonpack.unpack(TC.Util.base64ToUtf8(e))}catch(n){try{t=JSON.parse(TC.Util.base64ToUtf8(e))}catch(e){TC.error(TC.Util.getLocaleString(r.options.locale,"mapStateNotValid"),TC.Consts.msgErrorMode.TOAST);return}}TC.Util.detectIE()&&2047===window.location.href.length&&TC.error(TC.Util.getLocaleString(r.options.locale,"mapStateNotValidForIE"),TC.Consts.msgErrorMode.TOAST);if(t){var n=!1;if(!t.hasOwnProperty("ext")){n=!0;t.ext=r.options.initialExtent}if(!t.hasOwnProperty("base")){n=!0;t.base=r.options.defaultBaseLayer}if(t.hasOwnProperty("layers"))for(var a=t.layers.length-1;a>=0;a--)if(t.layers[a]&&t.layers[a].hasOwnProperty("u")&&t.layers[a].hasOwnProperty("n")){if(!t.layers[a].hasOwnProperty("o")||!t.layers[a].hasOwnProperty("v")||!t.layers[a].hasOwnProperty("h")){n=!0;jQuery.extend(t.layers[a],{o:t.layers[a].o||1,v:t.layers[a].v||!0,h:t.layers[a].h||!1})}}else{n=!0;t.layers.length=t.layers.length-1}else{n=!0;t.layers=[]}t.hasOwnProperty("vw3")&&(t.vw3?(!t.vw3.cp||t.vw3.cp&&3!=t.vw3.cp.length||!t.vw3.chpr||t.vw3.chpr&&3!=t.vw3.chpr.length||!t.vw3.bcpd)&&(n=!0):n=!0);n&&TC.error(TC.Util.getLocaleString(r.options.locale,"mapStateNotValid"),TC.Consts.msgErrorMode.TOAST);return t}TC.error(TC.Util.getLocaleString(r.options.locale,"mapStateNotValid"),TC.Consts.msgErrorMode.TOAST)}};var T=function(e){if(s<=0){s=0;r.$events.trigger($.Event(TC.Consts.event.BEFOREUPDATE))}s+=1},v=function(e){if((s-=1)<=0){s=0;r.$events.trigger($.Event(TC.Consts.event.UPDATE))}},g=function(e){var t=$.Deferred();if("string"==typeof e){var r=e,n=/^(https?:)?\/\//i.test(r),a=function(t,a){var i=$.Deferred(),l=[r+"/"+a,o+r+"/"+a,o+"layout/responsive/"+a];n&&l.unshift(r+"/"+a);!function r(n){(function(e,t){var r=$.Deferred();$.ajax({type:"HEAD",url:e,complete:function(n,a){r.resolve({resource:t,found:404!==n.status,url:e})}});return r.promise()})(l[n],t).done(function(t){t.found?i.resolve(s(e,t)):r(++n)})}(0);return i.promise()},s=function(e,t){if(!(t.resource in e)){$.extend(!0,{},e);var n=t.found?t.url:o+r+"/"+i[t.resource];e[t.resource]=n}return e},o=TC.apiLocation+"TC/",i=(e={},{script:"script.js",style:"style.css",markup:"markup.html",config:"config.json",i18n:"resources"}),l=Object.keys(i).length;for(var c in i)a(c,i[c]).done(function(e){Object.keys(e).length===l&&t.resolve(e)})}else t.resolve(e);return t.promise()};TC.i18n=TC.i18n||{};TC.i18n.loadResources=TC.i18n.loadResources||function(e,t,r){var n;e?n=$.ajax({url:t+r+".json",type:"GET",dataType:"json",success:function(e){TC.i18n[r]=TC.i18n[r]||{};$.extend(TC.i18n[r],e);"undefined"!=typeof dust&&TC.loadJS(!window.dust.i18n,TC.apiLocation+TC.Consts.url.TEMPLATING_I18N,function(){dust.i18n.add(r,TC.i18n[r])})}}):dust.i18n.add(r,TC.i18n[r]);return n};var L=[],w=r.options.locale,m=$.Deferred();L.push(m);TC.loadJSInOrder(!window.dust||!window.dust.i18n,TC.url.templating,function(){if(w){dust.i18n.setLanguages([w]);L.push(TC.i18n.loadResources(!TC.i18n[w],TC.apiLocation+"TC/resources/",w))}m.resolve()});$.when.apply(this,L).always(function(){const e=TC.Util.getParameterByName(TC.Cfg.layoutURLParamName)||r.options.layout;e?g(e).done(function(e){r.$events.trigger($.Event(TC.Consts.event.BEFORELAYOUTLOAD,{map:r}));var n;"string"==typeof e?n={href:$.trim(e)}:(e.hasOwnProperty("config")||e.hasOwnProperty("markup")||e.hasOwnProperty("style")||e.hasOwnProperty("ie8Style")||e.hasOwnProperty("script")||e.hasOwnProperty("href")||e.hasOwnProperty("i18n"))&&(n=$.extend({},e));n.href&&(n.href+=n.href.match(/\/$/)?"":"/");n.config=n.config||n.href+"config.json";n.markup=n.markup||n.href+"markup.html";n.style=n.style||n.href+"style.css";n.ie8Style=n.ie8Style||n.href+"ie8.css";n.script=n.script||n.href+"script.js";n.i18n=n.i18n||n.href+"resources";n.i18n&&(n.i18n+=n.i18n.match(/\/$/)?"":"/");r.layout=n;var a=[],s=$.Deferred();a.push(s);n.config?a.push($.ajax({url:n.config,type:"GET",dataType:"json",success:function(e){s.resolve(e.i18n);o.call(r,e,t)},error:function(e,t,r){TC.error(t+": "+r);s.resolve(!1)}})):s.resolve(!1);if(n.style){r._$div.addClass("tc-lo");TC.loadCSS(n.style)}!Modernizr.canvas&&n.ie8Style&&TC.loadCSS(n.ie8Style);if(n.markup){var i;if(w){i=$.Deferred();a.push(i)}a.push($.ajax({url:n.markup,type:"GET",dataType:"html",success:function(e){s.then(function(t){if(t&&w)TC.i18n.loadResources(!0,n.i18n,w).always(function(){e=e.replace(/(?:\{\{([^\}\{]+)\}\}|\{@i18n \$key="([^\}\{]+)"\/\})/g,function(e,t,r){return TC.Util.getLocaleString(w,t||r)});r._$div.append(e);i.resolve()});else{r._$div.append(e);w&&i.resolve()}})},error:function(){i.reject()}}))}$.when.apply(this,a).always(function(){TC.loadJS(n.script,n.script,function(){p(r._$div);c()})})}):c()});r.$events.on(TC.Consts.event.UPDATEPARAMS,function(e){a(e.layer)});r.$events.on(TC.Consts.event.ZOOM,function(){for(var e=0;e<r.workLayers.length;e++)a(r.workLayers[e])});var b=TC.error;TC.error=function(e,t,n){TC.isDebug&&console.trace&&console.trace();if(t){var a=function(e,t,n){switch(t){case TC.Consts.msgErrorMode.TOAST:if(!r.toast){console.warn("No existe el objeto Toast");return}r.toast(e,{type:TC.Consts.msgType.ERROR,duration:2*TC.Cfg.toastDuration});break;case TC.Consts.msgErrorMode.EMAIL:TC.Cfg.loggingErrorsEnabled&&JL("onerrorLogger").fatalException(n?{msg:n,errorMsg:e}:e,null);break;case TC.Consts.msgErrorMode.CONSOLE:default:console.error(e)}};if($.isArray(t))for(var s=0;s<t.length;s++)a(e,t[s],n);else a(e,t,n)}else{b(e);r.toast(e,{type:TC.Consts.msgType.ERROR,duration:2*TC.Cfg.toastDuration})}}};var a=function(e){e.type===TC.Consts.layerType.WMS&&(e.tree=null)},s=function(e,t){var r=$.map(e,function(e){var r={};e&&(r[t]=e[t]);return r});"availableBaseLayers"===t&&console.log("layerOptions",r);var a={};a[t]=TC.Cfg[t];r.unshift(a);if("baseLayers"===t&&r[1].baseLayers){a=r[1];for(var s=0;s<a.baseLayers.length;s++)"object"==typeof a.baseLayers[s]&&$.extend(a.baseLayers[s],n.call(this,a.baseLayers[s].id))}else{r.unshift(!0);a=$.extend.apply(this,r);"availableBaseLayers"===t&&console.log("layerOption",a)}return a[t]},o=function(){const e=this.options=$.extend.apply(this,$.merge([!0,{},TC.Cfg],arguments));e.availableBaseLayers=TC.Cfg.availableBaseLayers.concat.apply(TC.Cfg.availableBaseLayers,Array.prototype.map.call(arguments,function(e){return e.availableBaseLayers||[]}));e.baseLayers=s.call(this,arguments,"baseLayers");e.workLayers=s.call(this,arguments,"workLayers");return e},i=TC.Map.prototype,l=function(e,t){var r,n='Layer "'+t.title+'" ("'+t.names+'"): ';r=t.isValidFromNames()?"layerSrsNotCompatible":"layerNameNotValid";n+=TC.Util.getLocaleString(e.options.locale,r);TC.error(n);e.$events.trigger($.Event(TC.Consts.event.LAYERERROR,{layer:t,reason:r}))};i.addLayer=function(e,t){const a=this,s=new $.Deferred;s.then(function(e){r.resolve(a,e,e.isBase);a.$events.trigger($.Event(TC.Consts.event.LAYERADD,{layer:e}));r.checkMapLoad(a);$.isFunction(t)&&t(e)},function(e){r.checkMapLoad(a)});const o=C(e);"object"!=typeof e||e.id||(e.id=TC.getUID());r.add(e.id||e,s,o,e.isBase);const i=function(e){if(e){var t={projection:a.wrap.map.getView().getProjection(),extent:a.initialExtent},r=a.baseLayer.getResolutions();if(r&&r.length)t.resolutions=r;else{t.minZoom=a.wrap.map.getView().getMinZoom();t.maxZoom=a.wrap.map.getView().getMaxZoom();var n=a.baseLayer.wrap.layer.getMinResolution();0!==n&&(t.minResolution=n);var s=a.baseLayer.wrap.layer.getMaxResolution();s!==Number.POSITIVE_INFINITY&&(t.maxResolution=s)}a.wrap.map.setView(new ol.View(t));a.wrap.map.getView().fit(a.initialExtent)}};var c,u,y;if(o){u=!TC.layer||!TC.layer.Raster;y=TC.apiLocation+"TC/layer/Raster"}else{u=!TC.layer||!TC.layer.Vector;y=TC.apiLocation+"TC/layer/Vector"}TC.loadJS(u,[y],function(){if("string"==typeof e)c=new TC.layer.Raster($.extend({},n.call(a,e),{map:a}));else if(e instanceof TC.Layer)(c=e).map=a;else{e.map=a;c=e.type===TC.Consts.layerType.VECTOR||e.type===TC.Consts.layerType.KML||e.type===TC.Consts.layerType.WFS?new TC.layer.Vector(e):new TC.layer.Raster(e)}a.$events.trigger($.Event(TC.Consts.event.BEFORELAYERADD,{layer:c}));$.when(a.wrap.getMap(),c.wrap.getLayer()).then(function(){var t;C(c)&&(t=a.wrap.indexOfFirstVector());-1===t&&(t=a.wrap.getLayerCount());const n=a.state&&a.state.crs||a.crs,o=c.isCompatible(n);if(c.isBase){if(!o)if(!c.type===TC.Consts.layerType.WMTS)c.mustReproject=!0;else{const e=c.wrap.getCompatibleMatrixSets(n)[0];e?c.wrap.setMatrixSet(e):c.mustReproject=!0}a.state?c.isDefault=a.state.base===c.id||a.state.base===c.options.fallbackLayer:"string"==typeof a.options.defaultBaseLayer?a.options.defaultBaseLayer===c.id&&(c.isDefault=!0):"number"==typeof a.options.defaultBaseLayer&&a.options.defaultBaseLayer===a.baseLayers.length&&(c.isDefault=!0);if(c.isDefault)if(c.mustReproject)if(c.options.fallbackLayer&&c.getFallbackLayer){var u=null===a.baseLayer;a.baseLayer=c.getFallbackLayer();a.addLayer(a.baseLayer).then(function(e){a.wrap.setBaseLayer(e.wrap.getLayer());i(u);s.resolve(c)})}else{l(a,c);s.reject(e)}else{u=null===a.baseLayer;a.wrap.setBaseLayer(c.wrap.getLayer());a.baseLayer=c;i(u);s.resolve(c)}else s.resolve(c)}else if(o){a.wrap.insertLayer(c.wrap.getLayer(),r.getResolvedVisibleLayerIndex(a,c.id));s.resolve(c)}else{l(a,c);s.reject(e)}})});return s.promise()};i.removeLayer=function(e){var t=this,n=new $.Deferred;$.when(e.wrap.getLayer()).then(function(a){for(var s=0;s<t.layers.length;s++)t.layers[s]===e&&t.layers.splice(s,1);if(e.isBase){for(s=0;s<t.baseLayers.length;s++)if(t.baseLayers[s]===e){t.baseLayers.splice(s,1);t.baseLayer===e&&t.setBaseLayer(t.baseLayers[0]);break}}else{for(s=0;s<t.workLayers.length;s++)if(t.workLayers[s]===e){t.workLayers.splice(s,1);break}e===t.vectors&&(t.vectors=null)}t.wrap.removeLayer(a);r.remove(e.id);t.$events.trigger($.Event(TC.Consts.event.LAYERREMOVE,{layer:e}));r.checkMapLoad(t);n.resolve(e)});return n};i.insertLayer=function(e,t,r){for(var n=this,a=-1,s=0;s<n.layers.length;s++)if(e===n.layers[s]){a=s;break}var o=[];o.push(e.wrap.getLayer());var i=n.layers[t];i&&o.push(i.wrap.getLayer());$.when.apply(this,o).then(function(s,o){var i=-1;if((i=o?n.wrap.getLayerIndex(o):n.wrap.getLayerCount())>=0){e.map=n;n.wrap.insertLayer(s,i);a>-1&&n.layers.splice(a,1);n.layers.splice(t,0,e);n.workLayers=n.layers.filter(function(e){return!e.isBase});n.$events.trigger($.Event(TC.Consts.event.LAYERORDER,{layer:e,oldIndex:a,newIndex:t}))}$.isFunction(r)&&r()})};i.setLayerIndex=function(e,t){this.wrap.setLayerIndex(e.wrap.getLayer(),t)};i.putLayerOnTop=function(e){var t=this.wrap.getLayerCount();this.setLayerIndex(e,t-1)};i.setBaseLayer=function(e,t){var r=this,a=null,s=!1;if("string"==typeof e){var o;for(o=0;o<r.layers.length;o++)if(r.layers[o].id===e){e=r.layers[o];s=!0;break}if(!s&&(e=n.call(r,e))){e=r.addLayer($.extend(!0,{},e,{isDefault:!0,map:r}));s=!0}}else{if($.inArray(e,r.layers)<0){e.isDefault=!0;e.map=r;r.addLayer(e)}s=!0}if(s)if(e.mustReproject)TC.error("Base layer must be reprojected");else{r.$events.trigger($.Event(TC.Consts.event.BEFOREBASELAYERCHANGE,{oldLayer:r.getBaseLayer(),newLayer:e}));a=e;$.when(r.wrap.getMap(),e).then(function(e,n){$.when(n.wrap.getLayer()).then(function(e){r.wrap.setBaseLayer(e).then(function(){r.baseLayer=n;r.$events.trigger($.Event(TC.Consts.event.BASELAYERCHANGE,{layer:n}));$.isFunction(t)&&t()})})})}else TC.error("Base layer is not available");return a};i.on=function(e,t){this.$events.on(e,t);return this};i.one=function(e,t){this.$events.one(e,t);return this};i.off=function(e,t){this.$events.off(e,t);return this};i.ready=function(e){$.isFunction(e)&&(this.isReady?e():this.one(TC.Consts.event.MAPREADY,e))};i.loaded=function(e){$.isFunction(e)&&(this.isLoaded?e():this.one(TC.Consts.event.MAPLOAD,e))};i.getLayerTree=function(){var e={baseLayers:[],workLayers:[]};this.baseLayer&&(e.baseLayers[0]=this.baseLayer.getTree());for(var t=0;t<this.workLayers.length;t++){var r=this.workLayers[t].getTree();r&&e.workLayers.unshift(r)}return e};i.addControl=function(e,t){var r=this,n=new $.Deferred,a=function(e){r.controls.push(e);e.register(r);$dv=$(e.div);0===$dv.parent().length&&$dv.appendTo(r._$div);r.$events.trigger($.Event(TC.Consts.event.CONTROLADD,{control:e}));n.resolve(e)};if("string"==typeof e){e=e.substr(0,1).toUpperCase()+e.substr(1);TC.loadJS(!TC.Control||!TC.control[e],[TC.apiLocation+"TC/control/"+e],function(){a(new TC.control[e](null,t))})}else a(e);return n.promise()};i.getControlsByClass=function(e){var t=[],r=e;if("string"==typeof e){r=window;for(var n=e.split("."),a=0;a<n.length&&(r=r[n[a]]);a++);}if($.isFunction(r))for(a=0;a<this.controls.length;a++){var s=this.controls[a];s instanceof r&&t.push(s)}return t};i.getControlById=function(e){const t=this;for(var r=0,n=t.controls.length;r<n;r++){const n=t.controls[r];if(n.id===e)return n}return null};i.getDefaultControl=function(){var e=this.getControlsByClass("TC.control.FeatureInfo");return e&&e.length?e[0]:null};i.getLoadingIndicator=function(){var e=null,t=this.getControlsByClass("TC.control.LoadingIndicator");t.length&&(e=t[0]);return e};i.setExtent=function(e,t){return this.wrap.setExtent(e,t)};i.getExtent=function(){return this.wrap.getExtent()};i.setCenter=function(e,t){return this.wrap.setCenter(e,t)};i.getCenter=function(){return this.wrap.getCenter()};i.setRotation=function(e){this.wrap.setRotation(e)};i.getRotation=function(){return this.wrap.getRotation()};i.getViewHTML=function(){return this.wrap.getViewport()};i.getCompatibleCRS=function(e){const t=((e=e||{}).layers||this.workLayers.concat(this.baseLayer)).filter(function(e){return e.isRaster()}).map(function(t){return t.getCompatibleCRS({normalized:!0,includeFallback:e.includeFallbacks})}),r=t.slice(1);return t[0].filter(function(e){return r.every(function(t){return t.indexOf(e)>=0})})};i.loadProjections=function(e){e=e||{};const t=$.Deferred(),r=e.crsList||[];$.when.apply(this,r.map(function(e){return TC.getProjectionData({crs:TC.Util.getCRSCode(e)})})).then(function(){var r=Array.prototype.slice.call(arguments).filter(function(e){return"ok"===e.status&&e.number_result>0}).map(function(e){const t=e.results[0],r="EPSG:"+t.code;TC.loadProjDef({crs:r,def:t.def,name:t.name});return{code:r,name:t.name,proj4:t.proj4,unit:t.unit}});e.orderBy&&(r=r.sort(TC.Util.getSorterByProperty(e.orderBy)));t.resolve(r)},function(e){t.reject(e)});return t.promise()};i.setProjection=function(t){const r=this,n=$.Deferred();var a;if((t=t||{}).crs){t.baseLayer?a=t.baseLayer:t.allowFallbackLayer&&(r.baseLayer.isCompatible(t.crs)||0!==r.baseLayer.wrap.getCompatibleMatrixSets(t.crs).length?r.baseLayer.firstOption&&(r.baseLayer.firstOption.isCompatible(t.crs)||r.baseLayer.firstOption.wrap.getCompatibleMatrixSets(t.crs).length>0)&&(a=r.baseLayer.firstOption):r.baseLayer.options.fallbackLayer&&(a=r.baseLayer.getFallbackLayer()));a||(a=r.baseLayer);if(r.baseLayers.indexOf(a)<0){r.baseLayers.push(a);const t=r.layers.reduce(e("isBase"),-1)+1;r.layers.splice(t,0,a)}TC.loadProjDef({crs:t.crs,callback:function(){a.getCapabilitiesPromise().then(function(){const e=$.extend({},t,{oldCrs:r.crs}),s=function(t){t.setProjection(e)};if(a.isCompatible(t.crs)||a.wrap.getCompatibleMatrixSets(t.crs).length>0){a.setProjection(e);r.wrap.setProjection($.extend({},t,{baseLayer:a}));r.crs=t.crs;r.baseLayers.filter(function(e){return e!==a}).forEach(s);r.workLayers.forEach(s);const o=function(){r.$events.trigger($.Event(TC.Consts.event.PROJECTIONCHANGE,{crs:t.crs}));n.resolve()};a&&a!==r.baseLayer?r.setBaseLayer(a,o):o()}else n.reject()})}})}return n.promise()};i.getMetersPerUnit=function(){return this.wrap.getMetersPerUnit()};i.getCoordinateFromPixel=function(e){return this.wrap.getCoordinateFromPixel(e)};i.getPixelFromCoordinate=function(e){return this.wrap.getPixelFromCoordinate(e)};i.zoomToFeatures=function(e,t){if(e.length>0){var r=[1/0,1/0,-1/0,-1/0],n=t||{},a=n.pointBoundsRadius||this.options.pointBoundsRadius;a/=this.getMetersPerUnit();var s=n.extentMargin;"number"!=typeof s&&(s=this.options.extentMargin);for(var o=0;o<e.length;o++){var i=e[o].getBounds();if(i){r[0]=Math.min(r[0],i[0]);r[1]=Math.min(r[1],i[1]);r[2]=Math.max(r[2],i[2]);r[3]=Math.max(r[3],i[3])}}if(r[2]-r[0]==0){r[0]=r[0]-a;r[2]=r[2]+a}if(r[3]-r[1]==0){r[1]=r[1]-a;r[3]=r[3]+a}if(this.options.extentMargin){var l=(r[2]-r[0])*s/2,c=(r[3]-r[1])*s/2;r[0]=r[0]-l;r[1]=r[1]-c;r[2]=r[2]+l;r[3]=r[3]+c}if(this.options.maxExtent){r[0]=Math.max(r[0],this.options.maxExtent[0]);r[1]=Math.max(r[1],this.options.maxExtent[1]);r[2]=Math.min(r[2],this.options.maxExtent[2]);r[3]=Math.min(r[3],this.options.maxExtent[3])}this.wrap.setExtent(r,n);this.$events.trigger($.Event(TC.Consts.event.ZOOMTO,{extent:r}))}};i.zoomToMarkers=function(e){var t=this;$.when.apply(this,t._markerDeferreds).then(function(){for(var r=[],n=0;n<t.workLayers.length;n++){var a=t.workLayers[n];if(a.type===TC.Consts.layerType.VECTOR)for(var s=0;s<a.features.length;s++){var o=a.features[s];o instanceof TC.feature.Marker&&(r[r.length]=o)}}for(n=0;n<arguments.length;n++)r[r.length]=arguments[n];t.zoomToFeatures(r,e);t._markerDeferreds=[]})};i.getLayer=function(e){var t=null;if("string"==typeof e){for(var r=0;r<this.layers.length;r++)if(this.layers[r].id===e){t=this.layers[r];break}}else TC.Layer&&e instanceof TC.Layer&&(t=e);return t};var c=function(e){var t;if(e.vectors)t=e.vectors;else{t=e.addLayer({id:TC.getUID(),title:TC.i18n[e.options.locale].vectors,type:TC.Consts.layerType.VECTOR});e.vectors=t;t.then(function(t){e.vectors=t})}return t};i.addPoint=function(e,t){if(t&&t.layer){var r=this.getLayer(t.layer);r&&r.addPoint(e,t)}else $.when(c(this)).then(function(r){r.addPoint(e,t)})};i.addMarker=function(e,t){if(t&&t.layer){var r=this.getLayer(t.layer);r&&this._markerDeferreds.push(r.addMarker(e,t))}else{var n=new $.Deferred;this._markerDeferreds.push(n);$.when(c(this)).then(function(r){$.when(r.addMarker(e,t)).then(function(e){n.resolve(e)})})}};i.addPolyline=function(e,t){if(t&&t.layer){this.getLayer(t.layer)&&t.layer.addPolyline(e,t)}else $.when(c(this)).then(function(r){r.addPolyline(e,t)})};i.addPolygon=function(e,t){if(t&&t.layer){this.getLayer(t.layer)&&t.layer.addPolygon(e,t)}else $.when(c(this)).then(function(r){r.addPolygon(e,t)})};i.getBaseLayer=function(){return this.baseLayer||this.baseLayers[0]};i.getResolutions=function(){return this.wrap.getResolutions()};i.getResolution=function(){return this.wrap.getResolution()};i.setResolution=function(e){this.wrap.setResolution(e)};i.exportFeatures=function(e,t){var r=t||{},n=this.getLoadingIndicator(),a=n&&n.addWait(),s=this.wrap.exportFeatures(e,r),o=TC.Consts.mimeType[r.format],i=r.format||"";TC.Util.downloadFile((r.fileName||TC.getUID())+"."+i.toLowerCase(),o,s);n&&n.removeWait(a)};var u={},y=function(){var e=$(this),t=e.parent(".tc-toast-container"),r=e.html();e.addClass(TC.Consts.classes.HIDDEN);void 0!==u[r]&&(u[r]=void 0);setTimeout(function(){e.remove();t.find(".tc-toast").length||t.remove()},1e3)};i.toast=function(e,t){var r=t||{},n=r.duration||TC.Cfg.toastDuration,a=u[e];if(a){clearTimeout(a.timeout);a.$toast.remove()}var s=this._$div.find(".tc-toast-container");s.length||(s=$("<div>").addClass("tc-toast-container").appendTo(this._$div));a=u[e]={$toast:$("<div>").addClass("tc-toast").html(e).appendTo(s).on(TC.Consts.event.CLICK,y)};var o="";switch(r.type){case TC.Consts.msgType.INFO:o=TC.Consts.classes.INFO;break;case TC.Consts.msgType.WARNING:o=TC.Consts.classes.WARNING;break;case TC.Consts.msgType.ERROR:o=TC.Consts.classes.ERROR}a.$toast.addClass(o);a.timeout=setTimeout(function(){y.call(a.$toast)},n)};var f=!1,p=function(e){if(/iPad/i.test(navigator.userAgent)){var t=window.innerHeight;e.height()===t+(Modernizr.mq("only screen and (orientation : landscape)")?20:0)&&(f=!0)}var r=function(){e.toggleClass(TC.Consts.classes.IPAD_IOS7_FIX,Modernizr.mq("only screen and (orientation : landscape)"))};if(f){r();$(window).on("resize",r)}else $(window).off("resize",r)},C=function(e){return"string"==typeof e||e.type!==TC.Consts.layerType.VECTOR&&e.type!==TC.Consts.layerType.KML&&e.type!==TC.Consts.layerType.WFS};i.exportImage=function(){var e=null,t="El mapa actual no es compatible con la exportaci\xf3n de im\xe1genes",r=this.wrap.getViewport({synchronous:!0}).getElementsByTagName("canvas")[0];if(r&&this.options.crossOrigin)try{e=r.toDataURL()}catch(e){TC.error(t+": "+e.message)}else TC.error(t);return e}}();