!function(){Math.hypot=Math.hypot||function(){for(var e=0,t=arguments.length,r=0;t>r;r++){if(arguments[r]===1/0||arguments[r]===-(1/0))return 1/0;e+=arguments[r]*arguments[r]}return Math.sqrt(e)}}(),function(){for(var e=0,t=["ms","moz","webkit","o"],r=0;r<t.length&&!window.requestAnimationFrame;++r)window.requestAnimationFrame=window[t[r]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[t[r]+"CancelAnimationFrame"]||window[t[r]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(t,r){var o=(new Date).getTime(),a=Math.max(0,16-(o-e)),n=window.setTimeout(function(){t(o+a)},a);return e=o+a,n}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)})}(),function(){var e="mousemove.tc",t="mouseout.tc",r="mouseover.tc",o=TC.url.ol.substr(0,TC.url.ol.lastIndexOf("/"));o=o.substr(0,o.lastIndexOf("/")+1)+"css/ol.css",ol.proj.oldGet=ol.proj.get,ol.proj.get=function(e){if("string"==typeof e){for(var t=0,r=ol.proj.EPSG4326.PROJECTIONS.length;r>t;t++){var o=ol.proj.EPSG4326.PROJECTIONS[t];if(o.getCode()===e)return o}TC.loadProjDef(e,!0)}return ol.proj.oldGet(e)},ol.format.GMLBase.prototype.readGeometryElement=function(e,t){var r=t[0],o=r.srsName=e.firstElementChild.getAttribute("srsName");if((this instanceof ol.format.GML2CRS84||this instanceof ol.format.GML3CRS84)&&("EPSG:4326"!==o||!o))throw"Conflicto de CRS";o&&(r.srsName=this.srsName||o,r.dataProjection=ol.proj.get(r.srsName));var a=ol.xml.pushParseAndPop(null,this.GEOMETRY_PARSERS_,e,t,this);return a?ol.format.Feature.transformWithOptions(a,!1,r):void 0},ol.format.GMLBase.prototype.readFeatureElement=function(e,t){var r,o,a=e.getAttribute("fid")||ol.xml.getAttributeNS(e,ol.format.GMLBase.GMLNS,"id"),n={};for(r=e.firstElementChild;r;r=r.nextElementSibling){var i=r.localName;if(0===r.childNodes.length||1===r.childNodes.length&&(3===r.firstChild.nodeType||4===r.firstChild.nodeType)){var l=ol.xml.getAllTextContent(r,!1);ol.format.GMLBase.ONLY_WHITESPACE_RE_.test(l)&&(l=void 0),n[i]=l}else(n[i]=this.readGeometryElement(r,t))&&"boundedBy"!==i&&"referencePoint"!==i&&(o=i)}var s=new ol.Feature(n);return o&&s.setGeometryName(o),a&&s.setId(a),s};var a="http://www.opengis.net/gml",n="http://www.opengis.net/gml/3.2";ol.format.GMLBase.prototype.MULTIPOINT_PARSERS_[n]=ol.format.GMLBase.prototype.MULTIPOINT_PARSERS_[a],ol.format.GMLBase.prototype.MULTILINESTRING_PARSERS_[n]=ol.format.GMLBase.prototype.MULTILINESTRING_PARSERS_[a],ol.format.GMLBase.prototype.MULTIPOLYGON_PARSERS_[n]=ol.format.GMLBase.prototype.MULTIPOLYGON_PARSERS_[a],ol.format.GMLBase.prototype.POINTMEMBER_PARSERS_[n]=ol.format.GMLBase.prototype.POINTMEMBER_PARSERS_[a],ol.format.GMLBase.prototype.LINESTRINGMEMBER_PARSERS_[n]=ol.format.GMLBase.prototype.LINESTRINGMEMBER_PARSERS_[a],ol.format.GMLBase.prototype.POLYGONMEMBER_PARSERS_[n]=ol.format.GMLBase.prototype.POLYGONMEMBER_PARSERS_[a],ol.format.GMLBase.prototype.RING_PARSERS[n]=ol.format.GMLBase.prototype.RING_PARSERS[a],ol.format.GML3.prototype.GEOMETRY_FLAT_COORDINATES_PARSERS_[n]=ol.format.GML3.prototype.GEOMETRY_FLAT_COORDINATES_PARSERS_[a],ol.format.GML3.prototype.FLAT_LINEAR_RINGS_PARSERS_[n]=ol.format.GML3.prototype.FLAT_LINEAR_RINGS_PARSERS_[a],ol.format.GML3.prototype.GEOMETRY_PARSERS_[n]=ol.format.GML3.prototype.GEOMETRY_PARSERS_[a],ol.format.GML3.prototype.MULTICURVE_PARSERS_[n]=ol.format.GML3.prototype.MULTICURVE_PARSERS_[a],ol.format.GML3.prototype.MULTISURFACE_PARSERS_[n]=ol.format.GML3.prototype.MULTISURFACE_PARSERS_[a],ol.format.GML3.prototype.CURVEMEMBER_PARSERS_[n]=ol.format.GML3.prototype.CURVEMEMBER_PARSERS_[a],ol.format.GML3.prototype.SURFACEMEMBER_PARSERS_[n]=ol.format.GML3.prototype.SURFACEMEMBER_PARSERS_[a],ol.format.GML3.prototype.SURFACE_PARSERS_[n]=ol.format.GML3.prototype.SURFACE_PARSERS_[a],ol.format.GML3.prototype.CURVE_PARSERS_[n]=ol.format.GML3.prototype.CURVE_PARSERS_[a],ol.format.GML3.prototype.ENVELOPE_PARSERS_[n]=ol.format.GML3.prototype.ENVELOPE_PARSERS_[a],ol.format.GML3.prototype.PATCHES_PARSERS_[n]=ol.format.GML3.prototype.PATCHES_PARSERS_[a],ol.format.GML3.prototype.SEGMENTS_PARSERS_[n]=ol.format.GML3.prototype.SEGMENTS_PARSERS_[a],ol.format.KML._createStyleDefaults_=ol.format.KML.createStyleDefaults_,ol.format.KML.createStyleDefaults_=function(){return ol.format.KML._createStyleDefaults_(),ol.format.KML.DEFAULT_FILL_STYLE_.color_=d(TC.Cfg.styles.polygon.fillColor,TC.Cfg.styles.polygon.fillOpacity),ol.format.KML.DEFAULT_TEXT_STYLE_.fill_=new ol.style.Fill({color:ol.format.KML.DEFAULT_COLOR_}),ol.format.KML.DEFAULT_STROKE_STYLE_.color_=d(TC.Cfg.styles.line.strokeColor,1),ol.format.KML.DEFAULT_STROKE_STYLE_.width_=TC.Cfg.styles.line.strokeWidth,ol.format.KML.DEFAULT_STYLE_ARRAY_},ol.format.KML.prototype._readDocumentOrFolder_=ol.format.KML.prototype.readDocumentOrFolder_,ol.format.KML.prototype.readDocumentOrFolder_=function(e,t){var r=ol.format.KML.prototype._readDocumentOrFolder_.apply(this,arguments);if("Folder"==e.localName)for(var o=0;o<r.length;o++){var a=r[o];$.isArray(a._folders)||(a._folders=[]);var n=e.getElementsByTagName("name")[0];n&&TC.Util.fastUnshift(a._folders,n.innerHTML||n.textContent)}return r},ol.format.KML.readText_=function(e,t){ol.asserts.assert(e.nodeType==Node.ELEMENT_NODE),ol.asserts.assert("text"==e.localName);var r=ol.xml.getAllTextContent(e,!1);return r.trim()},ol.format.KML.BALLOON_STYLE_PARSERS_=ol.xml.makeStructureNS(ol.format.KML.NAMESPACE_URIS_,{text:ol.xml.makeObjectPropertySetter(ol.format.KML.readText_)}),ol.format.KML.BalloonStyleParser_=function(e,t){ol.asserts.assert(e.nodeType==Node.ELEMENT_NODE),ol.asserts.assert("BalloonStyle"==e.localName);var r=ol.xml.pushParseAndPop({},ol.format.KML.BALLOON_STYLE_PARSERS_,e,t);if(goog.isDef(r)){var o=t[t.length-1];ol.asserts.assert(goog.isObject(o));var a=new ol.style.Text({text:r.text});o.balloonStyle=a}};for(var i in ol.format.KML.STYLE_PARSERS_){var l=ol.format.KML.STYLE_PARSERS_[i];l.BalloonStyle=ol.format.KML.BalloonStyleParser_}ol.format.KML.readStyle_=function(e,t){var r=ol.xml.pushParseAndPop({},ol.format.KML.STYLE_PARSERS_,e,t);if(!r)return null;var o="fillStyle"in r?r.fillStyle:ol.format.KML.DEFAULT_FILL_STYLE_,a=r.fill;void 0===a||a||(o=null);var n="imageStyle"in r?r.imageStyle:ol.format.KML.DEFAULT_IMAGE_STYLE_;n==ol.format.KML.DEFAULT_NO_IMAGE_STYLE_&&(n=void 0);var i="textStyle"in r?r.textStyle:ol.format.KML.DEFAULT_TEXT_STYLE_,l="strokeStyle"in r?r.strokeStyle:ol.format.KML.DEFAULT_STROKE_STYLE_,s="balloonStyle"in r?r.balloonStyle:ol.format.KML.DEFAULT_BALLOON_STYLE_,p=r.outline;void 0===p||p||(l=null);var c=new ol.style.Style({fill:o,image:n,stroke:l,text:i,zIndex:void 0});return c._balloon=s,[c]},ol.format.KML._readURI_=ol.format.KML.readURI_,ol.format.KML.readURI_=function(e){var t=ol.format.KML._readURI_(e);return"https:"===location.protocol&&0===t.indexOf("http://")&&(t=t.substr(5)),t};for(var i in ol.format.KML.ICON_PARSERS_)ol.format.KML.ICON_PARSERS_[i].href=ol.xml.makeObjectPropertySetter(ol.format.KML.readURI_);ol.format.KML.whenParser_=function(e,t){ol.asserts.assert(e.nodeType==Node.ELEMENT_NODE,"node.nodeType should be ELEMENT"),ol.asserts.assert("when"==e.localName,"localName should be when");var r=t[t.length-1];ol.asserts.assert(goog.isObject(r),"gxTrackObject should be an Object");var r=r.whens,o=ol.xml.getAllTextContent(e,!1);if(o=/^\s*(\d{4})($|-(\d{2})($|-(\d{2})($|T(\d{2}):(\d{2}):(\d{2})(?:.?\d{3})?(Z|(?:([+\-])(\d{2})(?::(\d{2}))?)))))\s*$/.exec(o)){var a=parseInt(o[1],10),n=o[3]?parseInt(o[3],10)-1:0,i=o[5]?parseInt(o[5],10):1,l=o[7]?parseInt(o[7],10):0,s=o[8]?parseInt(o[8],10):0,p=o[9]?parseInt(o[9],10):0,a=Date.UTC(a,n,i,l,s,p);o[10]&&"Z"!=o[10]&&(n="-"==o[11]?-1:1,a+=60*n*parseInt(o[12],10),o[13]&&(a+=3600*n*parseInt(o[13],10))),r.push(a)}else r.push(0)},ol.format.KML.GX_TRACK_PARSERS_=ol.xml.makeStructureNS(ol.format.KML.NAMESPACE_URIS_,{when:ol.format.KML.whenParser_},ol.xml.makeStructureNS(ol.format.KML.GX_NAMESPACE_URIS_,{coord:ol.format.KML.gxCoordParser_}));var s=function(e,t){var r=ol.xml.parse(e),o=r.getElementsByTagName(t.toLowerCase());if(o&&o.length>0){var a=o[0].getAttribute("xmlns");if(a.indexOf(" ")>-1&&f.indexOf(a)>-1)for(var n=a.split(" "),i=[],l=0;l<n.length;l++)i.push("xmlns:"+t.toLowerCase()+l+'="'+n[l].trim()+'"')}return e};ol.format.KML.prototype.readFeatures=function(e,t){if("string"==typeof e){var r="<kml",o=e.indexOf(r);if(o>=0){o+=r.length;{e.indexOf(">",o)}e.indexOf("xmlns:xsi=")<0&&(e=e.substr(0,o)+' xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"'+e.substr(o)),e=s(e,"KML")}}return ol.format.XMLFeature.prototype.readFeatures.call(this,e,t)},ol.format.XSD.readDateTime=function(e){if(e=ol.xml.getAllTextContent(e,!1),e=/^\s*(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})(Z|(?:([+\-])(\d{2})(?::(\d{2}))?))\s*$/.exec(e)){var t=parseInt(e[1],10),r=parseInt(e[2],10)-1,o=parseInt(e[3],10),a=parseInt(e[4],10),n=parseInt(e[5],10),i=parseInt(e[6],10),t=Date.UTC(t,r,o,a,n,i);return"Z"!=e[7]&&(r="-"==e[8]?-1:1,t+=60*r*parseInt(e[9],10),void 0!==e[10]&&(t+=3600*r*parseInt(e[10],10))),t}},ol.format.GPX.RTEPT_PARSERS_=ol.xml.makeStructureNS(ol.format.GPX.NAMESPACE_URIS_,{ele:ol.xml.makeObjectPropertySetter(ol.format.XSD.readDecimal),time:ol.xml.makeObjectPropertySetter(ol.format.XSD.readDateTime)}),ol.format.GPX.TRKPT_PARSERS_=ol.xml.makeStructureNS(ol.format.GPX.NAMESPACE_URIS_,{ele:ol.xml.makeObjectPropertySetter(ol.format.XSD.readDecimal),time:ol.xml.makeObjectPropertySetter(ol.format.XSD.readDateTime)}),ol.format.GPX.WPT_PARSERS_=ol.xml.makeStructureNS(ol.format.GPX.NAMESPACE_URIS_,{ele:ol.xml.makeObjectPropertySetter(ol.format.XSD.readDecimal),time:ol.xml.makeObjectPropertySetter(ol.format.XSD.readDateTime),magvar:ol.xml.makeObjectPropertySetter(ol.format.XSD.readDecimal),geoidheight:ol.xml.makeObjectPropertySetter(ol.format.XSD.readDecimal),name:ol.xml.makeObjectPropertySetter(ol.format.XSD.readString),cmt:ol.xml.makeObjectPropertySetter(ol.format.XSD.readString),desc:ol.xml.makeObjectPropertySetter(ol.format.XSD.readString),src:ol.xml.makeObjectPropertySetter(ol.format.XSD.readString),link:ol.format.GPX.parseLink_,sym:ol.xml.makeObjectPropertySetter(ol.format.XSD.readString),type:ol.xml.makeObjectPropertySetter(ol.format.XSD.readString),fix:ol.xml.makeObjectPropertySetter(ol.format.XSD.readString),sat:ol.xml.makeObjectPropertySetter(ol.format.XSD.readNonNegativeInteger),hdop:ol.xml.makeObjectPropertySetter(ol.format.XSD.readDecimal),vdop:ol.xml.makeObjectPropertySetter(ol.format.XSD.readDecimal),pdop:ol.xml.makeObjectPropertySetter(ol.format.XSD.readDecimal),ageofdgpsdata:ol.xml.makeObjectPropertySetter(ol.format.XSD.readDecimal),dgpsid:ol.xml.makeObjectPropertySetter(ol.format.XSD.readNonNegativeInteger),extensions:ol.format.GPX.parseExtensions_}),ol.format.XSD.writeDateTimeTextNode=function(e,t){var r=new Date(t),o=r.getUTCFullYear()+"-"+goog.string.padNumber(r.getUTCMonth()+1,2)+"-"+goog.string.padNumber(r.getUTCDate(),2)+"T"+goog.string.padNumber(r.getUTCHours(),2)+":"+goog.string.padNumber(r.getUTCMinutes(),2)+":"+goog.string.padNumber(r.getUTCSeconds(),2)+"Z";e.appendChild(ol.xml.DOCUMENT.createTextNode(o))},ol.format.GPX.WPT_TYPE_SERIALIZERS_=ol.xml.makeStructureNS(ol.format.GPX.NAMESPACE_URIS_,{ele:ol.xml.makeChildAppender(ol.format.XSD.writeDecimalTextNode),time:ol.xml.makeChildAppender(ol.format.XSD.writeDateTimeTextNode),magvar:ol.xml.makeChildAppender(ol.format.XSD.writeDecimalTextNode),geoidheight:ol.xml.makeChildAppender(ol.format.XSD.writeDecimalTextNode),name:ol.xml.makeChildAppender(ol.format.XSD.writeStringTextNode),cmt:ol.xml.makeChildAppender(ol.format.XSD.writeStringTextNode),desc:ol.xml.makeChildAppender(ol.format.XSD.writeStringTextNode),src:ol.xml.makeChildAppender(ol.format.XSD.writeStringTextNode),link:ol.xml.makeChildAppender(ol.format.GPX.writeLink_),sym:ol.xml.makeChildAppender(ol.format.XSD.writeStringTextNode),type:ol.xml.makeChildAppender(ol.format.XSD.writeStringTextNode),fix:ol.xml.makeChildAppender(ol.format.XSD.writeStringTextNode),sat:ol.xml.makeChildAppender(ol.format.XSD.writeNonNegativeIntegerTextNode),hdop:ol.xml.makeChildAppender(ol.format.XSD.writeDecimalTextNode),vdop:ol.xml.makeChildAppender(ol.format.XSD.writeDecimalTextNode),pdop:ol.xml.makeChildAppender(ol.format.XSD.writeDecimalTextNode),ageofdgpsdata:ol.xml.makeChildAppender(ol.format.XSD.writeDecimalTextNode),dgpsid:ol.xml.makeChildAppender(ol.format.XSD.writeNonNegativeIntegerTextNode)});var p=function(e){for(var t=[],r=[],o=Math.pow(2,e.length),a=0;o>a;a++){r=[];for(var n=0;n<e.length;n++)a&Math.pow(2,n)&&-1==r.indexOf(e[n])&&r.push(e[n]);r.length>0&&-1==t.indexOf(r.join(" "))&&t.push(r.join(" "))}return t},c=function(e,t){if(e&&e.length>0)for(var r=0;r<t.length;r++){var o=e.indexOf(t[r]);o>-1&&e.splice(o,1)}},u=function(e,t){for(var r=0;r<e.length;r++)for(var o=e[r],a=0;a<t.length;a++){var n=t[a].split(" ")[0];o[t[a]]=o[n]}},g=[ol.format.KML.DATA_PARSERS_,ol.format.KML.EXTENDED_DATA_PARSERS_,ol.format.KML.REGION_PARSERS_,ol.format.KML.LAT_LON_ALT_BOX_PARSERS_,ol.format.KML.LOD_PARSERS_,ol.format.KML.EXTRUDE_AND_ALTITUDE_MODE_PARSERS_,ol.format.KML.FLAT_LINEAR_RING_PARSERS_,ol.format.KML.FLAT_LINEAR_RINGS_PARSERS_,ol.format.KML.GX_TRACK_PARSERS_,ol.format.KML.GEOMETRY_FLAT_COORDINATES_PARSERS_,ol.format.KML.ICON_PARSERS_,ol.format.KML.ICON_STYLE_PARSERS_,ol.format.KML.INNER_BOUNDARY_IS_PARSERS_,ol.format.KML.LABEL_STYLE_PARSERS_,ol.format.KML.LINE_STYLE_PARSERS_,ol.format.KML.MULTI_GEOMETRY_PARSERS_,ol.format.KML.GX_MULTITRACK_GEOMETRY_PARSERS_,ol.format.KML.NETWORK_LINK_PARSERS_,ol.format.KML.LINK_PARSERS_,ol.format.KML.OUTER_BOUNDARY_IS_PARSERS_,ol.format.KML.PAIR_PARSERS_,ol.format.KML.PLACEMARK_PARSERS_,ol.format.KML.POLY_STYLE_PARSERS_,ol.format.KML.SCHEMA_DATA_PARSERS_,ol.format.KML.STYLE_PARSERS_,ol.format.KML.STYLE_MAP_PARSERS_],f=p(ol.format.KML.NAMESPACE_URIS_.slice().slice(1));c(f,ol.format.KML.NAMESPACE_URIS_),ol.format.KML.NAMESPACE_URIS_=ol.format.KML.NAMESPACE_URIS_.concat(f),u(g,f);var m=[ol.format.GPX.GPX_PARSERS_,ol.format.GPX.LINK_PARSERS_,ol.format.GPX.RTE_PARSERS_,ol.format.GPX.RTEPT_PARSERS_,ol.format.GPX.TRK_PARSERS_,ol.format.GPX.TRKSEG_PARSERS_,ol.format.GPX.TRKPT_PARSERS_,ol.format.GPX.WPT_PARSERS_,ol.format.GPX.LINK_SERIALIZERS_,ol.format.GPX.RTE_SEQUENCE_,ol.format.GPX.RTE_SERIALIZERS_,ol.format.GPX.RTEPT_TYPE_SEQUENCE_,ol.format.GPX.TRK_SEQUENCE_,ol.format.GPX.TRK_SERIALIZERS_,ol.format.GPX.TRKSEG_SERIALIZERS_,ol.format.GPX.WPT_TYPE_SEQUENCE_,ol.format.GPX.WPT_TYPE_SERIALIZERS_,ol.format.GPX.GPX_SERIALIZERS_],y=p(ol.format.GPX.NAMESPACE_URIS_.slice().slice(1));c(y,ol.format.GPX.NAMESPACE_URIS_),ol.format.GPX.NAMESPACE_URIS_=ol.format.GPX.NAMESPACE_URIS_.concat(y),u(m,y),ol.format.GMLBase.prototype.readFeaturesInternal=function(e,t){ol.DEBUG&&console.assert(e.nodeType==Node.ELEMENT_NODE,"node.nodeType should be ELEMENT");var r=e.localName,o=null;if("FeatureCollection"==r){var a=this.FEATURE_COLLECTION_PARSERS[ol.format.GMLBase.GMLNS];a.member||(a.member=ol.xml.makeArrayPusher(ol.format.GMLBase.prototype.readFeaturesInternal)),"http://www.opengis.net/wfs"===e.namespaceURI?o=ol.xml.pushParseAndPop([],this.FEATURE_COLLECTION_PARSERS,e,t,this):(this.FEATURE_COLLECTION_PARSERS[e.namespaceURI]=this.FEATURE_COLLECTION_PARSERS[e.namespaceURI]||this.FEATURE_COLLECTION_PARSERS[ol.format.GMLBase.GMLNS],o=ol.xml.pushParseAndPop([],this.FEATURE_COLLECTION_PARSERS,e,t,this))}else if("featureMembers"==r||"featureMember"==r||"member"==r){var n,i,l=t[0],s=l.featureType,p=l.featureNS,c="p",u="p0";if(e.childNodes){for(s=[],p={},n=0,i=e.childNodes.length;i>n;++n){var g=e.childNodes[n];if(1===g.nodeType){var f=g.nodeName.split(":").pop();if(-1===s.indexOf(f)){var m="",y=0,d=g.namespaceURI;for(var v in p){if(p[v]===d){m=v;break}++y}m||(m=c+y,p[m]=d),s.push(m+":"+f)}}}"featureMember"!=r&&"member"!=r&&(l.featureType=s,l.featureNS=p)}if("string"==typeof p){var h=p;p={},p[u]=h}var C={},T=Array.isArray(s)?s:[s];for(var S in p){var w={};for(n=0,i=T.length;i>n;++n){var E=-1===T[n].indexOf(":")?u:T[n].split(":")[0];E===S&&(w[T[n].split(":").pop()]="featureMembers"==r?ol.xml.makeArrayPusher(this.readFeatureElement,this):ol.xml.makeReplacer(this.readFeatureElement,this))}C[p[S]]=w}o="featureMember"==r||"member"==r?ol.xml.pushParseAndPop(void 0,C,e,t):ol.xml.pushParseAndPop([],C,e,t)}null===o&&(o=[]);var L=function(e){var t=e.getGeometry();if(!t||!t.flatCoordinates.length)throw"Geometría no válida. ¿Posible versión incorrecta de GML?"};if(o instanceof ol.Feature)L(o);else for(var n=0,R=o.length;R>n;n++)L(o[n]);return o},ol.format.GML3CRS84=function(){ol.format.GML3.call(this,{srsName:"CRS:84"})},ol.inherits(ol.format.GML3CRS84,ol.format.GML3),ol.format.GML2CRS84=function(){ol.format.GML2.call(this,{srsName:"CRS:84"})},ol.inherits(ol.format.GML2CRS84,ol.format.GML2),ol.format.GML3CRS84=function(){ol.format.GML3.call(this,{srsName:"CRS:84"})},ol.inherits(ol.format.GML3CRS84,ol.format.GML3),ol.format.GML2CRS84=function(){ol.format.GML2.call(this,{srsName:"CRS:84"})},ol.inherits(ol.format.GML2CRS84,ol.format.GML2),ol.View.prototype.getValueForResolutionFunction=function(e){var t=e||2,r=this.maxResolution_,o=this.minResolution_,a=Math.log(r/o)/Math.log(t);return function(e){var o=Math.log(r/e)/Math.log(t)/a;return o=Math.max(Math.min(1,o),0)}};var d=function(e,t){var r;return e?(r=ol.color.asArray(e),r=r.slice(),void 0!==t&&(r[3]=t)):r=[0,0,0,1],r},v=function(e,t){var r=e.map.getView(),o=r.getResolution(),a={projection:r.getProjection(),center:r.getCenter(),resolution:o,enableRotation:!1};if(e.parent.options.maxExtent&&(a.extent=e.parent.options.initialExtent),t instanceof TC.layer.Raster){var n,i,l=t.getResolutions();if(l&&l.length){n=t.maxResolution||l[0],i=t.minResolution||l[l.length-1];var s=l.indexOf(i),p=l.indexOf(n);a.resolutions=l.slice(p,s+1)}else n=t.maxResolution,i=t.minResolution;i&&(a.minResolution=i,i>o&&(a.resolution=i)),n&&(a.maxResolution=n,o>n&&(a.resolution=n))}return a};TC.wrap.Map.prototype.setMap=function(){var e=this,t=[(e.parent.options.initialExtent[0]+e.parent.options.initialExtent[2])/2,(e.parent.options.initialExtent[1]+e.parent.options.initialExtent[3])/2],r=proj4(e.parent.crs),o=function(){var t=e.parent.crs.substr(e.parent.crs.lastIndexOf(":")+1),o={units:r.oProj.units,extent:e.parent.options.baselayerExtent,global:!0,worldExtent:e.parent.options.baselayerExtent},a=[];o.code="EPSG:"+t,a.push(new ol.proj.Projection(o)),o.code="urn:ogc:def:crs:EPSG::"+t,a.push(new ol.proj.Projection(o)),ol.proj.addEquivalentProjections(a);var n=function(e,t,r,o){for(var a=[],n=o||2,i=0;i<t.length;i+=n)a=a.concat(e(t.slice(i,i+n)));if($.isArray(r)){r.length=0;for(var i=0;i<a.length;i++)r[i]=a[i];a=r}return a},i=function(e,t,o){return n(r.forward,e,t,o)},l=function(e,t,o){return n(r.inverse,e,t,o)};ol.proj.addEquivalentTransforms(ol.proj.EPSG4326.PROJECTIONS,a,i,l)};o();var a={code:e.parent.crs,units:r.oProj.units,extent:e.parent.options.baselayerExtent};"EPSG:4326"===e.parent.crs&&(a.axisOrientation="neu");var n=new ol.proj.Projection(a),i=ol.interaction.defaults(),l={projection:n,center:t,enableRotation:!1};if(e.parent.options.maxExtent){var s=e.parent.options.maxExtent;l.extent=s;var p=e.parent.div.getBoundingClientRect(),c=(p.width/p.height,s[2]-s[0]),u=s[3]-s[1];l.resolution=p.width/p.height>c/u?c/p.width:u/p.height}else l.zoom=2;e.map=new ol.Map({target:e.parent.div,renderer:ol.renderer.Type.CANVAS,view:new ol.View(l),controls:[],interactions:i}),e.map.getView().fit(e.parent.options.initialExtent,e.map.getSize()),e.map._wrap=e;var g=function(){e.map.updateSize()};$(e.parent.div).on(ol.events.EventType.RESIZE,g),e.parent.$events.one(TC.Consts.event.MAPLOAD,g),e.map.on(ol.MapBrowserEvent.EventType.SINGLECLICK,function(t){var r=$.map(e.parent.workLayers,function(){return!1});e.map.forEachFeatureAtPixel(t.pixel,function(t,o){if(t._wrap&&t._wrap.parent.showsPopup){for(var a=0;a<e.parent.workLayers.length;a++){var n=e.parent.workLayers[a];if(n.wrap.layer===o){r[a]=!0;break}}return e.parent.$events.trigger($.Event(TC.Consts.event.FEATURECLICK,{feature:t._wrap.parent})),t}});for(var o=0;o<r.length;o++)r[o]||e.parent.$events.trigger($.Event(TC.Consts.event.NOFEATURECLICK,{layer:e.parent.workLayers[o]}))});var f=e.map.getView();f.on("change:resolution",function(){e.parent.$events.trigger($.Event(TC.Consts.event.BEFOREZOOM))},e.parent),e.map.on(ol.MapEvent.Type.MOVEEND,function(){e.parent.$events.trigger($.Event(TC.Consts.event.ZOOM))}),e.mapDeferred.resolve(e.map);var m=function(t,r){var o=(e.map.getView().getResolution(),e.map.getView().getZoom(),r||v(e,t)),a=new ol.View(o);e.map.setView(a),e.map.render()};e.parent.$events.on(TC.Consts.event.BASELAYERCHANGE,function(e){m(e.layer)}),e.parent.$events.on(TC.Consts.event.MAPLOAD,function(t){m(e.parent.getBaseLayer())})},TC.wrap.Map.prototype.insertLayer=function(e,t){for(var r=this,o=r.map.getLayers(),a=!1,n=0;n<o.getLength();n++)if(o.item(n)===e){a=!0;break}if(a)o.remove(e),o.insertAt(t,e);else{if(o.insertAt(t,e),e instanceof ol.layer.Tile){var i=e.getSource().getResolutions(),l=r.map.getView();l.maxResolution_=i[0],l.minResolution_=i[i.length-1]}var s=e._wrap,p=0;s.$events.on(TC.Consts.event.BEFORETILELOAD,function(t){s.parent.state=TC.Layer.state.LOADING,0>=p&&(p=0,r.parent.$events.trigger($.Event(TC.Consts.event.BEFORELAYERUPDATE,{layer:s.parent}))),e._loadingTileCount=e._loadingTileCount+1}),s.$events.on(TC.Consts.event.TILELOAD,function(e){p-=1,0>=p&&(p=0,s.parent.state=TC.Layer.state.IDLE,r.parent.$events.trigger($.Event(TC.Consts.event.LAYERUPDATE,{layer:s.parent})))})}},TC.wrap.Map.prototype.removeLayer=function(e){this.map.removeLayer(e)},TC.wrap.Map.prototype.getLayerCount=function(){return this.map.getLayerGroup().getLayers().getLength()},TC.wrap.Map.prototype.indexOfFirstVector=function(){var e=-1;return this.map.getLayerGroup().getLayers().forEach(function(t,r){t instanceof ol.layer.Vector&&-1===e&&(e=r)}),e},TC.wrap.Map.prototype.getLayerIndex=function(e){var t=-1;return this.map.getLayerGroup().getLayers().forEach(function(r,o){r===e&&(t=o)}),t},TC.wrap.Map.prototype.setLayerIndex=function(e,t){var r=this.map.getLayers(),o=r.getArray(),a=o.indexOf(e);a>-1&&a!=t&&(this.map.removeLayer(e),this.insertLayer(e,t))},TC.wrap.Map.prototype.setBaseLayer=function(e){var t=this,r=new $.Deferred,o=v(t,e._wrap.parent),a=t.map.getView(),n=function(){var o=t.parent.getBaseLayer();o&&t.map.removeLayer(o.wrap.getLayer()),t.insertLayer(e,0),r.resolve()},i=a.getResolution();return i!==o.resolution?a.animate({resolution:o.resolution,duration:TC.Consts.ZOOM_ANIMATION_DURATION},function(){n()}):n(),r.promise()},TC.wrap.Map.prototype.setExtent=function(e,t){var r=this;r.done&&r.done.resolve(),r.done=new $.Deferred;var o=t||{};return clearTimeout(r._timeout),r._timeout=setTimeout(function(){var t=r.map.getSize(),a=r.map.getView(),n=function(){r.done.resolve()},i=function(){var r=a.getResolutionForExtent(e,t);if(a.constrainResolution){var i=a.constrainResolution(r,0,0);r>i&&(i=a.constrainResolution(i,-1,0)),r=i}a.animate({resolution:r,center:[(e[0]+e[2])/2,(e[1]+e[3])/2],duration:void 0===o.animate||o.animate?TC.Consts.ZOOM_ANIMATION_DURATION:0},n)};r.parent.baseLayer?$.when(r.parent.baseLayer.wrap.getLayer()).then(function(o){var n=o.getSource();if(n.getResolutions!=goog.abstractMethod){var l=a.getResolutionForExtent(e,t),s=r.parent.baseLayer.getResolutions();if(s&&s.length>0){var p=Math.min.apply(r,s);if(p>l){var c=.5*(p/l-1),u=ol.extent.getWidth(e)*c,g=ol.extent.getHeight(e)*c;e=e.slice(0),e[0]=e[0]-u,e[1]=e[1]-g,e[2]=e[2]+u,e[3]=e[3]+g}}}i()}):i()},50),r.done},TC.wrap.Map.prototype.getExtent=function(){return this.map.getView().calculateExtent(this.map.getSize())},TC.wrap.Map.prototype.setCenter=function(e,t){var r=this,o=t||{},a=r.map.getView();o.animate?a.animate({center:e,duration:TC.Consts.ZOOM_ANIMATION_DURATION}):a.setCenter(e)},TC.wrap.Map.prototype.getCenter=function(){return this.map.getView().getCenter()},TC.wrap.Map.prototype.getResolution=function(){return this.map.getView().getResolution()},TC.wrap.Map.prototype.setResolution=function(e){$.when(this.getMap()).then(function(t){t.getView().setResolution(e)})},TC.wrap.Map.prototype.setRotation=function(e){$.when(this.getMap()).then(function(t){t.getView().setRotation(e)})},TC.wrap.Map.prototype.getRotation=function(){return this.map.getView().getRotation()},TC.wrap.Map.prototype.getCoordinateFromPixel=function(e){return this.map.getCoordinateFromPixel(e)},TC.wrap.Map.prototype.getPixelFromCoordinate=function(e){return this.map.getPixelFromCoordinate(e)},TC.wrap.Map.prototype.getViewport=function(e){var t=this,r=e||{};if(r.synchronous)o=t.map.getViewport();else{var o=new $.Deferred;$.when(this.getMap()).then(function(e){o.resolve(e.getViewport())})}return o},TC.wrap.Map.prototype.isNative=function(e){return e instanceof ol.Map},TC.wrap.Map.prototype.isGeo=function(){return this.map.getView().getProjection().getUnits()===ol.proj.Units.DEGREES},TC.wrap.Map.prototype.addPopup=function(t){var r=$.Deferred(),o=this,a=void 0===t.options.draggable||t.options.draggable;TC.loadJS(a&&!$.fn.drag,[TC.apiLocation+"lib/jQuery/jquery.event.drag.js"],function(){$.when(o.getMap()).then(function(r){if(!t.$popupDiv){var n=TC.Util.getDiv();t.$popupDiv=$(n),t.$popupDiv.addClass(TC.control.Popup.prototype.CLASS).appendTo(o.parent.div),t.$contentDiv=$(TC.Util.getDiv()).addClass(TC.control.Popup.prototype.CLASS+"-content").appendTo(t.$popupDiv);var i=new ol.Overlay({element:n,positioning:"bottom-left"});r.addOverlay(i),t.wrap.popup=i;var l=$(r.getViewport());if(a){var s=t.$popupDiv.parent();t.$popupDiv.addClass(TC.Consts.classes.DRAGGABLE),s.on("touchmove",function(e){$(e.target).parents(".tc-ctl-finfo-layer-content").length&&e.stopPropagation()}).drag("start",function(e,o){var a=e.target.getBoundingClientRect();if(a.left+e.target.clientWidth<e.clientX||a.top+e.target.clientHeight<e.clientY)return!1;if(t.setDragging(!0),t._currentOffset=i.getOffset(),t._previousContainerPosition){var n=r.getSize();i.setPosition(r.getCoordinateFromPixel([t._previousContainerPosition[0],n[1]-t._previousContainerPosition[1]])),t._currentOffset=[0,0],i.setOffset(t._currentOffset),delete t._previousContainerPosition}else t._currentOffset=i.getOffset()}).drag("end",function(e,o){t.setDragging(!1);var a=r.getCoordinateFromPixel([0,0]),n=r.getCoordinateFromPixel(i.getOffset()),l=[n[0]-a[0],n[1]-a[1]],p=i.getPosition();i.setPosition([p[0]+l[0],p[1]+l[1]]),i.setOffset([0,0]),t._currentOffset=[0,0],t._previousContainerPosition=[parseInt(s.css("left")),parseInt(s.css("bottom"))]}).drag(function(e,r){return e.buttons||Modernizr.touch?void i.setOffset([t._currentOffset[0]+r.deltaX,t._currentOffset[1]+r.deltaY]):!1},{not:"th,td,input,select"})}l.off(e+".popup").on(e+".popup",function(e){var t=r.getTarget(),a=!1;if(!o.parent.activeControl||!o.parent.activeControl.isExclusive()){var n=r.getEventPixel(e.originalEvent);a=r.forEachFeatureAtPixel(n,function(e,t){var r=!0;return e._wrap&&!e._wrap.parent.showsPopup&&(r=!1),r})}t.style.cursor=a?"pointer":""})}}),r.resolve()}),r.promise()},TC.wrap.Map.prototype.hidePopup=function(e){var t=this;t.parent.currentFeature=null,e.$popupDiv&&e.$popupDiv.removeClass(TC.Consts.classes.VISIBLE)};var h=function(e){switch(e){case TC.Consts.layerType.KML:case TC.Consts.mimeType.KML:return new ol.format.KML({showPointNames:!1});case TC.Consts.layerType.GPX:return new ol.format.GPX;case TC.Consts.layerType.GEOJSON:case TC.Consts.mimeType.JSON:case TC.Consts.format.JSON:return new ol.format.GeoJSON;case TC.Consts.format.GML2:return new ol.format.GML2;case TC.Consts.format.GML3:return new ol.format.GML3;case TC.Consts.mimeType.GML:case TC.Consts.format.GML:return new ol.format.GML;case TC.Consts.format.TOPOJSON:return new ol.format.TopoJSON;case TC.Consts.format.WKT:return new ol.format.WKT}};TC.wrap.Map.prototype.exportFeatures=function(e,t){var r=this,o=M({styles:r.parent.options.styles}),a=e.map(function(e){var t=e.wrap.feature;return t.getStyle()||t.setStyle(o),t}),n=h(t.format);if(n instanceof ol.format.GMLBase){n.featureNS="sitna",n.featureType="getFeatureInfoResult";var i=n.writeFeaturesNode(a,{featureProjection:r.parent.crs}),l=ol.xml.createElementNS("http://www.opengis.net/gml","FeatureCollection");return ol.xml.setAttributeNS(l,"http://www.w3.org/2001/XMLSchema-instance","xsi:schemaLocation",n.schemaLocation),i.removeAttribute("xmlns:xsi"),i.removeAttribute("xsi:schemaLocation"),l.appendChild(i),l.outerHTML}return n.writeFeatures(a,{featureProjection:r.parent.crs})};var C=function(e){for(var t=0,r=e.dataTransfer.types.length;r>t;t++)if("Files"===e.dataTransfer.types[t])return!0;return!1},T=function(e){var t=this;C(e)&&(t.getMap()._wrap.parent._$div.addClass(TC.Consts.classes.DROP),e.preventDefault(),e.stopPropagation())},S=function(e){var t=this;if(C(e)){var r=t.getMap()._wrap.parent;e.target===t.target&&r._$div.removeClass(TC.Consts.classes.DROP)}};TC.wrap.Map.prototype.enableDragAndDrop=function(e){var t=this,r=e||{},o={formatConstructors:[ol.format.KML,ol.format.GPX,ol.format.GML3CRS84,ol.format.GML2CRS84,ol.format.GML,ol.format.GML2,ol.format.GeoJSON,function(){return new ol.format.WKT({splitCollection:!0})},ol.format.TopoJSON]};o.target=r.dropTarget?TC.getDiv(r.dropTarget):t.parent.div;var a=new ol.interaction.DragAndDrop(o);if(a.on(ol.interaction.DragAndDrop.EventType.ADD_FEATURES,function(e){var r=e.features?e.features.map(function(e){return TC.wrap.Feature.createFeature(e)}):[];$.when.apply(this,r).then(function(){var r=t.parent.getLoadingIndicator();if(r&&r.removeWait(t._featureImportWaitId),arguments.length){for(var o=new Array(arguments.length),a=0,n=o.length;n>a;a++)o[a]=arguments[a];t.parent.$events.trigger($.Event(TC.Consts.event.FEATURESIMPORT,{features:o,fileName:e.file.name}))}else t.parent.$events.trigger($.Event(TC.Consts.event.FEATURESIMPORTERROR,{file:e.file}))})}),r.once)a.map_=t.map;else{t.map.addInteraction(a);var n=a.target?a.target:t.map.getViewport(),i=function(e){if(C(e)){var r=t.parent;if(a.target===e.target){var o=r.getLoadingIndicator();o&&(t._featureImportWaitId=o.addWait()),e.stopPropagation()}else e.preventDefault();r._$div.removeClass(TC.Consts.classes.DROP)}};a.dropListenKeys_.push(ol.events.listen(n,ol.events.EventType.DRAGENTER,T,a)),a.dropListenKeys_.push(ol.events.listen(document.body,ol.events.EventType.DRAGENTER,T,a)),a.dropListenKeys_.push(ol.events.listen(n,ol.events.EventType.DRAGOVER,T,a)),a.dropListenKeys_.push(ol.events.listen(document.body,ol.events.EventType.DRAGOVER,T,a)),a.dropListenKeys_.push(ol.events.listen(n,ol.events.EventType.DROP,i,a)),a.dropListenKeys_.push(ol.events.listen(document.body,ol.events.EventType.DROP,i,a)),a.dropListenKeys_.push(ol.events.listen(document.body,"dragleave",S,a)),a.dropListenKeys_.push(ol.events.listen(document.body,"dragend",S,a)),a.dropListenKeys_.push(ol.events.listen(document.body,"dragexit",S,a)),document.addEventListener("mouseenter",function(e){e.buttons||t.parent._$div.removeClass(TC.Consts.classes.DROP)},!1),t.ddEnabled=!0}return a},TC.wrap.Map.prototype.loadFiles=function(e){var t,r=this;r.ddEnabled?r.map.getInteractions().forEach(function(e){e instanceof ol.interaction.DragAndDrop&&(t=e)}):t=r.enableDragAndDrop({once:!0});var o=r.parent.getLoadingIndicator();o&&(r._featureImportWaitId=o.addWait()),ol.interaction.DragAndDrop.handleDrop_.call(t,{dataTransfer:{files:e}})},TC.wrap.Layer.prototype.getVisibility=function(e){var t=this,r=!1;return t.layer&&(r=t.layer.getVisible()),r},TC.wrap.Layer.prototype.setVisibility=function(e){var t=this;$.when(t.getLayer()).then(function(t){t.setVisible(e)})},TC.wrap.Layer.prototype.isNative=function(e){return e instanceof ol.layer.Layer},TC.wrap.layer.Raster.prototype.WmsParser=ol.format.WMSCapabilities,TC.wrap.layer.Raster.prototype.WmtsParser=ol.format.WMTSCapabilities,TC.wrap.Layer.prototype.addCommonEvents=function(e){var t=this;e.on("change:visible",function(){t.parent.map&&t.parent.map.$events.trigger($.Event(TC.Consts.event.LAYERVISIBILITY,{layer:t.parent
}))},t.parent.map)},TC.wrap.layer.Raster.prototype.getGetMapUrl=function(){var e=null,t=this;switch(t.getServiceType()){case TC.Consts.layerType.WMS:for(var r=t.parent.capabilities.Capability.Request.GetMap.DCPType,o=0;o<r.length;o++)if(r[o].HTTP&&r[o].HTTP.Get){e=r[o].HTTP.Get.OnlineResource;break}break;case TC.Consts.layerType.WMTS:e=t.parent.capabilities.OperationsMetadata.GetTile.DCP.HTTP.Get[0].href}return e=$("<textarea />").html(e).text()},TC.wrap.layer.Raster.prototype.getInfoFormats=function(){var e=null,t=this.parent.capabilities;return t.Capability&&t.Capability.Request.GetFeatureInfo&&(e=t.Capability.Request.GetFeatureInfo.Format),e},TC.wrap.layer.Raster.infoFormatPreference=["application/json","application/vnd.ogc.gml/3.1.1","application/vnd.ogc.gml","application/vnd.esri.wms_featureinfo_xml","text/html","text/plain","text/xml"],TC.wrap.layer.Raster.prototype.getWMTSLayer=function(){var e=null,t=this,r=t.parent.capabilities;if(r&&r.Contents)for(var o=0;o<r.Contents.Layer.length;o++)for(var a=r.Contents.Layer[o],n=0;n<a.TileMatrixSetLink.length;n++)if(t.parent.options.matrixSet===a.TileMatrixSetLink[n].TileMatrixSet){e=a;break}return e},TC.wrap.layer.Raster.prototype.getTileMatrix=function(e){var t=null,r=this,o=r.parent.capabilities;if(o&&o.Contents&&o.Contents.TileMatrixSet)for(var a=0;a<o.Contents.TileMatrixSet.length;a++){var n=o.Contents.TileMatrixSet[a];if(n.Identifier===e){t=n.TileMatrix;break}}return t},TC.wrap.layer.Raster.prototype.getScaleDenominators=function(e){var t=[],r=this;if(e.ScaleDenominator?t=[e.ScaleDenominator,e.ScaleDenominator]:(e.MinScaleDenominator||e.MaxScaleDenominator)&&(t=[e.MaxScaleDenominator,e.MinScaleDenominator]),!t.length&&!r.getName(e)){for(var o=r.getLayerNodes(e),a=-(1/0),n=1/0,i=0,l=o.length;l>i;i++){var s=r.getScaleDenominators(o[i]);s[0]>a&&(a=s[0]),s[1]<n&&(n=s[1])}a>-(1/0)&&1/0>n&&(t=[a,n])}return t},TC.wrap.layer.Raster.prototype.getAttribution=function(e){var t=null;return e&&(t=e.ServiceIdentification?e.ServiceIdentification.Title:e.Service.Title),t},TC.wrap.layer.Raster.prototype.getInfo=function(e){var t=this,r={},o=t.parent.capabilities;if(o&&o.Capability)for(var a=t.getAllLayerNodes(),n=0;n<a.length;n++){var i=a[n];if(t.parent.compareNames(t.getName(i),e)){i.Title&&(r.title=i.Title),i.Abstract&&(r["abstract"]=i.Abstract),r.legend=[];var l=function(e){var t=this.getLegend(e);t.src&&r.legend.push({src:t.src,title:e.Title})},s=function(e,r){if(e.Layer&&e.Layer.length>0)for(var o in e.Layer)s(e.Layer[o],r);else r.apply(t,[e])};if(s(i,l),i.MetadataURL&&i.MetadataURL.length){r.metadata=[];for(var p=0;p<i.MetadataURL.length;p++){var c=i.MetadataURL[p];r.metadata.push({format:c.Format,type:c.type,url:c.OnlineResource})}}r.queryable=i.queryable;break}}return r},TC.wrap.layer.Raster.prototype.getServiceType=function(){var e=null,t=this.parent.capabilities;return t.Capability&&t.Capability.Request&&t.Capability.Request.GetMap?e=TC.Consts.layerType.WMS:t.OperationsMetadata&&t.OperationsMetadata.GetTile&&(e=TC.Consts.layerType.WMTS),e},TC.wrap.layer.Raster.prototype.getServiceTitle=function(){var e=null,t=this.parent.capabilities;return t.Capability&&t.Service?e=t.Service.Title:t.ServiceIdentification&&(e=t.ServiceIdentification.Title),e},TC.wrap.layer.Raster.prototype.getRootLayerNode=function(){var e,t=this;return t.getServiceType()===TC.Consts.layerType.WMS&&(e=t.parent.capabilities.Capability.Layer),e},TC.wrap.layer.Raster.prototype.getName=function(e,t){var r=e.Name;if(r&&t){var o=r.indexOf(":");o>=0&&(r=r.substr(o+1))}return r},TC.wrap.layer.Raster.prototype.getIdentifier=function(e){return e.Identifier},TC.wrap.layer.Raster.prototype.getLayerNodes=function(e){var t=e.Layer;return $.isArray(t)||(t=t?[t]:[]),t},TC.wrap.layer.Raster.prototype.getAllLayerNodes=function(){var e=this;if(!e._layerList)switch(e.getServiceType()){case TC.Consts.layerType.WMS:var t=function o(t){for(var r=[t],a=e.getLayerNodes(t),n=0;n<a.length;n++)r=r.concat(o(a[n]));return r},r=e.getRootLayerNode();e._layerList=r?t(r):[];break;case TC.Consts.layerType.WMTS:e._layerList=e.parent.capabilities.Contents.Layer.slice();break;default:e._layerList=[]}return e._layerList},TC.wrap.layer.Raster.prototype.normalizeLayerNode=function(e){return e},TC.wrap.layer.Raster.prototype.normalizeCapabilities=function(e){return e},TC.wrap.layer.Raster.prototype.getLegend=function(e){var t={},r=e.Style;if(r&&r.length&&r.length&&r[0].LegendURL&&r[0].LegendURL.length){var o=r[0].LegendURL[0];t.src=$("<textarea />").html(o.OnlineResource).text()}return t},TC.wrap.layer.Raster.prototype.isCompatible=function(e){var t=this,r=!0,o=t.parent;switch(t.getServiceType()){case TC.Consts.layerType.WMS:if(o.capabilities&&o.capabilities.Capability&&o.capabilities.Capability.Layer&&o.names.length>0)for(var a=o.names.slice(0),n=function p(r,a,n){var i=!1;if(r)for(var l=0;l<r.length;l++){var s=r[l],c=n||$.inArray(e,s.CRS||s.SRS)>=0;if(o.compareNames(t.getName(s),a)){c&&(i=!0);break}if(p(s.Layer,a,c)){i=!0;break}}return i};a.length>0;)if(!n([o.capabilities.Capability.Layer],a.pop())){r=!1;break}break;case TC.Consts.layerType.WMTS:var i=new RegExp("^urn:ogc:def:crs:"+e.replace(":",":.*:")+"$|^"+e+"$","g");if(r=!1,o.capabilities&&o.capabilities.Contents&&o.capabilities.Contents.TileMatrixSet)for(var l=o.capabilities.Contents.TileMatrixSet,s=0;s<l.length;s++)if(l[s].Identifier===o.options.matrixSet){r=i.test(l[s].SupportedCRS);break}}return r},TC.wrap.layer.Raster.prototype.getCompatibleLayers=function(e){var t=this,r=[],o=t.parent;switch(t.getServiceType()){case TC.Consts.layerType.WMS:if(o.capabilities&&o.capabilities.Capability&&o.capabilities.Capability.Layer){var a=function(e,t,o){var n=o||$.inArray(t,e.CRS||e.SRS)>=0;if(n&&e.Name&&(r[r.length]=e.Name),e.Layer)for(var i=0;i<e.Layer.length;i++)a(e.Layer[i],t,n)};a(o.capabilities.Capability.Layer,e)}break;case TC.Consts.layerType.WMTS:var n=new RegExp("^urn:ogc:def:crs:"+e.replace(":",":.*:")+"$","g");if(o.capabilities&&o.capabilities.Contents&&o.capabilities.Contents.TileMatrixSet)for(var i=o.capabilities.Contents.TileMatrixSet,l=0;l<i.length;l++)n.test(i[l].SupportedCRS)&&(r[r.length]=i[l].Identifier)}return r},TC.wrap.layer.Raster.prototype.setWMTSUrl=function(){var e=this;$.when(e.getLayer()).then(function(t){e.parent.options=e.parent.options||{};var r=t.getSource().getUrls();e.parent.options.urlPattern=r[r.length-1]})};var w=function(e,t){var r=this,o=e.getImage();r.parent.usesSSL?t=t.replace(/^(f|ht)tp?:\/\//i,"https://"):r.parent.usesProxy&&(t=TC.proxify(t)),o.src=r.parent.names.length?t:TC.Consts.BLANK_IMAGE},E=function(e,t){var r=this;r.$events.trigger($.Event(TC.Consts.event.BEFORETILELOAD,{tile:e}));var o=e.getImage();if("function"==typeof window.btoa){for(var a=new XMLHttpRequest,n=t.split("?"),i=n[1].split("&"),l="",s=0;s<i.length;s++){var p=i[s].split("=");p&&p.length>1&&p[1]&&"LAYERS"!==p[0]&&(l+="&"+i[s])}a.open("POST",n[0],!0),a.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),a.responseType="arraybuffer",a.onload=function(t){if(200===this.status){for(var n=new Uint8Array(this.response),i=n.length,l=new Array(i);i--;)l[i]=String.fromCharCode(n[i]);var s=l.join(""),p=a.getResponseHeader("content-type");if(0===p.indexOf("image")){var c=function(){r.$events.trigger($.Event(TC.Consts.event.TILELOAD,{tile:e}))};o.addEventListener("load",c),o.addEventListener("error",c),o.src="data:"+p+";base64,"+window.btoa(s)}}},a.send(l)}};TC.wrap.layer.Raster.prototype.createWmsLayer=function(e,t,r){var o=this,a=null,n=null,i=r&&r.method&&"POST"===r.method;o.$events=$(o),n=i?$.proxy(E,o):$.proxy(w,o);var l=new ol.source.ImageWMS({url:e,crossOrigin:r.map?r.map.options.crossOrigin:void 0,params:t,extent:TC.Cfg.initialExtent,ratio:TC.Cfg.imageRatio,imageLoadFunction:n});l.on(ol.source.Image.EventType.IMAGELOADSTART,function(e){o.$events.trigger($.Event(TC.Consts.event.BEFORETILELOAD,{tile:e.image.getImage()}))}),l.on(ol.source.Image.EventType.IMAGELOADEND,function(e){o.$events.trigger($.Event(TC.Consts.event.TILELOAD,{tile:e.image.getImage()}))}),l.on(ol.source.Image.EventType.IMAGELOADERROR,function(e){o.$events.trigger($.Event(TC.Consts.event.TILELOAD,{tile:e.image.getImage()}))});var s={visible:!!t.LAYERS.length||i,source:l};return r.minResolution&&(s.minResolution=r.minResolution),r.maxResolution&&(s.maxResolution=r.maxResolution),a=new ol.layer.Image(s),a._wrap=o,o.addCommonEvents(a),a},TC.wrap.layer.Raster.prototype.createWmtsLayer=function(e,t,r){var o=this,a=null;o.$events=$(o);var n=ol.source.WMTS.optionsFromCapabilities(o.parent.capabilities,{layer:t,matrixSet:r.matrixSet,crossOrigin:r.map?r.map.options.crossOrigin:void 0,requestEncoding:r.encoding,format:r.format}),i="https:";location.protocol===i&&(n.urls=n.urls.map(function(e){return e.replace("http:",i)})),n.crossOrigin=r.map?r.map.options.crossOrigin:void 0;var l=new ol.source.WMTS(n);l.setTileLoadFunction($.proxy(w,o)),l.on(ol.source.Tile.EventType.TILELOADSTART,function(e){o.$events.trigger($.Event(TC.Consts.event.BEFORETILELOAD,{tile:e.tile.getImage()}))}),l.on(ol.source.Tile.EventType.TILELOADEND,function(e){o.$events.trigger($.Event(TC.Consts.event.TILELOAD,{tile:e.tile.getImage()}))}),l.on(ol.source.Tile.EventType.TILELOADERROR,function(e){o.$events.trigger($.Event(TC.Consts.event.TILELOAD,{tile:e.tile.getImage()}))});var s={source:l};r.minResolution&&(s.minResolution=r.minResolution),r.maxResolution&&(s.maxResolution=r.maxResolution),a=new ol.layer.Tile(s),a._wrap=o;var p=$.proxy(l.getResolutions,l);l.getResolutions=function(){var e=p(),t=a._wrap.parent.getLimitedMatrixSet();if(t&&t.length){var r=t[0].matrixIndex;e=e.slice(r,t.length+r)}return e},o.addCommonEvents(a);var c=l.getResolutions();return a.setMaxResolution(c[0]+1),a.setMinResolution(c[c.length-1]),a},TC.wrap.layer.Raster.prototype.getParams=function(){return this.layer.getSource().getParams()},TC.wrap.layer.Raster.prototype.setParams=function(e){this.layer.getSource().updateParams(e)},TC.wrap.layer.Raster.prototype.getResolutions=function(){if(this.layer.getSource){var e=this.layer.getSource();return e.getResolutions&&e.getResolutions!=goog.abstractMethod?e.getResolutions():[]}return[]},TC.wrap.Geometry={getNearest:function(e,t){var r=new ol.geom.LineString(t);return r.getClosestPoint(e)}};var L=function(e,t,r){if(e){var o=function(o){var a=(r&&r._wrap?r._wrap.parent.options.width:null)||t;if(o>a){var n=a/o;e.setScale(n)}},a=e.getSize();if(a)o(a[0]);else{var n=e.getImage();n.addEventListener("load",function(){o(this.width)})}}},R=function(e,t){var r=e,o=t&&t.wrap&&t.wrap.feature;if("string"==typeof e){var a=e.match(/^\$\{(.+)\}$/);if(a&&o){for(var n=a[1].split("."),i=o.getProperties(),l=0;l<n.length&&void 0!==i;l++)i=i[n[l]];if(void 0===i){i=t.data;for(var l=0;l<n.length&&void 0!==i;l++)i=i[n[l]]}r=i}}else $.isFunction(e)&&(r=e(t));return r},M=function(e,t){var r,o={};t&&(r=t._wrap?t._wrap.parent:{id:TC.wrap.Feature.prototype.getId.call({feature:t}),features:t.get("features"),getData:function(){return TC.wrap.Feature.prototype.getData.call({feature:t})}});var a,n=r&&$.isArray(r.features)&&r.features.length>1&&e.cluster;a=n?e.cluster.styles||TC.Cfg.styles.cluster:e.styles||TC.Cfg.styles,a.line&&(o.stroke=new ol.style.Stroke({color:R(a.line.strokeColor,r),width:R(a.line.strokeWidth,r),lineDash:a.line.lineDash})),a.polygon&&(o.fill=new ol.style.Fill({color:d(R(a.polygon.fillColor,r),R(a.polygon.fillOpacity,r))}),o.stroke=new ol.style.Stroke({color:R(a.polygon.strokeColor,r),width:R(a.polygon.strokeWidth,r),lineDash:a.polygon.lineDash}));var i=function(e){var t={text:""+R(e.label,r)};return e.fontSize&&(t.font=R(e.fontSize,r)+"pt sans-serif"),e.angle&&(t.rotation=-Math.PI*R(e.angle,r)/180),e.fontColor&&(t.fill=new ol.style.Fill({color:d(R(e.fontColor,r),1)})),e.labelOutlineColor&&(t.stroke=new ol.style.Stroke({color:d(R(e.labelOutlineColor,r),1),width:R(e.labelOutlineWidth,r)})),e.labelOffset&&(t.offsetX=e.labelOffset[0],t.offsetY=e.labelOffset[1]),new ol.style.Text(t)};if(a.point){var l=a.point,s={radius:R(l.radius,r)||(R(l.height,r)+R(l.width,r))/4};l.fillColor&&(s.fill=new ol.style.Fill({color:d(R(l.fillColor,r),R(l.fillOpacity,r))})),l.strokeColor&&(s.stroke=new ol.style.Stroke({color:R(l.strokeColor,r),width:R(l.strokeWidth,r),lineDash:l.lineDash})),isNaN(s.radius)||(o.image=new ol.style.Circle(s)),l.label&&(o.text=i(l))}if(a.marker){var p=a.marker;p.url&&(o.image=new ol.style.Icon({crossOrigin:"anonymous",anchor:p.anchor,src:p.url})),p.label&&(o.text=i(p))}return[new ol.style.Style(o)]};TC.wrap.layer.Vector.prototype.reloadSource=function(){var e=this,t=new $.Deferred,r=e.createVectorSource(e.parent,e.createStyles(e.parent));if(e.parent.type===TC.Consts.layerType.WFS)var o=r.source.on("change",function(e){"ready"==r.source.getState()&&(ol.Observable.unByKey(o),t.resolve())});var a=e.layer.getSource().getFeatures();return e.layer.setSource(r.source),r.style&&e.layer.setStyle(r.style),e.parent.type!=TC.Consts.layerType.WFS&&(r.source.addFeatures(a),t.resolve()),t},TC.wrap.layer.Vector.prototype["import"]=function(e){var t=this,r=$.extend({},e);r.type=e.format;var o=t.layer.getSource().getFeatures(),a=t.createVectorSource(r,t.createStyles(t.parent));t.layer.setSource(a.source),a.style&&t.layer.setStyle(a.style),a.source.addFeatures(o)},TC.wrap.layer.Vector.prototype.createVectorSource=function(e,t){var r,o,a=this,n=function(e){var t=e.indexOf("?");switch(t>=0?e=e.substr(0,t):(t=e.indexOf("#"),t>=0&&(e=e.substr(0,t))),e.substr(e.lastIndexOf(".")+1).toLowerCase()){case"kml":return TC.Consts.layerType.KML;case"gpx":return TC.Consts.layerType.GPX;case"json":case"geojson":return TC.Consts.layerType.GEOJSON;default:return TC.Consts.layerType.VECTOR}};if($.isArray(e.url)||e.urls){var i=e.urls||e.url;i=$.map(i,function(e,t){return TC.proxify(e)}),o={url:i,format:new ol.format.KML({showPointNames:!1}),projection:e.crs}}else if(e.url&&e.type!==TC.Consts.layerType.WFS)o={url:TC.proxify(e.url),projection:e.crs},o.format=h(n(e.url))||h(e.type);else if(e.data)o={projection:e.crs,loader:function(t,r,o){var n=this.getFormat();try{var i=n.readFeatures(e.data,{featureProjection:o});this.addFeatures(i)}catch(l){a.parent.map&&a.parent.map.$events.trigger($.Event(TC.Consts.event.LAYERERROR,{layer:a.parent,reason:l.message}))}}},o.format=h(e.format)||h(e.type);else if(e.type==TC.Consts.layerType.WFS){var l,s;switch(e.outputFormat){case TC.Consts.format.JSON:l=new ol.format.GeoJSON({geometryName:e.geometryName}),s="json";break;case TC.Consts.format.GML3:l=new ol.format.GML3,s=TC.Consts.mimeType.GML;break;default:l=new ol.format.GML2,s=TC.Consts.mimeType.GML}o={format:l,loader:function(t,r,o){var n=this,i=e.url;if(i){a.parent.state=TC.Layer.state.LOADING,a.parent.map.$events.trigger($.Event(TC.Consts.event.BEFORELAYERUPDATE,{layer:a.parent}));var p={},c=o.getCode(),u=e.version||"1.1.0",g=i,f=$.isArray(e.featureType)?e.featureType:[e.featureType];if(!e.properties||e.properties instanceof Array&&!e.properties.length||!Object.keys(e.properties).length)g=g+"?service=WFS&version="+u+"&request=GetFeature&typename="+f.join(",")+"&outputFormat="+s+"&srsname="+c,t[0]!==-(1/0)&&t[1]!==-(1/0)&&t[2]!==1/0&&t[3]!==1/0&&(g=g+"&bbox="+t.join(",")+","+c),e.maxFeatures&&(g=g+"maxFeatures="+e.maxFeatures);else{p.type="POST",p.contentType=TC.Consts.mimeType.XML,p.processData=!1;var m=[];m[m.length]='<wfs:GetFeature xmlns:wfs="http://www.opengis.net/wfs" service="WFS" version="',m[m.length]=u,m[m.length]='" outputFormat="',m[m.length]=e.outputFormat,e.maxFeatures&&(m[m.length]='" maxFeatures="',m[m.length]=e.maxFeatures),m[m.length]='" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.opengis.net/wfs http://schemas.opengis.net/wfs/',m[m.length]=u,m[m.length]='/wfs.xsd">';for(var y=0;y<f.length;y++){if(m[m.length]='<wfs:Query typeName="feature:',m[m.length]=f[y],m[m.length]='" srsName="',m[m.length]=c,m[m.length]='">',m[m.length]='<ogc:Filter xmlns:ogc="http://www.opengis.net/ogc">',(e.properties.length>1||Object.keys(e.properties).length>1)&&(m[m.length]="<ogc:And>"),e.properties instanceof Array)for(var d=0;d<e.properties.length;d++){var v=e.properties[d];m[m.length]='<ogc:PropertyIsEqualTo matchCase="true"><ogc:PropertyName>',m[m.length]=v.name,m[m.length]="</ogc:PropertyName><ogc:Literal>",m[m.length]=v.value,m[m.length]="</ogc:Literal></ogc:PropertyIsEqualTo>"}else if(e.properties instanceof Object)for(var d=0;d<e.properties[f[y]].length;d++){var v=e.properties[f[y]][d];m[m.length]='<ogc:PropertyIsEqualTo matchCase="true"><ogc:PropertyName>',m[m.length]=v.name,m[m.length]="</ogc:PropertyName><ogc:Literal>",m[m.length]=v.value,m[m.length]="</ogc:Literal></ogc:PropertyIsEqualTo>"}(e.properties.length>1||Object.keys(e.properties).length>1)&&(m[m.length]="</ogc:And>"),m[m.length]="</ogc:Filter></wfs:Query>"}m[m.length]="</wfs:GetFeature>",p.data=m.join("")}p.url=g,a._requestUrl=g,$.ajax(p).done(function(e){n.addFeatures(l.readFeatures(e)),a.parent.state=TC.Layer.state.IDLE,a.parent.map.$events.trigger($.Event(TC.Consts.event.LAYERUPDATE,{layer:a.parent}))})}},projection:e.crs}}r=new ol.source.Vector(o),r._tcLayer=a.parent;var p=e.style&&e.style.marker?e.style.marker:TC.Cfg.styles.marker;if(e.style&&e.style.marker||(p=$.extend({},p,{anchor:TC.Cfg.styles.point.anchor})),e.cluster&&(r=new ol.source.Cluster({projection:e.crs,distance:e.cluster.distance,source:r}),e.cluster.animation)){var c=function(e,t,r,o){var a=Math.min((Date.now()-o)/r,1),n=(t[0]-e[0])*a,i=(t[1]-e[1])*a;return[e[0]+n,e[1]+i]},u=function(e,t){var r=Date.now(),o=e.getGeometry().getCoordinates(),a=t.getGeometry().getCoordinates();t.setGeometry(new ol.geom.Point(o));var n=function i(){var n=c(o,a,TC.Consts.CLUSTER_ANIMATION_DURATION,r);t.setGeometry(new ol.geom.Point(n)),n[0]!==a[0]&&n[1]!==a[1]?requestAnimationFrame(i):g.splice($.inArray(e,g),1)};requestAnimationFrame(n)},g=[];r.addEventListener(ol.source.Vector.EventType.REMOVEFEATURE,function(e){var t=e.feature.get("features");t&&t.length>1&&g.push(e.feature)}),r.addEventListener(ol.source.Vector.EventType.ADDFEATURE,function(e){var t=e.feature.get("features");if(t){var r=t[0].getGeometry().getCoordinates();if(t.length>1){var o=$.grep(g,function(e){var t=e.getGeometry().getCoordinates();return t[0]===r[0]&&t[1]===r[1]});o.length&&g.splice($.inArray(o[0],g),1)}var a=$.grep(g,function(e){var t=e.get("features");if(t&&t.length>0){var o=$.grep(t,function(e){var t=e.getGeometry().getCoordinates();return t[0]===r[0]&&t[1]===r[1]});return o.length>0}});a.length&&u(a[a.length-1],e.feature)}})}var f=r;do f.addEventListener(ol.source.Vector.EventType.ADDFEATURE,function(e){var t=e.feature,r=t.getStyle();$.isFunction(r)&&(r=r.call(t)),$.isArray(r)&&(r=r[0]),r&&L(r.getImage(),p.width,t)}),f=$.isFunction(f.getSource)?f.getSource():null;while(f);var m=function(e){var t=null,r=e.getStyle();if($.isFunction(r)&&(r=r.call(e,e)),$.isArray(r)&&(r=r[0]),r){var o=r.getImage();o instanceof ol.style.Icon&&(t=o.getSrc())}return t};r.addEventListener(ol.source.Vector.EventType.ADDFEATURE,function(e){var t=e.feature;if(!t._wrap){var r,o=t.getGeometry();o instanceof ol.geom.Point?r=m(t)?a.parent.addMarker(t):a.parent.addPoint(t):o instanceof ol.geom.LineString?r=a.parent.addPolyline(t):o instanceof ol.geom.Polygon?r=a.parent.addPolygon(t):o instanceof ol.geom.MultiLineString?r=a.parent.addMultiPolyline(t):o instanceof ol.geom.MultiPolygon&&(r=a.parent.addMultiPolygon(t));var n;$.when(r).then(function(e){var r=t.get("features");$.isArray(r)&&(e.features=$.map(r,function(t){return new e.constructor(t)})),clearTimeout(n),n=setTimeout(function(){a.parent.map.$events.trigger($.Event(TC.Consts.event.FEATURESADD,{layer:a.parent,features:[e]}))},50)})}}),r.addEventListener(ol.source.Vector.EventType.REMOVEFEATURE,function(e){var t=e.feature;if(t._wrap){var r=$.inArray(t._wrap.parent,a.parent.features);r>-1&&(a.parent.features.splice(r,1),a.parent.map.$events.trigger($.Event(TC.Consts.event.FEATUREREMOVE,{layer:a.parent,feature:t._wrap.parent})))}}),r.addEventListener(ol.source.Vector.EventType.ADDFEATURE,function(e){a.parent.map.$events.trigger($.Event(TC.Consts.event.VECTORUPDATE,{layer:a.parent}))}),r.addEventListener(ol.source.Vector.EventType.REMOVEFEATURE,function(){a.parent.map.$events.trigger($.Event(TC.Consts.event.VECTORUPDATE,{layer:a.parent}))});var y={source:r};return o&&o.format instanceof ol.format.KML||(y.style=t||e.styles),y},TC.wrap.layer.Vector.prototype.createStyles=function(e){var t=this,r=!1;if($.isFunction(e))r=!0,t.styleFunction=function(t){return M(e(t))};else{e=$.extend({},e),e.crs=e.crs||TC.Cfg.crs,e.styles=e.styles||TC.Cfg.styles;var o=function n(e){for(var t in e){var r=e[t];switch(typeof r){case"string":if(/^\$\{(.+)\}$/.test(r))return!0;break;case"object":if(n(r))return!0;break;case"function":return!0}}return!1};r=!(!e.cluster||!e.cluster.styles)||o(e.styles),t.styleFunction=function(e){return M(t.parent.options,e)}}var a=r?t.styleFunction:t.styleFunction();return a},TC.wrap.layer.Vector.prototype.createVectorLayer=function(){var e=this,t=null;e.$events=$(e);var r=e.parent.options,o=e.createVectorSource(r,e.createStyles(r));return t=new ol.layer.Vector(o),t._wrap=e,e.addCommonEvents(t),t},TC.wrap.layer.Vector.prototype.addFeatures=function(e){$.when(this.getLayer()).then(function(t){for(var r=t;$.isFunction(r.getSource);)r=r.getSource();r.addFeatures(e)})},TC.wrap.layer.Vector.prototype.getFeatures=function(){var e=this.getLayer();return e instanceof ol.layer.Layer?e.getSource().getFeatures():[]},TC.wrap.layer.Vector.prototype.getFeatureById=function(e){var t=this.getLayer();return t instanceof ol.layer.Layer?t.getSource().getFeatureById(e):null},TC.wrap.layer.Vector.prototype.removeFeature=function(e){$.when(this.getLayer()).then(function(t){var r=t.getSource();r.removeFeature(e.wrap.feature)})},TC.wrap.layer.Vector.prototype.clearFeatures=function(){$.when(this.getLayer()).then(function(e){var t=e.getSource();t.clearFeatures?t.clearFeatures():t.clear()})},TC.wrap.layer.Vector.prototype.setFeatureVisibility=function(e,t){var r=this,o={color:"rgba(0, 0, 0, 0)"},a={color:"rgba(0, 0, 0, 0)"},n=new ol.style.Style({image:new ol.style.Circle({radius:0,fill:new ol.style.Fill(o),stroke:new ol.style.Stroke(a)}),fill:new ol.style.Fill(o),stroke:new ol.style.Stroke(a)}),i=$.inArray(e,r.parent.features);if(i>=0){var l=e.wrap.feature;t&&l._originalStyle?l.setStyle(l._originalStyle):(l._originalStyle=l.getStyle(),l.setStyle(n)),$.when(r.getLayer()).then(function(e){r.parent.map.$events.trigger($.Event(TC.Consts.event.VECTORUPDATE,{layer:r.parent}))})}},TC.wrap.layer.Vector.prototype.getRGBA=function(e,t){return d(e,t)},TC.wrap.layer.Vector.prototype.findFeature=function(e){},TC.wrap.layer.Vector.prototype.getGetFeatureUrl=function(){return this._requestUrl},TC.wrap.layer.Vector.prototype.getDescribeFeatureTypeUrl=function(){var e=this,t=e.parent,r=t.options.version||"1.1.0",o=t.url,a=$.isArray(t.options.featureType)?t.options.featureType:[t.options.featureType];return o=o+"?service=WFS&version="+r+"&request=DescribeFeatureType&typename="+a.join(",")+"&outputFormat=XMLSCHEMA"},TC.wrap.layer.Vector.prototype.sendTransaction=function(e,t,r){var o=this,a=$.Deferred(),n=function(e){return e.wrap.feature},i=$.map(e,n),l=$.map(t,n),s=$.map(r,n);return e.length||t.length||r.length?$.when(o.getLayer()).then(function(e){var t=(e.getSource(),new ol.format.WFS),r=o.parent.options,n=t.writeTransaction(i,l,s,{featurePrefix:r.featurePrefix,featureNS:r.featureNS,featureType:r.featureType[0]}),p={url:o.parent.url,type:"POST",contentType:TC.Consts.mimeType.XML,processData:!1,data:n.outerHTML};$.ajax(p).done(function(e){var r=e.getElementsByTagName("ExceptionReport")[0],o={reason:""};if(r){var n=r.getElementsByTagName("Exception")[0];if(n){o.code=n.getAttribute("exceptionCode");for(var i=n.getElementsByTagName("ExceptionText"),l=0,s=i.length;s>l;l++)o.reason+="\n"+i[l].innerHTML}a.reject(o)}else{var p=t.readTransactionResponse(e);a.resolve(p)}}).fail(function(){a.reject({code:"",reason:"unknown"})})}):a.resolve(o.parent),a},TC.wrap.layer.Vector.prototype.setDraggable=function(e,t,r){var o=this;$.when(o.parent.map.wrap.getMap(),o.getLayer()).then(function(a,n){if(e){var i={layers:[n],features:new ol.Collection(n.getSource().getFeatures())};o.interaction=new ol.interaction.Translate(i),$.isFunction(t)&&o.interaction.on(ol.interaction.Translate.EventType.TRANSLATEEND,function(e){e.features.getLength()&&t(e.features.item(0)._wrap.parent)}),$.isFunction(r)&&o.interaction.on(ol.interaction.Translate.EventType.TRANSLATESTART,function(e){e.features.getLength()&&r(e.features.item(0)._wrap.parent)}),a.addInteraction(o.interaction)}else o.interaction&&a.removeInteraction(o.interaction)})},TC.wrap.control.Click.prototype.register=function(e){var t=this;t._trigger=function(r){var o=0;return e.wrap.map.forEachFeatureAtPixel(r.pixel,function(e,t){e._wrap&&e._wrap.parent.showsPopup&&o++}),o||(t.parent.map.$events.trigger($.Event(TC.Consts.event.CLICK,{coordinate:r.coordinate,pixel:r.pixel})),t.parent.callback(r.coordinate,r.pixel)),0===o}},TC.wrap.control.Click.prototype.activate=function(){var e=this;$.when(e.parent.map.wrap.getMap()).then(function(t){t.on(ol.MapBrowserEvent.EventType.SINGLECLICK,e._trigger)})},TC.wrap.control.Click.prototype.deactivate=function(){var e=this;$.when(e.parent.map.wrap.getMap()).then(function(t){t.un(ol.MapBrowserEvent.EventType.SINGLECLICK,e._trigger)})},TC.wrap.control.ScaleBar.prototype.render=function(){var e=this;e.ctl?e.ctl.updateElement_():e.ctl=new ol.control.ScaleLine({target:e.parent.div})},TC.wrap.control.ScaleBar.prototype.getText=function(){var e=this;return e.ctl?e.ctl.renderedHTML_:void 0},TC.wrap.control.NavBar.prototype.register=function(e){var t=this;$.when(e.wrap.getMap()).then(function(r){var o=t.parent.div;t.zCtl=new ol.control.Zoom({target:o}),t.zsCtl=new ol.control.ZoomSlider({target:o,render:function(e){if(!e.frameState||!e.frameState.viewState||r.getView().getMinResolution()<=e.frameState.viewState.resolution){var o=function(){this.element.offsetWidth>this.element.offsetHeight?(t.requestSliderSize||(t.requestSliderSize=window.requestAnimationFrame(o.bind(this))),window.requestAnimationFrame(o.bind(this))):this.element.offsetWidth<this.element.offsetHeight&&(t.requestSliderSize&&(window.cancelAnimationFrame(t.requestSliderSize),delete t.requestSliderSize),ol.control.ZoomSlider.render.call(this,e))};o.call(this)}}}),t.z2eCtl=new ol.control.ZoomToExtent({target:o,extent:e.options.initialExtent,tipLabel:""}),r.addControl(t.zCtl),r.addControl(t.zsCtl),r.addControl(t.z2eCtl);var a=t.parent._$div;$buttons=a.find("button").addClass("tc-ctl-btn "+t.parent.CLASS+"-btn").css("display","block").html(""),$buttons.filter(".ol-zoom-in").addClass(t.parent.CLASS+"-btn-zoomin").attr("title",t.parent.getLocaleString("zoomIn")),$buttons.filter(".ol-zoom-out").addClass(t.parent.CLASS+"-btn-zoomout").attr("title",t.parent.getLocaleString("zoomOut")),a.find(".ol-zoom-extent button").addClass(t.parent.CLASS+"-btn-home").attr("title",t.parent.getLocaleString("zoomToInitialExtent")),$(e.div).find(".ol-zoomslider").addClass(t.parent.CLASS+"-bar").find(".ol-zoomslider-thumb").addClass(t.parent.CLASS+"-slider"),e.on(TC.Consts.event.BASELAYERCHANGE,$.proxy(t.refresh,t))})},TC.wrap.control.NavBar.prototype.refresh=function(){var e=this,t=e.parent.map.wrap.map;if(e.zsCtl.sliderInitialized_){var r=t.getView().getResolution();e.zsCtl.setThumbPosition_(r)}else t.once(ol.MapEvent.Type.POSTRENDER,function(t){e.zsCtl.render(t)})},TC.wrap.control.Coordinates.prototype.register=function(r){var o=this,a=new $.Deferred;return o.map=r,o._cleanCoordsTrigger=function(e){var t=o.map.getControlsByClass(TC.control.Popup)[0];e.toElement&&$(e.toElement).attr("class")&&t&&$(e.toElement).attr("class").indexOf(t.CLASS)>-1?o.parent.coordsToClick({coordinate:[(o.map.getExtent()[0]+o.map.getExtent()[2])/2,(o.map.getExtent()[1]+o.map.getExtent()[3])/2]}):o.parent.cleanCoordsPointer(e)},o._coordsTrigger=function(e){o.parent.coordsToClick(e)},$.when(r.wrap.getMap()).then(function(r){o.olMap=r;var n=r.getView().getProjection();o.parent.crs=n.getCode(),o.parent.units=n.getUnits(),o.parent.isGeo=o.parent.units===ol.proj.Units.DEGREES;var i=r.getViewport();$(i).add(o.parent.div).on(e+".coords",function(e){var t=r.getEventCoordinate(e);t&&(o.parent.isGeo?o.parent.latLon=t.reverse():o.parent.xy=t,o.parent.update.apply(o.parent,arguments))}).on(t,function(e){o.parent.clear.apply(o.parent,arguments)}),a.resolve()}),a},TC.wrap.control.Geolocation.prototype.register=function(e){var t=this;t.map=e,t._snapTrigger=function(e){e.dragging||t.initSnap(t.olMap.getEventCoordinate(e.originalEvent))},t._postcomposeTrigger=function(e){t.duringTrackSnap(e)},$.when(e.wrap.getMap()).then(function(e){t.olMap=e})},TC.wrap.control.Geolocation.prototype.hasCoordinates=function(){var e=this;return e.trackData&&e.trackData.trackFeature&&e.trackData.trackFeature.getGeometry().getCoordinates().length>=1};var _=function(e,t){var r=t-e,o={s:Math.floor(r/1e3%60),m:Math.floor(r/6e4%60),h:Math.floor(r/36e5%24)};return $.extend({},o,{toString:("00000"+o.h).slice(-2)+":"+("00000"+o.m).slice(-2)+":"+("00000"+o.s).slice(-2)})};TC.wrap.control.Geolocation.prototype.getTooltip=function(e){var t=this;t.parent.elevationMarker||(t.parent.elevationMarker=new ol.Overlay({element:t.parent.track.htmlElevationMarker,offset:[0,-11],positioning:ol.Overlay.Positioning.CENTER_CENTER,stopEvent:!1})),t.parent.layerTrack.getVisibility()&&t.parent.layerTrack.getOpacity()>0&&($(t.parent.track.htmlElevationMarker).show(),t.olMap.addOverlay(t.parent.elevationMarker),t.parent.elevationMarker.setPosition(t.parent.chart.coordinates[e[0].index]));var r=t.map.getExtent(),o=t.parent.chart.coordinates[e[0].index];r[0]<=o[0]&&o[0]<=r[2]&&r[1]<=o[1]&&o[1]<=r[3]||TC.loadJS(!TC.feature||TC.feature&&!TC.feature.Point,[TC.apiLocation+"TC/feature/Point.js"],function(){t.map.setCenter(o.slice(0,2),{animate:!0})});var a=e[0].x;a/=1e3;var n;4==t.parent.chart.coordinates[0].length&&t.parent.chart.coordinates[0][3]>0&&(n=_(t.parent.chart.coordinates[0][3],o[3]));var i,l,s=t.parent.map.options.locale&&t.parent.map.options.locale.replace("_","-")||void 0,p=parseInt(e[0].value.toFixed(0)).toLocaleString(s);return 1>a?(i=Math.round(1e3*a),l=" m"):(i=Math.round(100*a)/100,l=" km"),i=i.toLocaleString(s),'<div class="track-elevation-tooltip"><div><span>'+p+" m </span><br><span>"+i+l+" </span></div>"+(n?"<span>"+n.toString+"</span><div/>":"")},TC.wrap.control.Geolocation.prototype.addWaypoint=function(e,t){var r=this,o=new ol.Feature({geometry:new ol.geom.Point([e[0],e[1],t.ele,t.time],"XYZM")});o.setProperties(t),r.parent.layerTracking.wrap.layer.getSource().addFeature(o)};var P=!0,A=function(e,t){var r=e.getGeometry(),o=r.getType().toLowerCase(),a=!P,n=[];return n.push(new ol.style.Style({stroke:new ol.style.Stroke({width:2,color:"rgba(0,206,209, "+(a&&e.get("tracking")?0:1)+")",lineDash:[.1,6]})})),"point"!=o||a||n.push(new ol.style.Style({image:new ol.style.Circle({radius:3,fill:new ol.style.Fill({color:"rgba(0,206,209, "+(a&&e.get("tracking")?0:.5)+")"}),stroke:new ol.style.Stroke({color:"rgba(255, 255, 255, "+(a&&e.get("tracking")?0:1)+")",width:1})}),text:new ol.style.Text({textAlign:"center",textBaseline:"middle",font:"bold 14px Arial",text:a&&e.get("tracking")?"":e.get("name"),fill:new ol.style.Fill({color:"rgba(0,206,209, "+(a&&e.get("tracking")?0:1)+")"}),stroke:new ol.style.Stroke({color:"rgba(255, 255, 255, "+(a&&e.get("tracking")?0:1)+")",width:parseInt(3,10)}),offsetX:parseInt(0,10),offsetY:parseInt(0,10)})})),n};TC.wrap.control.Geolocation.prototype.setTrackOnMapVisibility=function(e){var t=this;P=e,t.parent.layerTracking.wrap.layer.setStyle(A)},TC.wrap.control.Geolocation.prototype.addPosition=function(e,t,r,o,a,n,i){var l=this,s=Math.round(e[0]),p=Math.round(e[1]);if(l.trackData&&l.trackData.trackFeature){var c=l.trackData.trackFeature.getGeometry().getLastCoordinate();if(c&&0==c.length)l.trackData.trackFeature.getGeometry().appendCoordinate([s,p,t,r]);
else{var u=Math.round(c[0]),g=Math.round(c[1]);(s!=u||p!=g)&&l.trackData.trackFeature.getGeometry().appendCoordinate([s,p,t,r])}}l.parent.$events.trigger($.Event(l.parent.Const.Event.STATEUPDATED,{moving:void 0!=t&&void 0!=o&&o>0&&t>0}))},TC.wrap.control.Geolocation.prototype.positionChangehandler=function(e){var t,r,o,a,n,i=this,l=$.Deferred();if(e&&e.coords)if(i.parent.layerGPS.clearFeatures(),t=e.coords.accuracy||0,r=e.coords.heading||e[2]||0,o=e.coords.speed?3.6*e.coords.speed:0,a=e.coords.altitude||0,n=e.coords.altitudeAccuracy||0,i.trackData&&i.trackData.trackFeature){var s=[e.coords&&e.coords.longitude||e[0],e.coords&&e.coords.latitude||e[1]],p=TC.Util.reproject(s,"EPSG:4326",i.parent.map.crs);i.addPosition(p,r,(new Date).getTime(),o,t,n,a);var c=i.trackData.trackFeature.getGeometry().getCoordinates(),u=c.length;u>=2&&(i.parent.deltaMean=(c[u-1][3]-c[0][3])/(u-1)),i.parent.$events.trigger($.Event(i.parent.Const.Event.POSITIONCHANGE,{pd:{position:[p[0],p[1]],altitude:a,accuracy:t,heading:TC.Util.radToDeg(r),speed:o}})),$.when(i.parent.layerGPS.addPoint(p,{radius:4,fillColor:"#00CED1",fillOpacity:1,strokeColor:"#ffffff",strokeWidth:2,showsPopup:!1}),i.parent.layerGPS.addCircle([p,t],{strokeColor:"#00CED1",strokeWidth:.4,fillColor:"#ffffff",fillOpacity:.2,showsPopup:!1})).done(function(e,t){i.parent.geopositionTracking=!0,0==i.parent.firstPosition&&(i.parent.firstPosition=!0,i.parent.$centerDiv?i.parent.$centerDiv.toggleClass(TC.Consts.classes.HIDDEN,!1):(i.parent.$centerDiv=i.parent._$div.find("."+i.parent.CLASS+"-track-center"),i.parent.$button=i.parent._$div.find("."+i.parent.CLASS+"-track-center button"),i.parent.$button.on("click",function(){i.parent.layerGPS.map.zoomToFeatures(i.parent.layerGPS.features),i.parent.track.$info.find(".prsidebar-body").fadeIn("slide"),i.parent.track.$info.find(".prcollapsed").hide()}),i.parent.$centerDiv.appendTo(i.parent.map._$div),i.parent.$centerDiv.toggleClass(TC.Consts.classes.HIDDEN,!1)),i.parent.layerGPS.map.zoomToFeatures(i.parent.layerGPS.features)),l.resolve({marker:e,accuracy:t})})}else l.resolve(null);else l.resolve(null);return l.promise()},TC.wrap.control.Geolocation.prototype.setTracking=function(e){function t(){var e=s++;navigator.geolocation.getCurrentPosition(function(e){clearInterval(l),r.parent.getLoadingIndicator().removeWait(r.parent.currentPositionWaiting),r.positionChangehandler(e).then(function(e){1==r.parent.geopositionTracking&&e&&e.marker&&e.accuracy&&(r.currentPositionTrk=navigator.geolocation.watchPosition(r.positionChangehandler.bind(r),r.parent.onGeolocateError.bind(r.parent),p))})},function(e){switch(e.code){case e.TIMEOUT:t();break;default:clearInterval(l),r.parent.onGeolocateError.call(r.parent,e)}},{timeout:5e3+e,maximumAge:10,enableHighAccuracy:!0})}var r=this;if(e){r.parent.firstPosition=!1,r.trackData={};var o=[];if(r.parent.sessionTracking)for(var a=(new ol.format.GeoJSON).readFeatures(r.parent.sessionTracking),n=0;n<a.length;n++){var i=a[n].getGeometry().getType().toLowerCase();"point"==i?o.push(a[n]):"linestring"==i&&(r.trackData.trackFeature=a[n],r.trackData.trackFeature.setProperties({tracking:!0}))}else r.trackData.trackFeature=new ol.Feature({geometry:new ol.geom.LineString([],"XYZM"),tracking:!0});r.parent.layerTracking.wrap.layer.setSource(new ol.source.Vector({features:[r.trackData.trackFeature]})),o.length>0&&r.parent.layerTracking.wrap.addFeatures(o),r.parent.layerTracking.wrap.layer.setStyle(A),r.trackData.trackFeature.getGeometry().getCoordinates().length>1&&r.parent.map.setExtent(r.parent.layerTracking.wrap.layer.getSource().getExtent()),r.parent.currentPositionWaiting=r.parent.getLoadingIndicator().addWait();var l,s=0,p={enableHighAccuracy:!0,timeout:6e5};l=setInterval(t,1e3),setTimeout(function(){r.trackData&&0==r.trackData.trackFeature.getGeometry().getLastCoordinate().length&&(clearInterval(l),r.parent.getLoadingIndicator().removeWait(r.parent.currentPositionWaiting),r.map.toast(r.parent.getLocaleString("geo.error.permission_denied"),{type:TC.Consts.msgType.WARNING}),r.parent.track.$activateButton.toggleClass(TC.Consts.classes.HIDDEN,!1),r.parent.track.$deactivateButton.toggleClass(TC.Consts.classes.HIDDEN,!0))},p.timeout+1e3)}else P=!0,r.parent.firstPosition=!1,window.navigator.geolocation.clearWatch(r.currentPositionTrk),delete r.trackData,r.parent.$centerDiv&&r.parent.$centerDiv.toggleClass(TC.Consts.classes.HIDDEN,!0)},TC.wrap.control.Geolocation.prototype.activateSnapping=function(){var e=this;P=!0,TC.Util.detectMobile()||(e.olMap.on([ol.MapBrowserEvent.EventType.POINTERMOVE,ol.MapBrowserEvent.EventType.SINGLECLICK],e._snapTrigger),e.olMap.on(ol.render.Event.Type.POSTCOMPOSE,e._postcomposeTrigger))},TC.wrap.control.Geolocation.prototype.deactivateSnapping=function(){var e=this;$.when(e.parent.map.wrap.getMap()).then(function(t){TC.Util.detectMobile()||(t.un([ol.MapBrowserEvent.EventType.POINTERMOVE,ol.MapBrowserEvent.EventType.SINGLECLICK],e._snapTrigger),t.un(ol.render.Event.Type.POSTCOMPOSE,e._postcomposeTrigger)),e.snapInfo&&t.removeOverlay(e.snapInfo),e.snapInfoElement&&(e.snapInfoElement.style.display="none"),e.snapLine&&(delete e.snapLine,t.render())})},TC.wrap.control.Geolocation.prototype.clear=function(e){var t=this;e&&e.wrap.layer&&(e.wrap.layer.getSource().clear(),e.wrap.layer.setSource(new ol.source.Vector)),I=!1,t.deactivateSnapping.call(t)};var x;TC.wrap.control.Geolocation.prototype.duringTrackSnap=function(e){var t=this,r=x=e.vectorContext;r&&t.snapLine&&("function"==typeof r.setFillStrokeStyle&&r.setFillStrokeStyle(null,new ol.style.Stroke({color:"rgba(197, 39, 55, 1)",width:1})),"function"==typeof r.drawGeometry&&r.drawGeometry(t.snapLine.wrap.feature.getGeometry()))},TC.wrap.control.Geolocation.prototype.initSnap=function(e){var t=this;if(t.parent.layerTrack){var r=t.parent.layerTrack.wrap.layer.getSource(),o=r.getClosestFeatureToCoordinate(e);if(null!==o){var a=o.getGeometry(),n=a.getClosestPoint(e),i=[e,[n[0],n[1]]];t.snapLine?t.snapLine.wrap.feature.getGeometry().setCoordinates(i):t.snapLine=new TC.feature.Polyline(i),t.snapInfoElement||(t.snapInfoElement=document.getElementsByClassName("tc-ctl-geolocation-track-snap-info")[0]),t.snapInfoElement.style.display="block",t.snapInfo||(t.snapInfo=new ol.Overlay({element:t.snapInfoElement,offset:[5,18]}),t.olMap.addOverlay(t.snapInfo)),void 0==t.snapInfo.getMap()&&t.snapInfo.setMap(t.olMap),t.snapInfo.setPosition(e);var l={};"LineString"!=o.getGeometry().getType()&&o.getKeys().indexOf("name")>-1&&(l.n=o.get("name"));var s=t.parent.map.options.locale&&t.parent.map.options.locale.replace("_","-")||void 0;l.x=Math.round(n[0]).toLocaleString(s),l.y=Math.round(n[1]).toLocaleString(s),l.z=n.length>=3?(Math.round(100*n[2])/100).toLocaleString(s):void 0,l.m=4==n.length&&n[3]>0?new Date(n[3]).toLocaleString(s):void 0,l&&t.parent.getRenderedHtml(t.parent.CLASS+"-track-snapping-node",l,function(e){t.snapInfoElement.innerHTML=e})}t.olMap.render()}};var I=!1;TC.wrap.control.Geolocation.prototype.drawTrackingData=function(e){var t=this,r=$.Deferred(),o=[],a=new TC.wrap.parser.JSON,n=a.parser.readFeatures(e);t.activateSnapping.call(t),I||($(document).on("mouseover",".tc-ctl-p-results",function(e){t.parent.layerTrack.getVisibility()||0!=t.parent.layerTrack.getOpacity()||t.deactivateSnapping.call(t)}),$(document).on("mouseout",".tc-ctl-p-results",function(e){t.parent.layerTrack.getVisibility()&&t.parent.layerTrack.getOpacity()>0&&t.activateSnapping.call(t)}),I=!0);for(var i=0,l=n.length;l>i;i++)o.push(TC.wrap.Feature.createFeature(n[i]));return $.when.apply($,o).then(function(){for(var e=0;e<arguments.length;e++){var o=arguments[e];o&&t.parent.layerTrack.addFeature(o)}t.parent.map.zoomToFeatures(t.parent.layerTrack.features),r.resolve()}),r.promise()},TC.wrap.control.Geolocation.prototype.formattedToStorage=function(e,t){var r=new TC.wrap.parser.JSON;r=r.parser;var o=e.wrap.layer.getSource().getFeatures();if(t)for(var a=0;a<o.length;a++)o[a].get("tracking")&&o[a].set("tracking",!1);return r.writeFeatures(o)},TC.wrap.control.Geolocation.prototype["export"]=function(e,t){var r=this,o=new $.Deferred,a=[];return r.parent.getTrackingData(t).then(function(n){if(n){var i=new ol.source.Vector({features:(new ol.format.GeoJSON).readFeatures(n)});if(i.getFeatures().length>0)i.forEachFeature(function(e){var t=e.clone();if(t.getGeometry().transform(r.parent.map.crs,"EPSG:4326"),"linestring"==t.getGeometry().getType().toLowerCase()){var o=new ol.geom.MultiLineString([],t.getGeometry().getLayout());o.appendLineString(t.getGeometry()),a.push(new ol.Feature({geometry:o}))}else a.push(t)});else{var l=r.parent.getTrackingData(t),s=new ol.source.Vector({features:(new ol.format.GeoJSON).readFeatures(l)});s.forEachFeature(function(e){var t=e.clone();if(t.getGeometry().transform(r.parent.map.crs,"EPSG:4326"),"linestring"==t.getGeometry().getType().toLowerCase()){var o=new ol.geom.MultiLineString([],t.getGeometry().getLayout());o.appendLineString(t.getGeometry()),a.push(new ol.Feature({geometry:o}))}else a.push(t)})}}switch(e){case"GPX":o.resolve(a?(new ol.format.GPX).writeFeatures(a):null);break;case"KML":o.resolve(a?(new ol.format.KML).writeFeatures(a):null)}}),o};var O=function(e){var t=[],r=[];if(e.length>1){4==e[0].length&&(e=e.sort(function(e,t){return e[0][3]==t[0][3]?0:e[0][3]<t[0][3]?-1:1}));for(var o=0;o<e.length;o++){for(var a=e[o],n=-1,i=1/0,l=a.getLastCoordinate(),s=o+1;s<e.length;s++){var p=e[s].getFirstCoordinate(),c=Math.hypot(l[0]-p[0],l[1]-p[1]);i>c&&(n=s,i=c)}t.length<e.length&&(-1==t.indexOf(o)&&(t.push(o),r=r.concat(a.getCoordinates())),-1==t.indexOf(n)&&(t.push(n),r=r.concat(e[n].getCoordinates())))}return r}return e[0].getCoordinates()};TC.wrap.control.Geolocation.prototype.processImportedFeatures=function(e){for(var t=this,r=t.parent.layerTrack.wrap.layer.getSource(),o=t.parent.importedFileName,a=[],n=[],i=[],l=[],s=r.getFeatures(),p=[],c=[],u=0;u<s.length;u++){var g=s[u];if(g instanceof TC.Feature&&(g=s[u].wrap.feature),g.getGeometry()instanceof ol.geom.Point)c.push(g.getGeometry().getCoordinates()),l.push(g);else if(g.getGeometry()instanceof ol.geom.LineString)p.push(g.getGeometry()),i.push(g);else if(g.getGeometry()instanceof ol.geom.MultiLineString){var f=g.clone();a.push(f.getProperties().hasOwnProperty("name")?f.getProperties().name.trim().length>0?f.getProperties().name:o:o);var m=f.getGeometry().getLineStrings(),y=O(m);n.push(new ol.Feature({geometry:new ol.geom.LineString(y)})),i.push(g)}}if(p.length>0){var y=O(p);n.push(new ol.Feature({geometry:new ol.geom.LineString(y)}))}if(c.length>0&&l.length==s.length&&n.push(new ol.Feature({geometry:new ol.geom.LineString(c)})),i.length>0)for(var d=0;d<i.length;d++)r.removeFeature(i[d]);if(n.length>0){var v,h=function(e,t){for(var r=[],o=e.indexOf(t);-1!=o;)if(r.push(o),o=e.indexOf(t,o+1),r.length>1)return!0;return r.length>1?!0:!1},C=(new $.Deferred,0),T=function(){var e=[];return $.each(n,function(i){var l=new $.Deferred;v&&r.removeFeature(v);var s;if(a.length>i){var s=a[i];h(a,s)&&(s="["+(i+1)+"] "+s)}t.parent.importedFileName=s?s:o,v=n[i],r.addFeature(v),t.parent.saveTrack(t.parent.getLocaleString("geo.trk.upload.ok",{trackName:t.parent.importedFileName})).then(function(e){0==i&&(C=e),l.resolve()}),e.push(l)}),$.when.apply(void 0,e).promise()};T().then(function(){t.parent.$events.trigger(t.parent.Const.Event.IMPORTEDTRACK,C),delete t.parent.importedFileName;var o=t.parent.layerTrack.features;if(o&&o.length>0)for(var a=0;a<o.length;a++)o[a].showsPopup=!1;t.parent.map.setExtent(r.getExtent()),t.parent.getLoadingIndicator().removeWait(e)})}else t.parent.layerTrack&&(t.parent.map.removeLayer(t.parent.layerTrack),t.parent.layerTrack=void 0),delete t.parent.importedFileName,t.parent.getLoadingIndicator().removeWait(e),TC.alert(t.parent.getLocaleString("geo.trk.upload.error4"))},TC.wrap.control.Geolocation.prototype["import"]=function(e,t,r){var o,a,n=this;if(t&&t.text){var i=n.parent.layerTrack.wrap.createVectorSource({data:t.text,type:r});o=i.source,a=o.on("change",function(t){"ready"==o.getState()&&(ol.Observable.unByKey(a),n.processImportedFeatures(e))});var l=n.parent.layerTrack.wrap.layer;l.setSource(o)}else n.parent.layerTrack&&(n.parent.map.removeLayer(n.parent.layerTrack),n.parent.layerTrack=void 0),delete n.parent.importedFileName,n.parent.getLoadingIndicator().removeWait(e),TC.alert(n.parent.getLocaleString("geo.trk.upload.error4"))};var F;TC.wrap.control.Geolocation.prototype.simulateTrackEnd=function(){var e=this;$(e.miProgressTextDiv).remove(),$(e.miProgressDiv).remove(),$(e.miDiv).remove(),e.simulateMarker&&(window.cancelAnimationFrame(F),e.simulateMarker.layer.wrap.layer.getSource().getFeatures().length>0&&e.simulateMarker.layer.removeFeature(e.simulateMarker),delete e.simulateMarker)},TC.wrap.control.Geolocation.prototype.simulateTrack=function(){for(var e,t=this,r=t.parent.layerTrack.wrap.layer.getSource().getFeatures(),o=0;o<r.length;o++)if(r[o].getGeometry()instanceof ol.geom.LineString){e=r[o].getGeometry().getCoordinates();break}if(e&&e.length>0){var a=e[0],n=function(){var e=new $.Deferred;return t.simulateMarker?(t.simulateMarker.setCoords(a.slice(0,2)),e.resolve(t.simulateMarker)):t.parent.layerTrack.addPoint(a.slice(0,2),{radius:7,fillColor:"#ff0000",strokeColor:"#ffffff",strokeWidth:2}).then(function(t){e.resolve(t)}),e};n().then(function(r){t.simulateMarker=r;var o=function(){var r,o,a,n=(e.length,!1);if(t.parent.hasElevation){var i=d3.select(".c3-event-rects,.c3-event-rects-single").node().getBoundingClientRect();$("body").append('<div class="miDiv">'),t.miDiv=$("div.miDiv"),t.miDiv.width(i.width),t.miDiv.height(i.height),t.miDiv.append('<div class="miProgressDiv">'),t.miProgressDiv=$("div.miProgressDiv"),t.miProgressDiv.addClass("tc-ctl-geolocation-track-elevation-chart-progress"),t.miProgressDiv.width("0%"),t.miProgressDiv.height(i.height),t.miProgressDiv.append('<div class="miProgressTextDiv">'),t.miProgressTextDiv=$("div.miProgressTextDiv"),t.miProgressTextDiv.addClass("tc-ctl-geolocation-track-elevation-chart-progress text"),t.miProgressTextDiv.width(i.width),t.miProgressTextDiv.height(i.height),t.miDiv.css({top:i.top,left:i.left,bottom:i.bottom,right:i.right,position:"absolute","z-index":1e4})}var l=e;if(4==l[0].length&&l[0][3]>0)r=l[0][3],o=l[l.length-1][3],n=!0;else{l[0][3]=Date.now();for(var s=1;s<l.length;s++){var p;l[s][3]=0,p=s+1<l.length?new ol.geom.LineString(l.slice(s-1,s+1)).getLength():new ol.geom.LineString(l.slice(s-1)).getLength(),l[s][3]=l[s-1][3]+36e5*p/t.parent.walkingSpeed}r=l[0][3],o=l[l.length-1][3]}var c=new ol.geom.LineString(l),u=r,g=c.getLength(),p=0,f=function(e){for(var t=0;t<l.length;t++)if(l[t][3]>e)return{d:new ol.geom.LineString(l.slice(0,t)).getLength(),p:l[t-1].slice(0,2)}},m=function(){if(!t.parent.simulate_paused){var e=c.getCoordinateAtM(u),r=f(u);if(a>=1||!e||!r){t.simulateTrackEnd();var o=t.parent.getSelectedTrack();return o&&t.parent.uiSimulate(!1,o),$(t.miProgressTextDiv).remove(),$(t.miProgressDiv).remove(),void $(t.miDiv).remove()}if(t.parent.hasElevation){p=r.d;var i=(p+Math.hypot(r.p[0]-e[0],r.p[1]-e[1]))/g*100;t.miProgressDiv.width(i+"%");var s;n&&(s=_(l[0][3],e[3]));var y,d,v=t.parent.map.options.locale&&t.parent.map.options.locale.replace("_","-")||void 0,h=parseInt(e[2].toFixed(0)).toLocaleString(v);1>p/1e3?(y=Math.round(p/1e3*1e3),d=" m"):(y=Math.round(p/1e3*100)/100,d=" km"),y=y.toLocaleString(v),t.miProgressTextDiv.html("<div><span>"+h+" m</span><br><span>"+y+d+"</span></div>"+(n?"<br><span>"+s.toString+"</span>":""))}if(t.simulateMarker){{var C=t.simulateMarker.getCoords(),T=e;180*Math.atan2(T[1]-C[1],T[0]-C[0])/Math.PI}t.simulateMarker.setCoords(e)}u+=1!==t.parent.simulate_speed?t.parent.delta*t.parent.simulate_speed:t.parent.delta}F=requestAnimationFrame(m)};F=requestAnimationFrame(m)},a=new $.Deferred;window.d3?a.resolve():TC.loadJS(!window.d3,[TC.Consts.url.D3C3],function(){a.resolve()}),a.then(function(){F=requestAnimationFrame(o)})})}},TC.wrap.control.Geolocation.prototype.headingChangehandler=function(e){var t=this;t.parent.track.$infoOnMap||(t.parent.track.$infoOnMap=$('<div style="overflow-y: scroll; height: 200px; width: 200px; top: 0; left: 100px; background-color: fuchsia; position: absolute;"></div>').appendTo(t.parent.map._$div)),t.parent.track.$infoOnMap.show(),t.parent.track.$infoOnMap.html(t.parent.track.$infoOnMap.html()+"<br> <p> salta headingChangehandler </p>"),t.parent.track.$infoOnMap.html(t.parent.track.$infoOnMap.html()+"<br> <p> evt.target.getHeading(): "+e.target.getHeading()+" </p>"),t.heading=e.target.getHeading(),$.when(t.map.wrap.getMap()).then(function(e){e.getView().setRotation(-t.heading)}),t.parent.$events.trigger($.Event(t.parent.Const.Event.STATEUPDATED,{moving:void 0!=heading&&heading>0}))},TC.wrap.control.Geolocation.prototype.orientationChangehandler=function(e){var t=this,r=t.map.wrap.map.getView(),o=r.getCenter(),a=r.getResolution(),n=e.target.getBeta()||0,i=e.target.getGamma()||0;o[0]-=a*i*25,o[1]+=a*n*25,r.setCenter(r.constrainCenter(o)),t.parent.$events.trigger($.Event(t.parent.Const.Event.STATEUPDATED,{moving:void 0!=heading&&heading>0}))},TC.wrap.control.Geolocation.prototype.pulsate=function(e){var t=this;t.pulsated=!0;var r,o=e.wrap.feature.getGeometry().getRadius(),a=(new Date).getTime(),n=500,i=function(e){switch(!0){case 50>=e:return o;case e>50&&100>=e:return 1.02*o;case e>100&&150>=e:return 1.05*o;case e>150&&200>=e:return 1.02*o;case e>200&&300>=e:return o;case e>300&&350>=e:return 1.02*o;case e>350&&400>=e:return 1.05*o;case e>400&&450>=e:return 1.02*o;case e>450&&500>=e:return 1*o;default:return o}};r=t.olMap.on(ol.render.Event.Type.POSTCOMPOSE,function(t){var o=t.vectorContext,l=t.frameState,s=l.time-a,p=e.wrap.feature.getGeometry().clone(),c=i(s);return p.setRadius(c),o.setFillStrokeStyle(new ol.style.Fill({color:"rgba(0, 0, 0, 0.1)"}),new ol.style.Stroke({color:"rgba(255, 0, 0, .8)",width:1})),o.drawCircleGeometry(p),s>n?void ol.Observable.unByKey(r):void(l.animate=!0)})},TC.wrap.control.Coordinates.prototype.coordsActivate=function(){var e=this;e.olMap.on(ol.MapBrowserEvent.EventType.SINGLECLICK,e._coordsTrigger);var r=e.olMap.getViewport();$(r).on(t,e._cleanCoordsTrigger)},TC.wrap.control.Coordinates.prototype.coordsDeactivate=function(){var e=this;e.olMap.un(ol.MapBrowserEvent.EventType.SINGLECLICK,e._coordsTrigger);var r=e.olMap.getViewport();$(r).off(t,e._cleanCoordsTrigger)},TC.wrap.Parser=function(){},TC.wrap.Parser.prototype.read=function(e){var t=[],r=this;return r.parser&&(TC.Feature||TC.syncLoadJS(TC.apiLocation+"TC/Feature.js"),t=$.map(r.parser.readFeatures(e),function(e){return new TC.Feature(null,{id:e.getId(),data:e.getProperties()})})),t},TC.wrap.parser={WFS:function(e){this.parser=new ol.format.WFS(e)},JSON:function(e){this.parser=new ol.format.GeoJSON(e)}},TC.inherit(TC.wrap.parser.WFS,TC.wrap.Parser),TC.inherit(TC.wrap.parser.JSON,TC.wrap.Parser),TC.wrap.control.OverviewMap.prototype.register=function(e){var t=this;$.when(t.parent.layer.wrap.getLayer()).then(function(r){t.ovMap=new ol.control.OverviewMap({target:t.parent.div,collapsed:!1,collapsible:!1,className:t.parent.CLASS+" ol-overviewmap",layers:[r]});var o=$(t.ovMap.boxOverlay_.getElement()).parents(".ol-overlay-container").first();TC.loadJS(!$.fn.drag,[TC.apiLocation+"lib/jquery/jquery.event.drag.js",TC.apiLocation+"lib/jquery/jquery.event.drop.js"],function(){var r,a,n=t.ovMap.ovmap_;o.drag("start",function(t,o){var i=$(this);r=parseInt(i.css("bottom")),a=parseInt(i.css("left"));var l=n.getPixelFromCoordinate([e.options.maxExtent[0],e.options.maxExtent[1]]),s=n.getPixelFromCoordinate([e.options.maxExtent[2],e.options.maxExtent[3]]),p=n.getSize();o.limit={bottom:p[1]-l[1],left:l[0],top:p[1]-s[1]-i.height(),right:s[0]-i.width()}}).drag("end",function(r,o){var a=($(this),t.ovMap.getMap()),i=a.getView(),l=n.getPixelFromCoordinate(i.getCenter()),s=n.getCoordinateFromPixel([l[0]+o.deltaX,l[1]+o.deltaY]),p=e.getExtent(),c=(p[2]-p[0])/2,u=(p[3]-p[1])/2;s[0]+c>e.options.maxExtent[2]?s[0]=e.options.maxExtent[2]-c:s[0]-c<e.options.maxExtent[0]&&(s[0]=e.options.maxExtent[0]+c),s[1]+u>e.options.maxExtent[3]?s[1]=e.options.maxExtent[3]-u:s[1]-u<e.options.maxExtent[1]&&(s[1]=e.options.maxExtent[1]+u),i.animate({center:s,duration:TC.Consts.ZOOM_ANIMATION_DURATION})}).drag(function(e,t){{var o=$(this);parseInt(o.css("bottom")),parseInt(o.css("left"))}t.limit.top?(o.css("bottom",Math.min(Math.max(r-t.deltaY,t.limit.bottom),t.limit.top)+"px"),o.css("left",Math.min(Math.max(a+t.deltaX,t.limit.left),t.limit.right)+"px")):(o.css("bottom",r-t.deltaY+"px"),o.css("left",a+t.deltaX+"px"))})}),$.when(e.wrap.getMap()).then(function(o){t.ovMap.ovmap_.setView(new ol.View(v(e.wrap,r._wrap.parent)));var a=$(t.parent.div).find("."+t.parent.CLASS+"-load");r._wrap.$events.on(TC.Consts.event.BEFORETILELOAD,function(){a.removeClass(TC.Consts.classes.HIDDEN).addClass(TC.Consts.classes.VISIBLE)}),r._wrap.$events.on(TC.Consts.event.TILELOAD,function(){a.removeClass(TC.Consts.classes.VISIBLE).addClass(TC.Consts.classes.HIDDEN)}),o.addControl(t.ovMap),t.parent.isLoaded=!0,t.parent.$events.trigger($.Event(TC.Consts.event.MAPLOAD))})})},TC.wrap.control.OverviewMap.prototype.enable=function(){var e=this;e.parent.layer&&e.parent.layer.setVisibility&&(e.parent.layer.setVisibility(!0),$(e.parent.map.div).trigger("resize"))},TC.wrap.control.OverviewMap.prototype.disable=function(){var e=this;e.parent.layer&&e.parent.layer.setVisibility&&e.parent.layer.setVisibility(!1)},TC.wrap.control.FeatureInfo.prototype.register=function(e){var t=this;$.when(e.wrap.getMap()).then(function(r){TC.wrap.control.Click.prototype.register.call(t,e);var o=t._trigger;t._trigger=function(r){t.hasElegibleLayers().then(function(a){a&&o.call(t,r)&&e.$events.trigger($.Event(TC.Consts.event.BEFOREFEATUREINFO,{xy:r.pixel,control:t.parent}))})}})},TC.wrap.control.FeatureInfo.prototype.hasElegibleLayers=function(){var e=$.Deferred(),t=this.parent.map,r=!1;return $.when(t.wrap.getMap()).then(function(o){o.getLayers().forEach(function(e){var o=e._wrap.parent,a=e.getSource();return a.getGetFeatureInfoUrl&&$.inArray(o,t.workLayers)>=0?(r=!0,!1):void 0}),e.resolve(r)}),e};var D,N=function(e){var t=e.innerHTML||e.textContent;return D=D||document.createElement("textarea"),D.innerHTML=t,D.value},G={readFeatures:function(e){var t=[],r=(new DOMParser).parseFromString(e,"text/xml");if("FeatureInfoResponse"===r.documentElement.tagName)for(var o=r.documentElement.getElementsByTagName("FeatureInfoCollection"),a=0,n=o.length;n>a;a++)for(var i=o[a],l=i.getAttribute("layername"),s=i.getElementsByTagName("FeatureInfo"),p=0,c=s.length;c>p;p++){for(var u=s[p].getElementsByTagName("Field"),g={},f=0,m=u.length;m>f;f++){var y=u[f];g[N(y.getElementsByTagName("FieldName")[0])]=N(y.getElementsByTagName("FieldValue")[0])}var d=new ol.Feature(g);d.setId(l+"."+TC.getUID()),t[t.length]=d}return t}},k=function(e,t,r){var o=t.getPath(r);e.layers.push({name:r,title:o[o.length-1],path:o.slice(1),features:[]})};TC.wrap.control.FeatureInfo.prototype.getFeatureInfo=function(e,t){var r=this,o=t||{},a=r.parent.map;$.when(a.wrap.getMap()).then(function(t){for(var n={},i={},l=[],s=[],p=t.getLayers().getArray(),c=0;c<p.length;c++){var u=p[c];if(u.getVisible()){var g=u._wrap.parent,f=u.getSource();if(f.getGetFeatureInfoUrl&&$.inArray(g,a.workLayers)>=0&&g.names.length>0&&(!o.serviceUrl||o.serviceUrl===g.url)){var m={};n[g.title]?m=n[g.title]:(m={layers:[],mapLayer:g,request:null},n[g.title]=m,i[g.title]={source:jQuery.extend(!0,{},f),layers:[]});var y=g.getDisgregatedLayerNames();if(o.layerName)y.indexOf(o.layerName)>=0&&u._wrap.getInfo(o.layerName).queryable&&(k(m,g,o.layerName),i[g.title].layers.push(o.layerName));else{for(var d=0;d<y.length;d++){var v=y[d];u._wrap.getInfo(v).queryable?k(m,g,v):(y.splice(d,1),d-=1)}i[g.title].layers=i[g.title].layers.concat(y)}}}}var h=o.mapSize||t.getSize(),C=Math.round(e[0]),T=Math.round(e[1]),S=o.boundingBox||a.getExtent(),w=t.getView().getResolution();for(var E in n){var m=n[E],f=i[E].source,p=i[E].layers,L=f.getParams();f.params_.LAYERS=p.join(",");var R=f.getGetFeatureInfoUrl(e,w,a.crs,{QUERY_LAYERS:p.join(","),INFO_FORMAT:L.INFO_FORMAT,FEATURE_COUNT:1e3,radius:a.options.pixelTolerance,buffer:a.options.pixelTolerance});R=R.replace(/I=\d+(\.\d+)?/,"I="+C).replace(/J=\d+(\.\d+)?/,"J="+T).replace(/WIDTH=\d+/,"WIDTH="+h[0]).replace(/HEIGHT=\d+/,"HEIGHT="+h[1]).replace(/BBOX=-?\d+(\.\d+)?\%2C-?\d+(\.\d+)?\%2C-?\d+(\.\d+)?\%2C-?\d+(\.\d+)?/,"BBOX="+S.join("%2C")).replace(/sld_body=[a-zA-Z%0-9._]*/);var M=R;m.mapLayer.usesProxy?R=TC.proxify(R):m.mapLayer.usesSSL&&(R=R.replace(/^(f|ht)tp?:\/\//i,"https://"));var _=$.ajax({url:R});_.originalUrl=R,_.title=E,_.requestedFormat=L.INFO_FORMAT,_.expandUrl=M,l.push(_)}l.length>0?$.when.apply(r,l).then(function(){for(var t=l.length>1?arguments:[arguments],i=!1,p=0,c=[],u=0;u<t.length;u++){var g=t[u],f=n[l[u].title],m=g[2];if("success"===g[1]){i=!0,f.text=m.responseText;var y,d=m.getResponseHeader("Content-type");if(d&&d.indexOf(";")>-1&&(d=d.substr(0,d.indexOf(";")).trim()),d||(d=m.requestedFormat),d===m.requestedFormat){switch(d){case"application/json":y=new ol.format.GeoJSON;break;case"application/vnd.ogc.gml":y=m.responseText.indexOf("FeatureCollection")>-1?new ol.format.WFS({gmlFormat:new ol.format.GML2}):new ol.format.WMSGetFeatureInfo;break;case"application/vnd.ogc.gml/3.1.1":y=new ol.format.GML3;break;case"application/vnd.esri.wms_featureinfo_xml":y=G;break;default:y=null}if(y){var v=y.readFeatures(m.responseText,{featureProjection:ol.proj.get(a.crs)});p+=v.length;for(var h=function(e,t,r){var o=!1;if(t===r)o=!0;else{var a=e.getNodePath(t),n=e.getNodePath(r);if(a.length>0&&n.length>=a.length){o=!0;for(var i=0;i<a.length;i++)if(e.wrap.getName(a[i])!==e.wrap.getName(n[i])){o=!1;break}}}return o},C={},T=0;T<v.length;T++){var S=v[T];if(S instanceof ol.Feature){for(var w=S.getId()||TC.getUID(),E=!1,L=w.substr(0,w.lastIndexOf(".")),R=0;R<f.layers.length;R++){var M=f.layers[R],_=M.name.substr(M.name.indexOf(":")+1);if(h(f.mapLayer,_,L)){E=!0,o.featureId&&S.getId()!==o.featureId||(s.push(TC.wrap.Feature.createFeature(S)),c.push(M.features));break}}if(!E){var P;C[L]?P=C[L]:(P={name:L,title:L,features:[]},C[L]=P,f.layers.push(P)),o.featureId&&S.getId()!==o.featureId||(s.push(TC.wrap.Feature.createFeature(S)),c.push(P.features))}}}}else{var A={name:"layer"+TC.getUID(),title:"Datos en el punto",features:[]};f.layers[f.layers.length]=A,A.features[0]={rawUrl:m.originalUrl,expandUrl:m.expandUrl,rawContent:m.responseText,rawFormat:d},p+=1}}else a.$events.trigger($.Event(TC.Consts.event.FEATUREINFOERROR,{xy:e,control:r.parent,layer:f.mapLayer,message:m.responseText}))}else a.$events.trigger($.Event(TC.Consts.event.FEATUREINFOERROR,{xy:e,control:r.parent,layer:f.mapLayer,message:m.responseText}))}if(i){var x=s;if(s.length){var I=$.Deferred();x=x.concat(I),TC.loadJS(!TC.Geometry,TC.apiLocation+"TC/Geometry.js",function(){I.resolve()})}$.when.apply(this,x).then(function(){var t;if(arguments.length)for(var o=a.wrap.getCoordinateFromPixel(e),i=0;i<arguments.length;i++){var l=arguments[i];if(l){l.attributes=[];for(var s in l.data){var u=l.data[s];"object"!=typeof u&&l.attributes.push({name:s,value:"number"==typeof u?u.toLocaleString(TC.Util.getMapLocale(r.parent.map)):u})}l.showsPopup=!1,!t&&TC.Geometry.isInside(o,l.geometry)&&(t=l),c[i].push(l)}}var g=[];for(var f in n)n.hasOwnProperty(f)&&g.push(n[f]);a.$events.trigger($.Event(TC.Consts.event.FEATUREINFO,{xy:e||null,services:g,featureCount:p,defaultFeature:t,control:r.parent}))})}},function(e,t,o){a.$events.trigger(TC.Consts.event.NOFEATUREINFO),a.toast(r.parent.getLocaleString("featureInfo.error"),{type:TC.Consts.msgType.ERROR})}):a.$events.trigger($.Event(TC.Consts.event.FEATUREINFO,{xy:e,services:n,featureCount:0,control:r.parent}))})},TC.wrap.control.PolygonFeatureInfo.prototype.register=function(e){var t=this;$.when(e.wrap.getMap()).then(function(r){TC.wrap.control.Click.prototype.register.call(t,e);var o=t._trigger;t._trigger=function(e){t.hasElegibleLayers().then(function(r){r&&(t.parent._isSearching||e.type!=ol.MapBrowserEvent.EventType.SINGLECLICK||t.parent._isDrawing||t.parent._isSearching||o.call(t,e))})}})},TC.wrap.control.PolygonFeatureInfo.prototype.hasElegibleLayers=function(){var e=$.Deferred(),t=this.parent.map,r=!1;return $.when(t.wrap.getMap()).then(function(o){o.getLayers().forEach(function(e){var o=e._wrap.parent,a=e.getSource();return a.getGetFeatureInfoUrl&&$.inArray(o,t.workLayers)>=0?(r=!0,!1):void 0}),e.resolve(r)}),e},TC.wrap.control.PolygonFeatureInfo.prototype.beginDraw=function(e,t,r){var o=this,a=!1;o.drawCtrl?(o.drawCtrl.setActive(!0),o.drawCtrl.startDrawing_({coordinate:e})):$.when(t.wrap.getLayer()).then(function(t){o.drawCtrl=new ol.interaction.Draw({source:t.getSource(),type:ol.geom.GeometryType.POLYGON,style:t.getStyle()}),t.getSource().on("addfeature",function(e){e.feature._wrap.parent.showsPopup=!1}),o.drawCtrl.handleEvent=function(e){return e.type==ol.MapBrowserEvent.EventType.SINGLECLICK&&(a&&2==this.sketchCoords_[0].length&&null!==this.sketchFeature_?this.addToDrawing_(e):a=!0),ol.interaction.Draw.handleEvent.call(this,e)},o.parent.map.wrap.getMap().addInteraction(o.drawCtrl),o.drawCtrl.on("drawstart",function(e){o.parent._isDrawing=!0;var t=o.parent.map;$.when(t.wrap.getMap()).then(function(e){e.getInteractions().forEach(function(e,t){e instanceof ol.interaction.DoubleClickZoom&&e.setActive(!1)})})}),o.drawCtrl.startDrawing_({coordinate:e}),o.drawCtrl.on("drawend",function(e){o.parent._isDrawing=!1;var a=o.parent.map;$.when(a.wrap.getMap()).then(function(e){e.getInteractions().forEach(function(e,t){e instanceof ol.interaction.DoubleClickZoom&&e.setActive(!1)})}),r&&r(e.feature.getGeometry().getCoordinates()[0]),this.setActive(!1),o.parent.map.wrap.getMap().removeInteraction(o.drawCtrl),o.drawCtrl=null,t.getSource().clear(),o.parent._drawToken=!0,setTimeout(function(){o.parent._drawToken=!1},500)})})},TC.wrap.control.PolygonFeatureInfo.prototype.cancelDraw=function(e,t,r){var o=this;o.drawCtrl&&o.parent._isDrawing&&(o.parent._isDrawing=!1,o.drawCtrl.setActive(!1),o.drawCtrl.source_.clear())},TC.wrap.control.PolygonFeatureInfo.prototype.getFeaturesByPolygon=function(e,t){this.writeGMLPolygon||(this.writeGMLPolygon=function(e,t){switch(t){case"3.1.1":break;case"3.2":for(var r=e.toString();r.indexOf(",")>=0;)r=r.replace(","," ");return'<gml:Polygon srsDimension="2"><gml:exterior><gml:LinearRing><gml:posList>'+r+"</gml:posList></gml:LinearRing></gml:exterior></gml:Polygon>";case"2.0":default:var r=jQuery.each(e,function(e,t){return t.join(",")}).join(" ");return"<gml:Polygon><gml:outerBoundaryIs><gml:LinearRing><gml:coordinates>"+r+"</gml:coordinates></gml:LinearRing></gml:outerBoundaryIs></gml:Polygon>"}});var r=this,o=r.parent.map,a=[],n={};$.when(o.wrap.getMap()).then(function(i){if(!t){for(var l=null,s=0;s<e.length;s++)(!l||l[1]<e[s][1])&&(l=e[s]);t=i.getPixelFromCoordinate(new ol.geom.Point(l).getCoordinates())}o.$events.trigger($.Event(TC.Consts.event.BEFOREFEATUREINFO,{xy:t,control:r.parent}));var p={};i.getLayers().forEach(function(i){if(i.getVisible()){var l=i._wrap.parent;if($.inArray(l,o.workLayers)<0||l.type!==TC.Consts.layerType.WMS)return;var s=l.options.url.substring(0,l.options.url.lastIndexOf("/wms")||l.options.url.lastIndexOf("/WMS")||l.options.url.lastIndexOf("/"))+"/wfs",c=l.getDisgregatedLayerNames()||l.availableNames;n[l.title]||(n[l.title]={layers:[],mapLayer:l,layerNames:[]});for(var u=0;u<c.length;u++){var g=c[u];if(l.isVisibleByScale(g)&&l.wrap.getInfo(g).queryable){n[l.title].layerNames.push(g);var f=l.getPath(g);n[l.title].layers.push({name:g,title:f[f.length-1],path:f.slice(1),features:[]})}}if(0==n[l.title].layerNames.length)return;if("undefined"!=typeof n[l.title].request)return;n[l.title].request=l.getWFSCapabilitiesPromise(),n[l.title].defer=$.Deferred(),a.push(n[l.title].defer),$.when(n[l.title].request).then(function(a){var i=null,l=null;for(var c in n)if(n[c].request&&n[c].request.promise()==this){l=n[c];

break}var u=l.layerNames,g=l.defer;if(u instanceof Array&&u.length){if("undefined"==typeof a.Operations.GetFeature)return TC.error("El servicio "+l.mapLayer.title+" no tiene habilitado el GetFeature de WFS"),void g.resolve(null);for(var f=[],m=0;m<u.length;m++){for(var y=u[m].substring(u[m].indexOf(":")+1);"_"===y[y.length-1];)y=y.substring(0,y.lastIndexOf("_"));a.FeatureTypes.hasOwnProperty(y)?f.indexOf(y)<0&&f.push(y):TC.error("El servicio "+l.mapLayer.title+" no dispone de la capa "+y)}if(0==f.length)return TC.error("No hay ninguna capa válida para el servicio "+l.mapLayer.title+" por lo que no se consultará dicho servicio"),void g.resolve(null);a.Operations.GetFeature.CountDefault&&(i=a.Operations.GetFeature.CountDefault.DefaultValue),r.queryBuilder||(r.queryBuilder=function(e,t,r,o,a){var n='<wfs:GetFeature service="WFS" ';switch(t.version){case"1.0.0":if(n+='xmlns:wfs="http://www.opengis.net/wfs" xmlns:gml="http://www.opengis.net/gml" ',!t.Operations.GetFeature.Operations.hasOwnProperty("Query"))return TC.error("El servicio "+l.mapLayer.title+" no tiene habilitado el Query de WFS"),null;break;case"1.1.0":break;case"2.0.0":if(n+='xmlns="http://www.opengis.net/wfs/2.0" xmlns:wfs="http://www.opengis.net/wfs/2.0" xmlns:gml="http://www.opengis.net/gml/3.2" ',t.Operations.QueryExpressions.AllowedValues.Value.indexOf("wfs:Query")<0)return TC.error("El servicio "+l.mapLayer.title+" no tiene habilitado el Query de WFS"),null}for(var i in t)"string"==typeof t[i]&&i.indexOf("gml")<0&&t[i].indexOf("wfs")<0&&(n+=i+'="'+t[i]+'" ');t.Operations.GetFeature.outputFormat.indexOf("json")>=0&&(n+=' outputFormat="JSON" '),a&&(n+=' resultType="hits" '),n+=">";for(var i=0;i<o.length;i++)if("1.0.0"===t.version&&(n+='<wfs:Query typeName="'+o[i]+'"><ogc:Filter><ogc:Intersects><ogc:PropertyName></ogc:PropertyName>'+this.writeGMLPolygon(r,"2.0")+"</ogc:Intersects></ogc:Filter></wfs:Query>"),"2.0.0"===t.version){for(var s=r.toString();s.indexOf(",")>=0;)s=s.replace(","," ");n+='<wfs:Query typeNames="'+o[i]+'"><fes:Filter><fes:Intersects><fes:ValueReference></fes:ValueReference>'+this.writeGMLPolygon(r,"3.2")+"</fes:Intersects></fes:Filter></wfs:Query>"}n+="</wfs:GetFeature>";var p=$.Deferred();return jQuery.ajax({url:e,data:n,cache:!1,contentType:"application/xml",type:"POST"}).then(function(){"success"==arguments[1]?p.resolve(arguments):p.reject(arguments)}),p});var d=null;i&&r.queryBuilder(s,a,e,f,!0).done(function(e){var t=parseInt(xml2json(e[0]).numberMatched,10);t>parseInt(i,10)&&d.reject({err:"NumMaxFeatures",limit:i,message:"Se ha superado el máximo de {0} elementos de este servicio",service:l})}),d=r.queryBuilder(s,a,e,f,!1),d.done(function(e){var a=e[0],n=e[1],i=e[2],s=!1,c=[];if("success"===n){s=!0;var u,f=i.getResponseHeader("Content-type");switch(f&&f.indexOf(";")>-1&&(f=f.substr(0,f.indexOf(";")).trim()),f||(f=a.requestedFormat),f){case"application/json":u=new ol.format.GeoJSON;break;case"application/vnd.ogc.gml":u=a.responseText.indexOf("FeatureCollection")>-1?new ol.format.WFS({gmlFormat:new ol.format.GML2}):new ol.format.WMSGetFeatureInfo;break;case"application/vnd.ogc.gml/3.1.1":u=new ol.format.GML3;break;case"text/xml":var m=xml2json(a);m.ServiceException&&TC.error(m.ServiceException),u=null;break;default:u=null}if(u)for(var y=u.readFeatures(i.responseText,{featureProjection:ol.proj.get(o.crs)}),d=function(e,t,r){var o=!1;if(t===r||0===t.indexOf(r))o=!0;else{var a=e.getPath(t),n=e.getPath(r);if(a.length>0&&n.length>=a.length){o=!0;for(var i=0;i<a.length;i++)if(a[i]!==n[i]){o=!1;break}}}return o},v={},h=0;h<y.length;h++){var C=y[h];if(C instanceof ol.Feature){for(var T=C.getId()||TC.getUID(),S=!1,w=T.substr(0,T.lastIndexOf(".")),E=0;E<l.layers.length;E++){var L=l.layers[E],R=L.name.substr(L.name.indexOf(":")+1);if(d(l.mapLayer,R,w)){S=!0,c.push(TC.wrap.Feature.createFeature(C)),p[C.id_]=L.features;break}}if(!S){var M;v[w]?M=v[w]:(M={name:w,title:w,features:[]},v[w]=M,l.layers.push(M)),c.push(TC.wrap.Feature.createFeature(C)),p[C.id_]=M.features}}}else{var L=l.layers[0];L.features.push({error:i.responseText})}}else o.$events.trigger($.Event(TC.Consts.event.FEATUREINFOERROR,{xy:t||null,control:r.parent,layer:l.mapLayer}));s&&$.when.apply(this,c).then(function(){if(arguments.length)for(var e=0;e<arguments.length;e++){var t=arguments[e];t.attributes=[];for(var r in t.data){var o=t.data[r];"object"!=typeof o&&t.attributes.push({name:r,value:o})}p[t.id].push(t)}g.resolve({service:l})})}).fail(function(e){e.err&&"NumMaxFeatures"===e.err?g.resolve({service:e.service,Error:e.message.format(e.limit)}):g.reject(e)})}},function(e){TC.error(e.Message?e.Message:e.responseText)})}}),$.when.apply($,a).then(function(){for(var e=[],a=0,a=0,n=0;n<arguments.length;n++)if(arguments[n]){arguments[n].Error&&(arguments[n].service.hasLimits=arguments[n].Error),e.push(arguments[n].service);for(var i=0;i<arguments[n].service.layers.length;i++)a+=arguments[n].service.layers[i].features.length}o.$events.trigger(a?$.Event(TC.Consts.event.FEATUREINFO,{xy:t||null,services:e,featureCount:a,control:r.parent}):$.Event(TC.Consts.event.NOFEATUREINFO,{xy:t,control:r.parent}))},function(e){console.log(e)})})},TC.wrap.control.Popup.prototype=function(){this.popup=null},TC.Consts.event.PANANIMATIONSTART="pananimationstart.tc",TC.Consts.event.PANANIMATIONEND="pananimationend.tc",TC.wrap.control.Popup.prototype.fitToView=function(){var e=this,t=e.parent.map,r=e.parent.map.wrap.map,o=e.parent.$popupDiv[0].getBoundingClientRect(),a=t._$div[0].getBoundingClientRect(),n=r.getCoordinateFromPixel([o.left-a.left,o.top-a.top]),i=r.getCoordinateFromPixel([o.right-a.left,o.bottom-a.top]),l=n[0],s=n[1],p=i[0],c=i[1],u=[l,c,p,s],g=t.getExtent();if(!ol.extent.containsExtent(g,u)){var f={left:Math.max(g[0]-u[0],0),bottom:Math.max(g[1]-u[1],0),right:Math.max(u[2]-g[2],0),top:Math.max(u[3]-g[3],0)};if(e.parent.dragged){var m=e.popup.getPosition();f.right?m[0]=m[0]-f.right:f.left&&(m[0]=m[0]+f.left),f.top?m[1]=m[1]-f.top:f.bottom&&(m[1]=m[1]+f.bottom);var y=r.getPixelFromCoordinate(m);y[1]=r.getSize()[1]-y[1],e.parent._previousContainerPosition=y,e.popup._oldUpdatePixelPosition(m)}else if(e.parent.isVisible()){var d=r.getView(),v=d.getCenter().slice();f.top?v[1]+=f.top:f.bottom&&(v[1]-=f.bottom),f.right?v[0]+=f.right:f.left&&(v[0]-=f.left),d.animate({center:v,easing:function(t){return 0===t&&e.parent.map.$events.trigger($.Event(TC.Consts.event.PANANIMATIONSTART)),1===t&&e.parent.map.$events.trigger($.Event(TC.Consts.event.PANANIMATIONEND)),t}})}}},TC.wrap.control.Popup.prototype.setDragged=function(e){var t=this.popup;e?(t._oldUpdatePixelPosition||(t._oldUpdatePixelPosition=t.updatePixelPosition,t.updatePixelPosition=function(){}),t._newHandleOffsetChanged||(t._newHandleOffsetChanged=function(){this._oldUpdatePixelPosition()},ol.events.unlisten(t,ol.Object.getChangeEventType(ol.Overlay.Property.OFFSET),t.handleOffsetChanged,t),ol.events.listen(t,ol.Object.getChangeEventType(ol.Overlay.Property.OFFSET),t._newHandleOffsetChanged,t))):(delete this.parent._previousContainerPosition,t._oldUpdatePixelPosition&&(t.updatePixelPosition=t._oldUpdatePixelPosition,delete t._oldUpdatePixelPosition),t._newHandleOffsetChanged&&(ol.events.unlisten(t,ol.Object.getChangeEventType(ol.Overlay.Property.OFFSET),t._newHandleOffsetChanged,t),ol.events.listen(t,ol.Object.getChangeEventType(ol.Overlay.Property.OFFSET),t.handleOffsetChanged,t),delete t._newHandleOffsetChanged))},TC.wrap.Feature.prototype.getLegend=function(){var e=this,t={},r=e.feature.getStyle();if("function"==typeof r&&(r=r.call(e.feature)),r){var o=r[0].getImage();if(o)o instanceof ol.style.Icon?t.src=o.getSrc():o instanceof ol.style.Circle&&(t.src=o.canvas_.toDataURL()),e.parent.options.radius?t.height=t.width=2*e.parent.options.radius:(t.width=e.parent.options.width,t.height=e.parent.options.height);else{var a=r[0].getStroke(),n=r[0].getFill();if(a){var i=a.getColor();i&&(t.strokeColor=ol.color.asString(i));var l=a.getWidth();l&&(t.strokeWidth=l)}if(n){var s=n.getColor();s&&(t.fillColor=ol.color.asString(s))}}}return t};var b=function(e,t,r){var o,a={},n=r||"geometry";return a[n]=new t(e),o=new ol.Feature(a),r&&o.setGeometryName(r),o},b=function(e,t,r){var o,a={},n=r||"geometry";return a[n]=new t(e),o=new ol.Feature(a),r&&o.setGeometryName(r),o};TC.wrap.Feature.prototype.createPoint=function(e,t){var r=this;$.isArray(e)?r.feature=b(e,ol.geom.Point,t.geometryName):r.isNative(e)&&(r.feature=e,r.parent.geometry=e.getGeometry().getCoordinates()),r.feature._wrap=r,r.feature.setStyle(M({styles:{point:t}},r.feature))},TC.wrap.Feature.prototype.createMarker=function(e,t){var r=this,o=TC.Util.getPointIconUrl(t);o?(t.url=o,$.isArray(e)?r.feature=b(e,ol.geom.Point,t.geometryName):r.isNative(e)&&(r.feature=e,r.parent.geometry=e.getGeometry().getCoordinates()),r.feature._wrap=r,r.feature.setStyle(M({styles:{marker:t}},r.feature))):r.createPoint(e,t)},TC.wrap.Feature.prototype.createPolyline=function(e,t){var r=this;$.isArray(e)?r.feature=b(e,ol.geom.LineString,t.geometryName):r.isNative(e)&&(r.feature=e,r.parent.geometry=e.getGeometry().getCoordinates()),r.feature._wrap=r,t&&r.feature.setStyle(M({styles:{line:t}},r.feature))},TC.wrap.Feature.prototype.createPolygon=function(e,t){var r=this;if($.isArray(e)){if(e.length){var o=e[0];if($.isArray(o)&&o.length){var a=o[0];$.isArray(a)||(e=[e]);for(var n=0;n<e.length;n++){o=e[n];var i=o[0],l=o[o.length-1];(i[0]!==l[0]||i[1]!==l[1])&&(o[o.length]=i),r.parent.geometry=e,r.feature=b(e,ol.geom.MultiLineString,t.geometryName)}r.parent.geometry=e,r.feature=b(e,ol.geom.Polygon,t.geometryName)}}}else r.isNative(e)&&(r.feature=e,r.parent.geometry=e.getGeometry().getCoordinates());r.feature._wrap=r;var s=t||{};(s.strokeColor||s.strokeWidth||s.fillColor||s.fillOpacity)&&r.feature.setStyle(M({styles:{polygon:s}},r.feature))},TC.wrap.Feature.prototype.createMultiPolyline=function(e,t){var r=this;if($.isArray(e)){if(e.length){var o=e[0];if($.isArray(o)&&o.length){var a=o[0];$.isArray(a)||(e=[e]),r.parent.geometry=e,r.feature=b(e,ol.geom.MultiLineString,t.geometryName)}}}else r.isNative(e)&&(r.feature=e,r.parent.geometry=e.getGeometry().getCoordinates());r.feature._wrap=r,t&&r.feature.setStyle(M({styles:{line:t}},r.feature))},TC.wrap.Feature.prototype.createMultiPolygon=function(e,t){var r=this;if($.isArray(e)){if(e.length){var o=e[0];if($.isArray(o)&&o.length){var a=o[0];if($.isArray(a)&&a.length){var n=a[0];$.isArray(n)||(e=[e])}else e=[[e]];for(var i=0,l=e.length;l>i;i++){o=e[i];for(var s=0,p=o.length;p>s;s++){a=o[s];var c=a[0],u=a[a.length-1];(c[0]!==u[0]||c[1]!==u[1])&&(a[a.length]=c)}}r.parent.geometry=e,r.feature=b(e,ol.geom.MultiPolygon,t.geometryName)}}}else r.isNative(e)&&(r.feature=e,r.parent.geometry=e.getGeometry().getCoordinates());r.feature._wrap=r;var g=t||{};(g.strokeColor||g.strokeWidth||g.fillColor||g.fillOpacity)&&r.feature.setStyle(M({styles:{polygon:g}},r.feature))},TC.wrap.Feature.prototype.createCircle=function(e,t){var r=this;if($.isArray(e)&&$.isArray(e[0])&&"number"==typeof e[0][0]&&"number"==typeof e[0][1]&&"number"==typeof e[1]){var o={},a=t.geometryName||"geometry";o[a]=new ol.geom.Circle(e[0],e[1]),r.feature=new ol.Feature(o),t.geometryName&&r.feature.setGeometryName(t.geometryName)}else if(r.isNative(e)){r.feature=e;var n=e.getGeometry();r.parent.geometry=[n.getCenter(),n.getRadius()]}r.feature._wrap=r,t&&r.feature.setStyle(new ol.style.Style({stroke:new ol.style.Stroke({color:t.strokeColor,width:t.strokeWidth,lineDash:t.lineDash}),fill:new ol.style.Fill({color:d(t.fillColor,t.fillOpacity)})}))},TC.wrap.Feature.createFeature=function(e){var t,r=new $.Deferred,o=e.getGeometry(),a={id:e.getId()};switch(!0){case o instanceof ol.geom.Point:var n=e.getStyle();$.isFunction(n)&&(n=n.call(e));for(var i=n?$.isArray(n)?n:[n]:[],l=0,s=i.length;s>l;l++)if(n=i[l],n.getImage()instanceof ol.style.Icon){t="Marker";break}t=t||"Point";break;case o instanceof ol.geom.LineString:t="Polyline";break;case o instanceof ol.geom.Polygon:t="Polygon";break;case o instanceof ol.geom.MultiLineString:t="MultiPolyline";break;case o instanceof ol.geom.MultiPolygon:t="MultiPolygon"}return t?TC.loadJS(!TC.feature||TC.feature&&!TC.feature[t],[TC.apiLocation+"TC/feature/"+t+".js"],function(){var o=new TC.feature[t](e,a);o.data=o.wrap.getData(),r.resolve(o)}):TC.loadJS(!TC.Feature,[TC.apiLocation+"TC/Feature.js"],function(){var t=new TC.Feature(e,a);t.data=t.wrap.getData(),r.resolve(t)}),r},TC.wrap.Feature.prototype.cloneFeature=function(){return this.feature.clone()},TC.wrap.Feature.prototype.getStyle=function(){var e=this,t={},r=e.feature.getStyle();$.isFunction(r)&&(r=r.call(e.feature));for(var o=r?$.isArray(r)?r:[r]:[],a=0,n=o.length;n>a;a++){r=o[a];var i=r.getFill();i&&(t.fillColor=i.getColor(),$.isArray(t.fillColor)&&(t.fillOpacity=t.fillColor[3]));var l=r.getStroke();l&&(t.strokeColor=l.getColor(),t.strokeWidth=l.getWidth());var s=r.getImage();if(s instanceof ol.style.Icon){t.url=s.getSrc();var p=s.getSize(),c=s.getAnchor();t.anchor=[c[0],c[1]],s.anchorXUnits_===ol.style.Icon.AnchorUnits.PIXELS&&(t.anchor[0]=t.anchor[0]/p[0]),s.anchorYUnits_===ol.style.Icon.AnchorUnits.PIXELS&&(t.anchor[1]=t.anchor[1]/p[1])}var u=r.getText();if(u){t.label=u.getText();var g=u.getFont();g&&(t.fontSize=parseInt(g.match(/\d+pt/))||.75*parseInt(g.match(/\d+px/)));var f=u.getRotation();f&&(t.angle=-180*f/Math.PI),t.labelOffset=[u.getOffsetX(),u.getOffsetY()],i=u.getFill(),i&&(t.fontColor=i.getColor()),l=u.getStroke(),l&&(t.labelOutlineColor=l.getColor(),t.labelOutlineWidth=l.getWidth())}}return $.extend(e.parent.options,t),t},TC.wrap.Feature.prototype.getGeometry=function(){var e,t=this;if(t.feature&&t.feature.getGeometry){var r=t.feature.getGeometry();r&&(r.getCoordinates?e=r.getCoordinates():r instanceof ol.geom.Circle&&(e=[r.getCenter(),r.getRadius()]))}return e},TC.wrap.Feature.prototype.setGeometry=function(e){var t=!1,r=this;if(r.feature&&r.feature.getGeometry){var o,a,n,i,l,s,p,c=r.feature.getGeometry();switch(!0){case c instanceof ol.geom.MultiPolygon:l=!0,i=e,$.isArray(i)&&(n=e[0]);case c instanceof ol.geom.Polygon||c instanceof ol.geom.MultiLineString:s=!0,n=l?n:e,$.isArray(n)&&(a=n[0]);case c instanceof ol.geom.LineString:p=!0,a=s?a:e,$.isArray(a)&&(o=a[0]);case c instanceof ol.geom.Point:o=p?o:e,$.isArray(o)&&"number"==typeof o[0]&&"number"==typeof o[1]&&(c.setCoordinates(e),t=!0);break;case c instanceof ol.geom.Circle:$.isArray(e)&&$.isArray(e[0])&&"number"==typeof e[0][0]&&"number"==typeof e[0][1]&&"number"==typeof e[1]&&(c.setCenterAndRadius(e[0],e[1]),t=!0)}}return t},TC.wrap.Feature.prototype.getId=function(){var e,t=this;return t.feature&&(e=t.feature.getId()),e},TC.wrap.Feature.prototype.setId=function(e){var t=this;t.feature&&t.feature.setId(e)},TC.wrap.Feature.prototype.setStyle=function(e){var t=this,r=t.feature,o=t.parent,a=r.getGeometry();if(a instanceof ol.geom.Point){var n;if(e.anchor){var i={anchor:R(e.anchor,o),src:TC.Util.getPointIconUrl(e),size:[R(e.width,o),R(e.height,o)]};e.angle&&(i.angle=e.angle),n=new ol.style.Icon(i)}else{var l={radius:R(e.radius,o)||(R(e.height,o)+R(e.width,o))/4};e.fillColor&&(l.fill=new ol.style.Fill({color:d(R(e.fillColor,o),R(e.fillOpacity,o))})),e.strokeColor&&(l.stroke=new ol.style.Stroke({color:R(e.strokeColor,o),width:R(e.strokeWidth,o),lineDash:e.lineDash})),isNaN(l.radius)||(n=new ol.style.Circle(l))}r.setStyle(new ol.style.Style({image:n}))}else a instanceof ol.geom.LineString||a instanceof ol.geom.MultiLineString?r.setStyle(new ol.style.Style({stroke:new ol.style.Stroke({color:R(e.strokeColor,o),width:R(e.strokeWidth,o),lineDash:e.lineDash})})):(a instanceof ol.geom.Polygon||a instanceof ol.geom.MultiPolygon)&&r.setStyle(new ol.style.Style({stroke:new ol.style.Stroke({color:R(e.strokeColor,o),width:R(e.strokeWidth,o),lineDash:e.lineDash}),fill:new ol.style.Fill({color:d(R(e.fillColor,o),R(e.fillOpacity,o))})}))},TC.wrap.Feature.prototype.getInnerPoint=function(e){var t,r=e||{},o=this.feature,a=o.getGeometry(),n=function(e){var t=r.clipBox;e[0]=Math.min(Math.max(e[0],t[0]),t[2]),e[1]=Math.min(Math.max(e[1],t[1]),t[3])},i=function g(e){if(r.clipBox&&$.isArray(e))if($.isArray(e[0]))for(var t=0,o=e.length;o>t;t++)g(e[t]);else n(e)};switch(t=a.getFirstCoordinate(),a.getType()){case ol.geom.GeometryType.MULTI_POLYGON:a=a.getPolygon(0);case ol.geom.GeometryType.POLYGON:var l=function(e,t){for(var r=!1,o=0,a=t.length-1;o<t.length;a=o++){var n=t[o][0],i=t[o][1],l=t[a][0],s=t[a][1],p=i>e[1]!=s>e[1]&&e[0]<(l-n)*(e[1]-i)/(s-i)+n;p&&(r=!r)}return r},s=a.getCoordinates();i(s),a=new ol.geom.Polygon(s),t=a.getInteriorPoint().getCoordinates();for(var p=a.getLinearRings(),c=1;c<p.length;c++)if(l(t,p[c].getCoordinates())){t=a.getClosestPoint(t);break}break;case ol.geom.GeometryType.MULTI_LINE_STRING:a=a.getLineString(0);case ol.geom.GeometryType.LINE_STRING:var u=[0,0],s=a.getCoordinates();i(s),a=new ol.geom.LineString(s);for(var c=0;c<s.length;c++)u[0]+=s[c][0],u[1]+=s[c][1];u[0]/=s.length,u[1]/=s.length,t=a.getClosestPoint(u)}return t},TC.wrap.Feature.prototype.showPopup=function(e){var t=this,r=e.map;if(r){var o=t.feature;if(o){r.currentFeature=t.parent;var a=r.getExtent();if(t._innerCentroid=t.getInnerPoint({clipBox:a}),e.$contentDiv.html(t.parent.getInfo()),e.options.closeButton){var n=e.$popupDiv.find("."+e.CLASS+"-close").length;if(0==n){var i=$("<div>").addClass(e.CLASS+"-close").attr("title",e.getLocaleString("close")).appendTo(e.$popupDiv);i.on(TC.Consts.event.CLICK,function(){e.hide()}),e.$contentDiv.addClass(e.CLASS+"-has-btn"),e.$contentDiv.find(".tc-ctl-finfo").css("width","auto").css("height","auto")}}var l,s=t.parent.options;if(s.anchor)l=s.anchor;else{for(var p,c=o._wrap.parent,u=0;u<r.workLayers.length;u++){var g=r.workLayers[u];if(!g.isRaster()&&$.inArray(c,g.features)>=0){p=g.wrap.styleFunction(o);break}}if($.isArray(p)){var f=p[0].getImage();l=!f||f instanceof ol.style.Icon?[.5,0]:[.5,.5]}}e.wrap.popup.setOffset(l&&s.height?[0,-s.height*l[1]]:[0,0]),e.wrap.popup.setPosition(t._innerCentroid),e.$popupDiv.addClass(TC.Consts.classes.VISIBLE)}else r.wrap.hidePopup(e)}},TC.wrap.Feature.prototype.isNative=function(e){return e instanceof ol.Feature},TC.wrap.Feature.prototype.getPath=function(){var e=[],t=this;return t.feature&&t.feature._folders&&(e=t.feature._folders),e},TC.wrap.Feature.prototype.getBounds=function(){var e=null,t=this;return t.feature&&(e=t.feature.getGeometry().getExtent()),e},TC.wrap.Feature.prototype.getTemplate=function(){var e=null,t=this,r=t.feature.getStyle();if("function"==typeof r&&(r=r.call(t.feature)),$.isArray(r))for(var o=0;o<r.length;o++)if(r[o]._balloon){var a=r[o]._balloon.getText();if(a){r=r[o]._balloon;break}}return r&&!$.isArray(r)&&r.getText&&(e=r.getText()),e},TC.wrap.Feature.prototype.getData=function(){var e=this,t=e.feature.getProperties();$.isArray(t.features)&&(t=1===t.features.length?t.features[0].getProperties():t.features.length+" elementos");var r=e.feature.getGeometryName();return t[r]&&delete t[r],t},TC.wrap.Feature.prototype.setData=function(e){this.feature.setProperties(e)},TC.wrap.control.Draw.prototype.mouseMoveHandler=function(e){var t=e.data;t.sketch&&t.parent.$events.trigger($.Event(TC.Consts.event.MEASUREPARTIAL,t.getMeasureData()))},TC.wrap.control.Draw.prototype.mouseOverHandler=function(e){var t=e.data;t.sketch&&t.hoverCoordinate&&(t.pushCoordinate(t.hoverCoordinate),t.hoverCoordinate=null)},TC.wrap.control.Draw.prototype.clickHandler=function(e){var t=e.data;if(t.sketch){var r=t.sketch.getGeometry().getCoordinates();t.parent.$events.trigger($.Event(TC.Consts.event.POINT,{point:r[r.length-1]}))}},TC.wrap.control.Draw.prototype.getGeometry=function(){var e={};if(this.sketch){var t=this.sketch.getGeometry();t instanceof ol.geom.Polygon?e.geometry=new TC.feature.Polygon(t.getCoordinates()):t instanceof ol.geom.LineString?e.geometry=new TC.feature.Polyline(t.getCoordinates()):t instanceof ol.geom.Point&&(e.geometry=new TC.feature.Point(t.getCoordinates()))}return e},TC.wrap.control.Draw.prototype.getMeasureData=function(){var e=this,t=function(t,r){r.length=t.getLength(),r.units=e.units,r.length>100&&e.units===ol.proj.Units.METERS&&(r.length=r.length/1e3,r.units="km")},r=function(t,r){r.area=t.getArea();var o=t.getLinearRing(0);r.perimeter=ol.geom.flat.length.linearRing(o.flatCoordinates,0,o.flatCoordinates.length,o.stride),r.units=e.units,r.area>1e4&&e.units===ol.proj.Units.METERS&&(r.area=r.area/1e6,r.perimeter=r.perimeter/1e3,r.units="km")},o={};if(this.sketch){var a=this.sketch.getGeometry();a instanceof ol.geom.Polygon?r(a,o):a instanceof ol.geom.LineString&&t(a,o)}return o},TC.wrap.control.Draw.prototype.activate=function(t){var o,a=this;switch(t){case TC.Consts.geom.POLYGON:o=ol.geom.GeometryType.POLYGON;break;case TC.Consts.geom.POINT:o=ol.geom.GeometryType.POINT;break;default:o=ol.geom.GeometryType.LINE_STRING}a.parent.map&&$.when(a.parent.map.wrap.getMap(),a.parent.getLayer()).then(function(n,i){a.units=n.getView().getProjection().getUnits(),$.when(i&&i.wrap.getLayer()).then(function(i){if(a.$viewport||(a.$viewport=$(n.getViewport())),a.interaction&&(n.removeInteraction(a.interaction),a.$viewport.off(TC.Consts.event.CLICK,a.clickHandler),a.parent.measure&&a.$viewport.off(e+".draw",a.mouseMoveHandler).off(r,a.mouseOverHandler)),a.snapInteraction&&n.removeInteraction(a.snapInteraction),t){a.$viewport.on(TC.Consts.event.CLICK,a,a.clickHandler),a.parent.measure&&a.$viewport.on(e+".draw",a,a.mouseMoveHandler).on(r,a,a.mouseOverHandler);var l={type:o,snapTolerance:0,condition:function(){return ol.events.condition.shiftKeyOnly(arguments[0])&&(hole=n.forEachFeatureAtPixel(n.getPixelFromCoordinate(arguments[0].coordinate),function(e){return ol.geom.GeometryType.POLYGON==e.getGeometry().getType()||ol.geom.GeometryType.MULTI_POLYGON==e.getGeometry().getType()?e:null})),!0}};if(i)l.source=i.getSource(),l.style=i.getStyle();else{var s=a.parent.map.options.styles.selection;l.style=M({styles:{point:$.extend({},s.point,{fillOpacity:0}),line:s.line,polygon:s.polygon}})}if(t===TC.Consts.geom.RECTANGLE&&(l.type=ol.geom.GeometryType.LINE_STRING,l.maxPoints=2,l.geometryFunction=function(e,t){t||(t=new ol.geom.Polygon(null));var r=e[0],o=e[1];return t.setCoordinates([[r,[r[0],o[1]],o,[o[0],r[1]],r]]),t}),a.interaction=new ol.interaction.Draw(l),a.interaction.on("drawstart",function(e){a.sketch=e.feature,a.parent.$events.trigger($.Event(TC.Consts.event.DRAWSTART))},this),a.interaction.on("drawend",function(e){a.parent.$events.trigger(a.parent.measure?$.Event(TC.Consts.event.MEASURE,a.getMeasureData()):$.Event(TC.Consts.event.DRAWEND,a.getGeometry())),a.sketch=null},this),n.addInteraction(a.interaction),a.parent.snapping){var p={};i?p.source=i.getSource():a.parent.snapping instanceof TC.Layer&&(p.source=a.parent.snapping.wrap.layer.getSource()),a.snapInteraction=new ol.interaction.Snap(p),n.addInteraction(a.snapInteraction)}}a.redoStack=[]})})},TC.wrap.control.Draw.prototype.deactivate=function(){var e=this;e.parent.map&&$.when(e.parent.map.wrap.getMap(),e.parent.getLayer()).then(function(t,r){e.$viewport&&e.$viewport.off(TC.Consts.event.CLICK,e.clickHandler),r&&r.clearFeatures(),e.interaction&&(t.removeInteraction(e.interaction),e.interaction=null)})},TC.wrap.control.Draw.prototype.popCoordinate=function(){var e=this,t=null;if(e.interaction){var r=e.interaction.sketchFeature_;if(r){var o,a=r.getGeometry();a instanceof ol.geom.Polygon?o=a.getCoordinates()[0]:a instanceof ol.geom.LineString&&(o=a.getCoordinates());if(o.length>1){var n;a instanceof ol.geom.Polygon?n=e.interaction.sketchCoords_[0]:a instanceof ol.geom.LineString&&(n=e.interaction.sketchCoords_);var i=!1;if(e.interaction.sketchPoint_)for(var l=e.interaction.sketchPoint_.getGeometry().getCoordinates(),s=0;s<o.length;s++)if(o[s][0]==l[0]&&o[s][1]==l[1]){i=!0;break}var p;p=i?n.length-2:n.length-1,t=n[p],n.splice(p,1),a instanceof ol.geom.Polygon?(a.setCoordinates([n]),e.interaction.sketchLine_.getGeometry().setCoordinates(n)):a.setCoordinates(n),r.setGeometry(a)}}}return t},TC.wrap.control.Draw.prototype.pushCoordinate=function(e){var t=this,r=!1;if(t.interaction){var o=t.interaction.sketchFeature_;if(o){var a,n=o.getGeometry();n instanceof ol.geom.Polygon?a=n.getCoordinates()[0]:n instanceof ol.geom.LineString&&(a=n.getCoordinates());var i;n instanceof ol.geom.Polygon?i=t.interaction.sketchCoords_[0]:n instanceof ol.geom.LineString&&(i=t.interaction.sketchCoords_);var l=!1;if(t.interaction.sketchPoint_)for(var s=t.interaction.sketchPoint_.getGeometry().getCoordinates(),p=0;p<a.length;p++)if(a[p][0]==s[0]&&a[p][1]==s[1]){l=!0;break}index=l?i.length-1:i.length,i.splice(index,0,e),n instanceof ol.geom.LineString?n.setCoordinates(i,ol.geom.GeometryLayout.XY):(n.setCoordinates([i],ol.geom.GeometryLayout.XY),t.interaction.sketchLine_.getGeometry().setCoordinates(i)),r=!0}}return r},TC.wrap.control.Draw.prototype.undo=function(){var e=this,t=!1,r=e.popCoordinate();return r&&(e.redoStack.push(r),t=!0),e.parent.$events.trigger($.Event(TC.Consts.event.MEASUREPARTIAL,e.getMeasureData())),t},TC.wrap.control.Draw.prototype.redo=function(){var e=this,t=!1;return e.redoStack.length>0&&(e.pushCoordinate(e.redoStack.pop()),t=!0),e.parent.$events.trigger($.Event(TC.Consts.event.MEASUREPARTIAL,e.getMeasureData())),t},TC.wrap.control.Draw.prototype.end=function(){var e=this;e.interaction&&e.interaction.sketchFeature_&&e.interaction.finishDrawing()},TC.wrap.control.CacheBuilder.prototype.getRequestSchemas=function(e){for(var t=e.extent,r=e.layers,o=new Array(r.length),a=0,n=o.length;n>a;a++){var i=r[a],l={layerId:i.id},s=i.wrap.layer.getSource();if(s.getUrls&&(l.url=s.getUrls()[0]),s.getTileGrid){for(var p=s.getTileGrid(),c=p.getResolutions(),u=p.getMatrixIds(),g=i.getLayerNodeByName(i.layerNames),f=null,m=0,y=g.TileMatrixSetLink.length;y>m;m++){var d=g.TileMatrixSetLink[m];if(d.TileMatrixSet===i.matrixSet){f=d.TileMatrixSetLimits;break}}l.tileMatrixLimits=[];for(var m=0,v=c.length;v>m;m++){var h=p.getOrigin(m),C=p.getTileSize(m),T=c[m],S=C*T,w={mId:u[m],res:T,origin:h,tSize:C,cl:Math.floor((t[0]-h[0])/S),cr:Math.floor((t[2]-h[0])/S),rt:Math.floor((h[1]-t[3])/S),rb:Math.floor((h[1]-t[1])/S)};if(f){var E=f[m];E&&(w.cl=Math.max(w.cl,E.MinTileCol),w.cr=Math.min(w.cr,E.MaxTileCol),w.rt=Math.max(w.rt,E.MinTileRow),w.rb=Math.min(w.rb,E.MaxTileRow))}w.cl<=w.cr&&w.rt<=w.rb&&l.tileMatrixLimits.push(w)}}o[a]=l}return o},TC.wrap.control.CacheBuilder.prototype.getGetTilePattern=function(e){var t="",r=e.wrap.layer.getSource();return r.getUrls&&(t=r.getUrls()[0]),e.options.encoding!==TC.Consts.WMTSEncoding.RESTFUL&&(t.indexOf("?")<0&&(t+="?"),t.indexOf("?")===t.length-1&&(t=t+"layer="+e.layerNames+"&style=default&tilematrixset="+encodeURIComponent(e.matrixSet)+"&Service=WMTS&Request=GetTile&Version=1.0.0&Format="+encodeURIComponent(e.format)+"&TileMatrix={TileMatrix}&TileCol={TileCol}&TileRow={TileRow}")),t},TC.wrap.control.Edit.prototype.activate=function(e){var t=this;t.cancel(!0),e===TC.Consts.editMode.SELECT&&t.parent.map&&$.when(t.parent.map.wrap.getMap(),t.parent.layer.wrap.getLayer()).then(function(e,r){var o=t.parent.map.options.styles.selection;t.selectInteraction&&e.removeInteraction(t.selectInteraction);var a=new ol.interaction.Select({layers:[r],style:M({styles:{point:$.extend({},o.point,{fillOpacity:0}),line:o.line,polygon:o.polygon}})});t.selectInteraction=a,e.addInteraction(a);var n=function(e){return e._wrap.parent};a.on("select",function(e){e.selected.length>0&&t.parent.$events.trigger($.Event(TC.Consts.event.FEATURESSELECT,{ctrl:t,features:e.selected.map(n)})),e.deselected.length>0&&0==e.selected.length&&t.parent.$events.trigger($.Event(TC.Consts.event.FEATURESUNSELECT,{ctrl:t.parent,features:e.deselected.map(n)}))}),t.modifyInteraction&&e.removeInteraction(t.modifyInteraction);var i=new ol.interaction.Modify({features:a.getFeatures(),style:M({styles:{point:$.extend({},o.point,{fillOpacity:0}),line:o.line,polygon:o.polygon}})});i.on(ol.interaction.Modify.EventType.MODIFYEND,function(e){e.features.forEach(function(e){e._wrap.parent.geometry=e._wrap.getGeometry(),t.parent.$events.trigger($.Event(TC.Consts.event.FEATUREMODIFY,{feature:e._wrap.parent,layer:t.parent.layer}))})}),t.modifyInteraction=i,e.addInteraction(i),t.snapInteraction&&e.removeInteraction(t.snapInteraction),t.parent.snapping&&(t.snapInteraction=new ol.interaction.Snap({source:r.getSource()}),e.addInteraction(t.snapInteraction))})},TC.wrap.control.Edit.prototype.deactivate=function(){var e=this;e.modifyInteraction&&(e.modifyInteraction.setActive(!1),e.selectInteraction.setActive(!1),$.when(e.parent.map.wrap.getMap()).then(function(t){t.removeInteraction(e.modifyInteraction),e.modifyInteraction=null,e.selectInteraction=null})),e.drawInteraction&&(e.drawInteraction.abortDrawing_(),e.drawInteraction.setActive(!1),$.when(e.parent.map.wrap.getMap()).then(function(t){t.removeInteraction(e.drawInteraction),e.drawInteraction=null})),e.parent.$events.trigger($.Event(TC.Consts.event.CONTROLDEACTIVATE,{ctrl:e}))},TC.wrap.control.Edit.prototype.cancel=function(e,t){var r=this;r.points=[],r.histPoints=[];r.control&&r.control.layer||r.modifyInteraction&&r.modifyInteraction.layer;if(r.selectInteraction){var o=r.selectInteraction.getFeatures();r.parent.$events.trigger($.Event(TC.Consts.event.FEATURESUNSELECT,{ctrl:r.parent,feature:o.get(0)})),o.clear(),r.selectInteraction.setActive(!1)}},TC.wrap.control.Edit.prototype.getSelectedFeatures=function(){var e=this,t=[];return e.selectInteraction&&e.selectInteraction.getFeatures().forEach(function(e){t[t.length]=e._wrap.parent}),t},TC.wrap.control.Edit.prototype.setSelectedFeatures=function(e){var t=this;if(t.selectInteraction){var r=t.selectInteraction.featureOverlay_.getSource();r.clear(),r.addFeatures(e.map(function(e){return e.wrap.feature}))}},TC.wrap.control.Edit.prototype.deleteFeatures=function(e){var t=this;if($.isArray(e)){var r=e.map(function(e){return e.wrap.feature});$.when(t.parent.layer.wrap.getLayer()).then(function(e){for(var o=t.selectInteraction?t.selectInteraction.getFeatures():null,a=0,n=r.length;n>a;a++){var i=r[a];o&&(o.remove(i),t.parent.$events.trigger($.Event(TC.Consts.event.FEATURESUNSELECT,{feature:i._wrap.parent}))),e.getSource().removeFeature(i),t.parent.$events.trigger($.Event(TC.Consts.event.FEATUREREMOVE,{feature:i._wrap.parent}))}})}}}();