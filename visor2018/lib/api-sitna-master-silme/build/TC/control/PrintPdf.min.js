TC.control=TC.control||{};TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control");TC.control.PrintPdf=function(){TC.Control.apply(this,arguments)};TC.inherit(TC.control.PrintPdf,TC.Control);!function(){var e=TC.control.PrintPdf.prototype;e.CLASS="tc-ctl-print-pdf";var t={marginTop:20,marginLeft:55,a4:{width:596,height:842},a3:{width:842,height:1191},qrCode:{sideLength:85},headerHeight:20},n="portrait",i="landscape",r="a4",a=TC.Util.getParameterByName("orientation"),o=TC.Util.getParameterByName("size");TC.isDebug?e.template=TC.apiLocation+"TC/templates/PrintPdf.html":e.template=function(){dust.register(e.CLASS,t);function t(e,t){return e.w('<button disabled class="disabled tc-button tc-ctl-print-pdf-btn" title="').h("i18n",t,{},{$key:"printpdf"}).w('"></button>')}t.__dustBody=!0;return t};var s=function(){var e=window.location.href,t=e.indexOf("?"),n=e.indexOf("#");t>0&&(e=t<n?e.replace(e.substring(t,n),""):e.replace(e.substring(t,e.length-1),""));return e},l=function(e){var n=$.Deferred();e?TC.loadJS("undefined"==typeof QRCode,[TC.apiLocation+"lib/qrcode/qrcode.min.js"],function(){e.length>150&&(e=TC.Util.shortenUrl(e));var i=$("#qrcode");i.empty();new QRCode(i.get(0),{text:e,width:t.qrCode.sideLength,height:t.qrCode.sideLength});setTimeout(function(){var e=i.find("img").attr("src");n.resolve(e)},100)}):n.resolve(imgBase64);return n.promise()};e.register=function(e){var t=this;TC.Control.prototype.register.call(t,e);t.map.mustBeExportable=!0;t.pdfLibPromise=function(){var e=$.Deferred();window.pdfMake?e.resolve():TC.loadJS(!window.pdfMake,[TC.Consts.url.PDFMAKE],function(){e.resolve()});return e.promise()}();var n=!0;e._$div.on("mouseover",function(){if(n){e.toast(t.getLocaleString("print.advice.title")+": "+t.getLocaleString("print.advice.desc"),{type:TC.Consts.msgType.INFO,duration:7e3});n=!1}});var i="."+t.CLASS+"-btn";t.map.$events.on(TC.Consts.event.STARTLOADING,function(){var e=t._$div.find(i);e.addClass("disabled");e.attr("disabled","disabled")});t.map.$events.on(TC.Consts.event.STOPLOADING,function(){var e=t._$div.find(i);e.removeClass("disabled");e.removeAttr("disabled")});t.getLayersFromOpener();t.options.qrCode&&l(s());t._$div.on("click","."+t.CLASS+"-btn",function(){t.createPdf()})};var d=function(){var e=$.Deferred(),n={pageOrientation:a||i,pageSize:o||r,pageMargins:[t.marginLeft,t.marginTop]};e.resolve(n);return e.promise()};e.createPdf=function(){var e=this,i=function(e,i){return e===n?t[i].width:t[i].height}(a,o),r=function(e,i){return e===n?t[i].height:t[i].width}(a,o);e.canvas=$(".tc-map .ol-viewport canvas")[0];e.mapSize=TC.Util.calculateAspectRatioFit(e.canvas.width,e.canvas.height,i-2*t.marginLeft,r-2*t.marginTop-t.headerHeight);var c=function(t){TC.error(e.getLocaleString("print.error"));TC.error("No se ha podido generar el base64 correspondiente a la imagen: "+t,TC.Consts.msgErrorMode.EMAIL,"Error en la impresi\xf3n")},p=e.map.getControlsByClass(TC.control.LoadingIndicator)[0],g=p.addWait(),f=function(){p.removeWait(g)};$.when(e.pdfLibPromise).then(d).then(function(n){n.content=n.content||[];var i=$.Deferred(),r=e.map.getControlsByClass(TC.control.ScaleBar)[0];if(r)var a=$(".tc-ctl-sb .ol-scale-line-inner"),o=e.canvas.width/e.mapSize.width,s=a.width()/o;var l=function(e){var t=[],a=e||{text:""};t.push(a);t.push({text:TC.Util.getParameterByName(TC.Cfg.titleURLParamName),alignment:"center",fontSize:11});r&&t.push({table:{widths:[s],body:[[{text:r.getText(),fontSize:10,alignment:"center"}]]},layout:{hLineWidth:function(e,t){return 0===e?0:1},paddingLeft:function(e,t){return 0},paddingRight:function(e,t){return 0},paddingTop:function(e,t){return 0},paddingBottom:function(e,t){return 0}}});n.content.push({table:{widths:[s,"*",s]},layout:"noBorders"});n.content[0].table.body=[t];i.resolve(n)};e.options.logo?$.when(TC.Util.imgToDataUrl(e.options.logo,"image/png")).then(function(e,n){n.width,n.height;var i=TC.Util.calculateAspectRatioFit(n.width,n.height,s,t.headerHeight);l({image:e,height:i.height,width:i.width})},function(){c(e.options.logo);i.reject()}):l();return i.promise()}).fail(f).then(function(n){var i=$.Deferred();n.content=n.content||[];var r=function(t){n.content.push({table:{widths:["*"],body:[[{image:TC.Util.toDataUrl(t),width:e.mapSize.width}]]},layout:{paddingLeft:function(e,t){return 0},paddingRight:function(e,t){return 0},paddingTop:function(e,t){return.1},paddingBottom:function(e,t){return 0}}});i.resolve(n)};e.options.qrCode?$.when(l(s())).then(function(n){if(n)$.when(TC.Util.addToCanvas(e.canvas,n,{x:e.canvas.width-t.qrCode.sideLength,y:e.canvas.height-t.qrCode.sideLength})).then(function(e){r(e)});else{TC.error(e.getLocaleString("print.qr.error"));r(e.canvas)}}):r(e.canvas);return i.promise()}).then(function(t){var n=$.Deferred(),i=function(e,t,n){if(t.isVisibleByScale(e.name)){var i,r;t.options&&t.options.params&&t.options.params.base64LegendSrc?r=t.options.params.base64LegendSrc:e.legend&&(i=e.legend.src);result.push({src:i,title:e.title,level:n,srcBase64:r})}},r=function(e,t,n,i){if(Array.isArray(e))for(var a=0;a<e.length;a++)r(e[a],t,n,i);else if(e&&e.hasOwnProperty("children")&&e.children.length>0){e.title&&e.name&&result.push({header:e.title,level:i});r(e.children,t,n,++i)}if(e&&e.hasOwnProperty("children")&&0==e.children.length){t.apply(this,[e,n,i]);i--}};if(e.options.legend&&e.options.legend.visible){var o=e.options.legend.orientation||a,s=e.map.workLayers,l=[];t.content=t.content||{};if(s.length>0){for(var d=s.length-1;d>=0;d--){var p=s[d];if(p.type===TC.Consts.layerType.WMS&&p.getVisibility()){result=[];r(p.getTree(),i,p,0);result.length>0&&l.push({title:p.title,layers:result})}}$.when.apply($,function(){for(var e=[],t=0;t<l.length;t++)for(var n=l[t].layers,i=0;i<n.length;i++)!function(n,i){var r=l[t].layers[i],a=r.src||r.srcBase64;if(a){TC.tool&&TC.tool.Proxification||TC.syncLoadJS(TC.apiLocation+"TC/tool/Proxification");e.push($.Deferred());var o=e[e.length-1];new TC.tool.Proxification(TC.proxify,{allowedMixedContent:!0}).getImage(a,!0).then(function(e){if(e.complete){var t=TC.Util.imgTagToDataUrl(e,"image/png");r.image={base64:t.base64,canvas:t.canvas}}else c(a);o.resolve()},function(e){c(a);o.reject()})}}(0,i);return e}()).then(function(){l.length>0&&t.content.push({text:" ",pageBreak:"before",pageOrientation:o});for(var e=0;e<l.length;e++){var i=l[e],r=10;t.content.push({text:i.title,fontSize:11,margin:[0,0,0,5]});for(var a=0;a<i.layers.length;a++){var s=i.layers[a];r=7*s.level;if(!s.header||s.header!==i.title)if(s.header)t.content.push({text:s.header,fontSize:10,margin:[r,0,0,3]});else{t.content.push({text:s.title,fontSize:9,margin:[r,0,0,2]});if(s.image){var d=s.image.canvas.width/2,c=d*s.image.canvas.height/s.image.canvas.width;t.content.push({image:s.image.base64,width:d,height:c,margin:[r,0,0,2]})}}}}n.resolve(t)},function(){n.reject()})}else n.resolve(t)}else n.resolve(t);return n.promise()}).fail(f).then(function(e){var t=window.location.host+"_",n=TC.Util.getParameterByName("title");t+=n||TC.Util.getFormattedDate((new Date).toString(),!0);pdfMake.createPdf(e).download(t.replace(/[\\\/:*?"<>\|]/g,"")+".pdf")}).then(f)};e.getLayersFromOpener=function(e){var t=this,n=window.opener;if(n){var i=n.TC,r=i.printPreview?i.printPreview.refererMap:null;r&&t.map.loaded(function(){for(var e=0;e<t.map.baseLayers.length;e++)t.map.removeLayer(t.map.baseLayers[e]);var n=r.getBaseLayer();t.map.addLayer({id:n.id,title:n.title,type:n.type,url:n.url,encoding:n.encoding,layerNames:n.layerNames,matrixSet:n.matrixSet,format:n.format,minResolution:n.minResolution,maxZoom:n.maxZoom,isBase:!0});var a,o=r.workLayers;for(e=0;e<o.length;e++)(a=o[e]).type===i.Consts.layerType.WMS&&a.options.stateless&&t.map.addLayer({id:a.id,title:a.title,type:a.type,method:a.method,url:a.url,format:a.format,stateless:a.stateless,params:a.params,layerNames:a.layerNames},function(e){e.setVisibility(a.getVisibility());e.setOpacity(a.getOpacity())});var s=i.printPreview.mapFeatures;s&&t.map.addLayer({id:t.getUID(),type:i.Consts.layerType.VECTOR},function(e){i.loadJS(!i.feature,[i.apiLocation+"TC/Feature",i.apiLocation+"TC/feature/Point",i.apiLocation+"TC/feature/Polyline",i.apiLocation+"TC/feature/Polygon",i.apiLocation+"TC/feature/MultiPolygon",i.apiLocation+"TC/feature/MultiPolyline",i.apiLocation+"TC/feature/Circle",i.apiLocation+"TC/feature/Marker"],function(){for(var t=0;t<s.length;t++){var n=s[t];switch(n.CLASSNAME){case"TC.feature.Point":e.addPoint(n.geometry,n.options);break;case"TC.feature.Polyline":e.addPolyline(n.geometry,n.options);break;case"TC.feature.Polygon":e.addPolygon(n.geometry,n.options);break;case"TC.feature.MultiPolygon":e.addMultiPolygon(n.geometry,n.options);break;case"TC.feature.MultiPolyline":e.addMultiPolyline(n.geometry,n.options);break;case"TC.feature.Circle":e.addCircle(n.geometry,n.options);break;case"TC.feature.Marker":e.addMarker(n.geometry,n.options)}}})})})}}}();