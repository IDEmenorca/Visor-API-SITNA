TC.control=TC.control||{};TC.Consts=TC.Consts||{};TC.Consts.SCREEN_SIZE_KEY="TC.Map.screenSize";TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control");TC.control.Scale=function(){TC.Control.apply(this,arguments)};TC.inherit(TC.control.Scale,TC.Control);!function(){var e=TC.control.Scale.prototype;e.CLASS="tc-ctl-scl";TC.isDebug?e.template=TC.apiLocation+"TC/templates/Scale.html":e.template=function(){dust.register(e.CLASS,t);function t(e,t){return e.w('<div class="ol-scale-line ol-unselectable"><span>1:').h("math",t,{},{key:n,method:"round"}).w('</span> <input type="button" value="').f(t.get(["screenSize"],!1),t,"h").w("''\" title=\"").h("i18n",t,{},{$key:"estimatedMapSize"}).w('" /></div>')}t.__dustBody=!0;function n(e,t){return e.f(t.get(["scale"],!1),t,"h")}n.__dustBody=!0;return t};e.render=function(e){var t=this;$("input[type=button]",t._$div).off();t.renderData({scale:t.getScale(),screenSize:TC.Cfg.screenSize},function(){var n=t._$div.find("span");n.text("1:"+t.format(n.text().substr(2)));t._$div.find('input[type="button"]').on(TC.Consts.event.CLICK,function(){t.setScreenSize.call(t)});$.isFunction(e)&&e()})};e.register=function(e){var t=this;TC.Control.prototype.register.call(t,e);var n=TC.Util.storage.getLocalValue(TC.Consts.SCREEN_SIZE_KEY);n&&(TC.Cfg.screenSize=n);t.render(function(){e.on(TC.Consts.event.ZOOM,function(){delete t.metersPerDegree;t.update()})})};e.update=function(){this.render()};e.setScreenSize=function(){var e=this;TC.prompt(e.getLocaleString("selectScreenSize"),TC.Cfg.screenSize,function(t){if(t){TC.Cfg.screenSize=parseFloat(t);TC.Util.storage.setLocalValue(TC.Consts.SCREEN_SIZE_KEY,TC.Cfg.screenSize);e.update()}})};e.getScale=function(e){var t=0,n=!e&&this.map?this.map.wrap.getResolution():e;if(n){t=n*this.getDpi(TC.Cfg.screenSize)/.0254;window.devicePixelRatio&&(t*=window.devicePixelRatio)}if(this.map&&this.map.wrap.isGeo()){if(!this.metersPerDegree){var i=this.map.getExtent();i&&(this.metersPerDegree=TC.Util.getMetersPerDegree(i))}this.metersPerDegree&&(t*=this.metersPerDegree)}return t};e.getDpi=function(e){this.dpi=Math.sqrt(screen.width*screen.width+screen.height*screen.height)/e;return this.dpi};e.format=function(e){for(var t=new Number(e).toFixed(0),n=[];t.length>3;){var i=t.length-3;n.unshift(t.substr(i));t=t.substr(0,i)}t&&n.unshift(t);return n.join(".")}}();