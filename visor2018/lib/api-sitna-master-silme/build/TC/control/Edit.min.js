TC.control=TC.control||{};TC.control.SWCacheClient||TC.syncLoadJS(TC.apiLocation+"TC/control/SWCacheClient");TC.Consts.editMode={SELECT:"select",ADDPOINT:"addpoint",ADDLINE:"addline",ADDPOLYGON:"addpolygon"};TC.Consts.editStyles={NEW:"temporary",SELECTED:"select",DEFAULT:"default"};TC.Consts.event.POINT="point.tc";TC.Consts.event.BEFOREFEATUREMODIFY="beforefeaturemodify.tc";TC.Consts.event.FEATUREMODIFY="featuremodify.tc";TC.Consts.event.FEATURESSELECT="featureselect.tc";TC.Consts.event.FEATURESUNSELECT="featureunselect.tc";!function(){var e=0,t=function(e,t){var n=$.Deferred();TC.loadJS(!window.localforage,[TC.Consts.url.LOCALFORAGE],function(){var o,a;switch(!0){case t instanceof TC.feature.Polygon:a=TC.Consts.geom.POLYGON;break;case t instanceof TC.feature.Polyline:a=TC.Consts.geom.POLYLINE;break;case t instanceof TC.feature.Point:a=TC.Consts.geom.POINT;break;case t instanceof TC.feature.MultiPolygon:a=TC.Consts.geom.MULTIPOLYGON;break;case t instanceof TC.feature.MultiPolyline:a=TC.Consts.geom.MULTIPOLYLINE}o={id:t.id||t.provId,attributes:t.data,type:a,geometry:t.geometry};localforage.setItem(e,o).then(function(){n.resolve({feature:t})}).catch(function(e){n.reject({feature:t,error:e})})});return n.promise()},n=function(e){var t=$.Deferred();TC.loadJS(!window.localforage,[TC.Consts.url.LOCALFORAGE],function(){localforage.removeItem(e).then(function(){t.resolve(e)}).catch(function(e){t.reject(e)})});return t.promise()},o=function(e){var t=$.Deferred();TC.loadJS(!window.localforage,[TC.Consts.url.LOCALFORAGE],function(){localforage.getItem(e).then(function(n){t.resolve({key:e,feature:n})}).catch(function(e){t.reject(e)})});return t.promise()},a=function(e,t){return e.LOCAL_STORAGE_KEY_PREFIX+(t||e.layer.id)},i=function(e,t){return a(e,t)+e.LOCAL_STORAGE_ADDED_KEY_PREFIX},s=function(e,t){return a(e,t)+e.LOCAL_STORAGE_MODIFIED_KEY_PREFIX},r=function(e,t){return a(e,t)+e.LOCAL_STORAGE_REMOVED_KEY_PREFIX},l=function(e){var t=!1;(TC.feature.MultiPolygon&&e instanceof TC.feature.MultiPolygon||TC.feature.MultiPolyline&&e instanceof TC.feature.MultiPolyline)&&e.geometry.length>1&&(t=!0);return t},c=function(e,t){e._$deleteBtn.prop("disabled",0===t.length);e._$joinBtn.prop("disabled",t.length<2);e._$splitBtn.prop("disabled",0===t.filter(l).length)},d=function(e,t){e._$saveBtn.prop("disabled",t);e._$discardBtn.prop("disabled",t);self.checkedOut=!t},u=function(e,t){void 0!==t?d(e,!t):TC.loadJS(!window.localforage,[TC.Consts.url.LOCALFORAGE],function(){var t=a(e);localforage.keys().then(function(n){if(n){for(var o=!0,a=0,i=n.length;a<i;a++)if(0===n[a].indexOf(t)){o=!1;break}d(e,o)}})})},f=function(e,t){var n=$.Deferred(),o=e._changesLayers[t.id];if(o)n.resolve(o);else{o=e._changesLayers[t.id]=new TC.layer.Vector({id:TC.getUID(),title:t.title+" - cambios pendientes",stealth:!0,styles:e.getChangesLayerStyle(t)});var a=e.map.layers.indexOf(t);e.map.insertLayer(o,a+1,function(){n.resolve(o)})}return n.promise()};TC.control.Edit=function(){var o=this;TC.control.SWCacheClient.apply(this,arguments);o._classSelector="."+o.CLASS;o.$events=$(o);o.wrap=new TC.wrap.control.Edit(o);o._layerDeferred=$.Deferred();o.layer=null;o.checkedOut=!1;o.callback=arguments[2]&&$.isFunction(arguments[2])?arguments[2]:o.options.callback?o.options.callback:null;o.multi=!!o.options.multi&&o.options.multi;o.eraseActionConfirmTxt=o.options.eraseText?o.options.eraseText:"\xbfEst\xe1 seguro de eliminar esta(s) geometr\xeda(s)?";o.cancelActionConfirmTxt=o.options.cancelText?o.options.eraseText:"Si continua todos los cambios se perder\xe1n. \xbfDesea continuar?";o.styles=o.options.styles;o.features={};o.attributeEditor=null;o.pointDraw=null;o.lineDraw=null;o.polygonDraw=null;o.snapping="boolean"!=typeof o.options.snapping||o.options.snapping;o._changesLayers={};o._showsChanges="boolean"!=typeof o.options.showChanges||o.options.showChanges;$.isFunction(o.options.getChangesLayerStyleFunction)&&(o.getChangesLayerStyleFunction=o.getChangesLayerStyle);o.$events.on(TC.Consts.event.FEATUREADD,function(n){var a=n.feature;a.provId="NewFeature."+e++;var s=o._changesLayers[o.layer.id];o.features[o.layer.id].added.push(a);s.addFeature(a);t(i(o)+a.provId,a).then(function(){u(o,!0);TC.toast("Adici\xf3n guardada")},function(){TC.error("Fallo al guardar adici\xf3n")})}).on(TC.Consts.event.FEATUREREMOVE,function(e){var a=e.feature,l=a.provId||a.id,c=function(){u(o);TC.toast("Eliminaci\xf3n guardada")},d=function(){TC.error("Fallo al guardar eliminaci\xf3n")},f=o._changesLayers[o.layer.id],y=o.features[o.layer.id],p=y.added.indexOf(a);if(p<0){var C=r(o);if((p=y.modified.indexOf(a))<0){if((p=y.removed.indexOf(a))<0){y.removed.push(a);f.addFeature(a);t(C+a.id,a).then(c,d)}}else{y.modified.splice(p,1);y.removed.push(a);n(s(o)+a.id).then(function(){c();t(C+a.id,a).then(c,d)},d)}}else{f.removeFeature(a);y.added.splice(p,1);n(i(o)+l).then(c,d)}}).on(TC.Consts.event.FEATUREMODIFY,function(e){var n=e.feature,a=n.provId||n.id,r=function(){u(o,!0);TC.toast("Modificaci\xf3n guardada")},l=function(){TC.error("Fallo al guardar modificaci\xf3n")},c=o._changesLayers[o.layer.id],d=o.features[o.layer.id],f=d.added.indexOf(n);if(f<0){if((f=d.modified.indexOf(n))<0){c.addFeature(n);d.modified.push(n)}t(s(o)+a,n).then(r,l)}else t(i(o)+a,n).then(r,l)}).on(TC.Consts.event.FEATUREADD+" "+TC.Consts.event.FEATUREREMOVE+" "+TC.Consts.event.FEATUREMODIFY,function(e){if(o.serviceWorkerEnabled&&navigator.onLine){var t=o.layer.wrap.getGetFeatureUrl(),n=o.layer.wrap.getDescribeFeatureTypeUrl();t&&n&&o.createCache(o.LOCAL_STORAGE_KEY_PREFIX+o.layer.id,{urlList:[t,n]})}}).on(TC.Consts.event.CONTROLDEACTIVATE,function(e){}).on(TC.Consts.event.FEATURESSELECT,function(e){var t=o.getSelectedFeatures();c(o,t);t.length&&t[0].showPopup(o.attributeEditor)}).on(TC.Consts.event.FEATURESUNSELECT,function(e){c(o,o.getSelectedFeatures())})};TC.inherit(TC.control.Edit,TC.control.SWCacheClient);var y=TC.control.Edit.prototype;y.CLASS="tc-ctl-edit";y.LOCAL_STORAGE_KEY_PREFIX="TC.offline.edit.";y.LOCAL_STORAGE_ADDED_KEY_PREFIX=".added.";y.LOCAL_STORAGE_MODIFIED_KEY_PREFIX=".modified.";y.LOCAL_STORAGE_REMOVED_KEY_PREFIX=".removed.";y.template={};if(TC.isDebug){y.template[y.CLASS]=TC.apiLocation+"TC/templates/Edit.html";y.template[y.CLASS+"-attr"]=TC.apiLocation+"TC/templates/EditAttributes.html"}else{y.template[y.CLASS]=function(){dust.register(y.CLASS,e);function e(e,o){return e.w("<h2>").h("i18n",o,{},{$key:"featureEdit"}).w(' <span class="tc-beta">').h("i18n",o,{},{$key:"beta"}).w('</span></h2><div class="tc-ctl-edit-layer"><select class="tc-combo tc-ctl-edit-layer-sel"><option value="">').h("i18n",o,{},{$key:"selectLayerToEdit"}).w("</option>").s(o.get(["layers"],!1),o,{block:t},{}).w('</select><input type="checkbox" id="tc-ctl-edit-view-changes-cb"').x(o.get(["showChanges"],!1),o,{block:n},{}).w(' /><label class="tc-ctl-edit-view-changes" for="tc-ctl-edit-view-changes-cb">').h("i18n",o,{},{$key:"highlightUnsyncedChanges"}).w('</label></div><div class="tc-ctl-edit-mode"><form><label class="tc-ctl-edit-btn-select" title="').h("i18n",o,{},{$key:"select"}).w('"><input type="radio" name="mode" value="select" /><span>').h("i18n",o,{},{$key:"select"}).w('</span></label><label class="tc-ctl-edit-btn-point" title="').h("i18n",o,{},{$key:"newPoint"}).w('"><input type="radio" name="mode" value="addpoint" /><span>').h("i18n",o,{},{$key:"newPoint"}).w('</span></label><label class="tc-ctl-edit-btn-line" title="').h("i18n",o,{},{$key:"newLine"}).w('"><input type="radio" name="mode" value="addline" /><span>').h("i18n",o,{},{$key:"newLine"}).w('</span></label><label class="tc-ctl-edit-btn-polygon" title="').h("i18n",o,{},{$key:"newPolygon"}).w('"><input type="radio" name="mode" value="addpolygon" /><span>').h("i18n",o,{},{$key:"newPolygon"}).w('</span></label></form></div><div class="tc-ctl-edit-select tc-hidden"><button class="tc-ctl-btn tc-ctl-edit-btn-delete" disabled title="').h("i18n",o,{},{$key:"delete"}).w('">').h("i18n",o,{},{$key:"delete"}).w('</button><button class="tc-ctl-btn tc-ctl-edit-btn-join" disabled title="').h("i18n",o,{},{$key:"joinGeometries.tooltip"}).w('">').h("i18n",o,{},{$key:"joinGeometries"}).w('</button><button class="tc-ctl-btn tc-ctl-edit-btn-split" disabled title="').h("i18n",o,{},{$key:"splitGeometry"}).w('">').h("i18n",o,{},{$key:"splitGeometry"}).w('</button><button class="tc-ctl-btn tc-ctl-edit-btn-cancel" disabled title="').h("i18n",o,{},{$key:"cancel"}).w('">').h("i18n",o,{},{$key:"cancel"}).w('</button></div><div class="tc-ctl-edit-point tc-hidden"></div><div class="tc-ctl-edit-line tc-hidden"></div><div class="tc-ctl-edit-polygon tc-hidden"></div><div class="tc-ctl-edit-save"><button class="tc-button tc-icon-button tc-ctl-edit-btn-save" disabled title="').h("i18n",o,{},{$key:"syncChanges"}).w('">').h("i18n",o,{},{$key:"syncChanges"}).w('</button><button class="tc-button tc-icon-button tc-ctl-edit-btn-discard" disabled title="').h("i18n",o,{},{$key:"discardChanges"}).w('">').h("i18n",o,{},{$key:"discardChanges"}).w("</button></div>")}e.__dustBody=!0;function t(e,t){return e.w('<option value="').f(t.get(["id"],!1),t,"h").w('">').f(t.get(["title"],!1),t,"h").w("</option>")}t.__dustBody=!0;function n(e,t){return e.w(" checked")}n.__dustBody=!0;return e};y.template[y.CLASS+"-attr"]=function(){dust.register(y.CLASS+"-attr",t);var e={inputText:O,inputNumber:D,inputCheckbox:B,inputDate:F,inputTime:P,inputDatetime:I};function t(t,o){o=o.shiftBlocks(e);return t.w('<div class="tc-ctl-edit-attr"><h3>').h("i18n",o,{},{$key:"attributeEdit"}).w('</h3><div class="tc-ctl-edit-attr-body"><table><tbody>').s(o.get(["data"],!1),o,{block:n},{}).w('</tbody></table></div><div class="tc-ctl-edit-attr-footer"><button class="tc-button tc-ctl-edit-btn-attr-ok">').h("i18n",o,{},{$key:"ok"}).w('</button><button class="tc-button tc-ctl-edit-btn-attr-cancel">').h("i18n",o,{},{$key:"cancel"}).w("</button></div></div>")}t.__dustBody=!0;function n(t,n){n=n.shiftBlocks(e);return t.w("<tr><th>").f(n.get(["name"],!1),n,"h").w("</th><td>").x(n.get(["readOnly"],!1),n,{else:o,block:N},{}).w("</td></tr>")}n.__dustBody=!0;function o(t,n){n=n.shiftBlocks(e);return t.x(n.get(["availableValues"],!1),n,{block:a},{}).h("select",n,{block:s},{key:n.get(["type"],!1)})}o.__dustBody=!0;function a(t,n){n=n.shiftBlocks(e);return t.w('<select class="tc-combo" name="').f(n.get(["name"],!1),n,"h").w('"><option value=""></option>').s(n.get(["availableValues"],!1),n,{block:i},{}).w("</select>")}a.__dustBody=!0;function i(t,n){n=n.shiftBlocks(e);return t.w('<option value="').f(n.getPath(!0,[]),n,"h").w('">').f(n.getPath(!0,[]),n,"h").w("</option>")}i.__dustBody=!0;function s(t,n){n=n.shiftBlocks(e);return t.h("none",n,{block:r},{}).h("eq",n,{block:l},{value:"int"}).h("eq",n,{block:c},{value:"integer"}).h("eq",n,{block:d},{value:"double"}).h("eq",n,{block:u},{value:"boolean"}).h("eq",n,{block:f},{value:"date"}).h("eq",n,{block:p},{value:"time"}).h("eq",n,{block:C},{value:"dateTime"}).h("eq",n,{block:h},{value:"byte"}).h("eq",n,{block:g},{value:"long"}).h("eq",n,{block:v},{value:"negativeInteger"}).h("eq",n,{block:m},{value:"nonNegativeInteger"}).h("eq",n,{block:b},{value:"nonPositiveInteger"}).h("eq",n,{block:T},{value:"positiveInteger"}).h("eq",n,{block:_},{value:"short"}).h("eq",n,{block:E},{value:"unsignedLong"}).h("eq",n,{block:k},{value:"unsignedInt"}).h("eq",n,{block:L},{value:"unsignedShort"}).h("eq",n,{block:w},{value:"unsignedByte"}).h("eq",n,{block:S},{value:"float"}).h("eq",n,{block:$},{value:"decimal"})}s.__dustBody=!0;function r(t,n){n=n.shiftBlocks(e);return t.b(n.getBlock("inputText"),n,{},{})}r.__dustBody=!0;function l(t,n){n=n.shiftBlocks(e);return t.b(n.getBlock("inputNumber"),n,{},{})}l.__dustBody=!0;function c(t,n){n=n.shiftBlocks(e);return t.b(n.getBlock("inputNumber"),n,{},{})}c.__dustBody=!0;function d(t,n){n=n.shiftBlocks(e);return t.b(n.getBlock("inputNumber"),n,{},{})}d.__dustBody=!0;function u(t,n){n=n.shiftBlocks(e);return t.b(n.getBlock("inputCheckbox"),n,{},{})}u.__dustBody=!0;function f(t,n){n=n.shiftBlocks(e);return t.b(n.getBlock("inputDate"),n,{},{})}f.__dustBody=!0;function p(t,n){n=n.shiftBlocks(e);return t.b(n.getBlock("inputTime"),n,{},{})}p.__dustBody=!0;function C(t,n){n=n.shiftBlocks(e);return t.b(n.getBlock("inputDatetime"),n,{},{})}C.__dustBody=!0;function h(t,n){n=n.shiftBlocks(e);return t.b(n.getBlock("inputNumber"),n,{},{})}h.__dustBody=!0;function g(t,n){n=n.shiftBlocks(e);return t.b(n.getBlock("inputNumber"),n,{},{})}g.__dustBody=!0;function v(t,n){n=n.shiftBlocks(e);return t.b(n.getBlock("inputNumber"),n,{},{})}v.__dustBody=!0;function m(t,n){n=n.shiftBlocks(e);return t.b(n.getBlock("inputNumber"),n,{},{})}m.__dustBody=!0;function b(t,n){n=n.shiftBlocks(e);return t.b(n.getBlock("inputNumber"),n,{},{})}b.__dustBody=!0;function T(t,n){n=n.shiftBlocks(e);return t.b(n.getBlock("inputNumber"),n,{},{})}T.__dustBody=!0;function _(t,n){n=n.shiftBlocks(e);return t.b(n.getBlock("inputNumber"),n,{},{})}_.__dustBody=!0;function E(t,n){n=n.shiftBlocks(e);return t.b(n.getBlock("inputNumber"),n,{},{})}E.__dustBody=!0;function k(t,n){n=n.shiftBlocks(e);return t.b(n.getBlock("inputNumber"),n,{},{})}k.__dustBody=!0;function L(t,n){n=n.shiftBlocks(e);return t.b(n.getBlock("inputNumber"),n,{},{})}L.__dustBody=!0;function w(t,n){n=n.shiftBlocks(e);return t.b(n.getBlock("inputNumber"),n,{},{})}w.__dustBody=!0;function S(t,n){n=n.shiftBlocks(e);return t.b(n.getBlock("inputNumber"),n,{},{})}S.__dustBody=!0;function $(t,n){n=n.shiftBlocks(e);return t.b(n.getBlock("inputNumber"),n,{},{})}$.__dustBody=!0;function O(t,n){n=n.shiftBlocks(e);return t.w('<input type="text" class="tc-textbox" name="').f(n.get(["name"],!1),n,"h").w('" value="').f(n.get(["value"],!1),n,"h").w('" />')}O.__dustBody=!0;function D(t,n){n=n.shiftBlocks(e);return t.w('<input type="number" class="tc-textbox" name="').f(n.get(["name"],!1),n,"h").w('" value="').f(n.get(["value"],!1),n,"h").w('" />')}D.__dustBody=!0;function B(t,n){n=n.shiftBlocks(e);return t.w('<input type="checkbox" name="').f(n.get(["name"],!1),n,"h").w('"').x(n.get(["value"],!1),n,{block:A},{}).w("/>")}B.__dustBody=!0;function A(t,n){n=n.shiftBlocks(e);return t.w(" checked")}A.__dustBody=!0;function F(t,n){n=n.shiftBlocks(e);return t.w('<input type="date" class="tc-textbox" name="').f(n.get(["name"],!1),n,"h").w('" value="').f(n.get(["value"],!1),n,"h").w('" />')}F.__dustBody=!0;function P(t,n){n=n.shiftBlocks(e);return t.w('<input type="time" class="tc-textbox" name="').f(n.get(["name"],!1),n,"h").w('" value="').f(n.get(["value"],!1),n,"h").w('" />')}P.__dustBody=!0;function I(t,n){n=n.shiftBlocks(e);return t.w('<input type="datetime" class="tc-textbox" name="').f(n.get(["name"],!1),n,"h").w('" value="').f(n.get(["value"],!1),n,"h").w('" />')}I.__dustBody=!0;function N(t,n){n=n.shiftBlocks(e);return t.f(n.get(["value"],!1),n,"h")}N.__dustBody=!0;return t}}y.register=function(t){var n=this;TC.control.SWCacheClient.prototype.register.call(n,t);const l=n.getUID(),c=n.getUID(),d=n.getUID();t.addControl("popup",{closeButton:!0}).then(function(e){n.attributeEditor=e});t.on(TC.Consts.event.LAYERUPDATE,function(t){if(t.layer.type===TC.Consts.layerType.WFS&&!t.layer.options.stealth){var l=t.layer,c=n.features[t.layer.id]=n.features[t.layer.id]||{added:[],modified:[],removed:[]};f(n,l).then(function(t){n.layer!==l&&t.setVisibility(!1);var d=a(n,l.id),u=i(n,l.id),f=s(n,l.id),y=r(n,l.id);TC.loadJS(!window.localforage,[TC.Consts.url.LOCALFORAGE],function(){TC.getUID();localforage.keys().then(function(n){if(n)for(var a=0,i=n.length;a<i;a++){var s=n[a];0===s.indexOf(d)&&o(s).then(function(n){var o,a=n.key;if(0===a.indexOf(y)){o=a.substr(y.length);var i=l.getFeatureById(o);l.removeFeature(i);t.addFeature(i);c.removed.push(i)}else if(0===a.indexOf(f)){o=a.substr(f.length);if(i=l.getFeatureById(o)){t.addFeature(i);c.modified.push(i);i.wrap.setGeometry(n.feature.geometry);i.setData(n.feature.attributes)}}else if(0===a.indexOf(u)){o=a.substr(u.length);var s,r=parseInt(o.substr(o.lastIndexOf(".")+1));e=Math.max(e,r+1);switch(n.feature.type){case TC.Consts.geom.POINT:s=l.addPoint(n.feature.geometry);break;case TC.Consts.geom.POLYLINE:s=l.addPolyline(n.feature.geometry);break;case TC.Consts.geom.POLYGON:s=l.addPolygon(n.feature.geometry);break;case TC.Consts.geom.MULTIPOLYLINE:s=l.addMultiPolyline(n.feature.geometry);break;case TC.Consts.geom.MULTIPOLYGON:s=l.addMultiPolygon(n.feature.geometry)}s.then(function(e){t.addFeature(e);c.added.push(e);e.provId=o;e.setData(n.feature.attributes)})}})}})})})}}).on(TC.Consts.event.LAYERADD,function(e){if(e.layer.type===TC.Consts.layerType.WFS&&!e.layer.options.stealth){n.features[e.layer.id]=n.features[e.layer.id]||{added:[],modified:[],removed:[]};$("<option>").attr("value",e.layer.id).html(e.layer.title||e.layer.id).appendTo(n._$layerSelect)}}).on(TC.Consts.event.LAYERREMOVE,function(e){if(e.layer.type===TC.Consts.layerType.WFS&&!e.layer.options.stealth){var t=n._$layerSelect.find("option[value="+e.layer.id+"]");t.filter(":selected").length>0&&n.setLayer(null);t.remove()}}).on(TC.Consts.event.POPUP,function(e){if(e.control===n.attributeEditor){for(var t=e.control.currentFeature,o=n.attributes.slice(),a={},i=n._joinedFeatureAttributes||[],s=0,r=o.length;s<r;s++){var l=t.getData()||{},c=o[s];c.value=l[c.name];"id"===c.name&&(c.readOnly=!0);c.availableValues=[];for(var d=0,u=i.length;d<u;d++){var f=i[d][c.name];void 0!==f&&""!==f&&(c.availableValues[c.availableValues.length]=f)}a[c.name]=c.type}o.sort(function(e,t){return(e.readOnly?!t.readOnly:t.readOnly)?!e.readOnly-!t.readOnly:e.name>t.name?1:e.name<t.name?-1:0});n.getRenderedHtml(n.CLASS+"-attr",{data:o},function(e){var o=n.attributeEditor.$contentDiv;o.html(e);var i=o.find("input"),s=o.find("select");i.on("input",function(e){var t=$(e.target),n=s.filter("[name="+t.attr("name")+"]");n.val()!==t.val()&&n.val("")});s.on("change",function(e){var t=$(e.target);i.filter("[name="+t.attr("name")+"]").val(t.val())});o.find("."+n.CLASS+"-btn-attr-ok").on("click",function(){var e={};i.each(function(t,n){var o=(i=$(n)).attr("name"),s=i.val();switch(a[o]){case"int":case"integer":case"byte":case"long":case"negativeInteger":case"nonNegativeInteger":case"nonPositiveInteger":case"positiveInteger":case"short":case"unsignedLong":case"unsignedInt":case"unsignedShort":case"unsignedByte":s=parseInt(s);Number.isNaN(s)||(e[o]=s);break;case"double":case"float":case"decimal":s=parseFloat(s);Number.isNaN(s)||(e[o]=s);break;case"date":case"time":case"dateTime":e[o]=new Date(s);break;case"boolean":e[o]=!!s;break;case void 0:break;default:e[o]=s}});t.setData(e);n.$events.trigger($.Event(TC.Consts.event.FEATUREMODIFY,{feature:t,layer:n.layer}));n.attributeEditor.hide()});o.find("."+n.CLASS+"-btn-attr-cancel").on("click",function(){n.attributeEditor.hide()})})}});t.loaded(function(){if(n.options.layer)n.setLayer(n.options.layer);else{var e=t.workLayers.filter(function(e){return e.type===TC.Consts.layerType.WFS&&!e.options.stealth});1===e.length?n.setLayer(e[0].id):n.setLayer(null)}n.showChanges(n._showsChanges);n.renderPromise().then(function(){$.when.apply(n,[t.addControl("draw",{id:l,div:n._$div.find("."+n.CLASS+"-point"),mode:TC.Consts.geom.POINT,layer:!1}),t.addControl("draw",{id:c,div:n._$div.find("."+n.CLASS+"-line"),mode:TC.Consts.geom.POLYLINE,layer:!1}),t.addControl("draw",{id:d,div:n._$div.find("."+n.CLASS+"-polygon"),mode:TC.Consts.geom.POLYGON,layer:!1})]).then(function(e,t,o){n.pointDraw=e;n.lineDraw=t;n.polygonDraw=o;var a=function(e){var t,o=e.feature;switch(n.geometryType){case TC.Consts.geom.POINT:t=TC.feature.Point;break;case TC.Consts.geom.POLYLINE:t=TC.feature.Polyline;break;case TC.Consts.geom.POLYGON:t=TC.feature.Polygon;break;case TC.Consts.geom.MULTIPOLYLINE:t=TC.feature.MultiPolyline;break;case TC.Consts.geom.MULTIPOLYGON:t=TC.feature.MultiPolygon}t&&(o=new t(o.geometry,{geometryName:n.layer.options.geometryName}));n.layer.addFeature(o);n.$events.trigger($.Event(TC.Consts.event.FEATUREADD,{feature:o}))},i=function(){n.cancel()};e.on(TC.Consts.event.DRAWEND,a).on(TC.Consts.event.DRAWCANCEL,i);t.on(TC.Consts.event.DRAWEND,a).on(TC.Consts.event.DRAWCANCEL,i);o.on(TC.Consts.event.DRAWEND,a).on(TC.Consts.event.DRAWCANCEL,i);n.options.modes&&$.isArray(n.options.modes)&&1==n.options.modes.length&&n.setMode(n.options.modes[0],null)})})})};y.render=function(e){var t=this,n=[];if(t.map)for(var o=0,a=t.map.workLayers.length;o<a;o++){var i=t.map.workLayers[o];i.type!==TC.Consts.layerType.WFS||i.options.stealth||n.push({id:i.id,title:i.title||i.id})}TC.Control.prototype.renderData.call(t,{layers:n,showChanges:t.showChanges},function(){t._$layerDiv=t._$div.find(t._classSelector+"-layer");t._$layerSelect=t._$layerDiv.find(t._classSelector+"-layer-sel").on("change",function(e){t.setLayer(t._$layerSelect.val())});t._$layerDiv.find("#"+t.CLASS+"-view-changes-cb").on("change",function(e){t.showChanges($(e.target).prop("checked"))});t._$cancelBtn=t._$div.find(t._classSelector+"-btn-cancel").on("click",function(){t.cancel()});t._$deleteBtn=t._$div.find(t._classSelector+"-btn-delete").on("click",function(){TC.confirm(t.eraseActionConfirmTxt,function(){t.deleteFeatures(t.getSelectedFeatures())})});t._$joinBtn=t._$div.find(t._classSelector+"-btn-join").on("click",function(){t.joinFeatures(t.getSelectedFeatures())});t._$splitBtn=t._$div.find(t._classSelector+"-btn-split").on("click",function(){t.splitFeatures(t.getSelectedFeatures())});t._$saveBtn=t._$div.find(t._classSelector+"-btn-save").on("click",function(){t.applyEdits()});t._$discardBtn=t._$div.find(t._classSelector+"-btn-discard").on("click",function(){t.discardEdits()});if(t.options.modes&&$.isArray(t.options.modes)&&t.options.modes.length>0){for(var n in TC.Consts.editMode)if("string"==typeof n&&t.options.modes.indexOf(TC.Consts.editMode[n])<0){$("label"+t._classSelector+"-btn-"+TC.Consts.editMode[n],t._$div).remove();$("div"+t._classSelector+"-"+TC.Consts.editMode[n],t._$div).remove()}if(1==t.options.modes.length){var o=t.options.modes[0];$("label"+t._classSelector+"-btn-"+o,t._$div).css("display","none")}}t._$div.find("input[type=radio][name=mode]").on("change",function(){var e=$(this).val(),n=t.mode===e?void 0:e;t.setMode(n)});$.isFunction(e)&&e()})};y.setLayer=function(e){var t=this;t.layer=map.getLayer(e);t.setMode(null);if(t.layer){f(t,t.layer).then(function(e){for(var n in t._changesLayers){var o=t._changesLayers[n];o.setVisibility(t._showsChanges&&o===e)}});t.layer.describeFeatureType().then(function(e){t.attributes=e.filter(function(e){switch(e.type){case"gml:LinearRingPropertyType":case"gml:PolygonPropertyType":t.geometryType=TC.Consts.geom.POLYGON;return!1;case"gml:MultiPolygonPropertyType":case"gml:MultiSurfacePropertyType":t.geometryType=TC.Consts.geom.MULTIPOLYGON;return!1;case"gml:LineStringPropertyType":t.geometryType=TC.Consts.geom.POLYLINE;return!1;case"gml:MultiLineStringPropertyType":t.geometryType=TC.Consts.geom.MULTIPOLYLINE;return!1;case"gml:PointPropertyType":case"gml:MultiPointPropertyType":t.geometryType=TC.Consts.geom.POINT;return!1;case"gml:BoxPropertyType":t.geometryType=TC.Consts.geom.RECTANGLE;return!1;case"gml:GeometryCollectionPropertyType":case"gml:GeometryAssociationType":return!1;default:return!0}});for(var n=0,o=t.attributes.length;n<o;n++){var a=t.attributes[n];a.type=a.type.substr(a.type.indexOf(":")+1)}t.renderPromise().then(function(){u(t);t._$div.find(t._classSelector+"-layer-sel").val(t.layer.id);$rb=t._$div.find("input[type=radio][name=mode]");var e;switch(t.geometryType){case TC.Consts.geom.POINT:e="[value=select],[value="+TC.Consts.editMode.ADDPOINT+"]";break;case TC.Consts.geom.POLYLINE:case TC.Consts.geom.MULTIPOLYLINE:e="[value=select],[value="+TC.Consts.editMode.ADDLINE+"]";break;case TC.Consts.geom.POLYGON:case TC.Consts.geom.MULTIPOLYGON:e="[value=select],[value="+TC.Consts.editMode.ADDPOLYGON+"]";break;default:e="[value]"}var n=$rb.filter(e).attr("disabled",!1);$rb.not(n).attr("disabled",!0)})});t._layerDeferred.resolve(t.layer)}else{t.renderPromise().then(function(){u(t,!1);$rb=t._$div.find("input[type=radio][name=mode]").attr("disabled",!0);$rb.each(function(e,t){$(t).prop("checked",!1)})});t._layerDeferred.resolve(null)}};y.setMode=function(e){var t=this;t.mode=e;!function(e){e._$deleteBtn.prop("disabled",!0);e._$joinBtn.prop("disabled",!0);e._$splitBtn.prop("disabled",!0)}(t);var n,o,a=function(e){if(e){t.snapping&&(e.snapping=t.layer);e.activate()}};switch(e){case TC.Consts.editMode.SELECT:n=t._$div.find(t._classSelector+"-select");o=t._$div.find(t._classSelector+"-point,"+t._classSelector+"-line,"+t._classSelector+"-polygon");t.activate();break;case TC.Consts.editMode.ADDPOINT:n=t._$div.find(t._classSelector+"-point");o=t._$div.find(t._classSelector+"-select,"+t._classSelector+"-line,"+t._classSelector+"-polygon");a(t.pointDraw);break;case TC.Consts.editMode.ADDLINE:n=t._$div.find(t._classSelector+"-line");o=t._$div.find(t._classSelector+"-select,"+t._classSelector+"-point,"+t._classSelector+"-polygon");a(t.lineDraw);break;case TC.Consts.editMode.ADDPOLYGON:n=t._$div.find(t._classSelector+"-polygon");o=t._$div.find(t._classSelector+"-select,"+t._classSelector+"-point,"+t._classSelector+"-line");a(t.polygonDraw);break;default:n=$();o=t._$div.find(t._classSelector+"-select,"+t._classSelector+"-point,"+t._classSelector+"-line,"+t._classSelector+"-polygon");t.isActive&&t.deactivate();t.pointDraw&&t.pointDraw.isActive&&t.pointDraw.deactivate();t.lineDraw&&t.lineDraw.isActive&&t.lineDraw.deactivate();t.polygonDraw&&t.polygonDraw.isActive&&t.polygonDraw.deactivate()}e?t._$div.find("input[type=radio][name=mode][value="+e+"]").prop("checked",!0).addClass(TC.Consts.classes.CHECKED).next().addClass(TC.Consts.classes.CHECKED):t._$div.find("input[type=radio][name=mode]").prop("checked",!1).removeClass(TC.Consts.classes.CHECKED).next().removeClass(TC.Consts.classes.CHECKED);n.removeClass(TC.Consts.classes.HIDDEN);o.addClass(TC.Consts.classes.HIDDEN)};y.showChanges=function(e){this._showsChanges=e;for(var t in this._changesLayers){this._changesLayers[t].setVisibility(e&&this.layer&&t===this.layer.id)}};y.cancel=function(){this.options.modes&&$.isArray(this.options.modes)&&1==this.options.modes.length?this.setMode(this.options.modes[0],null):this.setMode(null,!1);this.wrap.cancel(!0,this.cancelActionConfirmTxt)};y.onFeatureClick=function(e){self.activeControl&&self.activeControl.isExclusive()||e.feature.show()};y.activate=function(e){var t=this;TC.Control.prototype.activate.call(t);var n=e||{};t._$cancelBtn.prop("disabled",!1);$.when(t.getLayer()).then(function(){t.wrap.activate(n.mode?n.mode:t.mode);TC.Control.prototype.activate.call(t)})};y.deactivate=function(){TC.Control.prototype.deactivate.call(this);this.wrap.cancel(!0);this._$cancelBtn.prop("disabled",!0);this.wrap.deactivate()};y.isExclusive=function(){return!0};y.joinFeatures=function(e){var t=this;if(t.geometryType===TC.Consts.geom.MULTIPOLYLINE||t.geometryType===TC.Consts.geom.MULTIPOLYGON||t.geometryType===TC.Consts.geom.MULTIPOINT){t._joinedFeatureAttributes=[];if(e.length>1){for(var n=e.map(function(e){t._joinedFeatureAttributes[t._joinedFeatureAttributes.length]=e.getData();return e.geometry}).reduce(function(e,t){return e.concat(t)}),o=new e[0].constructor(n),a=0,i=e.length;a<i;a++){var s=e[a];t.layer.removeFeature(s);t.$events.trigger($.Event(TC.Consts.event.FEATUREREMOVE,{feature:s}))}t.layer.addFeature(o).then(function(e){t.setSelectedFeatures([o]);t.$events.trigger($.Event(TC.Consts.event.FEATUREADD,{feature:e}));e.showPopup(t.attributeEditor)})}c(t,[o])}};y.splitFeatures=function(e){for(var t=this,n=e.filter(l),o=n.map(function(e){return e.geometry}),a=[],i=0,s=n.length;i<s;i++)for(var r=(p=n[i]).getData(),d=o[i],u=0,f=d.length;u<f;u++)a[a.length]=new p.constructor([d[u]],{data:r});i=0;for(var y=n.length;i<y;i++){var p=n[i];t.layer.removeFeature(p);t.$events.trigger($.Event(TC.Consts.event.FEATUREREMOVE,{feature:p}))}var C=new Array(a.length);for(i=0,y=a.length;i<y;i++){(C[i]=t.layer.addFeature(a[i])).then(function(e){t.$events.trigger($.Event(TC.Consts.event.FEATUREADD,{feature:e}))})}$.when.apply(this,C).then(function(){t.setSelectedFeatures(a)});c(t,a)};y.deleteFeatures=function(e){this.wrap.deleteFeatures(e);0===this.layer.features.length&&this._$deleteBtn.prop("disabled",!0)};y.applyEdits=function(){var e=this;if(e.layer){var t=e.features[e.layer.id];e.layer.applyEdits(t.added,t.modified,t.removed).then(function(){e.discardEdits();e.map.toast("Cambios sincronizados con \xe9xito con el servidor")},function(e){TC.error("Error ["+e.code+"] al guardar cambios: "+e.reason)})}};y.discardEdits=function(){var e=this;e._joinedFeatureAttributes=[];var t=a(e);TC.loadJS(!window.localforage,[TC.Consts.url.LOCALFORAGE],function(){localforage.keys().then(function(n){if(n){for(var o=0,a=n.length;o<a;o++){var i=n[o];0===i.indexOf(t)&&localforage.removeItem(i)}if(e.layer){var s=e.features[e.layer.id];s.added.length=0;s.modified.length=0;s.removed.length=0;e.setSelectedFeatures([]);e.attributeEditor.hide();e._changesLayers[e.layer.id].clearFeatures();e.deleteCache(t).then(function(){e.layer.refresh()})}u(e,!1)}})})};y.getSelectedFeatures=function(){return this.wrap.getSelectedFeatures()};y.setSelectedFeatures=function(e){return this.wrap.setSelectedFeatures(e)};y.getLayer=function(){return this.layer||this._layerDeferred};y.getChangesLayerStyle=function(e){var t=function(t){for(var n,o=e.wrap.getRGBA(t),a=0;a<3;a++)o[a]=255-o[a];4===(n=(65536*o[0]+256*o[1]+o[2]).toString(16)).length?n="00"+n:5===n.length&&(n="0"+n);return"#"+n},n=[1,3],o=$.extend(!0,{},e.options.styles);if(o.point){o.point.strokeColor=t(o.point.strokeColor);o.point.lineDash=n}if(o.line){o.line.strokeColor=t(o.line.strokeColor);o.line.lineDash=n}if(o.polygon){o.polygon.strokeColor=t(o.polygon.strokeColor);o.polygon.lineDash=n}return o}}();