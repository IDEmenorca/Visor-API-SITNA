TC.control=TC.control||{};TC.control.MapContents||TC.syncLoadJS(TC.apiLocation+"TC/control/MapContents");TC.control.TOC=function(){TC.control.MapContents.apply(this,arguments)};TC.inherit(TC.control.TOC,TC.control.MapContents);!function(){var t=TC.control.TOC.prototype;t.CLASS="tc-ctl-toc";t.template={};if(TC.isDebug){t.template[t.CLASS]=TC.apiLocation+"TC/templates/TOC.html";t.template[t.CLASS+"-branch"]=TC.apiLocation+"TC/templates/TOCBranch.html";t.template[t.CLASS+"-node"]=TC.apiLocation+"TC/templates/TOCNode.html"}else{t.template[t.CLASS]=function(){dust.register(t.CLASS,e);function e(t,e){return t.w("<h2>").h("i18n",e,{},{$key:"worklayers"}).w('</h2><div class="tc-ctl-toc-tree"><form><div class="tc-ctl-toc-empty">').h("i18n",e,{},{$key:"noData"}).w('</div><ul class="tc-ctl-toc-branch tc-ctl-toc-wl">').s(e.get(["workLayers"],!1),e,{block:n},{}).w("</ul></form></div>")}e.__dustBody=!0;function n(t,e){return t.p("tc-ctl-toc-wlbranch",e,e.rebase(e.getPath(!0,[])),{})}n.__dustBody=!0;return e};t.template[t.CLASS+"-branch"]=function(){dust.register(t.CLASS+"-branch",e);function e(t,e){return t.w("<li ").x(e.get(["children"],!1),e,{else:n,block:a},{}).w(' data-tc-layer-name="').f(e.get(["name"],!1),e,"h").w('" data-tc-layer-uid="').f(e.get(["uid"],!1),e,"h").w('"><input type="checkbox" class="tc-ctl-toc-branch-cb" name="toc" value="').f(e.get(["name"],!1),e,"h").w('"').x(e.get(["isVisible"],!1),e,{block:i},{}).w(" /><span>").f(e.get(["title"],!1),e,"h").w('</span><ul class="tc-ctl-toc-branch">').s(e.get(["children"],!1),e,{block:c},{}).w("</ul></li>")}e.__dustBody=!0;function n(t,e){return t.w('class="tc-ctl-toc-node tc-ctl-toc-leaf"')}n.__dustBody=!0;function a(t,e){return t.w('class="tc-ctl-toc-node"')}a.__dustBody=!0;function i(t,e){return t.w(" checked")}i.__dustBody=!0;function c(t,e){return t.p("tc-ctl-toc-node",e,e.rebase(e.getPath(!0,[])),{})}c.__dustBody=!0;return e};t.template[t.CLASS+"-node"]=function(){dust.register(t.CLASS+"-node",e);function e(t,e){return t.w("<li ").x(e.get(["children"],!1),e,{else:n,block:a},{}).w(' data-tc-layer-name="').f(e.get(["name"],!1),e,"h").w('" data-tc-layer-uid="').f(e.get(["uid"],!1),e,"h").w('"><input type="checkbox" name="toc" value="').f(e.get(["name"],!1),e,"h").w('"').x(e.get(["isVisible"],!1),e,{block:i},{}).w(" /><span>").f(e.get(["title"],!1),e,"h").w('</span><ul class="tc-ctl-toc-branch">').s(e.get(["children"],!1),e,{block:c},{}).w("</ul></li>")}e.__dustBody=!0;function n(t,e){return t.w('class="tc-ctl-toc-node tc-ctl-toc-leaf"')}n.__dustBody=!0;function a(t,e){return t.w('class="tc-ctl-toc-node"')}a.__dustBody=!0;function i(t,e){return t.w(" checked")}i.__dustBody=!0;function c(t,e){return t.p("tc-ctl-toc-node",e,e.rebase(e.getPath(!0,[])),{})}c.__dustBody=!0;return e}}var e="tcLayer",n="tcLayerUid";t.register=function(t){var e=this;TC.control.MapContents.prototype.register.call(e,t);e._addBrowserEventHandlers();t.on(TC.Consts.event.EXTERNALSERVICEADDED,function(n){if(n&&n.layer){n.layer.map=t;t.addLayer(n.layer);e.updateLayerTree(n.layer)}})};t._addBrowserEventHandlers=function(){var t=this;t._$div.on("click.tc","input[type=checkbox]",function(a){var i=$(a.target),c=i.closest("ul."+t.CLASS+"-wl").children("li").has(i).data(e),o=i.parents("li").first().data(n),r=i.prop("checked");c.setNodeVisibility(o,r);a.stopPropagation()}).on(TC.Consts.event.MOUSEUP,"li",function(e){var n=$(e.target);if(!n.hasClass(t.CLASS+"-leaf")){n.toggleClass(TC.Consts.classes.COLLAPSED);n.find("ul").first().toggleClass(TC.Consts.classes.COLLAPSED);e.stopPropagation()}})};t.update=function(){var t=function(t){return t.children("input[type=checkbox]")};this._$div.find("ul."+this.CLASS+"-wl").first().children("li").each(function(a,i){var c=$(i),o=c.data(e);if(o){var r=o.getVisibility();t(c).prop("checked",r);o.tree=null;c.find("li").each(function(e,a){var i=$(a),c=t(i),r=i.data(n);switch(o.getNodeVisibility(r)){case TC.Consts.visibility.VISIBLE:case TC.Consts.visibility.NOT_VISIBLE_AT_RESOLUTION:c.prop("checked",!0);c.prop("indeterminate",!1);break;case TC.Consts.visibility.HAS_VISIBLE:c.prop("checked",!1);c.prop("indeterminate",!0);break;default:c.prop("checked",!1);c.prop("indeterminate",!1)}})}});this.updateScale()};t.updateScale=function(){var t=this;t._$div.find("ul."+t.CLASS+"-wl").children("li").each(function(a,i){var c=$(i),o=c.data(e);c.find("li").each(function(e,a){var i=$(a);i.toggleClass(t.CLASS+"-node-notvisible",!o.isVisibleByScale(i.data(n)))})})};t.updateLayerTree=function(t){var a=this;if(!t.isBase&&!t.options.stealth){TC.control.MapContents.prototype.updateLayerTree.call(a,t);a._$div.find("."+a.CLASS+"-empty").addClass(TC.Consts.classes.HIDDEN);var i=a.CLASS+"-branch";TC.loadJSInOrder(!window.dust,TC.url.templating,function(){dust.render(i,a.layerTrees[t.id],function(i,c){var o=$(c);Modernizr.canvas||o.find("li:last-child").addClass(TC.Consts.classes.LASTCHILD);var r=o.data(n),l=a._$div.find("."+a.CLASS+"-wl"),s=l.find('li[data-tc-layer-uid="'+r+'"]');if(1===s.length){s.html(o.html());s.data(e)||s.data(e,t)}else{o.data(e,t);l.prepend(o)}i&&TC.error(i)});var c="ul."+a.CLASS+"-wl",o="ul."+a.CLASS+"-branch",r="li."+a.CLASS+"-node",l="li."+a.CLASS+"-leaf";a._$div.find(c+" "+o+" "+o+","+c+" "+o+" "+r).not(l).addClass(TC.Consts.classes.COLLAPSED);a.update()})}};t.removeLayer=function(t){if(!t.isBase){var n=this,a=function(){return n._$div.find("."+n.CLASS+"-wl").children("li")},i=a();i.each(function(n,c){var o=$(c);if(o.data(e)===t){o.remove();i=a();return!1}});0===i.length&&n._$div.find("."+n.CLASS+"-empty").removeClass(TC.Consts.classes.HIDDEN)}};t.updateLayerVisibility=function(t){var n=this;n._$div.find("."+n.CLASS+"-wl").children("li").each(function(a,i){var c=$(i);if(c.data(e)===t){var o=!t.getVisibility(),r=c.find("input[type=checkbox]"),l=r.filter("."+n.CLASS+"-branch-cb");l.prop("checked",!o);r.not(l).prop("disabled",o);return!1}})};t.updateLayerOrder=function(t,e,n){};t.render=function(t){var e=this;TC.Control.prototype.render.call(e,function(){var n=e.options.controls||[];if(n.length>0){var a=n[0],i=$("<div/>");e._$div.append(i);e.map.addControl(a.name,$.extend({div:i},a.options))}$.isFunction(t)&&t()})}}();