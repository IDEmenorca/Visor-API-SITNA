TC.control=TC.control||{};TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control");TC.control.ExternalWMS=function(e){if(TC.isLegacy)console.warn("El control ExternalWMS no soporta modo legacy");else{this.count=0;this._addedUrls=[];TC.Control.apply(this,arguments);this.allowReprojection="boolean"!=typeof this.options.allowReprojection||this.options.allowReprojection}};TC.inherit(TC.control.ExternalWMS,TC.Control);!function(){var e=TC.control.ExternalWMS.prototype;e.CLASS="tc-ctl-xwms";e.markServicesAsSelected=function(e){if(e.length>0){var t=$(e[0]);t.attr("disabled","true");t.addClass("tc-ctl-xwms-option-selected")}};e.register=function(e){if(TC.isLegacy)console.warn("El control ExternalWMS no soporta modo legacy");else{var t=this;TC.Control.prototype.register.call(t,e);t._$div.on("change","select",function(e){if(""!=this.value){var r=this.value;0===r.indexOf("//")&&(r=location.protocol+r);t._$div.find("input").val(r);$(this).val("")}});t._$div.on("click","button[name='agregar']",function(e){var r=t._$div.find("input").val().trim();if(r)if(/^((https?|ftp):)?(\/\/)?(((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?(((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?)(:\d*)?)(\/((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)?(\?((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(\#((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/i.test(r))if(t._addedUrls.indexOf(r)>-1)TC.alert(t.getLocaleString("serviceAlreadyAdded"));else{var o=t.map.getControlsByClass("TC.control.LoadingIndicator")[0];o.show();var i=TC.Util.getQueryStringParams(r),n=["version","service","request"],a=function(e,t){for(var r=0;r<t.length;r++)e=TC.Util.removeURLParameter(e,t[r]);e.match(/\?$/)&&(e=e.substr(0,e.length-1));return e}(r,Object.keys(i));for(var d in i)n.indexOf(d.toLowerCase())>=0&&delete i[d];var l=t._$div.find("button");l.attr("disabled","true");for(var u={id:"xwms"+ ++t.count,type:"WMS",url:a,hideTree:!1,queryParams:i},s=0;s<t.options.suggestions.length;s++){var c=$.grep(t.options.suggestions[s].items,function(e,t){return e.url===r});if(c.length>0&&c[0].layerNames){u.layerNames=c[0].layerNames;break}}var F=new TC.layer.Raster(u);F.getCapabilitiesPromise().then(function(e){if(void 0!==e.Capability){var i=e.Capability.Layer;if(!i.CRS||-1!=i.CRS.indexOf(t.map.crs)||t.allowReprojection){t.map.$events.trigger($.Event(TC.Consts.event.EXTERNALSERVICEADDED,{layer:F}));t._$div.find("input").val("");var n=t._$div.find("select option[value='"+r+"']");t.markServicesAsSelected(n);t._addedUrls.push(r);o.hide();l.removeAttr("disabled")}else{TC.alert(t.getLocaleString("serviceSrsNotCompatible"));o.hide();l.removeAttr("disabled")}}else{TC.alert(t.getLocaleString("noLayersFoundInService"));o.hide();l.removeAttr("disabled")}},function(e){TC.alert(t.getLocaleString("serviceCouldNotBeLoaded")+":\n"+e);o.hide();l.removeAttr("disabled")})}else TC.alert(t.getLocaleString("typeAValidAddress"));else TC.alert(t.getLocaleString("typeAnAddress"))});e.on(TC.Consts.event.LAYERADD,function(e){if(e.layer&&!e.layer.isBase){var r=e.layer.url;if(r){t.pending_markServicesAsSelected=t.pending_markServicesAsSelected||[];0===t._$div.find("select option").length&&r&&-1===t.pending_markServicesAsSelected.indexOf(r)&&t.pending_markServicesAsSelected.push(r);var o=t._$div.find("select option").filter(function(e,t){return TC.Util.addProtocol(t.value)===TC.Util.addProtocol(r)});t.markServicesAsSelected(o);t._addedUrls.push(r)}}})}};e.template={};TC.isDebug?e.template[e.CLASS]=TC.apiLocation+"TC/templates/ExternalWMS.html":e.template[e.CLASS]=function(){dust.register(e.CLASS,t);function t(e,t){return e.x(t.get(["title"],!1),t,{block:r},{}).w('<div><div class="tc-group tc-ctl-xwms-cnt"> <select id="add-wms-select" class="tc-combo" title="WMS (Web Map Service)"><option value="">WMS</option>').s(t.get(["suggestions"],!1),t,{block:o},{}).w('</select><input type="text" class="tc-textbox" placeholder="').h("i18n",t,{},{$key:"writeAddressOrSelect"}).w('" /></div><div class="tc-group tc-group tc-ctl-xwms-cnt" style="text-align:right;"><button type="button" class="tc-button tc-icon-button" title="').h("i18n",t,{},{$key:"addService.title"}).w('" name="agregar">').h("i18n",t,{},{$key:"addService"}).w("</button></div></div>")}t.__dustBody=!0;function r(e,t){return e.w("<h2>").h("i18n",t,{},{$key:"addMaps"}).w("</h2>")}r.__dustBody=!0;function o(e,t){return e.x(t.get(["group"],!1),t,{block:i},{}).s(t.get(["items"],!1),t,{block:n},{}).x(t.get(["group"],!1),t,{block:a},{})}o.__dustBody=!0;function i(e,t){return e.w('<optgroup label="').f(t.get(["group"],!1),t,"h").w('">')}i.__dustBody=!0;function n(e,t){return e.w('<option value="').f(t.get(["url"],!1),t,"h").w('">').f(t.get(["name"],!1),t,"h").w("</option>")}n.__dustBody=!0;function a(e,t){return e.w("\t</optgroup>")}a.__dustBody=!0;return t};e.render=function(e){var t=this;t.renderData(t.options,function(){t.pending_markServicesAsSelected=t.pending_markServicesAsSelected||[];t.pending_markServicesAsSelected.forEach(function(e){var r=t._$div.find("select option").filter(function(t,r){return TC.Util.addProtocol(r.value)===TC.Util.addProtocol(e)});t.markServicesAsSelected(r);t._addedUrls.push(e)});t.pending_markServicesAsSelected=[]})}}();