TC.control=TC.control||{};TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control");TC.filter||TC.syncLoadJS(TC.apiLocation+"TC/Filter");TC.control.Download=function(t){this._classSelector="."+this.CLASS;TC.Control.apply(this,arguments);var e=t||{};this._$dialogDiv=$(TC.Util.getDiv(e.dialogDiv));e.dialogDiv||this._$dialogDiv.appendTo("body")};TC.inherit(TC.control.Download,TC.Control);!function(){var t=TC.control.Download.prototype;t.CLASS="tc-ctl-download";t.template={};if(TC.isDebug){t.template[t.CLASS]=TC.apiLocation+"TC/templates/Download.html";t.template[t.CLASS+"-dialog"]=TC.apiLocation+"TC/templates/DownloadDialog.html"}else{t.template[t.CLASS]=function(){dust.register(t.CLASS,e);function e(t,e){return t.w("<h2>").h("i18n",e,{},{$key:"download"}).w(' </h2><div class="tc-ctl-tctr tc-ctl-tctr-select"><form><label class="tc-ctl-tctr-tab tc-ctl-download-image" style="width:calc(100%/2 - 1px)"><input type="radio" name="sctnr-sel" value="image" /><span>').h("i18n",e,{},{$key:"dl.export.map"}).w('</span></label><label class="tc-ctl-tctr-tab tc-ctl-download-data" style="width:calc(100%/2 - 1px)"><input type="radio" name="sctnr-sel" value="data" /><span>').h("i18n",e,{},{$key:"dl.export.vector"}).w('</span></label></form></div><div class="tc-ctl tc-ctl-tctr-elm tc-ctl-tctr-elm-image tc-group tc-ctl-download-cnt tc-ctl-download-image tc-hidden"><label>').h("i18n",e,{},{$key:"format"}).w(':</label><select id="download-format-image" class="tc-combo"><option value="image/png">PNG</option><option value="image/jpeg">JPEG</option></select><div class="tc-ctl-download-div"><input id="tc-ctl-download-image-qr" class="tc-hidden" type="checkbox" checked style="display:none;" /><label for="tc-ctl-download-image-qr" class="tc-ctl-download-image-qr-label" title="').h("i18n",e,{},{$key:"createQrCodeToImage"}).w('">').h("i18n",e,{},{$key:"appendQRCode"}).w('</label></div><div class="tc-group tc-group tc-ctl-download-cnt" style="text-align:right;"><button type="button" class="tc-ctl-download-btn tc-button tc-icon-button" title="').h("i18n",e,{},{$key:"downloadImageFromCurrentMap"}).w('" name="descargar">').h("i18n",e,{},{$key:"download"}).w('</button></div></div><div class="tc-ctl tc-ctl-tctr-elm tc-ctl-tctr-elm-data tc-group tc-ctl-download-cnt tc-hidden"><label>').h("i18n",e,{},{$key:"format"}).w(':</label><select id="download-format" class="tc-combo"><option value="GML32">GML</option><option value="application/json">GeoJSON</option><option value="application/vnd.google-earth.kml+xml">KML (Google Earth)</option><option value="shape-zip">Shape (ESRI)</option></select><div class="tc-ctl-download-div"><i class="tc-ctl-download-help icon-question-sign" data-toggle="tooltip" data-placement="top" title="').h("i18n",e,{},{$key:"showDownloadHelp"}).w('"></i></div><div class="tc-group tc-group tc-ctl-download-cnt" style="text-align:right;"><button type="button" class="tc-ctl-download-btn tc-button tc-icon-button" title="').h("i18n",e,{},{$key:"downloadLayersFromCurrentExtent"}).w('" name="descargar">').h("i18n",e,{},{$key:"download"}).w('</button></div><div class="tc-alert alert-warning tc-hidden"><p id="zoom-msg"><strong>').h("i18n",e,{},{$key:"tooManyFeatures"}).w(": </strong>").h("i18n",e,{},{$key:"tooManyFeatures.instructions"}).w('</p><p id="layers-msg"><strong>').h("i18n",e,{},{$key:"noLayersLoaded"}).w(": </strong>").h("i18n",e,{},{$key:"noLayersLoaded.instructions"}).w('</p><p id="url-msg"><strong>').h("i18n",e,{},{$key:"tooManySelectedLayers"}).w(": </strong>").h("i18n",e,{},{$key:"tooManySelectedLayers.instructions"}).w('</p><p id="noFeatures-msg"><strong>').h("i18n",e,{},{$key:"noData"}).w(": </strong>").h("i18n",e,{},{$key:"noData.instructions"}).w('</p><p id="novalid-msg"><strong>').h("i18n",e,{},{$key:"noValidService"}).w(": </strong>").h("i18n",e,{},{$key:"noValidService.instructions"}).w("</p></div></div>")}e.__dustBody=!0;return e};t.template[t.CLASS+"-dialog"]=function(){dust.register(t.CLASS+"-dialog",e);function e(t,e){return t.w(' <div class="tc-ctl-download-help-dialog tc-modal"><div class="tc-modal-background tc-modal-close"></div><div class="tc-modal-window"><div class="tc-modal-header"><h3>').h("i18n",e,{},{$key:"downloadData"}).w('</h3><div class="tc-ctl-popup-close tc-modal-close"></div></div><div class="tc-modal-body"><p>').h("i18n",e,{},{$key:"dl.instructions.1|s"}).w("</p><ul><li>").h("i18n",e,{},{$key:"dl.instructions.2|s"}).w("</li><li>").h("i18n",e,{},{$key:"dl.instructions.3|s"}).w("</li><li>").h("i18n",e,{},{$key:"dl.instructions.4|s"}).w("<ul><li>").h("i18n",e,{},{$key:"dl.instructions.5|s"}).w("</li><li>").h("i18n",e,{},{$key:"dl.instructions.6|s"}).w('</li></ul></li></ul></div><div class="tc-modal-footer"><button type="button" class="tc-button tc-modal-close">').h("i18n",e,{},{$key:"close"}).w("</button></div></div></div>")}e.__dustBody=!0;return e}}t.render=function(t){var e=this;e.getRenderedHtml(e.CLASS+"-dialog",null,function(t){e._$dialogDiv.html(t)}).then(function(){TC.Control.prototype.render.call(e,function(){e.CLASS;var o=".tc-ctl-tctr";e._selectors={TAB:o+"-tab",RADIOBUTTON:"input[type=radio][name=sctnr-sel]",ELEMENT:o+"-elm"};e._$div.find("span").on(TC.Consts.event.CLICK,function(t){var o=$(this).closest(e._selectors.TAB).find(e._selectors.RADIOBUTTON),n=o.val(),a=e._$div.find(e._selectors.ELEMENT);if(e._oldValue===n&&e.options.deselectable){setTimeout(function(){o.prop("checked",!1)},0);e._oldValue=null;$active=$();$hidden=a}else{$active=a.filter(e._selectors.ELEMENT+"-"+n);$hidden=a.not($active);e._oldValue=n}$active.removeClass(TC.Consts.classes.HIDDEN);$hidden.addClass(TC.Consts.classes.HIDDEN);o.prop("checked",!0)});t&&t()})})};t.register=function(t){var e=this;TC.Control.prototype.register.call(e,t);e.map.mustBeExportable=!0;var o=function(){for(var t=[],o=0;o<e.map.workLayers.length;o++){var n=e.map.workLayers[o];n.type===TC.Consts.layerType.WMS&&n.getVisibility()&&n.names.length>0&&t.push(n)}return t},n=function(t,o){var n,a=e._$div.find(".alert-warning");switch(t.key){case TC.Consts.WFSErrors.NumMaxFeatures:n=a.find("#zoom-msg").html().format({serviceName:t.params.serviceTitle});break;case TC.Consts.WFSErrors.NoLayers:n=e.getLocaleString("noLayersLoaded");break;case TC.Consts.WFSErrors.GetCapabilities:n=a.find("#novalid-msg").html().format({serviceName:t.params.serviceTitle});break;case TC.Consts.WFSErrors.NoFeatures:n=a.find("#noFeatures-msg").html();break;case TC.Consts.WFSErrors.Indeterminate:n=e.getLocaleString("wfs.IndeterminateError");e.map.toast(n,{type:TC.Consts.msgType.ERROR});TC.error("Error:{error} \r\n Descripcion:{descripcion} \r\n Servicio:{serviceName}".format({error:t.params.err,descripcion:t.params.errorThrown,serviceName:t.params.serviceTitle}),TC.Consts.msgErrorMode.CONSOLE);e.map.getLoadingIndicator().removeWait(o);return;default:n=e.getLocaleString("wfs."+t.key,t.params)}e.map.toast(n,{type:TC.Consts.msgType.WARNING});e.map.getLoadingIndicator().removeWait(o)};e._$div.on(TC.Consts.event.CLICK,".tc-ctl-download-btn",function(){var t=e.map.getLoadingIndicator().addWait(),a=$active.find("select").val();if($active.find("select").val().indexOf("image")>-1){var l,i=$.Deferred(),r=e.map.wrap.getViewport({synchronous:!0}).getElementsByTagName("canvas")[0],s=TC.Util.cloneCanvas(r),c=e.map.getControlsByClass(TC.control.ScaleBar);if(0==c.length){(c=new TC.control.ScaleBar).register(e.map);c.render()}if(c){var d=s.getContext("2d");d.save();var p,g,m=document.getElementsByClassName("ol-scale-line-inner"),u=m.item(0),h=$.extend({},u.getBoundingClientRect()),C=(m=document.getElementsByClassName(c[0].CLASS)).item(0),v=$.extend({},C.getBoundingClientRect()),w=u.textContent;d.beginPath();d.strokeStyle=window.getComputedStyle(u).borderColor;if(h.width>h.height){p=h.width;g=h.height}else{p=h.height;g=h.width}v.left=h.left=15;v.left=v.left-2;v.top=h.top=15;v.top--;d.moveTo(h.left,h.top);d.lineTo(h.left,h.top+g);d.lineTo(h.left+p,h.top+g);d.lineTo(h.left+p,h.top);d.stroke();d.measureText(w);var f={x:h.left+p/2,y:h.top+g/2};d.globalAlpha=.5;d.fillStyle=window.getComputedStyle(C).backgroundColor;p+=4;g+=4;d.fillRect(v.left,v.top,p,g);d.globalAlpha=1;d.fillStyle=window.getComputedStyle(u).color;d.font=window.getComputedStyle(u).fontSize+" "+window.getComputedStyle(u).fontFamily;d.textAlign="center";d.textBaseline="middle";d.fillText(w,f.x,f.y)}$active.find("#tc-ctl-download-image-qr:checked").length>0?$.when(function(t){var e=$.Deferred();t?TC.loadJS("undefined"==typeof QRCode,[TC.apiLocation+"lib/qrcode/qrcode.min.js"],function(){t.length>150&&(t=TC.Util.shortenUrl(t));$("body").append('<div id="qrcode"></div>');var o=$("#qrcode");new QRCode(o.get(0),{text:t,width:85,height:85});setTimeout(function(){var t=o.find("img").attr("src");o.remove();e.resolve(t)},100)}):e.resolve(imgBase64);return e.promise()}(function(){var t=window.location.href,e=t.indexOf("?"),o=t.indexOf("#");e>0&&(t=e<o?t.replace(t.substring(e,o),""):t.replace(t.substring(e,t.length-1),""));return t}())).then(function(o){if(o){var n=s.getContext("2d");n.fillStyle="#ffffff";n.fillRect(s.width-91,s.height-91,91,91);$.when(TC.Util.addToCanvas(s,o,{x:s.width-88,y:s.height-88})).then(function(t){i.resolve(t)})}else{TC.error(e.getLocaleString("dl.export.map.error")+": QR");e.map.getLoadingIndicator().removeWait(t)}}):i.resolve(s);$.when(i).then(function(o){try{l=o.toDataURL(a);TC.Util.downloadDataURI(window.location.hostname+"_"+TC.Util.getFormattedDate((new Date).toString(),!0)+"."+a.split("/")[1],a,l)}catch(t){TC.error(e.getLocaleString("dl.export.map.error")+": "+t.message)}e.map.getLoadingIndicator().removeWait(t)})}else{o();var y=e.map.getExtent(),T=TC.Util.reproject(y.slice(0,2),e.map.crs,TC.Defaults.crs),S=TC.Util.reproject(y.slice(2),e.map.crs,TC.Defaults.crs),b=TC.WFSGetFeatureBuilder(e.map,new TC.filter.bbox([T[0],T[1],S[0],S[1]]),a,!0);$.when.apply($,b).then(function(){var o=$.grep(arguments,function(t){return null!=t});if(0!==o.length){for(var a=[],l=0;l<o.length;l++)if(o[l].errors&&o[l].errors.length)for(var i=0;i<o[l].errors.length;i++){var r=o[l].errors[i];n(r,t)}else{var s=o[l].data,c=o[l].url;s&&c&&a.push({url:c+"?download=zip",data:s})}TC.Util.downloadFileForm(a);e.map.getLoadingIndicator().removeWait(t)}else n({key:TC.Consts.WFSErrors.NoLayers},t)})}});e._$div.on(TC.Consts.event.CLICK,".tc-ctl-download-help",function(t){t.stopPropagation();TC.Util.showModal(e._$dialogDiv.find(e._classSelector+"-help-dialog"))})}}();