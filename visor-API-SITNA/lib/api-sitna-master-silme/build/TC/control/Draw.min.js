TC.control=TC.control||{};TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control");TC.Feature&&TC.feature.Point||TC.syncLoadJS(TC.apiLocation+"TC/feature/Point");TC.Feature&&TC.feature.Polyline||TC.syncLoadJS(TC.apiLocation+"TC/feature/Polyline");TC.Feature&&TC.feature.Polygon||TC.syncLoadJS(TC.apiLocation+"TC/feature/Polygon");TC.Consts.event.DRAWSTART="drawstart.tc";TC.Consts.event.DRAWEND="drawend.tc";TC.Consts.event.DRAWCANCEL="drawcancel.tc";TC.Consts.event.DRAWUNDO="drawundo.tc";TC.Consts.event.DRAWREDO="drawredo.tc";TC.Consts.event.MEASURE="measure.tc";TC.Consts.event.MEASUREPARTIAL="measurepartial.tc";TC.Consts.event.STYLECHANGE="stylechange.tc";TC.Consts.event.CHANGE="change.tc";!function(){TC.control.Draw=function(){var t=this;TC.Control.apply(t,arguments);t._classSelector="."+t.CLASS;t._pointClass=t.CLASS+"-point";t._lineClass=t.CLASS+"-line";t._polygonClass=t.CLASS+"-polygon";t.history=[];t.historyIndex=0;t.exportsState=!0;t.$events.on(TC.Consts.event.DRAWSTART,function(e){t.resetValues()});t.$events.on(TC.Consts.event.POINT,function(s){t.layer&&!t.persistent&&t.layer.features&&t.layer.features.length>0&&t.layer.clearFeatures();t.history.length=t.historyIndex;t.history[t.historyIndex++]=s.point;e(t)});t.$events.on(TC.Consts.event.DRAWEND,function(e){s(t);t.callBack&&t.callBack(e.feature)});t.layerPromise=$.Deferred();this.renderPromise().then(function(){t.reset=!0;t.callBack=null;t.measure=!1;t._cancelClick=!1;t.mode=t.options.mode||TC.Consts.geom.POLYLINE;t.options.measure&&(t.measure=t.options.measure);$.isFunction(t.options.callback)&&(t.callBack=t.options.callback);void 0===t.options.persistent?t.persistent=!0:t.persistent=t.options.persistent;t.wrap=new TC.wrap.control.Draw(t);t._$newBtn=t._$div.find(t._classSelector+"-btn-new").on(TC.Consts.event.CLICK,function(){t.new()});t._$cancelBtn=t._$div.find(t._classSelector+"-btn-cancel").on(TC.Consts.event.CLICK,function(){t.cancel()});t._$endBtn=t._$div.find(t._classSelector+"-btn-end").on(TC.Consts.event.CLICK,function(){t.end()});t._$undoBtn=t._$div.find(t._classSelector+"-btn-undo").on(TC.Consts.event.CLICK,function(){t.undo()});t._$redoBtn=t._$div.find(t._classSelector+"-btn-redo").on(TC.Consts.event.CLICK,function(){t.redo()});if(t.options.styleTools){t._$strokeColorPicker=t._$div.find(t._classSelector+"-str-c").on(TC.Consts.event.CHANGE,function(e){t.setStrokeColor(e.target.value)});t._$strokeWidthSelector=t._$div.find(t._classSelector+"-str-w").on(TC.Consts.event.CHANGE,function(e){t.setStrokeWidth(e.target.value)});t._$strokeWidthWatch=t._$div.find(t._classSelector+"-str-w-watch")}})};TC.inherit(TC.control.Draw,TC.Control);var t=TC.control.Draw.prototype;t.CLASS="tc-ctl-draw";var e=function(t){t._$endBtn.prop("disabled",0===t.historyIndex||t.mode===TC.Consts.geom.POLYGON&&t.historyIndex<3||t.mode===TC.Consts.geom.POLYLINE&&t.historyIndex<2);t._$redoBtn.prop("disabled",t.history.length===t.historyIndex);t._$undoBtn.prop("disabled",0===t.historyIndex)},s=function(t){t.resetValues();t._$endBtn.prop("disabled",!0);t._$cancelBtn.prop("disabled",!1)};TC.isDebug?t.template=TC.apiLocation+"TC/templates/Draw.html":t.template=function(){dust.register(t.CLASS,e);function e(t,e){return t.w('<div class="tc-ctl-draw-tools"><button class="tc-ctl-btn tc-ctl-draw-btn-new" title="').f(e.get(["tooltip"],!1),e,"h").w('">').h("i18n",e,{},{$key:"new"}).w('</button><button class="tc-ctl-btn tc-ctl-draw-btn-undo" disabled title="').h("i18n",e,{},{$key:"undo"}).w('">').h("i18n",e,{},{$key:"undo"}).w('</button><button class="tc-ctl-btn tc-ctl-draw-btn-redo" disabled title="').h("i18n",e,{},{$key:"redo"}).w('">').h("i18n",e,{},{$key:"redo"}).w('</button><button class="tc-ctl-btn tc-ctl-draw-btn-end" disabled title="').h("i18n",e,{},{$key:"end"}).w('">').h("i18n",e,{},{$key:"end"}).w('</button><button class="tc-ctl-btn tc-ctl-draw-btn-cancel" title="').h("i18n",e,{},{$key:"cancel"}).w('">').h("i18n",e,{},{$key:"cancel"}).w("</button></div>").x(e.get(["styleTools"],!1),e,{block:s},{})}e.__dustBody=!0;function s(t,e){return t.w('<div class="tc-ctl-draw-style">').h("i18n",e,{},{$key:"strokeColor"}).w('<input type="color" class="tc-ctl-col tc-ctl-draw-str-c" value="').f(e.get(["strokeColor"],!1),e,"h").w('" title="').h("i18n",e,{},{$key:"selectColor"}).w('" />').h("i18n",e,{},{$key:"strokeWidth"}).w('<div class="tc-ctl-draw-str-w-watch" style="border-bottom-width:').f(e.get(["strokeWidth"],!1),e,"h").w('px;"> </div><input type="number" class="tc-ctl-draw-str-w tc-textbox" value="').f(e.get(["strokeWidth"],!1),e,"h").w('" min="1" max="15" /></div>')}s.__dustBody=!0;return e};t.render=function(t){var e,s,o,n=this;switch(n.options.mode){case TC.Consts.geom.POLYLINE:case TC.Consts.geom.MULTIPOLYLINE:e=n.getLocaleString("drawLine");n._$div.addClass(n._lineClass);s=TC.Cfg.styles.line.strokeColor;o=TC.Cfg.styles.line.strokeWidth;break;case TC.Consts.geom.POLYGON:case TC.Consts.geom.MULTIPOLYGON:e=n.getLocaleString("drawPolygon");n._$div.addClass(n._polygonClass);s=TC.Cfg.styles.polygon.strokeColor;o=TC.Cfg.styles.polygon.strokeWidth;break;case TC.Consts.geom.POINT:case TC.Consts.geom.MULTIPOINT:e=n.getLocaleString("drawPoint");n._$div.addClass(n._pointClass);s=TC.Cfg.styles.point.strokeColor;o=TC.Cfg.styles.point.strokeWidth;break;default:e=n.getLocaleString("draw");s=TC.Cfg.styles.line.strokeColor;o=TC.Cfg.styles.line.strokeWidth}const i={tooltip:e,strokeColor:function(t){const e=t.match(/^#([0-9a-f])([0-9a-f])([0-9a-f])$/i);return e&&e.length?"#"+e[1]+e[1]+e[2]+e[2]+e[3]+e[3]:t}(s),strokeWidth:o,styleTools:n.options.styleTools};n.renderData(i,function(){Modernizr.inputtypes.color?$.isFunction(t)&&t():TC.loadJS(!$.fn.spectrum,TC.apiLocation+"lib/spectrum/spectrum.min.js",function(){TC.loadCSS(TC.apiLocation+"lib/spectrum/spectrum.css");n._$div.find("input[type=color]").spectrum({preferredFormat:"hex",showPalette:!0,palette:[],selectionPalette:[],cancelText:n.getLocaleString("cancel"),chooseText:n.getLocaleString("ok"),replacerClassName:n.CLASS+"-str-c"});$.isFunction(t)&&t()})})};t.register=function(t){var e=this;TC.Control.prototype.register.call(e,t);const s=function(){e.styles={};$.extend(!0,e.styles,e.options.styles||e.layer.options.styles)};t.loaded(function(){if(e.options.layer){e.setLayer(e.options.layer);s()}else"boolean"!=typeof e.options.layer&&t.addLayer({id:e.getUID(),title:"DrawControl",stealth:!0,type:TC.Consts.layerType.VECTOR,styles:{point:t.options.styles.point,line:t.options.styles.line,polygon:t.options.styles.polygon}}).then(function(o){e.layer=o;s();t.putLayerOnTop(e.layer);e.layerPromise.resolve(o)})})};t.new=function(){this.layer&&!this.persistent&&this.layer.clearFeatures();this._$cancelBtn.prop("disabled",!1);this.setMode(this.mode,!0);return this};t.undo=function(){var t=this.wrap.undo();if(t){this.historyIndex--;e(this);this.historyIndex<=0&&this.resetValues();this.$events.trigger($.Event(TC.Consts.event.DRAWUNDO))}return t};t.redo=function(){var t=this.wrap.redo();if(t){this.historyIndex++;e(this);this.$events.trigger($.Event(TC.Consts.event.DRAWREDO))}return t};t.cancel=function(){this._cancelClick=!0;this.setMode(null,!1);this.resetValues();s(this);this._$cancelBtn.prop("disabled",!0);this.$events.trigger($.Event(TC.Consts.event.DRAWCANCEL,{ctrl:this}));return this};t.activate=function(){this._$newBtn.addClass(TC.Consts.classes.ACTIVE);this._$cancelBtn.prop("disabled",!1);TC.Control.prototype.activate.call(this);this.wrap.activate(this.mode);this._$div.removeClass(this._pointClass).removeClass(this._lineClass).removeClass(this._polygonClass);switch(this.mode){case TC.Consts.geom.POINT:this._$div.addClass(this._pointClass);break;case TC.Consts.geom.POLYLINE:this._$div.addClass(this._lineClass);break;case TC.Consts.geom.POLYGON:this._$div.addClass(this._polygonClass)}};t.deactivate=function(){this._$newBtn&&this._$newBtn.removeClass(TC.Consts.classes.ACTIVE);this._$cancelBtn&&this._$cancelBtn.prop("disabled",!0);TC.Control.prototype.deactivate.call(this,!this._cancelClick);this.wrap&&this.wrap.deactivate();this.resetValues();this._cancelClick=!1};t.clear=function(){const t=this;t.layer&&t.layer.clearFatures();t.resetValues();return t};t.isExclusive=function(){return!0};t.end=function(){this.wrap.end();this.resetValues();return this};t.setMode=function(t,e){const s=this;t&&(s.mode=t);if(e&&t){s.layer&&s.layer.map.putLayerOnTop(s.layer);s.activate()}else s.deactivate();var o=e?TC.Consts.event.CONTROLACTIVATE:TC.Consts.event.CONTROLDEACTIVATE;s.map&&s.map.$events.trigger($.Event(o,{control:s}));return s};t.setStyle=function(t){const e=this;if(t)$.extend(e.style,t);else switch(e.options.mode){case TC.Consts.geom.POLYLINE:case TC.Consts.geom.MULTIPOLYLINE:t={line:e.styles.line};break;case TC.Consts.geom.POLYGON:case TC.Consts.geom.MULTIPOLYGON:t={polygon:e.styles.polygon};break;case TC.Consts.geom.POINT:case TC.Consts.geom.MULTIPOINT:t={point:e.styles.point};break;default:t={}}e.isActive&&e.wrap.setStyle(t)};t.getModeStyle=function(t){const e=this;switch(t=t||e.options.mode){case TC.Consts.geom.POLYLINE:case TC.Consts.geom.MULTIPOLYLINE:return e.styles.line;case TC.Consts.geom.POLYGON:case TC.Consts.geom.MULTIPOLYGON:return e.styles.polygon;case TC.Consts.geom.POINT:case TC.Consts.geom.MULTIPOINT:return e.styles.point;default:return null}};t.setStrokeColorWatch=function(t){const e=this;if(e.options.styleTools){void 0===t&&(t=e.getModeStyle().strokeColor);const s=t.match(/^#([0-9a-f])([0-9a-f])([0-9a-f])$/i);s&&s.length&&(t="#"+s[1]+s[1]+s[2]+s[2]+s[3]+s[3]);e._$strokeColorPicker.val(t);Modernizr.inputtypes.color||e._$strokeColorPicker.spectrum("set",t)}return e};t.setStrokeColor=function(t){const e=this,s=e.getModeStyle();s&&(s.strokeColor=t);e.isActive&&e.setStyle();e.setStrokeColorWatch(t);e.$events.trigger($.Event(TC.Consts.event.STYLECHANGE,{property:"strokeColor",value:t}));return e};t.setStrokeWidthWatch=function(t){const e=this;if(e.options.styleTools){void 0===t&&(t=e.getModeStyle().strokeWidth);if((t=parseInt(t,10))!==Number.NaN){e._$strokeWidthSelector.val(t);e._$strokeWidthWatch.css("border-bottom-width",t+"px")}}return e};t.setStrokeWidth=function(t){const e=this;if((t=parseInt(t,10))!==Number.NaN){const s=e.getModeStyle();s&&(s.strokeWidth=t);e.isActive&&e.setStyle();e.setStrokeWidthWatch(t);e.$events.trigger($.Event(TC.Consts.event.STYLECHANGE,{property:"strokeWidth",value:t}))}return e};t.getLayer=function(){return this.options&&"boolean"==typeof this.options.layer&&!this.options.layer?null:this.layer?this.layer:this.layerPromise};t.setLayer=function(t){if(this.map){this.layer="string"==typeof t?this.map.getLayer(t):t;this.layerPromise.resolve(this.layer)}};t.resetValues=function(){this.history.length=0;this.historyIndex=0;e(this);return this};t.exportState=function(){const t=this;return t.exportsState?{id:t.id,layer:t.layer.exportState()}:null};t.importState=function(t){$.when(this.getLayer()).then(function(e){e.importState(t.layer)})}}();