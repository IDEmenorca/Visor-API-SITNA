TC.control=TC.control||{};TC.control.Measure||TC.syncLoadJS(TC.apiLocation+"TC/control/Measure");TC.control.DrawMeasureModify=function(){var t=this;TC.control.Measure.apply(t,arguments);t.persistentDrawControls=!0;t.renderPromise().then(function(){t._$coord=t._$div.find(".tc-ctl-meas-val-coord")});t._$dialogDiv=$(TC.Util.getDiv(t.options.dialogDiv));t.options.dialogDiv||t._$dialogDiv.appendTo("body");if(t.options.displayElevation){t.elevationActive=!0;t.elevationProfileActive=!0;TC.loadJS(!TC.tool||!TC.tool.Elevation,TC.apiLocation+"TC/tool/Elevation",function(){const e="boolean"==typeof t.options.displayElevation?{}:t.options.displayElevation;t.elevation=new TC.tool.Elevation(e)})}};TC.inherit(TC.control.DrawMeasureModify,TC.control.Measure);!function(){var t=TC.control.DrawMeasureModify.prototype;t.CLASS="tc-ctl-dmm";TC.Consts.event.DRAWCHART=TC.Consts.event.DRAWCHART||"drawchart.tc";const e=[],o=function(t){return e.filter(function(e){return e.feature===t})[0]},n=function(t){const o=e.reduce(function(e,o,n){return o.feature===t?n:e},-1);o>=0&&e.splice(o,1)};t.template={};if(TC.isDebug){t.template[t.CLASS]=TC.apiLocation+"TC/templates/DrawMeasureModify.html";t.template[t.CLASS+"-dialog"]=TC.apiLocation+"TC/templates/DrawMeasureModifyDialog.html"}else{t.template[t.CLASS]=function(){dust.register(t.CLASS,e);function e(t,e){return t.w("<h2>").h("i18n",e,{},{$key:"drawAndMeasure"}).w(' <span class="tc-beta">').h("i18n",e,{},{$key:"beta"}).w('</span></h2><div class="tc-ctl-meas-select"><form><label class="tc-ctl-meas-btn-pt"><input type="radio" name="mode" value="point" /><span>').h("i18n",e,{},{$key:"points"}).w('</span></label><label class="tc-ctl-meas-btn-len"><input type="radio" name="mode" value="polyline" /><span>').h("i18n",e,{},{$key:"lines"}).w('</span></label><label class="tc-ctl-meas-btn-area"><input type="radio" name="mode" value="polygon" /><span>').h("i18n",e,{},{$key:"polygons"}).w('</span></label></form></div><div class="tc-ctl-meas-mode tc-ctl-meas-pt tc-hidden"><div class="tc-ctl-meas-point"></div><div class="tc-ctl-meas-txt">').h("i18n",e,{},{$key:"search.list.coordinates"}).w(': <span class="tc-ctl-meas-val-coord"></span></div></div><div class="tc-ctl-meas-mode tc-ctl-meas-len tc-hidden"><div class="tc-ctl-meas-line"></div><div class="tc-ctl-meas-txt">').h("i18n",e,{},{$key:"2dLength"}).w(': <span class="tc-ctl-meas-val-len"></span><button class="tc-ctl-meas-prof-btn tc-active" title="').h("i18n",e,{},{$key:"deactivateElevationProfile"}).w('">').h("i18n",e,{},{$key:"geo.trk.chart.chpe"}).w('</button></div></div><div class="tc-ctl-meas-mode tc-ctl-meas-area tc-hidden"><div class="tc-ctl-meas-polygon"></div><div class="tc-ctl-meas-txt">').h("i18n",e,{},{$key:"area"}).w(': <span class="tc-ctl-meas-val-area"></span>, ').h("i18n",e,{},{$key:"2dPerimeter"}).w(': <span class="tc-ctl-meas-val-peri"></span></div></div><div class="tc-ctl-dmm-tool"><div class="tc-ctl-dmm-mod"></div><div class="tc-ctl-dmm-cmd"><button class="tc-ctl-dmm-btn-clr" disabled title="').h("i18n",e,{},{$key:"deleteAll"}).w('">').h("i18n",e,{},{$key:"deleteAll"}).w('</button><button class="tc-ctl-dmm-btn-dl" disabled title="').h("i18n",e,{},{$key:"download"}).w('">').h("i18n",e,{},{$key:"download"}).w("...</button></div></div>")}e.__dustBody=!0;return e};t.template[t.CLASS+"-dialog"]=function(){dust.register(t.CLASS+"-dialog",e);function e(t,e){return t.w('<div class="tc-ctl-dmm-dialog tc-modal"><div class="tc-modal-background tc-modal-close"></div><div class="tc-modal-window"><div class="tc-modal-header"><h3>').h("i18n",e,{},{$key:"downloadSketch"}).w('</h3><div class="tc-ctl-popup-close tc-modal-close"></div></div><div class="tc-modal-body"><div class="tc-ctl-dmm-dialog-ip"><h4>').h("i18n",e,{},{$key:"interpolateCoordsFromElevProfile"}).w('</h4><label><input type="radio" name="ip-coords" value="0" checked /><span>').h("i18n",e,{},{$key:"no"}).w('</span></label><label><input type="radio" name="ip-coords" value="1"/><span>').h("i18n",e,{},{$key:"yes"}).w('</span></label><div class="tc-ctl-dmm-dialog-ip-m tc-hidden">').h("i18n",e,{},{$key:"interpolateEveryXMeters.1"}).w('<input type="number" min="1" step="1" class="tc-textbox" value="').f(e.get(["interpolationInterval"],!1),e,"h").w('" />').h("i18n",e,{},{$key:"interpolateEveryXMeters.2"}).w('</div></div><div class="tc-ctl-dmm-dialog-dl"><button class="tc-button tc-btn-dl tc-ctl-dmm-dl-btn-kml" data-format="KML" title="KML">KML</button><button class="tc-button tc-btn-dl tc-ctl-dmm-dl-btn-gml" data-format="GML" title="GML">GML</button><button class="tc-button tc-btn-dl tc-ctl-dmm-dl-btn-geojson" data-format="GeoJSON" title="GeoJSON">GeoJSON</button><button class="tc-button tc-btn-dl tc-ctl-dmm-dl-btn-wkt" data-format="WKT" title="WKT">WKT</button><button class="tc-button tc-btn-dl tc-ctl-dmm-dl-btn-gpx" data-format="GPX" title="GPX">GPX</button></div></div></div></div>')}e.__dustBody=!0;return e}}t.render=function(t){var e=this;TC.control.Measure.prototype.render.call(e,function(){e._$clearBtn=e._$div.find(".tc-ctl-dmm-cmd button.tc-ctl-dmm-btn-clr").on(TC.Consts.event.CLICK,function(t){TC.confirm(e.getLocaleString("deleteAll.confirm"),function(){e.clear()})});e._$downloadBtn=e._$div.find(".tc-ctl-dmm-cmd button.tc-ctl-dmm-btn-dl").on(TC.Consts.event.CLICK,function(t){e.showSketchDownloadDialog()});e._$elevProfileBtn=e._$div.find(".tc-ctl-meas-prof-btn").on(TC.Consts.event.CLICK,function(t){e.elevationProfileActive?e.deactivateElevationProfile():e.activateElevationProfile()});e.options.displayElevation||e._$elevProfileBtn.hide();$.isFunction(t)&&t()});const o={};e.options.displayElevation&&(o.interpolationInterval=e.options.displayElevation.resolution);e.getRenderedHtml(e.CLASS+"-dialog",o,function(t){const o=function(t){const o={fileName:e.getLocaleString("sketch").toLowerCase().replace(" ","_")+"_"+TC.Util.getFormattedDate((new Date).toString(),!0),format:t};if(e.options.displayElevation){const t="1"===e._$dialogDiv.find("input[type=radio][name=ip-coords]:checked").val(),n={crs:e.map.crs,sampleNumber:0};n.resolution=t?e._$dialogDiv.find("."+e.CLASS+"-dialog-ip-m input[type=number]").val()||e.options.displayElevation.resolution:0;if(n.resolution){if(e.layer.features.reduce(function(t,e){switch(!0){case TC.feature.Polyline&&e instanceof TC.feature.Polyline:case TC.feature.Polygon&&e instanceof TC.feature.Polygon:return t+e.getLength();default:return t}},0)/n.resolution>e.options.displayElevation.maxCoordLength){TC.alert(e.getLocaleString("tooManyCoordinatesForElevation.warning"));return}}TC.Util.closeModal();const a=e.map.getLoadingIndicator(),i=a&&a.addWait();$.when.apply(this,e.layer.features.map(function(t){const a=TC.feature.Polygon&&t instanceof TC.feature.Polygon;if(a||TC.feature.Polyline&&t instanceof TC.feature.Polyline){const i=$.Deferred(),s=t.getData(),l=$.extend({coordinates:t.geometry},n);e.elevation.getElevation(l).then(function(e){const n=o.format===TC.Consts.format.GPX?Number.NaN:0;e.forEach(function(t){null===t[2]&&(t[2]=n)});const l=a?new TC.feature.Polygon([e],t.options):new TC.feature.Polyline(e,t.options);l.setData(s);l.setStyle(t.getStyle());i.resolve(l)},function(t){i.reject(t)});return i.promise()}return t})).then(function(){a&&a.removeWait(i);e.map.exportFeatures(Array.prototype.slice.call(arguments),o)},function(t){a&&a.removeWait(i);TC.error(e.getLocaleString("elevation.error"))})}else{TC.Util.closeModal();e.map.exportFeatures(e.layer.features,o)}};e._$dialogDiv.html(t).on("change","input[type=radio][name=ip-coords]",function(t){e._$dialogDiv.find("."+e.CLASS+"-dialog-ip-m").toggleClass(TC.Consts.classes.HIDDEN,"0"===t.target.value)}).on(TC.Consts.event.CLICK,"button[data-format]",function(t){const n=$(t.target).data("format");n===TC.Consts.format.GPX&&e.layer.features.some(function(t){return TC.feature.Polygon&&t instanceof TC.feature.Polygon})?TC.confirm(e.getLocaleString("gpxNotCompatible.confirm"),function(){o(n)}):o(n)})})};t.register=function(t){const a=this;TC.control.Measure.prototype.register.call(a,t);const i=a.getUID(),s=a.getUID();$.when(a.layerPromise,a.renderPromise()).then(function(l){a._modifyPromise=t.addControl("modify",{id:s,div:a._$div.find("."+a.CLASS+"-mod"),layer:l});a._modifyPromise.then(function(e){a.modify=e;e.on(TC.Consts.event.FEATURESSELECT,function(t){const e=t.features[t.features.length-1];if(e){a.showMeasures(a.getFeatureMeasureData(e));const t=e._originalStyle||e.getStyle();switch(!0){case TC.feature.Polygon&&e instanceof TC.feature.Polygon:a.displayMode(TC.Consts.geom.POLYGON);a.drawPolygons.setStrokeColorWatch(t.strokeColor).setStrokeWidthWatch(t.strokeWidth);break;case TC.feature.Polyline&&e instanceof TC.feature.Polyline:a.displayMode(TC.Consts.geom.POLYLINE);a.drawLines.setStrokeColorWatch(t.strokeColor).setStrokeWidthWatch(t.strokeWidth);const n=o(e);n&&a.renderElevationChart(n.data);break;case TC.feature.Point&&e instanceof TC.feature.Point:a.displayMode(TC.Consts.geom.POINT);a.drawPoints.setStrokeColorWatch(t.strokeColor).setStrokeWidthWatch(t.strokeWidth)}a.modify.setFontColorWatch(t.fontColor).setFontSizeWatch(t.fontSize)}}).on(TC.Consts.event.FEATURESUNSELECT,function(t){a.modify.getSelectedFeatures().length||a.resetDrawWatches();a.resetElevationProfile();a.resultsPanelChart&&a.resultsPanelChart.hide()}).on(TC.Consts.event.FEATUREMODIFY,function(t){if(t.layer===a.layer){n(t.feature);const e=function(t){const e=a.getFeatureMeasureData(t);a.showMeasures(e);a.setFeatureMeasureData(t)};e(t.feature);a.options.displayElevation&&a.elevation.setGeometry({feature:t.feature,crs:a.map.crs}).then(e);a.map.getControlsByClass("TC.control.Popup").forEach(function(e){e.isVisible()&&e.currentFeature===t.feature&&e.hide()})}});t.on(TC.Consts.event.CONTROLDEACTIVATE,function(t){if(t.control===a.modify){a.resetDrawWatches();a.resetElevationProfile();a.resultsPanelChart&&a.resultsPanelChart.hide()}else if(t.control===a.drawLines){a.resetElevationProfile();a.resultsPanelChart&&a.resultsPanelChart.hide()}}).on(TC.Consts.event.FEATURECLICK,function(e){if(TC.feature.Polyline&&e.feature instanceof TC.feature.Polyline&&a.layer.features.indexOf(e.feature)>=0){const n=o(e.feature);n?a.renderElevationChart(n.data):a.displayElevationProfile(e.feature.geometry);a.elevationProfileActive&&t.getControlsByClass("TC.control.Popup").forEach(function(t){t.currentFeature===e.feature&&t.hide()})}})});a._drawLinesPromise.then(function(t){t.$events.on(TC.Consts.event.DRAWSTART,function(){a.resetValues()}).on(TC.Consts.event.DRAWUNDO+" "+TC.Consts.event.DRAWREDO,function(){a.displayElevationProfile(this.history.slice(0,this.historyIndex))}).on(TC.Consts.event.POINT,function(t){const e=this.history.slice(0,this.historyIndex),o=e[e.length-1];o[0]===t.point[0]&&o[1]===t.point[1]||e.push(t.point);a.displayElevationProfile(e)}).on(TC.Consts.event.STYLECHANGE,function(t){a.onStyleChange(t)})});a._drawPolygonsPromise.then(function(t){t.$events.on(TC.Consts.event.DRAWSTART,function(){a.resetValues()}).on(TC.Consts.event.DRAWEND,function(t){a.options.displayElevation&&a.elevation.setGeometry({feature:t.feature,crs:a.map.crs})}).on(TC.Consts.event.STYLECHANGE,function(t){a.onStyleChange(t)})});a._drawPointsPromise=t.addControl("draw",{id:i,div:a._$div.find("."+TC.control.Measure.prototype.CLASS+"-point"),mode:TC.Consts.geom.POINT,persistent:a.persistentDrawControls,styleTools:!0,layer:a.layer});a._drawPointsPromise.then(function(e){e.containerControl=a;a.drawControls.push(e);a.drawPoints=e;a.resetValues();e.$events.on(TC.Consts.event.DRAWEND,function(e){const o=function(e){a.showMeasures({coords:e.geometry,units:t.wrap.isGeo()?"degrees":"m"});a.setFeatureMeasureData(e)};o(e.feature);a.options.displayElevation&&a.elevation.setGeometry({feature:e.feature,crs:a.map.crs}).then(o)}).on(TC.Consts.event.DRAWCANCEL,function(t){a.cancel()}).on(TC.Consts.event.STYLECHANGE,function(t){a.onStyleChange(t)});e.exportsState=!1});a.setMode(a.options.mode);t.on(TC.Consts.event.FEATUREADD,function(t){if(t.layer===a.layer){a.setFeatureMeasureData(t.feature);a._modifyPromise.then(function(e){e.displayLabelText(t.feature.getStyle().label)});a._$clearBtn.prop("disabled",!1);a._$downloadBtn.prop("disabled",!1)}}).on(TC.Consts.event.FEATUREREMOVE+" "+TC.Consts.event.FEATURESCLEAR,function(t){if(t.layer===a.layer)if(0===a.layer.features.length){a._$clearBtn.prop("disabled",!0);a._$downloadBtn.prop("disabled",!0);a.resetValues();e.length=0}else t.feature&&n(t.feature)})})};t.displayMode=function(t){const e=this;t===TC.Consts.geom.POINT&&(e._$activeMode=e._$div.find(".tc-ctl-meas-pt"));e.modify&&e.modify._$div.removeClass(TC.Consts.classes.COLLAPSED);return TC.control.Measure.prototype.displayMode.call(e,t)};t.setMode=function(t){const e=this;t===TC.Consts.geom.POINT&&e.drawPoints.activate();return TC.control.Measure.prototype.setMode.call(e,t)};t.setFeatureMeasureData=function(t){const e=this,o={};switch(!0){case TC.feature.Point&&t instanceof TC.feature.Point:o[e.getLocaleString("search.list.coordinates")]=e._$coord.html();t.setData(o);break;case TC.feature.Polyline&&t instanceof TC.feature.Polyline:o[e.getLocaleString("2dLength")]=e._$len.html();t.setData(o);break;case TC.feature.Polygon&&t instanceof TC.feature.Polygon:o[e.getLocaleString("area")]=e._$area.html();o[e.getLocaleString("2dPerimeter")]=e._$peri.html();t.setData(o)}return e};t.getFeatureMeasureData=function(t){const e=this,n={units:"m"},a={};e.map.wrap.isGeo()&&(a.crs=TC.Cfg.utmCrs);switch(!0){case TC.feature.Polygon&&t instanceof TC.feature.Polygon:n.area=t.getArea(a);n.perimeter=t.getLength(a);break;case TC.feature.Polyline&&t instanceof TC.feature.Polyline:n.length=t.getLength(a);const i=o(t);i?e.renderElevationChart(i.data):e.displayElevationProfile(t.geometry);break;case TC.feature.Point&&t instanceof TC.feature.Point:n.coords=t.geometry}return n};t.showMeasures=function(t){const e=this;TC.control.Measure.prototype.showMeasures.call(e,t);(t=t||{}).units;const o=e.map.options.locale||TC.Cfg.locale;if(t.coords){var n="m"===t.units?"x: "+TC.Util.formatNumber(t.coords[0].toFixed(TC.Consts.METER_PRECISION),o)+", y: "+TC.Util.formatNumber(t.coords[1].toFixed(TC.Consts.METER_PRECISION),o):TC.Util.formatNumber(t.coords[1].toFixed(TC.Consts.DEGREE_PRECISION),o)+", "+TC.Util.formatNumber(t.coords[0].toFixed(TC.Consts.DEGREE_PRECISION),o);t.coords.length>2&&(n+=", "+e.getLocaleString("ele")+": "+TC.Util.formatNumber(t.coords[2].toFixed(TC.Consts.METER_PRECISION)));e._$coord.html(n)}return e};t.resetValues=function(){const t=this;TC.control.Measure.prototype.resetValues.call(t);t._$coord&&t._$coord.text(t.NOMEASURE);return t};t.resetDrawWatches=function(){this.drawControls.forEach(function(t){t.setStrokeColorWatch().setStrokeWidthWatch()})};t.clear=function(){const t=this;t.resetValues();t.layer.clearFeatures();t.modify.isActive&&t.modify.deactivate();if(t.options.displayElevation){t.resetElevationProfile();t.resultsPanelChart&&t.resultsPanelChart.hide()}t._$clearBtn.prop("disabled",!0);t._$downloadBtn.prop("disabled",!0);return t};t.showSketchDownloadDialog=function(t){const e=this._$dialogDiv.find("."+this.CLASS+"-dialog");e.find("."+this.CLASS+"-dialog-ip").toggleClass(TC.Consts.classes.HIDDEN,!this.layer.features.some(function(t){return TC.feature.Polyline&&t instanceof TC.feature.Polyline||TC.feature.Polygon&&t instanceof TC.feature.Polygon}));TC.Util.showModal(e,t);return this};t.onStyleChange=function(t){const e=this;var o;switch(t.target.mode){case TC.Consts.geom.POLYGON:o=TC.feature.Polygon;break;case TC.Consts.geom.POLYLINE:o=TC.feature.Polyline;break;case TC.Consts.geom.POINT:o=TC.feature.Point}o&&e.modify.getSelectedFeatures().forEach(function(e){if(e instanceof o){const o={};o[t.property]=t.value;e.setStyle(o)}})};t.displayElevationProfile=function(n){const a=this;1===n.length&&(n=n.slice()).push(n[0]);const i=a.map.getLoadingIndicator(),s=i&&i.addWait();a.elevation.getElevation({crs:a.map.crs,coordinates:n}).then(function(l){i&&i.removeWait(s);var r=0,c=Number.NEGATIVE_INFINITY,d=Number.POSITIVE_INFINITY;const u=l.map(function(t,e,o){const n=0===e?t:o[e-1],a=t[0]-n[0],i=t[1]-n[1];r+=Math.sqrt(a*a+i*i);var s=t[2];if("number"==typeof s){c=Math.max(s,c);d=Math.min(s,d)}return[r,s]});a.elevationProfileData={x:u.map(function(t){return t[0]}),ele:u.map(function(t){return t[1]}),coords:l};const f={coords:l};"object"==typeof a.options.displayElevation&&(f.hillDeltaThreshold=a.options.displayElevation.hillDeltaThreshold);$.extend(a.elevationProfileData,TC.tool.Elevation.getElevationGain(f));const C=a.layer.features.filter(function(t){return TC.feature.Polyline&&t instanceof TC.feature.Polyline}).filter(function(t){for(var e=0,o=n.length;e<o;e++){const o=n[e],a=t.geometry[e];if(o[0]!==a[0]||o[1]!==a[1])return!1}return!0})[0];C&&function(t,n){var a=o(t);if(!a){a={feature:t};e.push(a)}a.data=n}(C,a.elevationProfileData);if(a.resultsPanelChart)a.renderElevationChart();else{const e=a.map.getControlsByClass(TC.control.ResultsPanel).filter(function(t){return"chart"===t.options.content})[0],o=e?e._$div:$("<div>").appendTo(a.map._$div);a.map.addControl("resultsPanel",{id:a.getUID(),div:o,content:"chart",titles:{main:a.getLocaleString("geo.trk.chart.chpe"),max:a.getLocaleString("geo.trk.chart.chpe")},chart:{ctx:a,onmouseout:t.removeElevationTooltip,tooltip:t.getElevationTooltip}}).then(function(t){a.resultsPanelChart=t;a.resultsPanelChart.render(function(){a.renderElevationChart()})})}},function(t){a.resetElevationProfile();i&&i.removeWait(s)})};t.renderElevationChart=function(t){const e=this;e.elevationProfileData=t||e.elevationProfileData;if(e.resultsPanelChart&&e.elevationProfileActive){e.resultsPanelChart.openChart(e.elevationProfileData);e.resultsPanelChart.isMinimized()||e.resultsPanelChart.show()}};t.getElevationTooltip=function(t){this.resultsPanelChart.wrap.showElevationMarker({data:t,layer:this.layer,coords:this.elevationProfileData.coords});return this.resultsPanelChart.getElevationChartTooltip(t)};t.removeElevationTooltip=function(){this.resultsPanelChart.wrap.hideElevationMarker()};t.activateElevationProfile=function(){const t=this;t.elevationProfileActive=!0;t._$elevProfileBtn.addClass(TC.Consts.classes.ACTIVE).attr("title",t.getLocaleString("deactivateElevationProfile"));var e=!1;if(t.drawLines.historyIndex>1){t.displayElevationProfile(t.drawLines.history.slice(0,t.drawLines.historyIndex));e=!0}else{const o=t.modify.getActiveFeatures().filter(function(t){return TC.feature.Polyline&&t instanceof TC.feature.Polyline});if(o.length){const n=o[o.length-1];t.displayElevationProfile(n.geometry);e=!0}}e||t.resetElevationProfile();t.resultsPanelChart&&t.resultsPanelChart.show()};t.deactivateElevationProfile=function(){const t=this;t.elevationProfileActive=!1;t._$elevProfileBtn.removeClass(TC.Consts.classes.ACTIVE).attr("title",t.getLocaleString("activateElevationProfile"));t.resetElevationProfile();t.resultsPanelChart&&t.resultsPanelChart.hide()};t.resetElevationProfile=function(){const t=this;if(t.options.displayElevation){t.elevationProfileData={x:[0],ele:[0],coords:[0,0,0],upHill:0,downHill:0};t.resultsPanelChart&&t.renderElevationChart()}}}();