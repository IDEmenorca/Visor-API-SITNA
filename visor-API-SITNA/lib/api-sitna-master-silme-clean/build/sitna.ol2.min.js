!function(e,t,i){function n(e,t){return typeof e===t}function r(){return"function"!=typeof t.createElement?t.createElement(arguments[0]):d?t.createElementNS.call(t,"http://www.w3.org/2000/svg",arguments[0]):t.createElement.apply(t,arguments)}function s(){var e=t.body;return e||((e=r(d?"svg":"body")).fake=!0),e}function a(e,i,n,a){var o,l,c,u,p="modernizr",d=r("div"),f=s();if(parseInt(n,10))for(;n--;)(c=r("div")).id=a?a[n]:p+(n+1),d.appendChild(c);return(o=r("style")).type="text/css",o.id="s"+p,(f.fake?f:d).appendChild(o),f.appendChild(d),o.styleSheet?o.styleSheet.cssText=e:o.appendChild(t.createTextNode(e)),d.id=p,f.fake&&(f.style.background="",f.style.overflow="hidden",u=h.style.overflow,h.style.overflow="hidden",h.appendChild(f)),l=i(d,e),f.fake?(f.parentNode.removeChild(f),h.style.overflow=u,h.offsetHeight):d.parentNode.removeChild(d),!!l}var o=[],l={_version:"3.6.0",_config:{classPrefix:"",enableClasses:!0,enableJSClass:!0,usePrefixes:!0},_q:[],on:function(e,t){var i=this;setTimeout(function(){t(i[e])},0)},addTest:function(e,t,i){o.push({name:e,fn:t,options:i})},addAsyncTest:function(e){o.push({name:null,fn:e})}},c=function(){};c.prototype=l,(c=new c).addTest("urlparser",function(){try{return"http://modernizr.com/"===new URL("http://modernizr.com/").href}catch(e){return!1}});var u=[],h=t.documentElement,p=l._config.usePrefixes?" -webkit- -moz- -o- -ms- ".split(" "):["",""];l._prefixes=p;var d="svg"===h.nodeName.toLowerCase(),f=r("input"),m="search tel url email datetime date month week time datetime-local number range color".split(" "),y={};c.inputtypes=function(e){for(var i,n,r,s=e.length,a=0;s>a;a++)f.setAttribute("type",i=e[a]),(r="text"!==f.type&&"style"in f)&&(f.value="1)",f.style.cssText="position:absolute;visibility:hidden;",/^range$/.test(i)&&void 0!==f.style.WebkitAppearance?(h.appendChild(f),r=(n=t.defaultView).getComputedStyle&&"textfield"!==n.getComputedStyle(f,null).WebkitAppearance&&0!==f.offsetHeight,h.removeChild(f)):/^(search|tel)$/.test(i)||(r=/^(url|email)$/.test(i)?f.checkValidity&&!1===f.checkValidity():"1)"!=f.value)),y[e[a]]=!!r;return y}(m);var g=function(){var t=e.matchMedia||e.msMatchMedia;return t?function(e){var i=t(e);return i&&i.matches||!1}:function(t){var i=!1;return a("@media "+t+" { #modernizr { position: absolute; } }",function(t){i="absolute"==(e.getComputedStyle?e.getComputedStyle(t,null):t.currentStyle).position}),i}}();l.mq=g;var C=l.testStyles=a;c.addTest("touchevents",function(){var i;if("ontouchstart"in e||e.DocumentTouch&&t instanceof DocumentTouch)i=!0;else{var n=["@media (",p.join("touch-enabled),("),"heartz",")","{#modernizr{top:9px;position:absolute}}"].join("");C(n,function(e){i=9===e.offsetTop})}return i}),c.addTest("canvas",function(){var e=r("canvas");return!(!e.getContext||!e.getContext("2d"))}),function(){var e,t,i,r,s,a;for(var l in o)if(o.hasOwnProperty(l)){if(e=[],(t=o[l]).name&&(e.push(t.name.toLowerCase()),t.options&&t.options.aliases&&t.options.aliases.length))for(i=0;i<t.options.aliases.length;i++)e.push(t.options.aliases[i].toLowerCase());for(r=n(t.fn,"function")?t.fn():t.fn,s=0;s<e.length;s++)1===(a=e[s].split(".")).length?c[a[0]]=r:(!c[a[0]]||c[a[0]]instanceof Boolean||(c[a[0]]=new Boolean(c[a[0]])),c[a[0]][a[1]]=r),u.push((r?"":"no-")+a.join("-"))}}(),delete l.addTest,delete l.addAsyncTest;for(var v=0;v<c._q.length;v++)c._q[v]();e.Modernizr=c}(window,document);!function(e,t){"function"==typeof define&&define.amd&&!0===define.amd.dust?define("dust.core",[],t):"object"==typeof exports?module.exports=t():e.dust=t()}(this,function(){function c(e,t){if(e)return"function"==typeof e&&e.template?e.template:n.isTemplateFn(e)?e:!1!==t?n.cache[e]:void 0}function o(e,t,r){if(!e)return t.setError(new Error("No template or template name provided to render"));var s=c(e,n.config.cache);return s?s(t,i.wrap(r,s.templateName)):n.onLoad?t.map(function(t){function s(e,s){var o;if(e)return t.setError(e);if(!(o=c(s,!1)||c(a,n.config.cache))){if(!n.compile)return t.setError(new Error("Dust compiler not available"));o=n.loadSource(n.compile(s,a))}o(t,i.wrap(r,o.templateName)).end()}var a=e;3===n.onLoad.length?n.onLoad(a,r.options,s):n.onLoad(a,s)}):t.setError(new Error("Template Not Found: "+e))}function i(e,t,i,n,r){void 0===e||e instanceof l||(e=new l(e));this.stack=e;this.global=t;this.options=i;this.blocks=n;this.templateName=r}function k(e,t,i){return function(n){return e.push(n)._get(t,i)}}function l(e,t,i,n){this.tail=t;this.isObject=e&&"object"==typeof e;this.head=e;this.index=i;this.of=n}function a(e){this.head=new t(this);this.callback=e;this.out=""}function e(){this.head=new t(this)}function t(e,t,i){this.root=e;this.next=t;this.data=[];this.flushable=!1;this.taps=i}function s(e,t){this.head=e;this.tail=t}var n={version:"2.7.1"},d="NONE",r="ERROR",u="WARN",v="INFO",f="DEBUG",y=function(){},h;n.config={whitespace:!1,amd:!1,cjs:!1,cache:!0};n._aliases={write:"w",end:"e",map:"m",render:"r",reference:"f",section:"s",exists:"x",notexists:"nx",block:"b",partial:"p",helper:"h"},function(){var e,t,i={DEBUG:0,INFO:1,WARN:2,ERROR:3,NONE:4};"undefined"!=typeof console&&console.log?(e=console.log,t="function"==typeof e?function(){e.apply(console,arguments)}:function(){e(Array.prototype.slice.apply(arguments).join(" "))}):t=y;n.log=function(e,r){i[r=r||v]>=i[n.debugLevel]&&t("[DUST:"+r+"]",e)};n.debugLevel=d;"undefined"!=typeof process&&process.env&&/\bdust\b/.test(process.env.DEBUG)&&(n.debugLevel=f)}();n.helpers={};n.cache={};n.register=function(e,t){e&&(t.templateName=e,!1!==n.config.cache&&(n.cache[e]=t))};n.render=function(e,t,i){var n=new a(i).head;try{o(e,n,t).end()}catch(e){n.setError(e)}};n.stream=function(t,i){var r=new e,s=r.head;return n.nextTick(function(){try{o(t,s,i).end()}catch(e){s.setError(e)}}),r};n.loadSource=function(source){return eval(source)};n.isArray=Array.isArray?Array.isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)};n.nextTick=function(e){setTimeout(e,0)};n.isEmpty=function(e){return 0!==e&&(!(!n.isArray(e)||e.length)||!e)};n.isEmptyObject=function(e){var t;if(null===e||void 0===e||e.length>0)return!1;for(t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0};n.isTemplateFn=function(e){return"function"==typeof e&&e.__dustBody};n.isThenable=function(e){return e&&"object"==typeof e&&"function"==typeof e.then};n.isStreamable=function(e){return e&&"function"==typeof e.on};n.filter=function(e,t,i){var r,s,a;if(i)for(r=0,s=i.length;s>r;r++)"s"===(a=i[r])?t=null:"function"==typeof n.filters[a]?e=n.filters[a](e):n.log("Invalid filter `"+a+"`",u);return t&&(e=n.filters[t](e)),e};n.filters={h:function(e){return n.escapeHtml(e)},j:function(e){return n.escapeJs(e)},u:encodeURI,uc:encodeURIComponent,js:function(e){return n.escapeJSON(e)},jp:function(e){return JSON?JSON.parse(e):(n.log("JSON is undefined; could not parse `"+e+"`",u),e)}};n.makeBase=n.context=function(e,t){return new i(void 0,e,t)};i.wrap=function(e,t){return e instanceof i?e:new i(e,{},{},null,t)};i.prototype.get=function(e,t){return"string"==typeof e&&("."===e[0]&&(t=!0,e=e.substr(1)),e=e.split(".")),this._get(t,e)};i.prototype._get=function(e,t){var i,s,a,o,l,c=this.stack||{},u=1;if(s=t[0],a=t.length,e&&0===a)o=c,c=c.head;else{if(e)c&&(c=c.head?c.head[s]:void 0);else{for(;c&&(!c.isObject||(o=c.head,void 0===(i=c.head[s])));)c=c.tail;c=void 0!==i?i:this.global&&this.global[s]}for(;c&&a>u;){if(n.isThenable(c))return c.then(k(this,e,t.slice(u)));o=c;c=c[t[u]];u++}}return"function"==typeof c?((l=function(){try{return c.apply(o,arguments)}catch(e){throw n.log(e,r),e}}).__dustBody=!!c.__dustBody,l):(void 0===c&&n.log("Cannot find reference `{"+t.join(".")+"}` in template `"+this.getTemplateName()+"`",v),c)};i.prototype.getPath=function(e,t){return this._get(e,t)};i.prototype.push=function(e,t,i){return void 0===e?(n.log("Not pushing an undefined variable onto the context",v),this):this.rebase(new l(e,this.stack,t,i))};i.prototype.pop=function(){var e=this.current();return this.stack=this.stack&&this.stack.tail,e};i.prototype.rebase=function(e){return new i(e,this.global,this.options,this.blocks,this.getTemplateName())};i.prototype.clone=function(){var e=this.rebase();return e.stack=this.stack,e};i.prototype.current=function(){return this.stack&&this.stack.head};i.prototype.getBlock=function(e){var i,r,s;if("function"==typeof e&&(e=e(new t,this).data.join("")),!(i=this.blocks))return n.log("No blocks for context `"+e+"` in template `"+this.getTemplateName()+"`",f),!1;for(r=i.length;r--;)if(s=i[r][e])return s;return n.log("Malformed template `"+this.getTemplateName()+"` was missing one or more blocks."),!1};i.prototype.shiftBlocks=function(e){var t,n=this.blocks;return e?(t=n?n.concat([e]):[e],new i(this.stack,this.global,this.options,t,this.getTemplateName())):this};i.prototype.resolve=function(e){var i;return"function"!=typeof e?e:(i=(new t).render(e,this))instanceof t?i.data.join(""):i};i.prototype.getTemplateName=function(){return this.templateName};a.prototype.flush=function(){for(var e=this.head;e;){if(!e.flushable)return e.error?(this.callback(e.error),n.log("Rendering failed with error `"+e.error+"`",r),void(this.flush=y)):void 0;this.out+=e.data.join("");e=e.next;this.head=e}this.callback(null,this.out)};e.prototype.flush=function(){for(var e=this.head;e;){if(!e.flushable)return e.error?(this.emit("error",e.error),this.emit("end"),n.log("Streaming failed with error `"+e.error+"`",r),void(this.flush=y)):void 0;this.emit("data",e.data.join(""));e=e.next;this.head=e}this.emit("end")};e.prototype.emit=function(e,t){var i,r,s=(this.events||{})[e]||[];if(!s.length)return n.log("Stream broadcasting, but no listeners for `"+e+"`",f),!1;for(i=0,r=(s=s.slice(0)).length;r>i;i++)s[i](t);return!0};e.prototype.on=function(e,t){var i=this.events=this.events||{},r=i[e]=i[e]||[];return"function"!=typeof t?n.log("No callback function provided for `"+e+"` event listener",u):r.push(t),this};e.prototype.pipe=function(e){if("function"!=typeof e.write||"function"!=typeof e.end)return n.log("Incompatible stream passed to `pipe`",u),this;var t=!1;return"function"==typeof e.emit&&e.emit("pipe",this),"function"==typeof e.on&&e.on("error",function(){t=!0}),this.on("data",function(i){if(!t)try{e.write(i,"utf8")}catch(e){n.log(e,r)}}).on("end",function(){if(!t)try{e.end();t=!0}catch(e){n.log(e,r)}})};t.prototype.write=function(e){var t=this.taps;return t&&(e=t.go(e)),this.data.push(e),this};t.prototype.end=function(e){return e&&this.write(e),this.flushable=!0,this.root.flush(),this};t.prototype.map=function(e){var i=new t(this.root,this.next,this.taps),s=new t(this.root,i,this.taps);this.next=s;this.flushable=!0;try{e(s)}catch(e){n.log(e,r);s.setError(e)}return i};t.prototype.tap=function(e){var t=this.taps;return this.taps=t?t.push(e):new s(e),this};t.prototype.untap=function(){return this.taps=this.taps.tail,this};t.prototype.render=function(e,t){return e(this,t)};t.prototype.reference=function(e,i,r,s){return"function"==typeof e?(e=e.apply(i.current(),[this,i,null,{auto:r,filters:s}]))instanceof t?e:this.reference(e,i,r,s):n.isThenable(e)?this.await(e,i,null,r,s):n.isStreamable(e)?this.stream(e,i,null,r,s):n.isEmpty(e)?this:this.write(n.filter(e,r,s))};t.prototype.section=function(e,i,s,a){var o,l,c,u=s.block,h=s.else,p=this;if("function"==typeof e&&!n.isTemplateFn(e)){try{e=e.apply(i.current(),[this,i,s,a])}catch(e){return n.log(e,r),this.setError(e)}if(e instanceof t)return e}if(n.isEmptyObject(a)||(i=i.push(a)),n.isArray(e)){if(u){if((l=e.length)>0){for((c=i.stack&&i.stack.head||{}).$len=l,o=0;l>o;o++)c.$idx=o,p=u(p,i.push(e[o],o,l));return c.$idx=void 0,c.$len=void 0,p}if(h)return h(this,i)}}else{if(n.isThenable(e))return this.await(e,i,s);if(n.isStreamable(e))return this.stream(e,i,s);if(!0===e){if(u)return u(this,i)}else if(e||0===e){if(u)return u(this,i.push(e))}else if(h)return h(this,i)}return n.log("Section without corresponding key in template `"+i.getTemplateName()+"`",f),this};t.prototype.exists=function(e,t,i){var r=i.block,s=i.else;if(n.isEmpty(e)){if(s)return s(this,t)}else{if(r)return r(this,t);n.log("No block for exists check in template `"+t.getTemplateName()+"`",f)}return this};t.prototype.notexists=function(e,t,i){var r=i.block,s=i.else;if(n.isEmpty(e)){if(r)return r(this,t);n.log("No block for not-exists check in template `"+t.getTemplateName()+"`",f)}else if(s)return s(this,t);return this};t.prototype.block=function(e,t,i){var n=e||i.block;return n?n(this,t):this};t.prototype.partial=function(e,t,i,r){var s;return void 0===r&&(r=i,i=t),n.isEmptyObject(r)||(s=(i=i.clone()).pop(),i=i.push(r).push(s)),n.isTemplateFn(e)?this.capture(e,t,function(e,t){i.templateName=e;o(e,t,i).end()}):(i.templateName=e,o(e,this,i))};t.prototype.helper=function(e,t,i,s){var a,o=this;if(!n.helpers[e])return n.log("Helper `"+e+"` does not exist",u),o;try{return a=n.helpers[e](o,t,i,s),n.isThenable(a)?this.await(a,t,i):a}catch(t){return n.log("Error in helper `"+e+"`: "+t.message,r),o.setError(t)}};t.prototype.await=function(e,t,i,r,s){var a=i&&i.block,o=i&&i.error;return this.map(function(i){e.then(function(e){a?i.render(a,t.push(e)).end():i.reference(e,t,r,s).end()},function(e){o?i.render(o,t.push(e)).end():(n.log("Unhandled promise rejection in `"+t.getTemplateName()+"`"),i.end())})})};t.prototype.stream=function(e,t,i,r,s){var a=i&&i.block,o=i&&i.error;return this.map(function(i){var l=!1;e.on("data",function(e){l||(i=a?i.map(function(i){i.render(a,t.push(e)).end()}):i.reference(e,t,r,s))}).on("error",function(e){l||(o?i.render(o,t.push(e)):n.log("Unhandled stream error in `"+t.getTemplateName()+"`"),l||(l=!0,i.end()))}).on("end",function(){l||(l=!0,i.end())})})};t.prototype.capture=function(e,t,i){return this.map(function(n){var r=new a(function(e,t){e?n.setError(e):i(t,n)});e(r.head,t).end()})};t.prototype.setError=function(e){return this.error=e,this.root.flush(),this};for(h in t.prototype)n._aliases[h]&&(t.prototype[n._aliases[h]]=t.prototype[h]);s.prototype.push=function(e){return new s(e,this)};s.prototype.go=function(e){for(var t=this;t;)e=t.head(e),t=t.tail;return e};var g=/[&<>"']/,nt=/&/g,p=/</g,tt=/>/g,it=/\"/g,rt=/\'/g;n.escapeHtml=function(e){return"string"==typeof e||e&&"function"==typeof e.toString?("string"!=typeof e&&(e=e.toString()),g.test(e)?e.replace(nt,"&amp;").replace(p,"&lt;").replace(tt,"&gt;").replace(it,"&quot;").replace(rt,"&#39;"):e):e};var ut=/\\/g,ft=/\//g,et=/\r/g,w=/\u2028/g,b=/\u2029/g,ot=/\n/g,st=/\f/g,ht=/'/g,ct=/"/g,lt=/\t/g;return n.escapeJs=function(e){return"string"==typeof e?e.replace(ut,"\\\\").replace(ft,"\\/").replace(ct,'\\"').replace(ht,"\\'").replace(et,"\\r").replace(w,"\\u2028").replace(b,"\\u2029").replace(ot,"\\n").replace(st,"\\f").replace(lt,"\\t"):e},n.escapeJSON=function(e){return JSON?JSON.stringify(e).replace(w,"\\u2028").replace(b,"\\u2029").replace(p,"\\u003c"):(n.log("JSON is undefined; could not escape `"+e+"`",u),e)},n}),function(e,t){"function"==typeof define&&define.amd&&!0===define.amd.dust?define("dust.parse",["dust.core"],function(e){return t(e).parse}):"object"==typeof exports?module.exports=t(require("./dust")):t(e.dust)}(this,function(e){var t=function(){function e(e,t,i,n,r,s){this.message=e;this.expected=t;this.found=i;this.offset=n;this.line=r;this.column=s;this.name="SyntaxError"}return function(e,t){function i(){this.constructor=e}i.prototype=t.prototype;e.prototype=new i}(e,Error),{SyntaxError:e,parse:function(t){function i(e){return fi!==e&&(fi>e&&(fi=0,mi={line:1,column:1,seenCR:!1}),function(e,i,n){for(var r,s=i;n>s;s++)"\n"===(r=t.charAt(s))?(e.seenCR||e.line++,e.column=1,e.seenCR=!1):"\r"===r||"\u2028"===r||"\u2029"===r?(e.line++,e.column=1,e.seenCR=!0):(e.column++,e.seenCR=!1)}(mi,fi,e),fi=e),mi}function n(e){yi>pi||(pi>yi&&(yi=pi,gi=[]),gi.push(e))}function r(n,r,s){var a=i(s),o=s<t.length?t.charAt(s):null;return null!==r&&function(e){var t=1;for(e.sort(function(e,t){return e.description<t.description?-1:e.description>t.description?1:0});t<e.length;)e[t-1]===e[t]?e.splice(t,1):t++}(r),new e(null!==n?n:function(e,t){for(var i=new Array(e.length),n=0;n<e.length;n++)i[n]=e[n].description;return"Expected "+(e.length>1?i.slice(0,-1).join(", ")+" or "+i[e.length-1]:i[0])+" but "+(t?'"'+function(e){function t(e){return e.charCodeAt(0).toString(16).toUpperCase()}return e.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/[\x00-\x07\x0B\x0E\x0F]/g,function(e){return"\\x0"+t(e)}).replace(/[\x10-\x1F\x80-\xFF]/g,function(e){return"\\x"+t(e)}).replace(/[\u0180-\u0FFF]/g,function(e){return"\\u0"+t(e)}).replace(/[\u1080-\uFFFF]/g,function(e){return"\\u"+t(e)})}(t)+'"':"end of input")+" found."}(r,o),r,o,s,a.line,a.column)}function s(){return a()}function a(){var e,t,i;for(e=pi,t=[],i=o();i!==j;)t.push(i),i=o();return t!==j&&(di=e,t=W(t)),t}function o(){var e;return(e=_())===j&&(e=N())===j&&(e=function(){var e,i,r,s,o,u,h;if(Ci++,e=pi,(i=l())!==j){for(r=[],s=D();s!==j;)r.push(s),s=D();r!==j&&(s=R())!==j&&(o=a())!==j&&(u=p())!==j?((h=c())===j&&(h=V),h!==j?(di=pi,(q(i,o,u,h)?Y:H)!==j?(di=e,i=X(i,o,u,h),e=i):(pi=e,e=H)):(pi=e,e=H)):(pi=e,e=H)}else pi=e,e=H;if(e===j)if(e=pi,(i=l())!==j){for(r=[],s=D();s!==j;)r.push(s),s=D();r!==j?(47===t.charCodeAt(pi)?(s=K,pi++):(s=j,0===Ci&&n(J)),s!==j&&(o=R())!==j?(di=e,i=Z(i),e=i):(pi=e,e=H)):(pi=e,e=H)}else pi=e,e=H;return Ci--,e===j&&(i=j,0===Ci&&n(z)),e}())===j&&(e=function(){var e,i,r,s,a,o,l,c,p;if(Ci++,e=pi,(i=k())!==j)if(62===t.charCodeAt(pi)?(r=Ce,pi++):(r=j,0===Ci&&n(ve)),r===j&&(43===t.charCodeAt(pi)?(r=Te,pi++):(r=j,0===Ci&&n(Le))),r!==j){for(s=[],a=D();a!==j;)s.push(a),a=D();if(s!==j)if(a=pi,(o=b())!==j&&(di=a,o=we(o)),(a=o)===j&&(a=O()),a!==j)if((o=u())!==j)if((l=h())!==j){for(c=[],p=D();p!==j;)c.push(p),p=D();c!==j?(47===t.charCodeAt(pi)?(p=K,pi++):(p=j,0===Ci&&n(J)),p!==j&&R()!==j?(di=e,i=be(r,a,o,l),e=i):(pi=e,e=H)):(pi=e,e=H)}else pi=e,e=H;else pi=e,e=H;else pi=e,e=H;else pi=e,e=H}else pi=e,e=H;else pi=e,e=H;return Ci--,e===j&&(i=j,0===Ci&&n(ge)),e}())===j&&(e=m())===j&&(e=d())===j&&(e=function(){var e,i,r,s,a,o,l,c;if(Ci++,e=pi,(i=I())!==j){for(r=[],s=D();s!==j;)r.push(s),s=D();r!==j?(di=e,i=Tt(i,r),e=i):(pi=e,e=H)}else pi=e,e=H;if(e===j){if(e=pi,i=[],r=pi,s=pi,Ci++,a=M(),Ci--,a===j?s=Y:(pi=s,s=H),s!==j?(a=pi,Ci++,o=_(),Ci--,o===j?a=Y:(pi=a,a=H),a!==j?(o=pi,Ci++,l=N(),Ci--,l===j?o=Y:(pi=o,o=H),o!==j?(l=pi,Ci++,c=I(),Ci--,c===j?l=Y:(pi=l,l=H),l!==j?(t.length>pi?(c=t.charAt(pi),pi++):(c=j,0===Ci&&n(Lt)),c!==j?(di=r,s=wt(c),r=s):(pi=r,r=H)):(pi=r,r=H)):(pi=r,r=H)):(pi=r,r=H)):(pi=r,r=H),r!==j)for(;r!==j;)i.push(r),r=pi,s=pi,Ci++,a=M(),Ci--,a===j?s=Y:(pi=s,s=H),s!==j?(a=pi,Ci++,o=_(),Ci--,o===j?a=Y:(pi=a,a=H),a!==j?(o=pi,Ci++,l=N(),Ci--,l===j?o=Y:(pi=o,o=H),o!==j?(l=pi,Ci++,c=I(),Ci--,c===j?l=Y:(pi=l,l=H),l!==j?(t.length>pi?(c=t.charAt(pi),pi++):(c=j,0===Ci&&n(Lt)),c!==j?(di=r,s=wt(c),r=s):(pi=r,r=H)):(pi=r,r=H)):(pi=r,r=H)):(pi=r,r=H)):(pi=r,r=H);else i=H;i!==j&&(di=e,i=bt(i));e=i}return Ci--,e===j&&(i=j,0===Ci&&n(vt)),e}()),e}function l(){var e,i,r,s,a,o;if(e=pi,k()!==j)if(Q.test(t.charAt(pi))?(i=t.charAt(pi),pi++):(i=j,0===Ci&&n(ee)),i!==j){for(r=[],s=D();s!==j;)r.push(s),s=D();r!==j&&(s=y())!==j&&(a=u())!==j&&(o=h())!==j?(di=e,e=te(i,s,a,o)):(pi=e,e=H)}else pi=e,e=H;else pi=e,e=H;return e}function c(){var e,i,r,s,a,o;if(Ci++,e=pi,k()!==j)if(47===t.charCodeAt(pi)?(i=K,pi++):(i=j,0===Ci&&n(J)),i!==j){for(r=[],s=D();s!==j;)r.push(s),s=D();if(r!==j)if((s=y())!==j){for(a=[],o=D();o!==j;)a.push(o),o=D();a!==j&&(o=R())!==j?(di=e,e=ne(s)):(pi=e,e=H)}else pi=e,e=H;else pi=e,e=H}else pi=e,e=H;else pi=e,e=H;return Ci--,e===j&&0===Ci&&n(ie),e}function u(){var e,i,r,s;return e=pi,i=pi,58===t.charCodeAt(pi)?(r=re,pi++):(r=j,0===Ci&&n(se)),r!==j&&(s=y())!==j?(di=i,i=r=ae(s)):(pi=i,i=H),i===j&&(i=V),i!==j&&(di=e,i=oe(i)),i}function h(){var e,i,r,s,a,o,l;if(Ci++,e=pi,i=[],r=pi,s=[],(a=D())!==j)for(;a!==j;)s.push(a),a=D();else s=H;for(s!==j&&(a=b())!==j?(61===t.charCodeAt(pi)?(o=ce,pi++):(o=j,0===Ci&&n(ue)),o!==j?((l=g())===j&&(l=y())===j&&(l=O()),l!==j?(di=r,r=s=he(a,l)):(pi=r,r=H)):(pi=r,r=H)):(pi=r,r=H);r!==j;){if(i.push(r),r=pi,s=[],(a=D())!==j)for(;a!==j;)s.push(a),a=D();else s=H;s!==j&&(a=b())!==j?(61===t.charCodeAt(pi)?(o=ce,pi++):(o=j,0===Ci&&n(ue)),o!==j?((l=g())===j&&(l=y())===j&&(l=O()),l!==j?(di=r,r=s=he(a,l)):(pi=r,r=H)):(pi=r,r=H)):(pi=r,r=H)}return i!==j&&(di=e,i=pe(i)),Ci--,(e=i)===j&&(i=j,0===Ci&&n(le)),e}function p(){var e,i,r,s,o,l;for(Ci++,e=pi,i=[],r=pi,k()!==j?(58===t.charCodeAt(pi)?(s=re,pi++):(s=j,0===Ci&&n(se)),s!==j&&(o=b())!==j&&R()!==j&&(l=a())!==j?(di=r,r=he(o,l)):(pi=r,r=H)):(pi=r,r=H);r!==j;)i.push(r),r=pi,k()!==j?(58===t.charCodeAt(pi)?(s=re,pi++):(s=j,0===Ci&&n(se)),s!==j&&(o=b())!==j&&R()!==j&&(l=a())!==j?(di=r,r=he(o,l)):(pi=r,r=H)):(pi=r,r=H);return i!==j&&(di=e,i=fe(i)),Ci--,(e=i)===j&&(i=j,0===Ci&&n(de)),e}function d(){var e,t,i;return Ci++,e=pi,k()!==j&&(t=y())!==j&&(i=f())!==j&&R()!==j?(di=e,e=ye(t,i)):(pi=e,e=H),Ci--,e===j&&0===Ci&&n(me),e}function f(){var e,i,r,s,a;for(Ci++,e=pi,i=[],r=pi,124===t.charCodeAt(pi)?(s=Ee,pi++):(s=j,0===Ci&&n(Oe)),s!==j&&(a=b())!==j?(di=r,r=s=ae(a)):(pi=r,r=H);r!==j;)i.push(r),r=pi,124===t.charCodeAt(pi)?(s=Ee,pi++):(s=j,0===Ci&&n(Oe)),s!==j&&(a=b())!==j?(di=r,r=s=ae(a)):(pi=r,r=H);return i!==j&&(di=e,i=Ae(i)),Ci--,(e=i)===j&&(i=j,0===Ci&&n(Se)),e}function m(){var e,i,r;return Ci++,e=pi,k()!==j?(126===t.charCodeAt(pi)?(i=Pe,pi++):(i=j,0===Ci&&n(_e)),i!==j&&(r=b())!==j&&R()!==j?(di=e,e=Ne(r)):(pi=e,e=H)):(pi=e,e=H),Ci--,e===j&&0===Ci&&n(xe),e}function y(){var e,t;return Ci++,e=pi,(t=w())!==j&&(di=e,t=ke(t)),(e=t)===j&&(e=pi,(t=b())!==j&&(di=e,t=Re(t)),e=t),Ci--,e===j&&(t=j,0===Ci&&n(Me)),e}function g(){var e,t;return Ci++,e=pi,(t=C())===j&&(t=L()),t!==j&&(di=e,t=De(t)),Ci--,(e=t)===j&&(t=j,0===Ci&&n(Ie)),e}function C(){var e,i,r,s;return Ci++,e=pi,(i=L())!==j?(46===t.charCodeAt(pi)?(r=$e,pi++):(r=j,0===Ci&&n(Be)),r!==j&&(s=v())!==j?(di=e,e=i=je(i,s)):(pi=e,e=H)):(pi=e,e=H),Ci--,e===j&&(i=j,0===Ci&&n(Fe)),e}function v(){var e,i,r;if(Ci++,e=pi,i=[],Ge.test(t.charAt(pi))?(r=t.charAt(pi),pi++):(r=j,0===Ci&&n(We)),r!==j)for(;r!==j;)i.push(r),Ge.test(t.charAt(pi))?(r=t.charAt(pi),pi++):(r=j,0===Ci&&n(We));else i=H;return i!==j&&(di=e,i=ze(i)),Ci--,(e=i)===j&&(i=j,0===Ci&&n(Ue)),e}function T(){var e,i,r;return Ci++,e=pi,45===t.charCodeAt(pi)?(i=Ve,pi++):(i=j,0===Ci&&n(qe)),i!==j&&(r=v())!==j?(di=e,e=i=Ye(i,r)):(pi=e,e=H),Ci--,e===j&&(i=j,0===Ci&&n(He)),e}function L(){var e;return Ci++,(e=T())===j&&(e=v()),Ci--,e===j&&0===Ci&&n(Xe),e}function w(){var e,i,r,s;if(Ci++,e=pi,(i=b())===j&&(i=V),i!==j){if(r=[],(s=E())===j&&(s=S()),s!==j)for(;s!==j;)r.push(s),(s=E())===j&&(s=S());else r=H;r!==j?(di=e,e=i=Je(i,r)):(pi=e,e=H)}else pi=e,e=H;if(e===j)if(e=pi,46===t.charCodeAt(pi)?(i=$e,pi++):(i=j,0===Ci&&n(Be)),i!==j){for(r=[],(s=E())===j&&(s=S());s!==j;)r.push(s),(s=E())===j&&(s=S());r!==j?(di=e,e=i=Ze(r)):(pi=e,e=H)}else pi=e,e=H;return Ci--,e===j&&(i=j,0===Ci&&n(Ke)),e}function b(){var e,i,r,s;if(Ci++,e=pi,et.test(t.charAt(pi))?(i=t.charAt(pi),pi++):(i=j,0===Ci&&n(tt)),i!==j){for(r=[],it.test(t.charAt(pi))?(s=t.charAt(pi),pi++):(s=j,0===Ci&&n(nt));s!==j;)r.push(s),it.test(t.charAt(pi))?(s=t.charAt(pi),pi++):(s=j,0===Ci&&n(nt));r!==j?(di=e,e=i=rt(i,r)):(pi=e,e=H)}else pi=e,e=H;return Ci--,e===j&&(i=j,0===Ci&&n(Qe)),e}function S(){var e,i,r,s,a,o;if(Ci++,e=pi,i=pi,(r=function(){var e;return 91===t.charCodeAt(pi)?(e=Kt,pi++):(e=j,0===Ci&&n(Jt)),e}())!==j){if(s=pi,a=[],Ge.test(t.charAt(pi))?(o=t.charAt(pi),pi++):(o=j,0===Ci&&n(We)),o!==j)for(;o!==j;)a.push(o),Ge.test(t.charAt(pi))?(o=t.charAt(pi),pi++):(o=j,0===Ci&&n(We));else a=H;a!==j&&(di=s,a=at(a));(s=a)===j&&(s=y());s!==j&&(a=function(){var e;return 93===t.charCodeAt(pi)?(e=Zt,pi++):(e=j,0===Ci&&n(Qt)),e}())!==j?(di=i,i=r=ot(s)):(pi=i,i=H)}else pi=i,i=H;return i!==j?((r=E())===j&&(r=V),r!==j?(di=e,e=i=lt(i,r)):(pi=e,e=H)):(pi=e,e=H),Ci--,e===j&&(i=j,0===Ci&&n(st)),e}function E(){var e,i,r,s,a;if(Ci++,e=pi,i=[],r=pi,46===t.charCodeAt(pi)?(s=$e,pi++):(s=j,0===Ci&&n(Be)),s!==j&&(a=b())!==j?(di=r,r=s=ut(a)):(pi=r,r=H),r!==j)for(;r!==j;)i.push(r),r=pi,46===t.charCodeAt(pi)?(s=$e,pi++):(s=j,0===Ci&&n(Be)),s!==j&&(a=b())!==j?(di=r,r=s=ut(a)):(pi=r,r=H);else i=H;return i!==j?((r=S())===j&&(r=V),r!==j?(di=e,e=i=ht(i,r)):(pi=e,e=H)):(pi=e,e=H),Ci--,e===j&&(i=j,0===Ci&&n(ct)),e}function O(){var e,i,r,s;if(Ci++,e=pi,34===t.charCodeAt(pi)?(i=dt,pi++):(i=j,0===Ci&&n(ft)),i!==j?(34===t.charCodeAt(pi)?(r=dt,pi++):(r=j,0===Ci&&n(ft)),r!==j?(di=e,e=i=mt()):(pi=e,e=H)):(pi=e,e=H),e===j&&(e=pi,34===t.charCodeAt(pi)?(i=dt,pi++):(i=j,0===Ci&&n(ft)),i!==j&&(r=x())!==j?(34===t.charCodeAt(pi)?(s=dt,pi++):(s=j,0===Ci&&n(ft)),s!==j?(di=e,e=i=yt(r)):(pi=e,e=H)):(pi=e,e=H),e===j))if(e=pi,34===t.charCodeAt(pi)?(i=dt,pi++):(i=j,0===Ci&&n(ft)),i!==j){if(r=[],(s=A())!==j)for(;s!==j;)r.push(s),s=A();else r=H;r!==j?(34===t.charCodeAt(pi)?(s=dt,pi++):(s=j,0===Ci&&n(ft)),s!==j?(di=e,e=i=gt(r)):(pi=e,e=H)):(pi=e,e=H)}else pi=e,e=H;return Ci--,e===j&&(i=j,0===Ci&&n(pt)),e}function A(){var e,t;return(e=m())===j&&(e=d())===j&&(e=pi,(t=x())!==j&&(di=e,t=Ct(t)),e=t),e}function x(){var e,i,r,s,a;if(Ci++,e=pi,i=[],r=pi,s=pi,Ci++,a=M(),Ci--,a===j?s=Y:(pi=s,s=H),s!==j?((a=P())===j&&(Et.test(t.charAt(pi))?(a=t.charAt(pi),pi++):(a=j,0===Ci&&n(Ot))),a!==j?(di=r,r=s=wt(a)):(pi=r,r=H)):(pi=r,r=H),r!==j)for(;r!==j;)i.push(r),r=pi,s=pi,Ci++,a=M(),Ci--,a===j?s=Y:(pi=s,s=H),s!==j?((a=P())===j&&(Et.test(t.charAt(pi))?(a=t.charAt(pi),pi++):(a=j,0===Ci&&n(Ot))),a!==j?(di=r,r=s=wt(a)):(pi=r,r=H)):(pi=r,r=H);else i=H;return i!==j&&(di=e,i=At(i)),Ci--,(e=i)===j&&(i=j,0===Ci&&n(St)),e}function P(){var e,i;return e=pi,t.substr(pi,2)===xt?(i=xt,pi+=2):(i=j,0===Ci&&n(Pt)),i!==j&&(di=e,i=_t()),i}function _(){var e,i,r,s,a,o;if(Ci++,e=pi,t.substr(pi,2)===Mt?(i=Mt,pi+=2):(i=j,0===Ci&&n(kt)),i!==j){for(r=[],s=pi,a=pi,Ci++,t.substr(pi,2)===Rt?(o=Rt,pi+=2):(o=j,0===Ci&&n(It)),Ci--,o===j?a=Y:(pi=a,a=H),a!==j?(t.length>pi?(o=t.charAt(pi),pi++):(o=j,0===Ci&&n(Lt)),o!==j?(di=s,s=a=Dt(o)):(pi=s,s=H)):(pi=s,s=H);s!==j;)r.push(s),s=pi,a=pi,Ci++,t.substr(pi,2)===Rt?(o=Rt,pi+=2):(o=j,0===Ci&&n(It)),Ci--,o===j?a=Y:(pi=a,a=H),a!==j?(t.length>pi?(o=t.charAt(pi),pi++):(o=j,0===Ci&&n(Lt)),o!==j?(di=s,s=a=Dt(o)):(pi=s,s=H)):(pi=s,s=H);r!==j?(t.substr(pi,2)===Rt?(s=Rt,pi+=2):(s=j,0===Ci&&n(It)),s!==j?(di=e,e=i=Ft(r)):(pi=e,e=H)):(pi=e,e=H)}else pi=e,e=H;return Ci--,e===j&&(i=j,0===Ci&&n(Nt)),e}function N(){var e,i,r,s,a,o;if(Ci++,e=pi,t.substr(pi,2)===Bt?(i=Bt,pi+=2):(i=j,0===Ci&&n(jt)),i!==j){for(r=[],s=pi,a=pi,Ci++,t.substr(pi,2)===Ut?(o=Ut,pi+=2):(o=j,0===Ci&&n(Gt)),Ci--,o===j?a=Y:(pi=a,a=H),a!==j?(t.length>pi?(o=t.charAt(pi),pi++):(o=j,0===Ci&&n(Lt)),o!==j?(di=s,s=a=wt(o)):(pi=s,s=H)):(pi=s,s=H);s!==j;)r.push(s),s=pi,a=pi,Ci++,t.substr(pi,2)===Ut?(o=Ut,pi+=2):(o=j,0===Ci&&n(Gt)),Ci--,o===j?a=Y:(pi=a,a=H),a!==j?(t.length>pi?(o=t.charAt(pi),pi++):(o=j,0===Ci&&n(Lt)),o!==j?(di=s,s=a=wt(o)):(pi=s,s=H)):(pi=s,s=H);r!==j?(t.substr(pi,2)===Ut?(s=Ut,pi+=2):(s=j,0===Ci&&n(Gt)),s!==j?(di=e,e=i=Wt(r)):(pi=e,e=H)):(pi=e,e=H)}else pi=e,e=H;return Ci--,e===j&&(i=j,0===Ci&&n($t)),e}function M(){var e,i,r,s,a,o,l,c,u,h;if(e=pi,(i=k())!==j){for(r=[],s=D();s!==j;)r.push(s),s=D();if(r!==j)if(zt.test(t.charAt(pi))?(s=t.charAt(pi),pi++):(s=j,0===Ci&&n(Ht)),s!==j){for(a=[],o=D();o!==j;)a.push(o),o=D();if(a!==j){if(o=[],l=pi,c=pi,Ci++,u=R(),Ci--,u===j?c=Y:(pi=c,c=H),c!==j?(u=pi,Ci++,h=I(),Ci--,h===j?u=Y:(pi=u,u=H),u!==j?(t.length>pi?(h=t.charAt(pi),pi++):(h=j,0===Ci&&n(Lt)),h!==j?l=c=[c,u,h]:(pi=l,l=H)):(pi=l,l=H)):(pi=l,l=H),l!==j)for(;l!==j;)o.push(l),l=pi,c=pi,Ci++,u=R(),Ci--,u===j?c=Y:(pi=c,c=H),c!==j?(u=pi,Ci++,h=I(),Ci--,h===j?u=Y:(pi=u,u=H),u!==j?(t.length>pi?(h=t.charAt(pi),pi++):(h=j,0===Ci&&n(Lt)),h!==j?l=c=[c,u,h]:(pi=l,l=H)):(pi=l,l=H)):(pi=l,l=H);else o=H;if(o!==j){for(l=[],c=D();c!==j;)l.push(c),c=D();l!==j&&(c=R())!==j?e=i=[i,r,s,a,o,l,c]:(pi=e,e=H)}else pi=e,e=H}else pi=e,e=H}else pi=e,e=H;else pi=e,e=H}else pi=e,e=H;return e===j&&(e=d()),e}function k(){var e;return 123===t.charCodeAt(pi)?(e=Vt,pi++):(e=j,0===Ci&&n(qt)),e}function R(){var e;return 125===t.charCodeAt(pi)?(e=Yt,pi++):(e=j,0===Ci&&n(Xt)),e}function I(){var e;return 10===t.charCodeAt(pi)?(e=ei,pi++):(e=j,0===Ci&&n(ti)),e===j&&(t.substr(pi,2)===ii?(e=ii,pi+=2):(e=j,0===Ci&&n(ni)),e===j&&(13===t.charCodeAt(pi)?(e=ri,pi++):(e=j,0===Ci&&n(si)),e===j&&(8232===t.charCodeAt(pi)?(e=ai,pi++):(e=j,0===Ci&&n(oi)),e===j&&(8233===t.charCodeAt(pi)?(e=li,pi++):(e=j,0===Ci&&n(ci)))))),e}function D(){var e;return ui.test(t.charAt(pi))?(e=t.charAt(pi),pi++):(e=j,0===Ci&&n(hi)),e===j&&(e=I()),e}function F(e){return e.concat([["line",i(di).line],["col",i(di).column]])}var $,B=arguments.length>1?arguments[1]:{},j={},U={start:s},G=s,W=function(e){return F(["body"].concat(e))},z={type:"other",description:"section"},H=j,V=null,q=function(e,t,i,n){return n&&e[1].text===n.text||function(e){throw r(e,null,di)}("Expected end tag for "+e[1].text+" but it was not found."),!0},Y=void 0,X=function(e,t,i){return i.push(["param",["literal","block"],t]),e.push(i),F(e)},K="/",J={type:"literal",value:"/",description:'"/"'},Z=function(e){return e.push(["bodies"]),F(e)},Q=/^[#?\^<+@%]/,ee={type:"class",value:"[#?\\^<+@%]",description:"[#?\\^<+@%]"},te=function(e,t,i,n){return[e,t,i,n]},ie={type:"other",description:"end tag"},ne=function(e){return e},re=":",se={type:"literal",value:":",description:'":"'},ae=function(e){return e},oe=function(e){return e?["context",e]:["context"]},le={type:"other",description:"params"},ce="=",ue={type:"literal",value:"=",description:'"="'},he=function(e,t){return["param",["literal",e],t]},pe=function(e){return["params"].concat(e)},de={type:"other",description:"bodies"},fe=function(e){return["bodies"].concat(e)},me={type:"other",description:"reference"},ye=function(e,t){return F(["reference",e,t])},ge={type:"other",description:"partial"},Ce=">",ve={type:"literal",value:">",description:'">"'},Te="+",Le={type:"literal",value:"+",description:'"+"'},we=function(e){return["literal",e]},be=function(e,t,i,n){return F([">"===e?"partial":e,t,i,n])},Se={type:"other",description:"filters"},Ee="|",Oe={type:"literal",value:"|",description:'"|"'},Ae=function(e){return["filters"].concat(e)},xe={type:"other",description:"special"},Pe="~",_e={type:"literal",value:"~",description:'"~"'},Ne=function(e){return F(["special",e])},Me={type:"other",description:"identifier"},ke=function(e){var t=["path"].concat(e);return t.text=e[1].join(".").replace(/,line,\d+,col,\d+/g,""),t},Re=function(e){var t=["key",e];return t.text=e,t},Ie={type:"other",description:"number"},De=function(e){return["literal",e]},Fe={type:"other",description:"float"},$e=".",Be={type:"literal",value:".",description:'"."'},je=function(e,t){return parseFloat(e+"."+t)},Ue={type:"other",description:"unsigned_integer"},Ge=/^[0-9]/,We={type:"class",value:"[0-9]",description:"[0-9]"},ze=function(e){return function(e){return parseInt(e.join(""),10)}(e)},He={type:"other",description:"signed_integer"},Ve="-",qe={type:"literal",value:"-",description:'"-"'},Ye=function(e,t){return-1*t},Xe={type:"other",description:"integer"},Ke={type:"other",description:"path"},Je=function(e,t){return t=t[0],e&&t?(t.unshift(e),F([!1,t])):F([!0,t])},Ze=function(e){return F(e.length>0?[!0,e[0]]:[!0,[]])},Qe={type:"other",description:"key"},et=/^[a-zA-Z_$]/,tt={type:"class",value:"[a-zA-Z_$]",description:"[a-zA-Z_$]"},it=/^[0-9a-zA-Z_$\-]/,nt={type:"class",value:"[0-9a-zA-Z_$\\-]",description:"[0-9a-zA-Z_$\\-]"},rt=function(e,t){return e+t.join("")},st={type:"other",description:"array"},at=function(e){return e.join("")},ot=function(e){return e},lt=function(e,t){return t?t.unshift(e):t=[e],t},ct={type:"other",description:"array_part"},ut=function(e){return e},ht=function(e,t){return t?e.concat(t):e},pt={type:"other",description:"inline"},dt='"',ft={type:"literal",value:'"',description:'"\\""'},mt=function(){return F(["literal",""])},yt=function(e){return F(["literal",e])},gt=function(e){return F(["body"].concat(e))},Ct=function(e){return["buffer",e]},vt={type:"other",description:"buffer"},Tt=function(e,t){return F(["format",e,t.join("")])},Lt={type:"any",description:"any character"},wt=function(e){return e},bt=function(e){return F(["buffer",e.join("")])},St={type:"other",description:"literal"},Et=/^[^"]/,Ot={type:"class",value:'[^"]',description:'[^"]'},At=function(e){return e.join("")},xt='\\"',Pt={type:"literal",value:'\\"',description:'"\\\\\\""'},_t=function(){return'"'},Nt={type:"other",description:"raw"},Mt="{`",kt={type:"literal",value:"{`",description:'"{`"'},Rt="`}",It={type:"literal",value:"`}",description:'"`}"'},Dt=function(e){return e},Ft=function(e){return F(["raw",e.join("")])},$t={type:"other",description:"comment"},Bt="{!",jt={type:"literal",value:"{!",description:'"{!"'},Ut="!}",Gt={type:"literal",value:"!}",description:'"!}"'},Wt=function(e){return F(["comment",e.join("")])},zt=/^[#?\^><+%:@\/~%]/,Ht={type:"class",value:"[#?\\^><+%:@\\/~%]",description:"[#?\\^><+%:@\\/~%]"},Vt="{",qt={type:"literal",value:"{",description:'"{"'},Yt="}",Xt={type:"literal",value:"}",description:'"}"'},Kt="[",Jt={type:"literal",value:"[",description:'"["'},Zt="]",Qt={type:"literal",value:"]",description:'"]"'},ei="\n",ti={type:"literal",value:"\n",description:'"\\n"'},ii="\r\n",ni={type:"literal",value:"\r\n",description:'"\\r\\n"'},ri="\r",si={type:"literal",value:"\r",description:'"\\r"'},ai="\u2028",oi={type:"literal",value:"\u2028",description:'"\\u2028"'},li="\u2029",ci={type:"literal",value:"\u2029",description:'"\\u2029"'},ui=/^[\t\x0B\f \xA0\uFEFF]/,hi={type:"class",value:"[\\t\\x0B\\f \\xA0\\uFEFF]",description:"[\\t\\x0B\\f \\xA0\\uFEFF]"},pi=0,di=0,fi=0,mi={line:1,column:1,seenCR:!1},yi=0,gi=[],Ci=0;if("startRule"in B){if(!(B.startRule in U))throw new Error("Can't start parsing from rule \""+B.startRule+'".');G=U[B.startRule]}if(($=G())!==j&&pi===t.length)return $;throw $!==j&&pi<t.length&&n({type:"end",description:"end of input"}),r(null,gi,yi)}}}();return e.parse=t.parse,t}),function(e,t){"function"==typeof define&&define.amd&&!0===define.amd.dust?define("dust.compile",["dust.core","dust.parse"],function(e,i){return t(i,e).compile}):"object"==typeof exports?module.exports=t(require("./parser").parse,require("./dust")):t(e.dust.parse,e.dust)}(this,function(e,t){function i(e){return h.filterNode({},e)}function n(e,t){for(var i,n=[t[0]],r=1,s=t.length;s>r;r++)(i=h.filterNode(e,t[r]))&&n.push(i);return n}function r(e,t){return t}function s(){}function a(e,i){var n,r={name:i,bodies:[],blocks:{},index:0,auto:"h"},s=t.escapeJs(i),a=i?'"'+s+'",':"",o="function(dust){",l=h.compileNode(r,e);return i&&(o+='dust.register("'+s+'",'+l+");"),n="("+(o+=function(e){var t,i=[],n=e.blocks;for(t in n)i.push('"'+t+'":'+n[t]);return i.length?(e.blocks="ctx=ctx.shiftBlocks(blocks);","var blocks={"+i.join(",")+"};"):(e.blocks="",e.blocks)}(r)+function(e){for(var t=[],i=e.bodies,n=e.blocks,r=0,s=i.length;s>r;r++)t[r]="function body_"+r+"(chk,ctx){"+n+"return chk"+i[r]+";}body_"+r+".__dustBody=!0;";return t.join("")}(r)+"return "+l+"}")+"(dust));",t.config.amd?"define("+a+'["dust.core"],'+o+");":t.config.cjs?"module.exports=function(dust){var tmpl="+n+"var f="+c().toString()+";f.template=tmpl;return f}":n}function o(e,t){for(var i="",n=1,r=t.length;r>n;n++)i+=h.compileNode(e,t[n]);return i}function l(e,i,n){return"."+(t._aliases[n]||n)+"("+h.compileNode(e,i[1])+","+h.compileNode(e,i[2])+","+h.compileNode(e,i[4])+","+h.compileNode(e,i[3])+")"}function c(e){return function(i,n){return t[n?"render":"stream"](e,i,n)}}var u,h={},p=t.isArray;h.compile=function(t,n){try{return a(i(e(t)),n)}catch(e){if(!e.line||!e.column)throw e;throw new SyntaxError(e.message+" At line : "+e.line+", column : "+e.column)}};h.filterNode=function(e,t){return h.optimizers[t[0]](e,t)};h.optimizers={body:function(e,t){for(var i,n,r=[t[0]],s=1,a=t.length;a>s;s++)(n=h.filterNode(e,t[s]))&&("buffer"===n[0]||"format"===n[0]?i?(i[0]="buffer"===n[0]?"buffer":i[0],i[1]+=n.slice(1,-2).join("")):(i=n,r.push(n)):(i=null,r.push(n)));return r},buffer:r,special:function(e,t){return["buffer",u[t[1]],t[2],t[3]]},format:function(e,i){return t.config.whitespace?(i.splice(1,2,i.slice(1,-2).join("")),i):null},reference:n,"#":n,"?":n,"^":n,"<":n,"+":n,"@":n,"%":n,partial:n,context:n,params:n,bodies:n,param:n,filters:r,key:r,path:r,literal:r,raw:r,comment:s,line:s,col:s};h.pragmas={esc:function(e,t,i){var n,r=e.auto;return t||(t="h"),e.auto="s"===t?"":t,n=o(e,i.block),e.auto=r,n}};u={s:" ",n:"\n",r:"\r",lb:"{",rb:"}"};h.compileNode=function(e,t){return h.nodes[t[0]](e,t)};h.nodes={body:function(e,t){var i=e.index++,n="body_"+i;return e.bodies[i]=o(e,t),n},buffer:function(e,t){return".w("+v(t[1])+")"},format:function(e,t){return".w("+v(t[1])+")"},reference:function(e,t){return".f("+h.compileNode(e,t[1])+",ctx,"+h.compileNode(e,t[2])+")"},"#":function(e,t){return l(e,t,"section")},"?":function(e,t){return l(e,t,"exists")},"^":function(e,t){return l(e,t,"notexists")},"<":function(e,t){for(var i,n=t[4],r=1,s=n.length;s>r;r++)if("block"===(i=n[r])[1][1])return e.blocks[t[1].text]=h.compileNode(e,i[2]),"";return""},"+":function(e,t){return void 0===t[1].text&&void 0===t[4]?".b(ctx.getBlock("+h.compileNode(e,t[1])+",chk, ctx),"+h.compileNode(e,t[2])+", {},"+h.compileNode(e,t[3])+")":".b(ctx.getBlock("+v(t[1].text)+"),"+h.compileNode(e,t[2])+","+h.compileNode(e,t[4])+","+h.compileNode(e,t[3])+")"},"@":function(e,t){return".h("+v(t[1].text)+","+h.compileNode(e,t[2])+","+h.compileNode(e,t[4])+","+h.compileNode(e,t[3])+")"},"%":function(e,t){var i,n,r,s,a,o,l,c,u,p=t[1][1];if(!h.pragmas[p])return"";for(n={},c=1,u=(i=t[4]).length;u>c;c++)n[(o=i[c])[1][1]]=o[2];for(s={},c=1,u=(r=t[3]).length;u>c;c++)s[(l=r[c])[1][1]]=l[2][1];return a=t[2][1]?t[2][1].text:null,h.pragmas[p](e,a,n,s)},partial:function(e,t){return".p("+h.compileNode(e,t[1])+",ctx,"+h.compileNode(e,t[2])+","+h.compileNode(e,t[3])+")"},context:function(e,t){return t[1]?"ctx.rebase("+h.compileNode(e,t[1])+")":"ctx"},params:function(e,t){for(var i=[],n=1,r=t.length;r>n;n++)i.push(h.compileNode(e,t[n]));return i.length?"{"+i.join(",")+"}":"{}"},bodies:function(e,t){for(var i=[],n=1,r=t.length;r>n;n++)i.push(h.compileNode(e,t[n]));return"{"+i.join(",")+"}"},param:function(e,t){return h.compileNode(e,t[1])+":"+h.compileNode(e,t[2])},filters:function(e,t){for(var i,n=[],r=1,s=t.length;s>r;r++)i=t[r],n.push('"'+i+'"');return'"'+e.auto+'"'+(n.length?",["+n.join(",")+"]":"")},key:function(e,t){return'ctx.get(["'+t[1]+'"], false)'},path:function(e,t){for(var i=t[1],n=t[2],r=[],s=0,a=n.length;a>s;s++)r.push(p(n[s])?h.compileNode(e,n[s]):'"'+n[s]+'"');return"ctx.getPath("+i+", ["+r.join(",")+"])"},literal:function(e,t){return v(t[1])},raw:function(e,t){return".w("+v(t[1])+")"}};var d=/\\/g,f=/"/g,m=/\f/g,y=/\n/g,g=/\r/g,C=/\t/g,v="undefined"==typeof JSON?function(e){return'"'+function(e){return e.replace(d,"\\\\").replace(f,'\\"').replace(m,"\\f").replace(y,"\\n").replace(g,"\\r").replace(C,"\\t")}(e)+'"'}:JSON.stringify;return t.compiler=h,t.compile=t.compiler.compile,t.renderSource=function(e,i,n){return c(t.loadSource(t.compile(e)))(i,n)},t.compileFn=function(e,i){return c(t.loadSource(t.compile(e,i)))},t.filterNode=h.filterNode,t.optimizers=h.optimizers,t.pragmas=h.pragmas,t.compileNode=h.compileNode,t.nodes=h.nodes,h});"function"==typeof define&&define.amd&&!0===define.amd.dust&&define(["require","dust.core","dust.compile"],function(e,t){return t.onLoad=function(t,i){e([t],function(){i()})},t});!function(e,t){"function"==typeof define&&define.amd&&!0===define.amd.dust?define(["dust.core"],t):"object"==typeof exports?module.exports=t(require("dustjs-linkedin")):t(e.dust)}(this,function(e){function t(t,i,n){n=n||"INFO";t=t?"{@"+t+"}: ":"";e.log(t+i,n)}function i(e){u[e]||(t(e,"Deprecation warning: "+e+" is deprecated and will be removed in a future version of dustjs-helpers","WARN"),t(null,"For help and a deprecation timeline, see https://github.com/linkedin/dustjs-helpers/wiki/Deprecated-Features#"+e.replace(/\W+/g,""),"WARN"),u[e]=!0)}function n(e){return function(e){return e.stack.tail&&e.stack.tail.head&&void 0!==e.stack.tail.head.__select__}(e)&&e.get("__select__")}function r(e,t){var i,n,r=e.stack.head,s=e.rebase();e.stack&&e.stack.tail&&(s.stack=e.stack.tail);n={isPending:!1,isResolved:!1,isDeferredComplete:!1,deferreds:[]};for(i in t)n[i]=t[i];return s.push({__select__:n}).push(r,e.stack.index,e.stack.of)}function s(e){var t,i;if(e.isDeferredPending=!0,e.deferreds.length)for(e.isDeferredComplete=!0,t=0,i=e.deferreds.length;t<i;t++)e.deferreds[t]();e.isDeferredPending=!1}function a(e,t){return"function"==typeof t?t.toString().replace(/(^\s+|\s+$)/gm,"").replace(/\n/gm,"").replace(/,\s*/gm,", ").replace(/\)\{/gm,") {"):t}function o(e,t){return function(i,n,r,s){return l(i,n,r,s,e,t)}}function l(e,i,r,s,a,o){var l,u,h,p=r.block,d=r.else,f=n(i)||{};if(f.isResolved&&!f.isDeferredPending)return e;if(s.hasOwnProperty("key"))u=s.key;else{if(!f.hasOwnProperty("key"))return t(a,"No key specified","WARN"),e;u=f.key}return h=s.type||f.type,o(u=c(i.resolve(u),h),c(i.resolve(s.value),h))?(f.isPending||(l=!0,f.isPending=!0),p&&(e=e.render(p,i)),l&&(f.isResolved=!0)):d&&(e=e.render(d,i)),e}function c(e,t){t&&(t=t.toLowerCase());switch(t){case"number":return+e;case"string":return String(e);case"boolean":return e="false"!==e&&e,Boolean(e);case"date":return new Date(e)}return e}var u={},h={tap:function(e,t,n){return i("tap"),n.resolve(e)},sep:function(e,t,i){var n=i.block;return t.stack.index===t.stack.of-1?e:n?n(e,t):e},first:function(e,t,i){return 0===t.stack.index?i.block(e,t):e},last:function(e,t,i){return t.stack.index===t.stack.of-1?i.block(e,t):e},contextDump:function(e,i,n,r){var s,o,l=i.resolve(r.to);switch(i.resolve(r.key)){case"full":s=i.stack;break;default:s=i.stack.head}o=JSON.stringify(s,a,2);switch(l){case"console":t("contextDump",o);break;default:o=o.replace(/</g,"\\u003c");e=e.write(o)}return e},math:function(e,i,a,o){var l,c=o.key,u=o.method,h=o.operand,p=o.round;if(!o.hasOwnProperty("key")||!o.method)return t("math","`key` or `method` was not provided","ERROR"),e;c=parseFloat(i.resolve(c));h=parseFloat(i.resolve(h));switch(u){case"mod":0===h&&t("math","Division by 0","ERROR");l=c%h;break;case"add":l=c+h;break;case"subtract":l=c-h;break;case"multiply":l=c*h;break;case"divide":0===h&&t("math","Division by 0","ERROR");l=c/h;break;case"ceil":case"floor":case"round":case"abs":l=Math[u](c);break;case"toint":l=parseInt(c,10);break;default:t("math","Method `"+u+"` is not supported","ERROR")}return void 0!==l&&(p&&(l=Math.round(l)),a&&a.block?(i=r(i,{key:l}),e=e.render(a.block,i),s(n(i))):e=e.write(l)),e},select:function(e,i,a,o){var l=a.block,c={};return o.hasOwnProperty("key")&&(c.key=i.resolve(o.key)),o.hasOwnProperty("type")&&(c.type=o.type),l?(i=r(i,c),e=e.render(l,i),s(n(i))):t("select","Missing body block","WARN"),e},eq:o("eq",function(e,t){return e===t}),ne:o("ne",function(e,t){return e!==t}),lt:o("lt",function(e,t){return e<t}),lte:o("lte",function(e,t){return e<=t}),gt:o("gt",function(e,t){return e>t}),gte:o("gte",function(e,t){return e>=t}),any:function(e,i,r){var s=n(i);return s?s.isDeferredComplete?t("any","Must not be nested inside {@any} or {@none} block","ERROR"):e=e.map(function(e){s.deferreds.push(function(){s.isResolved&&(e=e.render(r.block,i));e.end()})}):t("any","Must be used inside a {@select} block","ERROR"),e},none:function(e,i,r){var s=n(i);return s?s.isDeferredComplete?t("none","Must not be nested inside {@any} or {@none} block","ERROR"):e=e.map(function(e){s.deferreds.push(function(){s.isResolved||(e=e.render(r.block,i));e.end()})}):t("none","Must be used inside a {@select} block","ERROR"),e},size:function(t,i,n,r){var s,a,o=r.key;if((o=i.resolve(r.key))&&!0!==o)if(e.isArray(o))s=o.length;else if(!isNaN(parseFloat(o))&&isFinite(o))s=o;else if("object"==typeof o){s=0;for(a in o)o.hasOwnProperty(a)&&s++}else s=(o+"").length;else s=0;return t.write(s)}};for(var p in h)e.helpers[p]=h[p];return e});!function(e,t){"function"==typeof define&&define.amd?define(["dustjs-linkedin"],function(i){return t(i,e)}):"object"==typeof module&&module.exports?module.exports=t(require("dustjs-linkedin"),this):e.dust=t(e.dust,e)}(this,function(e,t,i){"use strict";var n=Object.prototype.toString,r=typeof console!==i?console:{log:function(){}},s={isArray:Array.isArray||function(e){return"[object Array]"===n.call(e)},isAvailable:function(e){return o[e]!==i},log:r.log},a={selected:i,languages:{},filters:{}},o=a.languages;return typeof String.prototype.trim===i&&(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}),e.i18n={resetContext:function(){a.selected=i,Object.keys(o).forEach(function(e){delete o[e]})},setLanguage:function(e){if(!s.isAvailable(e))throw new Error("language '"+e+"' not available!");a.selected=e},setLanguages:function(e){s.isArray(e)&&e.forEach(function(e){s.isAvailable(e)||(o[e]={}),a.selected===i&&(a.selected=e)})},add:function(e,t){if(s.isAvailable(e)){var i=o[e];Object.keys(t).forEach(function(e){i[e]=t[e]})}},addFilter:function(e,t){e in a.filters||(a.filters[e]=t)}},e.helpers.i18n=function(t,n,r,l){if(l&&l.$key!==i){var c,u,h,p,d=a.selected,f=o[d],m=/\{(\s*[\w]+\s*)\}/g;h=e.helpers.tap(l.$key,t,n).split("|");var y=e.helpers.tap(h.shift(),t,n);for(p=f!==i&&f[y]!==i?f[y]:null;null!==(c=m.exec(p));)"$key"===c[1].trim()?(u="",s.log("$key can't be used as a parameter")):u=e.helpers.tap(l[c[1].trim()],t,n),p=p.replace(c[0],u);h.forEach(function(e){e in a.filters&&(p=a.filters[e](p))}),t.write(p)}else s.log("No key given in the i18n helper");return t},e});!function(){dust.helpers.iterate=function(e,t,i,n){var r=(n=n||{}).on||t.current(),s=null!=n.excludedKeys?n.excludedKeys.split(","):null;for(var a in r)(null==s||s.indexOf(a)<0)&&(e=e.render(i.block,t.push({key:a,value:r[a]})));return e};dust.helpers.startsWith=function(e,t,i,n){var r=(n=n||{}).with||t.current();for(var s in r.split(","))if(t.current().toLowerCase().startsWith(s.toLowerCase()))return!0;return!1}}();!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).localforage=e()}}(function(){return function e(t,i,n){function r(a,o){if(!i[a]){if(!t[a]){var l="function"==typeof require&&require;if(!o&&l)return l(a,!0);if(s)return s(a,!0);var c=new Error("Cannot find module '"+a+"'");throw c.code="MODULE_NOT_FOUND",c}var u=i[a]={exports:{}};t[a][0].call(u.exports,function(e){return r(t[a][1][e]||e)},u,u.exports,e,t,i,n)}return i[a].exports}for(var s="function"==typeof require&&require,a=0;a<n.length;a++)r(n[a]);return r}({1:[function(e,t,i){(function(e){"use strict";function i(){c=!0;for(var e,t,i=u.length;i;){for(t=u,u=[],e=-1;++e<i;)t[e]();i=u.length}c=!1}var n,r=e.MutationObserver||e.WebKitMutationObserver;if(r){var s=0,a=new r(i),o=e.document.createTextNode("");a.observe(o,{characterData:!0}),n=function(){o.data=s=++s%2}}else if(e.setImmediate||void 0===e.MessageChannel)n="document"in e&&"onreadystatechange"in e.document.createElement("script")?function(){var t=e.document.createElement("script");t.onreadystatechange=function(){i(),t.onreadystatechange=null,t.parentNode.removeChild(t),t=null},e.document.documentElement.appendChild(t)}:function(){setTimeout(i,0)};else{var l=new e.MessageChannel;l.port1.onmessage=i,n=function(){l.port2.postMessage(0)}}var c,u=[];t.exports=function(e){1!==u.push(e)||c||n()}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],2:[function(e,t,i){"use strict";function n(){}function r(e){if("function"!=typeof e)throw new TypeError("resolver must be a function");this.state=f,this.queue=[],this.outcome=void 0,e!==n&&l(this,e)}function s(e,t,i){this.promise=e,"function"==typeof t&&(this.onFulfilled=t,this.callFulfilled=this.otherCallFulfilled),"function"==typeof i&&(this.onRejected=i,this.callRejected=this.otherCallRejected)}function a(e,t,i){u(function(){var n;try{n=t(i)}catch(t){return h.reject(e,t)}n===e?h.reject(e,new TypeError("Cannot resolve promise with itself")):h.resolve(e,n)})}function o(e){var t=e&&e.then;if(e&&"object"==typeof e&&"function"==typeof t)return function(){t.apply(e,arguments)}}function l(e,t){function i(t){r||(r=!0,h.reject(e,t))}function n(t){r||(r=!0,h.resolve(e,t))}var r=!1,s=c(function(){t(n,i)});"error"===s.status&&i(s.value)}function c(e,t){var i={};try{i.value=e(t),i.status="success"}catch(e){i.status="error",i.value=e}return i}var u=e(1),h={},p=["REJECTED"],d=["FULFILLED"],f=["PENDING"];t.exports=i=r,r.prototype.catch=function(e){return this.then(null,e)},r.prototype.then=function(e,t){if("function"!=typeof e&&this.state===d||"function"!=typeof t&&this.state===p)return this;var i=new this.constructor(n);this.state!==f?a(i,this.state===d?e:t,this.outcome):this.queue.push(new s(i,e,t));return i},s.prototype.callFulfilled=function(e){h.resolve(this.promise,e)},s.prototype.otherCallFulfilled=function(e){a(this.promise,this.onFulfilled,e)},s.prototype.callRejected=function(e){h.reject(this.promise,e)},s.prototype.otherCallRejected=function(e){a(this.promise,this.onRejected,e)},h.resolve=function(e,t){var i=c(o,t);if("error"===i.status)return h.reject(e,i.value);var n=i.value;if(n)l(e,n);else{e.state=d,e.outcome=t;for(var r=-1,s=e.queue.length;++r<s;)e.queue[r].callFulfilled(t)}return e},h.reject=function(e,t){e.state=p,e.outcome=t;for(var i=-1,n=e.queue.length;++i<n;)e.queue[i].callRejected(t);return e},i.resolve=function(e){return e instanceof this?e:h.resolve(new this(n),e)},i.reject=function(e){var t=new this(n);return h.reject(t,e)},i.all=function(e){function t(e,t){i.resolve(e).then(function(e){a[t]=e,++o!==r||s||(s=!0,h.resolve(c,a))},function(e){s||(s=!0,h.reject(c,e))})}var i=this;if("[object Array]"!==Object.prototype.toString.call(e))return this.reject(new TypeError("must be an array"));var r=e.length,s=!1;if(!r)return this.resolve([]);for(var a=new Array(r),o=0,l=-1,c=new this(n);++l<r;)t(e[l],l);return c},i.race=function(e){function t(e){i.resolve(e).then(function(e){s||(s=!0,h.resolve(o,e))},function(e){s||(s=!0,h.reject(o,e))})}var i=this;if("[object Array]"!==Object.prototype.toString.call(e))return this.reject(new TypeError("must be an array"));var r=e.length,s=!1;if(!r)return this.resolve([]);for(var a=-1,o=new this(n);++a<r;)t(e[a]);return o}},{1:1}],3:[function(e,t,i){(function(t){"use strict";"function"!=typeof t.Promise&&(t.Promise=e(2))}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{2:2}],4:[function(e,t,i){"use strict";function n(e,t){e=e||[],t=t||{};try{return new Blob(e,t)}catch(r){if("TypeError"!==r.name)throw r;for(var i=new("undefined"!=typeof BlobBuilder?BlobBuilder:"undefined"!=typeof MSBlobBuilder?MSBlobBuilder:"undefined"!=typeof MozBlobBuilder?MozBlobBuilder:WebKitBlobBuilder),n=0;n<e.length;n+=1)i.append(e[n]);return i.getBlob(t.type)}}function r(e,t){t&&e.then(function(e){t(null,e)},function(e){t(e)})}function s(e,t,i){"function"==typeof t&&e.then(t),"function"==typeof i&&e.catch(i)}function a(e){return"string"!=typeof e&&(console.warn(e+" used as a key, but it is not a string."),e=String(e)),e}function o(e){return"boolean"==typeof w?S.resolve(w):function(e){return new S(function(t){var i=e.transaction(E,x),r=n([""]);i.objectStore(E).put(r,"key"),i.onabort=function(e){e.preventDefault(),e.stopPropagation(),t(!1)},i.oncomplete=function(){var e=navigator.userAgent.match(/Chrome\/(\d+)/),i=navigator.userAgent.match(/Edge\//);t(i||!e||parseInt(e[1],10)>=43)}}).catch(function(){return!1})}(e).then(function(e){return w=e})}function l(e){var t=b[e.name],i={};i.promise=new S(function(e){i.resolve=e}),t.deferredOperations.push(i),t.dbReady?t.dbReady=t.dbReady.then(function(){return i.promise}):t.dbReady=i.promise}function c(e,t){return new S(function(i,n){if(e.db){if(!t)return i(e.db);l(e),e.db.close()}var r=[e.name];t&&r.push(e.version);var s=L.open.apply(L,r);t&&(s.onupgradeneeded=function(t){var i=s.result;try{i.createObjectStore(e.storeName),t.oldVersion<=1&&i.createObjectStore(E)}catch(i){if("ConstraintError"!==i.name)throw i;console.warn('The database "'+e.name+'" has been upgraded from version '+t.oldVersion+" to version "+t.newVersion+', but the storage "'+e.storeName+'" already exists.')}}),s.onerror=function(e){e.preventDefault(),n(s.error)},s.onsuccess=function(){i(s.result),function(e){var t=b[e.name].deferredOperations.pop();t&&t.resolve()}(e)}})}function u(e){return n([function(e){for(var t=e.length,i=new ArrayBuffer(t),n=new Uint8Array(i),r=0;r<t;r++)n[r]=e.charCodeAt(r);return i}(atob(e.data))],{type:e.type})}function h(e){return e&&e.__local_forage_encoded_blob}function p(e){var t=this,i=t._initReady().then(function(){var e=b[t._dbInfo.name];if(e&&e.dbReady)return e.dbReady});return s(i,e,e),i}function d(e){l(e);for(var t=b[e.name].forages,i=0;i<t.length;i++)t[i]._dbInfo.db&&(t[i]._dbInfo.db.close(),t[i]._dbInfo.db=null);return c(e,!1).then(function(e){for(var i=0;i<t.length;i++)t[i]._dbInfo.db=e}).catch(function(t){throw function(e,t){var i=b[e.name].deferredOperations.pop();i&&i.reject(t)}(e,t),t})}function f(e,t,i){try{var n=e.db.transaction(e.storeName,t);i(null,n)}catch(n){if(!e.db||"InvalidStateError"===n.name)return d(e).then(function(){var n=e.db.transaction(e.storeName,t);i(null,n)});i(n)}}function m(e){var t,i,n,r,s,a=.75*e.length,o=e.length,l=0;"="===e[e.length-1]&&(a--,"="===e[e.length-2]&&a--);var c=new ArrayBuffer(a),u=new Uint8Array(c);for(t=0;t<o;t+=4)i=_.indexOf(e[t]),n=_.indexOf(e[t+1]),r=_.indexOf(e[t+2]),s=_.indexOf(e[t+3]),u[l++]=i<<2|n>>4,u[l++]=(15&n)<<4|r>>2,u[l++]=(3&r)<<6|63&s;return c}function y(e){var t,i=new Uint8Array(e),n="";for(t=0;t<i.length;t+=3)n+=_[i[t]>>2],n+=_[(3&i[t])<<4|i[t+1]>>4],n+=_[(15&i[t+1])<<2|i[t+2]>>6],n+=_[63&i[t+2]];return i.length%3==2?n=n.substring(0,n.length-1)+"=":i.length%3==1&&(n=n.substring(0,n.length-2)+"=="),n}function g(){return!function(){var e="_localforage_support_test";try{return localStorage.setItem(e,!0),localStorage.removeItem(e),!1}catch(e){return!0}}()||localStorage.length>0}function C(e,t){e[t]=function(){var i=arguments;return e.ready().then(function(){return e[t].apply(e,i)})}}function v(){for(var e=1;e<arguments.length;e++){var t=arguments[e];if(t)for(var i in t)t.hasOwnProperty(i)&&(J(t[i])?arguments[0][i]=t[i].slice():arguments[0][i]=t[i])}return arguments[0]}var T="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},L=function(){try{if("undefined"!=typeof indexedDB)return indexedDB;if("undefined"!=typeof webkitIndexedDB)return webkitIndexedDB;if("undefined"!=typeof mozIndexedDB)return mozIndexedDB;if("undefined"!=typeof OIndexedDB)return OIndexedDB;if("undefined"!=typeof msIndexedDB)return msIndexedDB}catch(e){return}}();"undefined"==typeof Promise&&e(3);var w,b,S=Promise,E="local-forage-detect-blob-support",O=Object.prototype.toString,A="readonly",x="readwrite",P={_driver:"asyncStorage",_initStorage:function(e){function t(){return S.resolve()}var i=this,n={db:null};if(e)for(var r in e)n[r]=e[r];b||(b={});var s=b[n.name];s||(s={forages:[],db:null,dbReady:null,deferredOperations:[]},b[n.name]=s),s.forages.push(i),i._initReady||(i._initReady=i.ready,i.ready=p);for(var a=[],o=0;o<s.forages.length;o++){var l=s.forages[o];l!==i&&a.push(l._initReady().catch(t))}var u=s.forages.slice(0);return S.all(a).then(function(){return n.db=s.db,c(n,!1)}).then(function(e){return n.db=e,function(e,t){if(!e.db)return!0;var i=!e.db.objectStoreNames.contains(e.storeName),n=e.version<e.db.version,r=e.version>e.db.version;if(n&&(e.version!==t&&console.warn('The database "'+e.name+"\" can't be downgraded from version "+e.db.version+" to version "+e.version+"."),e.version=e.db.version),r||i){if(i){var s=e.db.version+1;s>e.version&&(e.version=s)}return!0}return!1}(n,i._defaultConfig.version)?function(e){return c(e,!0)}(n):e}).then(function(e){n.db=s.db=e,i._dbInfo=n;for(var t=0;t<u.length;t++){var r=u[t];r!==i&&(r._dbInfo.db=n.db,r._dbInfo.version=n.version)}})},_support:function(){try{if(!L)return!1;var e="undefined"!=typeof openDatabase&&/(Safari|iPhone|iPad|iPod)/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent)&&!/BlackBerry/.test(navigator.platform),t="function"==typeof fetch&&-1!==fetch.toString().indexOf("[native code");return(!e||t)&&"undefined"!=typeof indexedDB&&"undefined"!=typeof IDBKeyRange}catch(e){return!1}}(),iterate:function(e,t){var i=this,n=new S(function(t,n){i.ready().then(function(){f(i._dbInfo,A,function(r,s){if(r)return n(r);try{var a=s.objectStore(i._dbInfo.storeName).openCursor(),o=1;a.onsuccess=function(){var i=a.result;if(i){var n=i.value;h(n)&&(n=u(n));var r=e(n,i.key,o++);void 0!==r?t(r):i.continue()}else t()},a.onerror=function(){n(a.error)}}catch(e){n(e)}})}).catch(n)});return r(n,t),n},getItem:function(e,t){var i=this;e=a(e);var n=new S(function(t,n){i.ready().then(function(){f(i._dbInfo,A,function(r,s){if(r)return n(r);try{var a=s.objectStore(i._dbInfo.storeName).get(e);a.onsuccess=function(){var e=a.result;void 0===e&&(e=null),h(e)&&(e=u(e)),t(e)},a.onerror=function(){n(a.error)}}catch(e){n(e)}})}).catch(n)});return r(n,t),n},setItem:function(e,t,i){var n=this;e=a(e);var s=new S(function(i,r){var s;n.ready().then(function(){return s=n._dbInfo,"[object Blob]"===O.call(t)?o(s.db).then(function(e){return e?t:function(e){return new S(function(t,i){var n=new FileReader;n.onerror=i,n.onloadend=function(i){var n=btoa(i.target.result||"");t({__local_forage_encoded_blob:!0,data:n,type:e.type})},n.readAsBinaryString(e)})}(t)}):t}).then(function(t){f(n._dbInfo,x,function(s,a){if(s)return r(s);try{var o=a.objectStore(n._dbInfo.storeName);null===t&&(t=void 0);var l=o.put(t,e);a.oncomplete=function(){void 0===t&&(t=null),i(t)},a.onabort=a.onerror=function(){var e=l.error?l.error:l.transaction.error;r(e)}}catch(e){r(e)}})}).catch(r)});return r(s,i),s},removeItem:function(e,t){var i=this;e=a(e);var n=new S(function(t,n){i.ready().then(function(){f(i._dbInfo,x,function(r,s){if(r)return n(r);try{var a=s.objectStore(i._dbInfo.storeName).delete(e);s.oncomplete=function(){t()},s.onerror=function(){n(a.error)},s.onabort=function(){var e=a.error?a.error:a.transaction.error;n(e)}}catch(e){n(e)}})}).catch(n)});return r(n,t),n},clear:function(e){var t=this,i=new S(function(e,i){t.ready().then(function(){f(t._dbInfo,x,function(n,r){if(n)return i(n);try{var s=r.objectStore(t._dbInfo.storeName).clear();r.oncomplete=function(){e()},r.onabort=r.onerror=function(){var e=s.error?s.error:s.transaction.error;i(e)}}catch(e){i(e)}})}).catch(i)});return r(i,e),i},length:function(e){var t=this,i=new S(function(e,i){t.ready().then(function(){f(t._dbInfo,A,function(n,r){if(n)return i(n);try{var s=r.objectStore(t._dbInfo.storeName).count();s.onsuccess=function(){e(s.result)},s.onerror=function(){i(s.error)}}catch(e){i(e)}})}).catch(i)});return r(i,e),i},key:function(e,t){var i=this,n=new S(function(t,n){e<0?t(null):i.ready().then(function(){f(i._dbInfo,A,function(r,s){if(r)return n(r);try{var a=s.objectStore(i._dbInfo.storeName),o=!1,l=a.openCursor();l.onsuccess=function(){var i=l.result;i?0===e?t(i.key):o?t(i.key):(o=!0,i.advance(e)):t(null)},l.onerror=function(){n(l.error)}}catch(e){n(e)}})}).catch(n)});return r(n,t),n},keys:function(e){var t=this,i=new S(function(e,i){t.ready().then(function(){f(t._dbInfo,A,function(n,r){if(n)return i(n);try{var s=r.objectStore(t._dbInfo.storeName).openCursor(),a=[];s.onsuccess=function(){var t=s.result;t?(a.push(t.key),t.continue()):e(a)},s.onerror=function(){i(s.error)}}catch(e){i(e)}})}).catch(i)});return r(i,e),i}},_="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",N="~~local_forage_type~",M=/^~~local_forage_type~([^~]+)~/,k="__lfsc__:",R=k.length,I="arbf",D="blob",F="si08",$="ui08",B="uic8",j="si16",U="si32",G="ur16",W="ui32",z="fl32",H="fl64",V=R+I.length,q=Object.prototype.toString,Y={serialize:function(e,t){var i="";if(e&&(i=q.call(e)),e&&("[object ArrayBuffer]"===i||e.buffer&&"[object ArrayBuffer]"===q.call(e.buffer))){var n,r=k;e instanceof ArrayBuffer?(n=e,r+=I):(n=e.buffer,"[object Int8Array]"===i?r+=F:"[object Uint8Array]"===i?r+=$:"[object Uint8ClampedArray]"===i?r+=B:"[object Int16Array]"===i?r+=j:"[object Uint16Array]"===i?r+=G:"[object Int32Array]"===i?r+=U:"[object Uint32Array]"===i?r+=W:"[object Float32Array]"===i?r+=z:"[object Float64Array]"===i?r+=H:t(new Error("Failed to get type for BinaryArray"))),t(r+y(n))}else if("[object Blob]"===i){var s=new FileReader;s.onload=function(){var i=N+e.type+"~"+y(this.result);t(k+D+i)},s.readAsArrayBuffer(e)}else try{t(JSON.stringify(e))}catch(i){console.error("Couldn't convert value into a JSON string: ",e),t(null,i)}},deserialize:function(e){if(e.substring(0,R)!==k)return JSON.parse(e);var t,i=e.substring(V),r=e.substring(R,V);if(r===D&&M.test(i)){var s=i.match(M);t=s[1],i=i.substring(s[0].length)}var a=m(i);switch(r){case I:return a;case D:return n([a],{type:t});case F:return new Int8Array(a);case $:return new Uint8Array(a);case B:return new Uint8ClampedArray(a);case j:return new Int16Array(a);case G:return new Uint16Array(a);case U:return new Int32Array(a);case W:return new Uint32Array(a);case z:return new Float32Array(a);case H:return new Float64Array(a);default:throw new Error("Unkown type: "+r)}},stringToBuffer:m,bufferToString:y},X={_driver:"webSQLStorage",_initStorage:function(e){var t=this,i={db:null};if(e)for(var n in e)i[n]="string"!=typeof e[n]?e[n].toString():e[n];var r=new S(function(e,n){try{i.db=openDatabase(i.name,String(i.version),i.description,i.size)}catch(e){return n(e)}i.db.transaction(function(r){r.executeSql("CREATE TABLE IF NOT EXISTS "+i.storeName+" (id INTEGER PRIMARY KEY, key unique, value)",[],function(){t._dbInfo=i,e()},function(e,t){n(t)})})});return i.serializer=Y,r},_support:"function"==typeof openDatabase,iterate:function(e,t){var i=this,n=new S(function(t,n){i.ready().then(function(){var r=i._dbInfo;r.db.transaction(function(i){i.executeSql("SELECT * FROM "+r.storeName,[],function(i,n){for(var s=n.rows,a=s.length,o=0;o<a;o++){var l=s.item(o),c=l.value;if(c&&(c=r.serializer.deserialize(c)),void 0!==(c=e(c,l.key,o+1)))return void t(c)}t()},function(e,t){n(t)})})}).catch(n)});return r(n,t),n},getItem:function(e,t){var i=this;e=a(e);var n=new S(function(t,n){i.ready().then(function(){var r=i._dbInfo;r.db.transaction(function(i){i.executeSql("SELECT * FROM "+r.storeName+" WHERE key = ? LIMIT 1",[e],function(e,i){var n=i.rows.length?i.rows.item(0).value:null;n&&(n=r.serializer.deserialize(n)),t(n)},function(e,t){n(t)})})}).catch(n)});return r(n,t),n},setItem:function(e,t,i){return function e(t,i,n,s){var o=this;t=a(t);var l=new S(function(r,a){o.ready().then(function(){void 0===i&&(i=null);var l=i,c=o._dbInfo;c.serializer.serialize(i,function(i,u){u?a(u):c.db.transaction(function(e){e.executeSql("INSERT OR REPLACE INTO "+c.storeName+" (key, value) VALUES (?, ?)",[t,i],function(){r(l)},function(e,t){a(t)})},function(i){if(i.code===i.QUOTA_ERR){if(s>0)return void r(e.apply(o,[t,l,n,s-1]));a(i)}})})}).catch(a)});return r(l,n),l}.apply(this,[e,t,i,1])},removeItem:function(e,t){var i=this;e=a(e);var n=new S(function(t,n){i.ready().then(function(){var r=i._dbInfo;r.db.transaction(function(i){i.executeSql("DELETE FROM "+r.storeName+" WHERE key = ?",[e],function(){t()},function(e,t){n(t)})})}).catch(n)});return r(n,t),n},clear:function(e){var t=this,i=new S(function(e,i){t.ready().then(function(){var n=t._dbInfo;n.db.transaction(function(t){t.executeSql("DELETE FROM "+n.storeName,[],function(){e()},function(e,t){i(t)})})}).catch(i)});return r(i,e),i},length:function(e){var t=this,i=new S(function(e,i){t.ready().then(function(){var n=t._dbInfo;n.db.transaction(function(t){t.executeSql("SELECT COUNT(key) as c FROM "+n.storeName,[],function(t,i){var n=i.rows.item(0).c;e(n)},function(e,t){i(t)})})}).catch(i)});return r(i,e),i},key:function(e,t){var i=this,n=new S(function(t,n){i.ready().then(function(){var r=i._dbInfo;r.db.transaction(function(i){i.executeSql("SELECT key FROM "+r.storeName+" WHERE id = ? LIMIT 1",[e+1],function(e,i){var n=i.rows.length?i.rows.item(0).key:null;t(n)},function(e,t){n(t)})})}).catch(n)});return r(n,t),n},keys:function(e){var t=this,i=new S(function(e,i){t.ready().then(function(){var n=t._dbInfo;n.db.transaction(function(t){t.executeSql("SELECT key FROM "+n.storeName,[],function(t,i){for(var n=[],r=0;r<i.rows.length;r++)n.push(i.rows.item(r).key);e(n)},function(e,t){i(t)})})}).catch(i)});return r(i,e),i}},K={_driver:"localStorageWrapper",_initStorage:function(e){var t={};if(e)for(var i in e)t[i]=e[i];return t.keyPrefix=t.name+"/",t.storeName!==this._defaultConfig.storeName&&(t.keyPrefix+=t.storeName+"/"),g()?(this._dbInfo=t,t.serializer=Y,S.resolve()):S.reject()},_support:function(){try{return"undefined"!=typeof localStorage&&"setItem"in localStorage&&"function"==typeof localStorage.setItem}catch(e){return!1}}(),iterate:function(e,t){var i=this,n=i.ready().then(function(){for(var t=i._dbInfo,n=t.keyPrefix,r=n.length,s=localStorage.length,a=1,o=0;o<s;o++){var l=localStorage.key(o);if(0===l.indexOf(n)){var c=localStorage.getItem(l);if(c&&(c=t.serializer.deserialize(c)),void 0!==(c=e(c,l.substring(r),a++)))return c}}});return r(n,t),n},getItem:function(e,t){var i=this;e=a(e);var n=i.ready().then(function(){var t=i._dbInfo,n=localStorage.getItem(t.keyPrefix+e);return n&&(n=t.serializer.deserialize(n)),n});return r(n,t),n},setItem:function(e,t,i){var n=this;e=a(e);var s=n.ready().then(function(){void 0===t&&(t=null);var i=t;return new S(function(r,s){var a=n._dbInfo;a.serializer.serialize(t,function(t,n){if(n)s(n);else try{localStorage.setItem(a.keyPrefix+e,t),r(i)}catch(e){"QuotaExceededError"!==e.name&&"NS_ERROR_DOM_QUOTA_REACHED"!==e.name||s(e),s(e)}})})});return r(s,i),s},removeItem:function(e,t){var i=this;e=a(e);var n=i.ready().then(function(){var t=i._dbInfo;localStorage.removeItem(t.keyPrefix+e)});return r(n,t),n},clear:function(e){var t=this,i=t.ready().then(function(){for(var e=t._dbInfo.keyPrefix,i=localStorage.length-1;i>=0;i--){var n=localStorage.key(i);0===n.indexOf(e)&&localStorage.removeItem(n)}});return r(i,e),i},length:function(e){var t=this.keys().then(function(e){return e.length});return r(t,e),t},key:function(e,t){var i=this,n=i.ready().then(function(){var t,n=i._dbInfo;try{t=localStorage.key(e)}catch(e){t=null}return t&&(t=t.substring(n.keyPrefix.length)),t});return r(n,t),n},keys:function(e){var t=this,i=t.ready().then(function(){for(var e=t._dbInfo,i=localStorage.length,n=[],r=0;r<i;r++){var s=localStorage.key(r);0===s.indexOf(e.keyPrefix)&&n.push(s.substring(e.keyPrefix.length))}return n});return r(i,e),i}},J=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)},Z={},Q={},ee={INDEXEDDB:P,WEBSQL:X,LOCALSTORAGE:K},te=["clear","getItem","iterate","key","keys","length","removeItem","setItem"],ie={description:"",driver:[ee.INDEXEDDB._driver,ee.WEBSQL._driver,ee.LOCALSTORAGE._driver].slice(),name:"localforage",size:4980736,storeName:"keyvaluepairs",version:1},ne=new(function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e);for(var i in ee)if(ee.hasOwnProperty(i)){var n=ee[i],r=n._driver;this[i]=r,Z[r]||this.defineDriver(n)}this._defaultConfig=v({},ie),this._config=v({},this._defaultConfig,t),this._driverSet=null,this._initDriver=null,this._ready=!1,this._dbInfo=null,this._wrapLibraryMethodsWithReady(),this.setDriver(this._config.driver).catch(function(){})}return e.prototype.config=function(e){if("object"===(void 0===e?"undefined":T(e))){if(this._ready)return new Error("Can't call config() after localforage has been used.");for(var t in e){if("storeName"===t&&(e[t]=e[t].replace(/\W/g,"_")),"version"===t&&"number"!=typeof e[t])return new Error("Database version must be a number.");this._config[t]=e[t]}return!("driver"in e&&e.driver)||this.setDriver(this._config.driver)}return"string"==typeof e?this._config[e]:this._config},e.prototype.defineDriver=function(e,t,i){var n=new S(function(t,i){try{var n=e._driver,r=new Error("Custom driver not compliant; see https://mozilla.github.io/localForage/#definedriver");if(!e._driver)return void i(r);for(var s=te.concat("_initStorage"),a=0,o=s.length;a<o;a++){var l=s[a];if(!l||!e[l]||"function"!=typeof e[l])return void i(r)}var c=function(i){Z[n]&&console.info("Redefining LocalForage driver: "+n),Z[n]=e,Q[n]=i,t()};"_support"in e?e._support&&"function"==typeof e._support?e._support().then(c,i):c(!!e._support):c(!0)}catch(e){i(e)}});return s(n,t,i),n},e.prototype.driver=function(){return this._driver||null},e.prototype.getDriver=function(e,t,i){var n=Z[e]?S.resolve(Z[e]):S.reject(new Error("Driver not found."));return s(n,t,i),n},e.prototype.getSerializer=function(e){var t=S.resolve(Y);return s(t,e),t},e.prototype.ready=function(e){var t=this,i=t._driverSet.then(function(){return null===t._ready&&(t._ready=t._initDriver()),t._ready});return s(i,e,e),i},e.prototype.setDriver=function(e,t,i){function n(){a._config.driver=a.driver()}function r(e){return a._extend(e),n(),a._ready=a._initStorage(a._config),a._ready}var a=this;J(e)||(e=[e]);var o=this._getSupportedDrivers(e),l=null!==this._driverSet?this._driverSet.catch(function(){return S.resolve()}):S.resolve();return this._driverSet=l.then(function(){var e=o[0];return a._dbInfo=null,a._ready=null,a.getDriver(e).then(function(e){a._driver=e._driver,n(),a._wrapLibraryMethodsWithReady(),a._initDriver=function(e){return function(){var t=0;return function i(){for(;t<e.length;){var s=e[t];return t++,a._dbInfo=null,a._ready=null,a.getDriver(s).then(r).catch(i)}n();var o=new Error("No available storage method found.");return a._driverSet=S.reject(o),a._driverSet}()}}(o)})}).catch(function(){n();var e=new Error("No available storage method found.");return a._driverSet=S.reject(e),a._driverSet}),s(this._driverSet,t,i),this._driverSet},e.prototype.supports=function(e){return!!Q[e]},e.prototype._extend=function(e){v(this,e)},e.prototype._getSupportedDrivers=function(e){for(var t=[],i=0,n=e.length;i<n;i++){var r=e[i];this.supports(r)&&t.push(r)}return t},e.prototype._wrapLibraryMethodsWithReady=function(){for(var e=0,t=te.length;e<t;e++)C(this,te[e])},e.prototype.createInstance=function(t){return new e(t)},e}());t.exports=ne},{3:3}]},{},[4])(4)});var __extends=this.__extends||function(e,t){function i(){this.constructor=e}for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);i.prototype=t.prototype;e.prototype=new i},exports,define;function JL(e){if(!e)return JL.__;Array.prototype.reduce||(Array.prototype.reduce=function(e,t){for(var i=t,n=0;n<this.length;n++)i=e(i,this[n],n,this);return i});var t="";return("."+e).split(".").reduce(function(e,i,n,r){void 0===(i=e["__"+(t=t?t+"."+i:i)])&&(JL.Logger.prototype=e,i=new JL.Logger(t),e["__"+t]=i);return i},JL.__)}!function(e){function t(e,t,i){void 0!==t[e]&&(null===t[e]?delete i[e]:i[e]=t[e])}function i(t){if(null!=e.enabled&&!e.enabled||null!=e.maxMessages&&1>e.maxMessages)return!1;try{if(t.userAgentRegex&&!RegExp(t.userAgentRegex).test(navigator.userAgent))return!1}catch(e){}try{if(t.ipRegex&&e.clientIP&&!RegExp(t.ipRegex).test(e.clientIP))return!1}catch(e){}return!0}function n(e,t){try{if(e.disallow&&RegExp(e.disallow).test(t))return!1}catch(e){}return!0}function r(e){return"function"==typeof e?e instanceof RegExp?e.toString():e():e}function s(e){switch(typeof(e=r(e))){case"string":return new a(e,null,e);case"number":case"boolean":return e=e.toString(),new a(e,null,e);case"undefined":return new a("undefined",null,"undefined");case"object":return e instanceof RegExp||e instanceof String||e instanceof Number||e instanceof Boolean?(e=e.toString(),new a(e,null,e)):new a(null,e,JSON.stringify(e));default:return new a("unknown",null,"unknown")}}e.enabled;e.maxMessages;e.defaultAjaxUrl;e.clientIP;e.defaultBeforeSend;e.requestId="";var a=function(e,t,i){this.msg=e;this.meta=t;this.finalString=i};e.setOptions=function(e){t("enabled",e,this);t("maxMessages",e,this);t("defaultAjaxUrl",e,this);t("clientIP",e,this);t("requestId",e,this);t("defaultBeforeSend",e,this);return this};e.getAllLevel=function(){return-2147483648};e.getTraceLevel=function(){return 1e3};e.getDebugLevel=function(){return 2e3};e.getInfoLevel=function(){return 3e3};e.getWarnLevel=function(){return 4e3};e.getErrorLevel=function(){return 5e3};e.getFatalLevel=function(){return 6e3};e.getOffLevel=function(){return 2147483647};var o=function(e,t){this.inner=t;this.name="JL.Exception";this.message=s(e).finalString};e.Exception=o;o.prototype=Error();var l=function(e,t,i,n){this.l=e;this.m=t;this.n=i;this.t=n};e.LogItem=l;o=function(){function r(t,i){this.appenderName=t;this.sendLogItems=i;this.level=e.getTraceLevel();this.sendWithBufferLevel=2147483647;this.storeInBufferLevel=-2147483648;this.bufferSize=0;this.batchSize=1;this.buffer=[];this.batchBuffer=[]}r.prototype.setOptions=function(e){t("level",e,this);t("ipRegex",e,this);t("userAgentRegex",e,this);t("disallow",e,this);t("sendWithBufferLevel",e,this);t("storeInBufferLevel",e,this);t("bufferSize",e,this);t("batchSize",e,this);this.bufferSize<this.buffer.length&&(this.buffer.length=this.bufferSize);return this};r.prototype.log=function(e,t,r,s,a,o,c){!i(this)||!n(this,o)||a<this.storeInBufferLevel||(e=new l(a,o,c,(new Date).getTime()),a<this.level?0<this.bufferSize&&(this.buffer.push(e),this.buffer.length>this.bufferSize&&this.buffer.shift()):(a<this.sendWithBufferLevel||!this.buffer.length||(this.batchBuffer=this.batchBuffer.concat(this.buffer),this.buffer.length=0),this.batchBuffer.push(e),this.batchBuffer.length>=this.batchSize&&this.sendBatch()))};r.prototype.sendBatch=function(){0==this.batchBuffer.length||null!=e.maxMessages&&1>e.maxMessages||(null!=e.maxMessages&&(e.maxMessages-=this.batchBuffer.length),this.sendLogItems(this.batchBuffer),this.batchBuffer.length=0)};return r}();e.Appender=o;var c=function(i){function n(e){i.call(this,e,n.prototype.sendLogItemsAjax)}__extends(n,i);n.prototype.setOptions=function(e){t("url",e,this);t("beforeSend",e,this);i.prototype.setOptions.call(this,e);return this};n.prototype.sendLogItemsAjax=function(t){try{var i="/jsnlog.logger";null!=e.defaultAjaxUrl&&(i=e.defaultAjaxUrl);this.url&&(i=this.url);var n=JSON.stringify({r:e.requestId,lg:t}),r=this.getXhr(i);"function"==typeof this.beforeSend?this.beforeSend.call(this,r):"function"==typeof e.defaultBeforeSend&&e.defaultBeforeSend.call(this,r);r.send(n)}catch(e){}};n.prototype.getXhr=function(t){var i=new XMLHttpRequest;if(!("withCredentials"in i)&&"undefined"!=typeof XDomainRequest)return(i=new XDomainRequest).open("POST",t),i;i.open("POST",t);i.setRequestHeader("Content-Type","application/json");i.setRequestHeader("JSNLog-RequestId",e.requestId);return i};return n}(o);e.AjaxAppender=c;var u=function(t){function i(e){t.call(this,e,i.prototype.sendLogItemsConsole)}__extends(i,t);i.prototype.clog=function(e){console.log(e)};i.prototype.cerror=function(e){console.error?console.error(e):this.clog(e)};i.prototype.cwarn=function(e){console.warn?console.warn(e):this.clog(e)};i.prototype.cinfo=function(e){console.info?console.info(e):this.clog(e)};i.prototype.cdebug=function(e){console.debug?console.debug(e):this.cinfo(e)};i.prototype.sendLogItemsConsole=function(t){try{if(console){var i;for(i=0;i<t.length;++i){var n=t[i],r=n.n+": "+n.m;"undefined"==typeof window&&(r=new Date(n.t)+" | "+r);n.l<=e.getDebugLevel()?this.cdebug(r):n.l<=e.getInfoLevel()?this.cinfo(r):n.l<=e.getWarnLevel()?this.cwarn(r):this.cerror(r)}}}catch(e){}};return i}(o);e.ConsoleAppender=u;o=function(){function e(e){this.loggerName=e;this.seenRegexes=[]}e.prototype.setOptions=function(e){t("level",e,this);t("userAgentRegex",e,this);t("disallow",e,this);t("ipRegex",e,this);t("appenders",e,this);t("onceOnly",e,this);this.seenRegexes=[];return this};e.prototype.buildExceptionObject=function(e){var t={};e.stack?t.stack=e.stack:t.e=e;e.message&&(t.message=e.message);e.name&&(t.name=e.name);e.data&&(t.data=e.data);e.inner&&(t.inner=this.buildExceptionObject(e.inner));return t};e.prototype.log=function(e,t,a){var o=0;if(!this.appenders)return this;if(e>=this.level&&i(this)&&(a?(o=this.buildExceptionObject(a)).logData=r(t):o=t,n(this,(t=s(o)).finalString))){if(this.onceOnly)for(o=this.onceOnly.length-1;0<=o;){if(RegExp(this.onceOnly[o]).test(t.finalString)){if(this.seenRegexes[o])return this;this.seenRegexes[o]=!0}o--}t.meta=t.meta||{};t.meta.loggerName=this.loggerName;for(o=this.appenders.length-1;0<=o;)this.appenders[o].log(1e3>=e?"trace":2e3>=e?"debug":3e3>=e?"info":4e3>=e?"warn":5e3>=e?"error":"fatal",t.msg,t.meta,function(){},e,t.finalString,this.loggerName),o--}return this};e.prototype.trace=function(e){return this.log(1e3,e)};e.prototype.debug=function(e){return this.log(2e3,e)};e.prototype.info=function(e){return this.log(3e3,e)};e.prototype.warn=function(e){return this.log(4e3,e)};e.prototype.error=function(e){return this.log(5e3,e)};e.prototype.fatal=function(e){return this.log(6e3,e)};e.prototype.fatalException=function(e,t){return this.log(6e3,e,t)};return e}();e.Logger=o;e.createAjaxAppender=function(e){return new c(e)};e.createConsoleAppender=function(e){return new u(e)};o=new c("");"undefined"==typeof window&&(o=new u(""));e.__=new e.Logger("");e.__.setOptions({level:e.getDebugLevel(),appenders:[o]})}(JL||(JL={}));void 0!==exports&&(exports.JL=JL);"function"==typeof define&&define.amd&&define("jsnlog",[],function(){return JL});"function"==typeof __jsnlog_configure&&__jsnlog_configure(JL);var OpenLayers={VERSION_NUMBER:"Release 2.13.1",singleFile:!0,_getScriptLocation:function(){for(var e,t,i=new RegExp("(^|(.*?\\/))(OpenLayers[^\\/]*?\\.js)(\\?|$)"),n=document.getElementsByTagName("script"),r="",s=0,a=n.length;s<a;s++)if((e=n[s].getAttribute("src"))&&(t=e.match(i))){r=t[1];break}return function(){return r}}(),ImgPath:"",Class:function(){var e=arguments.length,t=arguments[0],i=arguments[e-1],n="function"==typeof i.initialize?i.initialize:function(){t.prototype.initialize.apply(this,arguments)};if(e>1){var r=[n,t].concat(Array.prototype.slice.call(arguments).slice(1,e-1),i);OpenLayers.inherit.apply(null,r)}else n.prototype=i;return n},inherit:function(e,t){var i,n,r,s=function(){};s.prototype=t.prototype;e.prototype=new s;for(i=2,n=arguments.length;i<n;i++){"function"==typeof(r=arguments[i])&&(r=r.prototype);OpenLayers.Util.extend(e.prototype,r)}}};OpenLayers.Util=OpenLayers.Util||{};OpenLayers.Util.extend=function(e,t){e=e||{};if(t){for(var i in t){var n=t[i];void 0!==n&&(e[i]=n)}!("function"==typeof window.Event&&t instanceof window.Event)&&t.hasOwnProperty&&t.hasOwnProperty("toString")&&(e.toString=t.toString)}return e};OpenLayers.String={startsWith:function(e,t){return 0==e.indexOf(t)},contains:function(e,t){return-1!=e.indexOf(t)},trim:function(e){return e.replace(/^\s\s*/,"").replace(/\s\s*$/,"")},camelize:function(e){for(var t=e.split("-"),i=t[0],n=1,r=t.length;n<r;n++){var s=t[n];i+=s.charAt(0).toUpperCase()+s.substring(1)}return i},format:function(e,t,i){t||(t=window);return e.replace(OpenLayers.String.tokenRegEx,function(e,n){for(var r,s=n.split(/\.+/),a=0;a<s.length;a++){0==a&&(r=t);if(void 0===r)break;r=r[s[a]]}"function"==typeof r&&(r=i?r.apply(null,i):r());return void 0===r?"undefined":r})},tokenRegEx:/\$\{([\w.]+?)\}/g,numberRegEx:/^([+-]?)(?=\d|\.\d)\d*(\.\d*)?([Ee]([+-]?\d+))?$/,isNumeric:function(e){return OpenLayers.String.numberRegEx.test(e)},numericIf:function(e,t){var i=e;!0===t&&null!=e&&e.replace&&(e=e.replace(/^\s*|\s*$/g,""));return OpenLayers.String.isNumeric(e)?parseFloat(e):i}};OpenLayers.Number={decimalSeparator:".",thousandsSeparator:",",limitSigDigs:function(e,t){var i=0;t>0&&(i=parseFloat(e.toPrecision(t)));return i},format:function(e,t,i,n){t=void 0!==t?t:0;i=void 0!==i?i:OpenLayers.Number.thousandsSeparator;n=void 0!==n?n:OpenLayers.Number.decimalSeparator;null!=t&&(e=parseFloat(e.toFixed(t)));var r=e.toString().split(".");1==r.length&&null==t&&(t=0);var s,a=r[0];if(i)for(var o=/(-?[0-9]+)([0-9]{3})/;o.test(a);)a=a.replace(o,"$1"+i+"$2");if(0==t)s=a;else{var l=r.length>1?r[1]:"0";null!=t&&(l+=new Array(t-l.length+1).join("0"));s=a+n+l}return s},zeroPad:function(e,t,i){for(var n=e.toString(i||10);n.length<t;)n="0"+n;return n}};OpenLayers.Function={bind:function(e,t){var i=Array.prototype.slice.apply(arguments,[2]);return function(){var n=i.concat(Array.prototype.slice.apply(arguments,[0]));return e.apply(t,n)}},bindAsEventListener:function(e,t){return function(i){return e.call(t,i||window.event)}},False:function(){return!1},True:function(){return!0},Void:function(){}};OpenLayers.Array={filter:function(e,t,i){var n=[];if(Array.prototype.filter)n=e.filter(t,i);else{var r=e.length;if("function"!=typeof t)throw new TypeError;for(var s=0;s<r;s++)if(s in e){var a=e[s];t.call(i,a,s,e)&&n.push(a)}}return n}};OpenLayers.Bounds=OpenLayers.Class({left:null,bottom:null,right:null,top:null,centerLonLat:null,initialize:function(e,t,i,n){if(OpenLayers.Util.isArray(e)){n=e[3];i=e[2];t=e[1];e=e[0]}null!=e&&(this.left=OpenLayers.Util.toFloat(e));null!=t&&(this.bottom=OpenLayers.Util.toFloat(t));null!=i&&(this.right=OpenLayers.Util.toFloat(i));null!=n&&(this.top=OpenLayers.Util.toFloat(n))},clone:function(){return new OpenLayers.Bounds(this.left,this.bottom,this.right,this.top)},equals:function(e){var t=!1;null!=e&&(t=this.left==e.left&&this.right==e.right&&this.top==e.top&&this.bottom==e.bottom);return t},toString:function(){return[this.left,this.bottom,this.right,this.top].join(",")},toArray:function(e){return!0===e?[this.bottom,this.left,this.top,this.right]:[this.left,this.bottom,this.right,this.top]},toBBOX:function(e,t){null==e&&(e=6);var i=Math.pow(10,e),n=Math.round(this.left*i)/i,r=Math.round(this.bottom*i)/i,s=Math.round(this.right*i)/i,a=Math.round(this.top*i)/i;return!0===t?r+","+n+","+a+","+s:n+","+r+","+s+","+a},toGeometry:function(){return new OpenLayers.Geometry.Polygon([new OpenLayers.Geometry.LinearRing([new OpenLayers.Geometry.Point(this.left,this.bottom),new OpenLayers.Geometry.Point(this.right,this.bottom),new OpenLayers.Geometry.Point(this.right,this.top),new OpenLayers.Geometry.Point(this.left,this.top)])])},getWidth:function(){return this.right-this.left},getHeight:function(){return this.top-this.bottom},getSize:function(){return new OpenLayers.Size(this.getWidth(),this.getHeight())},getCenterPixel:function(){return new OpenLayers.Pixel((this.left+this.right)/2,(this.bottom+this.top)/2)},getCenterLonLat:function(){this.centerLonLat||(this.centerLonLat=new OpenLayers.LonLat((this.left+this.right)/2,(this.bottom+this.top)/2));return this.centerLonLat},scale:function(e,t){null==t&&(t=this.getCenterLonLat());var i,n;if("OpenLayers.LonLat"==t.CLASS_NAME){i=t.lon;n=t.lat}else{i=t.x;n=t.y}var r=(this.left-i)*e+i,s=(this.bottom-n)*e+n,a=(this.right-i)*e+i,o=(this.top-n)*e+n;return new OpenLayers.Bounds(r,s,a,o)},add:function(e,t){if(null==e||null==t)throw new TypeError("Bounds.add cannot receive null values");return new OpenLayers.Bounds(this.left+e,this.bottom+t,this.right+e,this.top+t)},extend:function(e){if(e)switch(e.CLASS_NAME){case"OpenLayers.LonLat":this.extendXY(e.lon,e.lat);break;case"OpenLayers.Geometry.Point":this.extendXY(e.x,e.y);break;case"OpenLayers.Bounds":this.centerLonLat=null;(null==this.left||e.left<this.left)&&(this.left=e.left);(null==this.bottom||e.bottom<this.bottom)&&(this.bottom=e.bottom);(null==this.right||e.right>this.right)&&(this.right=e.right);(null==this.top||e.top>this.top)&&(this.top=e.top)}},extendXY:function(e,t){this.centerLonLat=null;(null==this.left||e<this.left)&&(this.left=e);(null==this.bottom||t<this.bottom)&&(this.bottom=t);(null==this.right||e>this.right)&&(this.right=e);(null==this.top||t>this.top)&&(this.top=t)},containsLonLat:function(e,t){"boolean"==typeof t&&(t={inclusive:t});t=t||{};var i=this.contains(e.lon,e.lat,t.inclusive),n=t.worldBounds;if(n&&!i){var r=n.getWidth(),s=(n.left+n.right)/2,a=Math.round((e.lon-s)/r);i=this.containsLonLat({lon:e.lon-a*r,lat:e.lat},{inclusive:t.inclusive})}return i},containsPixel:function(e,t){return this.contains(e.x,e.y,t)},contains:function(e,t,i){null==i&&(i=!0);if(null==e||null==t)return!1;e=OpenLayers.Util.toFloat(e);t=OpenLayers.Util.toFloat(t);return i?e>=this.left&&e<=this.right&&t>=this.bottom&&t<=this.top:e>this.left&&e<this.right&&t>this.bottom&&t<this.top},intersectsBounds:function(e,t){"boolean"==typeof t&&(t={inclusive:t});if((t=t||{}).worldBounds){var i=this.wrapDateLine(t.worldBounds);e=e.wrapDateLine(t.worldBounds)}else i=this;null==t.inclusive&&(t.inclusive=!0);var n=!1,r=i.left==e.right||i.right==e.left||i.top==e.bottom||i.bottom==e.top;if(t.inclusive||!r){var s=e.bottom>=i.bottom&&e.bottom<=i.top||i.bottom>=e.bottom&&i.bottom<=e.top,a=e.top>=i.bottom&&e.top<=i.top||i.top>e.bottom&&i.top<e.top,o=e.left>=i.left&&e.left<=i.right||i.left>=e.left&&i.left<=e.right,l=e.right>=i.left&&e.right<=i.right||i.right>=e.left&&i.right<=e.right;n=(s||a)&&(o||l)}if(t.worldBounds&&!n){var c=t.worldBounds,u=c.getWidth(),h=!c.containsBounds(i),p=!c.containsBounds(e);if(h&&!p){e=e.add(-u,0);n=i.intersectsBounds(e,{inclusive:t.inclusive})}else if(p&&!h){i=i.add(-u,0);n=e.intersectsBounds(i,{inclusive:t.inclusive})}}return n},containsBounds:function(e,t,i){null==t&&(t=!1);null==i&&(i=!0);var n=this.contains(e.left,e.bottom,i),r=this.contains(e.right,e.bottom,i),s=this.contains(e.left,e.top,i),a=this.contains(e.right,e.top,i);return t?n||r||s||a:n&&r&&s&&a},determineQuadrant:function(e){var t="",i=this.getCenterLonLat();t+=e.lat<i.lat?"b":"t";return t+=e.lon<i.lon?"l":"r"},transform:function(e,t){this.centerLonLat=null;var i=OpenLayers.Projection.transform({x:this.left,y:this.bottom},e,t),n=OpenLayers.Projection.transform({x:this.right,y:this.bottom},e,t),r=OpenLayers.Projection.transform({x:this.left,y:this.top},e,t),s=OpenLayers.Projection.transform({x:this.right,y:this.top},e,t);this.left=Math.min(i.x,r.x);this.bottom=Math.min(i.y,n.y);this.right=Math.max(n.x,s.x);this.top=Math.max(r.y,s.y);return this},wrapDateLine:function(e,t){var i=(t=t||{}).leftTolerance||0,n=t.rightTolerance||0,r=this.clone();if(e){for(var s=e.getWidth();r.left<e.left&&r.right-n<=e.left;)r=r.add(s,0);for(;r.left+i>=e.right&&r.right>e.right;)r=r.add(-s,0);var a=r.left+i;a<e.right&&a>e.left&&r.right-n>e.right&&(r=r.add(-s,0))}return r},CLASS_NAME:"OpenLayers.Bounds"});OpenLayers.Bounds.fromString=function(e,t){var i=e.split(",");return OpenLayers.Bounds.fromArray(i,t)};OpenLayers.Bounds.fromArray=function(e,t){return!0===t?new OpenLayers.Bounds(e[1],e[0],e[3],e[2]):new OpenLayers.Bounds(e[0],e[1],e[2],e[3])};OpenLayers.Bounds.fromSize=function(e){return new OpenLayers.Bounds(0,e.h,e.w,0)};OpenLayers.Bounds.oppositeQuadrant=function(e){var t="";t+="t"==e.charAt(0)?"b":"t";return t+="l"==e.charAt(1)?"r":"l"};OpenLayers.Element={visible:function(e){return"none"!=OpenLayers.Util.getElement(e).style.display},toggle:function(){for(var e=0,t=arguments.length;e<t;e++){var i=OpenLayers.Util.getElement(arguments[e]),n=OpenLayers.Element.visible(i)?"none":"";i.style.display=n}},remove:function(e){(e=OpenLayers.Util.getElement(e)).parentNode.removeChild(e)},getHeight:function(e){return(e=OpenLayers.Util.getElement(e)).offsetHeight},hasClass:function(e,t){var i=e.className;return!!i&&new RegExp("(^|\\s)"+t+"(\\s|$)").test(i)},addClass:function(e,t){OpenLayers.Element.hasClass(e,t)||(e.className+=(e.className?" ":"")+t);return e},removeClass:function(e,t){var i=e.className;i&&(e.className=OpenLayers.String.trim(i.replace(new RegExp("(^|\\s+)"+t+"(\\s+|$)")," ")));return e},toggleClass:function(e,t){OpenLayers.Element.hasClass(e,t)?OpenLayers.Element.removeClass(e,t):OpenLayers.Element.addClass(e,t);return e},getStyle:function(e,t){var i=null;if((e=OpenLayers.Util.getElement(e))&&e.style){if(!(i=e.style[OpenLayers.String.camelize(t)]))if(document.defaultView&&document.defaultView.getComputedStyle){var n=document.defaultView.getComputedStyle(e,null);i=n?n.getPropertyValue(t):null}else e.currentStyle&&(i=e.currentStyle[OpenLayers.String.camelize(t)]);window.opera&&-1!=OpenLayers.Util.indexOf(["left","top","right","bottom"],t)&&"static"==OpenLayers.Element.getStyle(e,"position")&&(i="auto")}return"auto"==i?null:i}};OpenLayers.LonLat=OpenLayers.Class({lon:0,lat:0,initialize:function(e,t){if(OpenLayers.Util.isArray(e)){t=e[1];e=e[0]}this.lon=OpenLayers.Util.toFloat(e);this.lat=OpenLayers.Util.toFloat(t)},toString:function(){return"lon="+this.lon+",lat="+this.lat},toShortString:function(){return this.lon+", "+this.lat},clone:function(){return new OpenLayers.LonLat(this.lon,this.lat)},add:function(e,t){if(null==e||null==t)throw new TypeError("LonLat.add cannot receive null values");return new OpenLayers.LonLat(this.lon+OpenLayers.Util.toFloat(e),this.lat+OpenLayers.Util.toFloat(t))},equals:function(e){var t=!1;null!=e&&(t=this.lon==e.lon&&this.lat==e.lat||isNaN(this.lon)&&isNaN(this.lat)&&isNaN(e.lon)&&isNaN(e.lat));return t},transform:function(e,t){var i=OpenLayers.Projection.transform({x:this.lon,y:this.lat},e,t);this.lon=i.x;this.lat=i.y;return this},wrapDateLine:function(e){var t=this.clone();if(e){for(;t.lon<e.left;)t.lon+=e.getWidth();for(;t.lon>e.right;)t.lon-=e.getWidth()}return t},CLASS_NAME:"OpenLayers.LonLat"});OpenLayers.LonLat.fromString=function(e){var t=e.split(",");return new OpenLayers.LonLat(t[0],t[1])};OpenLayers.LonLat.fromArray=function(e){var t=OpenLayers.Util.isArray(e),i=t&&e[0],n=t&&e[1];return new OpenLayers.LonLat(i,n)};OpenLayers.Pixel=OpenLayers.Class({x:0,y:0,initialize:function(e,t){this.x=parseFloat(e);this.y=parseFloat(t)},toString:function(){return"x="+this.x+",y="+this.y},clone:function(){return new OpenLayers.Pixel(this.x,this.y)},equals:function(e){var t=!1;null!=e&&(t=this.x==e.x&&this.y==e.y||isNaN(this.x)&&isNaN(this.y)&&isNaN(e.x)&&isNaN(e.y));return t},distanceTo:function(e){return Math.sqrt(Math.pow(this.x-e.x,2)+Math.pow(this.y-e.y,2))},add:function(e,t){if(null==e||null==t)throw new TypeError("Pixel.add cannot receive null values");return new OpenLayers.Pixel(this.x+e,this.y+t)},offset:function(e){var t=this.clone();e&&(t=this.add(e.x,e.y));return t},CLASS_NAME:"OpenLayers.Pixel"});OpenLayers.Size=OpenLayers.Class({w:0,h:0,initialize:function(e,t){this.w=parseFloat(e);this.h=parseFloat(t)},toString:function(){return"w="+this.w+",h="+this.h},clone:function(){return new OpenLayers.Size(this.w,this.h)},equals:function(e){var t=!1;null!=e&&(t=this.w==e.w&&this.h==e.h||isNaN(this.w)&&isNaN(this.h)&&isNaN(e.w)&&isNaN(e.h));return t},CLASS_NAME:"OpenLayers.Size"});OpenLayers.Console={log:function(){},debug:function(){},info:function(){},warn:function(){},error:function(){},userError:function(e){alert(e)},assert:function(){},dir:function(){},dirxml:function(){},trace:function(){},group:function(){},groupEnd:function(){},time:function(){},timeEnd:function(){},profile:function(){},profileEnd:function(){},count:function(){},CLASS_NAME:"OpenLayers.Console"};!function(){for(var e=document.getElementsByTagName("script"),t=0,i=e.length;t<i;++t)if(-1!=e[t].src.indexOf("firebug.js")&&console){OpenLayers.Util.extend(OpenLayers.Console,console);break}}();OpenLayers.Lang={code:null,defaultCode:"en",getCode:function(){OpenLayers.Lang.code||OpenLayers.Lang.setCode();return OpenLayers.Lang.code},setCode:function(e){var t;e||(e="msie"==OpenLayers.BROWSER_NAME?navigator.userLanguage:navigator.language);var i=e.split("-");i[0]=i[0].toLowerCase();"object"==typeof OpenLayers.Lang[i[0]]&&(t=i[0]);if(i[1]){var n=i[0]+"-"+i[1].toUpperCase();"object"==typeof OpenLayers.Lang[n]&&(t=n)}if(!t){OpenLayers.Console.warn("Failed to find OpenLayers.Lang."+i.join("-")+" dictionary, falling back to default language");t=OpenLayers.Lang.defaultCode}OpenLayers.Lang.code=t},translate:function(e,t){var i=OpenLayers.Lang[OpenLayers.Lang.getCode()],n=i&&i[e];n||(n=e);t&&(n=OpenLayers.String.format(n,t));return n}};OpenLayers.i18n=OpenLayers.Lang.translate;OpenLayers.Util=OpenLayers.Util||{};OpenLayers.Util.getElement=function(){for(var e=[],t=0,i=arguments.length;t<i;t++){var n=arguments[t];"string"==typeof n&&(n=document.getElementById(n));if(1==arguments.length)return n;e.push(n)}return e};OpenLayers.Util.isElement=function(e){return!(!e||1!==e.nodeType)};OpenLayers.Util.isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)};OpenLayers.Util.removeItem=function(e,t){for(var i=e.length-1;i>=0;i--)e[i]==t&&e.splice(i,1);return e};OpenLayers.Util.indexOf=function(e,t){if("function"==typeof e.indexOf)return e.indexOf(t);for(var i=0,n=e.length;i<n;i++)if(e[i]==t)return i;return-1};OpenLayers.Util.dotless=/\./g;OpenLayers.Util.modifyDOMElement=function(e,t,i,n,r,s,a,o){t&&(e.id=t.replace(OpenLayers.Util.dotless,"_"));if(i){e.style.left=i.x+"px";e.style.top=i.y+"px"}if(n){e.style.width=n.w+"px";e.style.height=n.h+"px"}r&&(e.style.position=r);s&&(e.style.border=s);a&&(e.style.overflow=a);if(parseFloat(o)>=0&&parseFloat(o)<1){e.style.filter="alpha(opacity="+100*o+")";e.style.opacity=o}else if(1==parseFloat(o)){e.style.filter="";e.style.opacity=""}};OpenLayers.Util.createDiv=function(e,t,i,n,r,s,a,o){var l=document.createElement("div");n&&(l.style.backgroundImage="url("+n+")");e||(e=OpenLayers.Util.createUniqueID("OpenLayersDiv"));r||(r="absolute");OpenLayers.Util.modifyDOMElement(l,e,t,i,r,s,a,o);return l};OpenLayers.Util.createImage=function(e,t,i,n,r,s,a,o){var l=document.createElement("img");e||(e=OpenLayers.Util.createUniqueID("OpenLayersDiv"));r||(r="relative");OpenLayers.Util.modifyDOMElement(l,e,t,i,r,s,null,a);if(o){l.style.display="none";function c(){l.style.display="";OpenLayers.Event.stopObservingElement(l)}OpenLayers.Event.observe(l,"load",c);OpenLayers.Event.observe(l,"error",c)}l.style.alt=e;l.galleryImg="no";n&&(l.src=n);return l};OpenLayers.IMAGE_RELOAD_ATTEMPTS=0;OpenLayers.Util.alphaHackNeeded=null;OpenLayers.Util.alphaHack=function(){if(null==OpenLayers.Util.alphaHackNeeded){var e=navigator.appVersion.split("MSIE"),t=parseFloat(e[1]),i=!1;try{i=!!document.body.filters}catch(e){}OpenLayers.Util.alphaHackNeeded=i&&t>=5.5&&t<7}return OpenLayers.Util.alphaHackNeeded};OpenLayers.Util.modifyAlphaImageDiv=function(e,t,i,n,r,s,a,o,l){OpenLayers.Util.modifyDOMElement(e,t,i,n,s,null,null,l);var c=e.childNodes[0];r&&(c.src=r);OpenLayers.Util.modifyDOMElement(c,e.id+"_innerImage",null,n,"relative",a);if(OpenLayers.Util.alphaHack()){"none"!=e.style.display&&(e.style.display="inline-block");null==o&&(o="scale");e.style.filter="progid:DXImageTransform.Microsoft.AlphaImageLoader(src='"+c.src+"', sizingMethod='"+o+"')";parseFloat(e.style.opacity)>=0&&parseFloat(e.style.opacity)<1&&(e.style.filter+=" alpha(opacity="+100*e.style.opacity+")");c.style.filter="alpha(opacity=0)"}};OpenLayers.Util.createAlphaImageDiv=function(e,t,i,n,r,s,a,o,l){var c=OpenLayers.Util.createDiv(),u=OpenLayers.Util.createImage(null,null,null,null,null,null,null,l);u.className="olAlphaImg";c.appendChild(u);OpenLayers.Util.modifyAlphaImageDiv(c,e,t,i,n,r,s,a,o);return c};OpenLayers.Util.upperCaseObject=function(e){var t={};for(var i in e)t[i.toUpperCase()]=e[i];return t};OpenLayers.Util.applyDefaults=function(e,t){e=e||{};var i="function"==typeof window.Event&&t instanceof window.Event;for(var n in t)(void 0===e[n]||!i&&t.hasOwnProperty&&t.hasOwnProperty(n)&&!e.hasOwnProperty(n))&&(e[n]=t[n]);!i&&t&&t.hasOwnProperty&&t.hasOwnProperty("toString")&&!e.hasOwnProperty("toString")&&(e.toString=t.toString);return e};OpenLayers.Util.getParameterString=function(e){var t=[];for(var i in e){var n=e[i];if(null!=n&&"function"!=typeof n){var r;if("object"==typeof n&&n.constructor==Array){for(var s,a=[],o=0,l=n.length;o<l;o++){s=n[o];a.push(encodeURIComponent(null===s||void 0===s?"":s))}r=a.join(",")}else r=encodeURIComponent(n);t.push(encodeURIComponent(i)+"="+r)}}return t.join("&")};OpenLayers.Util.urlAppend=function(e,t){var i=e;if(t){var n=(e+" ").split(/[?&]/);i+=" "===n.pop()?t:n.length?"&"+t:"?"+t}return i};OpenLayers.Util.getImagesLocation=function(){return OpenLayers.ImgPath||OpenLayers._getScriptLocation()+"img/"};OpenLayers.Util.getImageLocation=function(e){return OpenLayers.Util.getImagesLocation()+e};OpenLayers.Util.Try=function(){for(var e=null,t=0,i=arguments.length;t<i;t++){var n=arguments[t];try{e=n();break}catch(e){}}return e};OpenLayers.Util.getXmlNodeValue=function(e){var t=null;OpenLayers.Util.Try(function(){(t=e.text)||(t=e.textContent);t||(t=e.firstChild.nodeValue)},function(){t=e.textContent});return t};OpenLayers.Util.mouseLeft=function(e,t){for(var i=e.relatedTarget?e.relatedTarget:e.toElement;i!=t&&null!=i;)i=i.parentNode;return i!=t};OpenLayers.Util.DEFAULT_PRECISION=14;OpenLayers.Util.toFloat=function(e,t){null==t&&(t=OpenLayers.Util.DEFAULT_PRECISION);"number"!=typeof e&&(e=parseFloat(e));return 0===t?e:parseFloat(e.toPrecision(t))};OpenLayers.Util.rad=function(e){return e*Math.PI/180};OpenLayers.Util.deg=function(e){return 180*e/Math.PI};OpenLayers.Util.VincentyConstants={a:6378137,b:6356752.3142,f:1/298.257223563};OpenLayers.Util.distVincenty=function(e,t){for(var i=OpenLayers.Util.VincentyConstants,n=i.a,r=i.b,s=i.f,a=OpenLayers.Util.rad(t.lon-e.lon),o=Math.atan((1-s)*Math.tan(OpenLayers.Util.rad(e.lat))),l=Math.atan((1-s)*Math.tan(OpenLayers.Util.rad(t.lat))),c=Math.sin(o),u=Math.cos(o),h=Math.sin(l),p=Math.cos(l),d=a,f=2*Math.PI,m=20;Math.abs(d-f)>1e-12&&--m>0;){var y=Math.sin(d),g=Math.cos(d),C=Math.sqrt(p*y*(p*y)+(u*h-c*p*g)*(u*h-c*p*g));if(0==C)return 0;var v=c*h+u*p*g,T=Math.atan2(C,v),L=Math.asin(u*p*y/C),w=Math.cos(L)*Math.cos(L),b=v-2*c*h/w,S=s/16*w*(4+s*(4-3*w));f=d;d=a+(1-S)*s*Math.sin(L)*(T+S*C*(b+S*v*(2*b*b-1)))}if(0==m)return NaN;var E=w*(n*n-r*r)/(r*r),O=E/1024*(256+E*(E*(74-47*E)-128));return(r*(1+E/16384*(4096+E*(E*(320-175*E)-768)))*(T-O*C*(b+O/4*(v*(2*b*b-1)-O/6*b*(4*C*C-3)*(4*b*b-3))))).toFixed(3)/1e3};OpenLayers.Util.destinationVincenty=function(e,t,i){for(var n=OpenLayers.Util,r=n.VincentyConstants,s=r.a,a=r.b,o=r.f,l=e.lon,c=e.lat,u=i,h=n.rad(t),p=Math.sin(h),d=Math.cos(h),f=(1-o)*Math.tan(n.rad(c)),m=1/Math.sqrt(1+f*f),y=f*m,g=Math.atan2(f,d),C=m*p,v=1-C*C,T=v*(s*s-a*a)/(a*a),L=1+T/16384*(4096+T*(T*(320-175*T)-768)),w=T/1024*(256+T*(T*(74-47*T)-128)),b=u/(a*L),S=2*Math.PI;Math.abs(b-S)>1e-12;){var E=Math.cos(2*g+b),O=Math.sin(b),A=Math.cos(b);S=b;b=u/(a*L)+w*O*(E+w/4*(A*(2*E*E-1)-w/6*E*(4*O*O-3)*(4*E*E-3)))}var x=y*O-m*A*d,P=Math.atan2(y*A+m*O*d,(1-o)*Math.sqrt(C*C+x*x)),_=o/16*v*(4+o*(4-3*v)),N=Math.atan2(O*p,m*A-y*O*d)-(1-_)*o*C*(b+_*O*(E+_*A*(2*E*E-1)));Math.atan2(C,-x);return new OpenLayers.LonLat(l+n.deg(N),n.deg(P))};OpenLayers.Util.getParameters=function(e,t){t=t||{};e=null===e||void 0===e?window.location.href:e;var i="";if(OpenLayers.String.contains(e,"?")){var n=e.indexOf("?")+1,r=OpenLayers.String.contains(e,"#")?e.indexOf("#"):e.length;i=e.substring(n,r)}for(var s={},a=i.split(/[&;]/),o=0,l=a.length;o<l;++o){var c=a[o].split("=");if(c[0]){var u=c[0];try{u=decodeURIComponent(u)}catch(e){u=unescape(u)}var h=(c[1]||"").replace(/\+/g," ");try{h=decodeURIComponent(h)}catch(e){h=unescape(h)}!1!==t.splitArgs&&(h=h.split(","));1==h.length&&(h=h[0]);s[u]=h}}return s};OpenLayers.Util.lastSeqID=0;OpenLayers.Util.createUniqueID=function(e){e=null==e?"id_":e.replace(OpenLayers.Util.dotless,"_");OpenLayers.Util.lastSeqID+=1;return e+OpenLayers.Util.lastSeqID};OpenLayers.INCHES_PER_UNIT={inches:1,ft:12,mi:63360,m:39.37,km:39370,dd:4374754,yd:36};OpenLayers.INCHES_PER_UNIT.in=OpenLayers.INCHES_PER_UNIT.inches;OpenLayers.INCHES_PER_UNIT.degrees=OpenLayers.INCHES_PER_UNIT.dd;OpenLayers.INCHES_PER_UNIT.nmi=1852*OpenLayers.INCHES_PER_UNIT.m;OpenLayers.METERS_PER_INCH=.0254000508001016;OpenLayers.Util.extend(OpenLayers.INCHES_PER_UNIT,{Inch:OpenLayers.INCHES_PER_UNIT.inches,Meter:1/OpenLayers.METERS_PER_INCH,Foot:.3048006096012192/OpenLayers.METERS_PER_INCH,IFoot:.3048/OpenLayers.METERS_PER_INCH,ClarkeFoot:.3047972651151/OpenLayers.METERS_PER_INCH,SearsFoot:.30479947153867626/OpenLayers.METERS_PER_INCH,GoldCoastFoot:.3047997101815088/OpenLayers.METERS_PER_INCH,IInch:.0254/OpenLayers.METERS_PER_INCH,MicroInch:254e-7/OpenLayers.METERS_PER_INCH,Mil:2.54e-8/OpenLayers.METERS_PER_INCH,Centimeter:.01/OpenLayers.METERS_PER_INCH,Kilometer:1e3/OpenLayers.METERS_PER_INCH,Yard:.9144018288036576/OpenLayers.METERS_PER_INCH,SearsYard:.914398414616029/OpenLayers.METERS_PER_INCH,IndianYard:.9143985307444408/OpenLayers.METERS_PER_INCH,IndianYd37:.91439523/OpenLayers.METERS_PER_INCH,IndianYd62:.9143988/OpenLayers.METERS_PER_INCH,IndianYd75:.9143985/OpenLayers.METERS_PER_INCH,IndianFoot:.30479951/OpenLayers.METERS_PER_INCH,IndianFt37:.30479841/OpenLayers.METERS_PER_INCH,IndianFt62:.3047996/OpenLayers.METERS_PER_INCH,IndianFt75:.3047995/OpenLayers.METERS_PER_INCH,Mile:1609.3472186944373/OpenLayers.METERS_PER_INCH,IYard:.9144/OpenLayers.METERS_PER_INCH,IMile:1609.344/OpenLayers.METERS_PER_INCH,NautM:1852/OpenLayers.METERS_PER_INCH,"Lat-66":110943.31648893273/OpenLayers.METERS_PER_INCH,"Lat-83":110946.25736872235/OpenLayers.METERS_PER_INCH,Decimeter:.1/OpenLayers.METERS_PER_INCH,Millimeter:.001/OpenLayers.METERS_PER_INCH,Dekameter:10/OpenLayers.METERS_PER_INCH,Decameter:10/OpenLayers.METERS_PER_INCH,Hectometer:100/OpenLayers.METERS_PER_INCH,GermanMeter:1.0000135965/OpenLayers.METERS_PER_INCH,CaGrid:.999738/OpenLayers.METERS_PER_INCH,ClarkeChain:20.1166194976/OpenLayers.METERS_PER_INCH,GunterChain:20.11684023368047/OpenLayers.METERS_PER_INCH,BenoitChain:20.116782494375872/OpenLayers.METERS_PER_INCH,SearsChain:20.11676512155/OpenLayers.METERS_PER_INCH,ClarkeLink:.201166194976/OpenLayers.METERS_PER_INCH,GunterLink:.2011684023368047/OpenLayers.METERS_PER_INCH,BenoitLink:.20116782494375873/OpenLayers.METERS_PER_INCH,SearsLink:.2011676512155/OpenLayers.METERS_PER_INCH,Rod:5.02921005842012/OpenLayers.METERS_PER_INCH,IntnlChain:20.1168/OpenLayers.METERS_PER_INCH,IntnlLink:.201168/OpenLayers.METERS_PER_INCH,Perch:5.02921005842012/OpenLayers.METERS_PER_INCH,Pole:5.02921005842012/OpenLayers.METERS_PER_INCH,Furlong:201.1684023368046/OpenLayers.METERS_PER_INCH,Rood:3.778266898/OpenLayers.METERS_PER_INCH,CapeFoot:.3047972615/OpenLayers.METERS_PER_INCH,Brealey:375/OpenLayers.METERS_PER_INCH,ModAmFt:.304812252984506/OpenLayers.METERS_PER_INCH,Fathom:1.8288/OpenLayers.METERS_PER_INCH,"NautM-UK":1853.184/OpenLayers.METERS_PER_INCH,"50kilometers":5e4/OpenLayers.METERS_PER_INCH,"150kilometers":15e4/OpenLayers.METERS_PER_INCH});OpenLayers.Util.extend(OpenLayers.INCHES_PER_UNIT,{mm:OpenLayers.INCHES_PER_UNIT.Meter/1e3,cm:OpenLayers.INCHES_PER_UNIT.Meter/100,dm:100*OpenLayers.INCHES_PER_UNIT.Meter,km:1e3*OpenLayers.INCHES_PER_UNIT.Meter,kmi:OpenLayers.INCHES_PER_UNIT.nmi,fath:OpenLayers.INCHES_PER_UNIT.Fathom,ch:OpenLayers.INCHES_PER_UNIT.IntnlChain,link:OpenLayers.INCHES_PER_UNIT.IntnlLink,"us-in":OpenLayers.INCHES_PER_UNIT.inches,"us-ft":OpenLayers.INCHES_PER_UNIT.Foot,"us-yd":OpenLayers.INCHES_PER_UNIT.Yard,"us-ch":OpenLayers.INCHES_PER_UNIT.GunterChain,"us-mi":OpenLayers.INCHES_PER_UNIT.Mile,"ind-yd":OpenLayers.INCHES_PER_UNIT.IndianYd37,"ind-ft":OpenLayers.INCHES_PER_UNIT.IndianFt37,"ind-ch":20.11669506/OpenLayers.METERS_PER_INCH});OpenLayers.DOTS_PER_INCH=72;OpenLayers.Util.normalizeScale=function(e){return e>1?1/e:e};OpenLayers.Util.getResolutionFromScale=function(e,t){var i;if(e){null==t&&(t="degrees");i=1/(OpenLayers.Util.normalizeScale(e)*OpenLayers.INCHES_PER_UNIT[t]*OpenLayers.DOTS_PER_INCH)}return i};OpenLayers.Util.getScaleFromResolution=function(e,t){null==t&&(t="degrees");return e*OpenLayers.INCHES_PER_UNIT[t]*OpenLayers.DOTS_PER_INCH};OpenLayers.Util.pagePosition=function(e){var t=[0,0],i=OpenLayers.Util.getViewportElement();if(!e||e==window||e==i)return t;var n,r=OpenLayers.IS_GECKO&&document.getBoxObjectFor&&"absolute"==OpenLayers.Element.getStyle(e,"position")&&(""==e.style.top||""==e.style.left),s=null;if(e.getBoundingClientRect){n=e.getBoundingClientRect();var a=window.pageYOffset||i.scrollTop,o=window.pageXOffset||i.scrollLeft;t[0]=n.left+o;t[1]=n.top+a}else if(document.getBoxObjectFor&&!r){n=document.getBoxObjectFor(e);var l=document.getBoxObjectFor(i);t[0]=n.screenX-l.screenX;t[1]=n.screenY-l.screenY}else{t[0]=e.offsetLeft;t[1]=e.offsetTop;if((s=e.offsetParent)!=e)for(;s;){t[0]+=s.offsetLeft;t[1]+=s.offsetTop;s=s.offsetParent}var c=OpenLayers.BROWSER_NAME;("opera"==c||"safari"==c&&"absolute"==OpenLayers.Element.getStyle(e,"position"))&&(t[1]-=document.body.offsetTop);s=e.offsetParent;for(;s&&s!=document.body;){t[0]-=s.scrollLeft;"opera"==c&&"TR"==s.tagName||(t[1]-=s.scrollTop);s=s.offsetParent}}return t};OpenLayers.Util.getViewportElement=function(){var e=arguments.callee.viewportElement;if(void 0==e){e="msie"==OpenLayers.BROWSER_NAME&&"CSS1Compat"!=document.compatMode?document.body:document.documentElement;arguments.callee.viewportElement=e}return e};OpenLayers.Util.isEquivalentUrl=function(e,t,i){i=i||{};OpenLayers.Util.applyDefaults(i,{ignoreCase:!0,ignorePort80:!0,ignoreHash:!0,splitArgs:!1});var n=OpenLayers.Util.createUrlObject(e,i),r=OpenLayers.Util.createUrlObject(t,i);for(var s in n)if("args"!==s&&n[s]!=r[s])return!1;for(var s in n.args){if(n.args[s]!=r.args[s])return!1;delete r.args[s]}for(var s in r.args)return!1;return!0};OpenLayers.Util.createUrlObject=function(e,t){t=t||{};if(!/^\w+:\/\//.test(e)){var i=window.location,n=i.port?":"+i.port:"",r=i.protocol+"//"+i.host.split(":").shift()+n;if(0===e.indexOf("/"))e=r+e;else{var s=i.pathname.split("/");s.pop();e=r+s.join("/")+"/"+e}}t.ignoreCase&&(e=e.toLowerCase());var a=document.createElement("a");a.href=e;var o={};o.host=a.host.split(":").shift();o.protocol=a.protocol;t.ignorePort80?o.port="80"==a.port||"0"==a.port?"":a.port:o.port=""==a.port||"0"==a.port?"80":a.port;o.hash=t.ignoreHash||"#"===a.hash?"":a.hash;var l=a.search;if(!l){var c=e.indexOf("?");l=-1!=c?e.substr(c):""}o.args=OpenLayers.Util.getParameters(l,{splitArgs:t.splitArgs});o.pathname="/"==a.pathname.charAt(0)?a.pathname:"/"+a.pathname;return o};OpenLayers.Util.removeTail=function(e){var t=e.indexOf("?"),i=e.indexOf("#");return-1==t?-1!=i?e.substr(0,i):e:-1!=i?e.substr(0,Math.min(t,i)):e.substr(0,t)};OpenLayers.IS_GECKO=function(){var e=navigator.userAgent.toLowerCase();return-1==e.indexOf("webkit")&&-1!=e.indexOf("gecko")}();OpenLayers.CANVAS_SUPPORTED=function(){var e=document.createElement("canvas");return!(!e.getContext||!e.getContext("2d"))}();OpenLayers.BROWSER_NAME=function(){var e="",t=navigator.userAgent.toLowerCase();-1!=t.indexOf("opera")?e="opera":-1!=t.indexOf("msie")?e="msie":-1!=t.indexOf("safari")?e="safari":-1!=t.indexOf("mozilla")&&(e=-1!=t.indexOf("firefox")?"firefox":"mozilla");return e}();OpenLayers.Util.getBrowserName=function(){return OpenLayers.BROWSER_NAME};OpenLayers.Util.getRenderedDimensions=function(e,t,i){var n,r,s=document.createElement("div");s.style.visibility="hidden";for(var a=i&&i.containerElement?i.containerElement:document.body,o=!1,l=null,c=a;c&&"body"!=c.tagName.toLowerCase();){var u=OpenLayers.Element.getStyle(c,"position");if("absolute"==u){o=!0;break}if(u&&"static"!=u)break;c=c.parentNode}if(o&&(0===a.clientHeight||0===a.clientWidth)){(l=document.createElement("div")).style.visibility="hidden";l.style.position="absolute";l.style.overflow="visible";l.style.width=document.body.clientWidth+"px";l.style.height=document.body.clientHeight+"px";l.appendChild(s)}s.style.position="absolute";if(t)if(t.w){n=t.w;s.style.width=n+"px"}else if(t.h){r=t.h;s.style.height=r+"px"}i&&i.displayClass&&(s.className=i.displayClass);var h=document.createElement("div");h.innerHTML=e;h.style.overflow="visible";if(h.childNodes)for(var p=0,d=h.childNodes.length;p<d;p++)h.childNodes[p].style&&(h.childNodes[p].style.overflow="visible");s.appendChild(h);l?a.appendChild(l):a.appendChild(s);if(!n){n=parseInt(h.scrollWidth);s.style.width=n+"px"}r||(r=parseInt(h.scrollHeight));s.removeChild(h);if(l){l.removeChild(s);a.removeChild(l)}else a.removeChild(s);return new OpenLayers.Size(n,r)};OpenLayers.Util.getScrollbarWidth=function(){var e=OpenLayers.Util._scrollbarWidth;if(null==e){var t,i,n=null,r=null;(n=document.createElement("div")).style.position="absolute";n.style.top="-1000px";n.style.left="-1000px";n.style.width="100px";n.style.height="50px";n.style.overflow="hidden";(r=document.createElement("div")).style.width="100%";r.style.height="200px";n.appendChild(r);document.body.appendChild(n);t=r.offsetWidth;n.style.overflow="scroll";i=r.offsetWidth;document.body.removeChild(document.body.lastChild);OpenLayers.Util._scrollbarWidth=t-i;e=OpenLayers.Util._scrollbarWidth}return e};OpenLayers.Util.getFormattedLonLat=function(e,t,i){i||(i="dms");e=(e+540)%360-180;var n=Math.abs(e),r=Math.floor(n),s=(n-r)/(1/60),a=(s-(s=Math.floor(s)))/(1/60);a=Math.round(10*a);if((a/=10)>=60){a-=60;if((s+=1)>=60){s-=60;r+=1}}r<10&&(r="0"+r);var o=r+"\xb0";if(i.indexOf("dm")>=0){s<10&&(s="0"+s);o+=s+"'";if(i.indexOf("dms")>=0){a<10&&(a="0"+a);o+=a+'"'}}return o+="lon"==t?e<0?OpenLayers.i18n("W"):OpenLayers.i18n("E"):e<0?OpenLayers.i18n("S"):OpenLayers.i18n("N")};OpenLayers.Util=OpenLayers.Util||{};OpenLayers.Util.vendorPrefix=function(){"use strict";var e=["","O","ms","Moz","Webkit"],t=document.createElement("div").style,i={},n={};function r(t,i){if(void 0===n[i]){var r,s,a=0,o=e.length,l=void 0!==t.cssText;n[i]=null;for(;a<o;a++){if(s=e[a]){l||(s=s.toLowerCase());r=s+i.charAt(0).toUpperCase()+i.slice(1)}else r=i;if(void 0!==t[r]){n[i]=r;break}}}return n[i]}function s(e){return r(t,e)}return{css:function(e){if(void 0===i[e]){var t=s(e.replace(/(-[\s\S])/g,function(e){return e.charAt(1).toUpperCase()}));i[e]=function(e){return e?e.replace(/([A-Z])/g,function(e){return"-"+e.toLowerCase()}).replace(/^ms-/,"-ms-"):null}(t)}return i[e]},js:r,style:s,cssCache:i,jsCache:n}}();OpenLayers.Event={observers:!1,KEY_SPACE:32,KEY_BACKSPACE:8,KEY_TAB:9,KEY_RETURN:13,KEY_ESC:27,KEY_LEFT:37,KEY_UP:38,KEY_RIGHT:39,KEY_DOWN:40,KEY_DELETE:46,element:function(e){return e.target||e.srcElement},isSingleTouch:function(e){return e.touches&&1==e.touches.length},isMultiTouch:function(e){return e.touches&&e.touches.length>1},isLeftClick:function(e){return e.which&&1==e.which||e.button&&1==e.button},isRightClick:function(e){return e.which&&3==e.which||e.button&&2==e.button},stop:function(e,t){t||OpenLayers.Event.preventDefault(e);e.stopPropagation?e.stopPropagation():e.cancelBubble=!0},preventDefault:function(e){e.preventDefault?e.preventDefault():e.returnValue=!1},findElement:function(e,t){for(var i=OpenLayers.Event.element(e);i.parentNode&&(!i.tagName||i.tagName.toUpperCase()!=t.toUpperCase());)i=i.parentNode;return i},observe:function(e,t,i,n){var r=OpenLayers.Util.getElement(e);n=n||!1;"keypress"==t&&(navigator.appVersion.match(/Konqueror|Safari|KHTML/)||r.attachEvent)&&(t="keydown");this.observers||(this.observers={});if(!r._eventCacheID){var s="eventCacheID_";r.id&&(s=r.id+"_"+s);r._eventCacheID=OpenLayers.Util.createUniqueID(s)}var a=r._eventCacheID;this.observers[a]||(this.observers[a]=[]);this.observers[a].push({element:r,name:t,observer:i,useCapture:n});r.addEventListener?r.addEventListener(t,i,n):r.attachEvent&&r.attachEvent("on"+t,i)},stopObservingElement:function(e){var t=OpenLayers.Util.getElement(e)._eventCacheID;this._removeElementObservers(OpenLayers.Event.observers[t])},_removeElementObservers:function(e){if(e)for(var t=e.length-1;t>=0;t--){var i=e[t];OpenLayers.Event.stopObserving.apply(this,[i.element,i.name,i.observer,i.useCapture])}},stopObserving:function(e,t,i,n){n=n||!1;var r=OpenLayers.Util.getElement(e),s=r._eventCacheID;"keypress"==t&&(navigator.appVersion.match(/Konqueror|Safari|KHTML/)||r.detachEvent)&&(t="keydown");var a=!1,o=OpenLayers.Event.observers[s];if(o)for(var l=0;!a&&l<o.length;){var c=o[l];if(c.name==t&&c.observer==i&&c.useCapture==n){o.splice(l,1);0==o.length&&delete OpenLayers.Event.observers[s];a=!0;break}l++}a&&(r.removeEventListener?r.removeEventListener(t,i,n):r&&r.detachEvent&&r.detachEvent("on"+t,i));return a},unloadCache:function(){if(OpenLayers.Event&&OpenLayers.Event.observers){for(var e in OpenLayers.Event.observers){var t=OpenLayers.Event.observers[e];OpenLayers.Event._removeElementObservers.apply(this,[t])}OpenLayers.Event.observers=!1}},CLASS_NAME:"OpenLayers.Event"};OpenLayers.Event.observe(window,"unload",OpenLayers.Event.unloadCache,!1);OpenLayers.Events=OpenLayers.Class({BROWSER_EVENTS:["mouseover","mouseout","mousedown","mouseup","mousemove","click","dblclick","rightclick","dblrightclick","resize","focus","blur","touchstart","touchmove","touchend","keydown"],listeners:null,object:null,element:null,eventHandler:null,fallThrough:null,includeXY:!1,extensions:null,extensionCount:null,clearMouseListener:null,initialize:function(e,t,i,n,r){OpenLayers.Util.extend(this,r);this.object=e;this.fallThrough=n;this.listeners={};this.extensions={};this.extensionCount={};this._msTouches=[];null!=t&&this.attachToElement(t)},destroy:function(){for(var e in this.extensions)"boolean"!=typeof this.extensions[e]&&this.extensions[e].destroy();this.extensions=null;if(this.element){OpenLayers.Event.stopObservingElement(this.element);this.element.hasScrollEvent&&OpenLayers.Event.stopObserving(window,"scroll",this.clearMouseListener)}this.element=null;this.listeners=null;this.object=null;this.fallThrough=null;this.eventHandler=null},addEventType:function(e){},attachToElement:function(e){if(this.element)OpenLayers.Event.stopObservingElement(this.element);else{this.eventHandler=OpenLayers.Function.bindAsEventListener(this.handleBrowserEvent,this);this.clearMouseListener=OpenLayers.Function.bind(this.clearMouseCache,this)}this.element=e;for(var t,i=!!window.navigator.msMaxTouchPoints,n=0,r=this.BROWSER_EVENTS.length;n<r;n++){t=this.BROWSER_EVENTS[n];OpenLayers.Event.observe(e,t,this.eventHandler);i&&0===t.indexOf("touch")&&this.addMsTouchListener(e,t,this.eventHandler)}OpenLayers.Event.observe(e,"dragstart",OpenLayers.Event.stop)},on:function(e){for(var t in e)"scope"!=t&&e.hasOwnProperty(t)&&this.register(t,e.scope,e[t])},register:function(e,t,i,n){e in OpenLayers.Events&&!this.extensions[e]&&(this.extensions[e]=new OpenLayers.Events[e](this));if(null!=i){null==t&&(t=this.object);var r=this.listeners[e];if(!r){r=[];this.listeners[e]=r;this.extensionCount[e]=0}var s={obj:t,func:i};if(n){r.splice(this.extensionCount[e],0,s);"object"==typeof n&&n.extension&&this.extensionCount[e]++}else r.push(s)}},registerPriority:function(e,t,i){this.register(e,t,i,!0)},un:function(e){for(var t in e)"scope"!=t&&e.hasOwnProperty(t)&&this.unregister(t,e.scope,e[t])},unregister:function(e,t,i){null==t&&(t=this.object);var n=this.listeners[e];if(null!=n)for(var r=0,s=n.length;r<s;r++)if(n[r].obj==t&&n[r].func==i){n.splice(r,1);break}},remove:function(e){null!=this.listeners[e]&&(this.listeners[e]=[])},triggerEvent:function(e,t){var i=this.listeners[e];if(i&&0!=i.length){null==t&&(t={});t.object=this.object;t.element=this.element;t.type||(t.type=e);for(var n,r=0,s=(i=i.slice()).length;r<s;r++){var a=i[r];if(void 0!=(n=a.func.apply(a.obj,[t]))&&0==n)break}this.fallThrough||OpenLayers.Event.stop(t,!0);return n}},handleBrowserEvent:function(e){var t=e.type,i=this.listeners[t];if(i&&0!=i.length){var n=e.touches;if(n&&n[0]){for(var r,s=0,a=0,o=n.length,l=0;l<o;++l){s+=(r=this.getTouchClientXY(n[l])).clientX;a+=r.clientY}e.clientX=s/o;e.clientY=a/o}this.includeXY&&(e.xy=this.getMousePosition(e));this.triggerEvent(t,e)}},getTouchClientXY:function(e){var t=window.olMockWin||window,i=t.pageXOffset,n=t.pageYOffset,r=e.clientX,s=e.clientY;if(0===e.pageY&&Math.floor(s)>Math.floor(e.pageY)||0===e.pageX&&Math.floor(r)>Math.floor(e.pageX)){r-=i;s-=n}else if(s<e.pageY-n||r<e.pageX-i){r=e.pageX-i;s=e.pageY-n}e.olClientX=r;e.olClientY=s;return{clientX:r,clientY:s}},clearMouseCache:function(){this.element.scrolls=null;this.element.lefttop=null;this.element.offsets=null},getMousePosition:function(e){if(this.includeXY){if(!this.element.hasScrollEvent){OpenLayers.Event.observe(window,"scroll",this.clearMouseListener);this.element.hasScrollEvent=!0}}else this.clearMouseCache();if(!this.element.scrolls){var t=OpenLayers.Util.getViewportElement();this.element.scrolls=[window.pageXOffset||t.scrollLeft,window.pageYOffset||t.scrollTop]}this.element.lefttop||(this.element.lefttop=[document.documentElement.clientLeft||0,document.documentElement.clientTop||0]);this.element.offsets||(this.element.offsets=OpenLayers.Util.pagePosition(this.element));return new OpenLayers.Pixel(e.clientX+this.element.scrolls[0]-this.element.offsets[0]-this.element.lefttop[0],e.clientY+this.element.scrolls[1]-this.element.offsets[1]-this.element.lefttop[1])},addMsTouchListener:function(e,t,i){this.eventHandler;var n=this._msTouches;function r(e){i(OpenLayers.Util.applyDefaults({stopPropagation:function(){for(var e=n.length-1;e>=0;--e)n[e].stopPropagation()},preventDefault:function(){for(var e=n.length-1;e>=0;--e)n[e].preventDefault()},type:t},e))}switch(t){case"touchstart":return this.addMsTouchListenerStart(e,t,r);case"touchend":return this.addMsTouchListenerEnd(e,t,r);case"touchmove":return this.addMsTouchListenerMove(e,t,r);default:throw"Unknown touch event type"}},addMsTouchListenerStart:function(e,t,i){var n=this._msTouches;OpenLayers.Event.observe(e,"MSPointerDown",function(e){for(var t=!1,r=0,s=n.length;r<s;++r)if(n[r].pointerId==e.pointerId){t=!0;break}t||n.push(e);e.touches=n.slice();i(e)});OpenLayers.Event.observe(e,"MSPointerUp",function(e){for(var t=0,i=n.length;t<i;++t)if(n[t].pointerId==e.pointerId){n.splice(t,1);break}})},addMsTouchListenerMove:function(e,t,i){var n=this._msTouches;OpenLayers.Event.observe(e,"MSPointerMove",function(e){if(!(e.pointerType==e.MSPOINTER_TYPE_MOUSE&&0==e.buttons||1==n.length&&n[0].pageX==e.pageX&&n[0].pageY==e.pageY)){for(var t=0,r=n.length;t<r;++t)if(n[t].pointerId==e.pointerId){n[t]=e;break}e.touches=n.slice();i(e)}})},addMsTouchListenerEnd:function(e,t,i){var n=this._msTouches;OpenLayers.Event.observe(e,"MSPointerUp",function(e){for(var t=0,r=n.length;t<r;++t)if(n[t].pointerId==e.pointerId){n.splice(t,1);break}e.touches=n.slice();i(e)})},CLASS_NAME:"OpenLayers.Events"});OpenLayers.Animation=function(e){var t,i=OpenLayers.Util.vendorPrefix.js(e,"requestAnimationFrame"),n=!!i,r=(t=e[i]||function(t,i){e.setTimeout(t,16)},function(i,n){t.apply(e,[i,n])}),s=0,a={};return{isNative:n,requestFrame:r,start:function(e,t,i){t=t>0?t:Number.POSITIVE_INFINITY;var n=++s,o=+new Date;a[n]=function(){if(a[n]&&+new Date-o<=t){e();a[n]&&r(a[n],i)}else delete a[n]};r(a[n],i);return n},stop:function(e){delete a[e]}}}(window);OpenLayers.Tween=OpenLayers.Class({easing:null,begin:null,finish:null,duration:null,callbacks:null,time:null,minFrameRate:null,startTime:null,animationId:null,playing:!1,initialize:function(e){this.easing=e||OpenLayers.Easing.Expo.easeOut},start:function(e,t,i,n){this.playing=!0;this.begin=e;this.finish=t;this.duration=i;this.callbacks=n.callbacks;this.minFrameRate=n.minFrameRate||30;this.time=0;this.startTime=(new Date).getTime();OpenLayers.Animation.stop(this.animationId);this.animationId=null;this.callbacks&&this.callbacks.start&&this.callbacks.start.call(this,this.begin);this.animationId=OpenLayers.Animation.start(OpenLayers.Function.bind(this.play,this))},stop:function(){if(this.playing){this.callbacks&&this.callbacks.done&&this.callbacks.done.call(this,this.finish);OpenLayers.Animation.stop(this.animationId);this.animationId=null;this.playing=!1}},play:function(){var e={};for(var t in this.begin){var i=this.begin[t],n=this.finish[t];if(null==i||null==n||isNaN(i)||isNaN(n))throw new TypeError("invalid value for Tween");var r=n-i;e[t]=this.easing.apply(this,[this.time,i,r,this.duration])}this.time++;this.callbacks&&this.callbacks.eachStep&&((new Date).getTime()-this.startTime)/this.time<=1e3/this.minFrameRate&&this.callbacks.eachStep.call(this,e);this.time>this.duration&&this.stop()},CLASS_NAME:"OpenLayers.Tween"});OpenLayers.Easing={CLASS_NAME:"OpenLayers.Easing"};OpenLayers.Easing.Linear={easeIn:function(e,t,i,n){return i*e/n+t},easeOut:function(e,t,i,n){return i*e/n+t},easeInOut:function(e,t,i,n){return i*e/n+t},CLASS_NAME:"OpenLayers.Easing.Linear"};OpenLayers.Easing.Expo={easeIn:function(e,t,i,n){return 0==e?t:i*Math.pow(2,10*(e/n-1))+t},easeOut:function(e,t,i,n){return e==n?t+i:i*(1-Math.pow(2,-10*e/n))+t},easeInOut:function(e,t,i,n){return 0==e?t:e==n?t+i:(e/=n/2)<1?i/2*Math.pow(2,10*(e-1))+t:i/2*(2-Math.pow(2,-10*--e))+t},CLASS_NAME:"OpenLayers.Easing.Expo"};OpenLayers.Easing.Quad={easeIn:function(e,t,i,n){return i*(e/=n)*e+t},easeOut:function(e,t,i,n){return-i*(e/=n)*(e-2)+t},easeInOut:function(e,t,i,n){return(e/=n/2)<1?i/2*e*e+t:-i/2*(--e*(e-2)-1)+t},CLASS_NAME:"OpenLayers.Easing.Quad"};OpenLayers.Projection=OpenLayers.Class({proj:null,projCode:null,titleRegEx:/\+title=[^\+]*/,initialize:function(e,t){OpenLayers.Util.extend(this,t);this.projCode=e;"object"==typeof Proj4js&&(this.proj=new Proj4js.Proj(e))},getCode:function(){return this.proj?this.proj.srsCode:this.projCode},getUnits:function(){return this.proj?this.proj.units:null},toString:function(){return this.getCode()},equals:function(e){var t=e,i=!1;if(t){t instanceof OpenLayers.Projection||(t=new OpenLayers.Projection(t));if("object"==typeof Proj4js&&this.proj.defData&&t.proj.defData)i=this.proj.defData.replace(this.titleRegEx,"")==t.proj.defData.replace(this.titleRegEx,"");else if(t.getCode){var n=this.getCode(),r=t.getCode();i=n==r||!!OpenLayers.Projection.transforms[n]&&OpenLayers.Projection.transforms[n][r]===OpenLayers.Projection.nullTransform}}return i},destroy:function(){delete this.proj;delete this.projCode},CLASS_NAME:"OpenLayers.Projection"});OpenLayers.Projection.transforms={};OpenLayers.Projection.defaults={"EPSG:4326":{units:"degrees",maxExtent:[-180,-90,180,90],yx:!0},"CRS:84":{units:"degrees",maxExtent:[-180,-90,180,90]},"EPSG:900913":{units:"m",maxExtent:[-20037508.34,-20037508.34,20037508.34,20037508.34]}};OpenLayers.Projection.addTransform=function(e,t,i){if(i===OpenLayers.Projection.nullTransform){var n=OpenLayers.Projection.defaults[e];n&&!OpenLayers.Projection.defaults[t]&&(OpenLayers.Projection.defaults[t]=n)}OpenLayers.Projection.transforms[e]||(OpenLayers.Projection.transforms[e]={});OpenLayers.Projection.transforms[e][t]=i};OpenLayers.Projection.transform=function(e,t,i){if(t&&i){t instanceof OpenLayers.Projection||(t=new OpenLayers.Projection(t));i instanceof OpenLayers.Projection||(i=new OpenLayers.Projection(i));if(t.proj&&i.proj)e=Proj4js.transform(t.proj,i.proj,e);else{var n=t.getCode(),r=i.getCode(),s=OpenLayers.Projection.transforms;s[n]&&s[n][r]&&s[n][r](e)}}return e};OpenLayers.Projection.nullTransform=function(e){return e};!function(){var e=20037508.34;function t(t){t.x=180*t.x/e;t.y=180/Math.PI*(2*Math.atan(Math.exp(t.y/e*Math.PI))-Math.PI/2);return t}function i(t){t.x=t.x*e/180;var i=Math.log(Math.tan((90+t.y)*Math.PI/360))/Math.PI*e;t.y=Math.max(-20037508.34,Math.min(i,20037508.34));return t}function n(e,n){var r,s,a,o,l,c=OpenLayers.Projection.addTransform,u=OpenLayers.Projection.nullTransform;for(r=0,s=n.length;r<s;++r){c(e,a=n[r],i);c(a,e,t);for(l=r+1;l<s;++l){c(a,o=n[l],u);c(o,a,u)}}}var r,s=["EPSG:900913","EPSG:3857","EPSG:102113","EPSG:102100"],a=["CRS:84","urn:ogc:def:crs:EPSG:6.6:4326","EPSG:4326"];for(r=s.length-1;r>=0;--r)n(s[r],a);for(r=a.length-1;r>=0;--r)n(a[r],s)}();OpenLayers.Map=OpenLayers.Class({Z_INDEX_BASE:{BaseLayer:100,Overlay:325,Feature:725,Popup:750,Control:1e3},id:null,fractionalZoom:!1,events:null,allOverlays:!1,div:null,dragging:!1,size:null,viewPortDiv:null,layerContainerOrigin:null,layerContainerDiv:null,layers:null,controls:null,popups:null,baseLayer:null,center:null,resolution:null,zoom:0,panRatio:1.5,options:null,tileSize:null,projection:"EPSG:4326",units:null,resolutions:null,maxResolution:null,minResolution:null,maxScale:null,minScale:null,maxExtent:null,minExtent:null,restrictedExtent:null,numZoomLevels:16,theme:null,displayProjection:null,fallThrough:!1,autoUpdateSize:!0,eventListeners:null,panTween:null,panMethod:OpenLayers.Easing.Expo.easeOut,panDuration:50,zoomTween:null,zoomMethod:OpenLayers.Easing.Quad.easeOut,zoomDuration:20,paddingForPopups:null,layerContainerOriginPx:null,minPx:null,maxPx:null,initialize:function(e,t){1===arguments.length&&"object"==typeof e&&(e=(t=e)&&t.div);this.tileSize=new OpenLayers.Size(OpenLayers.Map.TILE_WIDTH,OpenLayers.Map.TILE_HEIGHT);this.paddingForPopups=new OpenLayers.Bounds(15,15,15,15);this.theme=OpenLayers._getScriptLocation()+"theme/default/style.css";this.options=OpenLayers.Util.extend({},t);OpenLayers.Util.extend(this,t);var i=this.projection instanceof OpenLayers.Projection?this.projection.projCode:this.projection;OpenLayers.Util.applyDefaults(this,OpenLayers.Projection.defaults[i]);!this.maxExtent||this.maxExtent instanceof OpenLayers.Bounds||(this.maxExtent=new OpenLayers.Bounds(this.maxExtent));!this.minExtent||this.minExtent instanceof OpenLayers.Bounds||(this.minExtent=new OpenLayers.Bounds(this.minExtent));!this.restrictedExtent||this.restrictedExtent instanceof OpenLayers.Bounds||(this.restrictedExtent=new OpenLayers.Bounds(this.restrictedExtent));!this.center||this.center instanceof OpenLayers.LonLat||(this.center=new OpenLayers.LonLat(this.center));this.layers=[];this.id=OpenLayers.Util.createUniqueID("OpenLayers.Map_");this.div=OpenLayers.Util.getElement(e);if(!this.div){this.div=document.createElement("div");this.div.style.height="1px";this.div.style.width="1px"}OpenLayers.Element.addClass(this.div,"olMap");var n=this.id+"_OpenLayers_ViewPort";this.viewPortDiv=OpenLayers.Util.createDiv(n,null,null,null,"relative",null,"hidden");this.viewPortDiv.style.width="100%";this.viewPortDiv.style.height="100%";this.viewPortDiv.className="olMapViewport";this.div.appendChild(this.viewPortDiv);this.events=new OpenLayers.Events(this,this.viewPortDiv,null,this.fallThrough,{includeXY:!0});if(OpenLayers.TileManager&&null!==this.tileManager){this.tileManager instanceof OpenLayers.TileManager||(this.tileManager=new OpenLayers.TileManager(this.tileManager));this.tileManager.addMap(this)}n=this.id+"_OpenLayers_Container";this.layerContainerDiv=OpenLayers.Util.createDiv(n);this.layerContainerDiv.style.zIndex=this.Z_INDEX_BASE.Popup-1;this.layerContainerOriginPx={x:0,y:0};this.applyTransform();this.viewPortDiv.appendChild(this.layerContainerDiv);this.updateSize();this.eventListeners instanceof Object&&this.events.on(this.eventListeners);if(!0===this.autoUpdateSize){this.updateSizeDestroy=OpenLayers.Function.bind(this.updateSize,this);OpenLayers.Event.observe(window,"resize",this.updateSizeDestroy)}if(this.theme){for(var r=!0,s=document.getElementsByTagName("link"),a=0,o=s.length;a<o;++a)if(OpenLayers.Util.isEquivalentUrl(s.item(a).href,this.theme)){r=!1;break}if(r){var l=document.createElement("link");l.setAttribute("rel","stylesheet");l.setAttribute("type","text/css");l.setAttribute("href",this.theme);document.getElementsByTagName("head")[0].appendChild(l)}}if(null==this.controls){this.controls=[];if(null!=OpenLayers.Control){OpenLayers.Control.Navigation?this.controls.push(new OpenLayers.Control.Navigation):OpenLayers.Control.TouchNavigation&&this.controls.push(new OpenLayers.Control.TouchNavigation);OpenLayers.Control.Zoom?this.controls.push(new OpenLayers.Control.Zoom):OpenLayers.Control.PanZoom&&this.controls.push(new OpenLayers.Control.PanZoom);OpenLayers.Control.ArgParser&&this.controls.push(new OpenLayers.Control.ArgParser);OpenLayers.Control.Attribution&&this.controls.push(new OpenLayers.Control.Attribution)}}for(a=0,o=this.controls.length;a<o;a++)this.addControlToMap(this.controls[a]);this.popups=[];this.unloadDestroy=OpenLayers.Function.bind(this.destroy,this);OpenLayers.Event.observe(window,"unload",this.unloadDestroy);if(t&&t.layers){delete this.center;delete this.zoom;this.addLayers(t.layers);t.center&&!this.getCenter()&&this.setCenter(t.center,t.zoom)}this.panMethod&&(this.panTween=new OpenLayers.Tween(this.panMethod));this.zoomMethod&&this.applyTransform.transform&&(this.zoomTween=new OpenLayers.Tween(this.zoomMethod))},getViewport:function(){return this.viewPortDiv},render:function(e){this.div=OpenLayers.Util.getElement(e);OpenLayers.Element.addClass(this.div,"olMap");this.viewPortDiv.parentNode.removeChild(this.viewPortDiv);this.div.appendChild(this.viewPortDiv);this.updateSize()},unloadDestroy:null,updateSizeDestroy:null,destroy:function(){if(!this.unloadDestroy)return!1;if(this.panTween){this.panTween.stop();this.panTween=null}if(this.zoomTween){this.zoomTween.stop();this.zoomTween=null}OpenLayers.Event.stopObserving(window,"unload",this.unloadDestroy);this.unloadDestroy=null;this.updateSizeDestroy&&OpenLayers.Event.stopObserving(window,"resize",this.updateSizeDestroy);this.paddingForPopups=null;if(null!=this.controls){for(var e=this.controls.length-1;e>=0;--e)this.controls[e].destroy();this.controls=null}if(null!=this.layers){for(e=this.layers.length-1;e>=0;--e)this.layers[e].destroy(!1);this.layers=null}this.viewPortDiv&&this.viewPortDiv.parentNode&&this.viewPortDiv.parentNode.removeChild(this.viewPortDiv);this.viewPortDiv=null;if(this.tileManager){this.tileManager.removeMap(this);this.tileManager=null}if(this.eventListeners){this.events.un(this.eventListeners);this.eventListeners=null}this.events.destroy();this.events=null;this.options=null},setOptions:function(e){var t=this.minPx&&e.restrictedExtent!=this.restrictedExtent;OpenLayers.Util.extend(this,e);t&&this.moveTo(this.getCachedCenter(),this.zoom,{forceZoomChange:!0})},getTileSize:function(){return this.tileSize},getBy:function(e,t,i){var n="function"==typeof i.test;return OpenLayers.Array.filter(this[e],function(e){return e[t]==i||n&&i.test(e[t])})},getLayersBy:function(e,t){return this.getBy("layers",e,t)},getLayersByName:function(e){return this.getLayersBy("name",e)},getLayersByClass:function(e){return this.getLayersBy("CLASS_NAME",e)},getControlsBy:function(e,t){return this.getBy("controls",e,t)},getControlsByClass:function(e){return this.getControlsBy("CLASS_NAME",e)},getLayer:function(e){for(var t=null,i=0,n=this.layers.length;i<n;i++){var r=this.layers[i];if(r.id==e){t=r;break}}return t},setLayerZIndex:function(e,t){e.setZIndex(this.Z_INDEX_BASE[e.isBaseLayer?"BaseLayer":"Overlay"]+5*t)},resetLayersZIndex:function(){for(var e=0,t=this.layers.length;e<t;e++){var i=this.layers[e];this.setLayerZIndex(i,e)}},addLayer:function(e){for(var t=0,i=this.layers.length;t<i;t++)if(this.layers[t]==e)return!1;if(!1===this.events.triggerEvent("preaddlayer",{layer:e}))return!1;this.allOverlays&&(e.isBaseLayer=!1);e.div.className="olLayerDiv";e.div.style.overflow="";this.setLayerZIndex(e,this.layers.length);e.isFixed?this.viewPortDiv.appendChild(e.div):this.layerContainerDiv.appendChild(e.div);this.layers.push(e);e.setMap(this);e.isBaseLayer||this.allOverlays&&!this.baseLayer?null==this.baseLayer?this.setBaseLayer(e):e.setVisibility(!1):e.redraw();this.events.triggerEvent("addlayer",{layer:e});e.events.triggerEvent("added",{map:this,layer:e});e.afterAdd();return!0},addLayers:function(e){for(var t=0,i=e.length;t<i;t++)this.addLayer(e[t])},removeLayer:function(e,t){if(!1!==this.events.triggerEvent("preremovelayer",{layer:e})){null==t&&(t=!0);e.isFixed?this.viewPortDiv.removeChild(e.div):this.layerContainerDiv.removeChild(e.div);OpenLayers.Util.removeItem(this.layers,e);e.removeMap(this);e.map=null;if(this.baseLayer==e){this.baseLayer=null;if(t)for(var i=0,n=this.layers.length;i<n;i++){var r=this.layers[i];if(r.isBaseLayer||this.allOverlays){this.setBaseLayer(r);break}}}this.resetLayersZIndex();this.events.triggerEvent("removelayer",{layer:e});e.events.triggerEvent("removed",{map:this,layer:e})}},getNumLayers:function(){return this.layers.length},getLayerIndex:function(e){return OpenLayers.Util.indexOf(this.layers,e)},setLayerIndex:function(e,t){var i=this.getLayerIndex(e);t<0?t=0:t>this.layers.length&&(t=this.layers.length);if(i!=t){this.layers.splice(i,1);this.layers.splice(t,0,e);for(var n=0,r=this.layers.length;n<r;n++)this.setLayerZIndex(this.layers[n],n);this.events.triggerEvent("changelayer",{layer:e,property:"order"});this.allOverlays&&(0===t?this.setBaseLayer(e):this.baseLayer!==this.layers[0]&&this.setBaseLayer(this.layers[0]))}},raiseLayer:function(e,t){var i=this.getLayerIndex(e)+t;this.setLayerIndex(e,i)},setBaseLayer:function(e){if(e!=this.baseLayer&&-1!=OpenLayers.Util.indexOf(this.layers,e)){var t=this.getCachedCenter(),i=OpenLayers.Util.getResolutionFromScale(this.getScale(),e.units);null==this.baseLayer||this.allOverlays||this.baseLayer.setVisibility(!1);this.baseLayer=e;if(!this.allOverlays||this.baseLayer.visibility){this.baseLayer.setVisibility(!0);!1===this.baseLayer.inRange&&this.baseLayer.redraw()}if(null!=t){var n=this.getZoomForResolution(i||this.resolution,!0);this.setCenter(t,n,!1,!0)}this.events.triggerEvent("changebaselayer",{layer:this.baseLayer})}},addControl:function(e,t){this.controls.push(e);this.addControlToMap(e,t)},addControls:function(e,t){for(var i=1===arguments.length?[]:t,n=0,r=e.length;n<r;n++){var s=e[n],a=i[n]?i[n]:null;this.addControl(s,a)}},addControlToMap:function(e,t){e.outsideViewport=null!=e.div;this.displayProjection&&!e.displayProjection&&(e.displayProjection=this.displayProjection);e.setMap(this);var i=e.draw(t);if(i&&!e.outsideViewport){i.style.zIndex=this.Z_INDEX_BASE.Control+this.controls.length;this.viewPortDiv.appendChild(i)}e.autoActivate&&e.activate()},getControl:function(e){for(var t=null,i=0,n=this.controls.length;i<n;i++){var r=this.controls[i];if(r.id==e){t=r;break}}return t},removeControl:function(e){if(e&&e==this.getControl(e.id)){e.div&&e.div.parentNode==this.viewPortDiv&&this.viewPortDiv.removeChild(e.div);OpenLayers.Util.removeItem(this.controls,e)}},addPopup:function(e,t){if(t)for(var i=this.popups.length-1;i>=0;--i)this.removePopup(this.popups[i]);e.map=this;this.popups.push(e);var n=e.draw();if(n){n.style.zIndex=this.Z_INDEX_BASE.Popup+this.popups.length;this.layerContainerDiv.appendChild(n)}},removePopup:function(e){OpenLayers.Util.removeItem(this.popups,e);if(e.div)try{this.layerContainerDiv.removeChild(e.div)}catch(e){}e.map=null},getSize:function(){var e=null;null!=this.size&&(e=this.size.clone());return e},updateSize:function(){var e=this.getCurrentSize();if(e&&!isNaN(e.h)&&!isNaN(e.w)){this.events.clearMouseCache();var t=this.getSize();null==t&&(this.size=t=e);if(!e.equals(t)){this.size=e;for(var i=0,n=this.layers.length;i<n;i++)this.layers[i].onMapResize();var r=this.getCachedCenter();if(null!=this.baseLayer&&null!=r){var s=this.getZoom();this.zoom=null;this.setCenter(r,s)}}}this.events.triggerEvent("updatesize")},getCurrentSize:function(){var e=new OpenLayers.Size(this.div.clientWidth,this.div.clientHeight);if(0==e.w&&0==e.h||isNaN(e.w)&&isNaN(e.h)){e.w=this.div.offsetWidth;e.h=this.div.offsetHeight}if(0==e.w&&0==e.h||isNaN(e.w)&&isNaN(e.h)){e.w=parseInt(this.div.style.width);e.h=parseInt(this.div.style.height)}return e},calculateBounds:function(e,t){var i=null;null==e&&(e=this.getCachedCenter());null==t&&(t=this.getResolution());if(null!=e&&null!=t){var n=this.size.w*t/2,r=this.size.h*t/2;i=new OpenLayers.Bounds(e.lon-n,e.lat-r,e.lon+n,e.lat+r)}return i},getCenter:function(){var e=null,t=this.getCachedCenter();t&&(e=t.clone());return e},getCachedCenter:function(){!this.center&&this.size&&(this.center=this.getLonLatFromViewPortPx({x:this.size.w/2,y:this.size.h/2}));return this.center},getZoom:function(){return this.zoom},pan:function(e,t,i){if((i=OpenLayers.Util.applyDefaults(i,{animate:!0,dragging:!1})).dragging)0==e&&0==t||this.moveByPx(e,t);else{var n=this.getViewPortPxFromLonLat(this.getCachedCenter()),r=n.add(e,t);if(this.dragging||!r.equals(n)){var s=this.getLonLatFromViewPortPx(r);if(i.animate)this.panTo(s);else{this.moveTo(s);if(this.dragging){this.dragging=!1;this.events.triggerEvent("moveend")}}}}},panTo:function(e){if(this.panTween&&this.getExtent().scale(this.panRatio).containsLonLat(e)){var t=this.getCachedCenter();if(e.equals(t))return;var i=this.getPixelFromLonLat(t),n=this.getPixelFromLonLat(e),r={x:n.x-i.x,y:n.y-i.y},s={x:0,y:0};this.panTween.start({x:0,y:0},r,this.panDuration,{callbacks:{eachStep:OpenLayers.Function.bind(function(e){var t=e.x-s.x,i=e.y-s.y;this.moveByPx(t,i);s.x=Math.round(e.x);s.y=Math.round(e.y)},this),done:OpenLayers.Function.bind(function(t){this.moveTo(e);this.dragging=!1;this.events.triggerEvent("moveend")},this)}})}else this.setCenter(e)},setCenter:function(e,t,i,n){this.panTween&&this.panTween.stop();this.zoomTween&&this.zoomTween.stop();this.moveTo(e,t,{dragging:i,forceZoomChange:n})},moveByPx:function(e,t){var i=this.size.w/2,n=this.size.h/2,r=i+e,s=n+t,a=this.baseLayer.wrapDateLine,o=0,l=0;if(this.restrictedExtent){o=i;l=n;a=!1}e=a||r<=this.maxPx.x-o&&r>=this.minPx.x+o?Math.round(e):0;t=s<=this.maxPx.y-l&&s>=this.minPx.y+l?Math.round(t):0;if(e||t){if(!this.dragging){this.dragging=!0;this.events.triggerEvent("movestart")}this.center=null;if(e){this.layerContainerOriginPx.x-=e;this.minPx.x-=e;this.maxPx.x-=e}if(t){this.layerContainerOriginPx.y-=t;this.minPx.y-=t;this.maxPx.y-=t}this.applyTransform();var c,u,h;for(u=0,h=this.layers.length;u<h;++u)if((c=this.layers[u]).visibility&&(c===this.baseLayer||c.inRange)){c.moveByPx(e,t);c.events.triggerEvent("move")}this.events.triggerEvent("move")}},adjustZoom:function(e){if(this.baseLayer&&this.baseLayer.wrapDateLine){var t=this.baseLayer.resolutions,i=this.getMaxExtent().getWidth()/this.size.w;if(this.getResolutionForZoom(e)>i)if(this.fractionalZoom)e=this.getZoomForResolution(i);else for(var n=0|e,r=t.length;n<r;++n)if(t[n]<=i){e=n;break}}return e},getMinZoom:function(){return this.adjustZoom(0)},moveTo:function(e,t,i){null==e||e instanceof OpenLayers.LonLat||(e=new OpenLayers.LonLat(e));i||(i={});if(null!=t){t=parseFloat(t);this.fractionalZoom||(t=Math.round(t))}var n=t;(t=this.adjustZoom(t))!==n&&(e=this.getCenter());var r=i.dragging||this.dragging,s=i.forceZoomChange;if(!this.getCachedCenter()&&!this.isValidLonLat(e)){e=this.maxExtent.getCenterLonLat();this.center=e.clone()}if(null!=this.restrictedExtent){null==e&&(e=this.center);null==t&&(t=this.getZoom());var a=this.getResolutionForZoom(t),o=this.calculateBounds(e,a);if(!this.restrictedExtent.containsBounds(o)){var l=this.restrictedExtent.getCenterLonLat();o.getWidth()>this.restrictedExtent.getWidth()?e=new OpenLayers.LonLat(l.lon,e.lat):o.left<this.restrictedExtent.left?e=e.add(this.restrictedExtent.left-o.left,0):o.right>this.restrictedExtent.right&&(e=e.add(this.restrictedExtent.right-o.right,0));o.getHeight()>this.restrictedExtent.getHeight()?e=new OpenLayers.LonLat(e.lon,l.lat):o.bottom<this.restrictedExtent.bottom?e=e.add(0,this.restrictedExtent.bottom-o.bottom):o.top>this.restrictedExtent.top&&(e=e.add(0,this.restrictedExtent.top-o.top))}}var c=s||this.isValidZoomLevel(t)&&t!=this.getZoom(),u=this.isValidLonLat(e)&&!e.equals(this.center);if(c||u||r){r||this.events.triggerEvent("movestart",{zoomChanged:c});if(u){!c&&this.center&&this.centerLayerContainer(e);this.center=e.clone()}var h=c?this.getResolutionForZoom(t):this.getResolution();if(c||null==this.layerContainerOrigin){this.layerContainerOrigin=this.getCachedCenter();this.layerContainerOriginPx.x=0;this.layerContainerOriginPx.y=0;this.applyTransform();var p=this.getMaxExtent({restricted:!0}),d=p.getCenterLonLat(),f=this.center.lon-d.lon,m=d.lat-this.center.lat,y=Math.round(p.getWidth()/h),g=Math.round(p.getHeight()/h);this.minPx={x:(this.size.w-y)/2-f/h,y:(this.size.h-g)/2-m/h};this.maxPx={x:this.minPx.x+Math.round(p.getWidth()/h),y:this.minPx.y+Math.round(p.getHeight()/h)}}if(c){this.zoom=t;this.resolution=h}var C=this.getExtent();if(this.baseLayer.visibility){this.baseLayer.moveTo(C,c,i.dragging);i.dragging||this.baseLayer.events.triggerEvent("moveend",{zoomChanged:c})}C=this.baseLayer.getExtent();for(var v=this.layers.length-1;v>=0;--v){var T=this.layers[v];if(T!==this.baseLayer&&!T.isBaseLayer){var L=T.calculateInRange();if(T.inRange!=L){T.inRange=L;L||T.display(!1);this.events.triggerEvent("changelayer",{layer:T,property:"visibility"})}if(L&&T.visibility){T.moveTo(C,c,i.dragging);i.dragging||T.events.triggerEvent("moveend",{zoomChanged:c})}}}this.events.triggerEvent("move");r||this.events.triggerEvent("moveend");if(c){v=0;for(var w=this.popups.length;v<w;v++)this.popups[v].updatePosition();this.events.triggerEvent("zoomend")}}},centerLayerContainer:function(e){var t=this.getViewPortPxFromLonLat(this.layerContainerOrigin),i=this.getViewPortPxFromLonLat(e);if(null!=t&&null!=i){var n=this.layerContainerOriginPx.x,r=this.layerContainerOriginPx.y,s=Math.round(t.x-i.x),a=Math.round(t.y-i.y);this.applyTransform(this.layerContainerOriginPx.x=s,this.layerContainerOriginPx.y=a);var o=n-s,l=r-a;this.minPx.x-=o;this.maxPx.x-=o;this.minPx.y-=l;this.maxPx.y-=l}},isValidZoomLevel:function(e){return null!=e&&e>=0&&e<this.getNumZoomLevels()},isValidLonLat:function(e){var t=!1;if(null!=e){var i=this.getMaxExtent(),n=this.baseLayer.wrapDateLine&&i;t=i.containsLonLat(e,{worldBounds:n})}return t},getProjection:function(){var e=this.getProjectionObject();return e?e.getCode():null},getProjectionObject:function(){var e=null;null!=this.baseLayer&&(e=this.baseLayer.projection);return e},getMaxResolution:function(){var e=null;null!=this.baseLayer&&(e=this.baseLayer.maxResolution);return e},getMaxExtent:function(e){var t=null;e&&e.restricted&&this.restrictedExtent?t=this.restrictedExtent:null!=this.baseLayer&&(t=this.baseLayer.maxExtent);return t},getNumZoomLevels:function(){var e=null;null!=this.baseLayer&&(e=this.baseLayer.numZoomLevels);return e},getExtent:function(){var e=null;null!=this.baseLayer&&(e=this.baseLayer.getExtent());return e},getResolution:function(){var e=null;null!=this.baseLayer?e=this.baseLayer.getResolution():!0===this.allOverlays&&this.layers.length>0&&(e=this.layers[0].getResolution());return e},getUnits:function(){var e=null;null!=this.baseLayer&&(e=this.baseLayer.units);return e},getScale:function(){var e=null;if(null!=this.baseLayer){var t=this.getResolution(),i=this.baseLayer.units;e=OpenLayers.Util.getScaleFromResolution(t,i)}return e},getZoomForExtent:function(e,t){var i=null;null!=this.baseLayer&&(i=this.baseLayer.getZoomForExtent(e,t));return i},getResolutionForZoom:function(e){var t=null;this.baseLayer&&(t=this.baseLayer.getResolutionForZoom(e));return t},getZoomForResolution:function(e,t){var i=null;null!=this.baseLayer&&(i=this.baseLayer.getZoomForResolution(e,t));return i},zoomTo:function(e,t){var i=this;if(i.isValidZoomLevel(e)){i.baseLayer.wrapDateLine&&(e=i.adjustZoom(e));if(i.zoomTween){var n={scale:i.getResolution()/i.getResolutionForZoom(e)};if(i.zoomTween.playing&&i.zoomTween.duration<3*i.zoomDuration)i.zoomTween.finish={scale:i.zoomTween.finish.scale*n.scale};else{if(!t){var r=i.getSize();t={x:r.w/2,y:r.h/2}}i.zoomTween.start({scale:1},n,i.zoomDuration,{minFrameRate:50,callbacks:{eachStep:function(e){var n=i.layerContainerOriginPx,r=e.scale,s=(r-1)*(n.x-t.x)|0,a=(r-1)*(n.y-t.y)|0;i.applyTransform(n.x+s,n.y+a,r)},done:function(e){i.applyTransform();var n=i.getResolution()/e.scale,r=i.getZoomForResolution(n,!0);i.moveTo(i.getZoomTargetCenter(t,n),r,!0)}}})}}else{var s=t?i.getZoomTargetCenter(t,i.getResolutionForZoom(e)):null;i.setCenter(s,e)}}},zoomIn:function(){this.zoomTo(this.getZoom()+1)},zoomOut:function(){this.zoomTo(this.getZoom()-1)},zoomToExtent:function(e,t){e instanceof OpenLayers.Bounds||(e=new OpenLayers.Bounds(e));var i=e.getCenterLonLat();if(this.baseLayer.wrapDateLine){var n=this.getMaxExtent();e=e.clone();for(;e.right<e.left;)e.right+=n.getWidth();i=e.getCenterLonLat().wrapDateLine(n)}this.setCenter(i,this.getZoomForExtent(e,t))},zoomToMaxExtent:function(e){var t=!e||e.restricted,i=this.getMaxExtent({restricted:t});this.zoomToExtent(i)},zoomToScale:function(e,t){var i=OpenLayers.Util.getResolutionFromScale(e,this.baseLayer.units),n=this.size.w*i/2,r=this.size.h*i/2,s=this.getCachedCenter(),a=new OpenLayers.Bounds(s.lon-n,s.lat-r,s.lon+n,s.lat+r);this.zoomToExtent(a,t)},getLonLatFromViewPortPx:function(e){var t=null;null!=this.baseLayer&&(t=this.baseLayer.getLonLatFromViewPortPx(e));return t},getViewPortPxFromLonLat:function(e){var t=null;null!=this.baseLayer&&(t=this.baseLayer.getViewPortPxFromLonLat(e));return t},getZoomTargetCenter:function(e,t){var i=null,n=this.getSize(),r=n.w/2-e.x,s=e.y-n.h/2,a=this.getLonLatFromPixel(e);a&&(i=new OpenLayers.LonLat(a.lon+r*t,a.lat+s*t));return i},getLonLatFromPixel:function(e){return this.getLonLatFromViewPortPx(e)},getPixelFromLonLat:function(e){var t=this.getViewPortPxFromLonLat(e);t.x=Math.round(t.x);t.y=Math.round(t.y);return t},getGeodesicPixelSize:function(e){var t=e?this.getLonLatFromPixel(e):this.getCachedCenter()||new OpenLayers.LonLat(0,0),i=this.getResolution(),n=t.add(-i/2,0),r=t.add(i/2,0),s=t.add(0,-i/2),a=t.add(0,i/2),o=new OpenLayers.Projection("EPSG:4326"),l=this.getProjectionObject()||o;if(!l.equals(o)){n.transform(l,o);r.transform(l,o);s.transform(l,o);a.transform(l,o)}return new OpenLayers.Size(OpenLayers.Util.distVincenty(n,r),OpenLayers.Util.distVincenty(s,a))},getViewPortPxFromLayerPx:function(e){var t=null;if(null!=e){var i=this.layerContainerOriginPx.x,n=this.layerContainerOriginPx.y;t=e.add(i,n)}return t},getLayerPxFromViewPortPx:function(e){var t=null;if(null!=e){var i=-this.layerContainerOriginPx.x,n=-this.layerContainerOriginPx.y;t=e.add(i,n);(isNaN(t.x)||isNaN(t.y))&&(t=null)}return t},getLonLatFromLayerPx:function(e){e=this.getViewPortPxFromLayerPx(e);return this.getLonLatFromViewPortPx(e)},getLayerPxFromLonLat:function(e){var t=this.getPixelFromLonLat(e);return this.getLayerPxFromViewPortPx(t)},applyTransform:function(e,t,i){i=i||1;var n=this.layerContainerOriginPx,r=1!==i;e=e||n.x;t=t||n.y;var s=this.layerContainerDiv.style,a=this.applyTransform.transform,o=this.applyTransform.template;if(void 0===a){a=OpenLayers.Util.vendorPrefix.style("transform");this.applyTransform.transform=a;if(a){var l=OpenLayers.Element.getStyle(this.viewPortDiv,OpenLayers.Util.vendorPrefix.css("transform"));if(!l||"none"!==l){o=["translate3d(",",0) ","scale3d(",",1)"];s[a]=[o[0],"0,0",o[1]].join("")}o&&~s[a].indexOf(o[0])||(o=["translate(",") ","scale(",")"]);this.applyTransform.template=o}}if(null===a||"translate3d("!==o[0]&&!0!==r){s.left=e+"px";s.top=t+"px";null!==a&&(s[a]="")}else{if(!0===r&&"translate("===o[0]){e-=n.x;t-=n.y;s.left=n.x+"px";s.top=n.y+"px"}s[a]=[o[0],e,"px,",t,"px",o[1],o[2],i,",",i,o[3]].join("")}},CLASS_NAME:"OpenLayers.Map"});OpenLayers.Map.TILE_WIDTH=256;OpenLayers.Map.TILE_HEIGHT=256;OpenLayers.Layer=OpenLayers.Class({id:null,name:null,div:null,opacity:1,alwaysInRange:null,RESOLUTION_PROPERTIES:["scales","resolutions","maxScale","minScale","maxResolution","minResolution","numZoomLevels","maxZoomLevel"],events:null,map:null,isBaseLayer:!1,alpha:!1,displayInLayerSwitcher:!0,visibility:!0,attribution:null,inRange:!1,imageSize:null,options:null,eventListeners:null,gutter:0,projection:null,units:null,scales:null,resolutions:null,maxExtent:null,minExtent:null,maxResolution:null,minResolution:null,numZoomLevels:null,minScale:null,maxScale:null,displayOutsideMaxExtent:!1,wrapDateLine:!1,metadata:null,initialize:function(e,t){this.metadata={};t=OpenLayers.Util.extend({},t);null!=this.alwaysInRange&&(t.alwaysInRange=this.alwaysInRange);this.addOptions(t);this.name=e;if(null==this.id){this.id=OpenLayers.Util.createUniqueID(this.CLASS_NAME+"_");this.div=OpenLayers.Util.createDiv(this.id);this.div.style.width="100%";this.div.style.height="100%";this.div.dir="ltr";this.events=new OpenLayers.Events(this,this.div);this.eventListeners instanceof Object&&this.events.on(this.eventListeners)}},destroy:function(e){null==e&&(e=!0);null!=this.map&&this.map.removeLayer(this,e);this.projection=null;this.map=null;this.name=null;this.div=null;this.options=null;if(this.events){this.eventListeners&&this.events.un(this.eventListeners);this.events.destroy()}this.eventListeners=null;this.events=null},clone:function(e){null==e&&(e=new OpenLayers.Layer(this.name,this.getOptions()));OpenLayers.Util.applyDefaults(e,this);e.map=null;return e},getOptions:function(){var e={};for(var t in this.options)e[t]=this[t];return e},setName:function(e){if(e!=this.name){this.name=e;null!=this.map&&this.map.events.triggerEvent("changelayer",{layer:this,property:"name"})}},addOptions:function(e,t){null==this.options&&(this.options={});if(e){"string"==typeof e.projection&&(e.projection=new OpenLayers.Projection(e.projection));e.projection&&OpenLayers.Util.applyDefaults(e,OpenLayers.Projection.defaults[e.projection.getCode()]);!e.maxExtent||e.maxExtent instanceof OpenLayers.Bounds||(e.maxExtent=new OpenLayers.Bounds(e.maxExtent));!e.minExtent||e.minExtent instanceof OpenLayers.Bounds||(e.minExtent=new OpenLayers.Bounds(e.minExtent))}OpenLayers.Util.extend(this.options,e);OpenLayers.Util.extend(this,e);this.projection&&this.projection.getUnits()&&(this.units=this.projection.getUnits());if(this.map){var i=this.map.getResolution(),n=this.RESOLUTION_PROPERTIES.concat(["projection","units","minExtent","maxExtent"]);for(var r in e)if(e.hasOwnProperty(r)&&OpenLayers.Util.indexOf(n,r)>=0){this.initResolutions();if(t&&this.map.baseLayer===this){this.map.setCenter(this.map.getCenter(),this.map.getZoomForResolution(i),!1,!0);this.map.events.triggerEvent("changebaselayer",{layer:this})}break}}},onMapResize:function(){},redraw:function(){var e=!1;if(this.map){this.inRange=this.calculateInRange();var t=this.getExtent();if(t&&this.inRange&&this.visibility){this.moveTo(t,!0,!1);this.events.triggerEvent("moveend",{zoomChanged:!0});e=!0}}return e},moveTo:function(e,t,i){var n=this.visibility;this.isBaseLayer||(n=n&&this.inRange);this.display(n)},moveByPx:function(e,t){},setMap:function(e){if(null==this.map){this.map=e;this.maxExtent=this.maxExtent||this.map.maxExtent;this.minExtent=this.minExtent||this.map.minExtent;this.projection=this.projection||this.map.projection;"string"==typeof this.projection&&(this.projection=new OpenLayers.Projection(this.projection));this.units=this.projection.getUnits()||this.units||this.map.units;this.initResolutions();if(!this.isBaseLayer){this.inRange=this.calculateInRange();var t=this.visibility&&this.inRange;this.div.style.display=t?"":"none"}this.setTileSize()}},afterAdd:function(){},removeMap:function(e){},getImageSize:function(e){return this.imageSize||this.tileSize},setTileSize:function(e){var t=e||(this.tileSize?this.tileSize:this.map.getTileSize());this.tileSize=t;this.gutter&&(this.imageSize=new OpenLayers.Size(t.w+2*this.gutter,t.h+2*this.gutter))},getVisibility:function(){return this.visibility},setVisibility:function(e){if(e!=this.visibility){this.visibility=e;this.display(e);this.redraw();null!=this.map&&this.map.events.triggerEvent("changelayer",{layer:this,property:"visibility"});this.events.triggerEvent("visibilitychanged")}},display:function(e){e!=("none"!=this.div.style.display)&&(this.div.style.display=e&&this.calculateInRange()?"block":"none")},calculateInRange:function(){var e=!1;if(this.alwaysInRange)e=!0;else if(this.map){var t=this.map.getResolution();e=t>=this.minResolution&&t<=this.maxResolution}return e},setIsBaseLayer:function(e){if(e!=this.isBaseLayer){this.isBaseLayer=e;null!=this.map&&this.map.events.triggerEvent("changebaselayer",{layer:this})}},initResolutions:function(){var e,t,i,n,r,s={},a=!0;for(e=0,t=this.RESOLUTION_PROPERTIES.length;e<t;e++){s[i=this.RESOLUTION_PROPERTIES[e]]=this.options[i];a&&this.options[i]&&(a=!1)}null==this.options.alwaysInRange&&(this.alwaysInRange=a);null==s.resolutions&&(s.resolutions=this.resolutionsFromScales(s.scales));null==s.resolutions&&(s.resolutions=this.calculateResolutions(s));if(null==s.resolutions){for(e=0,t=this.RESOLUTION_PROPERTIES.length;e<t;e++)s[i=this.RESOLUTION_PROPERTIES[e]]=null!=this.options[i]?this.options[i]:this.map[i];null==s.resolutions&&(s.resolutions=this.resolutionsFromScales(s.scales));null==s.resolutions&&(s.resolutions=this.calculateResolutions(s))}this.options.maxResolution&&"auto"!==this.options.maxResolution&&(n=this.options.maxResolution);this.options.minScale&&(n=OpenLayers.Util.getResolutionFromScale(this.options.minScale,this.units));this.options.minResolution&&"auto"!==this.options.minResolution&&(r=this.options.minResolution);this.options.maxScale&&(r=OpenLayers.Util.getResolutionFromScale(this.options.maxScale,this.units));if(s.resolutions){s.resolutions.sort(function(e,t){return t-e});n||(n=s.resolutions[0]);if(!r){var o=s.resolutions.length-1;r=s.resolutions[o]}}this.resolutions=s.resolutions;if(this.resolutions){t=this.resolutions.length;this.scales=new Array(t);for(e=0;e<t;e++)this.scales[e]=OpenLayers.Util.getScaleFromResolution(this.resolutions[e],this.units);this.numZoomLevels=t}this.minResolution=r;r&&(this.maxScale=OpenLayers.Util.getScaleFromResolution(r,this.units));this.maxResolution=n;n&&(this.minScale=OpenLayers.Util.getScaleFromResolution(n,this.units))},resolutionsFromScales:function(e){if(null!=e){var t,i,n;n=e.length;t=new Array(n);for(i=0;i<n;i++)t[i]=OpenLayers.Util.getResolutionFromScale(e[i],this.units);return t}},calculateResolutions:function(e){var t,i,n,r=e.maxResolution;if(null!=e.minScale)r=OpenLayers.Util.getResolutionFromScale(e.minScale,this.units);else if("auto"==r&&null!=this.maxExtent){t=this.map.getSize();i=this.maxExtent.getWidth()/t.w;n=this.maxExtent.getHeight()/t.h;r=Math.max(i,n)}var s=e.minResolution;if(null!=e.maxScale)s=OpenLayers.Util.getResolutionFromScale(e.maxScale,this.units);else if("auto"==e.minResolution&&null!=this.minExtent){t=this.map.getSize();i=this.minExtent.getWidth()/t.w;n=this.minExtent.getHeight()/t.h;s=Math.max(i,n)}if("number"!=typeof r&&"number"!=typeof s&&null!=this.maxExtent){var a=this.map.getTileSize();r=Math.max(this.maxExtent.getWidth()/a.w,this.maxExtent.getHeight()/a.h)}var o=e.maxZoomLevel,l=e.numZoomLevels;if("number"==typeof s&&"number"==typeof r&&void 0===l){var c=r/s;l=Math.floor(Math.log(c)/Math.log(2))+1}else void 0===l&&null!=o&&(l=o+1);if(!("number"!=typeof l||l<=0||"number"!=typeof r&&"number"!=typeof s)){var u,h=new Array(l),p=2;"number"==typeof s&&"number"==typeof r&&(p=Math.pow(r/s,1/(l-1)));if("number"==typeof r)for(u=0;u<l;u++)h[u]=r/Math.pow(p,u);else for(u=0;u<l;u++)h[l-1-u]=s*Math.pow(p,u);return h}},getResolution:function(){var e=this.map.getZoom();return this.getResolutionForZoom(e)},getExtent:function(){return this.map.calculateBounds()},getZoomForExtent:function(e,t){var i=this.map.getSize(),n=Math.max(e.getWidth()/i.w,e.getHeight()/i.h);return this.getZoomForResolution(n,t)},getDataExtent:function(){},getResolutionForZoom:function(e){e=Math.max(0,Math.min(e,this.resolutions.length-1));var t;if(this.map.fractionalZoom){var i=Math.floor(e),n=Math.ceil(e);t=this.resolutions[i]-(e-i)*(this.resolutions[i]-this.resolutions[n])}else t=this.resolutions[Math.round(e)];return t},getZoomForResolution:function(e,t){var i,n,r;if(this.map.fractionalZoom){var s,a=0,o=this.resolutions.length-1,l=this.resolutions[a],c=this.resolutions[o];for(n=0,r=this.resolutions.length;n<r;++n){if((s=this.resolutions[n])>=e){l=s;a=n}if(s<=e){c=s;o=n;break}}var u=l-c;i=u>0?a+(l-e)/u:a}else{var h,p=Number.POSITIVE_INFINITY;for(n=0,r=this.resolutions.length;n<r;n++)if(t){if((h=Math.abs(this.resolutions[n]-e))>p)break;p=h}else if(this.resolutions[n]<e)break;i=Math.max(0,n-1)}return i},getLonLatFromViewPortPx:function(e){var t=null,i=this.map;if(null!=e&&i.minPx){var n=i.getResolution(),r=i.getMaxExtent({restricted:!0}),s=(e.x-i.minPx.x)*n+r.left,a=(i.minPx.y-e.y)*n+r.top;t=new OpenLayers.LonLat(s,a);this.wrapDateLine&&(t=t.wrapDateLine(this.maxExtent))}return t},getViewPortPxFromLonLat:function(e,t){var i=null;if(null!=e){t=t||this.map.getResolution();var n=this.map.calculateBounds(null,t);i=new OpenLayers.Pixel(1/t*(e.lon-n.left),1/t*(n.top-e.lat))}return i},setOpacity:function(e){if(e!=this.opacity){this.opacity=e;for(var t=this.div.childNodes,i=0,n=t.length;i<n;++i){var r=t[i].firstChild||t[i],s=t[i].lastChild;s&&"iframe"===s.nodeName.toLowerCase()&&(r=s.parentNode);OpenLayers.Util.modifyDOMElement(r,null,null,null,null,null,null,e)}null!=this.map&&this.map.events.triggerEvent("changelayer",{layer:this,property:"opacity"})}},getZIndex:function(){return this.div.style.zIndex},setZIndex:function(e){this.div.style.zIndex=e},adjustBounds:function(e){if(this.gutter){var t=this.gutter*this.map.getResolution();e=new OpenLayers.Bounds(e.left-t,e.bottom-t,e.right+t,e.top+t)}if(this.wrapDateLine){var i={rightTolerance:this.getResolution(),leftTolerance:this.getResolution()};e=e.wrapDateLine(this.maxExtent,i)}return e},CLASS_NAME:"OpenLayers.Layer"});OpenLayers.Layer.HTTPRequest=OpenLayers.Class(OpenLayers.Layer,{URL_HASH_FACTOR:(Math.sqrt(5)-1)/2,url:null,params:null,reproject:!1,initialize:function(e,t,i,n){OpenLayers.Layer.prototype.initialize.apply(this,[e,n]);this.url=t;this.params||(this.params=OpenLayers.Util.extend({},i))},destroy:function(){this.url=null;this.params=null;OpenLayers.Layer.prototype.destroy.apply(this,arguments)},clone:function(e){null==e&&(e=new OpenLayers.Layer.HTTPRequest(this.name,this.url,this.params,this.getOptions()));return e=OpenLayers.Layer.prototype.clone.apply(this,[e])},setUrl:function(e){this.url=e},mergeNewParams:function(e){this.params=OpenLayers.Util.extend(this.params,e);var t=this.redraw();null!=this.map&&this.map.events.triggerEvent("changelayer",{layer:this,property:"params"});return t},redraw:function(e){return e?this.mergeNewParams({_olSalt:Math.random()}):OpenLayers.Layer.prototype.redraw.apply(this,[])},selectUrl:function(e,t){for(var i=1,n=0,r=e.length;n<r;n++){i*=e.charCodeAt(n)*this.URL_HASH_FACTOR;i-=Math.floor(i)}return t[Math.floor(i*t.length)]},getFullRequestString:function(e,t){var i=t||this.url,n=OpenLayers.Util.extend({},this.params);n=OpenLayers.Util.extend(n,e);var r=OpenLayers.Util.getParameterString(n);OpenLayers.Util.isArray(i)&&(i=this.selectUrl(r,i));var s=OpenLayers.Util.upperCaseObject(OpenLayers.Util.getParameters(i));for(var a in n)a.toUpperCase()in s&&delete n[a];r=OpenLayers.Util.getParameterString(n);return OpenLayers.Util.urlAppend(i,r)},CLASS_NAME:"OpenLayers.Layer.HTTPRequest"});OpenLayers.Tile=OpenLayers.Class({events:null,eventListeners:null,id:null,layer:null,url:null,bounds:null,size:null,position:null,isLoading:!1,initialize:function(e,t,i,n,r,s){this.layer=e;this.position=t.clone();this.setBounds(i);this.url=n;r&&(this.size=r.clone());this.id=OpenLayers.Util.createUniqueID("Tile_");OpenLayers.Util.extend(this,s);this.events=new OpenLayers.Events(this);this.eventListeners instanceof Object&&this.events.on(this.eventListeners)},unload:function(){if(this.isLoading){this.isLoading=!1;this.events.triggerEvent("unload")}},destroy:function(){this.layer=null;this.bounds=null;this.size=null;this.position=null;this.eventListeners&&this.events.un(this.eventListeners);this.events.destroy();this.eventListeners=null;this.events=null},draw:function(e){e||this.clear();var t=this.shouldDraw();t&&!e&&!1===this.events.triggerEvent("beforedraw")&&(t=null);return t},shouldDraw:function(){var e=!1,t=this.layer.maxExtent;if(t){var i=this.layer.map,n=i.baseLayer.wrapDateLine&&i.getMaxExtent();this.bounds.intersectsBounds(t,{inclusive:!1,worldBounds:n})&&(e=!0)}return e||this.layer.displayOutsideMaxExtent},setBounds:function(e){e=e.clone();if(this.layer.map.baseLayer.wrapDateLine){var t=this.layer.map.getMaxExtent(),i=this.layer.map.getResolution();e=e.wrapDateLine(t,{leftTolerance:i,rightTolerance:i})}this.bounds=e},moveTo:function(e,t,i){null==i&&(i=!0);this.setBounds(e);this.position=t.clone();i&&this.draw()},clear:function(e){},CLASS_NAME:"OpenLayers.Tile"});OpenLayers.Tile.Image=OpenLayers.Class(OpenLayers.Tile,{url:null,imgDiv:null,frame:null,imageReloadAttempts:null,layerAlphaHack:null,asyncRequestId:null,maxGetUrlLength:null,canvasContext:null,crossOriginKeyword:null,initialize:function(e,t,i,n,r,s){OpenLayers.Tile.prototype.initialize.apply(this,arguments);this.url=n;this.layerAlphaHack=this.layer.alpha&&OpenLayers.Util.alphaHack();if(null!=this.maxGetUrlLength||this.layer.gutter||this.layerAlphaHack){this.frame=document.createElement("div");this.frame.style.position="absolute";this.frame.style.overflow="hidden"}null!=this.maxGetUrlLength&&OpenLayers.Util.extend(this,OpenLayers.Tile.Image.IFrame)},destroy:function(){if(this.imgDiv){this.clear();this.imgDiv=null;this.frame=null}this.asyncRequestId=null;OpenLayers.Tile.prototype.destroy.apply(this,arguments)},draw:function(){var e=OpenLayers.Tile.prototype.draw.apply(this,arguments);if(e){this.layer!=this.layer.map.baseLayer&&this.layer.reproject&&(this.bounds=this.getBoundsFromBaseLayer(this.position));if(this.isLoading)this._loadEvent="reload";else{this.isLoading=!0;this._loadEvent="loadstart"}this.renderTile();this.positionTile()}else!1===e&&this.unload();return e},renderTile:function(){if(this.layer.async){var e=this.asyncRequestId=(this.asyncRequestId||0)+1;this.layer.getURLasync(this.bounds,function(t){if(e==this.asyncRequestId){this.url=t;this.initImage()}},this)}else{this.url=this.layer.getURL(this.bounds);this.initImage()}},positionTile:function(){var e=this.getTile().style,t=this.frame?this.size:this.layer.getImageSize(this.bounds),i=1;this.layer instanceof OpenLayers.Layer.Grid&&(i=this.layer.getServerResolution()/this.layer.map.getResolution());e.left=this.position.x+"px";e.top=this.position.y+"px";e.width=Math.round(i*t.w)+"px";e.height=Math.round(i*t.h)+"px"},clear:function(){OpenLayers.Tile.prototype.clear.apply(this,arguments);var e=this.imgDiv;if(e){var t=this.getTile();t.parentNode===this.layer.div&&this.layer.div.removeChild(t);this.setImgSrc();!0===this.layerAlphaHack&&(e.style.filter="");OpenLayers.Element.removeClass(e,"olImageLoadError")}this.canvasContext=null},getImage:function(){if(!this.imgDiv){this.imgDiv=OpenLayers.Tile.Image.IMAGE.cloneNode(!1);var e=this.imgDiv.style;if(this.frame){var t=0,i=0;if(this.layer.gutter){t=this.layer.gutter/this.layer.tileSize.w*100;i=this.layer.gutter/this.layer.tileSize.h*100}e.left=-t+"%";e.top=-i+"%";e.width=2*t+100+"%";e.height=2*i+100+"%"}e.visibility="hidden";e.opacity=0;this.layer.opacity<1&&(e.filter="alpha(opacity="+100*this.layer.opacity+")");e.position="absolute";if(this.layerAlphaHack){e.paddingTop=e.height;e.height="0";e.width="100%"}this.frame&&this.frame.appendChild(this.imgDiv)}return this.imgDiv},setImage:function(e){this.imgDiv=e},initImage:function(){if(this.url||this.imgDiv){this.events.triggerEvent("beforeload");this.layer.div.appendChild(this.getTile());this.events.triggerEvent(this._loadEvent);var e=this.getImage(),t=e.getAttribute("src")||"";if(this.url&&OpenLayers.Util.isEquivalentUrl(t,this.url))this._loadTimeout=window.setTimeout(OpenLayers.Function.bind(this.onImageLoad,this),0);else{this.stopLoading();this.crossOriginKeyword&&e.removeAttribute("crossorigin");OpenLayers.Event.observe(e,"load",OpenLayers.Function.bind(this.onImageLoad,this));OpenLayers.Event.observe(e,"error",OpenLayers.Function.bind(this.onImageError,this));this.imageReloadAttempts=0;this.setImgSrc(this.url)}}else this.isLoading=!1},setImgSrc:function(e){var t=this.imgDiv;if(e){t.style.visibility="hidden";t.style.opacity=0;this.crossOriginKeyword&&("data:"!==e.substr(0,5)?t.setAttribute("crossorigin",this.crossOriginKeyword):t.removeAttribute("crossorigin"));t.src=e}else{this.stopLoading();this.imgDiv=null;t.parentNode&&t.parentNode.removeChild(t)}},getTile:function(){return this.frame?this.frame:this.getImage()},createBackBuffer:function(){if(this.imgDiv&&!this.isLoading){var e;this.frame?(e=this.frame.cloneNode(!1)).appendChild(this.imgDiv):e=this.imgDiv;this.imgDiv=null;return e}},onImageLoad:function(){var e=this.imgDiv;this.stopLoading();e.style.visibility="inherit";e.style.opacity=this.layer.opacity;this.isLoading=!1;this.canvasContext=null;this.events.triggerEvent("loadend");!0===this.layerAlphaHack&&(e.style.filter="progid:DXImageTransform.Microsoft.AlphaImageLoader(src='"+e.src+"', sizingMethod='scale')")},onImageError:function(){var e=this.imgDiv;if(null!=e.src){this.imageReloadAttempts++;if(this.imageReloadAttempts<=OpenLayers.IMAGE_RELOAD_ATTEMPTS)this.setImgSrc(this.layer.getURL(this.bounds));else{OpenLayers.Element.addClass(e,"olImageLoadError");this.events.triggerEvent("loaderror");this.onImageLoad()}}},stopLoading:function(){OpenLayers.Event.stopObservingElement(this.imgDiv);window.clearTimeout(this._loadTimeout);delete this._loadTimeout},getCanvasContext:function(){if(OpenLayers.CANVAS_SUPPORTED&&this.imgDiv&&!this.isLoading){if(!this.canvasContext){var e=document.createElement("canvas");e.width=this.size.w;e.height=this.size.h;this.canvasContext=e.getContext("2d");this.canvasContext.drawImage(this.imgDiv,0,0)}return this.canvasContext}},CLASS_NAME:"OpenLayers.Tile.Image"});OpenLayers.Tile.Image.IMAGE=function(){var e=new Image;e.className="olTileImage";e.galleryImg="no";return e}();OpenLayers.Layer.Grid=OpenLayers.Class(OpenLayers.Layer.HTTPRequest,{tileSize:null,tileOriginCorner:"bl",tileOrigin:null,tileOptions:null,tileClass:OpenLayers.Tile.Image,grid:null,singleTile:!1,ratio:1.5,buffer:0,transitionEffect:"resize",numLoadingTiles:0,serverResolutions:null,loading:!1,backBuffer:null,gridResolution:null,backBufferResolution:null,backBufferLonLat:null,backBufferTimerId:null,removeBackBufferDelay:null,className:null,gridLayout:null,rowSign:null,transitionendEvents:["transitionend","webkitTransitionEnd","otransitionend","oTransitionEnd"],initialize:function(e,t,i,n){OpenLayers.Layer.HTTPRequest.prototype.initialize.apply(this,arguments);this.grid=[];this._removeBackBuffer=OpenLayers.Function.bind(this.removeBackBuffer,this);this.initProperties();this.rowSign="t"===this.tileOriginCorner.substr(0,1)?1:-1},initProperties:function(){void 0===this.options.removeBackBufferDelay&&(this.removeBackBufferDelay=this.singleTile?0:2500);void 0===this.options.className&&(this.className=this.singleTile?"olLayerGridSingleTile":"olLayerGrid")},setMap:function(e){OpenLayers.Layer.HTTPRequest.prototype.setMap.call(this,e);OpenLayers.Element.addClass(this.div,this.className)},removeMap:function(e){this.removeBackBuffer()},destroy:function(){this.removeBackBuffer();this.clearGrid();this.grid=null;this.tileSize=null;OpenLayers.Layer.HTTPRequest.prototype.destroy.apply(this,arguments)},clearGrid:function(){if(this.grid){for(var e=0,t=this.grid.length;e<t;e++)for(var i=this.grid[e],n=0,r=i.length;n<r;n++){var s=i[n];this.destroyTile(s)}this.grid=[];this.gridResolution=null;this.gridLayout=null}},addOptions:function(e,t){var i=void 0!==e.singleTile&&e.singleTile!==this.singleTile;OpenLayers.Layer.HTTPRequest.prototype.addOptions.apply(this,arguments);if(this.map&&i){this.initProperties();this.clearGrid();this.tileSize=this.options.tileSize;this.setTileSize();this.moveTo(null,!0)}},clone:function(e){null==e&&(e=new OpenLayers.Layer.Grid(this.name,this.url,this.params,this.getOptions()));e=OpenLayers.Layer.HTTPRequest.prototype.clone.apply(this,[e]);null!=this.tileSize&&(e.tileSize=this.tileSize.clone());e.grid=[];e.gridResolution=null;e.backBuffer=null;e.backBufferTimerId=null;e.loading=!1;e.numLoadingTiles=0;return e},moveTo:function(e,t,i){OpenLayers.Layer.HTTPRequest.prototype.moveTo.apply(this,arguments);if(null!=(e=e||this.map.getExtent())){var n=!this.grid.length||t,r=this.getTilesBounds(),s=this.map.getResolution();this.getServerResolution(s);if(this.singleTile){if(n||!i&&!r.containsBounds(e)){t&&"resize"!==this.transitionEffect&&this.removeBackBuffer();t&&"resize"!==this.transitionEffect||this.applyBackBuffer(s);this.initSingleTile(e)}}else if(n=n||!r.intersectsBounds(e,{worldBounds:this.map.baseLayer.wrapDateLine&&this.map.getMaxExtent()})){!t||"resize"!==this.transitionEffect&&this.gridResolution!==s||this.applyBackBuffer(s);this.initGriddedTiles(e)}else this.moveGriddedTiles()}},getTileData:function(e){var t=null,i=e.lon,n=e.lat,r=this.grid.length;if(this.map&&r){var s=this.map.getResolution(),a=this.tileSize.w,o=this.tileSize.h,l=this.grid[0][0].bounds,c=l.left,u=l.top;if(i<c&&this.map.baseLayer.wrapDateLine){var h=this.map.getMaxExtent().getWidth();i+=h*Math.ceil((c-i)/h)}var p=(i-c)/(s*a),d=(u-n)/(s*o),f=Math.floor(p),m=Math.floor(d);if(m>=0&&m<r){var y=this.grid[m][f];y&&(t={tile:y,i:Math.floor((p-f)*a),j:Math.floor((d-m)*o)})}}return t},destroyTile:function(e){this.removeTileMonitoringHooks(e);e.destroy()},getServerResolution:function(e){var t=Number.POSITIVE_INFINITY;e=e||this.map.getResolution();if(this.serverResolutions&&-1===OpenLayers.Util.indexOf(this.serverResolutions,e)){var i,n,r,s;for(i=this.serverResolutions.length-1;i>=0;i--){r=this.serverResolutions[i];if((n=Math.abs(r-e))>t)break;t=n;s=r}e=s}return e},getServerZoom:function(){var e=this.getServerResolution();return this.serverResolutions?OpenLayers.Util.indexOf(this.serverResolutions,e):this.map.getZoomForResolution(e)+(this.zoomOffset||0)},applyBackBuffer:function(e){null!==this.backBufferTimerId&&this.removeBackBuffer();var t=this.backBuffer;if(!t){if(!(t=this.createBackBuffer()))return;e===this.gridResolution?this.div.insertBefore(t,this.div.firstChild):this.map.baseLayer.div.parentNode.insertBefore(t,this.map.baseLayer.div);this.backBuffer=t;var i=this.grid[0][0].bounds;this.backBufferLonLat={lon:i.left,lat:i.top};this.backBufferResolution=this.gridResolution}for(var n,r=this.backBufferResolution/e,s=t.childNodes,a=s.length-1;a>=0;--a){(n=s[a]).style.top=(r*n._i*n._h|0)+"px";n.style.left=(r*n._j*n._w|0)+"px";n.style.width=Math.round(r*n._w)+"px";n.style.height=Math.round(r*n._h)+"px"}var o=this.getViewPortPxFromLonLat(this.backBufferLonLat,e),l=this.map.layerContainerOriginPx.x,c=this.map.layerContainerOriginPx.y;t.style.left=Math.round(o.x-l)+"px";t.style.top=Math.round(o.y-c)+"px"},createBackBuffer:function(){var e;if(this.grid.length>0){(e=document.createElement("div")).id=this.div.id+"_bb";e.className="olBackBuffer";e.style.position="absolute";var t=this.map;e.style.zIndex="resize"===this.transitionEffect?this.getZIndex()-1:t.Z_INDEX_BASE.BaseLayer-(t.getNumLayers()-t.getLayerIndex(this));for(var i=0,n=this.grid.length;i<n;i++)for(var r=0,s=this.grid[i].length;r<s;r++){var a=this.grid[i][r],o=this.grid[i][r].createBackBuffer();if(o){o._i=i;o._j=r;o._w=a.size.w;o._h=a.size.h;o.id=a.id+"_bb";e.appendChild(o)}}}return e},removeBackBuffer:function(){if(this._transitionElement){for(var e=this.transitionendEvents.length-1;e>=0;--e)OpenLayers.Event.stopObserving(this._transitionElement,this.transitionendEvents[e],this._removeBackBuffer);delete this._transitionElement}if(this.backBuffer){this.backBuffer.parentNode&&this.backBuffer.parentNode.removeChild(this.backBuffer);this.backBuffer=null;this.backBufferResolution=null;if(null!==this.backBufferTimerId){window.clearTimeout(this.backBufferTimerId);this.backBufferTimerId=null}}},moveByPx:function(e,t){this.singleTile||this.moveGriddedTiles()},setTileSize:function(e){if(this.singleTile){(e=this.map.getSize()).h=parseInt(e.h*this.ratio,10);e.w=parseInt(e.w*this.ratio,10)}OpenLayers.Layer.HTTPRequest.prototype.setTileSize.apply(this,[e])},getTilesBounds:function(){var e=null,t=this.grid.length;if(t){var i=this.grid[t-1][0].bounds,n=this.grid[0].length*i.getWidth(),r=this.grid.length*i.getHeight();e=new OpenLayers.Bounds(i.left,i.bottom,i.left+n,i.bottom+r)}return e},initSingleTile:function(e){this.events.triggerEvent("retile");var t=e.getCenterLonLat(),i=e.getWidth()*this.ratio,n=e.getHeight()*this.ratio,r=new OpenLayers.Bounds(t.lon-i/2,t.lat-n/2,t.lon+i/2,t.lat+n/2),s=this.map.getLayerPxFromLonLat({lon:r.left,lat:r.top});this.grid.length||(this.grid[0]=[]);var a=this.grid[0][0];if(a)a.moveTo(r,s);else{a=this.addTile(r,s);this.addTileMonitoringHooks(a);a.draw();this.grid[0][0]=a}this.removeExcessTiles(1,1);this.gridResolution=this.getServerResolution()},calculateGridLayout:function(e,t,i){var n=i*this.tileSize.w,r=i*this.tileSize.h,s=e.left-t.lon,a=Math.floor(s/n)-this.buffer,o=this.rowSign,l=o*(t.lat-e.top+r);return{tilelon:n,tilelat:r,startcol:a,startrow:Math[~o?"floor":"ceil"](l/r)-this.buffer*o}},getTileOrigin:function(){var e=this.tileOrigin;if(!e){var t=this.getMaxExtent(),i={tl:["left","top"],tr:["right","top"],bl:["left","bottom"],br:["right","bottom"]}[this.tileOriginCorner];e=new OpenLayers.LonLat(t[i[0]],t[i[1]])}return e},getTileBoundsForGridIndex:function(e,t){var i=this.getTileOrigin(),n=this.gridLayout,r=n.tilelon,s=n.tilelat,a=n.startcol,o=n.startrow,l=this.rowSign;return new OpenLayers.Bounds(i.lon+(a+t)*r,i.lat-(o+e*l)*s*l,i.lon+(a+t+1)*r,i.lat-(o+(e-1)*l)*s*l)},initGriddedTiles:function(e){this.events.triggerEvent("retile");var t=this.map.getSize(),i=this.getTileOrigin(),n=this.map.getResolution(),r=this.getServerResolution(),s=n/r,a={w:this.tileSize.w/s,h:this.tileSize.h/s},o=Math.ceil(t.h/a.h)+2*this.buffer+1,l=Math.ceil(t.w/a.w)+2*this.buffer+1,c=this.calculateGridLayout(e,i,r);this.gridLayout=c;var u=c.tilelon,h=c.tilelat,p=this.map.layerContainerOriginPx.x,d=this.map.layerContainerOriginPx.y,f=this.getTileBoundsForGridIndex(0,0),m=this.map.getViewPortPxFromLonLat(new OpenLayers.LonLat(f.left,f.top));m.x=Math.round(m.x)-p;m.y=Math.round(m.y)-d;var y=[],g=this.map.getCenter(),C=0;do{var v=this.grid[C];if(!v){v=[];this.grid.push(v)}var T=0;do{f=this.getTileBoundsForGridIndex(C,T);var L=m.clone();L.x=L.x+T*Math.round(a.w);L.y=L.y+C*Math.round(a.h);var w=v[T];if(w)w.moveTo(f,L,!1);else{w=this.addTile(f,L);this.addTileMonitoringHooks(w);v.push(w)}var b=f.getCenterLonLat();y.push({tile:w,distance:Math.pow(b.lon-g.lon,2)+Math.pow(b.lat-g.lat,2)});T+=1}while(f.right<=e.right+u*this.buffer||T<l);C+=1}while(f.bottom>=e.bottom-h*this.buffer||C<o);this.removeExcessTiles(C,T);n=this.getServerResolution();this.gridResolution=n;y.sort(function(e,t){return e.distance-t.distance});for(var S=0,E=y.length;S<E;++S)y[S].tile.draw()},getMaxExtent:function(){return this.maxExtent},addTile:function(e,t){var i=new this.tileClass(this,t,e,null,this.tileSize,this.tileOptions);this.events.triggerEvent("addtile",{tile:i});return i},addTileMonitoringHooks:function(e){e.onLoadStart=function(){if(!1===this.loading){this.loading=!0;this.events.triggerEvent("loadstart")}this.events.triggerEvent("tileloadstart",{tile:e});this.numLoadingTiles++;!this.singleTile&&this.backBuffer&&this.gridResolution===this.backBufferResolution&&OpenLayers.Element.addClass(e.getTile(),"olTileReplacing")};e.onLoadEnd=function(t){this.numLoadingTiles--;var i="unload"===t.type;this.events.triggerEvent("tileloaded",{tile:e,aborted:i});if(!this.singleTile&&!i&&this.backBuffer&&this.gridResolution===this.backBufferResolution){var n=e.getTile();if("none"===OpenLayers.Element.getStyle(n,"display")){var r=document.getElementById(e.id+"_bb");r&&r.parentNode.removeChild(r)}OpenLayers.Element.removeClass(n,"olTileReplacing")}if(0===this.numLoadingTiles){if(this.backBuffer)if(0===this.backBuffer.childNodes.length)this.removeBackBuffer();else{this._transitionElement=i?this.div.lastChild:e.imgDiv;for(var s=this.transitionendEvents,a=s.length-1;a>=0;--a)OpenLayers.Event.observe(this._transitionElement,s[a],this._removeBackBuffer);this.backBufferTimerId=window.setTimeout(this._removeBackBuffer,this.removeBackBufferDelay)}this.loading=!1;this.events.triggerEvent("loadend")}};e.onLoadError=function(){this.events.triggerEvent("tileerror",{tile:e})};e.events.on({loadstart:e.onLoadStart,loadend:e.onLoadEnd,unload:e.onLoadEnd,loaderror:e.onLoadError,scope:this})},removeTileMonitoringHooks:function(e){e.unload();e.events.un({loadstart:e.onLoadStart,loadend:e.onLoadEnd,unload:e.onLoadEnd,loaderror:e.onLoadError,scope:this})},moveGriddedTiles:function(){for(var e=this.buffer+1;;){var t=this.grid[0][0],i={x:t.position.x+this.map.layerContainerOriginPx.x,y:t.position.y+this.map.layerContainerOriginPx.y},n=this.getServerResolution()/this.map.getResolution(),r={w:Math.round(this.tileSize.w*n),h:Math.round(this.tileSize.h*n)};if(i.x>-r.w*(e-1))this.shiftColumn(!0,r);else if(i.x<-r.w*e)this.shiftColumn(!1,r);else if(i.y>-r.h*(e-1))this.shiftRow(!0,r);else{if(!(i.y<-r.h*e))break;this.shiftRow(!1,r)}}},shiftRow:function(e,t){var i=this.grid,n=e?0:i.length-1,r=e?-1:1,s=this.rowSign;this.gridLayout.startrow+=r*s;for(var a=i[n],o=i[e?"pop":"shift"](),l=0,c=o.length;l<c;l++){var u=o[l],h=a[l].position.clone();h.y+=t.h*r;u.moveTo(this.getTileBoundsForGridIndex(n,l),h)}i[e?"unshift":"push"](o)},shiftColumn:function(e,t){var i=this.grid,n=e?0:i[0].length-1,r=e?-1:1;this.gridLayout.startcol+=r;for(var s=0,a=i.length;s<a;s++){var o=i[s],l=o[n].position.clone(),c=o[e?"pop":"shift"]();l.x+=t.w*r;c.moveTo(this.getTileBoundsForGridIndex(s,n),l);o[e?"unshift":"push"](c)}},removeExcessTiles:function(e,t){for(var i,n;this.grid.length>e;){for(i=0,n=(s=this.grid.pop()).length;i<n;i++){var r=s[i];this.destroyTile(r)}}for(i=0,n=this.grid.length;i<n;i++)for(;this.grid[i].length>t;){var s;r=(s=this.grid[i]).pop();this.destroyTile(r)}},onMapResize:function(){if(this.singleTile){this.clearGrid();this.setTileSize()}},getTileBounds:function(e){var t=this.maxExtent,i=this.getResolution(),n=i*this.tileSize.w,r=i*this.tileSize.h,s=this.getLonLatFromViewPortPx(e),a=t.left+n*Math.floor((s.lon-t.left)/n),o=t.bottom+r*Math.floor((s.lat-t.bottom)/r);return new OpenLayers.Bounds(a,o,a+n,o+r)},CLASS_NAME:"OpenLayers.Layer.Grid"});OpenLayers.Layer.WMTS=OpenLayers.Class(OpenLayers.Layer.Grid,{isBaseLayer:!0,version:"1.0.0",requestEncoding:"KVP",url:null,layer:null,matrixSet:null,style:null,format:"image/jpeg",tileOrigin:null,tileFullExtent:null,formatSuffix:null,matrixIds:null,dimensions:null,params:null,zoomOffset:0,serverResolutions:null,formatSuffixMap:{"image/png":"png","image/png8":"png","image/png24":"png","image/png32":"png",png:"png","image/jpeg":"jpg","image/jpg":"jpg",jpeg:"jpg",jpg:"jpg"},matrix:null,initialize:function(e){for(var t in{url:!0,layer:!0,style:!0,matrixSet:!0})if(!(t in e))throw new Error("Missing property '"+t+"' in layer configuration.");e.params=OpenLayers.Util.upperCaseObject(e.params);var i=[e.name,e.url,e.params,e];OpenLayers.Layer.Grid.prototype.initialize.apply(this,i);this.formatSuffix||(this.formatSuffix=this.formatSuffixMap[this.format]||this.format.split("/").pop());if(this.matrixIds){var n=this.matrixIds.length;if(n&&"string"==typeof this.matrixIds[0]){var r=this.matrixIds;this.matrixIds=new Array(n);for(var s=0;s<n;++s)this.matrixIds[s]={identifier:r[s]}}}},setMap:function(){OpenLayers.Layer.Grid.prototype.setMap.apply(this,arguments)},updateMatrixProperties:function(){this.matrix=this.getMatrix();if(this.matrix){this.matrix.topLeftCorner&&(this.tileOrigin=this.matrix.topLeftCorner);this.matrix.tileWidth&&this.matrix.tileHeight&&(this.tileSize=new OpenLayers.Size(this.matrix.tileWidth,this.matrix.tileHeight));this.tileOrigin||(this.tileOrigin=new OpenLayers.LonLat(this.maxExtent.left,this.maxExtent.top));this.tileFullExtent||(this.tileFullExtent=this.maxExtent)}},moveTo:function(e,t,i){!t&&this.matrix||this.updateMatrixProperties();return OpenLayers.Layer.Grid.prototype.moveTo.apply(this,arguments)},clone:function(e){null==e&&(e=new OpenLayers.Layer.WMTS(this.options));return e=OpenLayers.Layer.Grid.prototype.clone.apply(this,[e])},getIdentifier:function(){return this.getServerZoom()},getMatrix:function(){var e;if(this.matrixIds&&0!==this.matrixIds.length)if("scaleDenominator"in this.matrixIds[0]){for(var t,i=OpenLayers.METERS_PER_INCH*OpenLayers.INCHES_PER_UNIT[this.units]*this.getServerResolution()/28e-5,n=Number.POSITIVE_INFINITY,r=0,s=this.matrixIds.length;r<s;++r)if((t=Math.abs(1-this.matrixIds[r].scaleDenominator/i))<n){n=t;e=this.matrixIds[r]}}else e=this.matrixIds[this.getIdentifier()];else e={identifier:this.getIdentifier()};return e},getTileInfo:function(e){var t=this.getServerResolution(),i=(e.lon-this.tileOrigin.lon)/(t*this.tileSize.w),n=(this.tileOrigin.lat-e.lat)/(t*this.tileSize.h),r=Math.floor(i),s=Math.floor(n);return{col:r,row:s,i:Math.floor((i-r)*this.tileSize.w),j:Math.floor((n-s)*this.tileSize.h)}},getURL:function(e){e=this.adjustBounds(e);var t="";if(!this.tileFullExtent||this.tileFullExtent.intersectsBounds(e)){var i,n=e.getCenterLonLat(),r=this.getTileInfo(n),s=(this.matrix.identifier,this.dimensions);t=OpenLayers.Util.isArray(this.url)?this.selectUrl([this.version,this.style,this.matrixSet,this.matrix.identifier,r.row,r.col].join(","),this.url):this.url;if("REST"===this.requestEncoding.toUpperCase()){i=this.params;if(-1!==t.indexOf("{")){var a=t.replace(/\{/g,"${"),o={style:this.style,Style:this.style,TileMatrixSet:this.matrixSet,TileMatrix:this.matrix.identifier,TileRow:r.row,TileCol:r.col};if(s){var l;for(u=s.length-1;u>=0;--u)o[l=s[u]]=i[l.toUpperCase()]}t=OpenLayers.String.format(a,o)}else{var c=this.version+"/"+this.layer+"/"+this.style+"/";if(s)for(var u=0;u<s.length;u++)i[s[u]]&&(c=c+i[s[u]]+"/");c=c+this.matrixSet+"/"+this.matrix.identifier+"/"+r.row+"/"+r.col+"."+this.formatSuffix;t.match(/\/$/)||(t+="/");t+=c}}else if("KVP"===this.requestEncoding.toUpperCase()){i={SERVICE:"WMTS",REQUEST:"GetTile",VERSION:this.version,LAYER:this.layer,STYLE:this.style,TILEMATRIXSET:this.matrixSet,TILEMATRIX:this.matrix.identifier,TILEROW:r.row,TILECOL:r.col,FORMAT:this.format};t=OpenLayers.Layer.Grid.prototype.getFullRequestString.apply(this,[i])}}return t},mergeNewParams:function(e){if("KVP"===this.requestEncoding.toUpperCase())return OpenLayers.Layer.Grid.prototype.mergeNewParams.apply(this,[OpenLayers.Util.upperCaseObject(e)])},CLASS_NAME:"OpenLayers.Layer.WMTS"});OpenLayers.Events.buttonclick=OpenLayers.Class({target:null,events:["mousedown","mouseup","click","dblclick","touchstart","touchmove","touchend","keydown"],startRegEx:/^mousedown|touchstart$/,cancelRegEx:/^touchmove$/,completeRegEx:/^mouseup|touchend$/,initialize:function(e){this.target=e;for(var t=this.events.length-1;t>=0;--t)this.target.register(this.events[t],this,this.buttonClick,{extension:!0})},destroy:function(){for(var e=this.events.length-1;e>=0;--e)this.target.unregister(this.events[e],this,this.buttonClick);delete this.target},getPressedButton:function(e){var t,i=3;do{if(OpenLayers.Element.hasClass(e,"olButton")){t=e;break}e=e.parentNode}while(--i>0&&e);return t},ignore:function(e){var t=3,i=!1;do{if("a"===e.nodeName.toLowerCase()){i=!0;break}e=e.parentNode}while(--t>0&&e);return i},buttonClick:function(e){var t=!0,i=OpenLayers.Event.element(e);if(i&&(OpenLayers.Event.isLeftClick(e)||!~e.type.indexOf("mouse"))){var n=this.getPressedButton(i);if(n){if("keydown"===e.type)switch(e.keyCode){case OpenLayers.Event.KEY_RETURN:case OpenLayers.Event.KEY_SPACE:this.target.triggerEvent("buttonclick",{buttonElement:n});OpenLayers.Event.stop(e);t=!1}else if(this.startEvt){if(this.completeRegEx.test(e.type)){var r=OpenLayers.Util.pagePosition(n),s=OpenLayers.Util.getViewportElement(),a=window.pageYOffset||s.scrollTop,o=window.pageXOffset||s.scrollLeft;r[0]=r[0]-o;r[1]=r[1]-a;this.target.triggerEvent("buttonclick",{buttonElement:n,buttonXY:{x:this.startEvt.clientX-r[0],y:this.startEvt.clientY-r[1]}})}this.cancelRegEx.test(e.type)&&delete this.startEvt;OpenLayers.Event.stop(e);t=!1}if(this.startRegEx.test(e.type)){this.startEvt=e;OpenLayers.Event.stop(e);t=!1}}else{t=!this.ignore(OpenLayers.Event.element(e));delete this.startEvt}}return t}});OpenLayers.Format=OpenLayers.Class({options:null,externalProjection:null,internalProjection:null,data:null,keepData:!1,initialize:function(e){OpenLayers.Util.extend(this,e);this.options=e},destroy:function(){},read:function(e){throw new Error("Read not implemented.")},write:function(e){throw new Error("Write not implemented.")},CLASS_NAME:"OpenLayers.Format"});OpenLayers.Format.XML=OpenLayers.Class(OpenLayers.Format,{namespaces:null,namespaceAlias:null,defaultPrefix:null,readers:{},writers:{},xmldom:null,initialize:function(e){window.ActiveXObject&&(this.xmldom=new ActiveXObject("Microsoft.XMLDOM"));OpenLayers.Format.prototype.initialize.apply(this,[e]);this.namespaces=OpenLayers.Util.extend({},this.namespaces);this.namespaceAlias={};for(var t in this.namespaces)this.namespaceAlias[this.namespaces[t]]=t},destroy:function(){this.xmldom=null;OpenLayers.Format.prototype.destroy.apply(this,arguments)},setNamespace:function(e,t){this.namespaces[e]=t;this.namespaceAlias[t]=e},read:function(e){var t=e.indexOf("<");t>0&&(e=e.substring(t));var i=OpenLayers.Util.Try(OpenLayers.Function.bind(function(){var t;(t=window.ActiveXObject&&!this.xmldom?new ActiveXObject("Microsoft.XMLDOM"):this.xmldom).loadXML(e);return t},this),function(){return(new DOMParser).parseFromString(e,"text/xml")},function(){var t=new XMLHttpRequest;t.open("GET","data:text/xml;charset=utf-8,"+encodeURIComponent(e),!1);t.overrideMimeType&&t.overrideMimeType("text/xml");t.send(null);return t.responseXML});this.keepData&&(this.data=i);return i},write:function(e){var t;if(this.xmldom)t=e.xml;else{var i=new XMLSerializer;if(1==e.nodeType){var n=document.implementation.createDocument("","",null);n.importNode&&(e=n.importNode(e,!0));n.appendChild(e);t=i.serializeToString(n)}else t=i.serializeToString(e)}return t},createElementNS:function(e,t){return this.xmldom?"string"==typeof e?this.xmldom.createNode(1,t,e):this.xmldom.createNode(1,t,""):document.createElementNS(e,t)},createDocumentFragment:function(){return this.xmldom?this.xmldom.createDocumentFragment():document.createDocumentFragment()},createTextNode:function(e){"string"!=typeof e&&(e=String(e));return this.xmldom?this.xmldom.createTextNode(e):document.createTextNode(e)},getElementsByTagNameNS:function(e,t,i){var n=[];if(e.getElementsByTagNameNS)n=e.getElementsByTagNameNS(t,i);else for(var r,s,a=e.getElementsByTagName("*"),o=0,l=a.length;o<l;++o){s=(r=a[o]).prefix?r.prefix+":"+i:i;"*"!=i&&s!=r.nodeName||"*"!=t&&t!=r.namespaceURI||n.push(r)}return n},getAttributeNodeNS:function(e,t,i){var n=null;if(e.getAttributeNodeNS)n=e.getAttributeNodeNS(t,i);else for(var r,s=e.attributes,a=0,o=s.length;a<o;++a)if((r=s[a]).namespaceURI==t&&(r.prefix?r.prefix+":"+i:i)==r.nodeName){n=r;break}return n},getAttributeNS:function(e,t,i){var n="";if(e.getAttributeNS)n=e.getAttributeNS(t,i)||"";else{var r=this.getAttributeNodeNS(e,t,i);r&&(n=r.nodeValue)}return n},getChildValue:function(e,t){var i=t||"";if(e)for(var n=e.firstChild;n;n=n.nextSibling)switch(n.nodeType){case 3:case 4:i+=n.nodeValue}return i},isSimpleContent:function(e){for(var t=!0,i=e.firstChild;i;i=i.nextSibling)if(1===i.nodeType){t=!1;break}return t},contentType:function(e){for(var t=!1,i=!1,n=OpenLayers.Format.XML.CONTENT_TYPE.EMPTY,r=e.firstChild;r;r=r.nextSibling){switch(r.nodeType){case 1:i=!0;break;case 8:break;default:t=!0}if(i&&t)break}if(i&&t)n=OpenLayers.Format.XML.CONTENT_TYPE.MIXED;else{if(i)return OpenLayers.Format.XML.CONTENT_TYPE.COMPLEX;if(t)return OpenLayers.Format.XML.CONTENT_TYPE.SIMPLE}return n},hasAttributeNS:function(e,t,i){return e.hasAttributeNS?e.hasAttributeNS(t,i):!!this.getAttributeNodeNS(e,t,i)},setAttributeNS:function(e,t,i,n){if(e.setAttributeNS)e.setAttributeNS(t,i,n);else{if(!this.xmldom)throw"setAttributeNS not implemented";if(t){var r=e.ownerDocument.createNode(2,i,t);r.nodeValue=n;e.setAttributeNode(r)}else e.setAttribute(i,n)}},createElementNSPlus:function(e,t){var i=(t=t||{}).uri||this.namespaces[t.prefix];if(!i){var n=e.indexOf(":");i=this.namespaces[e.substring(0,n)]}i||(i=this.namespaces[this.defaultPrefix]);var r=this.createElementNS(i,e);t.attributes&&this.setAttributes(r,t.attributes);var s=t.value;null!=s&&r.appendChild(this.createTextNode(s));return r},setAttributes:function(e,t){var i,n;for(var r in t)if(null!=t[r]&&t[r].toString){i=t[r].toString();n=this.namespaces[r.substring(0,r.indexOf(":"))]||null;this.setAttributeNS(e,n,r,i)}},readNode:function(e,t){t||(t={});var i=this.readers[e.namespaceURI?this.namespaceAlias[e.namespaceURI]:this.defaultPrefix];if(i){var n=i[e.localName||e.nodeName.split(":").pop()]||i["*"];n&&n.apply(this,[e,t])}return t},readChildNodes:function(e,t){t||(t={});for(var i,n=e.childNodes,r=0,s=n.length;r<s;++r)1==(i=n[r]).nodeType&&this.readNode(i,t);return t},writeNode:function(e,t,i){var n,r,s=e.indexOf(":");if(s>0){n=e.substring(0,s);r=e.substring(s+1)}else{n=i?this.namespaceAlias[i.namespaceURI]:this.defaultPrefix;r=e}var a=this.writers[n][r].apply(this,[t]);i&&i.appendChild(a);return a},getChildEl:function(e,t,i){return e&&this.getThisOrNextEl(e.firstChild,t,i)},getNextEl:function(e,t,i){return e&&this.getThisOrNextEl(e.nextSibling,t,i)},getThisOrNextEl:function(e,t,i){e:for(var n=e;n;n=n.nextSibling)switch(n.nodeType){case 1:if(!(t&&t!==(n.localName||n.nodeName.split(":").pop())||i&&i!==n.namespaceURI))break e;n=null;break e;case 3:if(/^\s*$/.test(n.nodeValue))break;case 4:case 6:case 12:case 10:case 11:n=null;break e}return n||null},lookupNamespaceURI:function(e,t){var i=null;if(e)if(e.lookupNamespaceURI)i=e.lookupNamespaceURI(t);else e:switch(e.nodeType){case 1:if(null!==e.namespaceURI&&e.prefix===t){i=e.namespaceURI;break e}var n=e.attributes.length;if(n)for(var r,s=0;s<n;++s){if("xmlns"===(r=e.attributes[s]).prefix&&r.name==="xmlns:"+t){i=r.value||null;break e}if("xmlns"===r.name&&null===t){i=r.value||null;break e}}i=this.lookupNamespaceURI(e.parentNode,t);break e;case 2:i=this.lookupNamespaceURI(e.ownerElement,t);break e;case 9:i=this.lookupNamespaceURI(e.documentElement,t);break e;case 6:case 12:case 10:case 11:break e;default:i=this.lookupNamespaceURI(e.parentNode,t)}return i},getXMLDoc:function(){OpenLayers.Format.XML.document||this.xmldom||(document.implementation&&document.implementation.createDocument?OpenLayers.Format.XML.document=document.implementation.createDocument("","",null):!this.xmldom&&window.ActiveXObject&&(this.xmldom=new ActiveXObject("Microsoft.XMLDOM")));return OpenLayers.Format.XML.document||this.xmldom},CLASS_NAME:"OpenLayers.Format.XML"});OpenLayers.Format.XML.CONTENT_TYPE={EMPTY:0,SIMPLE:1,COMPLEX:2,MIXED:3};OpenLayers.Format.XML.lookupNamespaceURI=OpenLayers.Function.bind(OpenLayers.Format.XML.prototype.lookupNamespaceURI,OpenLayers.Format.XML.prototype);OpenLayers.Format.XML.document=null;OpenLayers.Format.WFST=function(e){e=OpenLayers.Util.applyDefaults(e,OpenLayers.Format.WFST.DEFAULTS);var t=OpenLayers.Format.WFST["v"+e.version.replace(/\./g,"_")];if(!t)throw"Unsupported WFST version: "+e.version;return new t(e)};OpenLayers.Format.WFST.DEFAULTS={version:"1.0.0"};OpenLayers.Feature=OpenLayers.Class({layer:null,id:null,lonlat:null,data:null,marker:null,popupClass:null,popup:null,initialize:function(e,t,i){this.layer=e;this.lonlat=t;this.data=null!=i?i:{};this.id=OpenLayers.Util.createUniqueID(this.CLASS_NAME+"_")},destroy:function(){null!=this.layer&&null!=this.layer.map&&null!=this.popup&&this.layer.map.removePopup(this.popup);null!=this.layer&&null!=this.marker&&this.layer.removeMarker(this.marker);this.layer=null;this.id=null;this.lonlat=null;this.data=null;if(null!=this.marker){this.destroyMarker(this.marker);this.marker=null}if(null!=this.popup){this.destroyPopup(this.popup);this.popup=null}},onScreen:function(){var e=!1;if(null!=this.layer&&null!=this.layer.map){e=this.layer.map.getExtent().containsLonLat(this.lonlat)}return e},createMarker:function(){null!=this.lonlat&&(this.marker=new OpenLayers.Marker(this.lonlat,this.data.icon));return this.marker},destroyMarker:function(){this.marker.destroy()},createPopup:function(e){if(null!=this.lonlat){if(!this.popup){var t=this.marker?this.marker.icon:null,i=this.popupClass?this.popupClass:OpenLayers.Popup.Anchored;this.popup=new i(this.id+"_popup",this.lonlat,this.data.popupSize,this.data.popupContentHTML,t,e)}null!=this.data.overflow&&(this.popup.contentDiv.style.overflow=this.data.overflow);this.popup.feature=this}return this.popup},destroyPopup:function(){if(this.popup){this.popup.feature=null;this.popup.destroy();this.popup=null}},CLASS_NAME:"OpenLayers.Feature"});OpenLayers.State={UNKNOWN:"Unknown",INSERT:"Insert",UPDATE:"Update",DELETE:"Delete"};OpenLayers.Feature.Vector=OpenLayers.Class(OpenLayers.Feature,{fid:null,geometry:null,attributes:null,bounds:null,state:null,style:null,url:null,renderIntent:"default",modified:null,initialize:function(e,t,i){OpenLayers.Feature.prototype.initialize.apply(this,[null,null,t]);this.lonlat=null;this.geometry=e||null;this.state=null;this.attributes={};t&&(this.attributes=OpenLayers.Util.extend(this.attributes,t));this.style=i||null},destroy:function(){if(this.layer){this.layer.removeFeatures(this);this.layer=null}this.geometry=null;this.modified=null;OpenLayers.Feature.prototype.destroy.apply(this,arguments)},clone:function(){return new OpenLayers.Feature.Vector(this.geometry?this.geometry.clone():null,this.attributes,this.style)},onScreen:function(e){var t=!1;if(this.layer&&this.layer.map){var i=this.layer.map.getExtent();if(e){var n=this.geometry.getBounds();t=i.intersectsBounds(n)}else{t=i.toGeometry().intersects(this.geometry)}}return t},getVisibility:function(){return!(this.style&&"none"==this.style.display||!this.layer||this.layer&&this.layer.styleMap&&"none"==this.layer.styleMap.createSymbolizer(this,this.renderIntent).display||this.layer&&!this.layer.getVisibility())},createMarker:function(){return null},destroyMarker:function(){},createPopup:function(){return null},atPoint:function(e,t,i){var n=!1;this.geometry&&(n=this.geometry.atPoint(e,t,i));return n},destroyPopup:function(){},move:function(e){if(this.layer&&this.geometry.move){var t;t="OpenLayers.LonLat"==e.CLASS_NAME?this.layer.getViewPortPxFromLonLat(e):e;var i=this.layer.getViewPortPxFromLonLat(this.geometry.getBounds().getCenterLonLat()),n=this.layer.map.getResolution();this.geometry.move(n*(t.x-i.x),n*(i.y-t.y));this.layer.drawFeature(this);return i}},toState:function(e){if(e==OpenLayers.State.UPDATE)switch(this.state){case OpenLayers.State.UNKNOWN:case OpenLayers.State.DELETE:this.state=e;break;case OpenLayers.State.UPDATE:case OpenLayers.State.INSERT:}else if(e==OpenLayers.State.INSERT)switch(this.state){case OpenLayers.State.UNKNOWN:break;default:this.state=e}else if(e==OpenLayers.State.DELETE)switch(this.state){case OpenLayers.State.INSERT:case OpenLayers.State.DELETE:break;case OpenLayers.State.UNKNOWN:case OpenLayers.State.UPDATE:this.state=e}else e==OpenLayers.State.UNKNOWN&&(this.state=e)},CLASS_NAME:"OpenLayers.Feature.Vector"});OpenLayers.Feature.Vector.style={default:{fillColor:"#ee9900",fillOpacity:.4,hoverFillColor:"white",hoverFillOpacity:.8,strokeColor:"#ee9900",strokeOpacity:1,strokeWidth:1,strokeLinecap:"round",strokeDashstyle:"solid",hoverStrokeColor:"red",hoverStrokeOpacity:1,hoverStrokeWidth:.2,pointRadius:6,hoverPointRadius:1,hoverPointUnit:"%",pointerEvents:"visiblePainted",cursor:"inherit",fontColor:"#000000",labelAlign:"cm",labelOutlineColor:"white",labelOutlineWidth:3},select:{fillColor:"blue",fillOpacity:.4,hoverFillColor:"white",hoverFillOpacity:.8,strokeColor:"blue",strokeOpacity:1,strokeWidth:2,strokeLinecap:"round",strokeDashstyle:"solid",hoverStrokeColor:"red",hoverStrokeOpacity:1,hoverStrokeWidth:.2,pointRadius:6,hoverPointRadius:1,hoverPointUnit:"%",pointerEvents:"visiblePainted",cursor:"pointer",fontColor:"#000000",labelAlign:"cm",labelOutlineColor:"white",labelOutlineWidth:3},temporary:{fillColor:"#66cccc",fillOpacity:.2,hoverFillColor:"white",hoverFillOpacity:.8,strokeColor:"#66cccc",strokeOpacity:1,strokeLinecap:"round",strokeWidth:2,strokeDashstyle:"solid",hoverStrokeColor:"red",hoverStrokeOpacity:1,hoverStrokeWidth:.2,pointRadius:6,hoverPointRadius:1,hoverPointUnit:"%",pointerEvents:"visiblePainted",cursor:"inherit",fontColor:"#000000",labelAlign:"cm",labelOutlineColor:"white",labelOutlineWidth:3},delete:{display:"none"}};OpenLayers.Style=OpenLayers.Class({id:null,name:null,title:null,description:null,layerName:null,isDefault:!1,rules:null,context:null,defaultStyle:null,defaultsPerSymbolizer:!1,propertyStyles:null,initialize:function(e,t){OpenLayers.Util.extend(this,t);this.rules=[];t&&t.rules&&this.addRules(t.rules);this.setDefaultStyle(e||OpenLayers.Feature.Vector.style.default);this.id=OpenLayers.Util.createUniqueID(this.CLASS_NAME+"_")},destroy:function(){for(var e=0,t=this.rules.length;e<t;e++){this.rules[e].destroy();this.rules[e]=null}this.rules=null;this.defaultStyle=null},createSymbolizer:function(e){for(var t,i=this.defaultsPerSymbolizer?{}:this.createLiterals(OpenLayers.Util.extend({},this.defaultStyle),e),n=this.rules,r=[],s=!1,a=0,o=n.length;a<o;a++){if((t=n[a]).evaluate(e))if(t instanceof OpenLayers.Rule&&t.elseFilter)r.push(t);else{s=!0;this.applySymbolizer(t,i,e)}}if(0==s&&r.length>0){s=!0;for(a=0,o=r.length;a<o;a++)this.applySymbolizer(r[a],i,e)}n.length>0&&0==s&&(i.display="none");null!=i.label&&"string"!=typeof i.label&&(i.label=String(i.label));return i},applySymbolizer:function(e,t,i){var n=i.geometry?this.getSymbolizerPrefix(i.geometry):OpenLayers.Style.SYMBOLIZER_PREFIXES[0],r=e.symbolizer[n]||e.symbolizer;if(!0===this.defaultsPerSymbolizer){var s=this.defaultStyle;OpenLayers.Util.applyDefaults(r,{pointRadius:s.pointRadius});!0!==r.stroke&&!0!==r.graphic||OpenLayers.Util.applyDefaults(r,{strokeWidth:s.strokeWidth,strokeColor:s.strokeColor,strokeOpacity:s.strokeOpacity,strokeDashstyle:s.strokeDashstyle,strokeLinecap:s.strokeLinecap});!0!==r.fill&&!0!==r.graphic||OpenLayers.Util.applyDefaults(r,{fillColor:s.fillColor,fillOpacity:s.fillOpacity});!0===r.graphic&&OpenLayers.Util.applyDefaults(r,{pointRadius:this.defaultStyle.pointRadius,externalGraphic:this.defaultStyle.externalGraphic,graphicName:this.defaultStyle.graphicName,graphicOpacity:this.defaultStyle.graphicOpacity,graphicWidth:this.defaultStyle.graphicWidth,graphicHeight:this.defaultStyle.graphicHeight,graphicXOffset:this.defaultStyle.graphicXOffset,graphicYOffset:this.defaultStyle.graphicYOffset})}return this.createLiterals(OpenLayers.Util.extend(t,r),i)},createLiterals:function(e,t){var i=OpenLayers.Util.extend({},t.attributes||t.data);OpenLayers.Util.extend(i,this.context);for(var n in this.propertyStyles)e[n]=OpenLayers.Style.createLiteral(e[n],i,t,n);return e},findPropertyStyles:function(){var e={},t=this.defaultStyle;this.addPropertyStyles(e,t);for(var i,n,r=this.rules,s=0,a=r.length;s<a;s++){i=r[s].symbolizer;for(var o in i){if("object"!=typeof(n=i[o])){this.addPropertyStyles(e,i);break}this.addPropertyStyles(e,n)}}return e},addPropertyStyles:function(e,t){var i;for(var n in t)"string"==typeof(i=t[n])&&i.match(/\$\{\w+\}/)&&(e[n]=!0);return e},addRules:function(e){Array.prototype.push.apply(this.rules,e);this.propertyStyles=this.findPropertyStyles()},setDefaultStyle:function(e){this.defaultStyle=e;this.propertyStyles=this.findPropertyStyles()},getSymbolizerPrefix:function(e){for(var t=OpenLayers.Style.SYMBOLIZER_PREFIXES,i=0,n=t.length;i<n;i++)if(-1!=e.CLASS_NAME.indexOf(t[i]))return t[i]},clone:function(){var e=OpenLayers.Util.extend({},this);if(this.rules){e.rules=[];for(var t=0,i=this.rules.length;t<i;++t)e.rules.push(this.rules[t].clone())}e.context=this.context&&OpenLayers.Util.extend({},this.context);var n=OpenLayers.Util.extend({},this.defaultStyle);return new OpenLayers.Style(n,e)},CLASS_NAME:"OpenLayers.Style"});OpenLayers.Style.createLiteral=function(e,t,i,n){if("string"==typeof e&&-1!=e.indexOf("${")){e=OpenLayers.String.format(e,t,[i,n]);e=isNaN(e)||!e?e:parseFloat(e)}return e};OpenLayers.Style.SYMBOLIZER_PREFIXES=["Point","Line","Polygon","Text","Raster"];OpenLayers.Filter=OpenLayers.Class({initialize:function(e){OpenLayers.Util.extend(this,e)},destroy:function(){},evaluate:function(e){return!0},clone:function(){return null},toString:function(){return OpenLayers.Format&&OpenLayers.Format.CQL?OpenLayers.Format.CQL.prototype.write(this):Object.prototype.toString.call(this)},CLASS_NAME:"OpenLayers.Filter"});OpenLayers.Filter.Spatial=OpenLayers.Class(OpenLayers.Filter,{type:null,property:null,value:null,distance:null,distanceUnits:null,evaluate:function(e){var t=!1;switch(this.type){case OpenLayers.Filter.Spatial.BBOX:case OpenLayers.Filter.Spatial.INTERSECTS:if(e.geometry){var i=this.value;"OpenLayers.Bounds"==this.value.CLASS_NAME&&(i=this.value.toGeometry());e.geometry.intersects(i)&&(t=!0)}break;default:throw new Error("evaluate is not implemented for this filter type.")}return t},clone:function(){var e=OpenLayers.Util.applyDefaults({value:this.value&&this.value.clone&&this.value.clone()},this);return new OpenLayers.Filter.Spatial(e)},CLASS_NAME:"OpenLayers.Filter.Spatial"});OpenLayers.Filter.Spatial.BBOX="BBOX";OpenLayers.Filter.Spatial.INTERSECTS="INTERSECTS";OpenLayers.Filter.Spatial.DWITHIN="DWITHIN";OpenLayers.Filter.Spatial.WITHIN="WITHIN";OpenLayers.Filter.Spatial.CONTAINS="CONTAINS";OpenLayers.Filter.FeatureId=OpenLayers.Class(OpenLayers.Filter,{fids:null,type:"FID",initialize:function(e){this.fids=[];OpenLayers.Filter.prototype.initialize.apply(this,[e])},evaluate:function(e){for(var t=0,i=this.fids.length;t<i;t++){if((e.fid||e.id)==this.fids[t])return!0}return!1},clone:function(){var e=new OpenLayers.Filter.FeatureId;OpenLayers.Util.extend(e,this);e.fids=this.fids.slice();return e},CLASS_NAME:"OpenLayers.Filter.FeatureId"});OpenLayers.Format.WFST.v1=OpenLayers.Class(OpenLayers.Format.XML,{namespaces:{xlink:"http://www.w3.org/1999/xlink",xsi:"http://www.w3.org/2001/XMLSchema-instance",wfs:"http://www.opengis.net/wfs",gml:"http://www.opengis.net/gml",ogc:"http://www.opengis.net/ogc",ows:"http://www.opengis.net/ows"},defaultPrefix:"wfs",version:null,schemaLocations:null,srsName:null,extractAttributes:!0,xy:!0,stateName:null,initialize:function(e){this.stateName={};this.stateName[OpenLayers.State.INSERT]="wfs:Insert";this.stateName[OpenLayers.State.UPDATE]="wfs:Update";this.stateName[OpenLayers.State.DELETE]="wfs:Delete";OpenLayers.Format.XML.prototype.initialize.apply(this,[e])},getSrsName:function(e,t){var i=t&&t.srsName;i||(i=e&&e.layer?e.layer.projection.getCode():this.srsName);return i},read:function(e,t){t=t||{};OpenLayers.Util.applyDefaults(t,{output:"features"});"string"==typeof e&&(e=OpenLayers.Format.XML.prototype.read.apply(this,[e]));e&&9==e.nodeType&&(e=e.documentElement);var i={};e&&this.readNode(e,i,!0);i.features&&"features"===t.output&&(i=i.features);return i},readers:{wfs:{FeatureCollection:function(e,t){t.features=[];this.readChildNodes(e,t)}}},write:function(e,t){var i=this.writeNode("wfs:Transaction",{features:e,options:t}),n=this.schemaLocationAttr();n&&this.setAttributeNS(i,this.namespaces.xsi,"xsi:schemaLocation",n);return OpenLayers.Format.XML.prototype.write.apply(this,[i])},writers:{wfs:{GetFeature:function(e){var t=this.createElementNSPlus("wfs:GetFeature",{attributes:{service:"WFS",version:this.version,handle:e&&e.handle,outputFormat:e&&e.outputFormat,maxFeatures:e&&e.maxFeatures,"xsi:schemaLocation":this.schemaLocationAttr(e)}});if("string"==typeof this.featureType)this.writeNode("Query",e,t);else for(var i=0,n=this.featureType.length;i<n;i++){e.featureType=this.featureType[i];this.writeNode("Query",e,t)}return t},Transaction:function(e){var t,i,n=(e=e||{}).options||{},r=this.createElementNSPlus("wfs:Transaction",{attributes:{service:"WFS",version:this.version,handle:n.handle}}),s=e.features;if(s){!0===n.multi&&OpenLayers.Util.extend(this.geometryTypes,{"OpenLayers.Geometry.Point":"MultiPoint","OpenLayers.Geometry.LineString":!0===this.multiCurve?"MultiCurve":"MultiLineString","OpenLayers.Geometry.Polygon":!0===this.multiSurface?"MultiSurface":"MultiPolygon"});var a,o;for(t=0,i=s.length;t<i;++t){o=s[t];(a=this.stateName[o.state])&&this.writeNode(a,{feature:o,options:n},r)}!0===n.multi&&this.setGeometryTypes()}if(n.nativeElements)for(t=0,i=n.nativeElements.length;t<i;++t)this.writeNode("wfs:Native",n.nativeElements[t],r);return r},Native:function(e){return this.createElementNSPlus("wfs:Native",{attributes:{vendorId:e.vendorId,safeToIgnore:e.safeToIgnore},value:e.value})},Insert:function(e){var t=e.feature,i=e.options,n=this.createElementNSPlus("wfs:Insert",{attributes:{handle:i&&i.handle}});this.srsName=this.getSrsName(t);this.writeNode("feature:_typeName",t,n);return n},Update:function(e){var t=e.feature,i=e.options,n=this.createElementNSPlus("wfs:Update",{attributes:{handle:i&&i.handle,typeName:(this.featureNS?this.featurePrefix+":":"")+this.featureType}});this.featureNS&&n.setAttribute("xmlns:"+this.featurePrefix,this.featureNS);var r=t.modified;if(null!==this.geometryName&&(!r||void 0!==r.geometry)){this.srsName=this.getSrsName(t);this.writeNode("Property",{name:this.geometryName,value:t.geometry},n)}for(var s in t.attributes)void 0===t.attributes[s]||r&&r.attributes&&(!r.attributes||void 0===r.attributes[s])||this.writeNode("Property",{name:s,value:t.attributes[s]},n);this.writeNode("ogc:Filter",new OpenLayers.Filter.FeatureId({fids:[t.fid]}),n);return n},Property:function(e){var t=this.createElementNSPlus("wfs:Property");this.writeNode("Name",e.name,t);null!==e.value&&this.writeNode("Value",e.value,t);return t},Name:function(e){return this.createElementNSPlus("wfs:Name",{value:e})},Value:function(e){var t;if(e instanceof OpenLayers.Geometry){t=this.createElementNSPlus("wfs:Value");var i=this.writeNode("feature:_geometry",e).firstChild;t.appendChild(i)}else t=this.createElementNSPlus("wfs:Value",{value:e});return t},Delete:function(e){var t=e.feature,i=e.options,n=this.createElementNSPlus("wfs:Delete",{attributes:{handle:i&&i.handle,typeName:(this.featureNS?this.featurePrefix+":":"")+this.featureType}});this.featureNS&&n.setAttribute("xmlns:"+this.featurePrefix,this.featureNS);this.writeNode("ogc:Filter",new OpenLayers.Filter.FeatureId({fids:[t.fid]}),n);return n}}},schemaLocationAttr:function(e){e=OpenLayers.Util.extend({featurePrefix:this.featurePrefix,schema:this.schema},e);var t=OpenLayers.Util.extend({},this.schemaLocations);e.schema&&(t[e.featurePrefix]=e.schema);var i,n=[];for(var r in t)(i=this.namespaces[r])&&n.push(i+" "+t[r]);return n.join(" ")||void 0},setFilterProperty:function(e){if(e.filters)for(var t=0,i=e.filters.length;t<i;++t)OpenLayers.Format.WFST.v1.prototype.setFilterProperty.call(this,e.filters[t]);else e instanceof OpenLayers.Filter.Spatial&&!e.property&&(e.property=this.geometryName)},CLASS_NAME:"OpenLayers.Format.WFST.v1"});OpenLayers.Format.OGCExceptionReport=OpenLayers.Class(OpenLayers.Format.XML,{namespaces:{ogc:"http://www.opengis.net/ogc"},regExes:{trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g},defaultPrefix:"ogc",read:function(e){"string"==typeof e&&(e=OpenLayers.Format.XML.prototype.read.apply(this,[e]));var t={exceptionReport:null};if(e.documentElement){this.readChildNodes(e,t);null===t.exceptionReport&&(t=(new OpenLayers.Format.OWSCommon).read(e))}return t},readers:{ogc:{ServiceExceptionReport:function(e,t){t.exceptionReport={exceptions:[]};this.readChildNodes(e,t.exceptionReport)},ServiceException:function(e,t){var i={code:e.getAttribute("code"),locator:e.getAttribute("locator"),text:this.getChildValue(e)};t.exceptions.push(i)}}},CLASS_NAME:"OpenLayers.Format.OGCExceptionReport"});OpenLayers.Format.XML.VersionedOGC=OpenLayers.Class(OpenLayers.Format.XML,{defaultVersion:null,version:null,profile:null,allowFallback:!1,name:null,stringifyOutput:!1,parser:null,initialize:function(e){OpenLayers.Format.XML.prototype.initialize.apply(this,[e]);var t=this.CLASS_NAME;this.name=t.substring(t.lastIndexOf(".")+1)},getVersion:function(e,t){var i;e?(i=this.version)||(i=e.getAttribute("version"))||(i=this.defaultVersion):i=t&&t.version||this.version||this.defaultVersion;return i},getParser:function(e){e=e||this.defaultVersion;var t=this.profile?"_"+this.profile:"";if(!this.parser||this.parser.VERSION!=e){var i=OpenLayers.Format[this.name]["v"+e.replace(/\./g,"_")+t];if(!i){if(""!==t&&this.allowFallback){t="";i=OpenLayers.Format[this.name]["v"+e.replace(/\./g,"_")]}if(!i)throw"Can't find a "+this.name+" parser for version "+e+t}this.parser=new i(this.options)}return this.parser},write:function(e,t){var i=this.getVersion(null,t);this.parser=this.getParser(i);var n=this.parser.write(e,t);return!1===this.stringifyOutput?n:OpenLayers.Format.XML.prototype.write.apply(this,[n])},read:function(e,t){"string"==typeof e&&(e=OpenLayers.Format.XML.prototype.read.apply(this,[e]));var i=e.documentElement,n=this.getVersion(i);this.parser=this.getParser(n);var r=this.parser.read(e,t),s=this.parser.errorProperty||null;if(null!==s&&void 0===r[s]){var a=new OpenLayers.Format.OGCExceptionReport;r.error=a.read(e)}r.version=n;return r},CLASS_NAME:"OpenLayers.Format.XML.VersionedOGC"});OpenLayers.Filter.Logical=OpenLayers.Class(OpenLayers.Filter,{filters:null,type:null,initialize:function(e){this.filters=[];OpenLayers.Filter.prototype.initialize.apply(this,[e])},destroy:function(){this.filters=null;OpenLayers.Filter.prototype.destroy.apply(this)},evaluate:function(e){var t,i;switch(this.type){case OpenLayers.Filter.Logical.AND:for(t=0,i=this.filters.length;t<i;t++)if(0==this.filters[t].evaluate(e))return!1;return!0;case OpenLayers.Filter.Logical.OR:for(t=0,i=this.filters.length;t<i;t++)if(1==this.filters[t].evaluate(e))return!0;return!1;case OpenLayers.Filter.Logical.NOT:return!this.filters[0].evaluate(e)}},clone:function(){for(var e=[],t=0,i=this.filters.length;t<i;++t)e.push(this.filters[t].clone());return new OpenLayers.Filter.Logical({type:this.type,filters:e})},CLASS_NAME:"OpenLayers.Filter.Logical"});OpenLayers.Filter.Logical.AND="&&";OpenLayers.Filter.Logical.OR="||";OpenLayers.Filter.Logical.NOT="!";OpenLayers.Filter.Comparison=OpenLayers.Class(OpenLayers.Filter,{type:null,property:null,value:null,matchCase:!0,lowerBoundary:null,upperBoundary:null,initialize:function(e){OpenLayers.Filter.prototype.initialize.apply(this,[e]);this.type===OpenLayers.Filter.Comparison.LIKE&&void 0===e.matchCase&&(this.matchCase=null)},evaluate:function(e){e instanceof OpenLayers.Feature.Vector&&(e=e.attributes);var t,i=!1,n=e[this.property];switch(this.type){case OpenLayers.Filter.Comparison.EQUAL_TO:t=this.value;i=this.matchCase||"string"!=typeof n||"string"!=typeof t?n==t:n.toUpperCase()==t.toUpperCase();break;case OpenLayers.Filter.Comparison.NOT_EQUAL_TO:t=this.value;i=this.matchCase||"string"!=typeof n||"string"!=typeof t?n!=t:n.toUpperCase()!=t.toUpperCase();break;case OpenLayers.Filter.Comparison.LESS_THAN:i=n<this.value;break;case OpenLayers.Filter.Comparison.GREATER_THAN:i=n>this.value;break;case OpenLayers.Filter.Comparison.LESS_THAN_OR_EQUAL_TO:i=n<=this.value;break;case OpenLayers.Filter.Comparison.GREATER_THAN_OR_EQUAL_TO:i=n>=this.value;break;case OpenLayers.Filter.Comparison.BETWEEN:i=n>=this.lowerBoundary&&n<=this.upperBoundary;break;case OpenLayers.Filter.Comparison.LIKE:i=new RegExp(this.value,"gi").test(n);break;case OpenLayers.Filter.Comparison.IS_NULL:i=null===n}return i},value2regex:function(e,t,i){if("."==e)throw new Error("'.' is an unsupported wildCard character for OpenLayers.Filter.Comparison");e=e||"*";t=t||".";i=i||"!";this.value=this.value.replace(new RegExp("\\"+i+"(.|$)","g"),"\\$1");this.value=this.value.replace(new RegExp("\\"+t,"g"),".");this.value=this.value.replace(new RegExp("\\"+e,"g"),".*");this.value=this.value.replace(new RegExp("\\\\.\\*","g"),"\\"+e);this.value=this.value.replace(new RegExp("\\\\\\.","g"),"\\"+t);return this.value},regex2value:function(){var e=this.value;return e=(e=(e=(e=(e=e.replace(/!/g,"!!")).replace(/(\\)?\\\./g,function(e,t){return t?e:"!."})).replace(/(\\)?\\\*/g,function(e,t){return t?e:"!*"})).replace(/\\\\/g,"\\")).replace(/\.\*/g,"*")},clone:function(){return OpenLayers.Util.extend(new OpenLayers.Filter.Comparison,this)},CLASS_NAME:"OpenLayers.Filter.Comparison"});OpenLayers.Filter.Comparison.EQUAL_TO="==";OpenLayers.Filter.Comparison.NOT_EQUAL_TO="!=";OpenLayers.Filter.Comparison.LESS_THAN="<";OpenLayers.Filter.Comparison.GREATER_THAN=">";OpenLayers.Filter.Comparison.LESS_THAN_OR_EQUAL_TO="<=";OpenLayers.Filter.Comparison.GREATER_THAN_OR_EQUAL_TO=">=";OpenLayers.Filter.Comparison.BETWEEN="..";OpenLayers.Filter.Comparison.LIKE="~";OpenLayers.Filter.Comparison.IS_NULL="NULL";OpenLayers.Format.Filter=OpenLayers.Class(OpenLayers.Format.XML.VersionedOGC,{defaultVersion:"1.0.0",CLASS_NAME:"OpenLayers.Format.Filter"});OpenLayers.Filter.Function=OpenLayers.Class(OpenLayers.Filter,{name:null,params:null,CLASS_NAME:"OpenLayers.Filter.Function"});OpenLayers.Date={dateRegEx:/^(?:(\d{4})(?:-(\d{2})(?:-(\d{2}))?)?)?(?:(?:T(\d{1,2}):(\d{2}):(\d{2}(?:\.\d+)?)(Z|(?:[+-]\d{1,2}(?::(\d{2}))?)))|Z)?$/,toISOString:"toISOString"in Date.prototype?function(e){return e.toISOString()}:function(e){return isNaN(e.getTime())?"Invalid Date":e.getUTCFullYear()+"-"+OpenLayers.Number.zeroPad(e.getUTCMonth()+1,2)+"-"+OpenLayers.Number.zeroPad(e.getUTCDate(),2)+"T"+OpenLayers.Number.zeroPad(e.getUTCHours(),2)+":"+OpenLayers.Number.zeroPad(e.getUTCMinutes(),2)+":"+OpenLayers.Number.zeroPad(e.getUTCSeconds(),2)+"."+OpenLayers.Number.zeroPad(e.getUTCMilliseconds(),3)+"Z"},parse:function(e){var t,i=e.match(this.dateRegEx);if(i&&(i[1]||i[7])){var n=parseInt(i[1],10)||0,r=parseInt(i[2],10)-1||0,s=parseInt(i[3],10)||1;t=new Date(Date.UTC(n,r,s));var a=i[7];if(a){var o=parseInt(i[4],10),l=parseInt(i[5],10),c=parseFloat(i[6]),u=0|c,h=Math.round(1e3*(c-u));t.setUTCHours(o,l,u,h);if("Z"!==a){var p=-1e3*(60*parseInt(a,10)*60+60*(parseInt(i[8],10)||0));t=new Date(t.getTime()+p)}}}else t=new Date("invalid");return t}};OpenLayers.Format.Filter.v1=OpenLayers.Class(OpenLayers.Format.XML,{namespaces:{ogc:"http://www.opengis.net/ogc",gml:"http://www.opengis.net/gml",xlink:"http://www.w3.org/1999/xlink",xsi:"http://www.w3.org/2001/XMLSchema-instance"},defaultPrefix:"ogc",schemaLocation:null,initialize:function(e){OpenLayers.Format.XML.prototype.initialize.apply(this,[e])},read:function(e){var t={};this.readers.ogc.Filter.apply(this,[e,t]);return t.filter},readers:{ogc:{_expression:function(e){for(var t,i="",n=e.firstChild;n;n=n.nextSibling)switch(n.nodeType){case 1:(t=this.readNode(n)).property?i+="${"+t.property+"}":void 0!==t.value&&(i+=t.value);break;case 3:case 4:i+=n.nodeValue}return i},Filter:function(e,t){var i={fids:[],filters:[]};this.readChildNodes(e,i);i.fids.length>0?t.filter=new OpenLayers.Filter.FeatureId({fids:i.fids}):i.filters.length>0&&(t.filter=i.filters[0])},FeatureId:function(e,t){var i=e.getAttribute("fid");i&&t.fids.push(i)},And:function(e,t){var i=new OpenLayers.Filter.Logical({type:OpenLayers.Filter.Logical.AND});this.readChildNodes(e,i);t.filters.push(i)},Or:function(e,t){var i=new OpenLayers.Filter.Logical({type:OpenLayers.Filter.Logical.OR});this.readChildNodes(e,i);t.filters.push(i)},Not:function(e,t){var i=new OpenLayers.Filter.Logical({type:OpenLayers.Filter.Logical.NOT});this.readChildNodes(e,i);t.filters.push(i)},PropertyIsLessThan:function(e,t){var i=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.LESS_THAN});this.readChildNodes(e,i);t.filters.push(i)},PropertyIsGreaterThan:function(e,t){var i=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.GREATER_THAN});this.readChildNodes(e,i);t.filters.push(i)},PropertyIsLessThanOrEqualTo:function(e,t){var i=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.LESS_THAN_OR_EQUAL_TO});this.readChildNodes(e,i);t.filters.push(i)},PropertyIsGreaterThanOrEqualTo:function(e,t){var i=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.GREATER_THAN_OR_EQUAL_TO});this.readChildNodes(e,i);t.filters.push(i)},PropertyIsBetween:function(e,t){var i=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.BETWEEN});this.readChildNodes(e,i);t.filters.push(i)},Literal:function(e,t){t.value=OpenLayers.String.numericIf(this.getChildValue(e),!0)},PropertyName:function(e,t){t.property=this.getChildValue(e)},LowerBoundary:function(e,t){t.lowerBoundary=OpenLayers.String.numericIf(this.readers.ogc._expression.call(this,e),!0)},UpperBoundary:function(e,t){t.upperBoundary=OpenLayers.String.numericIf(this.readers.ogc._expression.call(this,e),!0)},Intersects:function(e,t){this.readSpatial(e,t,OpenLayers.Filter.Spatial.INTERSECTS)},Within:function(e,t){this.readSpatial(e,t,OpenLayers.Filter.Spatial.WITHIN)},Contains:function(e,t){this.readSpatial(e,t,OpenLayers.Filter.Spatial.CONTAINS)},DWithin:function(e,t){this.readSpatial(e,t,OpenLayers.Filter.Spatial.DWITHIN)},Distance:function(e,t){t.distance=parseInt(this.getChildValue(e));t.distanceUnits=e.getAttribute("units")},Function:function(e,t){},PropertyIsNull:function(e,t){var i=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.IS_NULL});this.readChildNodes(e,i);t.filters.push(i)}}},readSpatial:function(e,t,i){var n=new OpenLayers.Filter.Spatial({type:i});this.readChildNodes(e,n);n.value=n.components[0];delete n.components;t.filters.push(n)},encodeLiteral:function(e){e instanceof Date&&(e=OpenLayers.Date.toISOString(e));return e},writeOgcExpression:function(e,t){e instanceof OpenLayers.Filter.Function?this.writeNode("Function",e,t):this.writeNode("Literal",e,t);return t},write:function(e){return this.writers.ogc.Filter.apply(this,[e])},writers:{ogc:{Filter:function(e){var t=this.createElementNSPlus("ogc:Filter");this.writeNode(this.getFilterType(e),e,t);return t},_featureIds:function(e){for(var t=this.createDocumentFragment(),i=0,n=e.fids.length;i<n;++i)this.writeNode("ogc:FeatureId",e.fids[i],t);return t},FeatureId:function(e){return this.createElementNSPlus("ogc:FeatureId",{attributes:{fid:e}})},And:function(e){for(var t,i=this.createElementNSPlus("ogc:And"),n=0,r=e.filters.length;n<r;++n){t=e.filters[n];this.writeNode(this.getFilterType(t),t,i)}return i},Or:function(e){for(var t,i=this.createElementNSPlus("ogc:Or"),n=0,r=e.filters.length;n<r;++n){t=e.filters[n];this.writeNode(this.getFilterType(t),t,i)}return i},Not:function(e){var t=this.createElementNSPlus("ogc:Not"),i=e.filters[0];this.writeNode(this.getFilterType(i),i,t);return t},PropertyIsLessThan:function(e){var t=this.createElementNSPlus("ogc:PropertyIsLessThan");this.writeNode("PropertyName",e,t);this.writeOgcExpression(e.value,t);return t},PropertyIsGreaterThan:function(e){var t=this.createElementNSPlus("ogc:PropertyIsGreaterThan");this.writeNode("PropertyName",e,t);this.writeOgcExpression(e.value,t);return t},PropertyIsLessThanOrEqualTo:function(e){var t=this.createElementNSPlus("ogc:PropertyIsLessThanOrEqualTo");this.writeNode("PropertyName",e,t);this.writeOgcExpression(e.value,t);return t},PropertyIsGreaterThanOrEqualTo:function(e){var t=this.createElementNSPlus("ogc:PropertyIsGreaterThanOrEqualTo");this.writeNode("PropertyName",e,t);this.writeOgcExpression(e.value,t);return t},PropertyIsBetween:function(e){var t=this.createElementNSPlus("ogc:PropertyIsBetween");this.writeNode("PropertyName",e,t);this.writeNode("LowerBoundary",e,t);this.writeNode("UpperBoundary",e,t);return t},PropertyName:function(e){return this.createElementNSPlus("ogc:PropertyName",{value:e.property})},Literal:function(e){var t=this.encodeLiteral||OpenLayers.Format.Filter.v1.prototype.encodeLiteral;return this.createElementNSPlus("ogc:Literal",{value:t(e)})},LowerBoundary:function(e){var t=this.createElementNSPlus("ogc:LowerBoundary");this.writeOgcExpression(e.lowerBoundary,t);return t},UpperBoundary:function(e){var t=this.createElementNSPlus("ogc:UpperBoundary");this.writeNode("Literal",e.upperBoundary,t);return t},INTERSECTS:function(e){return this.writeSpatial(e,"Intersects")},WITHIN:function(e){return this.writeSpatial(e,"Within")},CONTAINS:function(e){return this.writeSpatial(e,"Contains")},DWITHIN:function(e){var t=this.writeSpatial(e,"DWithin");this.writeNode("Distance",e,t);return t},Distance:function(e){return this.createElementNSPlus("ogc:Distance",{attributes:{units:e.distanceUnits},value:e.distance})},Function:function(e){for(var t=this.createElementNSPlus("ogc:Function",{attributes:{name:e.name}}),i=e.params,n=0,r=i.length;n<r;n++)this.writeOgcExpression(i[n],t);return t},PropertyIsNull:function(e){var t=this.createElementNSPlus("ogc:PropertyIsNull");this.writeNode("PropertyName",e,t);return t}}},getFilterType:function(e){var t=this.filterMap[e.type];if(!t)throw"Filter writing not supported for rule type: "+e.type;return t},filterMap:{"&&":"And","||":"Or","!":"Not","==":"PropertyIsEqualTo","!=":"PropertyIsNotEqualTo","<":"PropertyIsLessThan",">":"PropertyIsGreaterThan","<=":"PropertyIsLessThanOrEqualTo",">=":"PropertyIsGreaterThanOrEqualTo","..":"PropertyIsBetween","~":"PropertyIsLike",NULL:"PropertyIsNull",BBOX:"BBOX",DWITHIN:"DWITHIN",WITHIN:"WITHIN",CONTAINS:"CONTAINS",INTERSECTS:"INTERSECTS",FID:"_featureIds"},CLASS_NAME:"OpenLayers.Format.Filter.v1"});OpenLayers.Geometry=OpenLayers.Class({id:null,parent:null,bounds:null,initialize:function(){this.id=OpenLayers.Util.createUniqueID(this.CLASS_NAME+"_")},destroy:function(){this.id=null;this.bounds=null},clone:function(){return new OpenLayers.Geometry},setBounds:function(e){e&&(this.bounds=e.clone())},clearBounds:function(){this.bounds=null;this.parent&&this.parent.clearBounds()},extendBounds:function(e){this.getBounds()?this.bounds.extend(e):this.setBounds(e)},getBounds:function(){null==this.bounds&&this.calculateBounds();return this.bounds},calculateBounds:function(){},distanceTo:function(e,t){},getVertices:function(e){},atPoint:function(e,t,i){var n=!1;if(null!=this.getBounds()&&null!=e){var r=null!=t?t:0,s=null!=i?i:0;n=new OpenLayers.Bounds(this.bounds.left-r,this.bounds.bottom-s,this.bounds.right+r,this.bounds.top+s).containsLonLat(e)}return n},getLength:function(){return 0},getArea:function(){return 0},getCentroid:function(){return null},toString:function(){return OpenLayers.Format&&OpenLayers.Format.WKT?OpenLayers.Format.WKT.prototype.write(new OpenLayers.Feature.Vector(this)):Object.prototype.toString.call(this)},CLASS_NAME:"OpenLayers.Geometry"});OpenLayers.Geometry.fromWKT=function(e){var t;if(OpenLayers.Format&&OpenLayers.Format.WKT){var i=OpenLayers.Geometry.fromWKT.format;if(!i){i=new OpenLayers.Format.WKT;OpenLayers.Geometry.fromWKT.format=i}var n=i.read(e);if(n instanceof OpenLayers.Feature.Vector)t=n.geometry;else if(OpenLayers.Util.isArray(n)){for(var r=n.length,s=new Array(r),a=0;a<r;++a)s[a]=n[a].geometry;t=new OpenLayers.Geometry.Collection(s)}}return t};OpenLayers.Geometry.segmentsIntersect=function(e,t,i){var n=i&&i.point,r=i&&i.tolerance,s=!1,a=e.x1-t.x1,o=e.y1-t.y1,l=e.x2-e.x1,c=e.y2-e.y1,u=t.y2-t.y1,h=t.x2-t.x1,p=u*l-h*c,d=h*o-u*a,f=l*o-c*a;if(0==p)0==d&&0==f&&(s=!0);else{var m=d/p,y=f/p;if(m>=0&&m<=1&&y>=0&&y<=1)if(n){var g=e.x1+m*l,C=e.y1+m*c;s=new OpenLayers.Geometry.Point(g,C)}else s=!0}if(r){if(s){if(n){var v,T=[e,t];e:for(var L=0;L<2;++L){v=T[L];for(var w=1;w<3;++w){g=v["x"+w];C=v["y"+w];if(Math.sqrt(Math.pow(g-s.x,2)+Math.pow(C-s.y,2))<r){s.x=g;s.y=C;break e}}}}}else{var b,S,E;T=[e,t];e:for(L=0;L<2;++L){b=T[L];S=T[(L+1)%2];for(w=1;w<3;++w){E={x:b["x"+w],y:b["y"+w]};if(OpenLayers.Geometry.distanceToSegment(E,S).distance<r){s=!n||new OpenLayers.Geometry.Point(E.x,E.y);break e}}}}}return s};OpenLayers.Geometry.distanceToSegment=function(e,t){var i=OpenLayers.Geometry.distanceSquaredToSegment(e,t);i.distance=Math.sqrt(i.distance);return i};OpenLayers.Geometry.distanceSquaredToSegment=function(e,t){var i,n,r=e.x,s=e.y,a=t.x1,o=t.y1,l=t.x2,c=t.y2,u=l-a,h=c-o,p=(u*(r-a)+h*(s-o))/(Math.pow(u,2)+Math.pow(h,2));if(p<=0){i=a;n=o}else if(p>=1){i=l;n=c}else{i=a+p*u;n=o+p*h}return{distance:Math.pow(i-r,2)+Math.pow(n-s,2),x:i,y:n,along:p}};OpenLayers.Geometry.Point=OpenLayers.Class(OpenLayers.Geometry,{x:null,y:null,initialize:function(e,t){OpenLayers.Geometry.prototype.initialize.apply(this,arguments);this.x=parseFloat(e);this.y=parseFloat(t)},clone:function(e){null==e&&(e=new OpenLayers.Geometry.Point(this.x,this.y));OpenLayers.Util.applyDefaults(e,this);return e},calculateBounds:function(){this.bounds=new OpenLayers.Bounds(this.x,this.y,this.x,this.y)},distanceTo:function(e,t){var i,n,r,s,a,o,l=!(t&&!1===t.edge)&&t&&t.details;if(e instanceof OpenLayers.Geometry.Point){n=this.x;r=this.y;s=e.x;a=e.y;i=Math.sqrt(Math.pow(n-s,2)+Math.pow(r-a,2));o=l?{x0:n,y0:r,x1:s,y1:a,distance:i}:i}else{o=e.distanceTo(this,t);l&&(o={x0:o.x1,y0:o.y1,x1:o.x0,y1:o.y0,distance:o.distance})}return o},equals:function(e){var t=!1;null!=e&&(t=this.x==e.x&&this.y==e.y||isNaN(this.x)&&isNaN(this.y)&&isNaN(e.x)&&isNaN(e.y));return t},toShortString:function(){return this.x+", "+this.y},move:function(e,t){this.x=this.x+e;this.y=this.y+t;this.clearBounds()},rotate:function(e,t){e*=Math.PI/180;var i=this.distanceTo(t),n=e+Math.atan2(this.y-t.y,this.x-t.x);this.x=t.x+i*Math.cos(n);this.y=t.y+i*Math.sin(n);this.clearBounds()},getCentroid:function(){return new OpenLayers.Geometry.Point(this.x,this.y)},resize:function(e,t,i){i=void 0==i?1:i;this.x=t.x+e*i*(this.x-t.x);this.y=t.y+e*(this.y-t.y);this.clearBounds();return this},intersects:function(e){return"OpenLayers.Geometry.Point"==e.CLASS_NAME?this.equals(e):e.intersects(this)},transform:function(e,t){if(e&&t){OpenLayers.Projection.transform(this,e,t);this.bounds=null}return this},getVertices:function(e){return[this]},CLASS_NAME:"OpenLayers.Geometry.Point"});OpenLayers.Geometry.Collection=OpenLayers.Class(OpenLayers.Geometry,{components:null,componentTypes:null,initialize:function(e){OpenLayers.Geometry.prototype.initialize.apply(this,arguments);this.components=[];null!=e&&this.addComponents(e)},destroy:function(){this.components.length=0;this.components=null;OpenLayers.Geometry.prototype.destroy.apply(this,arguments)},clone:function(){for(var geometry=eval("new "+this.CLASS_NAME+"()"),i=0,len=this.components.length;i<len;i++)geometry.addComponent(this.components[i].clone());OpenLayers.Util.applyDefaults(geometry,this);return geometry},getComponentsString:function(){for(var e=[],t=0,i=this.components.length;t<i;t++)e.push(this.components[t].toShortString());return e.join(",")},calculateBounds:function(){this.bounds=null;var e=new OpenLayers.Bounds,t=this.components;if(t)for(var i=0,n=t.length;i<n;i++)e.extend(t[i].getBounds());null!=e.left&&null!=e.bottom&&null!=e.right&&null!=e.top&&this.setBounds(e)},addComponents:function(e){OpenLayers.Util.isArray(e)||(e=[e]);for(var t=0,i=e.length;t<i;t++)this.addComponent(e[t])},addComponent:function(e,t){var i=!1;if(e&&(null==this.componentTypes||OpenLayers.Util.indexOf(this.componentTypes,e.CLASS_NAME)>-1)){if(null!=t&&t<this.components.length){var n=this.components.slice(0,t),r=this.components.slice(t,this.components.length);n.push(e);this.components=n.concat(r)}else this.components.push(e);e.parent=this;this.clearBounds();i=!0}return i},removeComponents:function(e){var t=!1;OpenLayers.Util.isArray(e)||(e=[e]);for(var i=e.length-1;i>=0;--i)t=this.removeComponent(e[i])||t;return t},removeComponent:function(e){OpenLayers.Util.removeItem(this.components,e);this.clearBounds();return!0},getLength:function(){for(var e=0,t=0,i=this.components.length;t<i;t++)e+=this.components[t].getLength();return e},getArea:function(){for(var e=0,t=0,i=this.components.length;t<i;t++)e+=this.components[t].getArea();return e},getGeodesicArea:function(e){for(var t=0,i=0,n=this.components.length;i<n;i++)t+=this.components[i].getGeodesicArea(e);return t},getCentroid:function(e){if(!e)return this.components.length&&this.components[0].getCentroid();var t=this.components.length;if(!t)return!1;for(var i,n=[],r=[],s=0,a=Number.MAX_VALUE,o=0;o<t;++o){var l=(i=this.components[o]).getArea(),c=i.getCentroid(!0);if(!(isNaN(l)||isNaN(c.x)||isNaN(c.y))){n.push(l);s+=l;a=l<a&&l>0?l:a;r.push(c)}}t=n.length;if(0===s){for(o=0;o<t;++o)n[o]=1;s=n.length}else{for(o=0;o<t;++o)n[o]/=a;s/=a}var u=0,h=0;for(o=0;o<t;++o){c=r[o];l=n[o];u+=c.x*l;h+=c.y*l}return new OpenLayers.Geometry.Point(u/s,h/s)},getGeodesicLength:function(e){for(var t=0,i=0,n=this.components.length;i<n;i++)t+=this.components[i].getGeodesicLength(e);return t},move:function(e,t){for(var i=0,n=this.components.length;i<n;i++)this.components[i].move(e,t)},rotate:function(e,t){for(var i=0,n=this.components.length;i<n;++i)this.components[i].rotate(e,t)},resize:function(e,t,i){for(var n=0;n<this.components.length;++n)this.components[n].resize(e,t,i);return this},distanceTo:function(e,t){for(var i,n,r,s=!(t&&!1===t.edge)&&t&&t.details,a=Number.POSITIVE_INFINITY,o=0,l=this.components.length;o<l;++o){i=this.components[o].distanceTo(e,t);if((r=s?i.distance:i)<a){n=i;if(0==(a=r))break}}return n},equals:function(e){var t=!0;if(e&&e.CLASS_NAME&&this.CLASS_NAME==e.CLASS_NAME)if(OpenLayers.Util.isArray(e.components)&&e.components.length==this.components.length){for(var i=0,n=this.components.length;i<n;++i)if(!this.components[i].equals(e.components[i])){t=!1;break}}else t=!1;else t=!1;return t},transform:function(e,t){if(e&&t){for(var i=0,n=this.components.length;i<n;i++){this.components[i].transform(e,t)}this.bounds=null}return this},intersects:function(e){for(var t=!1,i=0,n=this.components.length;i<n&&!(t=e.intersects(this.components[i]));++i);return t},getVertices:function(e){for(var t=[],i=0,n=this.components.length;i<n;++i)Array.prototype.push.apply(t,this.components[i].getVertices(e));return t},CLASS_NAME:"OpenLayers.Geometry.Collection"});OpenLayers.Geometry.MultiPoint=OpenLayers.Class(OpenLayers.Geometry.Collection,{componentTypes:["OpenLayers.Geometry.Point"],addPoint:function(e,t){this.addComponent(e,t)},removePoint:function(e){this.removeComponent(e)},CLASS_NAME:"OpenLayers.Geometry.MultiPoint"});OpenLayers.Geometry.Curve=OpenLayers.Class(OpenLayers.Geometry.MultiPoint,{componentTypes:["OpenLayers.Geometry.Point"],getLength:function(){var e=0;if(this.components&&this.components.length>1)for(var t=1,i=this.components.length;t<i;t++)e+=this.components[t-1].distanceTo(this.components[t]);return e},getGeodesicLength:function(e){var t=this;if(e){var i=new OpenLayers.Projection("EPSG:4326");i.equals(e)||(t=this.clone().transform(e,i))}var n=0;if(t.components&&t.components.length>1)for(var r,s,a=1,o=t.components.length;a<o;a++){r=t.components[a-1];s=t.components[a];n+=OpenLayers.Util.distVincenty({lon:r.x,lat:r.y},{lon:s.x,lat:s.y})}return 1e3*n},CLASS_NAME:"OpenLayers.Geometry.Curve"});OpenLayers.Geometry.LineString=OpenLayers.Class(OpenLayers.Geometry.Curve,{removeComponent:function(e){var t=this.components&&this.components.length>2;t&&OpenLayers.Geometry.Collection.prototype.removeComponent.apply(this,arguments);return t},intersects:function(e){var t=!1,i=e.CLASS_NAME;if("OpenLayers.Geometry.LineString"==i||"OpenLayers.Geometry.LinearRing"==i||"OpenLayers.Geometry.Point"==i){var n,r,s,a,o,l,c,u,h,p=this.getSortedSegments();n="OpenLayers.Geometry.Point"==i?[{x1:e.x,y1:e.y,x2:e.x,y2:e.y}]:e.getSortedSegments();e:for(var d=0,f=p.length;d<f;++d){s=(r=p[d]).x1;a=r.x2;o=r.y1;l=r.y2;for(var m=0,y=n.length;m<y&&!((c=n[m]).x1>a);++m)if(!(c.x2<s)){u=c.y1;h=c.y2;if(!(Math.min(u,h)>Math.max(o,l))&&!(Math.max(u,h)<Math.min(o,l))&&OpenLayers.Geometry.segmentsIntersect(r,c)){t=!0;break e}}}}else t=e.intersects(this);return t},getSortedSegments:function(){for(var e,t,i=this.components.length-1,n=new Array(i),r=0;r<i;++r){e=this.components[r];t=this.components[r+1];e.x<t.x?n[r]={x1:e.x,y1:e.y,x2:t.x,y2:t.y}:n[r]={x1:t.x,y1:t.y,x2:e.x,y2:e.y}}return n.sort(function(e,t){return e.x1-t.x1})},splitWithSegment:function(e,t){for(var i,n,r,s,a=!(t&&!1===t.edge),o=t&&t.tolerance,l=[],c=this.getVertices(),u=[],h=[],p=!1,d={point:!0,tolerance:o},f=null,m=0,y=c.length-2;m<=y;++m){i=c[m];u.push(i.clone());n=c[m+1];s={x1:i.x,y1:i.y,x2:n.x,y2:n.y};if((r=OpenLayers.Geometry.segmentsIntersect(e,s,d))instanceof OpenLayers.Geometry.Point&&(!!(r.x===e.x1&&r.y===e.y1||r.x===e.x2&&r.y===e.y2||r.equals(i)||r.equals(n))||a)){r.equals(h[h.length-1])||h.push(r.clone());if(0===m&&r.equals(i))continue;if(r.equals(n))continue;p=!0;r.equals(i)||u.push(r);l.push(new OpenLayers.Geometry.LineString(u));u=[r.clone()]}}if(p){u.push(n.clone());l.push(new OpenLayers.Geometry.LineString(u))}if(h.length>0){var g=e.x1<e.x2?1:-1,C=e.y1<e.y2?1:-1;f={lines:l,points:h.sort(function(e,t){return g*e.x-g*t.x||C*e.y-C*t.y})}}return f},split:function(e,t){var i,n,r,s,a=null,o=t&&t.mutual;if(e instanceof OpenLayers.Geometry.LineString){var l,c,u,h,p,d,f=this.getVertices(),m=[];r=[];for(var y=0,g=f.length-2;y<=g;++y){l=f[y];c=f[y+1];u={x1:l.x,y1:l.y,x2:c.x,y2:c.y};s=s||[e];o&&m.push(l.clone());for(var C=0;C<s.length;++C)if(h=s[C].splitWithSegment(u,t)){if((p=h.lines).length>0){p.unshift(C,1);Array.prototype.splice.apply(s,p);C+=p.length-2}if(o)for(var v=0,T=h.points.length;v<T;++v)if(!(d=h.points[v]).equals(l)){m.push(d);r.push(new OpenLayers.Geometry.LineString(m));m=d.equals(c)?[]:[d.clone()]}}}if(o&&r.length>0&&m.length>0){m.push(c.clone());r.push(new OpenLayers.Geometry.LineString(m))}}else a=e.splitWith(this,t);s&&s.length>1?n=!0:s=[];r&&r.length>1?i=!0:r=[];(n||i)&&(a=o?[r,s]:s);return a},splitWith:function(e,t){return e.split(this,t)},getVertices:function(e){return!0===e?[this.components[0],this.components[this.components.length-1]]:!1===e?this.components.slice(1,this.components.length-1):this.components.slice()},distanceTo:function(e,t){var i,n=!(t&&!1===t.edge)&&t&&t.details,r={},s=Number.POSITIVE_INFINITY;if(e instanceof OpenLayers.Geometry.Point){for(var a,o=this.getSortedSegments(),l=e.x,c=e.y,u=0,h=o.length;u<h;++u){a=o[u];if((i=OpenLayers.Geometry.distanceToSegment(e,a)).distance<s){s=i.distance;r=i;if(0===s)break}else if(a.x2>l&&(c>a.y1&&c<a.y2||c<a.y1&&c>a.y2))break}r=n?{distance:r.distance,x0:r.x,y0:r.y,x1:l,y1:c}:r.distance}else if(e instanceof OpenLayers.Geometry.LineString){var p,d,f,m,y,g=this.getSortedSegments(),C=e.getSortedSegments(),v=C.length,T={point:!0};e:for(u=0,h=g.length;u<h;++u){m=(p=g[u]).x1;y=p.y1;for(var L=0;L<v;++L){d=C[L];if(f=OpenLayers.Geometry.segmentsIntersect(p,d,T)){s=0;r={distance:0,x0:f.x,y0:f.y,x1:f.x,y1:f.y};break e}(i=OpenLayers.Geometry.distanceToSegment({x:m,y:y},d)).distance<s&&(r={distance:s=i.distance,x0:m,y0:y,x1:i.x,y1:i.y})}}n||(r=r.distance);if(0!==s&&p){i=e.distanceTo(new OpenLayers.Geometry.Point(p.x2,p.y2),t);var w=n?i.distance:i;w<s&&(r=n?{distance:s,x0:i.x1,y0:i.y1,x1:i.x0,y1:i.y0}:w)}}else{r=e.distanceTo(this,t);n&&(r={distance:r.distance,x0:r.x1,y0:r.y1,x1:r.x0,y1:r.y0})}return r},simplify:function(e){if(this&&null!==this){var t=this.getVertices();if(t.length<3)return this;var i=function(e,t,r,a){for(var o,l=0,c=0,u=t;u<r;u++)if((o=n(e[t],e[r],e[u]))>l){l=o;c=u}if(l>a&&c!=t){s.push(c);i(e,t,c,a);i(e,c,r,a)}},n=function(e,t,i){return Math.abs(.5*(e.x*t.y+t.x*i.y+i.x*e.y-t.x*e.y-i.x*t.y-e.x*i.y))/Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2))*2},r=t.length-1,s=[];s.push(0);s.push(r);for(;t[0].equals(t[r]);){r--;s.push(r)}i(t,0,r,e);var a=[];s.sort(function(e,t){return e-t});for(var o=0;o<s.length;o++)a.push(t[s[o]]);return new OpenLayers.Geometry.LineString(a)}return this},CLASS_NAME:"OpenLayers.Geometry.LineString"});OpenLayers.Geometry.MultiLineString=OpenLayers.Class(OpenLayers.Geometry.Collection,{componentTypes:["OpenLayers.Geometry.LineString"],split:function(e,t){for(var i,n,r,s,a,o=null,l=t&&t.mutual,c=[],u=[e],h=0,p=this.components.length;h<p;++h){n=this.components[h];s=!1;for(var d=0;d<u.length;++d)if(i=n.split(u[d],t)){if(l){for(var f=0,m=(r=i[0]).length;f<m;++f)0===f&&c.length?c[c.length-1].addComponent(r[f]):c.push(new OpenLayers.Geometry.MultiLineString([r[f]]));s=!0;i=i[1]}if(i.length){i.unshift(d,1);Array.prototype.splice.apply(u,i);break}}s||(c.length?c[c.length-1].addComponent(n.clone()):c=[new OpenLayers.Geometry.MultiLineString(n.clone())])}c&&c.length>1?s=!0:c=[];u&&u.length>1?a=!0:u=[];(s||a)&&(o=l?[c,u]:u);return o},splitWith:function(e,t){var i,n,r,s,a,o,l,c=null,u=t&&t.mutual;if(e instanceof OpenLayers.Geometry.LineString){l=[];o=[e];for(var h=0,p=this.components.length;h<p;++h){a=!1;n=this.components[h];for(var d=0;d<o.length;++d)if(i=o[d].split(n,t)){if(u){if((r=i[0]).length){r.unshift(d,1);Array.prototype.splice.apply(o,r);d+=r.length-2}0===(i=i[1]).length&&(i=[n.clone()])}for(var f=0,m=i.length;f<m;++f)0===f&&l.length?l[l.length-1].addComponent(i[f]):l.push(new OpenLayers.Geometry.MultiLineString([i[f]]));a=!0}a||(l.length?l[l.length-1].addComponent(n.clone()):l=[new OpenLayers.Geometry.MultiLineString([n.clone()])])}}else c=e.split(this);o&&o.length>1?s=!0:o=[];l&&l.length>1?a=!0:l=[];(s||a)&&(c=u?[o,l]:l);return c},CLASS_NAME:"OpenLayers.Geometry.MultiLineString"});OpenLayers.Geometry.LinearRing=OpenLayers.Class(OpenLayers.Geometry.LineString,{componentTypes:["OpenLayers.Geometry.Point"],addComponent:function(e,t){var i=!1,n=this.components.pop();null==t&&e.equals(n)||(i=OpenLayers.Geometry.Collection.prototype.addComponent.apply(this,arguments));var r=this.components[0];OpenLayers.Geometry.Collection.prototype.addComponent.apply(this,[r]);return i},removeComponent:function(e){var t=this.components&&this.components.length>3;if(t){this.components.pop();OpenLayers.Geometry.Collection.prototype.removeComponent.apply(this,arguments);var i=this.components[0];OpenLayers.Geometry.Collection.prototype.addComponent.apply(this,[i])}return t},move:function(e,t){for(var i=0,n=this.components.length;i<n-1;i++)this.components[i].move(e,t)},rotate:function(e,t){for(var i=0,n=this.components.length;i<n-1;++i)this.components[i].rotate(e,t)},resize:function(e,t,i){for(var n=0,r=this.components.length;n<r-1;++n)this.components[n].resize(e,t,i);return this},transform:function(e,t){if(e&&t){for(var i=0,n=this.components.length;i<n-1;i++){this.components[i].transform(e,t)}this.bounds=null}return this},getCentroid:function(){if(this.components){var e=this.components.length;if(e>0&&e<=2)return this.components[0].clone();if(e>2){var t=0,i=0,n=this.components[0].x,r=this.components[0].y,s=-1*this.getArea();if(0!=s){for(var a=0;a<e-1;a++){var o=this.components[a],l=this.components[a+1];t+=(o.x+l.x-2*n)*((o.x-n)*(l.y-r)-(l.x-n)*(o.y-r));i+=(o.y+l.y-2*r)*((o.x-n)*(l.y-r)-(l.x-n)*(o.y-r))}var c=n+t/(6*s),u=r+i/(6*s)}else{for(a=0;a<e-1;a++){t+=this.components[a].x;i+=this.components[a].y}c=t/(e-1),u=i/(e-1)}return new OpenLayers.Geometry.Point(c,u)}return null}},getArea:function(){var e=0;if(this.components&&this.components.length>2){for(var t=0,i=0,n=this.components.length;i<n-1;i++){var r=this.components[i],s=this.components[i+1];t+=(r.x+s.x)*(s.y-r.y)}e=-t/2}return e},getGeodesicArea:function(e){var t=this;if(e){var i=new OpenLayers.Projection("EPSG:4326");i.equals(e)||(t=this.clone().transform(e,i))}var n=0,r=t.components&&t.components.length;if(r>2){for(var s,a,o=0;o<r-1;o++){s=t.components[o];a=t.components[o+1];n+=OpenLayers.Util.rad(a.x-s.x)*(2+Math.sin(OpenLayers.Util.rad(s.y))+Math.sin(OpenLayers.Util.rad(a.y)))}n=6378137*n*6378137/2}return n},containsPoint:function(e){var t=OpenLayers.Number.limitSigDigs,i=t(e.x,14),n=t(e.y,14);function r(e,t,i,n,r){return(n-t)/(r-i)*(e-r)+n}for(var s,a,o,l,c,u,h,p=this.components.length-1,d=0,f=0;f<p;++f){o=t((s=this.components[f]).x,14);l=t(s.y,14);c=t((a=this.components[f+1]).x,14);if(l!=(u=t(a.y,14))){if((h=t(r(n,o,l,c,u),14))==i&&(l<u&&n>=l&&n<=u||l>u&&n<=l&&n>=u)){d=-1;break}h<=i||o!=c&&(h<Math.min(o,c)||h>Math.max(o,c))||(l<u&&n>=l&&n<u||l>u&&n<l&&n>=u)&&++d}else if(n==l&&(o<=c&&i>=o&&i<=c||o>=c&&i<=o&&i>=c)){d=-1;break}}return-1==d?1:!!(1&d)},intersects:function(e){var t=!1;if("OpenLayers.Geometry.Point"==e.CLASS_NAME)t=this.containsPoint(e);else if("OpenLayers.Geometry.LineString"==e.CLASS_NAME)t=e.intersects(this);else if("OpenLayers.Geometry.LinearRing"==e.CLASS_NAME)t=OpenLayers.Geometry.LineString.prototype.intersects.apply(this,[e]);else for(var i=0,n=e.components.length;i<n&&!(t=e.components[i].intersects(this));++i);return t},getVertices:function(e){return!0===e?[]:this.components.slice(0,this.components.length-1)},CLASS_NAME:"OpenLayers.Geometry.LinearRing"});OpenLayers.Geometry.Polygon=OpenLayers.Class(OpenLayers.Geometry.Collection,{componentTypes:["OpenLayers.Geometry.LinearRing"],getArea:function(){var e=0;if(this.components&&this.components.length>0){e+=Math.abs(this.components[0].getArea());for(var t=1,i=this.components.length;t<i;t++)e-=Math.abs(this.components[t].getArea())}return e},getGeodesicArea:function(e){var t=0;if(this.components&&this.components.length>0){t+=Math.abs(this.components[0].getGeodesicArea(e));for(var i=1,n=this.components.length;i<n;i++)t-=Math.abs(this.components[i].getGeodesicArea(e))}return t},containsPoint:function(e){var t=this.components.length,i=!1;if(t>0&&1!==(i=this.components[0].containsPoint(e))&&i&&t>1)for(var n,r=1;r<t;++r)if(n=this.components[r].containsPoint(e)){i=1===n&&1;break}return i},intersects:function(e){var t,i,n=!1;if("OpenLayers.Geometry.Point"==e.CLASS_NAME)n=this.containsPoint(e);else if("OpenLayers.Geometry.LineString"==e.CLASS_NAME||"OpenLayers.Geometry.LinearRing"==e.CLASS_NAME){for(t=0,i=this.components.length;t<i&&!(n=e.intersects(this.components[t]));++t);if(!n)for(t=0,i=e.components.length;t<i&&!(n=this.containsPoint(e.components[t]));++t);}else for(t=0,i=e.components.length;t<i&&!(n=this.intersects(e.components[t]));++t);if(!n&&"OpenLayers.Geometry.Polygon"==e.CLASS_NAME){var r=this.components[0];for(t=0,i=r.components.length;t<i&&!(n=e.containsPoint(r.components[t]));++t);}return n},distanceTo:function(e,t){return!!(t&&!1===t.edge)&&this.intersects(e)?0:OpenLayers.Geometry.Collection.prototype.distanceTo.apply(this,[e,t])},CLASS_NAME:"OpenLayers.Geometry.Polygon"});OpenLayers.Geometry.Polygon.createRegularPolygon=function(e,t,i,n){var r,s,a,o=Math.PI*(1/i-.5);n&&(o+=n/180*Math.PI);for(var l=[],c=0;c<i;++c){r=o+2*c*Math.PI/i;s=e.x+t*Math.cos(r);a=e.y+t*Math.sin(r);l.push(new OpenLayers.Geometry.Point(s,a))}var u=new OpenLayers.Geometry.LinearRing(l);return new OpenLayers.Geometry.Polygon([u])};OpenLayers.Geometry.MultiPolygon=OpenLayers.Class(OpenLayers.Geometry.Collection,{componentTypes:["OpenLayers.Geometry.Polygon"],CLASS_NAME:"OpenLayers.Geometry.MultiPolygon"});OpenLayers.Format.GML=OpenLayers.Class(OpenLayers.Format.XML,{featureNS:"http://mapserver.gis.umn.edu/mapserver",featurePrefix:"feature",featureName:"featureMember",layerName:"features",geometryName:"geometry",collectionName:"FeatureCollection",gmlns:"http://www.opengis.net/gml",extractAttributes:!0,xy:!0,initialize:function(e){this.regExes={trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g};OpenLayers.Format.XML.prototype.initialize.apply(this,[e])},read:function(e){"string"==typeof e&&(e=OpenLayers.Format.XML.prototype.read.apply(this,[e]));for(var t=this.getElementsByTagNameNS(e.documentElement,this.gmlns,this.featureName),i=[],n=0;n<t.length;n++){var r=this.parseFeature(t[n]);r&&i.push(r)}return i},parseFeature:function(e){for(var t,i,n,r,s,a=["MultiPolygon","Polygon","MultiLineString","LineString","MultiPoint","Point","Envelope"],o=0;o<a.length;++o){t=a[o];if((i=this.getElementsByTagNameNS(e,this.gmlns,t)).length>0){if(!(r=this.parseGeometry[t.toLowerCase()]))throw new TypeError("Unsupported geometry type: "+t);n=r.apply(this,[i[0]]);this.internalProjection&&this.externalProjection&&n.transform(this.externalProjection,this.internalProjection);break}}var l,c=this.getElementsByTagNameNS(e,this.gmlns,"Box");for(o=0;o<c.length;++o){var u=c[o],h=this.parseGeometry.box.apply(this,[u]),p=u.parentNode;"boundedBy"===(p.localName||p.nodeName.split(":").pop())?s=h:n=h.toGeometry()}this.extractAttributes&&(l=this.parseAttributes(e));var d=new OpenLayers.Feature.Vector(n,l);d.bounds=s;d.gml={featureType:e.firstChild.nodeName.split(":")[1],featureNS:e.firstChild.namespaceURI,featureNSPrefix:e.firstChild.prefix};for(var f,m=e.firstChild;m&&(1!=m.nodeType||!(f=m.getAttribute("fid")||m.getAttribute("id")));)m=m.nextSibling;d.fid=f;return d},parseGeometry:{point:function(e){var t,i=[];(t=this.getElementsByTagNameNS(e,this.gmlns,"pos")).length>0&&(i=t[0].firstChild.nodeValue.replace(this.regExes.trimSpace,"").split(this.regExes.splitSpace));0==i.length&&(t=this.getElementsByTagNameNS(e,this.gmlns,"coordinates")).length>0&&(i=t[0].firstChild.nodeValue.replace(this.regExes.removeSpace,"").split(","));if(0==i.length&&(t=this.getElementsByTagNameNS(e,this.gmlns,"coord")).length>0){var n=this.getElementsByTagNameNS(t[0],this.gmlns,"X"),r=this.getElementsByTagNameNS(t[0],this.gmlns,"Y");n.length>0&&r.length>0&&(i=[n[0].firstChild.nodeValue,r[0].firstChild.nodeValue])}2==i.length&&(i[2]=null);return this.xy?new OpenLayers.Geometry.Point(i[0],i[1],i[2]):new OpenLayers.Geometry.Point(i[1],i[0],i[2])},multipoint:function(e){var t=this.getElementsByTagNameNS(e,this.gmlns,"Point"),i=[];if(t.length>0)for(var n,r=0;r<t.length;++r)(n=this.parseGeometry.point.apply(this,[t[r]]))&&i.push(n);return new OpenLayers.Geometry.MultiPoint(i)},linestring:function(e,t){var i,n=[],r=[];if((i=this.getElementsByTagNameNS(e,this.gmlns,"posList")).length>0){n=this.getChildValue(i[0]).replace(this.regExes.trimSpace,"").split(this.regExes.splitSpace);for(var s,a,o,l,c=parseInt(i[0].getAttribute("dimension")),u=0;u<n.length/c;++u){a=n[s=u*c];o=n[s+1];l=2==c?null:n[s+2];this.xy?r.push(new OpenLayers.Geometry.Point(a,o,l)):r.push(new OpenLayers.Geometry.Point(o,a,l))}}if(0==n.length&&(i=this.getElementsByTagNameNS(e,this.gmlns,"coordinates")).length>0){var h=this.getChildValue(i[0]).replace(this.regExes.trimSpace,"").replace(this.regExes.trimComma,",").split(this.regExes.splitSpace);for(u=0;u<h.length;++u){2==(n=h[u].split(",")).length&&(n[2]=null);this.xy?r.push(new OpenLayers.Geometry.Point(n[0],n[1],n[2])):r.push(new OpenLayers.Geometry.Point(n[1],n[0],n[2]))}}var p=null;0!=r.length&&(p=t?new OpenLayers.Geometry.LinearRing(r):new OpenLayers.Geometry.LineString(r));return p},multilinestring:function(e){var t=this.getElementsByTagNameNS(e,this.gmlns,"LineString"),i=[];if(t.length>0)for(var n,r=0;r<t.length;++r)(n=this.parseGeometry.linestring.apply(this,[t[r]]))&&i.push(n);return new OpenLayers.Geometry.MultiLineString(i)},polygon:function(e){var t=this.getElementsByTagNameNS(e,this.gmlns,"LinearRing"),i=[];if(t.length>0)for(var n,r=0;r<t.length;++r)(n=this.parseGeometry.linestring.apply(this,[t[r],!0]))&&i.push(n);return new OpenLayers.Geometry.Polygon(i)},multipolygon:function(e){var t=this.getElementsByTagNameNS(e,this.gmlns,"Polygon"),i=[];if(t.length>0)for(var n,r=0;r<t.length;++r)(n=this.parseGeometry.polygon.apply(this,[t[r]]))&&i.push(n);return new OpenLayers.Geometry.MultiPolygon(i)},envelope:function(e){var t,i=[],n=this.getElementsByTagNameNS(e,this.gmlns,"lowerCorner");if(n.length>0){var r=[];n.length>0&&(r=n[0].firstChild.nodeValue.replace(this.regExes.trimSpace,"").split(this.regExes.splitSpace));2==r.length&&(r[2]=null);if(this.xy)var s=new OpenLayers.Geometry.Point(r[0],r[1],r[2]);else s=new OpenLayers.Geometry.Point(r[1],r[0],r[2])}var a=this.getElementsByTagNameNS(e,this.gmlns,"upperCorner");if(a.length>0){r=[];a.length>0&&(r=a[0].firstChild.nodeValue.replace(this.regExes.trimSpace,"").split(this.regExes.splitSpace));2==r.length&&(r[2]=null);if(this.xy)var o=new OpenLayers.Geometry.Point(r[0],r[1],r[2]);else o=new OpenLayers.Geometry.Point(r[1],r[0],r[2])}if(s&&o){i.push(new OpenLayers.Geometry.Point(s.x,s.y));i.push(new OpenLayers.Geometry.Point(o.x,s.y));i.push(new OpenLayers.Geometry.Point(o.x,o.y));i.push(new OpenLayers.Geometry.Point(s.x,o.y));i.push(new OpenLayers.Geometry.Point(s.x,s.y));var l=new OpenLayers.Geometry.LinearRing(i);t=new OpenLayers.Geometry.Polygon([l])}return t},box:function(e){var t,i=this.getElementsByTagNameNS(e,this.gmlns,"coordinates"),n=null,r=null;if(i.length>0&&2==(t=i[0].firstChild.nodeValue.split(" ")).length){n=t[0].split(",");r=t[1].split(",")}if(null!==n&&null!==r)return new OpenLayers.Bounds(parseFloat(n[0]),parseFloat(n[1]),parseFloat(r[0]),parseFloat(r[1]))}},parseAttributes:function(e){for(var t,i,n,r,s,a,o,l={},c=e.firstChild;c;){if(1==c.nodeType){t=c.childNodes;for(i=0;i<t.length;++i)if(1==(n=t[i]).nodeType)if(1==(r=n.childNodes).length){if(3==(s=r[0]).nodeType||4==s.nodeType){a=n.prefix?n.nodeName.split(":")[1]:n.nodeName;o=s.nodeValue.replace(this.regExes.trimSpace,"");l[a]=o}}else l[n.nodeName.split(":").pop()]=null;break}c=c.nextSibling}return l},write:function(e){OpenLayers.Util.isArray(e)||(e=[e]);for(var t=this.createElementNS("http://www.opengis.net/wfs","wfs:"+this.collectionName),i=0;i<e.length;i++)t.appendChild(this.createFeatureXML(e[i]));return OpenLayers.Format.XML.prototype.write.apply(this,[t])},createFeatureXML:function(e){var t=e.geometry,i=this.buildGeometryNode(t),n=this.createElementNS(this.featureNS,this.featurePrefix+":"+this.geometryName);n.appendChild(i);var r=this.createElementNS(this.gmlns,"gml:"+this.featureName),s=this.createElementNS(this.featureNS,this.featurePrefix+":"+this.layerName),a=e.fid||e.id;s.setAttribute("fid",a);s.appendChild(n);for(var o in e.attributes){var l=this.createTextNode(e.attributes[o]),c=o.substring(o.lastIndexOf(":")+1),u=this.createElementNS(this.featureNS,this.featurePrefix+":"+c);u.appendChild(l);s.appendChild(u)}r.appendChild(s);return r},buildGeometryNode:function(e){this.externalProjection&&this.internalProjection&&(e=e.clone()).transform(this.internalProjection,this.externalProjection);var t=e.CLASS_NAME,i=t.substring(t.lastIndexOf(".")+1);return this.buildGeometry[i.toLowerCase()].apply(this,[e])},buildGeometry:{point:function(e){var t=this.createElementNS(this.gmlns,"gml:Point");t.appendChild(this.buildCoordinatesNode(e));return t},multipoint:function(e){for(var t,i,n=this.createElementNS(this.gmlns,"gml:MultiPoint"),r=e.components,s=0;s<r.length;s++){t=this.createElementNS(this.gmlns,"gml:pointMember");i=this.buildGeometry.point.apply(this,[r[s]]);t.appendChild(i);n.appendChild(t)}return n},linestring:function(e){var t=this.createElementNS(this.gmlns,"gml:LineString");t.appendChild(this.buildCoordinatesNode(e));return t},multilinestring:function(e){for(var t,i,n=this.createElementNS(this.gmlns,"gml:MultiLineString"),r=e.components,s=0;s<r.length;++s){t=this.createElementNS(this.gmlns,"gml:lineStringMember");i=this.buildGeometry.linestring.apply(this,[r[s]]);t.appendChild(i);n.appendChild(t)}return n},linearring:function(e){var t=this.createElementNS(this.gmlns,"gml:LinearRing");t.appendChild(this.buildCoordinatesNode(e));return t},polygon:function(e){for(var t,i,n,r=this.createElementNS(this.gmlns,"gml:Polygon"),s=e.components,a=0;a<s.length;++a){n=0==a?"outerBoundaryIs":"innerBoundaryIs";t=this.createElementNS(this.gmlns,"gml:"+n);i=this.buildGeometry.linearring.apply(this,[s[a]]);t.appendChild(i);r.appendChild(t)}return r},multipolygon:function(e){for(var t,i,n=this.createElementNS(this.gmlns,"gml:MultiPolygon"),r=e.components,s=0;s<r.length;++s){t=this.createElementNS(this.gmlns,"gml:polygonMember");i=this.buildGeometry.polygon.apply(this,[r[s]]);t.appendChild(i);n.appendChild(t)}return n},bounds:function(e){var t=this.createElementNS(this.gmlns,"gml:Box");t.appendChild(this.buildCoordinatesNode(e));return t}},buildCoordinatesNode:function(e){var t=this.createElementNS(this.gmlns,"gml:coordinates");t.setAttribute("decimal",".");t.setAttribute("cs",",");t.setAttribute("ts"," ");var i=[];if(e instanceof OpenLayers.Bounds){i.push(e.left+","+e.bottom);i.push(e.right+","+e.top)}else for(var n=e.components?e.components:[e],r=0;r<n.length;r++)i.push(n[r].x+","+n[r].y);var s=this.createTextNode(i.join(" "));t.appendChild(s);return t},CLASS_NAME:"OpenLayers.Format.GML"});OpenLayers.Format.GML||(OpenLayers.Format.GML={});OpenLayers.Format.GML.Base=OpenLayers.Class(OpenLayers.Format.XML,{namespaces:{gml:"http://www.opengis.net/gml",xlink:"http://www.w3.org/1999/xlink",xsi:"http://www.w3.org/2001/XMLSchema-instance",wfs:"http://www.opengis.net/wfs"},defaultPrefix:"gml",schemaLocation:null,featureType:null,featureNS:null,geometryName:"geometry",extractAttributes:!0,srsName:null,xy:!0,geometryTypes:null,singleFeatureType:null,regExes:{trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g,featureMember:/^(.*:)?featureMembers?$/},initialize:function(e){OpenLayers.Format.XML.prototype.initialize.apply(this,[e]);this.setGeometryTypes();e&&e.featureNS&&this.setNamespace("feature",e.featureNS);this.singleFeatureType=!e||"string"==typeof e.featureType},read:function(e){"string"==typeof e&&(e=OpenLayers.Format.XML.prototype.read.apply(this,[e]));e&&9==e.nodeType&&(e=e.documentElement);var t=[];this.readNode(e,{features:t},!0);if(0==t.length){if((r=this.getElementsByTagNameNS(e,this.namespaces.gml,"featureMember")).length)for(var i=0,n=r.length;i<n;++i)this.readNode(r[i],{features:t},!0);else{var r;(r=this.getElementsByTagNameNS(e,this.namespaces.gml,"featureMembers")).length&&this.readNode(r[0],{features:t},!0)}}return t},readNode:function(e,t,i){if(!0===i&&!0===this.autoConfig){this.featureType=null;delete this.namespaceAlias[this.featureNS];delete this.namespaces.feature;this.featureNS=null}if(!this.featureNS&&!(e.prefix in this.namespaces)&&e.parentNode.namespaceURI==this.namespaces.gml&&this.regExes.featureMember.test(e.parentNode.nodeName)){this.featureType=e.nodeName.split(":").pop();this.setNamespace("feature",e.namespaceURI);this.featureNS=e.namespaceURI;this.autoConfig=!0}return OpenLayers.Format.XML.prototype.readNode.apply(this,[e,t])},readers:{gml:{_inherit:function(e,t,i){},featureMember:function(e,t){this.readChildNodes(e,t)},featureMembers:function(e,t){this.readChildNodes(e,t)},name:function(e,t){t.name=this.getChildValue(e)},boundedBy:function(e,t){var i={};this.readChildNodes(e,i);i.components&&i.components.length>0&&(t.bounds=i.components[0])},Point:function(e,t){var i={points:[]};this.readChildNodes(e,i);t.components||(t.components=[]);t.components.push(i.points[0])},coordinates:function(e,t){for(var i,n=this.getChildValue(e).replace(this.regExes.trimSpace,""),r=(n=n.replace(this.regExes.trimComma,",")).split(this.regExes.splitSpace),s=r.length,a=new Array(s),o=0;o<s;++o){i=r[o].split(",");this.xy?a[o]=new OpenLayers.Geometry.Point(i[0],i[1],i[2]):a[o]=new OpenLayers.Geometry.Point(i[1],i[0],i[2])}t.points=a},coord:function(e,t){var i={};this.readChildNodes(e,i);t.points||(t.points=[]);t.points.push(new OpenLayers.Geometry.Point(i.x,i.y,i.z))},X:function(e,t){t.x=this.getChildValue(e)},Y:function(e,t){t.y=this.getChildValue(e)},Z:function(e,t){t.z=this.getChildValue(e)},MultiPoint:function(e,t){var i={components:[]};this.readers.gml._inherit.apply(this,[e,i,t]);this.readChildNodes(e,i);t.components=[new OpenLayers.Geometry.MultiPoint(i.components)]},pointMember:function(e,t){this.readChildNodes(e,t)},LineString:function(e,t){var i={};this.readers.gml._inherit.apply(this,[e,i,t]);this.readChildNodes(e,i);t.components||(t.components=[]);t.components.push(new OpenLayers.Geometry.LineString(i.points))},MultiLineString:function(e,t){var i={components:[]};this.readers.gml._inherit.apply(this,[e,i,t]);this.readChildNodes(e,i);t.components=[new OpenLayers.Geometry.MultiLineString(i.components)]},lineStringMember:function(e,t){this.readChildNodes(e,t)},Polygon:function(e,t){var i={outer:null,inner:[]};this.readers.gml._inherit.apply(this,[e,i,t]);this.readChildNodes(e,i);i.inner.unshift(i.outer);t.components||(t.components=[]);t.components.push(new OpenLayers.Geometry.Polygon(i.inner))},LinearRing:function(e,t){var i={};this.readers.gml._inherit.apply(this,[e,i]);this.readChildNodes(e,i);t.components=[new OpenLayers.Geometry.LinearRing(i.points)]},MultiPolygon:function(e,t){var i={components:[]};this.readers.gml._inherit.apply(this,[e,i,t]);this.readChildNodes(e,i);t.components=[new OpenLayers.Geometry.MultiPolygon(i.components)]},polygonMember:function(e,t){this.readChildNodes(e,t)},GeometryCollection:function(e,t){var i={components:[]};this.readers.gml._inherit.apply(this,[e,i,t]);this.readChildNodes(e,i);t.components=[new OpenLayers.Geometry.Collection(i.components)]},geometryMember:function(e,t){this.readChildNodes(e,t)}},feature:{"*":function(e,t){var i,n=e.localName||e.nodeName.split(":").pop();t.features?this.singleFeatureType||-1===OpenLayers.Util.indexOf(this.featureType,n)?n===this.featureType&&(i="_typeName"):i="_typeName":0==e.childNodes.length||1==e.childNodes.length&&3==e.firstChild.nodeType?this.extractAttributes&&(i="_attribute"):i="_geometry";i&&this.readers.feature[i].apply(this,[e,t])},_typeName:function(e,t){var i={components:[],attributes:{}};this.readChildNodes(e,i);i.name&&(i.attributes.name=i.name);var n=new OpenLayers.Feature.Vector(i.components[0],i.attributes);if(!this.singleFeatureType){n.type=e.nodeName.split(":").pop();n.namespace=e.namespaceURI}var r=e.getAttribute("fid")||this.getAttributeNS(e,this.namespaces.gml,"id");r&&(n.fid=r);this.internalProjection&&this.externalProjection&&n.geometry&&n.geometry.transform(this.externalProjection,this.internalProjection);i.bounds&&(n.bounds=i.bounds);t.features.push(n)},_geometry:function(e,t){this.geometryName||(this.geometryName=e.nodeName.split(":").pop());this.readChildNodes(e,t)},_attribute:function(e,t){var i=e.localName||e.nodeName.split(":").pop(),n=this.getChildValue(e);t.attributes[i]=n}},wfs:{FeatureCollection:function(e,t){this.readChildNodes(e,t)}}},write:function(e){var t;t=OpenLayers.Util.isArray(e)?"featureMembers":"featureMember";var i=this.writeNode("gml:"+t,e);this.setAttributeNS(i,this.namespaces.xsi,"xsi:schemaLocation",this.schemaLocation);return OpenLayers.Format.XML.prototype.write.apply(this,[i])},writers:{gml:{featureMember:function(e){var t=this.createElementNSPlus("gml:featureMember");this.writeNode("feature:_typeName",e,t);return t},MultiPoint:function(e){for(var t=this.createElementNSPlus("gml:MultiPoint"),i=e.components||[e],n=0,r=i.length;n<r;++n)this.writeNode("pointMember",i[n],t);return t},pointMember:function(e){var t=this.createElementNSPlus("gml:pointMember");this.writeNode("Point",e,t);return t},MultiLineString:function(e){for(var t=this.createElementNSPlus("gml:MultiLineString"),i=e.components||[e],n=0,r=i.length;n<r;++n)this.writeNode("lineStringMember",i[n],t);return t},lineStringMember:function(e){var t=this.createElementNSPlus("gml:lineStringMember");this.writeNode("LineString",e,t);return t},MultiPolygon:function(e){for(var t=this.createElementNSPlus("gml:MultiPolygon"),i=e.components||[e],n=0,r=i.length;n<r;++n)this.writeNode("polygonMember",i[n],t);return t},polygonMember:function(e){var t=this.createElementNSPlus("gml:polygonMember");this.writeNode("Polygon",e,t);return t},GeometryCollection:function(e){for(var t=this.createElementNSPlus("gml:GeometryCollection"),i=0,n=e.components.length;i<n;++i)this.writeNode("geometryMember",e.components[i],t);return t},geometryMember:function(e){var t=this.createElementNSPlus("gml:geometryMember"),i=this.writeNode("feature:_geometry",e);t.appendChild(i.firstChild);return t}},feature:{_typeName:function(e){var t=this.createElementNSPlus("feature:"+this.featureType,{attributes:{fid:e.fid}});e.geometry&&this.writeNode("feature:_geometry",e.geometry,t);for(var i in e.attributes){var n=e.attributes[i];null!=n&&this.writeNode("feature:_attribute",{name:i,value:n},t)}return t},_geometry:function(e){this.externalProjection&&this.internalProjection&&(e=e.clone().transform(this.internalProjection,this.externalProjection));var t=this.createElementNSPlus("feature:"+this.geometryName),i=this.geometryTypes[e.CLASS_NAME],n=this.writeNode("gml:"+i,e,t);this.srsName&&n.setAttribute("srsName",this.srsName);return t},_attribute:function(e){return this.createElementNSPlus("feature:"+e.name,{value:e.value})}},wfs:{FeatureCollection:function(e){for(var t=this.createElementNSPlus("wfs:FeatureCollection"),i=0,n=e.length;i<n;++i)this.writeNode("gml:featureMember",e[i],t);return t}}},setGeometryTypes:function(){this.geometryTypes={"OpenLayers.Geometry.Point":"Point","OpenLayers.Geometry.MultiPoint":"MultiPoint","OpenLayers.Geometry.LineString":"LineString","OpenLayers.Geometry.MultiLineString":"MultiLineString","OpenLayers.Geometry.Polygon":"Polygon","OpenLayers.Geometry.MultiPolygon":"MultiPolygon","OpenLayers.Geometry.Collection":"GeometryCollection"}},CLASS_NAME:"OpenLayers.Format.GML.Base"});OpenLayers.Format.GML.v3=OpenLayers.Class(OpenLayers.Format.GML.Base,{schemaLocation:"http://www.opengis.net/gml http://schemas.opengis.net/gml/3.1.1/profiles/gmlsfProfile/1.0.0/gmlsf.xsd",curve:!1,multiCurve:!0,surface:!1,multiSurface:!0,initialize:function(e){OpenLayers.Format.GML.Base.prototype.initialize.apply(this,[e])},readers:{gml:OpenLayers.Util.applyDefaults({_inherit:function(e,t,i){var n=parseInt(e.getAttribute("srsDimension"),10)||i&&i.srsDimension;n&&(t.srsDimension=n)},featureMembers:function(e,t){this.readChildNodes(e,t)},Curve:function(e,t){var i={points:[]};this.readers.gml._inherit.apply(this,[e,i,t]);this.readChildNodes(e,i);t.components||(t.components=[]);t.components.push(new OpenLayers.Geometry.LineString(i.points))},segments:function(e,t){this.readChildNodes(e,t)},LineStringSegment:function(e,t){var i={};this.readChildNodes(e,i);i.points&&Array.prototype.push.apply(t.points,i.points)},pos:function(e,t){var i,n=this.getChildValue(e).replace(this.regExes.trimSpace,"").split(this.regExes.splitSpace);i=this.xy?new OpenLayers.Geometry.Point(n[0],n[1],n[2]):new OpenLayers.Geometry.Point(n[1],n[0],n[2]);t.points=[i]},posList:function(e,t){for(var i,n,r,s=this.getChildValue(e).replace(this.regExes.trimSpace,"").split(this.regExes.splitSpace),a=t.srsDimension||parseInt(e.getAttribute("srsDimension")||e.getAttribute("dimension"),10)||2,o=s.length/a,l=new Array(o),c=0,u=s.length;c<u;c+=a){i=s[c];n=s[c+1];r=2==a?void 0:s[c+2];this.xy?l[c/a]=new OpenLayers.Geometry.Point(i,n,r):l[c/a]=new OpenLayers.Geometry.Point(n,i,r)}t.points=l},Surface:function(e,t){this.readChildNodes(e,t)},patches:function(e,t){this.readChildNodes(e,t)},PolygonPatch:function(e,t){this.readers.gml.Polygon.apply(this,[e,t])},exterior:function(e,t){var i={};this.readChildNodes(e,i);t.outer=i.components[0]},interior:function(e,t){var i={};this.readChildNodes(e,i);t.inner.push(i.components[0])},MultiCurve:function(e,t){var i={components:[]};this.readers.gml._inherit.apply(this,[e,i,t]);this.readChildNodes(e,i);i.components.length>0&&(t.components=[new OpenLayers.Geometry.MultiLineString(i.components)])},curveMember:function(e,t){this.readChildNodes(e,t)},MultiSurface:function(e,t){var i={components:[]};this.readers.gml._inherit.apply(this,[e,i,t]);this.readChildNodes(e,i);i.components.length>0&&(t.components=[new OpenLayers.Geometry.MultiPolygon(i.components)])},surfaceMember:function(e,t){this.readChildNodes(e,t)},surfaceMembers:function(e,t){this.readChildNodes(e,t)},pointMembers:function(e,t){this.readChildNodes(e,t)},lineStringMembers:function(e,t){this.readChildNodes(e,t)},polygonMembers:function(e,t){this.readChildNodes(e,t)},geometryMembers:function(e,t){this.readChildNodes(e,t)},Envelope:function(e,t){var i={points:new Array(2)};this.readChildNodes(e,i);t.components||(t.components=[]);var n=i.points[0],r=i.points[1];t.components.push(new OpenLayers.Bounds(n.x,n.y,r.x,r.y))},lowerCorner:function(e,t){var i={};this.readers.gml.pos.apply(this,[e,i]);t.points[0]=i.points[0]},upperCorner:function(e,t){var i={};this.readers.gml.pos.apply(this,[e,i]);t.points[1]=i.points[0]}},OpenLayers.Format.GML.Base.prototype.readers.gml),feature:OpenLayers.Format.GML.Base.prototype.readers.feature,wfs:OpenLayers.Format.GML.Base.prototype.readers.wfs},write:function(e){var t;t=OpenLayers.Util.isArray(e)?"featureMembers":"featureMember";var i=this.writeNode("gml:"+t,e);this.setAttributeNS(i,this.namespaces.xsi,"xsi:schemaLocation",this.schemaLocation);return OpenLayers.Format.XML.prototype.write.apply(this,[i])},writers:{gml:OpenLayers.Util.applyDefaults({featureMembers:function(e){for(var t=this.createElementNSPlus("gml:featureMembers"),i=0,n=e.length;i<n;++i)this.writeNode("feature:_typeName",e[i],t);return t},Point:function(e){var t=this.createElementNSPlus("gml:Point");this.writeNode("pos",e,t);return t},pos:function(e){var t=this.xy?e.x+" "+e.y:e.y+" "+e.x;return this.createElementNSPlus("gml:pos",{value:t})},LineString:function(e){var t=this.createElementNSPlus("gml:LineString");this.writeNode("posList",e.components,t);return t},Curve:function(e){var t=this.createElementNSPlus("gml:Curve");this.writeNode("segments",e,t);return t},segments:function(e){var t=this.createElementNSPlus("gml:segments");this.writeNode("LineStringSegment",e,t);return t},LineStringSegment:function(e){var t=this.createElementNSPlus("gml:LineStringSegment");this.writeNode("posList",e.components,t);return t},posList:function(e){for(var t,i=e.length,n=new Array(i),r=0;r<i;++r){t=e[r];this.xy?n[r]=t.x+" "+t.y:n[r]=t.y+" "+t.x}return this.createElementNSPlus("gml:posList",{value:n.join(" ")})},Surface:function(e){var t=this.createElementNSPlus("gml:Surface");this.writeNode("patches",e,t);return t},patches:function(e){var t=this.createElementNSPlus("gml:patches");this.writeNode("PolygonPatch",e,t);return t},PolygonPatch:function(e){var t=this.createElementNSPlus("gml:PolygonPatch",{attributes:{interpolation:"planar"}});this.writeNode("exterior",e.components[0],t);for(var i=1,n=e.components.length;i<n;++i)this.writeNode("interior",e.components[i],t);return t},Polygon:function(e){var t=this.createElementNSPlus("gml:Polygon");this.writeNode("exterior",e.components[0],t);for(var i=1,n=e.components.length;i<n;++i)this.writeNode("interior",e.components[i],t);return t},exterior:function(e){var t=this.createElementNSPlus("gml:exterior");this.writeNode("LinearRing",e,t);return t},interior:function(e){var t=this.createElementNSPlus("gml:interior");this.writeNode("LinearRing",e,t);return t},LinearRing:function(e){var t=this.createElementNSPlus("gml:LinearRing");this.writeNode("posList",e.components,t);return t},MultiCurve:function(e){for(var t=this.createElementNSPlus("gml:MultiCurve"),i=e.components||[e],n=0,r=i.length;n<r;++n)this.writeNode("curveMember",i[n],t);return t},curveMember:function(e){var t=this.createElementNSPlus("gml:curveMember");this.curve?this.writeNode("Curve",e,t):this.writeNode("LineString",e,t);return t},MultiSurface:function(e){for(var t=this.createElementNSPlus("gml:MultiSurface"),i=e.components||[e],n=0,r=i.length;n<r;++n)this.writeNode("surfaceMember",i[n],t);return t},surfaceMember:function(e){var t=this.createElementNSPlus("gml:surfaceMember");this.surface?this.writeNode("Surface",e,t):this.writeNode("Polygon",e,t);return t},Envelope:function(e){var t=this.createElementNSPlus("gml:Envelope");this.writeNode("lowerCorner",e,t);this.writeNode("upperCorner",e,t);this.srsName&&t.setAttribute("srsName",this.srsName);return t},lowerCorner:function(e){var t=this.xy?e.left+" "+e.bottom:e.bottom+" "+e.left;return this.createElementNSPlus("gml:lowerCorner",{value:t})},upperCorner:function(e){var t=this.xy?e.right+" "+e.top:e.top+" "+e.right;return this.createElementNSPlus("gml:upperCorner",{value:t})}},OpenLayers.Format.GML.Base.prototype.writers.gml),feature:OpenLayers.Format.GML.Base.prototype.writers.feature,wfs:OpenLayers.Format.GML.Base.prototype.writers.wfs},setGeometryTypes:function(){this.geometryTypes={"OpenLayers.Geometry.Point":"Point","OpenLayers.Geometry.MultiPoint":"MultiPoint","OpenLayers.Geometry.LineString":!0===this.curve?"Curve":"LineString","OpenLayers.Geometry.MultiLineString":!1===this.multiCurve?"MultiLineString":"MultiCurve","OpenLayers.Geometry.Polygon":!0===this.surface?"Surface":"Polygon","OpenLayers.Geometry.MultiPolygon":!1===this.multiSurface?"MultiPolygon":"MultiSurface","OpenLayers.Geometry.Collection":"GeometryCollection"}},CLASS_NAME:"OpenLayers.Format.GML.v3"});OpenLayers.Format.Filter.v1_1_0=OpenLayers.Class(OpenLayers.Format.GML.v3,OpenLayers.Format.Filter.v1,{VERSION:"1.1.0",schemaLocation:"http://www.opengis.net/ogc/filter/1.1.0/filter.xsd",initialize:function(e){OpenLayers.Format.GML.v3.prototype.initialize.apply(this,[e])},readers:{ogc:OpenLayers.Util.applyDefaults({PropertyIsEqualTo:function(e,t){var i=e.getAttribute("matchCase"),n=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.EQUAL_TO,matchCase:!("false"===i||"0"===i)});this.readChildNodes(e,n);t.filters.push(n)},PropertyIsNotEqualTo:function(e,t){var i=e.getAttribute("matchCase"),n=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.NOT_EQUAL_TO,matchCase:!("false"===i||"0"===i)});this.readChildNodes(e,n);t.filters.push(n)},PropertyIsLike:function(e,t){var i=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.LIKE});this.readChildNodes(e,i);var n=e.getAttribute("wildCard"),r=e.getAttribute("singleChar"),s=e.getAttribute("escapeChar");i.value2regex(n,r,s);t.filters.push(i)}},OpenLayers.Format.Filter.v1.prototype.readers.ogc),gml:OpenLayers.Format.GML.v3.prototype.readers.gml,feature:OpenLayers.Format.GML.v3.prototype.readers.feature},writers:{ogc:OpenLayers.Util.applyDefaults({PropertyIsEqualTo:function(e){var t=this.createElementNSPlus("ogc:PropertyIsEqualTo",{attributes:{matchCase:e.matchCase}});this.writeNode("PropertyName",e,t);this.writeOgcExpression(e.value,t);return t},PropertyIsNotEqualTo:function(e){var t=this.createElementNSPlus("ogc:PropertyIsNotEqualTo",{attributes:{matchCase:e.matchCase}});this.writeNode("PropertyName",e,t);this.writeOgcExpression(e.value,t);return t},PropertyIsLike:function(e){var t=this.createElementNSPlus("ogc:PropertyIsLike",{attributes:{matchCase:e.matchCase,wildCard:"*",singleChar:".",escapeChar:"!"}});this.writeNode("PropertyName",e,t);this.writeNode("Literal",e.regex2value(),t);return t},BBOX:function(e){var t=this.createElementNSPlus("ogc:BBOX");e.property&&this.writeNode("PropertyName",e,t);var i=this.writeNode("gml:Envelope",e.value);e.projection&&i.setAttribute("srsName",e.projection);t.appendChild(i);return t},SortBy:function(e){for(var t=this.createElementNSPlus("ogc:SortBy"),i=0,n=e.length;i<n;i++)this.writeNode("ogc:SortProperty",e[i],t);return t},SortProperty:function(e){var t=this.createElementNSPlus("ogc:SortProperty");this.writeNode("ogc:PropertyName",e,t);this.writeNode("ogc:SortOrder","DESC"==e.order?"DESC":"ASC",t);return t},SortOrder:function(e){return this.createElementNSPlus("ogc:SortOrder",{value:e})}},OpenLayers.Format.Filter.v1.prototype.writers.ogc),gml:OpenLayers.Format.GML.v3.prototype.writers.gml,feature:OpenLayers.Format.GML.v3.prototype.writers.feature},writeSpatial:function(e,t){var i=this.createElementNSPlus("ogc:"+t);this.writeNode("PropertyName",e,i);if(e.value instanceof OpenLayers.Filter.Function)this.writeNode("Function",e.value,i);else{var n;n=e.value instanceof OpenLayers.Geometry?this.writeNode("feature:_geometry",e.value).firstChild:this.writeNode("gml:Envelope",e.value);e.projection&&n.setAttribute("srsName",e.projection);i.appendChild(n)}return i},CLASS_NAME:"OpenLayers.Format.Filter.v1_1_0"});OpenLayers.Format.OWSCommon=OpenLayers.Class(OpenLayers.Format.XML.VersionedOGC,{defaultVersion:"1.0.0",getVersion:function(e,t){var i=this.version;if(!i){var n=e.getAttribute("xmlns:ows");n&&"1.1"===n.substring(n.lastIndexOf("/")+1)&&(i="1.1.0");i||(i=this.defaultVersion)}return i},CLASS_NAME:"OpenLayers.Format.OWSCommon"});OpenLayers.Format.OWSCommon.v1=OpenLayers.Class(OpenLayers.Format.XML,{regExes:{trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g},read:function(e,t){t=OpenLayers.Util.applyDefaults(t,this.options);var i={};this.readChildNodes(e,i);return i},readers:{ows:{Exception:function(e,t){var i={code:e.getAttribute("exceptionCode"),locator:e.getAttribute("locator"),texts:[]};t.exceptions.push(i);this.readChildNodes(e,i)},ExceptionText:function(e,t){var i=this.getChildValue(e);t.texts.push(i)},ServiceIdentification:function(e,t){t.serviceIdentification={};this.readChildNodes(e,t.serviceIdentification)},Title:function(e,t){t.title=this.getChildValue(e)},Abstract:function(e,t){t.abstract=this.getChildValue(e)},Keywords:function(e,t){t.keywords={};this.readChildNodes(e,t.keywords)},Keyword:function(e,t){t[this.getChildValue(e)]=!0},ServiceType:function(e,t){t.serviceType={codeSpace:e.getAttribute("codeSpace"),value:this.getChildValue(e)}},ServiceTypeVersion:function(e,t){t.serviceTypeVersion=this.getChildValue(e)},Fees:function(e,t){t.fees=this.getChildValue(e)},AccessConstraints:function(e,t){t.accessConstraints=this.getChildValue(e)},ServiceProvider:function(e,t){t.serviceProvider={};this.readChildNodes(e,t.serviceProvider)},ProviderName:function(e,t){t.providerName=this.getChildValue(e)},ProviderSite:function(e,t){t.providerSite=this.getAttributeNS(e,this.namespaces.xlink,"href")},ServiceContact:function(e,t){t.serviceContact={};this.readChildNodes(e,t.serviceContact)},IndividualName:function(e,t){t.individualName=this.getChildValue(e)},PositionName:function(e,t){t.positionName=this.getChildValue(e)},ContactInfo:function(e,t){t.contactInfo={};this.readChildNodes(e,t.contactInfo)},Phone:function(e,t){t.phone={};this.readChildNodes(e,t.phone)},Voice:function(e,t){t.voice=this.getChildValue(e)},Address:function(e,t){t.address={};this.readChildNodes(e,t.address)},DeliveryPoint:function(e,t){t.deliveryPoint=this.getChildValue(e)},City:function(e,t){t.city=this.getChildValue(e)},AdministrativeArea:function(e,t){t.administrativeArea=this.getChildValue(e)},PostalCode:function(e,t){t.postalCode=this.getChildValue(e)},Country:function(e,t){t.country=this.getChildValue(e)},ElectronicMailAddress:function(e,t){t.electronicMailAddress=this.getChildValue(e)},Role:function(e,t){t.role=this.getChildValue(e)},OperationsMetadata:function(e,t){t.operationsMetadata={};this.readChildNodes(e,t.operationsMetadata)},Operation:function(e,t){var i=e.getAttribute("name");t[i]={};this.readChildNodes(e,t[i])},DCP:function(e,t){t.dcp={};this.readChildNodes(e,t.dcp)},HTTP:function(e,t){t.http={};this.readChildNodes(e,t.http)},Get:function(e,t){t.get||(t.get=[]);var i={url:this.getAttributeNS(e,this.namespaces.xlink,"href")};this.readChildNodes(e,i);t.get.push(i)},Post:function(e,t){t.post||(t.post=[]);var i={url:this.getAttributeNS(e,this.namespaces.xlink,"href")};this.readChildNodes(e,i);t.post.push(i)},Parameter:function(e,t){t.parameters||(t.parameters={});var i=e.getAttribute("name");t.parameters[i]={};this.readChildNodes(e,t.parameters[i])},Constraint:function(e,t){t.constraints||(t.constraints={});var i=e.getAttribute("name");t.constraints[i]={};this.readChildNodes(e,t.constraints[i])},Value:function(e,t){t[this.getChildValue(e)]=!0},OutputFormat:function(e,t){t.formats.push({value:this.getChildValue(e)});this.readChildNodes(e,t)},WGS84BoundingBox:function(e,t){var i={};i.crs=e.getAttribute("crs");if(t.BoundingBox)t.BoundingBox.push(i);else{t.projection=i.crs;i=t}this.readChildNodes(e,i)},BoundingBox:function(e,t){this.readers.ows.WGS84BoundingBox.apply(this,[e,t])},LowerCorner:function(e,t){var i=this.getChildValue(e).replace(this.regExes.trimSpace,""),n=(i=i.replace(this.regExes.trimComma,",")).split(this.regExes.splitSpace);t.left=n[0];t.bottom=n[1]},UpperCorner:function(e,t){var i=this.getChildValue(e).replace(this.regExes.trimSpace,""),n=(i=i.replace(this.regExes.trimComma,",")).split(this.regExes.splitSpace);t.right=n[0];t.top=n[1];t.bounds=new OpenLayers.Bounds(t.left,t.bottom,t.right,t.top);delete t.left;delete t.bottom;delete t.right;delete t.top},Language:function(e,t){t.language=this.getChildValue(e)}}},writers:{ows:{BoundingBox:function(e,t){var i=this.createElementNSPlus(t||"ows:BoundingBox",{attributes:{crs:e.projection}});this.writeNode("ows:LowerCorner",e,i);this.writeNode("ows:UpperCorner",e,i);return i},LowerCorner:function(e){return this.createElementNSPlus("ows:LowerCorner",{value:e.bounds.left+" "+e.bounds.bottom})},UpperCorner:function(e){return this.createElementNSPlus("ows:UpperCorner",{value:e.bounds.right+" "+e.bounds.top})},Identifier:function(e){return this.createElementNSPlus("ows:Identifier",{value:e})},Title:function(e){return this.createElementNSPlus("ows:Title",{value:e})},Abstract:function(e){return this.createElementNSPlus("ows:Abstract",{value:e})},OutputFormat:function(e){return this.createElementNSPlus("ows:OutputFormat",{value:e})}}},CLASS_NAME:"OpenLayers.Format.OWSCommon.v1"});OpenLayers.Format.OWSCommon.v1_0_0=OpenLayers.Class(OpenLayers.Format.OWSCommon.v1,{namespaces:{ows:"http://www.opengis.net/ows",xlink:"http://www.w3.org/1999/xlink"},readers:{ows:OpenLayers.Util.applyDefaults({ExceptionReport:function(e,t){t.success=!1;t.exceptionReport={version:e.getAttribute("version"),language:e.getAttribute("language"),exceptions:[]};this.readChildNodes(e,t.exceptionReport)}},OpenLayers.Format.OWSCommon.v1.prototype.readers.ows)},writers:{ows:OpenLayers.Format.OWSCommon.v1.prototype.writers.ows},CLASS_NAME:"OpenLayers.Format.OWSCommon.v1_0_0"});OpenLayers.Format.WFST.v1_1_0=OpenLayers.Class(OpenLayers.Format.Filter.v1_1_0,OpenLayers.Format.WFST.v1,{version:"1.1.0",schemaLocations:{wfs:"http://schemas.opengis.net/wfs/1.1.0/wfs.xsd"},initialize:function(e){OpenLayers.Format.Filter.v1_1_0.prototype.initialize.apply(this,[e]);OpenLayers.Format.WFST.v1.prototype.initialize.apply(this,[e])},readNode:function(e,t,i){return OpenLayers.Format.GML.v3.prototype.readNode.apply(this,arguments)},readers:{wfs:OpenLayers.Util.applyDefaults({FeatureCollection:function(e,t){t.numberOfFeatures=parseInt(e.getAttribute("numberOfFeatures"));OpenLayers.Format.WFST.v1.prototype.readers.wfs.FeatureCollection.apply(this,arguments)},TransactionResponse:function(e,t){t.insertIds=[];t.success=!1;this.readChildNodes(e,t)},TransactionSummary:function(e,t){t.success=!0},InsertResults:function(e,t){this.readChildNodes(e,t)},Feature:function(e,t){var i={fids:[]};this.readChildNodes(e,i);t.insertIds.push(i.fids[0])}},OpenLayers.Format.WFST.v1.prototype.readers.wfs),gml:OpenLayers.Format.GML.v3.prototype.readers.gml,feature:OpenLayers.Format.GML.v3.prototype.readers.feature,ogc:OpenLayers.Format.Filter.v1_1_0.prototype.readers.ogc,ows:OpenLayers.Format.OWSCommon.v1_0_0.prototype.readers.ows},writers:{wfs:OpenLayers.Util.applyDefaults({GetFeature:function(e){var t=OpenLayers.Format.WFST.v1.prototype.writers.wfs.GetFeature.apply(this,arguments);e&&this.setAttributes(t,{resultType:e.resultType,startIndex:e.startIndex,count:e.count});return t},Query:function(e){var t=(e=OpenLayers.Util.extend({featureNS:this.featureNS,featurePrefix:this.featurePrefix,featureType:this.featureType,srsName:this.srsName},e)).featurePrefix,i=this.createElementNSPlus("wfs:Query",{attributes:{typeName:(t?t+":":"")+e.featureType,srsName:e.srsName}});e.featureNS&&i.setAttribute("xmlns:"+t,e.featureNS);if(e.propertyNames)for(var n=0,r=e.propertyNames.length;n<r;n++)this.writeNode("wfs:PropertyName",{property:e.propertyNames[n]},i);if(e.filter){OpenLayers.Format.WFST.v1_1_0.prototype.setFilterProperty.call(this,e.filter);this.writeNode("ogc:Filter",e.filter,i)}return i},PropertyName:function(e){return this.createElementNSPlus("wfs:PropertyName",{value:e.property})}},OpenLayers.Format.WFST.v1.prototype.writers.wfs),gml:OpenLayers.Format.GML.v3.prototype.writers.gml,feature:OpenLayers.Format.GML.v3.prototype.writers.feature,ogc:OpenLayers.Format.Filter.v1_1_0.prototype.writers.ogc},CLASS_NAME:"OpenLayers.Format.WFST.v1_1_0"});OpenLayers.Control=OpenLayers.Class({id:null,map:null,div:null,type:null,allowSelection:!1,displayClass:"",title:"",autoActivate:!1,active:null,handlerOptions:null,handler:null,eventListeners:null,events:null,initialize:function(e){this.displayClass=this.CLASS_NAME.replace("OpenLayers.","ol").replace(/\./g,"");OpenLayers.Util.extend(this,e);this.events=new OpenLayers.Events(this);this.eventListeners instanceof Object&&this.events.on(this.eventListeners);null==this.id&&(this.id=OpenLayers.Util.createUniqueID(this.CLASS_NAME+"_"))},destroy:function(){if(this.events){this.eventListeners&&this.events.un(this.eventListeners);this.events.destroy();this.events=null}this.eventListeners=null;if(this.handler){this.handler.destroy();this.handler=null}if(this.handlers){for(var e in this.handlers)this.handlers.hasOwnProperty(e)&&"function"==typeof this.handlers[e].destroy&&this.handlers[e].destroy();this.handlers=null}if(this.map){this.map.removeControl(this);this.map=null}this.div=null},setMap:function(e){this.map=e;this.handler&&this.handler.setMap(e)},draw:function(e){if(null==this.div){this.div=OpenLayers.Util.createDiv(this.id);this.div.className=this.displayClass;if(!this.allowSelection){this.div.className+=" olControlNoSelect";this.div.setAttribute("unselectable","on",0);this.div.onselectstart=OpenLayers.Function.False}""!=this.title&&(this.div.title=this.title)}null!=e&&(this.position=e.clone());this.moveTo(this.position);return this.div},moveTo:function(e){if(null!=e&&null!=this.div){this.div.style.left=e.x+"px";this.div.style.top=e.y+"px"}},activate:function(){if(this.active)return!1;this.handler&&this.handler.activate();this.active=!0;this.map&&OpenLayers.Element.addClass(this.map.viewPortDiv,this.displayClass.replace(/ /g,"")+"Active");this.events.triggerEvent("activate");return!0},deactivate:function(){if(this.active){this.handler&&this.handler.deactivate();this.active=!1;this.map&&OpenLayers.Element.removeClass(this.map.viewPortDiv,this.displayClass.replace(/ /g,"")+"Active");this.events.triggerEvent("deactivate");return!0}return!1},CLASS_NAME:"OpenLayers.Control"});OpenLayers.Control.TYPE_BUTTON=1;OpenLayers.Control.TYPE_TOGGLE=2;OpenLayers.Control.TYPE_TOOL=3;OpenLayers.Control.PanZoom=OpenLayers.Class(OpenLayers.Control,{slideFactor:50,slideRatio:null,buttons:null,position:null,initialize:function(e){this.position=new OpenLayers.Pixel(OpenLayers.Control.PanZoom.X,OpenLayers.Control.PanZoom.Y);OpenLayers.Control.prototype.initialize.apply(this,arguments)},destroy:function(){this.map&&this.map.events.unregister("buttonclick",this,this.onButtonClick);this.removeButtons();this.buttons=null;this.position=null;OpenLayers.Control.prototype.destroy.apply(this,arguments)},setMap:function(e){OpenLayers.Control.prototype.setMap.apply(this,arguments);this.map.events.register("buttonclick",this,this.onButtonClick)},draw:function(e){OpenLayers.Control.prototype.draw.apply(this,arguments);e=this.position;this.buttons=[];var t={w:18,h:18},i=new OpenLayers.Pixel(e.x+t.w/2,e.y);this._addButton("panup","north-mini.png",i,t);e.y=i.y+t.h;this._addButton("panleft","west-mini.png",e,t);this._addButton("panright","east-mini.png",e.add(t.w,0),t);this._addButton("pandown","south-mini.png",i.add(0,2*t.h),t);this._addButton("zoomin","zoom-plus-mini.png",i.add(0,3*t.h+5),t);this._addButton("zoomworld","zoom-world-mini.png",i.add(0,4*t.h+5),t);this._addButton("zoomout","zoom-minus-mini.png",i.add(0,5*t.h+5),t);return this.div},_addButton:function(e,t,i,n){var r=OpenLayers.Util.getImageLocation(t),s=OpenLayers.Util.createAlphaImageDiv(this.id+"_"+e,i,n,r,"absolute");s.style.cursor="pointer";this.div.appendChild(s);s.action=e;s.className="olButton";this.buttons.push(s);return s},_removeButton:function(e){this.div.removeChild(e);OpenLayers.Util.removeItem(this.buttons,e)},removeButtons:function(){for(var e=this.buttons.length-1;e>=0;--e)this._removeButton(this.buttons[e])},onButtonClick:function(e){switch(e.buttonElement.action){case"panup":this.map.pan(0,-this.getSlideFactor("h"));break;case"pandown":this.map.pan(0,this.getSlideFactor("h"));break;case"panleft":this.map.pan(-this.getSlideFactor("w"),0);break;case"panright":this.map.pan(this.getSlideFactor("w"),0);break;case"zoomin":this.map.zoomIn();break;case"zoomout":this.map.zoomOut();break;case"zoomworld":this.map.zoomToMaxExtent()}},getSlideFactor:function(e){return this.slideRatio?this.map.getSize()[e]*this.slideRatio:this.slideFactor},CLASS_NAME:"OpenLayers.Control.PanZoom"});OpenLayers.Control.PanZoom.X=4;OpenLayers.Control.PanZoom.Y=4;OpenLayers.Control.PanZoomBar=OpenLayers.Class(OpenLayers.Control.PanZoom,{zoomStopWidth:18,zoomStopHeight:11,slider:null,sliderEvents:null,zoombarDiv:null,zoomWorldIcon:!1,panIcons:!0,forceFixedZoomLevel:!1,mouseDragStart:null,deltaY:null,zoomStart:null,destroy:function(){this._removeZoomBar();this.map.events.un({changebaselayer:this.redraw,updatesize:this.redraw,scope:this});OpenLayers.Control.PanZoom.prototype.destroy.apply(this,arguments);delete this.mouseDragStart;delete this.zoomStart},setMap:function(e){OpenLayers.Control.PanZoom.prototype.setMap.apply(this,arguments);this.map.events.on({changebaselayer:this.redraw,updatesize:this.redraw,scope:this})},redraw:function(){if(null!=this.div){this.removeButtons();this._removeZoomBar()}this.draw()},draw:function(e){OpenLayers.Control.prototype.draw.apply(this,arguments);e=this.position.clone();this.buttons=[];var t={w:18,h:18};if(this.panIcons){var i=new OpenLayers.Pixel(e.x+t.w/2,e.y),n=t.w;this.zoomWorldIcon&&(i=new OpenLayers.Pixel(e.x+t.w,e.y));this._addButton("panup","north-mini.png",i,t);e.y=i.y+t.h;this._addButton("panleft","west-mini.png",e,t);if(this.zoomWorldIcon){this._addButton("zoomworld","zoom-world-mini.png",e.add(t.w,0),t);n*=2}this._addButton("panright","east-mini.png",e.add(n,0),t);this._addButton("pandown","south-mini.png",i.add(0,2*t.h),t);this._addButton("zoomin","zoom-plus-mini.png",i.add(0,3*t.h+5),t);i=this._addZoomBar(i.add(0,4*t.h+5));this._addButton("zoomout","zoom-minus-mini.png",i,t)}else{this._addButton("zoomin","zoom-plus-mini.png",e,t);i=this._addZoomBar(e.add(0,t.h));this._addButton("zoomout","zoom-minus-mini.png",i,t);if(this.zoomWorldIcon){i=i.add(0,t.h+3);this._addButton("zoomworld","zoom-world-mini.png",i,t)}}return this.div},_addZoomBar:function(e){var t=OpenLayers.Util.getImageLocation("slider.png"),i=this.id+"_"+this.map.id,n=this.map.getMinZoom(),r=this.map.getNumZoomLevels()-1-this.map.getZoom(),s=OpenLayers.Util.createAlphaImageDiv(i,e.add(-1,r*this.zoomStopHeight),{w:20,h:9},t,"absolute");s.style.cursor="move";this.slider=s;this.sliderEvents=new OpenLayers.Events(this,s,null,!0,{includeXY:!0});this.sliderEvents.on({touchstart:this.zoomBarDown,touchmove:this.zoomBarDrag,touchend:this.zoomBarUp,mousedown:this.zoomBarDown,mousemove:this.zoomBarDrag,mouseup:this.zoomBarUp});var a={w:this.zoomStopWidth,h:this.zoomStopHeight*(this.map.getNumZoomLevels()-n)},o=(t=OpenLayers.Util.getImageLocation("zoombar.png"),null);if(OpenLayers.Util.alphaHack()){i=this.id+"_"+this.map.id;(o=OpenLayers.Util.createAlphaImageDiv(i,e,{w:a.w,h:this.zoomStopHeight},t,"absolute",null,"crop")).style.height=a.h+"px"}else o=OpenLayers.Util.createDiv("OpenLayers_Control_PanZoomBar_Zoombar"+this.map.id,e,a,t);o.style.cursor="pointer";o.className="olButton";this.zoombarDiv=o;this.div.appendChild(o);this.startTop=parseInt(o.style.top);this.div.appendChild(s);this.map.events.register("zoomend",this,this.moveZoomBar);return e=e.add(0,this.zoomStopHeight*(this.map.getNumZoomLevels()-n))},_removeZoomBar:function(){this.sliderEvents.un({touchstart:this.zoomBarDown,touchmove:this.zoomBarDrag,touchend:this.zoomBarUp,mousedown:this.zoomBarDown,mousemove:this.zoomBarDrag,mouseup:this.zoomBarUp});this.sliderEvents.destroy();this.div.removeChild(this.zoombarDiv);this.zoombarDiv=null;this.div.removeChild(this.slider);this.slider=null;this.map.events.unregister("zoomend",this,this.moveZoomBar)},onButtonClick:function(e){OpenLayers.Control.PanZoom.prototype.onButtonClick.apply(this,arguments);if(e.buttonElement===this.zoombarDiv){var t=e.buttonXY.y/this.zoomStopHeight;!this.forceFixedZoomLevel&&this.map.fractionalZoom||(t=Math.floor(t));var i=this.map.getNumZoomLevels()-1-t;i=Math.min(Math.max(i,0),this.map.getNumZoomLevels()-1);this.map.zoomTo(i)}},passEventToSlider:function(e){this.sliderEvents.handleBrowserEvent(e)},zoomBarDown:function(e){if(OpenLayers.Event.isLeftClick(e)||OpenLayers.Event.isSingleTouch(e)){this.map.events.on({touchmove:this.passEventToSlider,mousemove:this.passEventToSlider,mouseup:this.passEventToSlider,scope:this});this.mouseDragStart=e.xy.clone();this.zoomStart=e.xy.clone();this.div.style.cursor="move";this.zoombarDiv.offsets=null;OpenLayers.Event.stop(e)}},zoomBarDrag:function(e){if(null!=this.mouseDragStart){var t=this.mouseDragStart.y-e.xy.y,i=OpenLayers.Util.pagePosition(this.zoombarDiv);if(e.clientY-i[1]>0&&e.clientY-i[1]<parseInt(this.zoombarDiv.style.height)-2){var n=parseInt(this.slider.style.top)-t;this.slider.style.top=n+"px";this.mouseDragStart=e.xy.clone()}this.deltaY=this.zoomStart.y-e.xy.y;OpenLayers.Event.stop(e)}},zoomBarUp:function(e){if((OpenLayers.Event.isLeftClick(e)||"touchend"===e.type)&&this.mouseDragStart){this.div.style.cursor="";this.map.events.un({touchmove:this.passEventToSlider,mouseup:this.passEventToSlider,mousemove:this.passEventToSlider,scope:this});var t=this.map.zoom;if(!this.forceFixedZoomLevel&&this.map.fractionalZoom){t+=this.deltaY/this.zoomStopHeight;t=Math.min(Math.max(t,0),this.map.getNumZoomLevels()-1)}else{t+=this.deltaY/this.zoomStopHeight;t=Math.max(Math.round(t),0)}this.map.zoomTo(t);this.mouseDragStart=null;this.zoomStart=null;this.deltaY=0;OpenLayers.Event.stop(e)}},moveZoomBar:function(){var e=(this.map.getNumZoomLevels()-1-this.map.getZoom())*this.zoomStopHeight+this.startTop+1;this.slider.style.top=e+"px"},CLASS_NAME:"OpenLayers.Control.PanZoomBar"});OpenLayers.Events.featureclick=OpenLayers.Class({cache:null,map:null,provides:["featureclick","nofeatureclick","featureover","featureout"],initialize:function(e){this.target=e;if(e.object instanceof OpenLayers.Map)this.setMap(e.object);else{if(!(e.object instanceof OpenLayers.Layer.Vector))throw"Listeners for '"+this.provides.join("', '")+"' events can only be registered for OpenLayers.Layer.Vector or OpenLayers.Map instances";e.object.map?this.setMap(e.object.map):e.object.events.register("added",this,function(t){this.setMap(e.object.map)})}for(var t=this.provides.length-1;t>=0;--t)e.extensions[this.provides[t]]=!0},setMap:function(e){this.map=e;this.cache={};e.events.register("mousedown",this,this.start,{extension:!0});e.events.register("mouseup",this,this.onClick,{extension:!0});e.events.register("touchstart",this,this.start,{extension:!0});e.events.register("touchmove",this,this.cancel,{extension:!0});e.events.register("touchend",this,this.onClick,{extension:!0});e.events.register("mousemove",this,this.onMousemove,{extension:!0})},start:function(e){this.startEvt=e},cancel:function(e){delete this.startEvt},onClick:function(e){if(this.startEvt&&("touchend"===e.type||OpenLayers.Event.isLeftClick(e))){var t=this.getFeatures(this.startEvt);delete this.startEvt;for(var i,n,r={},s=0,a=t.length;s<a;++s){r[(n=(i=t[s]).layer).id]=!0;if(!1===this.triggerEvent("featureclick",{feature:i}))break}for(s=0,a=this.map.layers.length;s<a;++s)(n=this.map.layers[s])instanceof OpenLayers.Layer.Vector&&!r[n.id]&&this.triggerEvent("nofeatureclick",{layer:n})}},onMousemove:function(e){delete this.startEvt;for(var t,i=this.getFeatures(e),n={},r=[],s=0,a=i.length;s<a;++s){n[(t=i[s]).id]=t;this.cache[t.id]||r.push(t)}var o=[];for(var l in this.cache)(t=this.cache[l]).layer&&t.layer.map?n[t.id]||o.push(t):delete this.cache[l];for(s=0,a=r.length;s<a;++s){t=r[s];this.cache[t.id]=t;if(!1===this.triggerEvent("featureover",{feature:t}))break}for(s=0,a=o.length;s<a;++s){t=o[s];delete this.cache[t.id];if(!1===this.triggerEvent("featureout",{feature:t}))break}},triggerEvent:function(e,t){var i=t.feature?t.feature.layer:t.layer,n=this.target.object;if(n instanceof OpenLayers.Map||n===i)return this.target.triggerEvent(e,t)},getFeatures:function(e){var t,i,n,r,s,a=e.clientX,o=e.clientY,l=[],c=[],u=[];for(r=this.map.layers.length-1;r>=0;--r)if("none"!==(t=this.map.layers[r]).div.style.display)if(t.renderer instanceof OpenLayers.Renderer.Elements){if(t instanceof OpenLayers.Layer.Vector){i=document.elementFromPoint(a,o);for(;i&&i._featureId;)if(n=t.getFeatureById(i._featureId)){l.push(n);i.style.display="none";c.push(i);i=document.elementFromPoint(a,o)}else i=!1}u.push(t);t.div.style.display="none"}else if(t.renderer instanceof OpenLayers.Renderer.Canvas&&(n=t.renderer.getFeatureIdFromEvent(e))){l.push(n);u.push(t)}for(r=0,s=c.length;r<s;++r)c[r].style.display="";for(r=u.length-1;r>=0;--r)u[r].div.style.display="block";return l},destroy:function(){for(var e=this.provides.length-1;e>=0;--e)delete this.target.extensions[this.provides[e]];this.map.events.un({mousemove:this.onMousemove,mousedown:this.start,mouseup:this.onClick,touchstart:this.start,touchmove:this.cancel,touchend:this.onClick,scope:this});delete this.cache;delete this.map;delete this.target}});OpenLayers.Events.nofeatureclick=OpenLayers.Events.featureclick;OpenLayers.Events.featureover=OpenLayers.Events.featureclick;OpenLayers.Events.featureout=OpenLayers.Events.featureclick;OpenLayers.Handler=OpenLayers.Class({id:null,control:null,map:null,keyMask:null,active:!1,evt:null,touch:!1,initialize:function(e,t,i){OpenLayers.Util.extend(this,i);this.control=e;this.callbacks=t;var n=this.map||e.map;n&&this.setMap(n);this.id=OpenLayers.Util.createUniqueID(this.CLASS_NAME+"_")},setMap:function(e){this.map=e},checkModifiers:function(e){return null==this.keyMask||((e.shiftKey?OpenLayers.Handler.MOD_SHIFT:0)|(e.ctrlKey?OpenLayers.Handler.MOD_CTRL:0)|(e.altKey?OpenLayers.Handler.MOD_ALT:0)|(e.metaKey?OpenLayers.Handler.MOD_META:0))==this.keyMask},activate:function(){if(this.active)return!1;for(var e=OpenLayers.Events.prototype.BROWSER_EVENTS,t=0,i=e.length;t<i;t++)this[e[t]]&&this.register(e[t],this[e[t]]);this.active=!0;return!0},deactivate:function(){if(!this.active)return!1;for(var e=OpenLayers.Events.prototype.BROWSER_EVENTS,t=0,i=e.length;t<i;t++)this[e[t]]&&this.unregister(e[t],this[e[t]]);this.touch=!1;this.active=!1;return!0},startTouch:function(){if(!this.touch){this.touch=!0;for(var e=["mousedown","mouseup","mousemove","click","dblclick","mouseout"],t=0,i=e.length;t<i;t++)this[e[t]]&&this.unregister(e[t],this[e[t]])}},callback:function(e,t){e&&this.callbacks[e]&&this.callbacks[e].apply(this.control,t)},register:function(e,t){this.map.events.registerPriority(e,this,t);this.map.events.registerPriority(e,this,this.setEvent)},unregister:function(e,t){this.map.events.unregister(e,this,t);this.map.events.unregister(e,this,this.setEvent)},setEvent:function(e){this.evt=e;return!0},destroy:function(){this.deactivate();this.control=this.map=null},CLASS_NAME:"OpenLayers.Handler"});OpenLayers.Handler.MOD_NONE=0;OpenLayers.Handler.MOD_SHIFT=1;OpenLayers.Handler.MOD_CTRL=2;OpenLayers.Handler.MOD_ALT=4;OpenLayers.Handler.MOD_META=8;OpenLayers.Handler.Point=OpenLayers.Class(OpenLayers.Handler,{point:null,layer:null,multi:!1,citeCompliant:!1,mouseDown:!1,stoppedDown:null,lastDown:null,lastUp:null,persist:!1,stopDown:!1,stopUp:!1,layerOptions:null,pixelTolerance:5,lastTouchPx:null,initialize:function(e,t,i){i&&i.layerOptions&&i.layerOptions.styleMap||(this.style=OpenLayers.Util.extend(OpenLayers.Feature.Vector.style.default,{}));OpenLayers.Handler.prototype.initialize.apply(this,arguments)},activate:function(){if(!OpenLayers.Handler.prototype.activate.apply(this,arguments))return!1;var e=OpenLayers.Util.extend({displayInLayerSwitcher:!1,calculateInRange:OpenLayers.Function.True,wrapDateLine:this.citeCompliant},this.layerOptions);this.layer=new OpenLayers.Layer.Vector(this.CLASS_NAME,e);this.map.addLayer(this.layer);return!0},createFeature:function(e){var t=this.layer.getLonLatFromViewPortPx(e),i=new OpenLayers.Geometry.Point(t.lon,t.lat);this.point=new OpenLayers.Feature.Vector(i);this.callback("create",[this.point.geometry,this.point]);this.point.geometry.clearBounds();this.layer.addFeatures([this.point],{silent:!0})},deactivate:function(){if(!OpenLayers.Handler.prototype.deactivate.apply(this,arguments))return!1;this.cancel();if(null!=this.layer.map){this.destroyFeature(!0);this.layer.destroy(!1)}this.layer=null;return!0},destroyFeature:function(e){!this.layer||!e&&this.persist||this.layer.destroyFeatures();this.point=null},destroyPersistedFeature:function(){var e=this.layer;e&&e.features.length>1&&this.layer.features[0].destroy()},finalize:function(e){var t=e?"cancel":"done";this.mouseDown=!1;this.lastDown=null;this.lastUp=null;this.lastTouchPx=null;this.callback(t,[this.geometryClone()]);this.destroyFeature(e)},cancel:function(){this.finalize(!0)},click:function(e){OpenLayers.Event.stop(e);return!1},dblclick:function(e){OpenLayers.Event.stop(e);return!1},modifyFeature:function(e){this.point||this.createFeature(e);var t=this.layer.getLonLatFromViewPortPx(e);this.point.geometry.x=t.lon;this.point.geometry.y=t.lat;this.callback("modify",[this.point.geometry,this.point,!1]);this.point.geometry.clearBounds();this.drawFeature()},drawFeature:function(){this.layer.drawFeature(this.point,this.style)},getGeometry:function(){var e=this.point&&this.point.geometry;e&&this.multi&&(e=new OpenLayers.Geometry.MultiPoint([e]));return e},geometryClone:function(){var e=this.getGeometry();return e&&e.clone()},mousedown:function(e){return this.down(e)},touchstart:function(e){this.startTouch();this.lastTouchPx=e.xy;return this.down(e)},mousemove:function(e){return this.move(e)},touchmove:function(e){this.lastTouchPx=e.xy;return this.move(e)},mouseup:function(e){return this.up(e)},touchend:function(e){e.xy=this.lastTouchPx;return this.up(e)},down:function(e){this.mouseDown=!0;this.lastDown=e.xy;this.touch||this.modifyFeature(e.xy);this.stoppedDown=this.stopDown;return!this.stopDown},move:function(e){this.touch||this.mouseDown&&!this.stoppedDown||this.modifyFeature(e.xy);return!0},up:function(e){this.mouseDown=!1;this.stoppedDown=this.stopDown;if(!this.checkModifiers(e))return!0;if(this.lastUp&&this.lastUp.equals(e.xy))return!0;if(this.lastDown&&this.passesTolerance(this.lastDown,e.xy,this.pixelTolerance)){this.touch&&this.modifyFeature(e.xy);this.persist&&this.destroyPersistedFeature();this.lastUp=e.xy;this.finalize();return!this.stopUp}return!0},mouseout:function(e){if(OpenLayers.Util.mouseLeft(e,this.map.viewPortDiv)){this.stoppedDown=this.stopDown;this.mouseDown=!1}},passesTolerance:function(e,t,i){var n=!0;if(null!=i&&e&&t){e.distanceTo(t)>i&&(n=!1)}return n},CLASS_NAME:"OpenLayers.Handler.Point"});OpenLayers.Handler.Path=OpenLayers.Class(OpenLayers.Handler.Point,{line:null,maxVertices:null,doubleTouchTolerance:20,freehand:!1,freehandToggle:"shiftKey",timerId:null,redoStack:null,createFeature:function(e){var t=this.layer.getLonLatFromViewPortPx(e),i=new OpenLayers.Geometry.Point(t.lon,t.lat);this.point=new OpenLayers.Feature.Vector(i);this.line=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.LineString([this.point.geometry]));this.callback("create",[this.point.geometry,this.getSketch()]);this.point.geometry.clearBounds();this.layer.addFeatures([this.line,this.point],{silent:!0})},destroyFeature:function(e){OpenLayers.Handler.Point.prototype.destroyFeature.call(this,e);this.line=null},destroyPersistedFeature:function(){var e=this.layer;e&&e.features.length>2&&this.layer.features[0].destroy()},removePoint:function(){this.point&&this.layer.removeFeatures([this.point])},addPoint:function(e){this.layer.removeFeatures([this.point]);var t=this.layer.getLonLatFromViewPortPx(e);this.point=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(t.lon,t.lat));this.line.geometry.addComponent(this.point.geometry,this.line.geometry.components.length);this.layer.addFeatures([this.point]);this.callback("point",[this.point.geometry,this.getGeometry()]);this.callback("modify",[this.point.geometry,this.getSketch()]);this.drawFeature();delete this.redoStack},insertXY:function(e,t){this.line.geometry.addComponent(new OpenLayers.Geometry.Point(e,t),this.getCurrentPointIndex());this.drawFeature();delete this.redoStack},insertDeltaXY:function(e,t){var i=this.getCurrentPointIndex()-1,n=this.line.geometry.components[i];!n||isNaN(n.x)||isNaN(n.y)||this.insertXY(n.x+e,n.y+t)},insertDirectionLength:function(e,t){e*=Math.PI/180;var i=t*Math.cos(e),n=t*Math.sin(e);this.insertDeltaXY(i,n)},insertDeflectionLength:function(e,t){var i=this.getCurrentPointIndex()-1;if(i>0){var n=this.line.geometry.components[i],r=this.line.geometry.components[i-1],s=Math.atan2(n.y-r.y,n.x-r.x);this.insertDirectionLength(180*s/Math.PI+e,t)}},getCurrentPointIndex:function(){return this.line.geometry.components.length-1},undo:function(){var e=this.line.geometry,t=e.components,i=this.getCurrentPointIndex()-1,n=t[i],r=e.removeComponent(n);if(r){if(this.touch&&i>0){var s=(t=e.components)[i-1],a=t[this.getCurrentPointIndex()];a.x=s.x;a.y=s.y}this.redoStack||(this.redoStack=[]);this.redoStack.push(n);this.drawFeature()}return r},redo:function(){var e=this.redoStack&&this.redoStack.pop();if(e){this.line.geometry.addComponent(e,this.getCurrentPointIndex());this.drawFeature()}return!!e},freehandMode:function(e){return this.freehandToggle&&e[this.freehandToggle]?!this.freehand:this.freehand},modifyFeature:function(e,t){this.line||this.createFeature(e);var i=this.layer.getLonLatFromViewPortPx(e);this.point.geometry.x=i.lon;this.point.geometry.y=i.lat;this.callback("modify",[this.point.geometry,this.getSketch(),t]);this.point.geometry.clearBounds();this.drawFeature()},drawFeature:function(){this.layer.drawFeature(this.line,this.style);this.layer.drawFeature(this.point,this.style)},getSketch:function(){return this.line},getGeometry:function(){var e=this.line&&this.line.geometry;e&&this.multi&&(e=new OpenLayers.Geometry.MultiLineString([e]));return e},touchstart:function(e){if(this.timerId&&this.passesTolerance(this.lastTouchPx,e.xy,this.doubleTouchTolerance)){this.finishGeometry();window.clearTimeout(this.timerId);this.timerId=null;return!1}if(this.timerId){window.clearTimeout(this.timerId);this.timerId=null}this.timerId=window.setTimeout(OpenLayers.Function.bind(function(){this.timerId=null},this),300);return OpenLayers.Handler.Point.prototype.touchstart.call(this,e)},down:function(e){var t=this.stopDown;if(this.freehandMode(e)){t=!0;if(this.touch){this.modifyFeature(e.xy,!!this.lastUp);OpenLayers.Event.stop(e)}}this.touch||this.lastDown&&this.passesTolerance(this.lastDown,e.xy,this.pixelTolerance)||this.modifyFeature(e.xy,!!this.lastUp);this.mouseDown=!0;this.lastDown=e.xy;this.stoppedDown=t;return!t},move:function(e){if(this.stoppedDown&&this.freehandMode(e)){this.persist&&this.destroyPersistedFeature();if(this.maxVertices&&this.line&&this.line.geometry.components.length===this.maxVertices){this.removePoint();this.finalize()}else this.addPoint(e.xy);return!1}this.touch||this.mouseDown&&!this.stoppedDown||this.modifyFeature(e.xy,!!this.lastUp);return!0},up:function(e){if(this.mouseDown&&(!this.lastUp||!this.lastUp.equals(e.xy)))if(this.stoppedDown&&this.freehandMode(e)){this.persist&&this.destroyPersistedFeature();this.removePoint();this.finalize()}else if(this.passesTolerance(this.lastDown,e.xy,this.pixelTolerance)){this.touch&&this.modifyFeature(e.xy);null==this.lastUp&&this.persist&&this.destroyPersistedFeature();this.addPoint(e.xy);this.lastUp=e.xy;this.line.geometry.components.length===this.maxVertices+1&&this.finishGeometry()}this.stoppedDown=this.stopDown;this.mouseDown=!1;return!this.stopUp},finishGeometry:function(){var e=this.line.geometry.components.length-1;this.line.geometry.removeComponent(this.line.geometry.components[e]);this.removePoint();this.finalize()},dblclick:function(e){this.freehandMode(e)||this.finishGeometry();return!1},CLASS_NAME:"OpenLayers.Handler.Path"});OpenLayers.Handler.Polygon=OpenLayers.Class(OpenLayers.Handler.Path,{holeModifier:null,drawingHole:!1,polygon:null,createFeature:function(e){var t=this.layer.getLonLatFromViewPortPx(e),i=new OpenLayers.Geometry.Point(t.lon,t.lat);this.point=new OpenLayers.Feature.Vector(i);this.line=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.LinearRing([this.point.geometry]));this.polygon=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Polygon([this.line.geometry]));this.callback("create",[this.point.geometry,this.getSketch()]);this.point.geometry.clearBounds();this.layer.addFeatures([this.polygon,this.point],{silent:!0})},addPoint:function(e){if(!this.drawingHole&&this.holeModifier&&this.evt&&this.evt[this.holeModifier])for(var t,i,n=this.point.geometry,r=this.control.layer.features,s=r.length-1;s>=0;--s)if(((t=r[s].geometry)instanceof OpenLayers.Geometry.Polygon||t instanceof OpenLayers.Geometry.MultiPolygon)&&t.intersects(n)){i=r[s];this.control.layer.removeFeatures([i],{silent:!0});this.control.layer.events.registerPriority("sketchcomplete",this,this.finalizeInteriorRing);this.control.layer.events.registerPriority("sketchmodified",this,this.enforceTopology);i.geometry.addComponent(this.line.geometry);this.polygon=i;this.drawingHole=!0;break}OpenLayers.Handler.Path.prototype.addPoint.apply(this,arguments)},getCurrentPointIndex:function(){return this.line.geometry.components.length-2},enforceTopology:function(e){var t=e.vertex,i=this.line.geometry.components;if(!this.polygon.geometry.intersects(t)){var n=i[i.length-3];t.x=n.x;t.y=n.y}},finishGeometry:function(){var e=this.line.geometry.components.length-2;this.line.geometry.removeComponent(this.line.geometry.components[e]);this.removePoint();this.finalize()},finalizeInteriorRing:function(){var e=this.line.geometry,t=0!==e.getArea();if(t){for(var i=this.polygon.geometry.components,n=i.length-2;n>=0;--n)if(e.intersects(i[n])){t=!1;break}if(t){e:for(n=i.length-2;n>0;--n)for(var r=i[n].components,s=0,a=r.length;s<a;++s)if(e.containsPoint(r[s])){t=!1;break e}}}t?this.polygon.state!==OpenLayers.State.INSERT&&(this.polygon.state=OpenLayers.State.UPDATE):this.polygon.geometry.removeComponent(e);this.restoreFeature();return!1},cancel:function(){if(this.drawingHole){this.polygon.geometry.removeComponent(this.line.geometry);this.restoreFeature(!0)}return OpenLayers.Handler.Path.prototype.cancel.apply(this,arguments)},restoreFeature:function(e){this.control.layer.events.unregister("sketchcomplete",this,this.finalizeInteriorRing);this.control.layer.events.unregister("sketchmodified",this,this.enforceTopology);this.layer.removeFeatures([this.polygon],{silent:!0});this.control.layer.addFeatures([this.polygon],{silent:!0});this.drawingHole=!1;e||this.control.layer.events.triggerEvent("sketchcomplete",{feature:this.polygon})},destroyFeature:function(e){OpenLayers.Handler.Path.prototype.destroyFeature.call(this,e);this.polygon=null},drawFeature:function(){this.layer.drawFeature(this.polygon,this.style);this.layer.drawFeature(this.point,this.style)},getSketch:function(){return this.polygon},getGeometry:function(){var e=this.polygon&&this.polygon.geometry;e&&this.multi&&(e=new OpenLayers.Geometry.MultiPolygon([e]));return e},CLASS_NAME:"OpenLayers.Handler.Polygon"});OpenLayers.Renderer=OpenLayers.Class({container:null,root:null,extent:null,locked:!1,size:null,resolution:null,map:null,featureDx:0,initialize:function(e,t){this.container=OpenLayers.Util.getElement(e);OpenLayers.Util.extend(this,t)},destroy:function(){this.container=null;this.extent=null;this.size=null;this.resolution=null;this.map=null},supported:function(){return!1},setExtent:function(e,t){this.extent=e.clone();if(this.map.baseLayer&&this.map.baseLayer.wrapDateLine){var i=e.getWidth()/this.map.getExtent().getWidth();e=e.scale(1/i);this.extent=e.wrapDateLine(this.map.getMaxExtent()).scale(i)}t&&(this.resolution=null);return!0},setSize:function(e){this.size=e.clone();this.resolution=null},getResolution:function(){this.resolution=this.resolution||this.map.getResolution();return this.resolution},drawFeature:function(e,t){null==t&&(t=e.style);if(e.geometry){var i=e.geometry.getBounds();if(i){var n;this.map.baseLayer&&this.map.baseLayer.wrapDateLine&&(n=this.map.getMaxExtent());i.intersectsBounds(this.extent,{worldBounds:n})?this.calculateFeatureDx(i,n):t={display:"none"};var r=this.drawGeometry(e.geometry,t,e.id);if("none"!=t.display&&t.label&&!1!==r){var s=e.geometry.getCentroid();if(t.labelXOffset||t.labelYOffset){var a=isNaN(t.labelXOffset)?0:t.labelXOffset,o=isNaN(t.labelYOffset)?0:t.labelYOffset,l=this.getResolution();s.move(a*l,o*l)}this.drawText(e.id,t,s)}else this.removeText(e.id);return r}}},calculateFeatureDx:function(e,t){this.featureDx=0;if(t){var i=t.getWidth(),n=(this.extent.left+this.extent.right)/2,r=(e.left+e.right)/2,s=Math.round((r-n)/i);this.featureDx=s*i}},drawGeometry:function(e,t,i){},drawText:function(e,t,i){},removeText:function(e){},clear:function(){},getFeatureIdFromEvent:function(e){},eraseFeatures:function(e){OpenLayers.Util.isArray(e)||(e=[e]);for(var t=0,i=e.length;t<i;++t){var n=e[t];this.eraseGeometry(n.geometry,n.id);this.removeText(n.id)}},eraseGeometry:function(e,t){},moveRoot:function(e){},getRenderLayerId:function(){return this.container.id},applyDefaultSymbolizer:function(e){var t=OpenLayers.Util.extend({},OpenLayers.Renderer.defaultSymbolizer);if(!1===e.stroke){delete t.strokeWidth;delete t.strokeColor}!1===e.fill&&delete t.fillColor;OpenLayers.Util.extend(t,e);return t},CLASS_NAME:"OpenLayers.Renderer"});OpenLayers.Renderer.defaultSymbolizer={fillColor:"#000000",strokeColor:"#000000",strokeWidth:2,fillOpacity:1,strokeOpacity:1,pointRadius:0,labelAlign:"cm"};OpenLayers.Renderer.symbol={star:[350,75,379,161,469,161,397,215,423,301,350,250,277,301,303,215,231,161,321,161,350,75],cross:[4,0,6,0,6,4,10,4,10,6,6,6,6,10,4,10,4,6,0,6,0,4,4,4,4,0],x:[0,0,25,0,50,35,75,0,100,0,65,50,100,100,75,100,50,65,25,100,0,100,35,50,0,0],square:[0,0,0,1,1,1,1,0,0,0],triangle:[0,10,10,10,5,0,0,10]};OpenLayers.Renderer.Canvas=OpenLayers.Class(OpenLayers.Renderer,{hitDetection:!0,hitOverflow:0,canvas:null,features:null,pendingRedraw:!1,cachedSymbolBounds:{},initialize:function(e,t){OpenLayers.Renderer.prototype.initialize.apply(this,arguments);this.root=document.createElement("canvas");this.container.appendChild(this.root);this.canvas=this.root.getContext("2d");this.features={};if(this.hitDetection){this.hitCanvas=document.createElement("canvas");this.hitContext=this.hitCanvas.getContext("2d")}},setExtent:function(){OpenLayers.Renderer.prototype.setExtent.apply(this,arguments);return!1},eraseGeometry:function(e,t){this.eraseFeatures(this.features[t][0])},supported:function(){return OpenLayers.CANVAS_SUPPORTED},setSize:function(e){this.size=e.clone();var t=this.root;t.style.width=e.w+"px";t.style.height=e.h+"px";t.width=e.w;t.height=e.h;this.resolution=null;if(this.hitDetection){var i=this.hitCanvas;i.style.width=e.w+"px";i.style.height=e.h+"px";i.width=e.w;i.height=e.h}},drawFeature:function(e,t){var i;if(e.geometry){t=this.applyDefaultSymbolizer(t||e.style);var n,r=e.geometry.getBounds();this.map.baseLayer&&this.map.baseLayer.wrapDateLine&&(n=this.map.getMaxExtent());var s=r&&r.intersectsBounds(this.extent,{worldBounds:n});(i="none"!==t.display&&!!r&&s)?this.features[e.id]=[e,t]:delete this.features[e.id];this.pendingRedraw=!0}if(this.pendingRedraw&&!this.locked){this.redraw();this.pendingRedraw=!1}return i},drawGeometry:function(e,t,i){var n=e.CLASS_NAME;if("OpenLayers.Geometry.Collection"!=n&&"OpenLayers.Geometry.MultiPoint"!=n&&"OpenLayers.Geometry.MultiLineString"!=n&&"OpenLayers.Geometry.MultiPolygon"!=n)switch(e.CLASS_NAME){case"OpenLayers.Geometry.Point":this.drawPoint(e,t,i);break;case"OpenLayers.Geometry.LineString":this.drawLineString(e,t,i);break;case"OpenLayers.Geometry.LinearRing":this.drawLinearRing(e,t,i);break;case"OpenLayers.Geometry.Polygon":this.drawPolygon(e,t,i)}else for(var r=0;r<e.components.length;r++)this.drawGeometry(e.components[r],t,i)},drawExternalGraphic:function(e,t,i){var n=new Image,r=t.title||t.graphicTitle;r&&(n.title=r);var s=t.graphicWidth||t.graphicHeight,a=t.graphicHeight||t.graphicWidth;s=s||2*t.pointRadius;a=a||2*t.pointRadius;var o=void 0!=t.graphicXOffset?t.graphicXOffset:-.5*s,l=void 0!=t.graphicYOffset?t.graphicYOffset:-.5*a,c=t.graphicOpacity||t.fillOpacity;n.onload=OpenLayers.Function.bind(function(){if(this.features[i]){var t=this.getLocalXY(e),r=t[0],u=t[1];if(!isNaN(r)&&!isNaN(u)){var h=r+o|0,p=u+l|0,d=this.canvas;d.globalAlpha=c;var f=OpenLayers.Renderer.Canvas.drawImageScaleFactor||(OpenLayers.Renderer.Canvas.drawImageScaleFactor=/android 2.1/.test(navigator.userAgent.toLowerCase())?320/window.screen.width:1);d.drawImage(n,h*f,p*f,s*f,a*f);if(this.hitDetection){this.setHitContextStyle("fill",i);this.hitContext.fillRect(h,p,s,a)}}}},this);n.src=t.externalGraphic},drawNamedSymbol:function(e,t,i){var n,r,s,a,o,l,c,u,h,p=Math.PI/180,d=OpenLayers.Renderer.symbol[t.graphicName];if(!d)throw new Error(t.graphicName+" is not a valid symbol name");if(d.length&&!(d.length<2)){var f=this.getLocalXY(e),m=f[0],y=f[1];if(!isNaN(m)&&!isNaN(y)){this.canvas.lineCap="round";this.canvas.lineJoin="round";if(this.hitDetection){this.hitContext.lineCap="round";this.hitContext.lineJoin="round"}if(t.graphicName in this.cachedSymbolBounds)l=this.cachedSymbolBounds[t.graphicName];else{l=new OpenLayers.Bounds;for(o=0;o<d.length;o+=2)l.extend(new OpenLayers.LonLat(d[o],d[o+1]));this.cachedSymbolBounds[t.graphicName]=l}this.canvas.save();this.hitDetection&&this.hitContext.save();this.canvas.translate(m,y);this.hitDetection&&this.hitContext.translate(m,y);u=p*t.rotation;if(!isNaN(u)){this.canvas.rotate(u);this.hitDetection&&this.hitContext.rotate(u)}c=2*t.pointRadius/Math.max(l.getWidth(),l.getHeight());this.canvas.scale(c,c);this.hitDetection&&this.hitContext.scale(c,c);s=l.getCenterLonLat().lon;a=l.getCenterLonLat().lat;this.canvas.translate(-s,-a);this.hitDetection&&this.hitContext.translate(-s,-a);h=t.strokeWidth;t.strokeWidth=h/c;if(!1!==t.fill){this.setCanvasStyle("fill",t);this.canvas.beginPath();for(o=0;o<d.length;o+=2){n=d[o];r=d[o+1];0==o&&this.canvas.moveTo(n,r);this.canvas.lineTo(n,r)}this.canvas.closePath();this.canvas.fill();if(this.hitDetection){this.setHitContextStyle("fill",i,t);this.hitContext.beginPath();for(o=0;o<d.length;o+=2){n=d[o];r=d[o+1];0==o&&this.canvas.moveTo(n,r);this.hitContext.lineTo(n,r)}this.hitContext.closePath();this.hitContext.fill()}}if(!1!==t.stroke){this.setCanvasStyle("stroke",t);this.canvas.beginPath();for(o=0;o<d.length;o+=2){n=d[o];r=d[o+1];0==o&&this.canvas.moveTo(n,r);this.canvas.lineTo(n,r)}this.canvas.closePath();this.canvas.stroke();if(this.hitDetection){this.setHitContextStyle("stroke",i,t,c);this.hitContext.beginPath();for(o=0;o<d.length;o+=2){n=d[o];r=d[o+1];0==o&&this.hitContext.moveTo(n,r);this.hitContext.lineTo(n,r)}this.hitContext.closePath();this.hitContext.stroke()}}t.strokeWidth=h;this.canvas.restore();this.hitDetection&&this.hitContext.restore();this.setCanvasStyle("reset")}}},setCanvasStyle:function(e,t){if("fill"===e){this.canvas.globalAlpha=t.fillOpacity;this.canvas.fillStyle=t.fillColor}else if("stroke"===e){this.canvas.globalAlpha=t.strokeOpacity;this.canvas.strokeStyle=t.strokeColor;this.canvas.lineWidth=t.strokeWidth}else{this.canvas.globalAlpha=0;this.canvas.lineWidth=1}},featureIdToHex:function(e){var t=Number(e.split("_").pop())+1;if(t>=16777216){this.hitOverflow=t-16777215;t=t%16777216+1}var i="000000"+t.toString(16),n=i.length;return i="#"+i.substring(n-6,n)},setHitContextStyle:function(e,t,i,n){var r=this.featureIdToHex(t);if("fill"==e){this.hitContext.globalAlpha=1;this.hitContext.fillStyle=r}else if("stroke"==e){this.hitContext.globalAlpha=1;this.hitContext.strokeStyle=r;void 0===n?this.hitContext.lineWidth=i.strokeWidth+2:isNaN(n)||(this.hitContext.lineWidth=i.strokeWidth+2/n)}else{this.hitContext.globalAlpha=0;this.hitContext.lineWidth=1}},drawPoint:function(e,t,i){if(!1!==t.graphic)if(t.externalGraphic)this.drawExternalGraphic(e,t,i);else if(t.graphicName&&"circle"!=t.graphicName)this.drawNamedSymbol(e,t,i);else{var n=this.getLocalXY(e),r=n[0],s=n[1];if(!isNaN(r)&&!isNaN(s)){var a=2*Math.PI,o=t.pointRadius;if(!1!==t.fill){this.setCanvasStyle("fill",t);this.canvas.beginPath();this.canvas.arc(r,s,o,0,a,!0);this.canvas.fill();if(this.hitDetection){this.setHitContextStyle("fill",i,t);this.hitContext.beginPath();this.hitContext.arc(r,s,o,0,a,!0);this.hitContext.fill()}}if(!1!==t.stroke){this.setCanvasStyle("stroke",t);this.canvas.beginPath();this.canvas.arc(r,s,o,0,a,!0);this.canvas.stroke();if(this.hitDetection){this.setHitContextStyle("stroke",i,t);this.hitContext.beginPath();this.hitContext.arc(r,s,o,0,a,!0);this.hitContext.stroke()}this.setCanvasStyle("reset")}}}},drawLineString:function(e,t,i){t=OpenLayers.Util.applyDefaults({fill:!1},t);this.drawLinearRing(e,t,i)},drawLinearRing:function(e,t,i){if(!1!==t.fill){this.setCanvasStyle("fill",t);this.renderPath(this.canvas,e,t,i,"fill");if(this.hitDetection){this.setHitContextStyle("fill",i,t);this.renderPath(this.hitContext,e,t,i,"fill")}}if(!1!==t.stroke){this.setCanvasStyle("stroke",t);this.renderPath(this.canvas,e,t,i,"stroke");if(this.hitDetection){this.setHitContextStyle("stroke",i,t);this.renderPath(this.hitContext,e,t,i,"stroke")}}this.setCanvasStyle("reset")},renderPath:function(e,t,i,n,r){var s=t.components,a=s.length;e.beginPath();var o=this.getLocalXY(s[0]),l=o[0],c=o[1];if(!isNaN(l)&&!isNaN(c)){e.moveTo(o[0],o[1]);for(var u=1;u<a;++u){var h=this.getLocalXY(s[u]);e.lineTo(h[0],h[1])}"fill"===r?e.fill():e.stroke()}},drawPolygon:function(e,t,i){var n=e.components,r=n.length;this.drawLinearRing(n[0],t,i);for(var s=1;s<r;++s){this.canvas.globalCompositeOperation="destination-out";this.hitDetection&&(this.hitContext.globalCompositeOperation="destination-out");this.drawLinearRing(n[s],OpenLayers.Util.applyDefaults({stroke:!1,fillOpacity:1},t),i);this.canvas.globalCompositeOperation="source-over";this.hitDetection&&(this.hitContext.globalCompositeOperation="source-over");this.drawLinearRing(n[s],OpenLayers.Util.applyDefaults({fill:!1},t),i)}},drawText:function(e,t){var i=this.getLocalXY(e);this.setCanvasStyle("reset");this.canvas.fillStyle=t.fontColor;this.canvas.globalAlpha=t.fontOpacity||1;var n=[t.fontStyle?t.fontStyle:"normal","normal",t.fontWeight?t.fontWeight:"normal",t.fontSize?t.fontSize:"1em",t.fontFamily?t.fontFamily:"sans-serif"].join(" "),r=t.label.split("\n"),s=r.length;if(this.canvas.fillText){this.canvas.font=n;this.canvas.textAlign=OpenLayers.Renderer.Canvas.LABEL_ALIGN[t.labelAlign[0]]||"center";this.canvas.textBaseline=OpenLayers.Renderer.Canvas.LABEL_ALIGN[t.labelAlign[1]]||"middle";null==(l=OpenLayers.Renderer.Canvas.LABEL_FACTOR[t.labelAlign[1]])&&(l=-.5);var a=this.canvas.measureText("Mg").height||this.canvas.measureText("xx").width;i[1]+=a*l*(s-1);for(var o=0;o<s;o++){if(t.labelOutlineWidth){this.canvas.save();this.canvas.globalAlpha=t.labelOutlineOpacity||t.fontOpacity||1;this.canvas.strokeStyle=t.labelOutlineColor;this.canvas.lineWidth=t.labelOutlineWidth;this.canvas.strokeText(r[o],i[0],i[1]+a*o+1);this.canvas.restore()}this.canvas.fillText(r[o],i[0],i[1]+a*o)}}else if(this.canvas.mozDrawText){this.canvas.mozTextStyle=n;var l,c=OpenLayers.Renderer.Canvas.LABEL_FACTOR[t.labelAlign[0]];null==c&&(c=-.5);null==(l=OpenLayers.Renderer.Canvas.LABEL_FACTOR[t.labelAlign[1]])&&(l=-.5);a=this.canvas.mozMeasureText("xx");i[1]+=a*(1+l*s);for(o=0;o<s;o++){var u=i[0]+c*this.canvas.mozMeasureText(r[o]),h=i[1]+o*a;this.canvas.translate(u,h);this.canvas.mozDrawText(r[o]);this.canvas.translate(-u,-h)}}this.setCanvasStyle("reset")},getLocalXY:function(e){var t=this.getResolution(),i=this.extent;return[(e.x-this.featureDx)/t+-i.left/t,i.top/t-e.y/t]},clear:function(){var e=this.root.height,t=this.root.width;this.canvas.clearRect(0,0,t,e);this.features={};this.hitDetection&&this.hitContext.clearRect(0,0,t,e)},getFeatureIdFromEvent:function(e){var t,i;if(this.hitDetection&&"none"!==this.root.style.display&&!this.map.dragging){var n=e.xy,r=0|n.x,s=0|n.y,a=this.hitContext.getImageData(r,s,1,1).data;if(255===a[3]){var o=a[2]+256*(a[1]+256*a[0]);if(o){t="OpenLayers_Feature_Vector_"+(o-1+this.hitOverflow);try{i=this.features[t][0]}catch(e){}}}}return i},eraseFeatures:function(e){OpenLayers.Util.isArray(e)||(e=[e]);for(var t=0;t<e.length;++t)delete this.features[e[t].id];this.redraw()},redraw:function(){if(!this.locked){var e=this.root.height,t=this.root.width;this.canvas.clearRect(0,0,t,e);this.hitDetection&&this.hitContext.clearRect(0,0,t,e);var i,n,r,s,a=[],o=this.map.baseLayer&&this.map.baseLayer.wrapDateLine&&this.map.getMaxExtent();for(var l in this.features)if(this.features.hasOwnProperty(l)){n=(i=this.features[l][0]).geometry;this.calculateFeatureDx(n.getBounds(),o);r=this.features[l][1];this.drawGeometry(n,r,i.id);r.label&&a.push([i,r])}for(var c=0,u=a.length;c<u;++c){s=a[c];this.drawText(s[0].geometry.getCentroid(),s[1])}}},CLASS_NAME:"OpenLayers.Renderer.Canvas"});OpenLayers.Renderer.Canvas.LABEL_ALIGN={l:"left",r:"right",t:"top",b:"bottom"};OpenLayers.Renderer.Canvas.LABEL_FACTOR={l:0,r:-1,t:0,b:-1};OpenLayers.Renderer.Canvas.drawImageScaleFactor=null;OpenLayers.Handler.MouseWheel=OpenLayers.Class(OpenLayers.Handler,{wheelListener:null,interval:0,maxDelta:Number.POSITIVE_INFINITY,delta:0,cumulative:!0,initialize:function(e,t,i){OpenLayers.Handler.prototype.initialize.apply(this,arguments);this.wheelListener=OpenLayers.Function.bindAsEventListener(this.onWheelEvent,this)},destroy:function(){OpenLayers.Handler.prototype.destroy.apply(this,arguments);this.wheelListener=null},onWheelEvent:function(e){if(this.map&&this.checkModifiers(e)){for(var t=!1,i=!1,n=!1,r=OpenLayers.Event.element(e);null!=r&&!n&&!t;){if(!t)try{var s;if(r.currentStyle)s=r.currentStyle.overflow;else{s=document.defaultView.getComputedStyle(r,null).getPropertyValue("overflow")}t=s&&"auto"==s||"scroll"==s}catch(e){}if(!i&&!(i=OpenLayers.Element.hasClass(r,"olScrollable")))for(var a=0,o=this.map.layers.length;a<o;a++){var l=this.map.layers[a];if(r==l.div||r==l.pane){i=!0;break}}n=r==this.map.div;r=r.parentNode}if(!t&&n){if(i){var c=0;if(e.wheelDelta){(c=e.wheelDelta)%160==0&&(c*=.75);c/=120}else e.detail&&(c=-e.detail/Math.abs(e.detail));this.delta+=c;window.clearTimeout(this._timeoutId);if(this.interval&&Math.abs(this.delta)<this.maxDelta){var u=OpenLayers.Util.extend({},e);this._timeoutId=window.setTimeout(OpenLayers.Function.bind(function(){this.wheelZoom(u)},this),this.interval)}else this.wheelZoom(e)}OpenLayers.Event.stop(e)}}},wheelZoom:function(e){var t=this.delta;this.delta=0;if(t){e.xy=this.map.events.getMousePosition(e);t<0?this.callback("down",[e,this.cumulative?Math.max(-this.maxDelta,t):-1]):this.callback("up",[e,this.cumulative?Math.min(this.maxDelta,t):1])}},activate:function(e){if(OpenLayers.Handler.prototype.activate.apply(this,arguments)){var t=this.wheelListener;OpenLayers.Event.observe(window,"DOMMouseScroll",t);OpenLayers.Event.observe(window,"mousewheel",t);OpenLayers.Event.observe(document,"mousewheel",t);return!0}return!1},deactivate:function(e){if(OpenLayers.Handler.prototype.deactivate.apply(this,arguments)){var t=this.wheelListener;OpenLayers.Event.stopObserving(window,"DOMMouseScroll",t);OpenLayers.Event.stopObserving(window,"mousewheel",t);OpenLayers.Event.stopObserving(document,"mousewheel",t);return!0}return!1},CLASS_NAME:"OpenLayers.Handler.MouseWheel"});OpenLayers.Format.WMSCapabilities=OpenLayers.Class(OpenLayers.Format.XML.VersionedOGC,{defaultVersion:"1.1.1",profile:null,CLASS_NAME:"OpenLayers.Format.WMSCapabilities"});OpenLayers.Format.WMSCapabilities.v1=OpenLayers.Class(OpenLayers.Format.XML,{namespaces:{wms:"http://www.opengis.net/wms",xlink:"http://www.w3.org/1999/xlink",xsi:"http://www.w3.org/2001/XMLSchema-instance"},defaultPrefix:"wms",read:function(e){"string"==typeof e&&(e=OpenLayers.Format.XML.prototype.read.apply(this,[e]));var t=e;e&&9==e.nodeType&&(e=e.documentElement);var i={};this.readNode(e,i);if(void 0===i.service){var n=new OpenLayers.Format.OGCExceptionReport;i.error=n.read(t)}return i},readers:{wms:{Service:function(e,t){t.service={};this.readChildNodes(e,t.service)},Name:function(e,t){t.name=this.getChildValue(e)},Title:function(e,t){t.title=this.getChildValue(e)},Abstract:function(e,t){t.abstract=this.getChildValue(e)},BoundingBox:function(e,t){var i={};i.bbox=[parseFloat(e.getAttribute("minx")),parseFloat(e.getAttribute("miny")),parseFloat(e.getAttribute("maxx")),parseFloat(e.getAttribute("maxy"))];var n={x:parseFloat(e.getAttribute("resx")),y:parseFloat(e.getAttribute("resy"))};isNaN(n.x)&&isNaN(n.y)||(i.res=n);return i},OnlineResource:function(e,t){t.href=this.getAttributeNS(e,this.namespaces.xlink,"href")},ContactInformation:function(e,t){t.contactInformation={};this.readChildNodes(e,t.contactInformation)},ContactPersonPrimary:function(e,t){t.personPrimary={};this.readChildNodes(e,t.personPrimary)},ContactPerson:function(e,t){t.person=this.getChildValue(e)},ContactOrganization:function(e,t){t.organization=this.getChildValue(e)},ContactPosition:function(e,t){t.position=this.getChildValue(e)},ContactAddress:function(e,t){t.contactAddress={};this.readChildNodes(e,t.contactAddress)},AddressType:function(e,t){t.type=this.getChildValue(e)},Address:function(e,t){t.address=this.getChildValue(e)},City:function(e,t){t.city=this.getChildValue(e)},StateOrProvince:function(e,t){t.stateOrProvince=this.getChildValue(e)},PostCode:function(e,t){t.postcode=this.getChildValue(e)},Country:function(e,t){t.country=this.getChildValue(e)},ContactVoiceTelephone:function(e,t){t.phone=this.getChildValue(e)},ContactFacsimileTelephone:function(e,t){t.fax=this.getChildValue(e)},ContactElectronicMailAddress:function(e,t){t.email=this.getChildValue(e)},Fees:function(e,t){var i=this.getChildValue(e);i&&"none"!=i.toLowerCase()&&(t.fees=i)},AccessConstraints:function(e,t){var i=this.getChildValue(e);i&&"none"!=i.toLowerCase()&&(t.accessConstraints=i)},Capability:function(e,t){t.capability={nestedLayers:[],layers:[]};this.readChildNodes(e,t.capability)},Request:function(e,t){t.request={};this.readChildNodes(e,t.request)},GetCapabilities:function(e,t){t.getcapabilities={formats:[]};this.readChildNodes(e,t.getcapabilities)},Format:function(e,t){OpenLayers.Util.isArray(t.formats)?t.formats.push(this.getChildValue(e)):t.format=this.getChildValue(e)},DCPType:function(e,t){this.readChildNodes(e,t)},HTTP:function(e,t){this.readChildNodes(e,t)},Get:function(e,t){t.get={};this.readChildNodes(e,t.get);t.href||(t.href=t.get.href)},Post:function(e,t){t.post={};this.readChildNodes(e,t.post);t.href||(t.href=t.get.href)},GetMap:function(e,t){t.getmap={formats:[]};this.readChildNodes(e,t.getmap)},GetFeatureInfo:function(e,t){t.getfeatureinfo={formats:[]};this.readChildNodes(e,t.getfeatureinfo)},Exception:function(e,t){t.exception={formats:[]};this.readChildNodes(e,t.exception)},Layer:function(e,t){var i,n;if(t.capability){n=t.capability;i=t}else n=t;var r=e.getAttributeNode("queryable"),s=r&&r.specified?e.getAttribute("queryable"):null,a=(r=e.getAttributeNode("cascaded"))&&r.specified?e.getAttribute("cascaded"):null,o=(r=e.getAttributeNode("opaque"))&&r.specified?e.getAttribute("opaque"):null,l=e.getAttribute("noSubsets"),c=e.getAttribute("fixedWidth"),u=e.getAttribute("fixedHeight"),h=i||{},p=OpenLayers.Util.extend,d={nestedLayers:[],styles:i?[].concat(i.styles):[],srs:i?p({},h.srs):{},metadataURLs:[],bbox:i?p({},h.bbox):{},llbbox:h.llbbox,dimensions:i?p({},h.dimensions):{},authorityURLs:i?p({},h.authorityURLs):{},identifiers:{},keywords:[],queryable:s&&""!==s?"1"===s||"true"===s:h.queryable||!1,cascaded:null!==a?parseInt(a):h.cascaded||0,opaque:o?"1"===o||"true"===o:h.opaque||!1,noSubsets:null!==l?"1"===l||"true"===l:h.noSubsets||!1,fixedWidth:null!=c?parseInt(c):h.fixedWidth||0,fixedHeight:null!=u?parseInt(u):h.fixedHeight||0,minScale:h.minScale,maxScale:h.maxScale,attribution:h.attribution};t.nestedLayers.push(d);d.capability=n;this.readChildNodes(e,d);delete d.capability;if(d.name){var f=d.name.split(":"),m=n.request,y=m.getfeatureinfo;f.length>0&&(d.prefix=f[0]);n.layers.push(d);void 0===d.formats&&(d.formats=m.getmap.formats);void 0===d.infoFormats&&y&&(d.infoFormats=y.formats)}},Attribution:function(e,t){t.attribution={};this.readChildNodes(e,t.attribution)},LogoURL:function(e,t){t.logo={width:e.getAttribute("width"),height:e.getAttribute("height")};this.readChildNodes(e,t.logo)},Style:function(e,t){var i={};t.styles.push(i);this.readChildNodes(e,i)},LegendURL:function(e,t){var i={width:e.getAttribute("width"),height:e.getAttribute("height")};t.legend=i;this.readChildNodes(e,i)},MetadataURL:function(e,t){var i={type:e.getAttribute("type")};t.metadataURLs.push(i);this.readChildNodes(e,i)},DataURL:function(e,t){t.dataURL={};this.readChildNodes(e,t.dataURL)},FeatureListURL:function(e,t){t.featureListURL={};this.readChildNodes(e,t.featureListURL)},AuthorityURL:function(e,t){var i=e.getAttribute("name"),n={};this.readChildNodes(e,n);t.authorityURLs[i]=n.href},Identifier:function(e,t){var i=e.getAttribute("authority");t.identifiers[i]=this.getChildValue(e)},KeywordList:function(e,t){this.readChildNodes(e,t)},SRS:function(e,t){t.srs[this.getChildValue(e)]=!0}}},CLASS_NAME:"OpenLayers.Format.WMSCapabilities.v1"});OpenLayers.Format.WMSCapabilities.v1_3=OpenLayers.Class(OpenLayers.Format.WMSCapabilities.v1,{readers:{wms:OpenLayers.Util.applyDefaults({WMS_Capabilities:function(e,t){this.readChildNodes(e,t)},LayerLimit:function(e,t){t.layerLimit=parseInt(this.getChildValue(e))},MaxWidth:function(e,t){t.maxWidth=parseInt(this.getChildValue(e))},MaxHeight:function(e,t){t.maxHeight=parseInt(this.getChildValue(e))},BoundingBox:function(e,t){var i=OpenLayers.Format.WMSCapabilities.v1.prototype.readers.wms.BoundingBox.apply(this,[e,t]);i.srs=e.getAttribute("CRS");t.bbox[i.srs]=i},CRS:function(e,t){this.readers.wms.SRS.apply(this,[e,t])},EX_GeographicBoundingBox:function(e,t){t.llbbox=[];this.readChildNodes(e,t.llbbox)},westBoundLongitude:function(e,t){t[0]=this.getChildValue(e)},eastBoundLongitude:function(e,t){t[2]=this.getChildValue(e)},southBoundLatitude:function(e,t){t[1]=this.getChildValue(e)},northBoundLatitude:function(e,t){t[3]=this.getChildValue(e)},MinScaleDenominator:function(e,t){t.maxScale=parseFloat(this.getChildValue(e)).toPrecision(16)},MaxScaleDenominator:function(e,t){t.minScale=parseFloat(this.getChildValue(e)).toPrecision(16)},Dimension:function(e,t){var i={name:e.getAttribute("name").toLowerCase(),units:e.getAttribute("units"),unitsymbol:e.getAttribute("unitSymbol"),nearestVal:"1"===e.getAttribute("nearestValue"),multipleVal:"1"===e.getAttribute("multipleValues"),default:e.getAttribute("default")||"",current:"1"===e.getAttribute("current"),values:this.getChildValue(e).split(",")};t.dimensions[i.name]=i},Keyword:function(e,t){var i={value:this.getChildValue(e),vocabulary:e.getAttribute("vocabulary")};t.keywords&&t.keywords.push(i)}},OpenLayers.Format.WMSCapabilities.v1.prototype.readers.wms),sld:{UserDefinedSymbolization:function(e,t){this.readers.wms.UserDefinedSymbolization.apply(this,[e,t]);t.userSymbols.inlineFeature=1==parseInt(e.getAttribute("InlineFeature"));t.userSymbols.remoteWCS=1==parseInt(e.getAttribute("RemoteWCS"))},DescribeLayer:function(e,t){this.readers.wms.DescribeLayer.apply(this,[e,t])},GetLegendGraphic:function(e,t){this.readers.wms.GetLegendGraphic.apply(this,[e,t])}}},CLASS_NAME:"OpenLayers.Format.WMSCapabilities.v1_3"});OpenLayers.Format.WMSCapabilities.v1_3_0=OpenLayers.Class(OpenLayers.Format.WMSCapabilities.v1_3,{version:"1.3.0",CLASS_NAME:"OpenLayers.Format.WMSCapabilities.v1_3_0"});OpenLayers.Format.GML.v2=OpenLayers.Class(OpenLayers.Format.GML.Base,{schemaLocation:"http://www.opengis.net/gml http://schemas.opengis.net/gml/2.1.2/feature.xsd",initialize:function(e){OpenLayers.Format.GML.Base.prototype.initialize.apply(this,[e])},readers:{gml:OpenLayers.Util.applyDefaults({outerBoundaryIs:function(e,t){var i={};this.readChildNodes(e,i);t.outer=i.components[0]},innerBoundaryIs:function(e,t){var i={};this.readChildNodes(e,i);t.inner.push(i.components[0])},Box:function(e,t){var i={};this.readChildNodes(e,i);t.components||(t.components=[]);var n=i.points[0],r=i.points[1];t.components.push(new OpenLayers.Bounds(n.x,n.y,r.x,r.y))}},OpenLayers.Format.GML.Base.prototype.readers.gml),feature:OpenLayers.Format.GML.Base.prototype.readers.feature,wfs:OpenLayers.Format.GML.Base.prototype.readers.wfs},write:function(e){var t;t=OpenLayers.Util.isArray(e)?"wfs:FeatureCollection":"gml:featureMember";var i=this.writeNode(t,e);this.setAttributeNS(i,this.namespaces.xsi,"xsi:schemaLocation",this.schemaLocation);return OpenLayers.Format.XML.prototype.write.apply(this,[i])},writers:{gml:OpenLayers.Util.applyDefaults({Point:function(e){var t=this.createElementNSPlus("gml:Point");this.writeNode("coordinates",[e],t);return t},coordinates:function(e){for(var t,i=e.length,n=new Array(i),r=0;r<i;++r){t=e[r];this.xy?n[r]=t.x+","+t.y:n[r]=t.y+","+t.x;void 0!=t.z&&(n[r]+=","+t.z)}return this.createElementNSPlus("gml:coordinates",{attributes:{decimal:".",cs:",",ts:" "},value:1==i?n[0]:n.join(" ")})},LineString:function(e){var t=this.createElementNSPlus("gml:LineString");this.writeNode("coordinates",e.components,t);return t},Polygon:function(e){var t=this.createElementNSPlus("gml:Polygon");this.writeNode("outerBoundaryIs",e.components[0],t);for(var i=1;i<e.components.length;++i)this.writeNode("innerBoundaryIs",e.components[i],t);return t},outerBoundaryIs:function(e){var t=this.createElementNSPlus("gml:outerBoundaryIs");this.writeNode("LinearRing",e,t);return t},innerBoundaryIs:function(e){var t=this.createElementNSPlus("gml:innerBoundaryIs");this.writeNode("LinearRing",e,t);return t},LinearRing:function(e){var t=this.createElementNSPlus("gml:LinearRing");this.writeNode("coordinates",e.components,t);return t},Box:function(e){var t=this.createElementNSPlus("gml:Box");this.writeNode("coordinates",[{x:e.left,y:e.bottom},{x:e.right,y:e.top}],t);this.srsName&&t.setAttribute("srsName",this.srsName);return t}},OpenLayers.Format.GML.Base.prototype.writers.gml),feature:OpenLayers.Format.GML.Base.prototype.writers.feature,wfs:OpenLayers.Format.GML.Base.prototype.writers.wfs},CLASS_NAME:"OpenLayers.Format.GML.v2"});OpenLayers.Format.Filter.v1_0_0=OpenLayers.Class(OpenLayers.Format.GML.v2,OpenLayers.Format.Filter.v1,{VERSION:"1.0.0",schemaLocation:"http://www.opengis.net/ogc/filter/1.0.0/filter.xsd",initialize:function(e){OpenLayers.Format.GML.v2.prototype.initialize.apply(this,[e])},readers:{ogc:OpenLayers.Util.applyDefaults({PropertyIsEqualTo:function(e,t){var i=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.EQUAL_TO});this.readChildNodes(e,i);t.filters.push(i)},PropertyIsNotEqualTo:function(e,t){var i=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.NOT_EQUAL_TO});this.readChildNodes(e,i);t.filters.push(i)},PropertyIsLike:function(e,t){var i=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.LIKE});this.readChildNodes(e,i);var n=e.getAttribute("wildCard"),r=e.getAttribute("singleChar"),s=e.getAttribute("escape");i.value2regex(n,r,s);t.filters.push(i)}},OpenLayers.Format.Filter.v1.prototype.readers.ogc),gml:OpenLayers.Format.GML.v2.prototype.readers.gml,feature:OpenLayers.Format.GML.v2.prototype.readers.feature},writers:{ogc:OpenLayers.Util.applyDefaults({PropertyIsEqualTo:function(e){var t=this.createElementNSPlus("ogc:PropertyIsEqualTo");this.writeNode("PropertyName",e,t);this.writeOgcExpression(e.value,t);return t},PropertyIsNotEqualTo:function(e){var t=this.createElementNSPlus("ogc:PropertyIsNotEqualTo");this.writeNode("PropertyName",e,t);this.writeOgcExpression(e.value,t);return t},PropertyIsLike:function(e){var t=this.createElementNSPlus("ogc:PropertyIsLike",{attributes:{wildCard:"*",singleChar:".",escape:"!"}});this.writeNode("PropertyName",e,t);this.writeNode("Literal",e.regex2value(),t);return t},BBOX:function(e){var t=this.createElementNSPlus("ogc:BBOX");e.property&&this.writeNode("PropertyName",e,t);var i=this.writeNode("gml:Box",e.value,t);e.projection&&i.setAttribute("srsName",e.projection);return t}},OpenLayers.Format.Filter.v1.prototype.writers.ogc),gml:OpenLayers.Format.GML.v2.prototype.writers.gml,feature:OpenLayers.Format.GML.v2.prototype.writers.feature},writeSpatial:function(e,t){var i=this.createElementNSPlus("ogc:"+t);this.writeNode("PropertyName",e,i);if(e.value instanceof OpenLayers.Filter.Function)this.writeNode("Function",e.value,i);else{var n;n=e.value instanceof OpenLayers.Geometry?this.writeNode("feature:_geometry",e.value).firstChild:this.writeNode("gml:Box",e.value);e.projection&&n.setAttribute("srsName",e.projection);i.appendChild(n)}return i},CLASS_NAME:"OpenLayers.Format.Filter.v1_0_0"});OpenLayers.Format.WFST.v1_0_0=OpenLayers.Class(OpenLayers.Format.Filter.v1_0_0,OpenLayers.Format.WFST.v1,{version:"1.0.0",srsNameInQuery:!1,schemaLocations:{wfs:"http://schemas.opengis.net/wfs/1.0.0/WFS-transaction.xsd"},initialize:function(e){OpenLayers.Format.Filter.v1_0_0.prototype.initialize.apply(this,[e]);OpenLayers.Format.WFST.v1.prototype.initialize.apply(this,[e])},readNode:function(e,t,i){return OpenLayers.Format.GML.v2.prototype.readNode.apply(this,arguments)},readers:{wfs:OpenLayers.Util.applyDefaults({WFS_TransactionResponse:function(e,t){t.insertIds=[];t.success=!1;this.readChildNodes(e,t)},InsertResult:function(e,t){var i={fids:[]};this.readChildNodes(e,i);t.insertIds=t.insertIds.concat(i.fids)},TransactionResult:function(e,t){this.readChildNodes(e,t)},Status:function(e,t){this.readChildNodes(e,t)},SUCCESS:function(e,t){t.success=!0}},OpenLayers.Format.WFST.v1.prototype.readers.wfs),gml:OpenLayers.Format.GML.v2.prototype.readers.gml,feature:OpenLayers.Format.GML.v2.prototype.readers.feature,ogc:OpenLayers.Format.Filter.v1_0_0.prototype.readers.ogc},writers:{wfs:OpenLayers.Util.applyDefaults({Query:function(e){var t=(e=OpenLayers.Util.extend({featureNS:this.featureNS,featurePrefix:this.featurePrefix,featureType:this.featureType,srsName:this.srsName,srsNameInQuery:this.srsNameInQuery},e)).featurePrefix,i=this.createElementNSPlus("wfs:Query",{attributes:{typeName:(t?t+":":"")+e.featureType}});e.srsNameInQuery&&e.srsName&&i.setAttribute("srsName",e.srsName);e.featureNS&&i.setAttribute("xmlns:"+t,e.featureNS);if(e.propertyNames)for(var n=0,r=e.propertyNames.length;n<r;n++)this.writeNode("ogc:PropertyName",{property:e.propertyNames[n]},i);if(e.filter){this.setFilterProperty(e.filter);this.writeNode("ogc:Filter",e.filter,i)}return i}},OpenLayers.Format.WFST.v1.prototype.writers.wfs),gml:OpenLayers.Format.GML.v2.prototype.writers.gml,feature:OpenLayers.Format.GML.v2.prototype.writers.feature,ogc:OpenLayers.Format.Filter.v1_0_0.prototype.writers.ogc},CLASS_NAME:"OpenLayers.Format.WFST.v1_0_0"});OpenLayers.ElementsIndexer=OpenLayers.Class({maxZIndex:null,order:null,indices:null,compare:null,initialize:function(e){this.compare=e?OpenLayers.ElementsIndexer.IndexingMethods.Z_ORDER_Y_ORDER:OpenLayers.ElementsIndexer.IndexingMethods.Z_ORDER_DRAWING_ORDER;this.clear()},insert:function(e){this.exists(e)&&this.remove(e);var t=e.id;this.determineZIndex(e);for(var i,n=-1,r=this.order.length;r-n>1;){i=parseInt((n+r)/2);this.compare(this,e,OpenLayers.Util.getElement(this.order[i]))>0?n=i:r=i}this.order.splice(r,0,t);this.indices[t]=this.getZIndex(e);return this.getNextElement(r)},remove:function(e){var t=e.id,i=OpenLayers.Util.indexOf(this.order,t);if(i>=0){this.order.splice(i,1);delete this.indices[t];if(this.order.length>0){var n=this.order[this.order.length-1];this.maxZIndex=this.indices[n]}else this.maxZIndex=0}},clear:function(){this.order=[];this.indices={};this.maxZIndex=0},exists:function(e){return null!=this.indices[e.id]},getZIndex:function(e){return e._style.graphicZIndex},determineZIndex:function(e){var t=e._style.graphicZIndex;if(null==t){t=this.maxZIndex;e._style.graphicZIndex=t}else t>this.maxZIndex&&(this.maxZIndex=t)},getNextElement:function(e){var t=e+1;if(t<this.order.length){var i=OpenLayers.Util.getElement(this.order[t]);void 0==i&&(i=this.getNextElement(t));return i}return null},CLASS_NAME:"OpenLayers.ElementsIndexer"});OpenLayers.ElementsIndexer.IndexingMethods={Z_ORDER:function(e,t,i){var n=e.getZIndex(t),r=0;if(i){r=n-e.getZIndex(i)}return r},Z_ORDER_DRAWING_ORDER:function(e,t,i){var n=OpenLayers.ElementsIndexer.IndexingMethods.Z_ORDER(e,t,i);i&&0==n&&(n=1);return n},Z_ORDER_Y_ORDER:function(e,t,i){var n=OpenLayers.ElementsIndexer.IndexingMethods.Z_ORDER(e,t,i);if(i&&0===n){var r=i._boundsBottom-t._boundsBottom;n=0===r?1:r}return n}};OpenLayers.Renderer.Elements=OpenLayers.Class(OpenLayers.Renderer,{rendererRoot:null,root:null,vectorRoot:null,textRoot:null,xmlns:null,xOffset:0,indexer:null,BACKGROUND_ID_SUFFIX:"_background",LABEL_ID_SUFFIX:"_label",LABEL_OUTLINE_SUFFIX:"_outline",initialize:function(e,t){OpenLayers.Renderer.prototype.initialize.apply(this,arguments);this.rendererRoot=this.createRenderRoot();this.root=this.createRoot("_root");this.vectorRoot=this.createRoot("_vroot");this.textRoot=this.createRoot("_troot");this.root.appendChild(this.vectorRoot);this.root.appendChild(this.textRoot);this.rendererRoot.appendChild(this.root);this.container.appendChild(this.rendererRoot);t&&(t.zIndexing||t.yOrdering)&&(this.indexer=new OpenLayers.ElementsIndexer(t.yOrdering))},destroy:function(){this.clear();this.rendererRoot=null;this.root=null;this.xmlns=null;OpenLayers.Renderer.prototype.destroy.apply(this,arguments)},clear:function(){var e,t=this.vectorRoot;if(t)for(;e=t.firstChild;)t.removeChild(e);if(t=this.textRoot)for(;e=t.firstChild;)t.removeChild(e);this.indexer&&this.indexer.clear()},setExtent:function(e,t){var i=OpenLayers.Renderer.prototype.setExtent.apply(this,arguments),n=this.getResolution();if(this.map.baseLayer&&this.map.baseLayer.wrapDateLine){var r,s=e.getWidth()/this.map.getExtent().getWidth(),a=(e=e.scale(1/s),this.map.getMaxExtent());a.right>e.left&&a.right<e.right?r=!0:a.left>e.left&&a.left<e.right&&(r=!1);if(r!==this.rightOfDateLine||t){i=!1;this.xOffset=!0===r?a.getWidth()/n:0}this.rightOfDateLine=r}return i},getNodeType:function(e,t){},drawGeometry:function(e,t,i){var n=e.CLASS_NAME,r=!0;if("OpenLayers.Geometry.Collection"==n||"OpenLayers.Geometry.MultiPoint"==n||"OpenLayers.Geometry.MultiLineString"==n||"OpenLayers.Geometry.MultiPolygon"==n){for(var s=0,a=e.components.length;s<a;s++)r=this.drawGeometry(e.components[s],t,i)&&r;return r}r=!1;var o=!1;if("none"!=t.display){t.backgroundGraphic?this.redrawBackgroundNode(e.id,e,t,i):o=!0;r=this.redrawNode(e.id,e,t,i)}if(0==r){if(l=document.getElementById(e.id)){l._style.backgroundGraphic&&(o=!0);l.parentNode.removeChild(l)}}if(o){var l;(l=document.getElementById(e.id+this.BACKGROUND_ID_SUFFIX))&&l.parentNode.removeChild(l)}return r},redrawNode:function(e,t,i,n){i=this.applyDefaultSymbolizer(i);var r=this.nodeFactory(e,this.getNodeType(t,i));r._featureId=n;r._boundsBottom=t.getBounds().bottom;r._geometryClass=t.CLASS_NAME;r._style=i;var s=this.drawGeometryNode(r,t,i);if(!1===s)return!1;r=s.node;if(this.indexer){var a=this.indexer.insert(r);a?this.vectorRoot.insertBefore(r,a):this.vectorRoot.appendChild(r)}else r.parentNode!==this.vectorRoot&&this.vectorRoot.appendChild(r);this.postDraw(r);return s.complete},redrawBackgroundNode:function(e,t,i,n){var r=OpenLayers.Util.extend({},i);r.externalGraphic=r.backgroundGraphic;r.graphicXOffset=r.backgroundXOffset;r.graphicYOffset=r.backgroundYOffset;r.graphicZIndex=r.backgroundGraphicZIndex;r.graphicWidth=r.backgroundWidth||r.graphicWidth;r.graphicHeight=r.backgroundHeight||r.graphicHeight;r.backgroundGraphic=null;r.backgroundXOffset=null;r.backgroundYOffset=null;r.backgroundGraphicZIndex=null;return this.redrawNode(e+this.BACKGROUND_ID_SUFFIX,t,r,null)},drawGeometryNode:function(e,t,i){var n,r={isFilled:void 0===(i=i||e._style).fill||i.fill,isStroked:void 0===i.stroke?!!i.strokeWidth:i.stroke};switch(t.CLASS_NAME){case"OpenLayers.Geometry.Point":if(!1===i.graphic){r.isFilled=!1;r.isStroked=!1}n=this.drawPoint(e,t);break;case"OpenLayers.Geometry.LineString":r.isFilled=!1;n=this.drawLineString(e,t);break;case"OpenLayers.Geometry.LinearRing":n=this.drawLinearRing(e,t);break;case"OpenLayers.Geometry.Polygon":n=this.drawPolygon(e,t);break;case"OpenLayers.Geometry.Rectangle":n=this.drawRectangle(e,t)}e._options=r;return 0!=n&&{node:this.setStyle(e,i,r,t),complete:n}},postDraw:function(e){},drawPoint:function(e,t){},drawLineString:function(e,t){},drawLinearRing:function(e,t){},drawPolygon:function(e,t){},drawRectangle:function(e,t){},drawCircle:function(e,t){},removeText:function(e){var t=document.getElementById(e+this.LABEL_ID_SUFFIX);t&&this.textRoot.removeChild(t);var i=document.getElementById(e+this.LABEL_OUTLINE_SUFFIX);i&&this.textRoot.removeChild(i)},getFeatureIdFromEvent:function(e){var t=e.target,i=t&&t.correspondingUseElement;return(i||(t||e.srcElement))._featureId},eraseGeometry:function(e,t){if("OpenLayers.Geometry.MultiPoint"==e.CLASS_NAME||"OpenLayers.Geometry.MultiLineString"==e.CLASS_NAME||"OpenLayers.Geometry.MultiPolygon"==e.CLASS_NAME||"OpenLayers.Geometry.Collection"==e.CLASS_NAME)for(var i=0,n=e.components.length;i<n;i++)this.eraseGeometry(e.components[i],t);else{var r=OpenLayers.Util.getElement(e.id);if(r&&r.parentNode){if(r.geometry){r.geometry.destroy();r.geometry=null}r.parentNode.removeChild(r);this.indexer&&this.indexer.remove(r);if(r._style.backgroundGraphic){var s=e.id+this.BACKGROUND_ID_SUFFIX,a=OpenLayers.Util.getElement(s);a&&a.parentNode&&a.parentNode.removeChild(a)}}}},nodeFactory:function(e,t){var i=OpenLayers.Util.getElement(e);if(i){if(!this.nodeTypeCompare(i,t)){i.parentNode.removeChild(i);i=this.nodeFactory(e,t)}}else i=this.createNode(t,e);return i},nodeTypeCompare:function(e,t){},createNode:function(e,t){},moveRoot:function(e){var t=this.root;e.root.parentNode==this.rendererRoot&&(t=e.root);t.parentNode.removeChild(t);e.rendererRoot.appendChild(t)},getRenderLayerId:function(){return this.root.parentNode.parentNode.id},isComplexSymbol:function(e){return"circle"!=e&&!!e},CLASS_NAME:"OpenLayers.Renderer.Elements"});OpenLayers.Strategy=OpenLayers.Class({layer:null,options:null,active:null,autoActivate:!0,autoDestroy:!0,initialize:function(e){OpenLayers.Util.extend(this,e);this.options=e;this.active=!1},destroy:function(){this.deactivate();this.layer=null;this.options=null},setLayer:function(e){this.layer=e},activate:function(){if(!this.active){this.active=!0;return!0}return!1},deactivate:function(){if(this.active){this.active=!1;return!0}return!1},CLASS_NAME:"OpenLayers.Strategy"});OpenLayers.Strategy.Fixed=OpenLayers.Class(OpenLayers.Strategy,{preload:!1,activate:function(){var e=OpenLayers.Strategy.prototype.activate.apply(this,arguments);if(e){this.layer.events.on({refresh:this.load,scope:this});1==this.layer.visibility||this.preload?this.load():this.layer.events.on({visibilitychanged:this.load,scope:this})}return e},deactivate:function(){var e=OpenLayers.Strategy.prototype.deactivate.call(this);e&&this.layer.events.un({refresh:this.load,visibilitychanged:this.load,scope:this});return e},load:function(e){var t=this.layer;t.events.triggerEvent("loadstart",{filter:t.filter});t.protocol.read(OpenLayers.Util.applyDefaults({callback:this.merge,filter:t.filter,scope:this},e));t.events.un({visibilitychanged:this.load,scope:this})},merge:function(e){var t=this.layer;t.destroyFeatures();var i=e.features;if(i&&i.length>0){var n=t.projection,r=t.map.getProjectionObject();if(!r.equals(n))for(var s,a=0,o=i.length;a<o;++a)(s=i[a].geometry)&&s.transform(n,r);t.addFeatures(i)}t.events.triggerEvent("loadend",{response:e})},CLASS_NAME:"OpenLayers.Strategy.Fixed"});OpenLayers.Protocol=OpenLayers.Class({format:null,options:null,autoDestroy:!0,defaultFilter:null,initialize:function(e){e=e||{};OpenLayers.Util.extend(this,e);this.options=e},mergeWithDefaultFilter:function(e){return e&&this.defaultFilter?new OpenLayers.Filter.Logical({type:OpenLayers.Filter.Logical.AND,filters:[this.defaultFilter,e]}):e||this.defaultFilter||void 0},destroy:function(){this.options=null;this.format=null},read:function(e){(e=e||{}).filter=this.mergeWithDefaultFilter(e.filter)},create:function(){},update:function(){},delete:function(){},commit:function(){},abort:function(e){},createCallback:function(e,t,i){return OpenLayers.Function.bind(function(){e.apply(this,[t,i])},this)},CLASS_NAME:"OpenLayers.Protocol"});OpenLayers.Protocol.Response=OpenLayers.Class({code:null,requestType:null,last:!0,features:null,data:null,reqFeatures:null,priv:null,error:null,initialize:function(e){OpenLayers.Util.extend(this,e)},success:function(){return this.code>0},CLASS_NAME:"OpenLayers.Protocol.Response"});OpenLayers.Protocol.Response.SUCCESS=1;OpenLayers.Protocol.Response.FAILURE=0;OpenLayers.Protocol.WFS=function(e){e=OpenLayers.Util.applyDefaults(e,OpenLayers.Protocol.WFS.DEFAULTS);var t=OpenLayers.Protocol.WFS["v"+e.version.replace(/\./g,"_")];if(!t)throw"Unsupported WFS version: "+e.version;return new t(e)};OpenLayers.Protocol.WFS.fromWMSLayer=function(e,t){var i,n,r=e.params.LAYERS,s=(OpenLayers.Util.isArray(r)?r[0]:r).split(":");s.length>1&&(n=s[0]);i=s.pop();var a={url:e.url,featureType:i,featurePrefix:n,srsName:e.projection&&e.projection.getCode()||e.map&&e.map.getProjectionObject().getCode(),version:"1.1.0"};return new OpenLayers.Protocol.WFS(OpenLayers.Util.applyDefaults(t,a))};OpenLayers.Protocol.WFS.DEFAULTS={version:"1.0.0"};OpenLayers.Layer.Markers=OpenLayers.Class(OpenLayers.Layer,{isBaseLayer:!1,markers:null,drawn:!1,initialize:function(e,t){OpenLayers.Layer.prototype.initialize.apply(this,arguments);this.markers=[]},destroy:function(){this.clearMarkers();this.markers=null;OpenLayers.Layer.prototype.destroy.apply(this,arguments)},setOpacity:function(e){if(e!=this.opacity){this.opacity=e;for(var t=0,i=this.markers.length;t<i;t++)this.markers[t].setOpacity(this.opacity)}},moveTo:function(e,t,i){OpenLayers.Layer.prototype.moveTo.apply(this,arguments);if(t||!this.drawn){for(var n=0,r=this.markers.length;n<r;n++)this.drawMarker(this.markers[n]);this.drawn=!0}},addMarker:function(e){this.markers.push(e);this.opacity<1&&e.setOpacity(this.opacity);if(this.map&&this.map.getExtent()){e.map=this.map;this.drawMarker(e)}},removeMarker:function(e){if(this.markers&&this.markers.length){OpenLayers.Util.removeItem(this.markers,e);e.erase()}},clearMarkers:function(){if(null!=this.markers)for(;this.markers.length>0;)this.removeMarker(this.markers[0])},drawMarker:function(e){var t=this.map.getLayerPxFromLonLat(e.lonlat);if(null==t)e.display(!1);else if(e.isDrawn())e.icon&&e.icon.moveTo(t);else{var i=e.draw(t);this.div.appendChild(i)}},getDataExtent:function(){var e=null;if(this.markers&&this.markers.length>0){e=new OpenLayers.Bounds;for(var t=0,i=this.markers.length;t<i;t++){var n=this.markers[t];e.extend(n.lonlat)}}return e},CLASS_NAME:"OpenLayers.Layer.Markers"});OpenLayers.ProxyHost="";OpenLayers.Request||(OpenLayers.Request={});OpenLayers.Util.extend(OpenLayers.Request,{DEFAULT_CONFIG:{method:"GET",url:window.location.href,async:!0,user:void 0,password:void 0,params:null,proxy:OpenLayers.ProxyHost,headers:{},data:null,callback:function(){},success:null,failure:null,scope:null},URL_SPLIT_REGEX:/([^:]*:)\/\/([^:]*:?[^@]*@)?([^:\/\?]*):?([^\/\?]*)/,events:new OpenLayers.Events(this),makeSameOrigin:function(e,t){var i=0!==e.indexOf("http"),n=!i&&e.match(this.URL_SPLIT_REGEX);if(n){var r=window.location;i=n[1]==r.protocol&&n[3]==r.hostname;var s=n[4],a=r.port;(80!=s&&""!=s||"80"!=a&&""!=a)&&(i=i&&s==a)}i||t&&(e="function"==typeof t?t(e):t+encodeURIComponent(e));return e},issue:function(e){var t=OpenLayers.Util.extend(this.DEFAULT_CONFIG,{proxy:OpenLayers.ProxyHost});(e=e||{}).headers=e.headers||{};(e=OpenLayers.Util.applyDefaults(e,t)).headers=OpenLayers.Util.applyDefaults(e.headers,t.headers);var i,n=!1;for(i in e.headers)e.headers.hasOwnProperty(i)&&"x-requested-with"===i.toLowerCase()&&(n=!0);!1===n&&(e.headers["X-Requested-With"]="XMLHttpRequest");var r=new OpenLayers.Request.XMLHttpRequest,s=OpenLayers.Util.urlAppend(e.url,OpenLayers.Util.getParameterString(e.params||{}));s=OpenLayers.Request.makeSameOrigin(s,e.proxy);r.open(e.method,s,e.async,e.user,e.password);for(var a in e.headers)r.setRequestHeader(a,e.headers[a]);var o=this.events,l=this;r.onreadystatechange=function(){if(r.readyState==OpenLayers.Request.XMLHttpRequest.DONE){!1!==o.triggerEvent("complete",{request:r,config:e,requestUrl:s})&&l.runCallbacks({request:r,config:e,requestUrl:s})}};!1===e.async?r.send(e.data):window.setTimeout(function(){0!==r.readyState&&r.send(e.data)},0);return r},runCallbacks:function(e){var t,i,n=e.request,r=e.config,s=r.scope?OpenLayers.Function.bind(r.callback,r.scope):r.callback;r.success&&(t=r.scope?OpenLayers.Function.bind(r.success,r.scope):r.success);r.failure&&(i=r.scope?OpenLayers.Function.bind(r.failure,r.scope):r.failure);"file:"==OpenLayers.Util.createUrlObject(r.url).protocol&&n.responseText&&(n.status=200);s(n);if(!n.status||n.status>=200&&n.status<300){this.events.triggerEvent("success",e);t&&t(n)}if(n.status&&(n.status<200||n.status>=300)){this.events.triggerEvent("failure",e);i&&i(n)}},GET:function(e){e=OpenLayers.Util.extend(e,{method:"GET"});return OpenLayers.Request.issue(e)},POST:function(e){(e=OpenLayers.Util.extend(e,{method:"POST"})).headers=e.headers?e.headers:{};"CONTENT-TYPE"in OpenLayers.Util.upperCaseObject(e.headers)||(e.headers["Content-Type"]="application/xml");return OpenLayers.Request.issue(e)},PUT:function(e){(e=OpenLayers.Util.extend(e,{method:"PUT"})).headers=e.headers?e.headers:{};"CONTENT-TYPE"in OpenLayers.Util.upperCaseObject(e.headers)||(e.headers["Content-Type"]="application/xml");return OpenLayers.Request.issue(e)},DELETE:function(e){e=OpenLayers.Util.extend(e,{method:"DELETE"});return OpenLayers.Request.issue(e)},HEAD:function(e){e=OpenLayers.Util.extend(e,{method:"HEAD"});return OpenLayers.Request.issue(e)},OPTIONS:function(e){e=OpenLayers.Util.extend(e,{method:"OPTIONS"});return OpenLayers.Request.issue(e)}});!function(){var e=window.XMLHttpRequest,t=!!window.controllers,i=window.document.all&&!window.opera,n=i&&window.navigator.userAgent.match(/MSIE 7.0/);function r(){this._object=e&&!n?new e:new window.ActiveXObject("Microsoft.XMLHTTP");this._listeners=[]}function s(){return new r}s.prototype=r.prototype;t&&e.wrapped&&(s.wrapped=e.wrapped);s.UNSENT=0;s.OPENED=1;s.HEADERS_RECEIVED=2;s.LOADING=3;s.DONE=4;s.prototype.readyState=s.UNSENT;s.prototype.responseText="";s.prototype.responseXML=null;s.prototype.status=0;s.prototype.statusText="";s.prototype.priority="NORMAL";s.prototype.onreadystatechange=null;s.onreadystatechange=null;s.onopen=null;s.onsend=null;s.onabort=null;s.prototype.open=function(e,n,r,c,u){delete this._headers;arguments.length<3&&(r=!0);this._async=r;var h,p=this,d=this.readyState;if(i&&r){h=function(){if(d!=s.DONE){l(p);p.abort()}};window.attachEvent("onunload",h)}s.onopen&&s.onopen.apply(this,arguments);arguments.length>4?this._object.open(e,n,r,c,u):arguments.length>3?this._object.open(e,n,r,c):this._object.open(e,n,r);this.readyState=s.OPENED;a(this);this._object.onreadystatechange=function(){if(!t||r){p.readyState=p._object.readyState;o(p);if(p._aborted)p.readyState=s.UNSENT;else{if(p.readyState==s.DONE){delete p._data;l(p);i&&r&&window.detachEvent("onunload",h)}d!=p.readyState&&a(p);d=p.readyState}}}};s.prototype.send=function(e){s.onsend&&s.onsend.apply(this,arguments);arguments.length||(e=null);if(e&&e.nodeType){e=window.XMLSerializer?(new window.XMLSerializer).serializeToString(e):e.xml;this._headers["Content-Type"]||this._object.setRequestHeader("Content-Type","application/xml")}this._data=e;!function(e){e._object.send(e._data);if(t&&!e._async){e.readyState=s.OPENED;o(e);for(;e.readyState<s.DONE;){e.readyState++;a(e);if(e._aborted)return}}}(this)};s.prototype.abort=function(){s.onabort&&s.onabort.apply(this,arguments);this.readyState>s.UNSENT&&(this._aborted=!0);this._object.abort();l(this);this.readyState=s.UNSENT;delete this._data};s.prototype.getAllResponseHeaders=function(){return this._object.getAllResponseHeaders()};s.prototype.getResponseHeader=function(e){return this._object.getResponseHeader(e)};s.prototype.setRequestHeader=function(e,t){this._headers||(this._headers={});this._headers[e]=t;return this._object.setRequestHeader(e,t)};s.prototype.addEventListener=function(e,t,i){for(var n,r=0;n=this._listeners[r];r++)if(n[0]==e&&n[1]==t&&n[2]==i)return;this._listeners.push([e,t,i])};s.prototype.removeEventListener=function(e,t,i){for(var n,r=0;(n=this._listeners[r])&&(n[0]!=e||n[1]!=t||n[2]!=i);r++);n&&this._listeners.splice(r,1)};s.prototype.dispatchEvent=function(e){var t={type:e.type,target:this,currentTarget:this,eventPhase:2,bubbles:e.bubbles,cancelable:e.cancelable,timeStamp:e.timeStamp,stopPropagation:function(){},preventDefault:function(){},initEvent:function(){}};"readystatechange"==t.type&&this.onreadystatechange&&(this.onreadystatechange.handleEvent||this.onreadystatechange).apply(this,[t]);for(var i,n=0;i=this._listeners[n];n++)i[0]!=t.type||i[2]||(i[1].handleEvent||i[1]).apply(this,[t])};s.prototype.toString=function(){return"[object XMLHttpRequest]"};s.toString=function(){return"[XMLHttpRequest]"};function a(e){s.onreadystatechange&&s.onreadystatechange.apply(e);e.dispatchEvent({type:"readystatechange",bubbles:!1,cancelable:!1,timeStamp:new Date+0})}function o(e){try{e.responseText=e._object.responseText}catch(e){}try{e.responseXML=function(e){var t=e.responseXML,n=e.responseText;if(i&&n&&t&&!t.documentElement&&e.getResponseHeader("Content-Type").match(/[^\/]+\/[^\+]+\+xml/)){(t=new window.ActiveXObject("Microsoft.XMLDOM")).async=!1;t.validateOnParse=!1;t.loadXML(n)}return t&&(i&&0!=t.parseError||!t.documentElement||t.documentElement&&"parsererror"==t.documentElement.tagName)?null:t}(e._object)}catch(e){}try{e.status=e._object.status}catch(e){}try{e.statusText=e._object.statusText}catch(e){}}function l(e){e._object.onreadystatechange=new window.Function}window.Function.prototype.apply||(window.Function.prototype.apply=function(e,t){t||(t=[]);e.__func=this;e.__func(t[0],t[1],t[2],t[3],t[4]);delete e.__func});OpenLayers.Request||(OpenLayers.Request={});OpenLayers.Request.XMLHttpRequest=s}();OpenLayers.Format.KML=OpenLayers.Class(OpenLayers.Format.XML,{namespaces:{kml:"http://www.opengis.net/kml/2.2",gx:"http://www.google.com/kml/ext/2.2"},kmlns:"http://earth.google.com/kml/2.0",placemarksDesc:"No description available",foldersName:"OpenLayers export",foldersDesc:"Exported on "+new Date,extractAttributes:!0,kvpAttributes:!1,extractStyles:!1,extractTracks:!1,trackAttributes:null,internalns:null,features:null,styles:null,styleBaseUrl:"",fetched:null,maxDepth:0,initialize:function(e){this.regExes={trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g,kmlColor:/(\w{2})(\w{2})(\w{2})(\w{2})/,kmlIconPalette:/root:\/\/icons\/palette-(\d+)(\.\w+)/,straightBracket:/\$\[(.*?)\]/g};this.externalProjection=new OpenLayers.Projection("EPSG:4326");OpenLayers.Format.XML.prototype.initialize.apply(this,[e])},read:function(e){this.features=[];this.styles={};this.fetched={};var t={depth:0,styleBaseUrl:this.styleBaseUrl};return this.parseData(e,t)},parseData:function(e,t){"string"==typeof e&&(e=OpenLayers.Format.XML.prototype.read.apply(this,[e]));for(var i=["Link","NetworkLink","Style","StyleMap","Placemark"],n=0,r=i.length;n<r;++n){var s=i[n],a=this.getElementsByTagNameNS(e,"*",s);if(0!=a.length)switch(s.toLowerCase()){case"link":case"networklink":this.parseLinks(a,t);break;case"style":this.extractStyles&&this.parseStyles(a,t);break;case"stylemap":this.extractStyles&&this.parseStyleMaps(a,t);break;case"placemark":this.parseFeatures(a,t)}}return this.features},parseLinks:function(e,t){if(t.depth>=this.maxDepth)return!1;var i=OpenLayers.Util.extend({},t);i.depth++;for(var n=0,r=e.length;n<r;n++){var s=this.parseProperty(e[n],"*","href");if(s&&!this.fetched[s]){this.fetched[s]=!0;var a=this.fetchLink(s);a&&this.parseData(a,i)}}},fetchLink:function(e){var t=OpenLayers.Request.GET({url:e,async:!1});if(t)return t.responseText},parseStyles:function(e,t){for(var i=0,n=e.length;i<n;i++){var r=this.parseStyle(e[i]);if(r){var s=(t.styleBaseUrl||"")+"#"+r.id;this.styles[s]=r}}},parseKmlColor:function(e){var t=null;if(e){var i=e.match(this.regExes.kmlColor);i&&(t={color:"#"+i[4]+i[3]+i[2],opacity:parseInt(i[1],16)/255})}return t},parseStyle:function(e){for(var t,i,n={},r=["LineStyle","PolyStyle","IconStyle","BalloonStyle","LabelStyle"],s=0,a=r.length;s<a;++s){t=r[s];if(i=this.getElementsByTagNameNS(e,"*",t)[0])switch(t.toLowerCase()){case"linestyle":var o=this.parseProperty(i,"*","color");if(S=this.parseKmlColor(o)){n.strokeColor=S.color;n.strokeOpacity=S.opacity}(c=this.parseProperty(i,"*","width"))&&(n.strokeWidth=c);break;case"polystyle":o=this.parseProperty(i,"*","color");if(S=this.parseKmlColor(o)){n.fillOpacity=S.opacity;n.fillColor=S.color}"0"==this.parseProperty(i,"*","fill")&&(n.fillColor="none");"0"==this.parseProperty(i,"*","outline")&&(n.strokeWidth="0");break;case"iconstyle":var l=parseFloat(this.parseProperty(i,"*","scale")||1),c=32*l,u=32*l,h=this.getElementsByTagNameNS(i,"*","Icon")[0];if(h){var p=this.parseProperty(h,"*","href");if(p){var d=this.parseProperty(h,"*","w"),f=this.parseProperty(h,"*","h");if(OpenLayers.String.startsWith(p,"http://maps.google.com/mapfiles/kml")&&!d&&!f){d=64;f=64;l/=2}d=d||f;f=f||d;d&&(c=parseInt(d)*l);f&&(u=parseInt(f)*l);var m=p.match(this.regExes.kmlIconPalette);if(m){var y=m[1],g=m[2],C=this.parseProperty(h,"*","x");p="http://maps.google.com/mapfiles/kml/pal"+y+"/icon"+(8*((T=this.parseProperty(h,"*","y"))?7-T/32:7)+(C?C/32:0))+g}n.graphicOpacity=1;n.externalGraphic=p}}var v=this.getElementsByTagNameNS(i,"*","hotSpot")[0];if(v){C=parseFloat(v.getAttribute("x"));var T=parseFloat(v.getAttribute("y")),L=v.getAttribute("xunits");"pixels"==L?n.graphicXOffset=-C*l:"insetPixels"==L?n.graphicXOffset=C*l-c:"fraction"==L&&(n.graphicXOffset=-c*C);var w=v.getAttribute("yunits");"pixels"==w?n.graphicYOffset=T*l-u+1:"insetPixels"==w?n.graphicYOffset=-T*l+1:"fraction"==w&&(n.graphicYOffset=-u*(1-T)+1)}n.graphicWidth=c;n.graphicHeight=u;break;case"balloonstyle":var b=OpenLayers.Util.getXmlNodeValue(i);b&&(n.balloonStyle=b.replace(this.regExes.straightBracket,"${$1}"));break;case"labelstyle":var S;o=this.parseProperty(i,"*","color");if(S=this.parseKmlColor(o)){n.fontColor=S.color;n.fontOpacity=S.opacity}}}!n.strokeColor&&n.fillColor&&(n.strokeColor=n.fillColor);var E=e.getAttribute("id");E&&n&&(n.id=E);return n},parseStyleMaps:function(e,t){for(var i=0,n=e.length;i<n;i++)for(var r=e[i],s=this.getElementsByTagNameNS(r,"*","Pair"),a=r.getAttribute("id"),o=0,l=s.length;o<l;o++){var c=s[o],u=this.parseProperty(c,"*","key"),h=this.parseProperty(c,"*","styleUrl");h&&"normal"==u&&(this.styles[(t.styleBaseUrl||"")+"#"+a]=this.styles[(t.styleBaseUrl||"")+h])}},parseFeatures:function(e,t){for(var i=[],n=0,r=e.length;n<r;n++){var s=e[n],a=this.parseFeature.apply(this,[s]);if(!a)throw"Bad Placemark: "+n;this.extractStyles&&a.attributes&&a.attributes.styleUrl&&(a.style=this.getStyle(a.attributes.styleUrl,t));if(this.extractStyles){var o=this.getElementsByTagNameNS(s,"*","Style")[0];if(o){var l=this.parseStyle(o);l&&(a.style=OpenLayers.Util.extend(a.style,l))}}if(this.extractTracks){var c=this.getElementsByTagNameNS(s,this.namespaces.gx,"Track");if(c&&c.length>0){var u=c[0],h={features:[],feature:a};this.readNode(u,h);h.features.length>0&&i.push.apply(i,h.features)}}else i.push(a)}this.features=this.features.concat(i)},readers:{kml:{when:function(e,t){t.whens.push(OpenLayers.Date.parse(this.getChildValue(e)))},_trackPointAttribute:function(e,t){var i=e.nodeName.split(":").pop();t.attributes[i].push(this.getChildValue(e))}},gx:{Track:function(e,t){var i={whens:[],points:[],angles:[]};if(this.trackAttributes){i.attributes={};for(var n=0,r=this.trackAttributes.length;n<r;++n){h=this.trackAttributes[n];i.attributes[h]=[];h in this.readers.kml||(this.readers.kml[h]=this.readers.kml._trackPointAttribute)}}this.readChildNodes(e,i);if(i.whens.length!==i.points.length)throw new Error("gx:Track with unequal number of when ("+i.whens.length+") and gx:coord ("+i.points.length+") elements.");var s,a,o,l=i.angles.length>0;if(l&&i.whens.length!==i.angles.length)throw new Error("gx:Track with unequal number of when ("+i.whens.length+") and gx:angles ("+i.angles.length+") elements.");for(n=0,r=i.whens.length;n<r;++n){(s=t.feature.clone()).fid=t.feature.fid||t.feature.id;a=i.points[n];s.geometry=a;"z"in a&&(s.attributes.altitude=a.z);this.internalProjection&&this.externalProjection&&s.geometry.transform(this.externalProjection,this.internalProjection);if(this.trackAttributes)for(var c=0,u=this.trackAttributes.length;c<u;++c){var h=this.trackAttributes[c];s.attributes[h]=i.attributes[h][n]}s.attributes.when=i.whens[n];s.attributes.trackId=t.feature.id;if(l){o=i.angles[n];s.attributes.heading=parseFloat(o[0]);s.attributes.tilt=parseFloat(o[1]);s.attributes.roll=parseFloat(o[2])}t.features.push(s)}},coord:function(e,t){var i=this.getChildValue(e).replace(this.regExes.trimSpace,"").split(/\s+/),n=new OpenLayers.Geometry.Point(i[0],i[1]);i.length>2&&(n.z=parseFloat(i[2]));t.points.push(n)},angles:function(e,t){var i=this.getChildValue(e).replace(this.regExes.trimSpace,"").split(/\s+/);t.angles.push(i)}}},parseFeature:function(e){for(var t,i,n,r,s=["MultiGeometry","Polygon","LineString","Point"],a=0,o=s.length;a<o;++a){t=s[a];this.internalns=e.namespaceURI?e.namespaceURI:this.kmlns;if((i=this.getElementsByTagNameNS(e,this.internalns,t)).length>0){var l;if(!(l=this.parseGeometry[t.toLowerCase()]))throw new TypeError("Unsupported geometry type: "+t);n=l.apply(this,[i[0]]);this.internalProjection&&this.externalProjection&&n.transform(this.externalProjection,this.internalProjection);break}}this.extractAttributes&&(r=this.parseAttributes(e));var c=new OpenLayers.Feature.Vector(n,r),u=e.getAttribute("id")||e.getAttribute("name");null!=u&&(c.fid=u);return c},getStyle:function(e,t){var i=OpenLayers.Util.removeTail(e),n=OpenLayers.Util.extend({},t);n.depth++;n.styleBaseUrl=i;if(!this.styles[e]&&!OpenLayers.String.startsWith(e,"#")&&n.depth<=this.maxDepth&&!this.fetched[i]){var r=this.fetchLink(i);r&&this.parseData(r,n)}return OpenLayers.Util.extend({},this.styles[e])},parseGeometry:{point:function(e){var t=this.getElementsByTagNameNS(e,this.internalns,"coordinates"),i=[];if(t.length>0){var n=t[0].firstChild.nodeValue;i=(n=n.replace(this.regExes.removeSpace,"")).split(",")}if(!(i.length>1))throw"Bad coordinate string: "+n;2==i.length&&(i[2]=null);return new OpenLayers.Geometry.Point(i[0],i[1],i[2])},linestring:function(e,t){var i=this.getElementsByTagNameNS(e,this.internalns,"coordinates"),n=null;if(i.length>0){for(var r,s=this.getChildValue(i[0]),a=(s=(s=s.replace(this.regExes.trimSpace,"")).replace(this.regExes.trimComma,",")).split(this.regExes.splitSpace),o=a.length,l=new Array(o),c=0;c<o;++c){if(!((r=a[c].split(",")).length>1))throw"Bad LineString point coordinates: "+a[c];2==r.length&&(r[2]=null);l[c]=new OpenLayers.Geometry.Point(r[0],r[1],r[2])}if(!o)throw"Bad LineString coordinates: "+s;n=t?new OpenLayers.Geometry.LinearRing(l):new OpenLayers.Geometry.LineString(l)}return n},polygon:function(e){var t=this.getElementsByTagNameNS(e,this.internalns,"LinearRing"),i=t.length,n=new Array(i);if(i>0)for(var r,s=0,a=t.length;s<a;++s){if(!(r=this.parseGeometry.linestring.apply(this,[t[s],!0])))throw"Bad LinearRing geometry: "+s;n[s]=r}return new OpenLayers.Geometry.Polygon(n)},multigeometry:function(e){for(var t,i=[],n=e.childNodes,r=0,s=n.length;r<s;++r)if(1==(t=n[r]).nodeType){var a,o=t.prefix?t.nodeName.split(":")[1]:t.nodeName;(a=this.parseGeometry[o.toLowerCase()])&&i.push(a.apply(this,[t]))}return new OpenLayers.Geometry.Collection(i)}},parseAttributes:function(e){var t,i,n={},r=e.getElementsByTagName("ExtendedData");r.length&&(n=this.parseExtendedData(r[0]));for(var s=e.childNodes,a=0,o=s.length;a<o;++a)if(1==(t=s[a]).nodeType&&(i=t.childNodes).length>=1&&i.length<=3){var l;switch(i.length){case 1:l=i[0];break;case 2:var c=i[0],u=i[1];l=3==c.nodeType||4==c.nodeType?c:u;break;case 3:default:l=i[1]}if(3==l.nodeType||4==l.nodeType){var h=t.prefix?t.nodeName.split(":")[1]:t.nodeName,p=OpenLayers.Util.getXmlNodeValue(l);if(p){p=p.replace(this.regExes.trimSpace,"");n[h]=p}}}return n},parseExtendedData:function(e){var t,i,n,r,s={},a=e.getElementsByTagName("Data");for(t=0,i=a.length;t<i;t++){r=(n=a[t]).getAttribute("name");var o={},l=n.getElementsByTagName("value");l.length&&(o.value=this.getChildValue(l[0]));if(this.kvpAttributes)s[r]=o.value;else{var c=n.getElementsByTagName("displayName");c.length&&(o.displayName=this.getChildValue(c[0]));s[r]=o}}var u=e.getElementsByTagName("SimpleData");for(t=0,i=u.length;t<i;t++){o={};r=(n=u[t]).getAttribute("name");o.value=this.getChildValue(n);if(this.kvpAttributes)s[r]=o.value;else{o.displayName=r;s[r]=o}}return s},parseProperty:function(e,t,i){var n,r=this.getElementsByTagNameNS(e,t,i);try{n=OpenLayers.Util.getXmlNodeValue(r[0])}catch(e){n=null}return n},write:function(e){OpenLayers.Util.isArray(e)||(e=[e]);for(var t=this.createElementNS(this.kmlns,"kml"),i=this.createFolderXML(),n=0,r=e.length;n<r;++n)i.appendChild(this.createPlacemarkXML(e[n]));t.appendChild(i);return OpenLayers.Format.XML.prototype.write.apply(this,[t])},createFolderXML:function(){var e=this.createElementNS(this.kmlns,"Folder");if(this.foldersName){var t=this.createElementNS(this.kmlns,"name"),i=this.createTextNode(this.foldersName);t.appendChild(i);e.appendChild(t)}if(this.foldersDesc){var n=this.createElementNS(this.kmlns,"description"),r=this.createTextNode(this.foldersDesc);n.appendChild(r);e.appendChild(n)}return e},createPlacemarkXML:function(e){var t=this.createElementNS(this.kmlns,"name"),i=e.style&&e.style.label?e.style.label:e.id,n=e.attributes.name||i;t.appendChild(this.createTextNode(n));var r=this.createElementNS(this.kmlns,"description"),s=e.attributes.description||this.placemarksDesc;r.appendChild(this.createTextNode(s));var a=this.createElementNS(this.kmlns,"Placemark");null!=e.fid&&a.setAttribute("id",e.fid);a.appendChild(t);a.appendChild(r);var o=this.buildGeometryNode(e.geometry);a.appendChild(o);if(e.attributes){var l=this.buildExtendedData(e.attributes);l&&a.appendChild(l)}return a},buildGeometryNode:function(e){var t=e.CLASS_NAME,i=t.substring(t.lastIndexOf(".")+1),n=this.buildGeometry[i.toLowerCase()],r=null;n&&(r=n.apply(this,[e]));return r},buildGeometry:{point:function(e){var t=this.createElementNS(this.kmlns,"Point");t.appendChild(this.buildCoordinatesNode(e));return t},multipoint:function(e){return this.buildGeometry.collection.apply(this,[e])},linestring:function(e){var t=this.createElementNS(this.kmlns,"LineString");t.appendChild(this.buildCoordinatesNode(e));return t},multilinestring:function(e){return this.buildGeometry.collection.apply(this,[e])},linearring:function(e){var t=this.createElementNS(this.kmlns,"LinearRing");t.appendChild(this.buildCoordinatesNode(e));return t},polygon:function(e){for(var t,i,n,r=this.createElementNS(this.kmlns,"Polygon"),s=e.components,a=0,o=s.length;a<o;++a){n=0==a?"outerBoundaryIs":"innerBoundaryIs";t=this.createElementNS(this.kmlns,n);i=this.buildGeometry.linearring.apply(this,[s[a]]);t.appendChild(i);r.appendChild(t)}return r},multipolygon:function(e){return this.buildGeometry.collection.apply(this,[e])},collection:function(e){for(var t,i=this.createElementNS(this.kmlns,"MultiGeometry"),n=0,r=e.components.length;n<r;++n)(t=this.buildGeometryNode.apply(this,[e.components[n]]))&&i.appendChild(t);return i}},buildCoordinatesNode:function(e){var t,i=this.createElementNS(this.kmlns,"coordinates"),n=e.components;if(n){for(var r,s=n.length,a=new Array(s),o=0;o<s;++o){r=n[o];a[o]=this.buildCoordinates(r)}t=a.join(" ")}else t=this.buildCoordinates(e);var l=this.createTextNode(t);i.appendChild(l);return i},buildCoordinates:function(e){this.internalProjection&&this.externalProjection&&(e=e.clone()).transform(this.internalProjection,this.externalProjection);return e.x+","+e.y},buildExtendedData:function(e){var t=this.createElementNS(this.kmlns,"ExtendedData");for(var i in e)if(e[i]&&"name"!=i&&"description"!=i&&"styleUrl"!=i){var n=this.createElementNS(this.kmlns,"Data");n.setAttribute("name",i);var r=this.createElementNS(this.kmlns,"value");if("object"==typeof e[i]){e[i].value&&r.appendChild(this.createTextNode(e[i].value));if(e[i].displayName){var s=this.createElementNS(this.kmlns,"displayName");s.appendChild(this.getXMLDoc().createCDATASection(e[i].displayName));n.appendChild(s)}}else r.appendChild(this.createTextNode(e[i]));n.appendChild(r);t.appendChild(n)}return this.isSimpleContent(t)?null:t},CLASS_NAME:"OpenLayers.Format.KML"});OpenLayers.Format.WMSCapabilities.v1_1=OpenLayers.Class(OpenLayers.Format.WMSCapabilities.v1,{readers:{wms:OpenLayers.Util.applyDefaults({WMT_MS_Capabilities:function(e,t){this.readChildNodes(e,t)},Keyword:function(e,t){t.keywords&&t.keywords.push(this.getChildValue(e))},DescribeLayer:function(e,t){t.describelayer={formats:[]};this.readChildNodes(e,t.describelayer)},GetLegendGraphic:function(e,t){t.getlegendgraphic={formats:[]};this.readChildNodes(e,t.getlegendgraphic)},GetStyles:function(e,t){t.getstyles={formats:[]};this.readChildNodes(e,t.getstyles)},PutStyles:function(e,t){t.putstyles={formats:[]};this.readChildNodes(e,t.putstyles)},UserDefinedSymbolization:function(e,t){var i={supportSLD:1==parseInt(e.getAttribute("SupportSLD")),userLayer:1==parseInt(e.getAttribute("UserLayer")),userStyle:1==parseInt(e.getAttribute("UserStyle")),remoteWFS:1==parseInt(e.getAttribute("RemoteWFS"))};t.userSymbols=i},LatLonBoundingBox:function(e,t){t.llbbox=[parseFloat(e.getAttribute("minx")),parseFloat(e.getAttribute("miny")),parseFloat(e.getAttribute("maxx")),parseFloat(e.getAttribute("maxy"))]},BoundingBox:function(e,t){var i=OpenLayers.Format.WMSCapabilities.v1.prototype.readers.wms.BoundingBox.apply(this,[e,t]);i.srs=e.getAttribute("SRS");t.bbox[i.srs]=i},ScaleHint:function(e,t){var i=e.getAttribute("min"),n=e.getAttribute("max"),r=Math.pow(2,.5),s=OpenLayers.INCHES_PER_UNIT.m;0!=i&&(t.maxScale=parseFloat((i/r*s*OpenLayers.DOTS_PER_INCH).toPrecision(13)));n!=Number.POSITIVE_INFINITY&&(t.minScale=parseFloat((n/r*s*OpenLayers.DOTS_PER_INCH).toPrecision(13)))},Dimension:function(e,t){var i={name:e.getAttribute("name").toLowerCase(),units:e.getAttribute("units"),unitsymbol:e.getAttribute("unitSymbol")};t.dimensions[i.name]=i},Extent:function(e,t){var i=e.getAttribute("name").toLowerCase();if(i in t.dimensions){var n=t.dimensions[i];n.nearestVal="1"===e.getAttribute("nearestValue");n.multipleVal="1"===e.getAttribute("multipleValues");n.current="1"===e.getAttribute("current");n.default=e.getAttribute("default")||"";var r=this.getChildValue(e);n.values=r.split(",")}}},OpenLayers.Format.WMSCapabilities.v1.prototype.readers.wms)},CLASS_NAME:"OpenLayers.Format.WMSCapabilities.v1_1"});OpenLayers.Format.WMSCapabilities.v1_1_0=OpenLayers.Class(OpenLayers.Format.WMSCapabilities.v1_1,{version:"1.1.0",readers:{wms:OpenLayers.Util.applyDefaults({SRS:function(e,t){for(var i=this.getChildValue(e).split(/ +/),n=0,r=i.length;n<r;n++)t.srs[i[n]]=!0}},OpenLayers.Format.WMSCapabilities.v1_1.prototype.readers.wms)},CLASS_NAME:"OpenLayers.Format.WMSCapabilities.v1_1_0"});OpenLayers.Protocol.WFS.v1=OpenLayers.Class(OpenLayers.Protocol,{version:null,srsName:"EPSG:4326",featureType:null,featureNS:null,geometryName:"the_geom",schema:null,featurePrefix:"feature",formatOptions:null,readFormat:null,readOptions:null,initialize:function(e){OpenLayers.Protocol.prototype.initialize.apply(this,[e]);e.format||(this.format=OpenLayers.Format.WFST(OpenLayers.Util.extend({version:this.version,featureType:this.featureType,featureNS:this.featureNS,featurePrefix:this.featurePrefix,geometryName:this.geometryName,srsName:this.srsName,schema:this.schema},this.formatOptions)));!e.geometryName&&parseFloat(this.format.version)>1&&this.setGeometryName(null)},destroy:function(){this.options&&!this.options.format&&this.format.destroy();this.format=null;OpenLayers.Protocol.prototype.destroy.apply(this)},read:function(e){OpenLayers.Protocol.prototype.read.apply(this,arguments);e=OpenLayers.Util.extend({},e);OpenLayers.Util.applyDefaults(e,this.options||{});var t=new OpenLayers.Protocol.Response({requestType:"read"}),i=OpenLayers.Format.XML.prototype.write.apply(this.format,[this.format.writeNode("wfs:GetFeature",e)]);t.priv=OpenLayers.Request.POST({url:e.url,callback:this.createCallback(this.handleRead,t,e),params:e.params,headers:e.headers,data:i});return t},setFeatureType:function(e){this.featureType=e;this.format.featureType=e},setGeometryName:function(e){this.geometryName=e;this.format.geometryName=e},handleRead:function(e,t){t=OpenLayers.Util.extend({},t);OpenLayers.Util.applyDefaults(t,this.options);if(t.callback){var i=e.priv;if(i.status>=200&&i.status<300){var n=this.parseResponse(i,t.readOptions);if(n&&!1!==n.success){t.readOptions&&"object"==t.readOptions.output?OpenLayers.Util.extend(e,n):e.features=n;e.code=OpenLayers.Protocol.Response.SUCCESS}else{e.code=OpenLayers.Protocol.Response.FAILURE;e.error=n}}else e.code=OpenLayers.Protocol.Response.FAILURE;t.callback.call(t.scope,e)}},parseResponse:function(e,t){var i=e.responseXML;i&&i.documentElement||(i=e.responseText);if(!i||i.length<=0)return null;var n=null!==this.readFormat?this.readFormat.read(i):this.format.read(i,t);if(!this.featureNS){var r=this.readFormat||this.format;this.featureNS=r.featureNS;r.autoConfig=!1;this.geometryName||this.setGeometryName(r.geometryName)}return n},commit:function(e,t){t=OpenLayers.Util.extend({},t);OpenLayers.Util.applyDefaults(t,this.options);var i=new OpenLayers.Protocol.Response({requestType:"commit",reqFeatures:e});i.priv=OpenLayers.Request.POST({url:t.url,headers:t.headers,data:this.format.write(e,t),callback:this.createCallback(this.handleCommit,i,t)});return i},handleCommit:function(e,t){if(t.callback){var i=e.priv,n=i.responseXML;n&&n.documentElement||(n=i.responseText);var r=this.format.read(n)||{};e.insertIds=r.insertIds||[];if(r.success)e.code=OpenLayers.Protocol.Response.SUCCESS;else{e.code=OpenLayers.Protocol.Response.FAILURE;e.error=r}t.callback.call(t.scope,e)}},filterDelete:function(e,t){t=OpenLayers.Util.extend({},t);OpenLayers.Util.applyDefaults(t,this.options);new OpenLayers.Protocol.Response({requestType:"commit"});var i=this.format.createElementNSPlus("wfs:Transaction",{attributes:{service:"WFS",version:this.version}}),n=this.format.createElementNSPlus("wfs:Delete",{attributes:{typeName:(t.featureNS?this.featurePrefix+":":"")+t.featureType}});t.featureNS&&n.setAttribute("xmlns:"+this.featurePrefix,t.featureNS);var r=this.format.writeNode("ogc:Filter",e);n.appendChild(r);i.appendChild(n);var s=OpenLayers.Format.XML.prototype.write.apply(this.format,[i]);return OpenLayers.Request.POST({url:this.url,callback:t.callback||function(){},data:s})},abort:function(e){e&&e.priv.abort()},CLASS_NAME:"OpenLayers.Protocol.WFS.v1"});OpenLayers.Format.OWSCommon.v1_1_0=OpenLayers.Class(OpenLayers.Format.OWSCommon.v1,{namespaces:{ows:"http://www.opengis.net/ows/1.1",xlink:"http://www.w3.org/1999/xlink"},readers:{ows:OpenLayers.Util.applyDefaults({ExceptionReport:function(e,t){t.exceptionReport={version:e.getAttribute("version"),language:e.getAttribute("xml:lang"),exceptions:[]};this.readChildNodes(e,t.exceptionReport)},AllowedValues:function(e,t){t.allowedValues={};this.readChildNodes(e,t.allowedValues)},AnyValue:function(e,t){t.anyValue=!0},DataType:function(e,t){t.dataType=this.getChildValue(e)},Range:function(e,t){t.range={};this.readChildNodes(e,t.range)},MinimumValue:function(e,t){t.minValue=this.getChildValue(e)},MaximumValue:function(e,t){t.maxValue=this.getChildValue(e)},Identifier:function(e,t){t.identifier=this.getChildValue(e)},SupportedCRS:function(e,t){t.supportedCRS=this.getChildValue(e)}},OpenLayers.Format.OWSCommon.v1.prototype.readers.ows)},writers:{ows:OpenLayers.Util.applyDefaults({Range:function(e){var t=this.createElementNSPlus("ows:Range",{attributes:{"ows:rangeClosure":e.closure}});this.writeNode("ows:MinimumValue",e.minValue,t);this.writeNode("ows:MaximumValue",e.maxValue,t);return t},MinimumValue:function(e){return this.createElementNSPlus("ows:MinimumValue",{value:e})},MaximumValue:function(e){return this.createElementNSPlus("ows:MaximumValue",{value:e})},Value:function(e){return this.createElementNSPlus("ows:Value",{value:e})}},OpenLayers.Format.OWSCommon.v1.prototype.writers.ows)},CLASS_NAME:"OpenLayers.Format.OWSCommon.v1_1_0"});OpenLayers.Kinetic=OpenLayers.Class({threshold:0,deceleration:.0035,nbPoints:100,delay:200,points:void 0,timerId:void 0,initialize:function(e){OpenLayers.Util.extend(this,e)},begin:function(){OpenLayers.Animation.stop(this.timerId);this.timerId=void 0;this.points=[]},update:function(e){this.points.unshift({xy:e,tick:(new Date).getTime()});this.points.length>this.nbPoints&&this.points.pop()},end:function(e){for(var t,i,n=(new Date).getTime(),r=0,s=this.points.length;r<s&&!(n-(i=this.points[r]).tick>this.delay);r++)t=i;if(t){var a=(new Date).getTime()-t.tick,o=Math.sqrt(Math.pow(e.x-t.xy.x,2)+Math.pow(e.y-t.xy.y,2)),l=o/a;if(!(0==l||l<this.threshold)){var c=Math.asin((e.y-t.xy.y)/o);t.xy.x<=e.x&&(c=Math.PI-c);return{speed:l,theta:c}}}},move:function(e,t){var i=e.speed,n=Math.cos(e.theta),r=-Math.sin(e.theta),s=(new Date).getTime(),a=0,o=0;this.timerId=OpenLayers.Animation.start(OpenLayers.Function.bind(function(){if(null!=this.timerId){var e=(new Date).getTime()-s,l=-this.deceleration*Math.pow(e,2)/2+i*e,c=l*n,u=l*r,h={end:!1};if(-this.deceleration*e+i<=0){OpenLayers.Animation.stop(this.timerId);this.timerId=null;h.end=!0}h.x=c-a;h.y=u-o;a=c;o=u;t(h.x,h.y,h.end)}},this))},CLASS_NAME:"OpenLayers.Kinetic"});OpenLayers.Strategy.Filter=OpenLayers.Class(OpenLayers.Strategy,{filter:null,cache:null,caching:!1,activate:function(){var e=OpenLayers.Strategy.prototype.activate.apply(this,arguments);if(e){this.cache=[];this.layer.events.on({beforefeaturesadded:this.handleAdd,beforefeaturesremoved:this.handleRemove,scope:this})}return e},deactivate:function(){this.cache=null;this.layer&&this.layer.events&&this.layer.events.un({beforefeaturesadded:this.handleAdd,beforefeaturesremoved:this.handleRemove,scope:this});return OpenLayers.Strategy.prototype.deactivate.apply(this,arguments)},handleAdd:function(e){if(!this.caching&&this.filter){var t,i=e.features;e.features=[];for(var n=0,r=i.length;n<r;++n){t=i[n];this.filter.evaluate(t)?e.features.push(t):this.cache.push(t)}}},handleRemove:function(e){this.caching||(this.cache=[])},setFilter:function(e){this.filter=e;var t=this.cache;this.cache=[];this.handleAdd({features:this.layer.features});if(this.cache.length>0){this.caching=!0;this.layer.removeFeatures(this.cache.slice());this.caching=!1}if(t.length>0){var i={features:t};this.handleAdd(i);if(i.features.length>0){this.caching=!0;this.layer.addFeatures(i.features);this.caching=!1}}},CLASS_NAME:"OpenLayers.Strategy.Filter"});OpenLayers.Handler.Drag=OpenLayers.Class(OpenLayers.Handler,{started:!1,stopDown:!0,dragging:!1,last:null,start:null,lastMoveEvt:null,oldOnselectstart:null,interval:0,timeoutId:null,documentDrag:!1,documentEvents:null,initialize:function(e,t,i){OpenLayers.Handler.prototype.initialize.apply(this,arguments);if(!0===this.documentDrag){var n=this;this._docMove=function(e){n.mousemove({xy:{x:e.clientX,y:e.clientY},element:document})};this._docUp=function(e){n.mouseup({xy:{x:e.clientX,y:e.clientY}})}}},dragstart:function(e){var t=!0;this.dragging=!1;if(this.checkModifiers(e)&&(OpenLayers.Event.isLeftClick(e)||OpenLayers.Event.isSingleTouch(e))){this.started=!0;this.start=e.xy;this.last=e.xy;OpenLayers.Element.addClass(this.map.viewPortDiv,"olDragDown");this.down(e);this.callback("down",[e.xy]);OpenLayers.Event.preventDefault(e);this.oldOnselectstart||(this.oldOnselectstart=document.onselectstart?document.onselectstart:OpenLayers.Function.True);document.onselectstart=OpenLayers.Function.False;t=!this.stopDown}else{this.started=!1;this.start=null;this.last=null}return t},dragmove:function(e){this.lastMoveEvt=e;if(this.started&&!this.timeoutId&&(e.xy.x!=this.last.x||e.xy.y!=this.last.y)){if(!0===this.documentDrag&&this.documentEvents)if(e.element===document){this.adjustXY(e);this.setEvent(e)}else this.removeDocumentEvents();this.interval>0&&(this.timeoutId=setTimeout(OpenLayers.Function.bind(this.removeTimeout,this),this.interval));this.dragging=!0;this.move(e);this.callback("move",[e.xy]);if(!this.oldOnselectstart){this.oldOnselectstart=document.onselectstart;document.onselectstart=OpenLayers.Function.False}this.last=e.xy}return!0},dragend:function(e){if(this.started){if(!0===this.documentDrag&&this.documentEvents){this.adjustXY(e);this.removeDocumentEvents()}var t=this.start!=this.last;this.started=!1;this.dragging=!1;OpenLayers.Element.removeClass(this.map.viewPortDiv,"olDragDown");this.up(e);this.callback("up",[e.xy]);t&&this.callback("done",[e.xy]);document.onselectstart=this.oldOnselectstart}return!0},down:function(e){},move:function(e){},up:function(e){},out:function(e){},mousedown:function(e){return this.dragstart(e)},touchstart:function(e){this.startTouch();return this.dragstart(e)},mousemove:function(e){return this.dragmove(e)},touchmove:function(e){return this.dragmove(e)},removeTimeout:function(){this.timeoutId=null;this.dragging&&this.mousemove(this.lastMoveEvt)},mouseup:function(e){return this.dragend(e)},touchend:function(e){e.xy=this.last;return this.dragend(e)},mouseout:function(e){if(this.started&&OpenLayers.Util.mouseLeft(e,this.map.viewPortDiv))if(!0===this.documentDrag)this.addDocumentEvents();else{var t=this.start!=this.last;this.started=!1;this.dragging=!1;OpenLayers.Element.removeClass(this.map.viewPortDiv,"olDragDown");this.out(e);this.callback("out",[]);t&&this.callback("done",[e.xy]);document.onselectstart&&(document.onselectstart=this.oldOnselectstart)}return!0},click:function(e){return this.start==this.last},activate:function(){var e=!1;if(OpenLayers.Handler.prototype.activate.apply(this,arguments)){this.dragging=!1;e=!0}return e},deactivate:function(){var e=!1;if(OpenLayers.Handler.prototype.deactivate.apply(this,arguments)){this.started=!1;this.dragging=!1;this.start=null;this.last=null;e=!0;OpenLayers.Element.removeClass(this.map.viewPortDiv,"olDragDown")}return e},adjustXY:function(e){var t=OpenLayers.Util.pagePosition(this.map.viewPortDiv);e.xy.x-=t[0];e.xy.y-=t[1]},addDocumentEvents:function(){OpenLayers.Element.addClass(document.body,"olDragDown");this.documentEvents=!0;OpenLayers.Event.observe(document,"mousemove",this._docMove);OpenLayers.Event.observe(document,"mouseup",this._docUp)},removeDocumentEvents:function(){OpenLayers.Element.removeClass(document.body,"olDragDown");this.documentEvents=!1;OpenLayers.Event.stopObserving(document,"mousemove",this._docMove);OpenLayers.Event.stopObserving(document,"mouseup",this._docUp)},CLASS_NAME:"OpenLayers.Handler.Drag"});OpenLayers.Handler.Box=OpenLayers.Class(OpenLayers.Handler,{dragHandler:null,boxDivClassName:"olHandlerBoxZoomBox",boxOffsets:null,initialize:function(e,t,i){OpenLayers.Handler.prototype.initialize.apply(this,arguments);this.dragHandler=new OpenLayers.Handler.Drag(this,{down:this.startBox,move:this.moveBox,out:this.removeBox,up:this.endBox},{keyMask:this.keyMask})},destroy:function(){OpenLayers.Handler.prototype.destroy.apply(this,arguments);if(this.dragHandler){this.dragHandler.destroy();this.dragHandler=null}},setMap:function(e){OpenLayers.Handler.prototype.setMap.apply(this,arguments);this.dragHandler&&this.dragHandler.setMap(e)},startBox:function(e){this.callback("start",[]);this.zoomBox=OpenLayers.Util.createDiv("zoomBox",{x:-9999,y:-9999});this.zoomBox.className=this.boxDivClassName;this.zoomBox.style.zIndex=this.map.Z_INDEX_BASE.Popup-1;this.map.viewPortDiv.appendChild(this.zoomBox);OpenLayers.Element.addClass(this.map.viewPortDiv,"olDrawBox")},moveBox:function(e){var t=this.dragHandler.start.x,i=this.dragHandler.start.y,n=Math.abs(t-e.x),r=Math.abs(i-e.y),s=this.getBoxOffsets();this.zoomBox.style.width=n+s.width+1+"px";this.zoomBox.style.height=r+s.height+1+"px";this.zoomBox.style.left=(e.x<t?t-n-s.left:t-s.left)+"px";this.zoomBox.style.top=(e.y<i?i-r-s.top:i-s.top)+"px"},endBox:function(e){var t;if(Math.abs(this.dragHandler.start.x-e.x)>5||Math.abs(this.dragHandler.start.y-e.y)>5){var i=this.dragHandler.start,n=Math.min(i.y,e.y),r=Math.max(i.y,e.y),s=Math.min(i.x,e.x),a=Math.max(i.x,e.x);t=new OpenLayers.Bounds(s,r,a,n)}else t=this.dragHandler.start.clone();this.removeBox();this.callback("done",[t])},removeBox:function(){this.map.viewPortDiv.removeChild(this.zoomBox);this.zoomBox=null;this.boxOffsets=null;OpenLayers.Element.removeClass(this.map.viewPortDiv,"olDrawBox")},activate:function(){if(OpenLayers.Handler.prototype.activate.apply(this,arguments)){this.dragHandler.activate();return!0}return!1},deactivate:function(){if(OpenLayers.Handler.prototype.deactivate.apply(this,arguments)){this.dragHandler.deactivate()&&this.zoomBox&&this.removeBox();return!0}return!1},getBoxOffsets:function(){if(!this.boxOffsets){var e=document.createElement("div");e.style.position="absolute";e.style.border="1px solid black";e.style.width="3px";document.body.appendChild(e);var t=3==e.clientWidth;document.body.removeChild(e);var i=parseInt(OpenLayers.Element.getStyle(this.zoomBox,"border-left-width")),n=parseInt(OpenLayers.Element.getStyle(this.zoomBox,"border-right-width")),r=parseInt(OpenLayers.Element.getStyle(this.zoomBox,"border-top-width")),s=parseInt(OpenLayers.Element.getStyle(this.zoomBox,"border-bottom-width"));this.boxOffsets={left:i,right:n,top:r,bottom:s,width:!1===t?i+n:0,height:!1===t?r+s:0}}return this.boxOffsets},CLASS_NAME:"OpenLayers.Handler.Box"});OpenLayers.Control.ZoomBox=OpenLayers.Class(OpenLayers.Control,{type:OpenLayers.Control.TYPE_TOOL,out:!1,keyMask:null,alwaysZoom:!1,zoomOnClick:!0,draw:function(){this.handler=new OpenLayers.Handler.Box(this,{done:this.zoomBox},{keyMask:this.keyMask})},zoomBox:function(e){if(e instanceof OpenLayers.Bounds){var t,i=e.getCenterPixel();if(this.out){var n=e.right-e.left,r=e.bottom-e.top,s=Math.min(this.map.size.h/r,this.map.size.w/n),a=this.map.getExtent(),o=this.map.getLonLatFromPixel(i),l=o.lon-a.getWidth()/2*s,c=o.lon+a.getWidth()/2*s,u=o.lat-a.getHeight()/2*s,h=o.lat+a.getHeight()/2*s;t=new OpenLayers.Bounds(l,u,c,h)}else{var p=this.map.getLonLatFromPixel({x:e.left,y:e.bottom}),d=this.map.getLonLatFromPixel({x:e.right,y:e.top});t=new OpenLayers.Bounds(p.lon,p.lat,d.lon,d.lat)}var f=this.map.getZoom(),m=this.map.getSize(),y={x:m.w/2,y:m.h/2},g=this.map.getZoomForExtent(t),C=this.map.getResolution(),v=this.map.getResolutionForZoom(g);if(C==v)this.map.setCenter(this.map.getLonLatFromPixel(i));else{var T={x:(C*i.x-v*y.x)/(C-v),y:(C*i.y-v*y.y)/(C-v)};this.map.zoomTo(g,T)}f==this.map.getZoom()&&1==this.alwaysZoom&&this.map.zoomTo(f+(this.out?-1:1))}else this.zoomOnClick&&(this.out?this.map.zoomTo(this.map.getZoom()-1,e):this.map.zoomTo(this.map.getZoom()+1,e))},CLASS_NAME:"OpenLayers.Control.ZoomBox"});OpenLayers.Control.DragPan=OpenLayers.Class(OpenLayers.Control,{type:OpenLayers.Control.TYPE_TOOL,panned:!1,interval:0,documentDrag:!1,kinetic:null,enableKinetic:!0,kineticInterval:10,draw:function(){if(this.enableKinetic&&OpenLayers.Kinetic){var e={interval:this.kineticInterval};"object"==typeof this.enableKinetic&&(e=OpenLayers.Util.extend(e,this.enableKinetic));this.kinetic=new OpenLayers.Kinetic(e)}this.handler=new OpenLayers.Handler.Drag(this,{move:this.panMap,done:this.panMapDone,down:this.panMapStart},{interval:this.interval,documentDrag:this.documentDrag})},panMapStart:function(){this.kinetic&&this.kinetic.begin()},panMap:function(e){this.kinetic&&this.kinetic.update(e);this.panned=!0;this.map.pan(this.handler.last.x-e.x,this.handler.last.y-e.y,{dragging:!0,animate:!1})},panMapDone:function(e){if(this.panned){var t=null;this.kinetic&&(t=this.kinetic.end(e));this.map.pan(this.handler.last.x-e.x,this.handler.last.y-e.y,{dragging:!!t,animate:!1});if(t){var i=this;this.kinetic.move(t,function(e,t,n){i.map.pan(e,t,{dragging:!n,animate:!1})})}this.panned=!1}},CLASS_NAME:"OpenLayers.Control.DragPan"});OpenLayers.Handler.Click=OpenLayers.Class(OpenLayers.Handler,{delay:300,single:!0,double:!1,pixelTolerance:0,dblclickTolerance:13,stopSingle:!1,stopDouble:!1,timerId:null,down:null,last:null,first:null,rightclickTimerId:null,touchstart:function(e){this.startTouch();this.down=this.getEventInfo(e);this.last=this.getEventInfo(e);return!0},touchmove:function(e){this.last=this.getEventInfo(e);return!0},touchend:function(e){if(this.down){e.xy=this.last.xy;e.lastTouches=this.last.touches;this.handleSingle(e);this.down=null}return!0},mousedown:function(e){this.down=this.getEventInfo(e);this.last=this.getEventInfo(e);return!0},mouseup:function(e){var t=!0;this.checkModifiers(e)&&this.control.handleRightClicks&&OpenLayers.Event.isRightClick(e)&&(t=this.rightclick(e));return t},rightclick:function(e){if(this.passesTolerance(e)){if(null!=this.rightclickTimerId){this.clearTimer();this.callback("dblrightclick",[e]);return!this.stopDouble}var t=this.double?OpenLayers.Util.extend({},e):this.callback("rightclick",[e]),i=OpenLayers.Function.bind(this.delayedRightCall,this,t);this.rightclickTimerId=window.setTimeout(i,this.delay)}return!this.stopSingle},delayedRightCall:function(e){this.rightclickTimerId=null;e&&this.callback("rightclick",[e])},click:function(e){this.last||(this.last=this.getEventInfo(e));this.handleSingle(e);return!this.stopSingle},dblclick:function(e){this.handleDouble(e);return!this.stopDouble},handleDouble:function(e){if(this.passesDblclickTolerance(e)){this.double&&this.callback("dblclick",[e]);this.clearTimer()}},handleSingle:function(e){if(this.passesTolerance(e))if(null!=this.timerId){if(this.last.touches&&1===this.last.touches.length){this.double&&OpenLayers.Event.preventDefault(e);this.handleDouble(e)}this.last.touches&&2===this.last.touches.length||this.clearTimer()}else{this.first=this.getEventInfo(e);var t=this.single?OpenLayers.Util.extend({},e):null;this.queuePotentialClick(t)}},queuePotentialClick:function(e){this.timerId=window.setTimeout(OpenLayers.Function.bind(this.delayedCall,this,e),this.delay)},passesTolerance:function(e){var t=!0;if(null!=this.pixelTolerance&&this.down&&this.down.xy&&(t=this.pixelTolerance>=this.down.xy.distanceTo(e.xy))&&this.touch&&this.down.touches.length===this.last.touches.length)for(var i=0,n=this.down.touches.length;i<n;++i)if(this.getTouchDistance(this.down.touches[i],this.last.touches[i])>this.pixelTolerance){t=!1;break}return t},getTouchDistance:function(e,t){return Math.sqrt(Math.pow(e.clientX-t.clientX,2)+Math.pow(e.clientY-t.clientY,2))},passesDblclickTolerance:function(e){var t=!0;this.down&&this.first&&(t=this.down.xy.distanceTo(this.first.xy)<=this.dblclickTolerance);return t},clearTimer:function(){if(null!=this.timerId){window.clearTimeout(this.timerId);this.timerId=null}if(null!=this.rightclickTimerId){window.clearTimeout(this.rightclickTimerId);this.rightclickTimerId=null}},delayedCall:function(e){this.timerId=null;e&&this.callback("click",[e])},getEventInfo:function(e){var t;if(e.touches){var i,n=e.touches.length;t=new Array(n);for(var r=0;r<n;r++){i=e.touches[r];t[r]={clientX:i.olClientX,clientY:i.olClientY}}}return{xy:e.xy,touches:t}},deactivate:function(){var e=!1;if(OpenLayers.Handler.prototype.deactivate.apply(this,arguments)){this.clearTimer();this.down=null;this.first=null;this.last=null;e=!0}return e},CLASS_NAME:"OpenLayers.Handler.Click"});OpenLayers.Control.Navigation=OpenLayers.Class(OpenLayers.Control,{dragPan:null,dragPanOptions:null,pinchZoom:null,pinchZoomOptions:null,documentDrag:!1,zoomBox:null,zoomBoxEnabled:!0,zoomWheelEnabled:!0,mouseWheelOptions:null,handleRightClicks:!1,zoomBoxKeyMask:OpenLayers.Handler.MOD_SHIFT,autoActivate:!0,initialize:function(e){this.handlers={};OpenLayers.Control.prototype.initialize.apply(this,arguments)},destroy:function(){this.deactivate();this.dragPan&&this.dragPan.destroy();this.dragPan=null;this.zoomBox&&this.zoomBox.destroy();this.zoomBox=null;this.pinchZoom&&this.pinchZoom.destroy();this.pinchZoom=null;OpenLayers.Control.prototype.destroy.apply(this,arguments)},activate:function(){this.dragPan.activate();this.zoomWheelEnabled&&this.handlers.wheel.activate();this.handlers.click.activate();this.zoomBoxEnabled&&this.zoomBox.activate();this.pinchZoom&&this.pinchZoom.activate();return OpenLayers.Control.prototype.activate.apply(this,arguments)},deactivate:function(){this.pinchZoom&&this.pinchZoom.deactivate();this.zoomBox.deactivate();this.dragPan.deactivate();this.handlers.click.deactivate();this.handlers.wheel.deactivate();return OpenLayers.Control.prototype.deactivate.apply(this,arguments)},draw:function(){this.handleRightClicks&&(this.map.viewPortDiv.oncontextmenu=OpenLayers.Function.False);var e={click:this.defaultClick,dblclick:this.defaultDblClick,dblrightclick:this.defaultDblRightClick};this.handlers.click=new OpenLayers.Handler.Click(this,e,{double:!0,stopDouble:!0});this.dragPan=new OpenLayers.Control.DragPan(OpenLayers.Util.extend({map:this.map,documentDrag:this.documentDrag},this.dragPanOptions));this.zoomBox=new OpenLayers.Control.ZoomBox({map:this.map,keyMask:this.zoomBoxKeyMask});this.dragPan.draw();this.zoomBox.draw();var t=this.map.fractionalZoom?{}:{cumulative:!1,interval:50,maxDelta:6};this.handlers.wheel=new OpenLayers.Handler.MouseWheel(this,{up:this.wheelUp,down:this.wheelDown},OpenLayers.Util.extend(t,this.mouseWheelOptions));OpenLayers.Control.PinchZoom&&(this.pinchZoom=new OpenLayers.Control.PinchZoom(OpenLayers.Util.extend({map:this.map},this.pinchZoomOptions)))},defaultClick:function(e){e.lastTouches&&2==e.lastTouches.length&&this.map.zoomOut()},defaultDblClick:function(e){this.map.zoomTo(this.map.zoom+1,e.xy)},defaultDblRightClick:function(e){this.map.zoomTo(this.map.zoom-1,e.xy)},wheelChange:function(e,t){this.map.fractionalZoom||(t=Math.round(t));var i=this.map.getZoom(),n=i+t;n=Math.max(n,0);(n=Math.min(n,this.map.getNumZoomLevels()))!==i&&this.map.zoomTo(n,e.xy)},wheelUp:function(e,t){this.wheelChange(e,t||1)},wheelDown:function(e,t){this.wheelChange(e,t||-1)},disableZoomBox:function(){this.zoomBoxEnabled=!1;this.zoomBox.deactivate()},enableZoomBox:function(){this.zoomBoxEnabled=!0;this.active&&this.zoomBox.activate()},disableZoomWheel:function(){this.zoomWheelEnabled=!1;this.handlers.wheel.deactivate()},enableZoomWheel:function(){this.zoomWheelEnabled=!0;this.active&&this.handlers.wheel.activate()},CLASS_NAME:"OpenLayers.Control.Navigation"});OpenLayers.Layer.WMS=OpenLayers.Class(OpenLayers.Layer.Grid,{DEFAULT_PARAMS:{service:"WMS",version:"1.1.1",request:"GetMap",styles:"",format:"image/jpeg"},isBaseLayer:!0,encodeBBOX:!1,noMagic:!1,yx:{},initialize:function(e,t,i,n){var r=[];i=OpenLayers.Util.upperCaseObject(i);parseFloat(i.VERSION)>=1.3&&!i.EXCEPTIONS&&(i.EXCEPTIONS="INIMAGE");r.push(e,t,i,n);OpenLayers.Layer.Grid.prototype.initialize.apply(this,r);OpenLayers.Util.applyDefaults(this.params,OpenLayers.Util.upperCaseObject(this.DEFAULT_PARAMS));if(!this.noMagic&&this.params.TRANSPARENT&&"true"==this.params.TRANSPARENT.toString().toLowerCase()){null!=n&&n.isBaseLayer||(this.isBaseLayer=!1);"image/jpeg"==this.params.FORMAT&&(this.params.FORMAT=OpenLayers.Util.alphaHack()?"image/gif":"image/png")}},clone:function(e){null==e&&(e=new OpenLayers.Layer.WMS(this.name,this.url,this.params,this.getOptions()));return e=OpenLayers.Layer.Grid.prototype.clone.apply(this,[e])},reverseAxisOrder:function(){var e=this.projection.getCode();return parseFloat(this.params.VERSION)>=1.3&&!!(this.yx[e]||OpenLayers.Projection.defaults[e]&&OpenLayers.Projection.defaults[e].yx)},getURL:function(e){e=this.adjustBounds(e);var t=this.getImageSize(),i={},n=this.reverseAxisOrder();i.BBOX=this.encodeBBOX?e.toBBOX(null,n):e.toArray(n);i.WIDTH=t.w;i.HEIGHT=t.h;return this.getFullRequestString(i)},mergeNewParams:function(e){var t=[OpenLayers.Util.upperCaseObject(e)];return OpenLayers.Layer.Grid.prototype.mergeNewParams.apply(this,t)},getFullRequestString:function(e,t){var i=this.map.getProjectionObject(),n=this.projection&&this.projection.equals(i)?this.projection.getCode():i.getCode(),r="none"==n?null:n;parseFloat(this.params.VERSION)>=1.3?this.params.CRS=r:this.params.SRS=r;"boolean"==typeof this.params.TRANSPARENT&&(e.TRANSPARENT=this.params.TRANSPARENT?"TRUE":"FALSE");return OpenLayers.Layer.Grid.prototype.getFullRequestString.apply(this,arguments)},CLASS_NAME:"OpenLayers.Layer.WMS"});OpenLayers.StyleMap=OpenLayers.Class({styles:null,extendDefault:!0,initialize:function(e,t){this.styles={default:new OpenLayers.Style(OpenLayers.Feature.Vector.style.default),select:new OpenLayers.Style(OpenLayers.Feature.Vector.style.select),temporary:new OpenLayers.Style(OpenLayers.Feature.Vector.style.temporary),delete:new OpenLayers.Style(OpenLayers.Feature.Vector.style.delete)};if(e instanceof OpenLayers.Style){this.styles.default=e;this.styles.select=e;this.styles.temporary=e;this.styles.delete=e}else if("object"==typeof e)for(var i in e)if(e[i]instanceof OpenLayers.Style)this.styles[i]=e[i];else{if("object"!=typeof e[i]){this.styles.default=new OpenLayers.Style(e);this.styles.select=new OpenLayers.Style(e);this.styles.temporary=new OpenLayers.Style(e);this.styles.delete=new OpenLayers.Style(e);break}this.styles[i]=new OpenLayers.Style(e[i])}OpenLayers.Util.extend(this,t)},destroy:function(){for(var e in this.styles)this.styles[e].destroy();this.styles=null},createSymbolizer:function(e,t){e||(e=new OpenLayers.Feature.Vector);this.styles[t]||(t="default");e.renderIntent=t;var i={};this.extendDefault&&"default"!=t&&(i=this.styles.default.createSymbolizer(e));return OpenLayers.Util.extend(i,this.styles[t].createSymbolizer(e))},addUniqueValueRules:function(e,t,i,n){var r=[];for(var s in i)r.push(new OpenLayers.Rule({symbolizer:i[s],context:n,filter:new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.EQUAL_TO,property:t,value:s})}));this.styles[e].addRules(r)},CLASS_NAME:"OpenLayers.StyleMap"});OpenLayers.Layer.Vector=OpenLayers.Class(OpenLayers.Layer,{isBaseLayer:!1,isFixed:!1,features:null,filter:null,selectedFeatures:null,unrenderedFeatures:null,reportError:!0,style:null,styleMap:null,strategies:null,protocol:null,renderers:["SVG","VML","Canvas"],renderer:null,rendererOptions:null,geometryType:null,drawn:!1,ratio:1,initialize:function(e,t){OpenLayers.Layer.prototype.initialize.apply(this,arguments);this.renderer&&this.renderer.supported()||this.assignRenderer();if(!this.renderer||!this.renderer.supported()){this.renderer=null;this.displayError()}this.styleMap||(this.styleMap=new OpenLayers.StyleMap);this.features=[];this.selectedFeatures=[];this.unrenderedFeatures={};if(this.strategies)for(var i=0,n=this.strategies.length;i<n;i++)this.strategies[i].setLayer(this)},destroy:function(){if(this.strategies){var e,t,i;for(t=0,i=this.strategies.length;t<i;t++)(e=this.strategies[t]).autoDestroy&&e.destroy();this.strategies=null}if(this.protocol){this.protocol.autoDestroy&&this.protocol.destroy();this.protocol=null}this.destroyFeatures();this.features=null;this.selectedFeatures=null;this.unrenderedFeatures=null;this.renderer&&this.renderer.destroy();this.renderer=null;this.geometryType=null;this.drawn=null;OpenLayers.Layer.prototype.destroy.apply(this,arguments)},clone:function(e){null==e&&(e=new OpenLayers.Layer.Vector(this.name,this.getOptions()));e=OpenLayers.Layer.prototype.clone.apply(this,[e]);for(var t=this.features,i=t.length,n=new Array(i),r=0;r<i;++r)n[r]=t[r].clone();e.features=n;return e},refresh:function(e){this.calculateInRange()&&this.visibility&&this.events.triggerEvent("refresh",e)},assignRenderer:function(){for(var e=0,t=this.renderers.length;e<t;e++){var i=this.renderers[e],n="function"==typeof i?i:OpenLayers.Renderer[i];if(n&&n.prototype.supported()){this.renderer=new n(this.div,this.rendererOptions);break}}},displayError:function(){this.reportError&&OpenLayers.Console.userError(OpenLayers.i18n("browserNotSupported",{renderers:this.renderers.join("\n")}))},setMap:function(e){OpenLayers.Layer.prototype.setMap.apply(this,arguments);if(this.renderer){this.renderer.map=this.map;var t=this.map.getSize();t.w=t.w*this.ratio;t.h=t.h*this.ratio;this.renderer.setSize(t)}else this.map.removeLayer(this)},afterAdd:function(){if(this.strategies){var e,t,i;for(t=0,i=this.strategies.length;t<i;t++)(e=this.strategies[t]).autoActivate&&e.activate()}},removeMap:function(e){this.drawn=!1;if(this.strategies){var t,i,n;for(i=0,n=this.strategies.length;i<n;i++)(t=this.strategies[i]).autoActivate&&t.deactivate()}},onMapResize:function(){OpenLayers.Layer.prototype.onMapResize.apply(this,arguments);var e=this.map.getSize();e.w=e.w*this.ratio;e.h=e.h*this.ratio;this.renderer.setSize(e)},moveTo:function(e,t,i){OpenLayers.Layer.prototype.moveTo.apply(this,arguments);var n=!0;if(!i){this.renderer.root.style.visibility="hidden";var r=this.map.getSize(),s=r.w,a=r.h,o=s/2*this.ratio-s/2,l=a/2*this.ratio-a/2;o+=this.map.layerContainerOriginPx.x;o=-Math.round(o);l+=this.map.layerContainerOriginPx.y;l=-Math.round(l);this.div.style.left=o+"px";this.div.style.top=l+"px";var c=this.map.getExtent().scale(this.ratio);n=this.renderer.setExtent(c,t);this.renderer.root.style.visibility="visible";!0===OpenLayers.IS_GECKO&&(this.div.scrollLeft=this.div.scrollLeft);if(!t&&n)for(var u in this.unrenderedFeatures){var h=this.unrenderedFeatures[u];this.drawFeature(h)}}if(!this.drawn||t||!n){this.drawn=!0;u=0;for(var p=this.features.length;u<p;u++){this.renderer.locked=u!==p-1;h=this.features[u];this.drawFeature(h)}}},display:function(e){OpenLayers.Layer.prototype.display.apply(this,arguments);var t=this.div.style.display;t!=this.renderer.root.style.display&&(this.renderer.root.style.display=t)},addFeatures:function(e,t){OpenLayers.Util.isArray(e)||(e=[e]);var i=!t||!t.silent;if(i){var n={features:e};if(!1===this.events.triggerEvent("beforefeaturesadded",n))return;e=n.features}for(var r=[],s=0,a=e.length;s<a;s++){s!=e.length-1?this.renderer.locked=!0:this.renderer.locked=!1;var o=e[s];if(this.geometryType&&!(o.geometry instanceof this.geometryType))throw new TypeError("addFeatures: component should be an "+this.geometryType.prototype.CLASS_NAME);o.layer=this;!o.style&&this.style&&(o.style=OpenLayers.Util.extend({},this.style));if(i){if(!1===this.events.triggerEvent("beforefeatureadded",{feature:o}))continue;this.preFeatureInsert(o)}r.push(o);this.features.push(o);this.drawFeature(o);if(i){this.events.triggerEvent("featureadded",{feature:o});this.onFeatureInsert(o)}}i&&this.events.triggerEvent("featuresadded",{features:r})},removeFeatures:function(e,t){if(e&&0!==e.length){if(e===this.features)return this.removeAllFeatures(t);OpenLayers.Util.isArray(e)||(e=[e]);e===this.selectedFeatures&&(e=e.slice());var i=!t||!t.silent;i&&this.events.triggerEvent("beforefeaturesremoved",{features:e});for(var n=e.length-1;n>=0;n--){0!=n&&e[n-1].geometry?this.renderer.locked=!0:this.renderer.locked=!1;var r=e[n];delete this.unrenderedFeatures[r.id];i&&this.events.triggerEvent("beforefeatureremoved",{feature:r});this.features=OpenLayers.Util.removeItem(this.features,r);r.layer=null;r.geometry&&this.renderer.eraseFeatures(r);-1!=OpenLayers.Util.indexOf(this.selectedFeatures,r)&&OpenLayers.Util.removeItem(this.selectedFeatures,r);i&&this.events.triggerEvent("featureremoved",{feature:r})}i&&this.events.triggerEvent("featuresremoved",{features:e})}},removeAllFeatures:function(e){var t,i=!e||!e.silent,n=this.features;i&&this.events.triggerEvent("beforefeaturesremoved",{features:n});for(var r=n.length-1;r>=0;r--){t=n[r];i&&this.events.triggerEvent("beforefeatureremoved",{feature:t});t.layer=null;i&&this.events.triggerEvent("featureremoved",{feature:t})}this.renderer.clear();this.features=[];this.unrenderedFeatures={};this.selectedFeatures=[];i&&this.events.triggerEvent("featuresremoved",{features:n})},destroyFeatures:function(e,t){void 0==e&&(e=this.features);if(e){this.removeFeatures(e,t);for(var i=e.length-1;i>=0;i--)e[i].destroy()}},drawFeature:function(e,t){if(this.drawn){if("object"!=typeof t){t||e.state!==OpenLayers.State.DELETE||(t="delete");var i=t||e.renderIntent;(t=e.style||this.style)||(t=this.styleMap.createSymbolizer(e,i))}var n=this.renderer.drawFeature(e,t);!1===n||null===n?this.unrenderedFeatures[e.id]=e:delete this.unrenderedFeatures[e.id]}},eraseFeatures:function(e){this.renderer.eraseFeatures(e)},getFeatureFromEvent:function(e){if(!this.renderer)throw new Error("getFeatureFromEvent called on layer with no renderer. This usually means you destroyed a layer, but not some handler which is associated with it.");var t=null,i=this.renderer.getFeatureIdFromEvent(e);i&&(t="string"==typeof i?this.getFeatureById(i):i);return t},getFeatureBy:function(e,t){for(var i=null,n=0,r=this.features.length;n<r;++n)if(this.features[n][e]==t){i=this.features[n];break}return i},getFeatureById:function(e){return this.getFeatureBy("id",e)},getFeatureByFid:function(e){return this.getFeatureBy("fid",e)},getFeaturesByAttribute:function(e,t){var i,n,r=this.features.length,s=[];for(i=0;i<r;i++)(n=this.features[i])&&n.attributes&&n.attributes[e]===t&&s.push(n);return s},onFeatureInsert:function(e){},preFeatureInsert:function(e){},getDataExtent:function(){var e=null,t=this.features;if(t&&t.length>0)for(var i=null,n=0,r=t.length;n<r;n++)if(i=t[n].geometry){null===e&&(e=new OpenLayers.Bounds);e.extend(i.getBounds())}return e},CLASS_NAME:"OpenLayers.Layer.Vector"});OpenLayers.Renderer.SVG=OpenLayers.Class(OpenLayers.Renderer.Elements,{xmlns:"http://www.w3.org/2000/svg",xlinkns:"http://www.w3.org/1999/xlink",MAX_PIXEL:15e3,translationParameters:null,symbolMetrics:null,initialize:function(e){if(this.supported()){OpenLayers.Renderer.Elements.prototype.initialize.apply(this,arguments);this.translationParameters={x:0,y:0};this.symbolMetrics={}}},supported:function(){var e="http://www.w3.org/TR/SVG11/feature#";return document.implementation&&(document.implementation.hasFeature("org.w3c.svg","1.0")||document.implementation.hasFeature(e+"SVG","1.1")||document.implementation.hasFeature(e+"BasicStructure","1.1"))},inValidRange:function(e,t,i){var n=e+(i?0:this.translationParameters.x),r=t+(i?0:this.translationParameters.y);return n>=-this.MAX_PIXEL&&n<=this.MAX_PIXEL&&r>=-this.MAX_PIXEL&&r<=this.MAX_PIXEL},setExtent:function(e,t){var i=OpenLayers.Renderer.Elements.prototype.setExtent.apply(this,arguments),n=this.getResolution(),r=-e.left/n,s=e.top/n;if(t){this.left=r;this.top=s;var a="0 0 "+this.size.w+" "+this.size.h;this.rendererRoot.setAttributeNS(null,"viewBox",a);this.translate(this.xOffset,0);return!0}var o=this.translate(r-this.left+this.xOffset,s-this.top);o||this.setExtent(e,!0);return i&&o},translate:function(e,t){if(this.inValidRange(e,t,!0)){var i="";(e||t)&&(i="translate("+e+","+t+")");this.root.setAttributeNS(null,"transform",i);this.translationParameters={x:e,y:t};return!0}return!1},setSize:function(e){OpenLayers.Renderer.prototype.setSize.apply(this,arguments);this.rendererRoot.setAttributeNS(null,"width",this.size.w);this.rendererRoot.setAttributeNS(null,"height",this.size.h)},getNodeType:function(e,t){var i=null;switch(e.CLASS_NAME){case"OpenLayers.Geometry.Point":i=t.externalGraphic?"image":this.isComplexSymbol(t.graphicName)?"svg":"circle";break;case"OpenLayers.Geometry.Rectangle":i="rect";break;case"OpenLayers.Geometry.LineString":i="polyline";break;case"OpenLayers.Geometry.LinearRing":i="polygon";break;case"OpenLayers.Geometry.Polygon":case"OpenLayers.Geometry.Curve":i="path"}return i},setStyle:function(e,t,i){t=t||e._style;i=i||e._options;var n=t.title||t.graphicTitle;if(n){e.setAttributeNS(null,"title",n);var r=e.getElementsByTagName("title");if(r.length>0)r[0].firstChild.textContent=n;else{var s=this.nodeFactory(null,"title");s.textContent=n;e.appendChild(s)}}var a,o=parseFloat(e.getAttributeNS(null,"r")),l=1;if("OpenLayers.Geometry.Point"==e._geometryClass&&o){e.style.visibility="";if(!1===t.graphic)e.style.visibility="hidden";else if(t.externalGraphic){a=this.getPosition(e);t.graphicWidth&&t.graphicHeight&&e.setAttributeNS(null,"preserveAspectRatio","none");var c=t.graphicWidth||t.graphicHeight,u=t.graphicHeight||t.graphicWidth;c=c||2*t.pointRadius;u=u||2*t.pointRadius;var h=void 0!=t.graphicXOffset?t.graphicXOffset:-.5*c,p=void 0!=t.graphicYOffset?t.graphicYOffset:-.5*u,d=t.graphicOpacity||t.fillOpacity;e.setAttributeNS(null,"x",(a.x+h).toFixed());e.setAttributeNS(null,"y",(a.y+p).toFixed());e.setAttributeNS(null,"width",c);e.setAttributeNS(null,"height",u);e.setAttributeNS(this.xlinkns,"xlink:href",t.externalGraphic);e.setAttributeNS(null,"style","opacity: "+d);e.onclick=OpenLayers.Event.preventDefault}else if(this.isComplexSymbol(t.graphicName)){var f=3*t.pointRadius,m=2*f,y=this.importSymbol(t.graphicName);a=this.getPosition(e);l=3*this.symbolMetrics[y.id][0]/m;var g=e.parentNode,C=e.nextSibling;g&&g.removeChild(e);e.firstChild&&e.removeChild(e.firstChild);e.appendChild(y.firstChild.cloneNode(!0));e.setAttributeNS(null,"viewBox",y.getAttributeNS(null,"viewBox"));e.setAttributeNS(null,"width",m);e.setAttributeNS(null,"height",m);e.setAttributeNS(null,"x",a.x-f);e.setAttributeNS(null,"y",a.y-f);C?g.insertBefore(e,C):g&&g.appendChild(e)}else e.setAttributeNS(null,"r",t.pointRadius);var v=t.rotation;if((void 0!==v||void 0!==e._rotation)&&a){e._rotation=v;v|=0;if("svg"!==e.nodeName)e.setAttributeNS(null,"transform","rotate("+v+" "+a.x+" "+a.y+")");else{var T=this.symbolMetrics[y.id];e.firstChild.setAttributeNS(null,"transform","rotate("+v+" "+T[1]+" "+T[2]+")")}}}if(i.isFilled){e.setAttributeNS(null,"fill",t.fillColor);e.setAttributeNS(null,"fill-opacity",t.fillOpacity)}else e.setAttributeNS(null,"fill","none");if(i.isStroked){e.setAttributeNS(null,"stroke",t.strokeColor);e.setAttributeNS(null,"stroke-opacity",t.strokeOpacity);e.setAttributeNS(null,"stroke-width",t.strokeWidth*l);e.setAttributeNS(null,"stroke-linecap",t.strokeLinecap||"round");e.setAttributeNS(null,"stroke-linejoin","round");t.strokeDashstyle&&e.setAttributeNS(null,"stroke-dasharray",this.dashStyle(t,l))}else e.setAttributeNS(null,"stroke","none");t.pointerEvents&&e.setAttributeNS(null,"pointer-events",t.pointerEvents);null!=t.cursor&&e.setAttributeNS(null,"cursor",t.cursor);return e},dashStyle:function(e,t){var i=e.strokeWidth*t,n=e.strokeDashstyle;switch(n){case"solid":return"none";case"dot":return[1,4*i].join();case"dash":return[4*i,4*i].join();case"dashdot":return[4*i,4*i,1,4*i].join();case"longdash":return[8*i,4*i].join();case"longdashdot":return[8*i,4*i,1,4*i].join();default:return OpenLayers.String.trim(n).replace(/\s+/g,",")}},createNode:function(e,t){var i=document.createElementNS(this.xmlns,e);t&&i.setAttributeNS(null,"id",t);return i},nodeTypeCompare:function(e,t){return t==e.nodeName},createRenderRoot:function(){var e=this.nodeFactory(this.container.id+"_svgRoot","svg");e.style.display="block";return e},createRoot:function(e){return this.nodeFactory(this.container.id+e,"g")},createDefs:function(){var e=this.nodeFactory(this.container.id+"_defs","defs");this.rendererRoot.appendChild(e);return e},drawPoint:function(e,t){return this.drawCircle(e,t,1)},drawCircle:function(e,t,i){var n=this.getResolution(),r=(t.x-this.featureDx)/n+this.left,s=this.top-t.y/n;if(this.inValidRange(r,s)){e.setAttributeNS(null,"cx",r);e.setAttributeNS(null,"cy",s);e.setAttributeNS(null,"r",i);return e}return!1},drawLineString:function(e,t){var i=this.getComponentsString(t.components);if(i.path){e.setAttributeNS(null,"points",i.path);return i.complete?e:null}return!1},drawLinearRing:function(e,t){var i=this.getComponentsString(t.components);if(i.path){e.setAttributeNS(null,"points",i.path);return i.complete?e:null}return!1},drawPolygon:function(e,t){for(var i,n,r="",s=!0,a=!0,o=0,l=t.components.length;o<l;o++){r+=" M";if(n=(i=this.getComponentsString(t.components[o].components," ")).path){r+=" "+n;a=i.complete&&a}else s=!1}r+=" z";if(s){e.setAttributeNS(null,"d",r);e.setAttributeNS(null,"fill-rule","evenodd");return a?e:null}return!1},drawRectangle:function(e,t){var i=this.getResolution(),n=(t.x-this.featureDx)/i+this.left,r=this.top-t.y/i;if(this.inValidRange(n,r)){e.setAttributeNS(null,"x",n);e.setAttributeNS(null,"y",r);e.setAttributeNS(null,"width",t.width/i);e.setAttributeNS(null,"height",t.height/i);return e}return!1},drawText:function(e,t,i){var n=!!t.labelOutlineWidth;if(n){var r=OpenLayers.Util.extend({},t);r.fontColor=r.labelOutlineColor;r.fontStrokeColor=r.labelOutlineColor;r.fontStrokeWidth=t.labelOutlineWidth;t.labelOutlineOpacity&&(r.fontOpacity=t.labelOutlineOpacity);delete r.labelOutlineWidth;this.drawText(e,r,i)}var s=this.getResolution(),a=(i.x-this.featureDx)/s+this.left,o=i.y/s-this.top,l=n?this.LABEL_OUTLINE_SUFFIX:this.LABEL_ID_SUFFIX,c=this.nodeFactory(e+l,"text");c.setAttributeNS(null,"x",a);c.setAttributeNS(null,"y",-o);t.fontColor&&c.setAttributeNS(null,"fill",t.fontColor);t.fontStrokeColor&&c.setAttributeNS(null,"stroke",t.fontStrokeColor);t.fontStrokeWidth&&c.setAttributeNS(null,"stroke-width",t.fontStrokeWidth);t.fontOpacity&&c.setAttributeNS(null,"opacity",t.fontOpacity);t.fontFamily&&c.setAttributeNS(null,"font-family",t.fontFamily);t.fontSize&&c.setAttributeNS(null,"font-size",t.fontSize);t.fontWeight&&c.setAttributeNS(null,"font-weight",t.fontWeight);t.fontStyle&&c.setAttributeNS(null,"font-style",t.fontStyle);if(!0===t.labelSelect){c.setAttributeNS(null,"pointer-events","visible");c._featureId=e}else c.setAttributeNS(null,"pointer-events","none");var u=t.labelAlign||OpenLayers.Renderer.defaultSymbolizer.labelAlign;c.setAttributeNS(null,"text-anchor",OpenLayers.Renderer.SVG.LABEL_ALIGN[u[0]]||"middle");!0===OpenLayers.IS_GECKO&&c.setAttributeNS(null,"dominant-baseline",OpenLayers.Renderer.SVG.LABEL_ALIGN[u[1]]||"central");for(var h=t.label.split("\n"),p=h.length;c.childNodes.length>p;)c.removeChild(c.lastChild);for(var d=0;d<p;d++){var f=this.nodeFactory(e+l+"_tspan_"+d,"tspan");if(!0===t.labelSelect){f._featureId=e;f._geometry=i;f._geometryClass=i.CLASS_NAME}!1===OpenLayers.IS_GECKO&&f.setAttributeNS(null,"baseline-shift",OpenLayers.Renderer.SVG.LABEL_VSHIFT[u[1]]||"-35%");f.setAttribute("x",a);if(0==d){var m=OpenLayers.Renderer.SVG.LABEL_VFACTOR[u[1]];null==m&&(m=-.5);f.setAttribute("dy",m*(p-1)+"em")}else f.setAttribute("dy","1em");f.textContent=""===h[d]?" ":h[d];f.parentNode||c.appendChild(f)}c.parentNode||this.textRoot.appendChild(c)},getComponentsString:function(e,t){for(var i,n,r=[],s=!0,a=e.length,o=[],l=0;l<a;l++){n=e[l];r.push(n);if(i=this.getShortString(n))o.push(i);else{l>0&&this.getShortString(e[l-1])&&o.push(this.clipLine(e[l],e[l-1]));l<a-1&&this.getShortString(e[l+1])&&o.push(this.clipLine(e[l],e[l+1]));s=!1}}return{path:o.join(t||","),complete:s}},clipLine:function(e,t){if(t.equals(e))return"";var i,n=this.getResolution(),r=this.MAX_PIXEL-this.translationParameters.x,s=this.MAX_PIXEL-this.translationParameters.y,a=(t.x-this.featureDx)/n+this.left,o=this.top-t.y/n,l=(e.x-this.featureDx)/n+this.left,c=this.top-e.y/n;if(l<-r||l>r){i=(c-o)/(l-a);c=o+((l=l<0?-r:r)-a)*i}if(c<-s||c>s){i=(l-a)/(c-o);l=a+((c=c<0?-s:s)-o)*i}return l+","+c},getShortString:function(e){var t=this.getResolution(),i=(e.x-this.featureDx)/t+this.left,n=this.top-e.y/t;return!!this.inValidRange(i,n)&&i+","+n},getPosition:function(e){return{x:parseFloat(e.getAttributeNS(null,"cx")),y:parseFloat(e.getAttributeNS(null,"cy"))}},importSymbol:function(e){this.defs||(this.defs=this.createDefs());var t=this.container.id+"-"+e,i=document.getElementById(t);if(null!=i)return i;var n=OpenLayers.Renderer.symbol[e];if(!n)throw new Error(e+" is not a valid symbol name");var r=this.nodeFactory(t,"symbol"),s=this.nodeFactory(null,"polygon");r.appendChild(s);for(var a,o,l=new OpenLayers.Bounds(Number.MAX_VALUE,Number.MAX_VALUE,0,0),c=[],u=0;u<n.length;u+=2){a=n[u];o=n[u+1];l.left=Math.min(l.left,a);l.bottom=Math.min(l.bottom,o);l.right=Math.max(l.right,a);l.top=Math.max(l.top,o);c.push(a,",",o)}s.setAttributeNS(null,"points",c.join(" "));var h=l.getWidth(),p=l.getHeight(),d=[l.left-h,l.bottom-p,3*h,3*p];r.setAttributeNS(null,"viewBox",d.join(" "));this.symbolMetrics[t]=[Math.max(h,p),l.getCenterLonLat().lon,l.getCenterLonLat().lat];this.defs.appendChild(r);return r},getFeatureIdFromEvent:function(e){var t=OpenLayers.Renderer.Elements.prototype.getFeatureIdFromEvent.apply(this,arguments);if(!t){var i=e.target;t=i.parentNode&&i!=this.rendererRoot?i.parentNode._featureId:void 0}return t},CLASS_NAME:"OpenLayers.Renderer.SVG"});OpenLayers.Renderer.SVG.LABEL_ALIGN={l:"start",r:"end",b:"bottom",t:"hanging"};OpenLayers.Renderer.SVG.LABEL_VSHIFT={t:"-70%",b:"0"};OpenLayers.Renderer.SVG.LABEL_VFACTOR={t:0,b:-1};OpenLayers.Renderer.SVG.preventDefault=function(e){OpenLayers.Event.preventDefault(e)};OpenLayers.Control.ScaleLine=OpenLayers.Class(OpenLayers.Control,{maxWidth:100,topOutUnits:"km",topInUnits:"m",bottomOutUnits:"mi",bottomInUnits:"ft",eTop:null,eBottom:null,geodesic:!1,draw:function(){OpenLayers.Control.prototype.draw.apply(this,arguments);if(!this.eTop){this.eTop=document.createElement("div");this.eTop.className=this.displayClass+"Top";this.topInUnits.length;this.div.appendChild(this.eTop);""==this.topOutUnits||""==this.topInUnits?this.eTop.style.visibility="hidden":this.eTop.style.visibility="visible";this.eBottom=document.createElement("div");this.eBottom.className=this.displayClass+"Bottom";this.div.appendChild(this.eBottom);""==this.bottomOutUnits||""==this.bottomInUnits?this.eBottom.style.visibility="hidden":this.eBottom.style.visibility="visible"}this.map.events.register("moveend",this,this.update);this.update();return this.div},getBarLen:function(e){var t=parseInt(Math.log(e)/Math.log(10)),i=Math.pow(10,t),n=parseInt(e/i);return(n>5?5:n>2?2:1)*i},update:function(){var e=this.map.getResolution();if(e){var t,i,n=this.map.getUnits(),r=OpenLayers.INCHES_PER_UNIT,s=this.maxWidth*e*r[n],a=1;if(!0===this.geodesic){s*=a=(this.map.getGeodesicPixelSize().w||1e-6)*this.maxWidth/(s/r.km)}if(s>1e5){t=this.topOutUnits;i=this.bottomOutUnits}else{t=this.topInUnits;i=this.bottomInUnits}var o=s/r[t],l=s/r[i],c=this.getBarLen(o),u=this.getBarLen(l),h=(o=c/r[n]*r[t])/e/a,p=(l=u/r[n]*r[i])/e/a;if("visible"==this.eBottom.style.visibility){this.eBottom.style.width=Math.round(p)+"px";this.eBottom.innerHTML=u+" "+i}if("visible"==this.eTop.style.visibility){this.eTop.style.width=Math.round(h)+"px";this.eTop.innerHTML=c+" "+t}}},CLASS_NAME:"OpenLayers.Control.ScaleLine"});OpenLayers.Icon=OpenLayers.Class({url:null,size:null,offset:null,calculateOffset:null,imageDiv:null,px:null,initialize:function(e,t,i,n){this.url=e;this.size=t||{w:20,h:20};this.offset=i||{x:-this.size.w/2,y:-this.size.h/2};this.calculateOffset=n;var r=OpenLayers.Util.createUniqueID("OL_Icon_");this.imageDiv=OpenLayers.Util.createAlphaImageDiv(r)},destroy:function(){this.erase();OpenLayers.Event.stopObservingElement(this.imageDiv.firstChild);this.imageDiv.innerHTML="";this.imageDiv=null},clone:function(){return new OpenLayers.Icon(this.url,this.size,this.offset,this.calculateOffset)},setSize:function(e){null!=e&&(this.size=e);this.draw()},setUrl:function(e){null!=e&&(this.url=e);this.draw()},draw:function(e){OpenLayers.Util.modifyAlphaImageDiv(this.imageDiv,null,null,this.size,this.url,"absolute");this.moveTo(e);return this.imageDiv},erase:function(){null!=this.imageDiv&&null!=this.imageDiv.parentNode&&OpenLayers.Element.remove(this.imageDiv)},setOpacity:function(e){OpenLayers.Util.modifyAlphaImageDiv(this.imageDiv,null,null,null,null,null,null,null,e)},moveTo:function(e){null!=e&&(this.px=e);if(null!=this.imageDiv)if(null==this.px)this.display(!1);else{this.calculateOffset&&(this.offset=this.calculateOffset(this.size));OpenLayers.Util.modifyAlphaImageDiv(this.imageDiv,null,{x:this.px.x+this.offset.x,y:this.px.y+this.offset.y})}},display:function(e){this.imageDiv.style.display=e?"":"none"},isDrawn:function(){return this.imageDiv&&this.imageDiv.parentNode&&11!=this.imageDiv.parentNode.nodeType},CLASS_NAME:"OpenLayers.Icon"});OpenLayers.Marker=OpenLayers.Class({icon:null,lonlat:null,events:null,map:null,initialize:function(e,t){this.lonlat=e;var i=t||OpenLayers.Marker.defaultIcon();if(null==this.icon)this.icon=i;else{this.icon.url=i.url;this.icon.size=i.size;this.icon.offset=i.offset;this.icon.calculateOffset=i.calculateOffset}this.events=new OpenLayers.Events(this,this.icon.imageDiv)},destroy:function(){this.erase();this.map=null;this.events.destroy();this.events=null;if(null!=this.icon){this.icon.destroy();this.icon=null}},draw:function(e){return this.icon.draw(e)},erase:function(){null!=this.icon&&this.icon.erase()},moveTo:function(e){null!=e&&null!=this.icon&&this.icon.moveTo(e);this.lonlat=this.map.getLonLatFromLayerPx(e)},isDrawn:function(){return this.icon&&this.icon.isDrawn()},onScreen:function(){var e=!1;if(this.map){e=this.map.getExtent().containsLonLat(this.lonlat)}return e},inflate:function(e){this.icon&&this.icon.setSize({w:this.icon.size.w*e,h:this.icon.size.h*e})},setOpacity:function(e){this.icon.setOpacity(e)},setUrl:function(e){this.icon.setUrl(e)},display:function(e){this.icon.display(e)},CLASS_NAME:"OpenLayers.Marker"});OpenLayers.Marker.defaultIcon=function(){return new OpenLayers.Icon(OpenLayers.Util.getImageLocation("marker.png"),{w:21,h:25},{x:-10.5,y:-25})};OpenLayers.Format.JSON=OpenLayers.Class(OpenLayers.Format,{indent:"    ",space:" ",newline:"\n",level:0,pretty:!1,nativeJSON:!(!window.JSON||"function"!=typeof JSON.parse||"function"!=typeof JSON.stringify),read:function(json,filter){var object;if(this.nativeJSON)object=JSON.parse(json,filter);else try{if(/^[\],:{}\s]*$/.test(json.replace(/\\["\\\/bfnrtu]/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){object=eval("("+json+")");if("function"==typeof filter){function walk(e,t){if(t&&"object"==typeof t)for(var i in t)t.hasOwnProperty(i)&&(t[i]=walk(i,t[i]));return filter(e,t)}object=walk("",object)}}}catch(e){}this.keepData&&(this.data=object);return object},write:function(e,t){this.pretty=!!t;var i=null,n=typeof e;if(this.serialize[n])try{i=!this.pretty&&this.nativeJSON?JSON.stringify(e):this.serialize[n].apply(this,[e])}catch(e){OpenLayers.Console.error("Trouble serializing: "+e)}return i},writeIndent:function(){var e=[];if(this.pretty)for(var t=0;t<this.level;++t)e.push(this.indent);return e.join("")},writeNewline:function(){return this.pretty?this.newline:""},writeSpace:function(){return this.pretty?this.space:""},serialize:{object:function(e){if(null==e)return"null";if(e.constructor==Date)return this.serialize.date.apply(this,[e]);if(e.constructor==Array)return this.serialize.array.apply(this,[e]);var t,i,n,r=["{"];this.level+=1;var s=!1;for(t in e)if(e.hasOwnProperty(t)){i=OpenLayers.Format.JSON.prototype.write.apply(this,[t,this.pretty]);n=OpenLayers.Format.JSON.prototype.write.apply(this,[e[t],this.pretty]);if(null!=i&&null!=n){s&&r.push(",");r.push(this.writeNewline(),this.writeIndent(),i,":",this.writeSpace(),n);s=!0}}this.level-=1;r.push(this.writeNewline(),this.writeIndent(),"}");return r.join("")},array:function(e){var t,i=["["];this.level+=1;for(var n=0,r=e.length;n<r;++n)if(null!=(t=OpenLayers.Format.JSON.prototype.write.apply(this,[e[n],this.pretty]))){n>0&&i.push(",");i.push(this.writeNewline(),this.writeIndent(),t)}this.level-=1;i.push(this.writeNewline(),this.writeIndent(),"]");return i.join("")},string:function(e){var t={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};return/["\\\x00-\x1f]/.test(e)?'"'+e.replace(/([\x00-\x1f\\"])/g,function(e,i){var n=t[i];if(n)return n;n=i.charCodeAt();return"\\u00"+Math.floor(n/16).toString(16)+(n%16).toString(16)})+'"':'"'+e+'"'},number:function(e){return isFinite(e)?String(e):"null"},boolean:function(e){return String(e)},date:function(e){function t(e){return e<10?"0"+e:e}return'"'+e.getFullYear()+"-"+t(e.getMonth()+1)+"-"+t(e.getDate())+"T"+t(e.getHours())+":"+t(e.getMinutes())+":"+t(e.getSeconds())+'"'}},CLASS_NAME:"OpenLayers.Format.JSON"});OpenLayers.Format.GeoJSON=OpenLayers.Class(OpenLayers.Format.JSON,{ignoreExtraDims:!1,read:function(e,t,i){t=t||"FeatureCollection";var n=null,r=null;if(r="string"==typeof e?OpenLayers.Format.JSON.prototype.read.apply(this,[e,i]):e){if("string"!=typeof r.type)OpenLayers.Console.error("Bad GeoJSON - no type: "+e);else if(this.isValidType(r,t))switch(t){case"Geometry":try{n=this.parseGeometry(r)}catch(e){OpenLayers.Console.error(e)}break;case"Feature":try{(n=this.parseFeature(r)).type="Feature"}catch(e){OpenLayers.Console.error(e)}break;case"FeatureCollection":n=[];switch(r.type){case"Feature":try{n.push(this.parseFeature(r))}catch(e){n=null;OpenLayers.Console.error(e)}break;case"FeatureCollection":for(var s=0,a=r.features.length;s<a;++s)try{n.push(this.parseFeature(r.features[s]))}catch(e){n=null;OpenLayers.Console.error(e)}break;default:try{var o=this.parseGeometry(r);n.push(new OpenLayers.Feature.Vector(o))}catch(e){n=null;OpenLayers.Console.error(e)}}}}else OpenLayers.Console.error("Bad JSON: "+e);return n},isValidType:function(e,t){var i=!1;switch(t){case"Geometry":-1==OpenLayers.Util.indexOf(["Point","MultiPoint","LineString","MultiLineString","Polygon","MultiPolygon","Box","GeometryCollection"],e.type)?OpenLayers.Console.error("Unsupported geometry type: "+e.type):i=!0;break;case"FeatureCollection":i=!0;break;default:e.type==t?i=!0:OpenLayers.Console.error("Cannot convert types from "+e.type+" to "+t)}return i},parseFeature:function(e){var t,i,n,r;n=e.properties?e.properties:{};r=e.geometry&&e.geometry.bbox||e.bbox;try{i=this.parseGeometry(e.geometry)}catch(e){throw e}t=new OpenLayers.Feature.Vector(i,n);r&&(t.bounds=OpenLayers.Bounds.fromArray(r));e.id&&(t.fid=e.id);return t},parseGeometry:function(e){if(null==e)return null;var t,i=!1;if("GeometryCollection"==e.type){if(!OpenLayers.Util.isArray(e.geometries))throw"GeometryCollection must have geometries array: "+e;for(var n=e.geometries.length,r=new Array(n),s=0;s<n;++s)r[s]=this.parseGeometry.apply(this,[e.geometries[s]]);t=new OpenLayers.Geometry.Collection(r);i=!0}else{if(!OpenLayers.Util.isArray(e.coordinates))throw"Geometry must have coordinates array: "+e;if(!this.parseCoords[e.type.toLowerCase()])throw"Unsupported geometry type: "+e.type;try{t=this.parseCoords[e.type.toLowerCase()].apply(this,[e.coordinates])}catch(e){throw e}}this.internalProjection&&this.externalProjection&&!i&&t.transform(this.externalProjection,this.internalProjection);return t},parseCoords:{point:function(e){if(0==this.ignoreExtraDims&&2!=e.length)throw"Only 2D points are supported: "+e;return new OpenLayers.Geometry.Point(e[0],e[1])},multipoint:function(e){for(var t=[],i=null,n=0,r=e.length;n<r;++n){try{i=this.parseCoords.point.apply(this,[e[n]])}catch(e){throw e}t.push(i)}return new OpenLayers.Geometry.MultiPoint(t)},linestring:function(e){for(var t=[],i=null,n=0,r=e.length;n<r;++n){try{i=this.parseCoords.point.apply(this,[e[n]])}catch(e){throw e}t.push(i)}return new OpenLayers.Geometry.LineString(t)},multilinestring:function(e){for(var t=[],i=null,n=0,r=e.length;n<r;++n){try{i=this.parseCoords.linestring.apply(this,[e[n]])}catch(e){throw e}t.push(i)}return new OpenLayers.Geometry.MultiLineString(t)},polygon:function(e){for(var t,i,n=[],r=0,s=e.length;r<s;++r){try{i=this.parseCoords.linestring.apply(this,[e[r]])}catch(e){throw e}t=new OpenLayers.Geometry.LinearRing(i.components);n.push(t)}return new OpenLayers.Geometry.Polygon(n)},multipolygon:function(e){for(var t=[],i=null,n=0,r=e.length;n<r;++n){try{i=this.parseCoords.polygon.apply(this,[e[n]])}catch(e){throw e}t.push(i)}return new OpenLayers.Geometry.MultiPolygon(t)},box:function(e){if(2!=e.length)throw"GeoJSON box coordinates must have 2 elements";return new OpenLayers.Geometry.Polygon([new OpenLayers.Geometry.LinearRing([new OpenLayers.Geometry.Point(e[0][0],e[0][1]),new OpenLayers.Geometry.Point(e[1][0],e[0][1]),new OpenLayers.Geometry.Point(e[1][0],e[1][1]),new OpenLayers.Geometry.Point(e[0][0],e[1][1]),new OpenLayers.Geometry.Point(e[0][0],e[0][1])])])}},write:function(e,t){var i={type:null};if(OpenLayers.Util.isArray(e)){i.type="FeatureCollection";var n=e.length;i.features=new Array(n);for(var r=0;r<n;++r){var s=e[r];if(!s instanceof OpenLayers.Feature.Vector){throw"FeatureCollection only supports collections of features: "+s}i.features[r]=this.extract.feature.apply(this,[s])}}else if(0==e.CLASS_NAME.indexOf("OpenLayers.Geometry"))i=this.extract.geometry.apply(this,[e]);else if(e instanceof OpenLayers.Feature.Vector){i=this.extract.feature.apply(this,[e]);e.layer&&e.layer.projection&&(i.crs=this.createCRSObject(e))}return OpenLayers.Format.JSON.prototype.write.apply(this,[i,t])},createCRSObject:function(e){var t=e.layer.projection.toString(),i={};if(t.match(/epsg:/i)){var n=parseInt(t.substring(t.indexOf(":")+1));i=4326==n?{type:"name",properties:{name:"urn:ogc:def:crs:OGC:1.3:CRS84"}}:{type:"name",properties:{name:"EPSG:"+n}}}return i},extract:{feature:function(e){var t=this.extract.geometry.apply(this,[e.geometry]),i={type:"Feature",properties:e.attributes,geometry:t};null!=e.fid&&(i.id=e.fid);return i},geometry:function(e){if(null==e)return null;this.internalProjection&&this.externalProjection&&(e=e.clone()).transform(this.internalProjection,this.externalProjection);var t=e.CLASS_NAME.split(".")[2],i=this.extract[t.toLowerCase()].apply(this,[e]);return"Collection"==t?{type:"GeometryCollection",geometries:i}:{type:t,coordinates:i}},point:function(e){return[e.x,e.y]},multipoint:function(e){for(var t=[],i=0,n=e.components.length;i<n;++i)t.push(this.extract.point.apply(this,[e.components[i]]));return t},linestring:function(e){for(var t=[],i=0,n=e.components.length;i<n;++i)t.push(this.extract.point.apply(this,[e.components[i]]));return t},multilinestring:function(e){for(var t=[],i=0,n=e.components.length;i<n;++i)t.push(this.extract.linestring.apply(this,[e.components[i]]));return t},polygon:function(e){for(var t=[],i=0,n=e.components.length;i<n;++i)t.push(this.extract.linestring.apply(this,[e.components[i]]));return t},multipolygon:function(e){for(var t=[],i=0,n=e.components.length;i<n;++i)t.push(this.extract.polygon.apply(this,[e.components[i]]));return t},collection:function(e){for(var t=e.components.length,i=new Array(t),n=0;n<t;++n)i[n]=this.extract.geometry.apply(this,[e.components[n]]);return i}},CLASS_NAME:"OpenLayers.Format.GeoJSON"});OpenLayers.Popup=OpenLayers.Class({events:null,id:"",lonlat:null,div:null,contentSize:null,size:null,contentHTML:null,backgroundColor:"",opacity:"",border:"",contentDiv:null,groupDiv:null,closeDiv:null,autoSize:!1,minSize:null,maxSize:null,displayClass:"olPopup",contentDisplayClass:"olPopupContent",padding:0,disableFirefoxOverflowHack:!1,fixPadding:function(){"number"==typeof this.padding&&(this.padding=new OpenLayers.Bounds(this.padding,this.padding,this.padding,this.padding))},panMapIfOutOfView:!1,keepInMap:!1,closeOnMove:!1,map:null,initialize:function(e,t,i,n,r,s){null==e&&(e=OpenLayers.Util.createUniqueID(this.CLASS_NAME+"_"));this.id=e;this.lonlat=t;this.contentSize=null!=i?i:new OpenLayers.Size(OpenLayers.Popup.WIDTH,OpenLayers.Popup.HEIGHT);null!=n&&(this.contentHTML=n);this.backgroundColor=OpenLayers.Popup.COLOR;this.opacity=OpenLayers.Popup.OPACITY;this.border=OpenLayers.Popup.BORDER;this.div=OpenLayers.Util.createDiv(this.id,null,null,null,null,null,"hidden");this.div.className=this.displayClass;var a=this.id+"_GroupDiv";this.groupDiv=OpenLayers.Util.createDiv(a,null,null,null,"relative",null,"hidden");e=this.div.id+"_contentDiv";this.contentDiv=OpenLayers.Util.createDiv(e,null,this.contentSize.clone(),null,"relative");this.contentDiv.className=this.contentDisplayClass;this.groupDiv.appendChild(this.contentDiv);this.div.appendChild(this.groupDiv);r&&this.addCloseBox(s);this.registerEvents()},destroy:function(){this.id=null;this.lonlat=null;this.size=null;this.contentHTML=null;this.backgroundColor=null;this.opacity=null;this.border=null;this.closeOnMove&&this.map&&this.map.events.unregister("movestart",this,this.hide);this.events.destroy();this.events=null;if(this.closeDiv){OpenLayers.Event.stopObservingElement(this.closeDiv);this.groupDiv.removeChild(this.closeDiv)}this.closeDiv=null;this.div.removeChild(this.groupDiv);this.groupDiv=null;null!=this.map&&this.map.removePopup(this);this.map=null;this.div=null;this.autoSize=null;this.minSize=null;this.maxSize=null;this.padding=null;this.panMapIfOutOfView=null},draw:function(e){null==e&&null!=this.lonlat&&null!=this.map&&(e=this.map.getLayerPxFromLonLat(this.lonlat));this.closeOnMove&&this.map.events.register("movestart",this,this.hide);if(!this.disableFirefoxOverflowHack&&"firefox"==OpenLayers.BROWSER_NAME){this.map.events.register("movestart",this,function(){var e=document.defaultView.getComputedStyle(this.contentDiv,null).getPropertyValue("overflow");if("hidden"!=e){this.contentDiv._oldOverflow=e;this.contentDiv.style.overflow="hidden"}});this.map.events.register("moveend",this,function(){var e=this.contentDiv._oldOverflow;if(e){this.contentDiv.style.overflow=e;this.contentDiv._oldOverflow=null}})}this.moveTo(e);this.autoSize||this.size||this.setSize(this.contentSize);this.setBackgroundColor();this.setOpacity();this.setBorder();this.setContentHTML();this.panMapIfOutOfView&&this.panIntoView();return this.div},updatePosition:function(){if(this.lonlat&&this.map){var e=this.map.getLayerPxFromLonLat(this.lonlat);e&&this.moveTo(e)}},moveTo:function(e){if(null!=e&&null!=this.div){this.div.style.left=e.x+"px";this.div.style.top=e.y+"px"}},visible:function(){return OpenLayers.Element.visible(this.div)},toggle:function(){this.visible()?this.hide():this.show()},show:function(){this.div.style.display="";this.panMapIfOutOfView&&this.panIntoView()},hide:function(){this.div.style.display="none"},setSize:function(e){this.size=e.clone();var t=this.getContentDivPadding(),i=t.left+t.right,n=t.top+t.bottom;this.fixPadding();i+=this.padding.left+this.padding.right;n+=this.padding.top+this.padding.bottom;if(this.closeDiv){i+=parseInt(this.closeDiv.style.width)+t.right}this.size.w+=i;this.size.h+=n;if("msie"==OpenLayers.BROWSER_NAME){this.contentSize.w+=t.left+t.right;this.contentSize.h+=t.bottom+t.top}if(null!=this.div){this.div.style.width=this.size.w+"px";this.div.style.height=this.size.h+"px"}if(null!=this.contentDiv){this.contentDiv.style.width=e.w+"px";this.contentDiv.style.height=e.h+"px"}},updateSize:function(){var e="<div class='"+this.contentDisplayClass+"'>"+this.contentDiv.innerHTML+"</div>",t=this.map?this.map.div:document.body,i=OpenLayers.Util.getRenderedDimensions(e,null,{displayClass:this.displayClass,containerElement:t}),n=this.getSafeContentSize(i),r=null;if(n.equals(i))r=i;else{var s={w:n.w<i.w?n.w:null,h:n.h<i.h?n.h:null};if(s.w&&s.h)r=n;else{var a=OpenLayers.Util.getRenderedDimensions(e,s,{displayClass:this.contentDisplayClass,containerElement:t});if("hidden"!=OpenLayers.Element.getStyle(this.contentDiv,"overflow")&&a.equals(n)){var o=OpenLayers.Util.getScrollbarWidth();s.w?a.h+=o:a.w+=o}r=this.getSafeContentSize(a)}}this.setSize(r)},setBackgroundColor:function(e){void 0!=e&&(this.backgroundColor=e);null!=this.div&&(this.div.style.backgroundColor=this.backgroundColor)},setOpacity:function(e){void 0!=e&&(this.opacity=e);if(null!=this.div){this.div.style.opacity=this.opacity;this.div.style.filter="alpha(opacity="+100*this.opacity+")"}},setBorder:function(e){void 0!=e&&(this.border=e);null!=this.div&&(this.div.style.border=this.border)},setContentHTML:function(e){null!=e&&(this.contentHTML=e);if(null!=this.contentDiv&&null!=this.contentHTML&&this.contentHTML!=this.contentDiv.innerHTML){this.contentDiv.innerHTML=this.contentHTML;if(this.autoSize){this.registerImageListeners();this.updateSize()}}},registerImageListeners:function(){for(var e=function(){if(null!==this.popup.id){this.popup.updateSize();this.popup.visible()&&this.popup.panMapIfOutOfView&&this.popup.panIntoView();OpenLayers.Event.stopObserving(this.img,"load",this.img._onImgLoad)}},t=this.contentDiv.getElementsByTagName("img"),i=0,n=t.length;i<n;i++){var r=t[i];if(0==r.width||0==r.height){var s={popup:this,img:r};r._onImgLoad=OpenLayers.Function.bind(e,s);OpenLayers.Event.observe(r,"load",r._onImgLoad)}}},getSafeContentSize:function(e){var t=e.clone(),i=this.getContentDivPadding(),n=i.left+i.right,r=i.top+i.bottom;this.fixPadding();n+=this.padding.left+this.padding.right;r+=this.padding.top+this.padding.bottom;if(this.closeDiv){n+=parseInt(this.closeDiv.style.width)+i.right}if(this.minSize){t.w=Math.max(t.w,this.minSize.w-n);t.h=Math.max(t.h,this.minSize.h-r)}if(this.maxSize){t.w=Math.min(t.w,this.maxSize.w-n);t.h=Math.min(t.h,this.maxSize.h-r)}if(this.map&&this.map.size){var s=0,a=0;if(this.keepInMap&&!this.panMapIfOutOfView){var o=this.map.getPixelFromLonLat(this.lonlat);switch(this.relativePosition){case"tr":s=o.x;a=this.map.size.h-o.y;break;case"tl":s=this.map.size.w-o.x;a=this.map.size.h-o.y;break;case"bl":s=this.map.size.w-o.x;a=o.y;break;case"br":s=o.x;a=o.y;break;default:s=o.x;a=this.map.size.h-o.y}}var l=this.map.size.h-this.map.paddingForPopups.top-this.map.paddingForPopups.bottom-r-a,c=this.map.size.w-this.map.paddingForPopups.left-this.map.paddingForPopups.right-n-s;t.w=Math.min(t.w,c);t.h=Math.min(t.h,l)}return t},getContentDivPadding:function(){var e=this._contentDivPadding;if(!e){if(null==this.div.parentNode){this.div.style.display="none";document.body.appendChild(this.div)}e=new OpenLayers.Bounds(OpenLayers.Element.getStyle(this.contentDiv,"padding-left"),OpenLayers.Element.getStyle(this.contentDiv,"padding-bottom"),OpenLayers.Element.getStyle(this.contentDiv,"padding-right"),OpenLayers.Element.getStyle(this.contentDiv,"padding-top"));this._contentDivPadding=e;if(this.div.parentNode==document.body){document.body.removeChild(this.div);this.div.style.display=""}}return e},addCloseBox:function(e){this.closeDiv=OpenLayers.Util.createDiv(this.id+"_close",null,{w:17,h:17});this.closeDiv.className="olPopupCloseBox";var t=this.getContentDivPadding();this.closeDiv.style.right=t.right+"px";this.closeDiv.style.top=t.top+"px";this.groupDiv.appendChild(this.closeDiv);var i=e||function(e){this.hide();OpenLayers.Event.stop(e)};OpenLayers.Event.observe(this.closeDiv,"touchend",OpenLayers.Function.bindAsEventListener(i,this));OpenLayers.Event.observe(this.closeDiv,"click",OpenLayers.Function.bindAsEventListener(i,this))},panIntoView:function(){var e=this.map.getSize(),t=this.map.getViewPortPxFromLayerPx(new OpenLayers.Pixel(parseInt(this.div.style.left),parseInt(this.div.style.top))),i=t.clone();t.x<this.map.paddingForPopups.left?i.x=this.map.paddingForPopups.left:t.x+this.size.w>e.w-this.map.paddingForPopups.right&&(i.x=e.w-this.map.paddingForPopups.right-this.size.w);t.y<this.map.paddingForPopups.top?i.y=this.map.paddingForPopups.top:t.y+this.size.h>e.h-this.map.paddingForPopups.bottom&&(i.y=e.h-this.map.paddingForPopups.bottom-this.size.h);var n=t.x-i.x,r=t.y-i.y;this.map.pan(n,r)},registerEvents:function(){this.events=new OpenLayers.Events(this,this.div,null,!0);this.events.on({mousedown:this.onmousedown,mousemove:this.onmousemove,mouseup:this.onmouseup,click:this.onclick,mouseout:this.onmouseout,dblclick:this.ondblclick,touchstart:function(e){OpenLayers.Event.stop(e,!0)},scope:this})},onmousedown:function(e){this.mousedown=!0;OpenLayers.Event.stop(e,!0)},onmousemove:function(e){this.mousedown&&OpenLayers.Event.stop(e,!0)},onmouseup:function(e){if(this.mousedown){this.mousedown=!1;OpenLayers.Event.stop(e,!0)}},onclick:function(e){OpenLayers.Event.stop(e,!0)},onmouseout:function(e){this.mousedown=!1},ondblclick:function(e){OpenLayers.Event.stop(e,!0)},CLASS_NAME:"OpenLayers.Popup"});OpenLayers.Popup.WIDTH=200;OpenLayers.Popup.HEIGHT=200;OpenLayers.Popup.COLOR="white";OpenLayers.Popup.OPACITY=1;OpenLayers.Popup.BORDER="0px";OpenLayers.Popup.Anchored=OpenLayers.Class(OpenLayers.Popup,{relativePosition:null,keepInMap:!0,anchor:null,initialize:function(e,t,i,n,r,s,a){var o=[e,t,i,n,s,a];OpenLayers.Popup.prototype.initialize.apply(this,o);this.anchor=null!=r?r:{size:new OpenLayers.Size(0,0),offset:new OpenLayers.Pixel(0,0)}},destroy:function(){this.anchor=null;this.relativePosition=null;OpenLayers.Popup.prototype.destroy.apply(this,arguments)},show:function(){this.updatePosition();OpenLayers.Popup.prototype.show.apply(this,arguments)},moveTo:function(e){var t=this.relativePosition;this.relativePosition=this.calculateRelativePosition(e);OpenLayers.Popup.prototype.moveTo.call(this,this.calculateNewPx(e));this.relativePosition!=t&&this.updateRelativePosition()},setSize:function(e){OpenLayers.Popup.prototype.setSize.apply(this,arguments);if(this.lonlat&&this.map){var t=this.map.getLayerPxFromLonLat(this.lonlat);this.moveTo(t)}},calculateRelativePosition:function(e){var t=this.map.getLonLatFromLayerPx(e),i=this.map.getExtent().determineQuadrant(t);return OpenLayers.Bounds.oppositeQuadrant(i)},updateRelativePosition:function(){},calculateNewPx:function(e){var t=e.offset(this.anchor.offset),i=this.size||this.contentSize,n="t"==this.relativePosition.charAt(0);t.y+=n?-i.h:this.anchor.size.h;var r="l"==this.relativePosition.charAt(1);t.x+=r?-i.w:this.anchor.size.w;return t},CLASS_NAME:"OpenLayers.Popup.Anchored"});OpenLayers.Popup.Framed=OpenLayers.Class(OpenLayers.Popup.Anchored,{imageSrc:null,imageSize:null,isAlphaImage:!1,positionBlocks:null,blocks:null,fixedRelativePosition:!1,initialize:function(e,t,i,n,r,s,a){OpenLayers.Popup.Anchored.prototype.initialize.apply(this,arguments);if(this.fixedRelativePosition){this.updateRelativePosition();this.calculateRelativePosition=function(e){return this.relativePosition}}this.contentDiv.style.position="absolute";this.contentDiv.style.zIndex=1;s&&(this.closeDiv.style.zIndex=1);this.groupDiv.style.position="absolute";this.groupDiv.style.top="0px";this.groupDiv.style.left="0px";this.groupDiv.style.height="100%";this.groupDiv.style.width="100%"},destroy:function(){this.imageSrc=null;this.imageSize=null;this.isAlphaImage=null;this.fixedRelativePosition=!1;this.positionBlocks=null;for(var e=0;e<this.blocks.length;e++){var t=this.blocks[e];t.image&&t.div.removeChild(t.image);t.image=null;t.div&&this.groupDiv.removeChild(t.div);t.div=null}this.blocks=null;OpenLayers.Popup.Anchored.prototype.destroy.apply(this,arguments)},setBackgroundColor:function(e){},setBorder:function(){},setOpacity:function(e){},setSize:function(e){OpenLayers.Popup.Anchored.prototype.setSize.apply(this,arguments);this.updateBlocks()},updateRelativePosition:function(){this.padding=this.positionBlocks[this.relativePosition].padding;if(this.closeDiv){var e=this.getContentDivPadding();this.closeDiv.style.right=e.right+this.padding.right+"px";this.closeDiv.style.top=e.top+this.padding.top+"px"}this.updateBlocks()},calculateNewPx:function(e){var t=OpenLayers.Popup.Anchored.prototype.calculateNewPx.apply(this,arguments);return t=t.offset(this.positionBlocks[this.relativePosition].offset)},createBlocks:function(){this.blocks=[];var e=null;for(var t in this.positionBlocks){e=t;break}for(var i=this.positionBlocks[e],n=0;n<i.blocks.length;n++){var r={};this.blocks.push(r);var s=this.id+"_FrameDecorationDiv_"+n;r.div=OpenLayers.Util.createDiv(s,null,null,null,"absolute",null,"hidden",null);var a=this.id+"_FrameDecorationImg_"+n,o=this.isAlphaImage?OpenLayers.Util.createAlphaImageDiv:OpenLayers.Util.createImage;r.image=o(a,null,this.imageSize,this.imageSrc,"absolute",null,null,null);r.div.appendChild(r.image);this.groupDiv.appendChild(r.div)}},updateBlocks:function(){this.blocks||this.createBlocks();if(this.size&&this.relativePosition){for(var e=this.positionBlocks[this.relativePosition],t=0;t<e.blocks.length;t++){var i=e.blocks[t],n=this.blocks[t],r=i.anchor.left,s=i.anchor.bottom,a=i.anchor.right,o=i.anchor.top,l=isNaN(i.size.w)?this.size.w-(a+r):i.size.w,c=isNaN(i.size.h)?this.size.h-(s+o):i.size.h;n.div.style.width=(l<0?0:l)+"px";n.div.style.height=(c<0?0:c)+"px";n.div.style.left=null!=r?r+"px":"";n.div.style.bottom=null!=s?s+"px":"";n.div.style.right=null!=a?a+"px":"";n.div.style.top=null!=o?o+"px":"";n.image.style.left=i.position.x+"px";n.image.style.top=i.position.y+"px"}this.contentDiv.style.left=this.padding.left+"px";this.contentDiv.style.top=this.padding.top+"px"}},CLASS_NAME:"OpenLayers.Popup.Framed"});OpenLayers.Format.WMTSCapabilities=OpenLayers.Class(OpenLayers.Format.XML.VersionedOGC,{defaultVersion:"1.0.0",yx:{"urn:ogc:def:crs:EPSG::4326":!0},createLayer:function(e,t){if(!("layer"in t))throw new Error("Missing property 'layer' in configuration.");for(var i,n=e.contents,r=(n.layers,0),s=n.layers.length;r<s;++r)if(n.layers[r].identifier===t.layer){i=n.layers[r];break}if(!i)throw new Error("Layer not found");var a,o,l=t.format;!l&&i.formats&&i.formats.length&&(l=i.formats[0]);t.matrixSet?a=n.tileMatrixSets[t.matrixSet]:i.tileMatrixSetLinks.length>=1&&(a=n.tileMatrixSets[i.tileMatrixSetLinks[0].tileMatrixSet]);if(!a)throw new Error("matrixSet not found");for(r=0,s=i.styles.length;r<s&&!(o=i.styles[r]).isDefault;++r);var c=t.requestEncoding;if(!c){c="KVP";if(e.operationsMetadata.GetTile.dcp.http){var u=e.operationsMetadata.GetTile.dcp.http;if(u.get[0].constraints){var h=u.get[0].constraints.GetEncoding.allowedValues;h.KVP||!h.REST&&!h.RESTful||(c="REST")}}}var p=[],d=t.params||{};delete t.params;for(var f=0,m=i.dimensions.length;f<m;f++){var y=i.dimensions[f];p.push(y.identifier);d.hasOwnProperty(y.identifier)||(d[y.identifier]=y.default)}var g,C=t.projection||a.supportedCRS.replace(/urn:ogc:def:crs:(\w+):(.*:)?(\w+)$/,"$1:$3"),v=t.units||("EPSG:4326"===C?"degrees":"m"),T=[];for(var L in a.matrixIds)a.matrixIds.hasOwnProperty(L)&&T.push(28e-5*a.matrixIds[L].scaleDenominator/OpenLayers.METERS_PER_INCH/OpenLayers.INCHES_PER_UNIT[v]);if("REST"===c&&i.resourceUrls){g=[];i.resourceUrls;for(var w,b=0,S=i.resourceUrls.length;b<S;++b)(w=i.resourceUrls[b]).format===l&&"tile"===w.resourceType&&g.push(w.template)}else{var E,O=e.operationsMetadata.GetTile.dcp.http.get;g=[];for(r=0,s=O.length;r<s;r++)(!(E=O[r].constraints)||E&&E.GetEncoding.allowedValues[c])&&g.push(O[r].url)}return new OpenLayers.Layer.WMTS(OpenLayers.Util.applyDefaults(t,{url:g,requestEncoding:c,name:i.title,style:o.identifier,format:l,matrixIds:a.matrixIds,matrixSet:a.identifier,projection:C,units:v,resolutions:!1===t.isBaseLayer?void 0:T,serverResolutions:T,tileFullExtent:a.bounds,dimensions:p,params:d}))},CLASS_NAME:"OpenLayers.Format.WMTSCapabilities"});OpenLayers.Control.Button=OpenLayers.Class(OpenLayers.Control,{type:OpenLayers.Control.TYPE_BUTTON,trigger:function(){},CLASS_NAME:"OpenLayers.Control.Button"});OpenLayers.Control.Measure=OpenLayers.Class(OpenLayers.Control,{callbacks:null,displaySystem:"metric",geodesic:!1,displaySystemUnits:{geographic:["dd"],english:["mi","ft","in"],metric:["km","m"]},partialDelay:300,delayedTrigger:null,persist:!1,immediate:!1,initialize:function(e,t){OpenLayers.Control.prototype.initialize.apply(this,[t]);var i={done:this.measureComplete,point:this.measurePartial};this.immediate&&(i.modify=this.measureImmediate);this.callbacks=OpenLayers.Util.extend(i,this.callbacks);this.handlerOptions=OpenLayers.Util.extend({persist:this.persist},this.handlerOptions);this.handler=new e(this,this.callbacks,this.handlerOptions)},deactivate:function(){this.cancelDelay();return OpenLayers.Control.prototype.deactivate.apply(this,arguments)},cancel:function(){this.cancelDelay();this.handler.cancel()},setImmediate:function(e){this.immediate=e;this.immediate?this.callbacks.modify=this.measureImmediate:delete this.callbacks.modify},updateHandler:function(e,t){var i=this.active;i&&this.deactivate();this.handler=new e(this,this.callbacks,t);i&&this.activate()},measureComplete:function(e){this.cancelDelay();this.measure(e,"measure")},measurePartial:function(e,t){this.cancelDelay();t=t.clone();this.handler.freehandMode(this.handler.evt)?this.measure(t,"measurepartial"):this.delayedTrigger=window.setTimeout(OpenLayers.Function.bind(function(){this.delayedTrigger=null;this.measure(t,"measurepartial")},this),this.partialDelay)},measureImmediate:function(e,t,i){if(i&&!this.handler.freehandMode(this.handler.evt)){this.cancelDelay();this.measure(t.geometry,"measurepartial")}},cancelDelay:function(){if(null!==this.delayedTrigger){window.clearTimeout(this.delayedTrigger);this.delayedTrigger=null}},measure:function(e,t){var i,n;if(e.CLASS_NAME.indexOf("LineString")>-1){i=this.getBestLength(e);n=1}else{i=this.getBestArea(e);n=2}this.events.triggerEvent(t,{measure:i[0],units:i[1],order:n,geometry:e})},getBestArea:function(e){for(var t,i,n=this.displaySystemUnits[this.displaySystem],r=0,s=n.length;r<s;++r){t=n[r];if((i=this.getArea(e,t))>1)break}return[i,t]},getArea:function(e,t){var i,n;if(this.geodesic){i=e.getGeodesicArea(this.map.getProjectionObject());n="m"}else{i=e.getArea();n=this.map.getUnits()}var r=OpenLayers.INCHES_PER_UNIT[t];if(r){var s=OpenLayers.INCHES_PER_UNIT[n];i*=Math.pow(s/r,2)}return i},getBestLength:function(e){for(var t,i,n=this.displaySystemUnits[this.displaySystem],r=0,s=n.length;r<s;++r){t=n[r];if((i=this.getLength(e,t))>1)break}return[i,t]},getLength:function(e,t){var i,n;if(this.geodesic){i=e.getGeodesicLength(this.map.getProjectionObject());n="m"}else{i=e.getLength();n=this.map.getUnits()}var r=OpenLayers.INCHES_PER_UNIT[t];if(r){i*=OpenLayers.INCHES_PER_UNIT[n]/r}return i},CLASS_NAME:"OpenLayers.Control.Measure"});OpenLayers.Format.WMTSCapabilities.v1_0_0=OpenLayers.Class(OpenLayers.Format.OWSCommon.v1_1_0,{version:"1.0.0",namespaces:{ows:"http://www.opengis.net/ows/1.1",wmts:"http://www.opengis.net/wmts/1.0",xlink:"http://www.w3.org/1999/xlink"},yx:null,defaultPrefix:"wmts",initialize:function(e){OpenLayers.Format.XML.prototype.initialize.apply(this,[e]);this.options=e;var t=OpenLayers.Util.extend({},OpenLayers.Format.WMTSCapabilities.prototype.yx);this.yx=OpenLayers.Util.extend(t,this.yx)},read:function(e){"string"==typeof e&&(e=OpenLayers.Format.XML.prototype.read.apply(this,[e]));e&&9==e.nodeType&&(e=e.documentElement);var t={};this.readNode(e,t);t.version=this.version;return t},readers:{wmts:{Capabilities:function(e,t){this.readChildNodes(e,t)},Contents:function(e,t){t.contents={};t.contents.layers=[];t.contents.tileMatrixSets={};this.readChildNodes(e,t.contents)},Layer:function(e,t){var i={styles:[],formats:[],dimensions:[],tileMatrixSetLinks:[],layers:[]};this.readChildNodes(e,i);t.layers.push(i)},Style:function(e,t){var i={};i.isDefault="true"===e.getAttribute("isDefault");this.readChildNodes(e,i);t.styles.push(i)},Format:function(e,t){t.formats.push(this.getChildValue(e))},TileMatrixSetLink:function(e,t){var i={};this.readChildNodes(e,i);t.tileMatrixSetLinks.push(i)},TileMatrixSet:function(e,t){if(t.layers){var i={matrixIds:[]};this.readChildNodes(e,i);t.tileMatrixSets[i.identifier]=i}else t.tileMatrixSet=this.getChildValue(e)},TileMatrix:function(e,t){var i={supportedCRS:t.supportedCRS};this.readChildNodes(e,i);t.matrixIds.push(i)},ScaleDenominator:function(e,t){t.scaleDenominator=parseFloat(this.getChildValue(e))},TopLeftCorner:function(e,t){var i,n=this.getChildValue(e).split(" ");if(t.supportedCRS){var r=t.supportedCRS.replace(/urn:ogc:def:crs:(\w+):.+:(\w+)$/,"urn:ogc:def:crs:$1::$2");i=!!this.yx[r]}t.topLeftCorner=i?new OpenLayers.LonLat(n[1],n[0]):new OpenLayers.LonLat(n[0],n[1])},TileWidth:function(e,t){t.tileWidth=parseInt(this.getChildValue(e))},TileHeight:function(e,t){t.tileHeight=parseInt(this.getChildValue(e))},MatrixWidth:function(e,t){t.matrixWidth=parseInt(this.getChildValue(e))},MatrixHeight:function(e,t){t.matrixHeight=parseInt(this.getChildValue(e))},ResourceURL:function(e,t){t.resourceUrl=t.resourceUrl||{};var i=e.getAttribute("resourceType");t.resourceUrls||(t.resourceUrls=[]);var n=t.resourceUrl[i]={format:e.getAttribute("format"),template:e.getAttribute("template"),resourceType:i};t.resourceUrls.push(n)},WSDL:function(e,t){t.wsdl={};t.wsdl.href=e.getAttribute("xlink:href")},ServiceMetadataURL:function(e,t){t.serviceMetadataUrl={};t.serviceMetadataUrl.href=e.getAttribute("xlink:href")},LegendURL:function(e,t){t.legend={};t.legend.href=e.getAttribute("xlink:href");t.legend.format=e.getAttribute("format")},Dimension:function(e,t){var i={values:[]};this.readChildNodes(e,i);t.dimensions.push(i)},Default:function(e,t){t.default=this.getChildValue(e)},Value:function(e,t){t.values.push(this.getChildValue(e))}},ows:OpenLayers.Format.OWSCommon.v1_1_0.prototype.readers.ows},CLASS_NAME:"OpenLayers.Format.WMTSCapabilities.v1_0_0"});OpenLayers.Popup.FramedCloud=OpenLayers.Class(OpenLayers.Popup.Framed,{contentDisplayClass:"olFramedCloudPopupContent",autoSize:!0,panMapIfOutOfView:!0,imageSize:new OpenLayers.Size(1276,736),isAlphaImage:!1,fixedRelativePosition:!1,positionBlocks:{tl:{offset:new OpenLayers.Pixel(44,0),padding:new OpenLayers.Bounds(8,40,8,9),blocks:[{size:new OpenLayers.Size("auto","auto"),anchor:new OpenLayers.Bounds(0,51,22,0),position:new OpenLayers.Pixel(0,0)},{size:new OpenLayers.Size(22,"auto"),anchor:new OpenLayers.Bounds(null,50,0,0),position:new OpenLayers.Pixel(-1238,0)},{size:new OpenLayers.Size("auto",19),anchor:new OpenLayers.Bounds(0,32,22,null),position:new OpenLayers.Pixel(0,-631)},{size:new OpenLayers.Size(22,18),anchor:new OpenLayers.Bounds(null,32,0,null),position:new OpenLayers.Pixel(-1238,-632)},{size:new OpenLayers.Size(81,35),anchor:new OpenLayers.Bounds(null,0,0,null),position:new OpenLayers.Pixel(0,-688)}]},tr:{offset:new OpenLayers.Pixel(-45,0),padding:new OpenLayers.Bounds(8,40,8,9),blocks:[{size:new OpenLayers.Size("auto","auto"),anchor:new OpenLayers.Bounds(0,51,22,0),position:new OpenLayers.Pixel(0,0)},{size:new OpenLayers.Size(22,"auto"),anchor:new OpenLayers.Bounds(null,50,0,0),position:new OpenLayers.Pixel(-1238,0)},{size:new OpenLayers.Size("auto",19),anchor:new OpenLayers.Bounds(0,32,22,null),position:new OpenLayers.Pixel(0,-631)},{size:new OpenLayers.Size(22,19),anchor:new OpenLayers.Bounds(null,32,0,null),position:new OpenLayers.Pixel(-1238,-631)},{size:new OpenLayers.Size(81,35),anchor:new OpenLayers.Bounds(0,0,null,null),position:new OpenLayers.Pixel(-215,-687)}]},bl:{offset:new OpenLayers.Pixel(45,0),padding:new OpenLayers.Bounds(8,9,8,40),blocks:[{size:new OpenLayers.Size("auto","auto"),anchor:new OpenLayers.Bounds(0,21,22,32),position:new OpenLayers.Pixel(0,0)},{size:new OpenLayers.Size(22,"auto"),anchor:new OpenLayers.Bounds(null,21,0,32),position:new OpenLayers.Pixel(-1238,0)},{size:new OpenLayers.Size("auto",21),anchor:new OpenLayers.Bounds(0,0,22,null),position:new OpenLayers.Pixel(0,-629)},{size:new OpenLayers.Size(22,21),anchor:new OpenLayers.Bounds(null,0,0,null),position:new OpenLayers.Pixel(-1238,-629)},{size:new OpenLayers.Size(81,33),anchor:new OpenLayers.Bounds(null,null,0,0),position:new OpenLayers.Pixel(-101,-674)}]},br:{offset:new OpenLayers.Pixel(-44,0),padding:new OpenLayers.Bounds(8,9,8,40),blocks:[{size:new OpenLayers.Size("auto","auto"),anchor:new OpenLayers.Bounds(0,21,22,32),position:new OpenLayers.Pixel(0,0)},{size:new OpenLayers.Size(22,"auto"),anchor:new OpenLayers.Bounds(null,21,0,32),position:new OpenLayers.Pixel(-1238,0)},{size:new OpenLayers.Size("auto",21),anchor:new OpenLayers.Bounds(0,0,22,null),position:new OpenLayers.Pixel(0,-629)},{size:new OpenLayers.Size(22,21),anchor:new OpenLayers.Bounds(null,0,0,null),position:new OpenLayers.Pixel(-1238,-629)},{size:new OpenLayers.Size(81,33),anchor:new OpenLayers.Bounds(0,null,null,0),position:new OpenLayers.Pixel(-311,-674)}]}},minSize:new OpenLayers.Size(105,10),maxSize:new OpenLayers.Size(1200,660),initialize:function(e,t,i,n,r,s,a){this.imageSrc=OpenLayers.Util.getImageLocation("cloud-popup-relative.png");OpenLayers.Popup.Framed.prototype.initialize.apply(this,arguments);this.contentDiv.className=this.contentDisplayClass},CLASS_NAME:"OpenLayers.Popup.FramedCloud"});OpenLayers.Handler.Pinch=OpenLayers.Class(OpenLayers.Handler,{started:!1,stopDown:!1,pinching:!1,last:null,start:null,touchstart:function(e){var t=!0;this.pinching=!1;if(OpenLayers.Event.isMultiTouch(e)){this.started=!0;this.last=this.start={distance:this.getDistance(e.touches),delta:0,scale:1};this.callback("start",[e,this.start]);t=!this.stopDown}else{if(this.started)return!1;this.started=!1;this.start=null;this.last=null}OpenLayers.Event.preventDefault(e);return t},touchmove:function(e){if(this.started&&OpenLayers.Event.isMultiTouch(e)){this.pinching=!0;var t=this.getPinchData(e);this.callback("move",[e,t]);this.last=t;OpenLayers.Event.stop(e)}else if(this.started)return!1;return!0},touchend:function(e){if(this.started&&!OpenLayers.Event.isMultiTouch(e)){this.started=!1;this.pinching=!1;this.callback("done",[e,this.start,this.last]);this.start=null;this.last=null;return!1}return!0},activate:function(){var e=!1;if(OpenLayers.Handler.prototype.activate.apply(this,arguments)){this.pinching=!1;e=!0}return e},deactivate:function(){var e=!1;if(OpenLayers.Handler.prototype.deactivate.apply(this,arguments)){this.started=!1;this.pinching=!1;this.start=null;this.last=null;e=!0}return e},getDistance:function(e){var t=e[0],i=e[1];return Math.sqrt(Math.pow(t.olClientX-i.olClientX,2)+Math.pow(t.olClientY-i.olClientY,2))},getPinchData:function(e){var t=this.getDistance(e.touches),i=t/this.start.distance;return{distance:t,delta:this.last.distance-t,scale:i}},CLASS_NAME:"OpenLayers.Handler.Pinch"});OpenLayers.Handler.Hover=OpenLayers.Class(OpenLayers.Handler,{delay:500,pixelTolerance:null,stopMove:!1,px:null,timerId:null,mousemove:function(e){if(this.passesTolerance(e.xy)){this.clearTimer();this.callback("move",[e]);this.px=e.xy;e=OpenLayers.Util.extend({},e);this.timerId=window.setTimeout(OpenLayers.Function.bind(this.delayedCall,this,e),this.delay)}return!this.stopMove},mouseout:function(e){if(OpenLayers.Util.mouseLeft(e,this.map.viewPortDiv)){this.clearTimer();this.callback("move",[e])}return!0},passesTolerance:function(e){var t=!0;if(this.pixelTolerance&&this.px){Math.sqrt(Math.pow(this.px.x-e.x,2)+Math.pow(this.px.y-e.y,2))<this.pixelTolerance&&(t=!1)}return t},clearTimer:function(){if(null!=this.timerId){window.clearTimeout(this.timerId);this.timerId=null}},delayedCall:function(e){this.callback("pause",[e])},deactivate:function(){var e=!1;if(OpenLayers.Handler.prototype.deactivate.apply(this,arguments)){this.clearTimer();e=!0}return e},CLASS_NAME:"OpenLayers.Handler.Hover"});OpenLayers.Control.NavigationHistory=OpenLayers.Class(OpenLayers.Control,{type:OpenLayers.Control.TYPE_TOGGLE,previous:null,previousOptions:null,next:null,nextOptions:null,limit:50,autoActivate:!0,clearOnDeactivate:!1,registry:null,nextStack:null,previousStack:null,listeners:null,restoring:!1,initialize:function(e){OpenLayers.Control.prototype.initialize.apply(this,[e]);this.registry=OpenLayers.Util.extend({moveend:this.getState},this.registry);var t={trigger:OpenLayers.Function.bind(this.previousTrigger,this),displayClass:this.displayClass+" "+this.displayClass+"Previous"};OpenLayers.Util.extend(t,this.previousOptions);this.previous=new OpenLayers.Control.Button(t);var i={trigger:OpenLayers.Function.bind(this.nextTrigger,this),displayClass:this.displayClass+" "+this.displayClass+"Next"};OpenLayers.Util.extend(i,this.nextOptions);this.next=new OpenLayers.Control.Button(i);this.clear()},onPreviousChange:function(e,t){e&&!this.previous.active?this.previous.activate():!e&&this.previous.active&&this.previous.deactivate()},onNextChange:function(e,t){e&&!this.next.active?this.next.activate():!e&&this.next.active&&this.next.deactivate()},destroy:function(){OpenLayers.Control.prototype.destroy.apply(this);this.previous.destroy();this.next.destroy();this.deactivate();for(var e in this)this[e]=null},setMap:function(e){this.map=e;this.next.setMap(e);this.previous.setMap(e)},draw:function(){OpenLayers.Control.prototype.draw.apply(this,arguments);this.next.draw();this.previous.draw()},previousTrigger:function(){var e=this.previousStack.shift(),t=this.previousStack.shift();if(void 0!=t){this.nextStack.unshift(e);this.previousStack.unshift(t);this.restoring=!0;this.restore(t);this.restoring=!1;this.onNextChange(this.nextStack[0],this.nextStack.length);this.onPreviousChange(this.previousStack[1],this.previousStack.length-1)}else this.previousStack.unshift(e);return t},nextTrigger:function(){var e=this.nextStack.shift();if(void 0!=e){this.previousStack.unshift(e);this.restoring=!0;this.restore(e);this.restoring=!1;this.onNextChange(this.nextStack[0],this.nextStack.length);this.onPreviousChange(this.previousStack[1],this.previousStack.length-1)}return e},clear:function(){this.previousStack=[];this.previous.deactivate();this.nextStack=[];this.next.deactivate()},getState:function(){return{center:this.map.getCenter(),resolution:this.map.getResolution(),projection:this.map.getProjectionObject(),units:this.map.getProjectionObject().getUnits()||this.map.units||this.map.baseLayer.units}},restore:function(e){var t,i;if(this.map.getProjectionObject()==e.projection){i=this.map.getZoomForResolution(e.resolution);t=e.center}else{(t=e.center.clone()).transform(e.projection,this.map.getProjectionObject());var n=e.units,r=this.map.getProjectionObject().getUnits()||this.map.units||this.map.baseLayer.units,s=n&&r?OpenLayers.INCHES_PER_UNIT[n]/OpenLayers.INCHES_PER_UNIT[r]:1;i=this.map.getZoomForResolution(s*e.resolution)}this.map.setCenter(t,i)},setListeners:function(){this.listeners={};for(var e in this.registry)this.listeners[e]=OpenLayers.Function.bind(function(){if(!this.restoring){var t=this.registry[e].apply(this,arguments);this.previousStack.unshift(t);this.previousStack.length>1&&this.onPreviousChange(this.previousStack[1],this.previousStack.length-1);this.previousStack.length>this.limit+1&&this.previousStack.pop();if(this.nextStack.length>0){this.nextStack=[];this.onNextChange(null,0)}}return!0},this)},activate:function(){var e=!1;if(this.map&&OpenLayers.Control.prototype.activate.apply(this)){null==this.listeners&&this.setListeners();for(var t in this.listeners)this.map.events.register(t,this,this.listeners[t]);e=!0;0==this.previousStack.length&&this.initStack()}return e},initStack:function(){this.map.getCenter()&&this.listeners.moveend()},deactivate:function(){var e=!1;if(this.map&&OpenLayers.Control.prototype.deactivate.apply(this)){for(var t in this.listeners)this.map.events.unregister(t,this,this.listeners[t]);this.clearOnDeactivate&&this.clear();e=!0}return e},CLASS_NAME:"OpenLayers.Control.NavigationHistory"});OpenLayers.Protocol.WFS.v1_0_0=OpenLayers.Class(OpenLayers.Protocol.WFS.v1,{version:"1.0.0",CLASS_NAME:"OpenLayers.Protocol.WFS.v1_0_0"});OpenLayers.Strategy.Cluster=OpenLayers.Class(OpenLayers.Strategy,{distance:20,threshold:null,features:null,clusters:null,clustering:!1,resolution:null,activate:function(){var e=OpenLayers.Strategy.prototype.activate.call(this);e&&this.layer.events.on({beforefeaturesadded:this.cacheFeatures,featuresremoved:this.clearCache,moveend:this.cluster,scope:this});return e},deactivate:function(){var e=OpenLayers.Strategy.prototype.deactivate.call(this);if(e){this.clearCache();this.layer.events.un({beforefeaturesadded:this.cacheFeatures,featuresremoved:this.clearCache,moveend:this.cluster,scope:this})}return e},cacheFeatures:function(e){var t=!0;if(!this.clustering){this.clearCache();this.features=e.features;this.cluster();t=!1}return t},clearCache:function(){this.clustering||(this.features=null)},cluster:function(e){if((!e||e.zoomChanged)&&this.features){var t=this.layer.map.getResolution();if(t!=this.resolution||!this.clustersExist()){this.resolution=t;for(var i,n,r,s=[],a=0;a<this.features.length;++a)if((i=this.features[a]).geometry){n=!1;for(var o=s.length-1;o>=0;--o){r=s[o];if(this.shouldCluster(r,i)){this.addToCluster(r,i);n=!0;break}}n||s.push(this.createCluster(this.features[a]))}this.clustering=!0;this.layer.removeAllFeatures();this.clustering=!1;if(s.length>0){if(this.threshold>1){var l,c=s.slice();s=[];a=0;for(var u=c.length;a<u;++a)(l=c[a]).attributes.count<this.threshold?Array.prototype.push.apply(s,l.cluster):s.push(l)}this.clustering=!0;this.layer.addFeatures(s);this.clustering=!1}this.clusters=s}}},clustersExist:function(){var e=!1;if(this.clusters&&this.clusters.length>0&&this.clusters.length==this.layer.features.length){e=!0;for(var t=0;t<this.clusters.length;++t)if(this.clusters[t]!=this.layer.features[t]){e=!1;break}}return e},shouldCluster:function(e,t){var i=e.geometry.getBounds().getCenterLonLat(),n=t.geometry.getBounds().getCenterLonLat();return Math.sqrt(Math.pow(i.lon-n.lon,2)+Math.pow(i.lat-n.lat,2))/this.resolution<=this.distance},addToCluster:function(e,t){e.cluster.push(t);e.attributes.count+=1},createCluster:function(e){var t=e.geometry.getBounds().getCenterLonLat(),i=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(t.lon,t.lat),{count:1});i.cluster=[e];return i},CLASS_NAME:"OpenLayers.Strategy.Cluster"});OpenLayers.Control.OverviewMap=OpenLayers.Class(OpenLayers.Control,{element:null,ovmap:null,size:{w:180,h:90},layers:null,minRectSize:15,minRectDisplayClass:"RectReplacement",minRatio:8,maxRatio:32,mapOptions:null,autoPan:!1,handlers:null,resolutionFactor:1,maximized:!1,maximizeTitle:"",minimizeTitle:"",initialize:function(e){this.layers=[];this.handlers={};OpenLayers.Control.prototype.initialize.apply(this,[e])},destroy:function(){if(this.mapDiv){this.handlers.click&&this.handlers.click.destroy();this.handlers.drag&&this.handlers.drag.destroy();this.ovmap&&this.ovmap.viewPortDiv.removeChild(this.extentRectangle);this.extentRectangle=null;if(this.rectEvents){this.rectEvents.destroy();this.rectEvents=null}if(this.ovmap){this.ovmap.destroy();this.ovmap=null}this.element.removeChild(this.mapDiv);this.mapDiv=null;this.div.removeChild(this.element);this.element=null;if(this.maximizeDiv){this.div.removeChild(this.maximizeDiv);this.maximizeDiv=null}if(this.minimizeDiv){this.div.removeChild(this.minimizeDiv);this.minimizeDiv=null}this.map.events.un({buttonclick:this.onButtonClick,moveend:this.update,changebaselayer:this.baseLayerDraw,scope:this});OpenLayers.Control.prototype.destroy.apply(this,arguments)}},draw:function(){OpenLayers.Control.prototype.draw.apply(this,arguments);if(0===this.layers.length){if(!this.map.baseLayer){this.map.events.register("changebaselayer",this,this.baseLayerDraw);return this.div}var e=this.map.baseLayer.clone();this.layers=[e]}this.element=document.createElement("div");this.element.className=this.displayClass+"Element";this.element.style.display="none";this.mapDiv=document.createElement("div");this.mapDiv.style.width=this.size.w+"px";this.mapDiv.style.height=this.size.h+"px";this.mapDiv.style.position="relative";this.mapDiv.style.overflow="hidden";this.mapDiv.id=OpenLayers.Util.createUniqueID("overviewMap");this.extentRectangle=document.createElement("div");this.extentRectangle.style.position="absolute";this.extentRectangle.style.zIndex=1e3;this.extentRectangle.className=this.displayClass+"ExtentRectangle";this.element.appendChild(this.mapDiv);this.div.appendChild(this.element);if(this.outsideViewport)this.element.style.display="";else{this.div.className+=" "+this.displayClass+"Container";var t=OpenLayers.Util.getImageLocation("layer-switcher-maximize.png");this.maximizeDiv=OpenLayers.Util.createAlphaImageDiv(this.displayClass+"MaximizeButton",null,null,t,"absolute");this.maximizeDiv.style.display="none";this.maximizeDiv.className=this.displayClass+"MaximizeButton olButton";this.maximizeTitle&&(this.maximizeDiv.title=this.maximizeTitle);this.div.appendChild(this.maximizeDiv);t=OpenLayers.Util.getImageLocation("layer-switcher-minimize.png");this.minimizeDiv=OpenLayers.Util.createAlphaImageDiv("OpenLayers_Control_minimizeDiv",null,null,t,"absolute");this.minimizeDiv.style.display="none";this.minimizeDiv.className=this.displayClass+"MinimizeButton olButton";this.minimizeTitle&&(this.minimizeDiv.title=this.minimizeTitle);this.div.appendChild(this.minimizeDiv);this.minimizeControl()}this.map.getExtent()&&this.update();this.map.events.on({buttonclick:this.onButtonClick,moveend:this.update,scope:this});this.maximized&&this.maximizeControl();return this.div},baseLayerDraw:function(){this.draw();this.map.events.unregister("changebaselayer",this,this.baseLayerDraw)},rectDrag:function(e){var t=this.handlers.drag.last.x-e.x,i=this.handlers.drag.last.y-e.y;if(0!=t||0!=i){var n=this.rectPxBounds.top,r=this.rectPxBounds.left,s=Math.abs(this.rectPxBounds.getHeight()),a=this.rectPxBounds.getWidth(),o=Math.max(0,n-i);o=Math.min(o,this.ovmap.size.h-this.hComp-s);var l=Math.max(0,r-t);l=Math.min(l,this.ovmap.size.w-this.wComp-a);this.setRectPxBounds(new OpenLayers.Bounds(l,o+s,l+a,o))}},mapDivClick:function(e){var t=this.rectPxBounds.getCenterPixel(),i=e.xy.x-t.x,n=e.xy.y-t.y,r=this.rectPxBounds.top,s=this.rectPxBounds.left,a=Math.abs(this.rectPxBounds.getHeight()),o=this.rectPxBounds.getWidth(),l=Math.max(0,r+n);l=Math.min(l,this.ovmap.size.h-a);var c=Math.max(0,s+i);c=Math.min(c,this.ovmap.size.w-o);this.setRectPxBounds(new OpenLayers.Bounds(c,l+a,c+o,l));this.updateMapToRect()},onButtonClick:function(e){e.buttonElement===this.minimizeDiv?this.minimizeControl():e.buttonElement===this.maximizeDiv&&this.maximizeControl()},maximizeControl:function(e){this.element.style.display="";this.showToggle(!1);null!=e&&OpenLayers.Event.stop(e)},minimizeControl:function(e){this.element.style.display="none";this.showToggle(!0);null!=e&&OpenLayers.Event.stop(e)},showToggle:function(e){this.maximizeDiv&&(this.maximizeDiv.style.display=e?"":"none");this.minimizeDiv&&(this.minimizeDiv.style.display=e?"none":"")},update:function(){null==this.ovmap&&this.createMap();!this.autoPan&&this.isSuitableOverview()||this.updateOverview();this.updateRectToMap()},isSuitableOverview:function(){var e=this.map.getExtent(),t=this.map.getMaxExtent(),i=new OpenLayers.Bounds(Math.max(e.left,t.left),Math.max(e.bottom,t.bottom),Math.min(e.right,t.right),Math.min(e.top,t.top));this.ovmap.getProjection()!=this.map.getProjection()&&(i=i.transform(this.map.getProjectionObject(),this.ovmap.getProjectionObject()));var n=this.ovmap.getResolution()/this.map.getResolution();return n>this.minRatio&&n<=this.maxRatio&&this.ovmap.getExtent().containsBounds(i)},updateOverview:function(){var e,t=this.map.getResolution(),i=this.ovmap.getResolution(),n=i/t;n>this.maxRatio?i=this.minRatio*t:n<=this.minRatio&&(i=this.maxRatio*t);this.ovmap.getProjection()!=this.map.getProjection()?(e=this.map.center.clone()).transform(this.map.getProjectionObject(),this.ovmap.getProjectionObject()):e=this.map.center;this.ovmap.setCenter(e,this.ovmap.getZoomForResolution(i*this.resolutionFactor));this.updateRectToMap()},createMap:function(){var e=OpenLayers.Util.extend({controls:[],maxResolution:"auto",fallThrough:!1},this.mapOptions);this.ovmap=new OpenLayers.Map(this.mapDiv,e);this.ovmap.viewPortDiv.appendChild(this.extentRectangle);OpenLayers.Event.stopObserving(window,"unload",this.ovmap.unloadDestroy);this.ovmap.addLayers(this.layers);this.ovmap.zoomToMaxExtent();this.wComp=parseInt(OpenLayers.Element.getStyle(this.extentRectangle,"border-left-width"))+parseInt(OpenLayers.Element.getStyle(this.extentRectangle,"border-right-width"));this.wComp=this.wComp?this.wComp:2;this.hComp=parseInt(OpenLayers.Element.getStyle(this.extentRectangle,"border-top-width"))+parseInt(OpenLayers.Element.getStyle(this.extentRectangle,"border-bottom-width"));this.hComp=this.hComp?this.hComp:2;this.handlers.drag=new OpenLayers.Handler.Drag(this,{move:this.rectDrag,done:this.updateMapToRect},{map:this.ovmap});this.handlers.click=new OpenLayers.Handler.Click(this,{click:this.mapDivClick},{single:!0,double:!1,stopSingle:!0,stopDouble:!0,pixelTolerance:1,map:this.ovmap});this.handlers.click.activate();this.rectEvents=new OpenLayers.Events(this,this.extentRectangle,null,!0);this.rectEvents.register("mouseover",this,function(e){this.handlers.drag.active||this.map.dragging||this.handlers.drag.activate()});this.rectEvents.register("mouseout",this,function(e){this.handlers.drag.dragging||this.handlers.drag.deactivate()});if(this.ovmap.getProjection()!=this.map.getProjection()){var t=this.map.getProjectionObject().getUnits()||this.map.units||this.map.baseLayer.units,i=this.ovmap.getProjectionObject().getUnits()||this.ovmap.units||this.ovmap.baseLayer.units;this.resolutionFactor=t&&i?OpenLayers.INCHES_PER_UNIT[t]/OpenLayers.INCHES_PER_UNIT[i]:1}},updateRectToMap:function(){var e;e=this.ovmap.getProjection()!=this.map.getProjection()?this.map.getExtent().transform(this.map.getProjectionObject(),this.ovmap.getProjectionObject()):this.map.getExtent();var t=this.getRectBoundsFromMapBounds(e);t&&this.setRectPxBounds(t)},updateMapToRect:function(){var e=this.getMapBoundsFromRectBounds(this.rectPxBounds);this.ovmap.getProjection()!=this.map.getProjection()&&(e=e.transform(this.ovmap.getProjectionObject(),this.map.getProjectionObject()));this.map.panTo(e.getCenterLonLat())},setRectPxBounds:function(e){var t=Math.max(e.top,0),i=Math.max(e.left,0),n=Math.min(e.top+Math.abs(e.getHeight()),this.ovmap.size.h-this.hComp),r=Math.min(e.left+e.getWidth(),this.ovmap.size.w-this.wComp),s=Math.max(r-i,0),a=Math.max(n-t,0);if(s<this.minRectSize||a<this.minRectSize){this.extentRectangle.className=this.displayClass+this.minRectDisplayClass;var o=i+s/2-this.minRectSize/2,l=t+a/2-this.minRectSize/2;this.extentRectangle.style.top=Math.round(l)+"px";this.extentRectangle.style.left=Math.round(o)+"px";this.extentRectangle.style.height=this.minRectSize+"px";this.extentRectangle.style.width=this.minRectSize+"px"}else{this.extentRectangle.className=this.displayClass+"ExtentRectangle";this.extentRectangle.style.top=Math.round(t)+"px";this.extentRectangle.style.left=Math.round(i)+"px";this.extentRectangle.style.height=Math.round(a)+"px";this.extentRectangle.style.width=Math.round(s)+"px"}this.rectPxBounds=new OpenLayers.Bounds(Math.round(i),Math.round(n),Math.round(r),Math.round(t))},getRectBoundsFromMapBounds:function(e){var t=this.getOverviewPxFromLonLat({lon:e.left,lat:e.bottom}),i=this.getOverviewPxFromLonLat({lon:e.right,lat:e.top}),n=null;t&&i&&(n=new OpenLayers.Bounds(t.x,t.y,i.x,i.y));return n},getMapBoundsFromRectBounds:function(e){var t=this.getLonLatFromOverviewPx({x:e.left,y:e.bottom}),i=this.getLonLatFromOverviewPx({x:e.right,y:e.top});return new OpenLayers.Bounds(t.lon,t.lat,i.lon,i.lat)},getLonLatFromOverviewPx:function(e){var t=this.ovmap.size,i=this.ovmap.getResolution(),n=this.ovmap.getExtent().getCenterLonLat(),r=e.x-t.w/2,s=e.y-t.h/2;return{lon:n.lon+r*i,lat:n.lat-s*i}},getOverviewPxFromLonLat:function(e){var t=this.ovmap.getResolution(),i=this.ovmap.getExtent();if(i)return{x:Math.round(1/t*(e.lon-i.left)),y:Math.round(1/t*(i.top-e.lat))}},CLASS_NAME:"OpenLayers.Control.OverviewMap"});OpenLayers.Renderer.VML=OpenLayers.Class(OpenLayers.Renderer.Elements,{xmlns:"urn:schemas-microsoft-com:vml",symbolCache:{},offset:null,initialize:function(e){if(this.supported()){if(!document.namespaces.olv){document.namespaces.add("olv",this.xmlns);for(var t=document.createStyleSheet(),i=["shape","rect","oval","fill","stroke","imagedata","group","textbox"],n=0,r=i.length;n<r;n++)t.addRule("olv\\:"+i[n],"behavior: url(#default#VML); position: absolute; display: inline-block;")}OpenLayers.Renderer.Elements.prototype.initialize.apply(this,arguments)}},supported:function(){return!!document.namespaces},setExtent:function(e,t){var i=OpenLayers.Renderer.Elements.prototype.setExtent.apply(this,arguments),n=this.getResolution(),r=e.left/n|0,s=e.top/n-this.size.h|0;if(t||!this.offset){this.offset={x:r,y:s};r=0;s=0}else{r-=this.offset.x;s-=this.offset.y}var a=r-this.xOffset+" "+s;this.root.coordorigin=a;for(var o,l=[this.root,this.vectorRoot,this.textRoot],c=0,u=l.length;c<u;++c){o=l[c];var h=this.size.w+" "+this.size.h;o.coordsize=h}this.root.style.flip="y";return i},setSize:function(e){OpenLayers.Renderer.prototype.setSize.apply(this,arguments);for(var t,i=[this.rendererRoot,this.root,this.vectorRoot,this.textRoot],n=this.size.w+"px",r=this.size.h+"px",s=0,a=i.length;s<a;++s){(t=i[s]).style.width=n;t.style.height=r}},getNodeType:function(e,t){var i=null;switch(e.CLASS_NAME){case"OpenLayers.Geometry.Point":i=t.externalGraphic?"olv:rect":this.isComplexSymbol(t.graphicName)?"olv:shape":"olv:oval";break;case"OpenLayers.Geometry.Rectangle":i="olv:rect";break;case"OpenLayers.Geometry.LineString":case"OpenLayers.Geometry.LinearRing":case"OpenLayers.Geometry.Polygon":case"OpenLayers.Geometry.Curve":i="olv:shape"}return i},setStyle:function(e,t,i,n){t=t||e._style;i=i||e._options;var r=t.fillColor,s=t.title||t.graphicTitle;s&&(e.title=s);if("OpenLayers.Geometry.Point"===e._geometryClass)if(t.externalGraphic){i.isFilled=!0;var a=t.graphicWidth||t.graphicHeight,o=t.graphicHeight||t.graphicWidth;a=a||2*t.pointRadius;o=o||2*t.pointRadius;var l=this.getResolution(),c=void 0!=t.graphicXOffset?t.graphicXOffset:-.5*a,u=void 0!=t.graphicYOffset?t.graphicYOffset:-.5*o;e.style.left=((n.x-this.featureDx)/l-this.offset.x+c|0)+"px";e.style.top=(n.y/l-this.offset.y-(u+o)|0)+"px";e.style.width=a+"px";e.style.height=o+"px";e.style.flip="y";r="none";i.isStroked=!1}else if(this.isComplexSymbol(t.graphicName)){var h=this.importSymbol(t.graphicName);e.path=h.path;e.coordorigin=h.left+","+h.bottom;var p=h.size;e.coordsize=p+","+p;this.drawCircle(e,n,t.pointRadius);e.style.flip="y"}else this.drawCircle(e,n,t.pointRadius);i.isFilled?e.fillcolor=r:e.filled="false";var d=e.getElementsByTagName("fill"),f=0==d.length?null:d[0];if(i.isFilled){f||(f=this.createNode("olv:fill",e.id+"_fill"));f.opacity=t.fillOpacity;if("OpenLayers.Geometry.Point"===e._geometryClass&&t.externalGraphic){t.graphicOpacity&&(f.opacity=t.graphicOpacity);f.src=t.externalGraphic;f.type="frame";t.graphicWidth&&t.graphicHeight||(f.aspect="atmost")}f.parentNode!=e&&e.appendChild(f)}else f&&e.removeChild(f);var m=t.rotation;if(void 0!==m||void 0!==e._rotation){e._rotation=m;if(t.externalGraphic){this.graphicRotate(e,c,u,t);f.opacity=0}else"OpenLayers.Geometry.Point"===e._geometryClass&&(e.style.rotation=m||0)}var y=e.getElementsByTagName("stroke"),g=0==y.length?null:y[0];if(i.isStroked){if(!g){g=this.createNode("olv:stroke",e.id+"_stroke");e.appendChild(g)}g.on=!0;g.color=t.strokeColor;g.weight=t.strokeWidth+"px";g.opacity=t.strokeOpacity;g.endcap="butt"==t.strokeLinecap?"flat":t.strokeLinecap||"round";t.strokeDashstyle&&(g.dashstyle=this.dashStyle(t))}else{e.stroked=!1;g&&(g.on=!1)}"inherit"!=t.cursor&&null!=t.cursor&&(e.style.cursor=t.cursor);return e},graphicRotate:function(e,t,i,n){var r,s,a=(n=n||e._style).rotation||0;if(n.graphicWidth&&n.graphicHeight){s=Math.max(n.graphicWidth,n.graphicHeight);r=n.graphicWidth/n.graphicHeight;var o=Math.round(n.graphicWidth||s*r),l=Math.round(n.graphicHeight||s);e.style.width=o+"px";e.style.height=l+"px";var c=document.getElementById(e.id+"_image");if(!c){c=this.createNode("olv:imagedata",e.id+"_image");e.appendChild(c)}c.style.width=o+"px";c.style.height=l+"px";c.src=n.externalGraphic;c.style.filter="progid:DXImageTransform.Microsoft.AlphaImageLoader(src='', sizingMethod='scale')";var u=a*Math.PI/180,h=Math.sin(u),p=Math.cos(u),d="progid:DXImageTransform.Microsoft.Matrix(M11="+p+",M12="+-h+",M21="+h+",M22="+p+",SizingMethod='auto expand')\n",f=n.graphicOpacity||n.fillOpacity;f&&1!=f&&(d+="progid:DXImageTransform.Microsoft.BasicImage(opacity="+f+")\n");e.style.filter=d;var m=new OpenLayers.Geometry.Point(-t,-i),y=new OpenLayers.Bounds(0,0,o,l).toGeometry();y.rotate(n.rotation,m);var g=y.getBounds();e.style.left=Math.round(parseInt(e.style.left)+g.left)+"px";e.style.top=Math.round(parseInt(e.style.top)-g.bottom)+"px"}else{var C=new Image;C.onreadystatechange=OpenLayers.Function.bind(function(){if("complete"==C.readyState||"interactive"==C.readyState){r=C.width/C.height;s=Math.max(2*n.pointRadius,n.graphicWidth||0,n.graphicHeight||0);t*=r;n.graphicWidth=s*r;n.graphicHeight=s;this.graphicRotate(e,t,i,n)}},this);C.src=n.externalGraphic}},postDraw:function(e){e.style.visibility="visible";var t=e._style.fillColor,i=e._style.strokeColor;"none"==t&&e.fillcolor!=t&&(e.fillcolor=t);"none"==i&&e.strokecolor!=i&&(e.strokecolor=i)},setNodeDimension:function(e,t){var i=t.getBounds();if(i){var n=this.getResolution(),r=new OpenLayers.Bounds((i.left-this.featureDx)/n-this.offset.x|0,i.bottom/n-this.offset.y|0,(i.right-this.featureDx)/n-this.offset.x|0,i.top/n-this.offset.y|0);e.style.left=r.left+"px";e.style.top=r.top+"px";e.style.width=r.getWidth()+"px";e.style.height=r.getHeight()+"px";e.coordorigin=r.left+" "+r.top;e.coordsize=r.getWidth()+" "+r.getHeight()}},dashStyle:function(e){var t=e.strokeDashstyle;switch(t){case"solid":case"dot":case"dash":case"dashdot":case"longdash":case"longdashdot":return t;default:var i=t.split(/[ ,]/);return 2==i.length?1*i[0]>=2*i[1]?"longdash":1==i[0]||1==i[1]?"dot":"dash":4==i.length?1*i[0]>=2*i[1]?"longdashdot":"dashdot":"solid"}},createNode:function(e,t){var i=document.createElement(e);t&&(i.id=t);i.unselectable="on";i.onselectstart=OpenLayers.Function.False;return i},nodeTypeCompare:function(e,t){var i=t,n=i.indexOf(":");-1!=n&&(i=i.substr(n+1));var r=e.nodeName;-1!=(n=r.indexOf(":"))&&(r=r.substr(n+1));return i==r},createRenderRoot:function(){return this.nodeFactory(this.container.id+"_vmlRoot","div")},createRoot:function(e){return this.nodeFactory(this.container.id+e,"olv:group")},drawPoint:function(e,t){return this.drawCircle(e,t,1)},drawCircle:function(e,t,i){if(!isNaN(t.x)&&!isNaN(t.y)){var n=this.getResolution();e.style.left=((t.x-this.featureDx)/n-this.offset.x|0)-i+"px";e.style.top=(t.y/n-this.offset.y|0)-i+"px";var r=2*i;e.style.width=r+"px";e.style.height=r+"px";return e}return!1},drawLineString:function(e,t){return this.drawLine(e,t,!1)},drawLinearRing:function(e,t){return this.drawLine(e,t,!0)},drawLine:function(e,t,i){this.setNodeDimension(e,t);for(var n,r,s,a=this.getResolution(),o=t.components.length,l=new Array(o),c=0;c<o;c++){r=((n=t.components[c]).x-this.featureDx)/a-this.offset.x|0;s=n.y/a-this.offset.y|0;l[c]=" "+r+","+s+" l "}var u=i?" x e":" e";e.path="m"+l.join("")+u;return e},drawPolygon:function(e,t){this.setNodeDimension(e,t);var i,n,r,s,a,o,l,c,u,h,p=this.getResolution(),d=[];for(i=0,n=t.components.length;i<n;i++){d.push("m");r=t.components[i].components;s=0===i;a=null;o=null;for(l=0,c=r.length;l<c;l++){h=" "+(((u=r[l]).x-this.featureDx)/p-this.offset.x|0)+","+(u.y/p-this.offset.y|0);d.push(h);0==l&&d.push(" l");s||(a?a!=h&&(o?o!=h&&(s=!0):o=h):a=h)}d.push(s?" x ":" ")}d.push("e");e.path=d.join("");return e},drawRectangle:function(e,t){var i=this.getResolution();e.style.left=((t.x-this.featureDx)/i-this.offset.x|0)+"px";e.style.top=(t.y/i-this.offset.y|0)+"px";e.style.width=(t.width/i|0)+"px";e.style.height=(t.height/i|0)+"px";return e},drawText:function(e,t,i){var n=this.nodeFactory(e+this.LABEL_ID_SUFFIX,"olv:rect"),r=this.nodeFactory(e+this.LABEL_ID_SUFFIX+"_textbox","olv:textbox"),s=this.getResolution();n.style.left=((i.x-this.featureDx)/s-this.offset.x|0)+"px";n.style.top=(i.y/s-this.offset.y|0)+"px";n.style.flip="y";r.innerText=t.label;"inherit"!=t.cursor&&null!=t.cursor&&(r.style.cursor=t.cursor);t.fontColor&&(r.style.color=t.fontColor);t.fontOpacity&&(r.style.filter="alpha(opacity="+100*t.fontOpacity+")");t.fontFamily&&(r.style.fontFamily=t.fontFamily);t.fontSize&&(r.style.fontSize=t.fontSize);t.fontWeight&&(r.style.fontWeight=t.fontWeight);t.fontStyle&&(r.style.fontStyle=t.fontStyle);if(!0===t.labelSelect){n._featureId=e;r._featureId=e;r._geometry=i;r._geometryClass=i.CLASS_NAME}r.style.whiteSpace="nowrap";r.inset="1px,0px,0px,0px";if(!n.parentNode){n.appendChild(r);this.textRoot.appendChild(n)}var a=t.labelAlign||"cm";1==a.length&&(a+="m");var o=r.clientWidth*OpenLayers.Renderer.VML.LABEL_SHIFT[a.substr(0,1)],l=r.clientHeight*OpenLayers.Renderer.VML.LABEL_SHIFT[a.substr(1,1)];n.style.left=parseInt(n.style.left)-o-1+"px";n.style.top=parseInt(n.style.top)+l+"px"},moveRoot:function(e){var t=this.map.getLayer(e.container.id);t instanceof OpenLayers.Layer.Vector.RootContainer&&(t=this.map.getLayer(this.container.id));t&&t.renderer.clear();OpenLayers.Renderer.Elements.prototype.moveRoot.apply(this,arguments);t&&t.redraw()},importSymbol:function(e){var t=this.container.id+"-"+e,i=this.symbolCache[t];if(i)return i;var n=OpenLayers.Renderer.symbol[e];if(!n)throw new Error(e+" is not a valid symbol name");for(var r=new OpenLayers.Bounds(Number.MAX_VALUE,Number.MAX_VALUE,0,0),s=["m"],a=0;a<n.length;a+=2){var o=n[a],l=n[a+1];r.left=Math.min(r.left,o);r.bottom=Math.min(r.bottom,l);r.right=Math.max(r.right,o);r.top=Math.max(r.top,l);s.push(o);s.push(l);0==a&&s.push("l")}s.push("x e");var c=s.join(" "),u=(r.getWidth()-r.getHeight())/2;if(u>0){r.bottom=r.bottom-u;r.top=r.top+u}else{r.left=r.left+u;r.right=r.right-u}i={path:c,size:r.getWidth(),left:r.left,bottom:r.bottom};this.symbolCache[t]=i;return i},CLASS_NAME:"OpenLayers.Renderer.VML"});OpenLayers.Renderer.VML.LABEL_SHIFT={l:0,c:.5,r:1,t:0,m:.5,b:1};OpenLayers.Protocol.HTTP=OpenLayers.Class(OpenLayers.Protocol,{url:null,headers:null,params:null,callback:null,scope:null,readWithPOST:!1,updateWithPOST:!1,deleteWithPOST:!1,wildcarded:!1,srsInBBOX:!1,initialize:function(e){e=e||{};this.params={};this.headers={};OpenLayers.Protocol.prototype.initialize.apply(this,arguments);if(!this.filterToParams&&OpenLayers.Format.QueryStringFilter){var t=new OpenLayers.Format.QueryStringFilter({wildcarded:this.wildcarded,srsInBBOX:this.srsInBBOX});this.filterToParams=function(e,i){return t.write(e,i)}}},destroy:function(){this.params=null;this.headers=null;OpenLayers.Protocol.prototype.destroy.apply(this)},read:function(e){OpenLayers.Protocol.prototype.read.apply(this,arguments);(e=e||{}).params=OpenLayers.Util.applyDefaults(e.params,this.options.params);(e=OpenLayers.Util.applyDefaults(e,this.options)).filter&&this.filterToParams&&(e.params=this.filterToParams(e.filter,e.params));var t=void 0!==e.readWithPOST?e.readWithPOST:this.readWithPOST,i=new OpenLayers.Protocol.Response({requestType:"read"});if(t){var n=e.headers||{};n["Content-Type"]="application/x-www-form-urlencoded";i.priv=OpenLayers.Request.POST({url:e.url,callback:this.createCallback(this.handleRead,i,e),data:OpenLayers.Util.getParameterString(e.params),headers:n})}else i.priv=OpenLayers.Request.GET({url:e.url,callback:this.createCallback(this.handleRead,i,e),params:e.params,headers:e.headers});return i},handleRead:function(e,t){this.handleResponse(e,t)},create:function(e,t){t=OpenLayers.Util.applyDefaults(t,this.options);var i=new OpenLayers.Protocol.Response({reqFeatures:e,requestType:"create"});i.priv=OpenLayers.Request.POST({url:t.url,callback:this.createCallback(this.handleCreate,i,t),headers:t.headers,data:this.format.write(e)});return i},handleCreate:function(e,t){this.handleResponse(e,t)},update:function(e,t){var i=(t=t||{}).url||e.url||this.options.url+"/"+e.fid;t=OpenLayers.Util.applyDefaults(t,this.options);var n=new OpenLayers.Protocol.Response({reqFeatures:e,requestType:"update"}),r=this.updateWithPOST?"POST":"PUT";n.priv=OpenLayers.Request[r]({url:i,callback:this.createCallback(this.handleUpdate,n,t),headers:t.headers,data:this.format.write(e)});return n},handleUpdate:function(e,t){this.handleResponse(e,t)},delete:function(e,t){var i=(t=t||{}).url||e.url||this.options.url+"/"+e.fid;t=OpenLayers.Util.applyDefaults(t,this.options);var n=new OpenLayers.Protocol.Response({reqFeatures:e,requestType:"delete"}),r=this.deleteWithPOST?"POST":"DELETE",s={url:i,callback:this.createCallback(this.handleDelete,n,t),headers:t.headers};this.deleteWithPOST&&(s.data=this.format.write(e));n.priv=OpenLayers.Request[r](s);return n},handleDelete:function(e,t){this.handleResponse(e,t)},handleResponse:function(e,t){var i=e.priv;if(t.callback){if(i.status>=200&&i.status<300){"delete"!=e.requestType&&(e.features=this.parseFeatures(i));e.code=OpenLayers.Protocol.Response.SUCCESS}else e.code=OpenLayers.Protocol.Response.FAILURE;t.callback.call(t.scope,e)}},parseFeatures:function(e){var t=e.responseXML;t&&t.documentElement||(t=e.responseText);return!t||t.length<=0?null:this.format.read(t)},commit:function(e,t){t=OpenLayers.Util.applyDefaults(t,this.options);var i=[],n=0,r={};r[OpenLayers.State.INSERT]=[];r[OpenLayers.State.UPDATE]=[];r[OpenLayers.State.DELETE]=[];for(var s,a,o=[],l=0,c=e.length;l<c;++l)if(a=r[(s=e[l]).state]){a.push(s);o.push(s)}var u=(r[OpenLayers.State.INSERT].length>0?1:0)+r[OpenLayers.State.UPDATE].length+r[OpenLayers.State.DELETE].length,h=!0,p=new OpenLayers.Protocol.Response({reqFeatures:o});function d(e){this.callUserCallback(e,t);h=h&&e.success();if(++n>=u&&t.callback){p.code=h?OpenLayers.Protocol.Response.SUCCESS:OpenLayers.Protocol.Response.FAILURE;t.callback.apply(t.scope,[p])}}var f=r[OpenLayers.State.INSERT];f.length>0&&i.push(this.create(f,OpenLayers.Util.applyDefaults({callback:function(e){for(var t=e.features?e.features.length:0,i=new Array(t),n=0;n<t;++n)i[n]=e.features[n].fid;p.insertIds=i;d.apply(this,[e])},scope:this},t.create)));for(l=(f=r[OpenLayers.State.UPDATE]).length-1;l>=0;--l)i.push(this.update(f[l],OpenLayers.Util.applyDefaults({callback:d,scope:this},t.update)));for(l=(f=r[OpenLayers.State.DELETE]).length-1;l>=0;--l)i.push(this.delete(f[l],OpenLayers.Util.applyDefaults({callback:d,scope:this},t.delete)));return i},abort:function(e){e&&e.priv.abort()},callUserCallback:function(e,t){var i=t[e.requestType];i&&i.callback&&i.callback.call(i.scope,e)},CLASS_NAME:"OpenLayers.Protocol.HTTP"});OpenLayers.Handler.Feature=OpenLayers.Class(OpenLayers.Handler,{EVENTMAP:{click:{in:"click",out:"clickout"},mousemove:{in:"over",out:"out"},dblclick:{in:"dblclick",out:null},mousedown:{in:null,out:null},mouseup:{in:null,out:null},touchstart:{in:"click",out:"clickout"}},feature:null,lastFeature:null,down:null,up:null,clickTolerance:4,geometryTypes:null,stopClick:!0,stopDown:!0,stopUp:!1,initialize:function(e,t,i,n){OpenLayers.Handler.prototype.initialize.apply(this,[e,i,n]);this.layer=t},touchstart:function(e){this.startTouch();return!!OpenLayers.Event.isMultiTouch(e)||this.mousedown(e)},touchmove:function(e){OpenLayers.Event.preventDefault(e)},mousedown:function(e){(OpenLayers.Event.isLeftClick(e)||OpenLayers.Event.isSingleTouch(e))&&(this.down=e.xy);return!this.handle(e)||!this.stopDown},mouseup:function(e){this.up=e.xy;return!this.handle(e)||!this.stopUp},click:function(e){return!this.handle(e)||!this.stopClick},mousemove:function(e){if(!this.callbacks.over&&!this.callbacks.out)return!0;this.handle(e);return!0},dblclick:function(e){return!this.handle(e)},geometryTypeMatches:function(e){return null==this.geometryTypes||OpenLayers.Util.indexOf(this.geometryTypes,e.geometry.CLASS_NAME)>-1},handle:function(e){this.feature&&!this.feature.layer&&(this.feature=null);var t=e.type,i=!1,n=!!this.feature,r="click"==t||"dblclick"==t||"touchstart"==t;this.feature=this.layer.getFeatureFromEvent(e);this.feature&&!this.feature.layer&&(this.feature=null);this.lastFeature&&!this.lastFeature.layer&&(this.lastFeature=null);if(this.feature){"touchstart"===t&&OpenLayers.Event.preventDefault(e);var s=this.feature!=this.lastFeature;if(this.geometryTypeMatches(this.feature)){if(n&&s){this.lastFeature&&this.triggerCallback(t,"out",[this.lastFeature]);this.triggerCallback(t,"in",[this.feature])}else n&&!r||this.triggerCallback(t,"in",[this.feature]);this.lastFeature=this.feature;i=!0}else{this.lastFeature&&(n&&s||r)&&this.triggerCallback(t,"out",[this.lastFeature]);this.feature=null}}else this.lastFeature&&(n||r)&&this.triggerCallback(t,"out",[this.lastFeature]);return i},triggerCallback:function(e,t,i){var n=this.EVENTMAP[e][t];if(n)if("click"==e&&this.up&&this.down){Math.sqrt(Math.pow(this.up.x-this.down.x,2)+Math.pow(this.up.y-this.down.y,2))<=this.clickTolerance&&this.callback(n,i);this.up=this.down=null}else this.callback(n,i)},activate:function(){var e=!1;if(OpenLayers.Handler.prototype.activate.apply(this,arguments)){this.moveLayerToTop();this.map.events.on({removelayer:this.handleMapEvents,changelayer:this.handleMapEvents,scope:this});e=!0}return e},deactivate:function(){var e=!1;if(OpenLayers.Handler.prototype.deactivate.apply(this,arguments)){this.moveLayerBack();this.feature=null;this.lastFeature=null;this.down=null;this.up=null;this.map.events.un({removelayer:this.handleMapEvents,changelayer:this.handleMapEvents,scope:this});e=!0}return e},handleMapEvents:function(e){"removelayer"!=e.type&&"order"!=e.property||this.moveLayerToTop()},moveLayerToTop:function(){var e=Math.max(this.map.Z_INDEX_BASE.Feature-1,this.layer.getZIndex())+1;this.layer.setZIndex(e)},moveLayerBack:function(){var e=this.layer.getZIndex()-1;e>=this.map.Z_INDEX_BASE.Feature?this.layer.setZIndex(e):this.map.setLayerZIndex(this.layer,this.map.getLayerIndex(this.layer))},CLASS_NAME:"OpenLayers.Handler.Feature"});OpenLayers.Control.DragFeature=OpenLayers.Class(OpenLayers.Control,{geometryTypes:null,onStart:function(e,t){},onDrag:function(e,t){},onComplete:function(e,t){},onEnter:function(e){},onLeave:function(e){},documentDrag:!1,layer:null,feature:null,dragCallbacks:{},featureCallbacks:{},lastPixel:null,initialize:function(e,t){OpenLayers.Control.prototype.initialize.apply(this,[t]);this.layer=e;this.handlers={drag:new OpenLayers.Handler.Drag(this,OpenLayers.Util.extend({down:this.downFeature,move:this.moveFeature,up:this.upFeature,out:this.cancel,done:this.doneDragging},this.dragCallbacks),{documentDrag:this.documentDrag}),feature:new OpenLayers.Handler.Feature(this,this.layer,OpenLayers.Util.extend({click:this.clickFeature,clickout:this.clickoutFeature,over:this.overFeature,out:this.outFeature},this.featureCallbacks),{geometryTypes:this.geometryTypes})}},clickFeature:function(e){if(this.handlers.feature.touch&&!this.over&&this.overFeature(e)){this.handlers.drag.dragstart(this.handlers.feature.evt);this.handlers.drag.stopDown=!1}},clickoutFeature:function(e){if(this.handlers.feature.touch&&this.over){this.outFeature(e);this.handlers.drag.stopDown=!0}},destroy:function(){this.layer=null;OpenLayers.Control.prototype.destroy.apply(this,[])},activate:function(){return this.handlers.feature.activate()&&OpenLayers.Control.prototype.activate.apply(this,arguments)},deactivate:function(){this.handlers.drag.deactivate();this.handlers.feature.deactivate();this.feature=null;this.dragging=!1;this.lastPixel=null;OpenLayers.Element.removeClass(this.map.viewPortDiv,this.displayClass+"Over");return OpenLayers.Control.prototype.deactivate.apply(this,arguments)},overFeature:function(e){var t=!1;if(this.handlers.drag.dragging)this.feature.id==e.id?this.over=!0:this.over=!1;else{this.feature=e;this.handlers.drag.activate();t=!0;this.over=!0;OpenLayers.Element.addClass(this.map.viewPortDiv,this.displayClass+"Over");this.onEnter(e)}return t},downFeature:function(e){this.lastPixel=e;this.onStart(this.feature,e)},moveFeature:function(e){var t=this.map.getResolution();this.feature.geometry.move(t*(e.x-this.lastPixel.x),t*(this.lastPixel.y-e.y));this.layer.drawFeature(this.feature);this.lastPixel=e;this.onDrag(this.feature,e)},upFeature:function(e){this.over||this.handlers.drag.deactivate()},doneDragging:function(e){this.onComplete(this.feature,e)},outFeature:function(e){if(this.handlers.drag.dragging)this.feature.id==e.id&&(this.over=!1);else{this.over=!1;this.handlers.drag.deactivate();OpenLayers.Element.removeClass(this.map.viewPortDiv,this.displayClass+"Over");this.onLeave(e);this.feature=null}},cancel:function(){this.handlers.drag.deactivate();this.over=!1},setMap:function(e){this.handlers.drag.setMap(e);this.handlers.feature.setMap(e);OpenLayers.Control.prototype.setMap.apply(this,arguments)},CLASS_NAME:"OpenLayers.Control.DragFeature"});OpenLayers.Format.WMSGetFeatureInfo=OpenLayers.Class(OpenLayers.Format.XML,{layerIdentifier:"_layer",featureIdentifier:"_feature",regExes:{trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g},gmlFormat:null,read:function(e){var t;"string"==typeof e&&(e=OpenLayers.Format.XML.prototype.read.apply(this,[e]));var i=e.documentElement;if(i){var n=this["read_"+i.nodeName];t=n?n.call(this,i):new OpenLayers.Format.GML(this.options?this.options:{}).read(e)}else t=e;return t},read_msGMLOutput:function(e){var t=[],i=this.getSiblingNodesByTagCriteria(e,this.layerIdentifier);if(i)for(var n=0,r=i.length;n<r;++n){var s=i[n],a=s.nodeName;s.prefix&&(a=a.split(":")[1]);a=a.replace(this.layerIdentifier,"");var o=this.getSiblingNodesByTagCriteria(s,this.featureIdentifier);if(o)for(var l=0;l<o.length;l++){var c=o[l],u=this.parseGeometry(c),h=this.parseAttributes(c),p=new OpenLayers.Feature.Vector(u.geometry,h,null);p.bounds=u.bounds;p.type=a;t.push(p)}}return t},read_FeatureInfoResponse:function(e){for(var t=[],i=this.getElementsByTagNameNS(e,"*","FIELDS"),n=0,r=i.length;n<r;n++){var s,a=i[n],o={},l=a.attributes.length;if(l>0)for(s=0;s<l;s++){var c=a.attributes[s];o[c.nodeName]=c.nodeValue}else{var u=a.childNodes;for(s=0,l=u.length;s<l;++s){var h=u[s];3!=h.nodeType&&(o[h.getAttribute("name")]=h.getAttribute("value"))}}t.push(new OpenLayers.Feature.Vector(null,o,null))}return t},getSiblingNodesByTagCriteria:function(e,t){var i,n,r,s,a,o=[];if(e&&e.hasChildNodes()){r=(i=e.childNodes).length;for(var l=0;l<r;l++){a=i[l];for(;a&&1!=a.nodeType;){a=a.nextSibling;l++}(n=a?a.nodeName:"").length>0&&n.indexOf(t)>-1?o.push(a):(s=this.getSiblingNodesByTagCriteria(a,t)).length>0&&(0==o.length?o=s:o.push(s))}}return o},parseAttributes:function(e){var t={};if(1==e.nodeType)for(var i=e.childNodes,n=i.length,r=0;r<n;++r){var s=i[r];if(1==s.nodeType){var a=s.childNodes,o=s.prefix?s.nodeName.split(":")[1]:s.nodeName;if(0==a.length)t[o]=null;else if(1==a.length){var l=a[0];if(3==l.nodeType||4==l.nodeType){var c=l.nodeValue.replace(this.regExes.trimSpace,"");t[o]=c}}}}return t},parseGeometry:function(e){this.gmlFormat||(this.gmlFormat=new OpenLayers.Format.GML);var t,i=this.gmlFormat.parseFeature(e),n=null;if(i){t=i.geometry&&i.geometry.clone();n=i.bounds&&i.bounds.clone();i.destroy()}return{geometry:t,bounds:n}},CLASS_NAME:"OpenLayers.Format.WMSGetFeatureInfo"});OpenLayers.Control.WMSGetFeatureInfo=OpenLayers.Class(OpenLayers.Control,{hover:!1,drillDown:!1,maxFeatures:10,clickCallback:"click",output:"features",layers:null,queryVisible:!1,url:null,layerUrls:null,infoFormat:"text/html",vendorParams:{},format:null,formatOptions:null,handler:null,hoverRequest:null,initialize:function(e){(e=e||{}).handlerOptions=e.handlerOptions||{};OpenLayers.Control.prototype.initialize.apply(this,[e]);this.format||(this.format=new OpenLayers.Format.WMSGetFeatureInfo(e.formatOptions));!0===this.drillDown&&(this.hover=!1);if(this.hover)this.handler=new OpenLayers.Handler.Hover(this,{move:this.cancelHover,pause:this.getInfoForHover},OpenLayers.Util.extend(this.handlerOptions.hover||{},{delay:250}));else{var t={};t[this.clickCallback]=this.getInfoForClick;this.handler=new OpenLayers.Handler.Click(this,t,this.handlerOptions.click||{})}},getInfoForClick:function(e){this.events.triggerEvent("beforegetfeatureinfo",{xy:e.xy});OpenLayers.Element.addClass(this.map.viewPortDiv,"olCursorWait");this.request(e.xy,{})},getInfoForHover:function(e){this.events.triggerEvent("beforegetfeatureinfo",{xy:e.xy});this.request(e.xy,{hover:!0})},cancelHover:function(){if(this.hoverRequest){this.hoverRequest.abort();this.hoverRequest=null}},findLayers:function(){for(var e,t,i=this.layers||this.map.layers,n=[],r=i.length-1;r>=0;--r)if((e=i[r])instanceof OpenLayers.Layer.WMS&&(!this.queryVisible||e.getVisibility())){t=OpenLayers.Util.isArray(e.url)?e.url[0]:e.url;!1!==this.drillDown||this.url||(this.url=t);(!0===this.drillDown||this.urlMatches(t))&&n.push(e)}return n},urlMatches:function(e){var t=OpenLayers.Util.isEquivalentUrl(this.url,e);if(!t&&this.layerUrls)for(var i=0,n=this.layerUrls.length;i<n;++i)if(OpenLayers.Util.isEquivalentUrl(this.layerUrls[i],e)){t=!0;break}return t},buildWMSOptions:function(e,t,i,n){for(var r=[],s=[],a=0,o=t.length;a<o;a++)if(null!=t[a].params.LAYERS){r=r.concat(t[a].params.LAYERS);s=s.concat(this.getStyleNames(t[a]))}var l=t[0],c=this.map.getProjection(),u=l.projection;u&&u.equals(this.map.getProjectionObject())&&(c=u.getCode());var h=OpenLayers.Util.extend({service:"WMS",version:l.params.VERSION,request:"GetFeatureInfo",exceptions:l.params.EXCEPTIONS,bbox:this.map.getExtent().toBBOX(null,l.reverseAxisOrder()),feature_count:this.maxFeatures,height:this.map.getSize().h,width:this.map.getSize().w,format:n,info_format:l.params.INFO_FORMAT||this.infoFormat},parseFloat(l.params.VERSION)>=1.3?{crs:c,i:parseInt(i.x),j:parseInt(i.y)}:{srs:c,x:parseInt(i.x),y:parseInt(i.y)});0!=r.length&&(h=OpenLayers.Util.extend({layers:r,query_layers:r,styles:s},h));OpenLayers.Util.applyDefaults(h,this.vendorParams);return{url:e,params:OpenLayers.Util.upperCaseObject(h),callback:function(t){this.handleResponse(i,t,e)},scope:this}},getStyleNames:function(e){return e.params.STYLES?e.params.STYLES:OpenLayers.Util.isArray(e.params.LAYERS)?new Array(e.params.LAYERS.length):e.params.LAYERS.replace(/[^,]/g,"")},request:function(e,t){if(0!=(r=this.findLayers()).length){t=t||{};if(!1===this.drillDown){var i=this.buildWMSOptions(this.url,r,e,r[0].params.FORMAT),n=OpenLayers.Request.GET(i);!0===t.hover&&(this.hoverRequest=n)}else{this._requestCount=0;this._numRequests=0;this.features=[];for(var r,s={},a=0,o=r.length;a<o;a++){var l=r[a];if((c=OpenLayers.Util.isArray(l.url)?l.url[0]:l.url)in s)s[c].push(l);else{this._numRequests++;s[c]=[l]}}for(var c in s){r=s[c];i=this.buildWMSOptions(c,r,e,r[0].params.FORMAT);OpenLayers.Request.GET(i)}}}else{this.events.triggerEvent("nogetfeatureinfo");OpenLayers.Element.removeClass(this.map.viewPortDiv,"olCursorWait")}},triggerGetFeatureInfo:function(e,t,i){this.events.triggerEvent("getfeatureinfo",{text:e.responseText,features:i,request:e,xy:t});OpenLayers.Element.removeClass(this.map.viewPortDiv,"olCursorWait")},handleResponse:function(e,t,i){var n=t.responseXML;n&&n.documentElement||(n=t.responseText);var r=this.format.read(n);if(!1===this.drillDown)this.triggerGetFeatureInfo(t,e,r);else{this._requestCount++;"object"===this.output?this._features=(this._features||[]).concat({url:i,features:r}):this._features=(this._features||[]).concat(r);if(this._requestCount===this._numRequests){this.triggerGetFeatureInfo(t,e,this._features.concat());delete this._features;delete this._requestCount;delete this._numRequests}}},CLASS_NAME:"OpenLayers.Control.WMSGetFeatureInfo"});OpenLayers.Protocol.WFS.v1_1_0=OpenLayers.Class(OpenLayers.Protocol.WFS.v1,{version:"1.1.0",initialize:function(e){OpenLayers.Protocol.WFS.v1.prototype.initialize.apply(this,arguments);this.outputFormat&&!this.readFormat&&("gml2"==this.outputFormat.toLowerCase()?this.readFormat=new OpenLayers.Format.GML.v2({featureType:this.featureType,featureNS:this.featureNS,geometryName:this.geometryName}):"json"==this.outputFormat.toLowerCase()&&(this.readFormat=new OpenLayers.Format.GeoJSON))},CLASS_NAME:"OpenLayers.Protocol.WFS.v1_1_0"});OpenLayers.Control.PinchZoom=OpenLayers.Class(OpenLayers.Control,{type:OpenLayers.Control.TYPE_TOOL,pinchOrigin:null,currentCenter:null,autoActivate:!0,preserveCenter:!1,initialize:function(e){OpenLayers.Control.prototype.initialize.apply(this,arguments);this.handler=new OpenLayers.Handler.Pinch(this,{start:this.pinchStart,move:this.pinchMove,done:this.pinchDone},this.handlerOptions)},pinchStart:function(e,t){var i=this.preserveCenter?this.map.getPixelFromLonLat(this.map.getCenter()):e.xy;this.pinchOrigin=i;this.currentCenter=i},pinchMove:function(e,t){var i=t.scale,n=this.map.layerContainerOriginPx,r=this.pinchOrigin,s=this.preserveCenter?this.map.getPixelFromLonLat(this.map.getCenter()):e.xy,a=Math.round(n.x+s.x-r.x+(i-1)*(n.x-r.x)),o=Math.round(n.y+s.y-r.y+(i-1)*(n.y-r.y));this.map.applyTransform(a,o,i);this.currentCenter=s},pinchDone:function(e,t,i){this.map.applyTransform();var n=this.map.getZoomForResolution(this.map.getResolution()/i.scale,!0);if(n!==this.map.getZoom()||!this.currentCenter.equals(this.pinchOrigin)){var r=this.map.getResolutionForZoom(n),s=this.map.getLonLatFromPixel(this.pinchOrigin),a=this.currentCenter,o=this.map.getSize();s.lon+=r*(o.w/2-a.x);s.lat-=r*(o.h/2-a.y);this.map.div.clientWidth=this.map.div.clientWidth;this.map.setCenter(s,n)}},CLASS_NAME:"OpenLayers.Control.PinchZoom"});OpenLayers.Format.WMSCapabilities.v1_1_1=OpenLayers.Class(OpenLayers.Format.WMSCapabilities.v1_1,{version:"1.1.1",readers:{wms:OpenLayers.Util.applyDefaults({SRS:function(e,t){t.srs[this.getChildValue(e)]=!0}},OpenLayers.Format.WMSCapabilities.v1_1.prototype.readers.wms)},CLASS_NAME:"OpenLayers.Format.WMSCapabilities.v1_1_1"});var Proj4js={defaultDatum:"WGS84",transform:function(e,t,i){if(!e.readyToUse){this.reportError("Proj4js initialization for:"+e.srsCode+" not yet complete");return i}if(!t.readyToUse){this.reportError("Proj4js initialization for:"+t.srsCode+" not yet complete");return i}if(e.datum&&t.datum&&((e.datum.datum_type==Proj4js.common.PJD_3PARAM||e.datum.datum_type==Proj4js.common.PJD_7PARAM)&&"WGS84"!=t.datumCode||(t.datum.datum_type==Proj4js.common.PJD_3PARAM||t.datum.datum_type==Proj4js.common.PJD_7PARAM)&&"WGS84"!=e.datumCode)){var n=Proj4js.WGS84;this.transform(e,n,i);e=n}"enu"!=e.axis&&this.adjust_axis(e,!1,i);if("longlat"==e.projName){i.x*=Proj4js.common.D2R;i.y*=Proj4js.common.D2R}else{if(e.to_meter){i.x*=e.to_meter;i.y*=e.to_meter}e.inverse(i)}e.from_greenwich&&(i.x+=e.from_greenwich);i=this.datum_transform(e.datum,t.datum,i);t.from_greenwich&&(i.x-=t.from_greenwich);if("longlat"==t.projName){i.x*=Proj4js.common.R2D;i.y*=Proj4js.common.R2D}else{t.forward(i);if(t.to_meter){i.x/=t.to_meter;i.y/=t.to_meter}}"enu"!=t.axis&&this.adjust_axis(t,!0,i);return i},datum_transform:function(e,t,i){if(e.compare_datums(t))return i;if(e.datum_type==Proj4js.common.PJD_NODATUM||t.datum_type==Proj4js.common.PJD_NODATUM)return i;if(e.es!=t.es||e.a!=t.a||e.datum_type==Proj4js.common.PJD_3PARAM||e.datum_type==Proj4js.common.PJD_7PARAM||t.datum_type==Proj4js.common.PJD_3PARAM||t.datum_type==Proj4js.common.PJD_7PARAM){e.geodetic_to_geocentric(i);e.datum_type!=Proj4js.common.PJD_3PARAM&&e.datum_type!=Proj4js.common.PJD_7PARAM||e.geocentric_to_wgs84(i);t.datum_type!=Proj4js.common.PJD_3PARAM&&t.datum_type!=Proj4js.common.PJD_7PARAM||t.geocentric_from_wgs84(i);t.geocentric_to_geodetic(i)}return i},adjust_axis:function(e,t,i){for(var n,r,s=i.x,a=i.y,o=i.z||0,l=0;l<3;l++)if(!t||2!=l||void 0!==i.z){if(0==l){n=s;r="x"}else if(1==l){n=a;r="y"}else{n=o;r="z"}switch(e.axis[l]){case"e":i[r]=n;break;case"w":i[r]=-n;break;case"n":i[r]=n;break;case"s":i[r]=-n;break;case"u":void 0!==i[r]&&(i.z=n);break;case"d":void 0!==i[r]&&(i.z=-n);break;default:alert("ERROR: unknow axis ("+e.axis[l]+") - check definition of "+e.projName);return null}}return i},reportError:function(e){},extend:function(e,t){e=e||{};if(t)for(var i in t){var n=t[i];void 0!==n&&(e[i]=n)}return e},Class:function(){for(var e,t=function(){this.initialize.apply(this,arguments)},i={},n=0;n<arguments.length;++n){e="function"==typeof arguments[n]?arguments[n].prototype:arguments[n];Proj4js.extend(i,e)}t.prototype=i;return t},bind:function(e,t){var i=Array.prototype.slice.apply(arguments,[2]);return function(){var n=i.concat(Array.prototype.slice.apply(arguments,[0]));return e.apply(t,n)}},scriptName:"proj4js-combined.js",defsLookupService:"http://spatialreference.org/ref",libPath:null,getScriptLocation:function(){if(this.libPath)return this.libPath;for(var e=this.scriptName,t=e.length,i=document.getElementsByTagName("script"),n=0;n<i.length;n++){var r=i[n].getAttribute("src");if(r){var s=r.lastIndexOf(e);if(s>-1&&s+t==r.length){this.libPath=r.slice(0,-t);break}}}return this.libPath||""},loadScript:function(e,t,i,n){var r=document.createElement("script");r.defer=!1;r.type="text/javascript";r.id=e;r.src=e;r.onload=t;r.onerror=i;r.loadCheck=n;/MSIE/.test(navigator.userAgent)&&(r.onreadystatechange=this.checkReadyState);document.getElementsByTagName("head")[0].appendChild(r)},checkReadyState:function(){"loaded"==this.readyState&&(this.loadCheck()?this.onload():this.onerror())}},QRCode;Proj4js.Proj=Proj4js.Class({readyToUse:!1,title:null,projName:null,units:null,datum:null,x0:0,y0:0,localCS:!1,queue:null,initialize:function(e,t){this.srsCodeInput=e;this.queue=[];t&&this.queue.push(t);if(e.indexOf("GEOGCS")>=0||e.indexOf("GEOCCS")>=0||e.indexOf("PROJCS")>=0||e.indexOf("LOCAL_CS")>=0){this.parseWKT(e);this.deriveConstants();this.loadProjCode(this.projName)}else{if(0==e.indexOf("urn:")){var i=e.split(":");"ogc"!=i[1]&&"x-ogc"!=i[1]||"def"!=i[2]||"crs"!=i[3]||(e=i[4]+":"+i[i.length-1])}else if(0==e.indexOf("http://")){var n=e.split("#");n[0].match(/epsg.org/)?e="EPSG:"+n[1]:n[0].match(/RIG.xml/)&&(e="IGNF:"+n[1])}this.srsCode=e.toUpperCase();if(0==this.srsCode.indexOf("EPSG")){this.srsCode=this.srsCode;this.srsAuth="epsg";this.srsProjNumber=this.srsCode.substring(5)}else if(0==this.srsCode.indexOf("IGNF")){this.srsCode=this.srsCode;this.srsAuth="IGNF";this.srsProjNumber=this.srsCode.substring(5)}else if(0==this.srsCode.indexOf("CRS")){this.srsCode=this.srsCode;this.srsAuth="CRS";this.srsProjNumber=this.srsCode.substring(4)}else{this.srsAuth="";this.srsProjNumber=this.srsCode}this.loadProjDefinition()}},loadProjDefinition:function(){if(Proj4js.defs[this.srsCode])this.defsLoaded();else{var e=Proj4js.getScriptLocation()+"defs/"+this.srsAuth.toUpperCase()+this.srsProjNumber+".js";Proj4js.loadScript(e,Proj4js.bind(this.defsLoaded,this),Proj4js.bind(this.loadFromService,this),Proj4js.bind(this.checkDefsLoaded,this))}},loadFromService:function(){var e=Proj4js.defsLookupService+"/"+this.srsAuth+"/"+this.srsProjNumber+"/proj4js/";Proj4js.loadScript(e,Proj4js.bind(this.defsLoaded,this),Proj4js.bind(this.defsFailed,this),Proj4js.bind(this.checkDefsLoaded,this))},defsLoaded:function(){this.parseDefs();this.loadProjCode(this.projName)},checkDefsLoaded:function(){return!!Proj4js.defs[this.srsCode]},defsFailed:function(){Proj4js.reportError("failed to load projection definition for: "+this.srsCode);Proj4js.defs[this.srsCode]=Proj4js.defs.WGS84;this.defsLoaded()},loadProjCode:function(e){if(Proj4js.Proj[e])this.initTransforms();else{var t=Proj4js.getScriptLocation()+"projCode/"+e+".js";Proj4js.loadScript(t,Proj4js.bind(this.loadProjCodeSuccess,this,e),Proj4js.bind(this.loadProjCodeFailure,this,e),Proj4js.bind(this.checkCodeLoaded,this,e))}},loadProjCodeSuccess:function(e){Proj4js.Proj[e].dependsOn?this.loadProjCode(Proj4js.Proj[e].dependsOn):this.initTransforms()},loadProjCodeFailure:function(e){Proj4js.reportError("failed to find projection file for: "+e)},checkCodeLoaded:function(e){return!!Proj4js.Proj[e]},initTransforms:function(){Proj4js.extend(this,Proj4js.Proj[this.projName]);this.init();this.readyToUse=!0;if(this.queue)for(var e;e=this.queue.shift();)e.call(this,this)},wktRE:/^(\w+)\[(.*)\]$/,parseWKT:function(e){var t=e.match(this.wktRE);if(t){var i,n=t[1],r=t[2].split(",");i=(i=(i="TOWGS84"==n.toUpperCase()?n:r.shift()).replace(/^\"/,"")).replace(/\"$/,"");for(var s=new Array,a=0,o="",l=0;l<r.length;++l){for(var c=r[l],u=0;u<c.length;++u){"["==c.charAt(u)&&++a;"]"==c.charAt(u)&&--a}o+=c;if(0===a){s.push(o);o=""}else o+=","}switch(n){case"LOCAL_CS":this.projName="identity";this.localCS=!0;this.srsCode=i;break;case"GEOGCS":this.projName="longlat";this.geocsCode=i;this.srsCode||(this.srsCode=i);break;case"PROJCS":this.srsCode=i;break;case"GEOCCS":break;case"PROJECTION":this.projName=Proj4js.wktProjections[i];break;case"DATUM":this.datumName=i;break;case"LOCAL_DATUM":this.datumCode="none";break;case"SPHEROID":this.ellps=i;this.a=parseFloat(s.shift());this.rf=parseFloat(s.shift());break;case"PRIMEM":this.from_greenwich=parseFloat(s.shift());break;case"UNIT":this.units=i;this.unitsPerMeter=parseFloat(s.shift());break;case"PARAMETER":var h=i.toLowerCase(),p=parseFloat(s.shift());switch(h){case"false_easting":this.x0=p;break;case"false_northing":this.y0=p;break;case"scale_factor":this.k0=p;break;case"central_meridian":this.long0=p*Proj4js.common.D2R;break;case"latitude_of_origin":this.lat0=p*Proj4js.common.D2R}break;case"TOWGS84":this.datum_params=s;break;case"AXIS":h=i.toLowerCase();switch(p=s.shift()){case"EAST":p="e";break;case"WEST":p="w";break;case"NORTH":p="n";break;case"SOUTH":p="s";break;case"UP":p="u";break;case"DOWN":p="d";break;case"OTHER":default:p=" "}this.axis||(this.axis="enu");switch(h){case"x":this.axis=p+this.axis.substr(1,2);break;case"y":this.axis=this.axis.substr(0,1)+p+this.axis.substr(2,1);break;case"z":this.axis=this.axis.substr(0,2)+p}}for(l=0;l<s.length;++l)this.parseWKT(s[l])}},parseDefs:function(){this.defData=Proj4js.defs[this.srsCode];var e,t;if(this.defData){for(var i=this.defData.split("+"),n=0;n<i.length;n++){var r=i[n].split("=");e=r[0].toLowerCase();t=r[1];switch(e.replace(/\s/gi,"")){case"":break;case"title":this.title=t;break;case"proj":this.projName=t.replace(/\s/gi,"");break;case"units":this.units=t.replace(/\s/gi,"");break;case"datum":this.datumCode=t.replace(/\s/gi,"");break;case"nadgrids":this.nagrids=t.replace(/\s/gi,"");break;case"ellps":this.ellps=t.replace(/\s/gi,"");break;case"a":this.a=parseFloat(t);break;case"b":this.b=parseFloat(t);break;case"rf":this.rf=parseFloat(t);break;case"lat_0":this.lat0=t*Proj4js.common.D2R;break;case"lat_1":this.lat1=t*Proj4js.common.D2R;break;case"lat_2":this.lat2=t*Proj4js.common.D2R;break;case"lat_ts":this.lat_ts=t*Proj4js.common.D2R;break;case"lon_0":this.long0=t*Proj4js.common.D2R;break;case"alpha":this.alpha=parseFloat(t)*Proj4js.common.D2R;break;case"lonc":this.longc=t*Proj4js.common.D2R;break;case"x_0":this.x0=parseFloat(t);break;case"y_0":this.y0=parseFloat(t);break;case"k_0":case"k":this.k0=parseFloat(t);break;case"r_a":this.R_A=!0;break;case"zone":this.zone=parseInt(t,10);break;case"south":this.utmSouth=!0;break;case"towgs84":this.datum_params=t.split(",");break;case"to_meter":this.to_meter=parseFloat(t);break;case"from_greenwich":this.from_greenwich=t*Proj4js.common.D2R;break;case"pm":t=t.replace(/\s/gi,"");this.from_greenwich=Proj4js.PrimeMeridian[t]?Proj4js.PrimeMeridian[t]:parseFloat(t);this.from_greenwich*=Proj4js.common.D2R;break;case"axis":3==(t=t.replace(/\s/gi,"")).length&&-1!="ewnsud".indexOf(t.substr(0,1))&&-1!="ewnsud".indexOf(t.substr(1,1))&&-1!="ewnsud".indexOf(t.substr(2,1))&&(this.axis=t)}}this.deriveConstants()}},deriveConstants:function(){"@null"==this.nagrids&&(this.datumCode="none");if(this.datumCode&&"none"!=this.datumCode){var e=Proj4js.Datum[this.datumCode];if(e){this.datum_params=e.towgs84?e.towgs84.split(","):null;this.ellps=e.ellipse;this.datumName=e.datumName?e.datumName:this.datumCode}}if(!this.a){var t=Proj4js.Ellipsoid[this.ellps]?Proj4js.Ellipsoid[this.ellps]:Proj4js.Ellipsoid.WGS84;Proj4js.extend(this,t)}this.rf&&!this.b&&(this.b=(1-1/this.rf)*this.a);if(0===this.rf||Math.abs(this.a-this.b)<Proj4js.common.EPSLN){this.sphere=!0;this.b=this.a}this.a2=this.a*this.a;this.b2=this.b*this.b;this.es=(this.a2-this.b2)/this.a2;this.e=Math.sqrt(this.es);if(this.R_A){this.a*=1-this.es*(Proj4js.common.SIXTH+this.es*(Proj4js.common.RA4+this.es*Proj4js.common.RA6));this.a2=this.a*this.a;this.b2=this.b*this.b;this.es=0}this.ep2=(this.a2-this.b2)/this.b2;this.k0||(this.k0=1);this.axis||(this.axis="enu");this.datum=new Proj4js.datum(this)}});Proj4js.Proj.longlat={init:function(){},forward:function(e){return e},inverse:function(e){return e}};Proj4js.Proj.identity=Proj4js.Proj.longlat;Proj4js.defs={WGS84:"+title=long/lat:WGS84 +proj=longlat +ellps=WGS84 +datum=WGS84 +units=degrees","EPSG:4326":"+title=long/lat:WGS84 +proj=longlat +a=6378137.0 +b=6356752.31424518 +ellps=WGS84 +datum=WGS84 +units=degrees","EPSG:4269":"+title=long/lat:NAD83 +proj=longlat +a=6378137.0 +b=6356752.31414036 +ellps=GRS80 +datum=NAD83 +units=degrees","EPSG:3875":"+title= Google Mercator +proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs"};Proj4js.defs["EPSG:3785"]=Proj4js.defs["EPSG:3875"];Proj4js.defs.GOOGLE=Proj4js.defs["EPSG:3875"];Proj4js.defs["EPSG:900913"]=Proj4js.defs["EPSG:3875"];Proj4js.defs["EPSG:102113"]=Proj4js.defs["EPSG:3875"];Proj4js.common={PI:3.141592653589793,HALF_PI:1.5707963267948966,TWO_PI:6.283185307179586,FORTPI:.7853981633974483,R2D:57.29577951308232,D2R:.017453292519943295,SEC_TO_RAD:484813681109536e-20,EPSLN:1e-10,MAX_ITER:20,COS_67P5:.3826834323650898,AD_C:1.0026,PJD_UNKNOWN:0,PJD_3PARAM:1,PJD_7PARAM:2,PJD_GRIDSHIFT:3,PJD_WGS84:4,PJD_NODATUM:5,SRS_WGS84_SEMIMAJOR:6378137,SIXTH:.16666666666666666,RA4:.04722222222222222,RA6:.022156084656084655,RV4:.06944444444444445,RV6:.04243827160493827,msfnz:function(e,t,i){var n=e*t;return i/Math.sqrt(1-n*n)},tsfnz:function(e,t,i){var n=e*i,r=.5*e;n=Math.pow((1-n)/(1+n),r);return Math.tan(.5*(this.HALF_PI-t))/n},phi2z:function(e,t){for(var i,n,r=.5*e,s=this.HALF_PI-2*Math.atan(t),a=0;a<=15;a++){i=e*Math.sin(s);s+=n=this.HALF_PI-2*Math.atan(t*Math.pow((1-i)/(1+i),r))-s;if(Math.abs(n)<=1e-10)return s}alert("phi2z has NoConvergence");return-9999},qsfnz:function(e,t){var i;return e>1e-7?(1-e*e)*(t/(1-(i=e*t)*i)-.5/e*Math.log((1-i)/(1+i))):2*t},asinz:function(e){Math.abs(e)>1&&(e=e>1?1:-1);return Math.asin(e)},e0fn:function(e){return 1-.25*e*(1+e/16*(3+1.25*e))},e1fn:function(e){return.375*e*(1+.25*e*(1+.46875*e))},e2fn:function(e){return.05859375*e*e*(1+.75*e)},e3fn:function(e){return e*e*e*(35/3072)},mlfn:function(e,t,i,n,r){return e*r-t*Math.sin(2*r)+i*Math.sin(4*r)-n*Math.sin(6*r)},srat:function(e,t){return Math.pow((1-e)/(1+e),t)},sign:function(e){return e<0?-1:1},adjust_lon:function(e){return e=Math.abs(e)<this.PI?e:e-this.sign(e)*this.TWO_PI},adjust_lat:function(e){return e=Math.abs(e)<this.HALF_PI?e:e-this.sign(e)*this.PI},latiso:function(e,t,i){if(Math.abs(t)>this.HALF_PI)return+Number.NaN;if(t==this.HALF_PI)return Number.POSITIVE_INFINITY;if(t==-1*this.HALF_PI)return-1*Number.POSITIVE_INFINITY;var n=e*i;return Math.log(Math.tan((this.HALF_PI+t)/2))+e*Math.log((1-n)/(1+n))/2},fL:function(e,t){return 2*Math.atan(e*Math.exp(t))-this.HALF_PI},invlatiso:function(e,t){var i=this.fL(1,t),n=0,r=0;do{n=i;r=e*Math.sin(n);i=this.fL(Math.exp(e*Math.log((1+r)/(1-r))/2),t)}while(Math.abs(i-n)>1e-12);return i},sinh:function(e){var t=Math.exp(e);return t=(t-1/t)/2},cosh:function(e){var t=Math.exp(e);return t=(t+1/t)/2},tanh:function(e){var t=Math.exp(e);return t=(t-1/t)/(t+1/t)},asinh:function(e){return(e>=0?1:-1)*Math.log(Math.abs(e)+Math.sqrt(e*e+1))},acosh:function(e){return 2*Math.log(Math.sqrt((e+1)/2)+Math.sqrt((e-1)/2))},atanh:function(e){return Math.log((e-1)/(e+1))/2},gN:function(e,t,i){var n=t*i;return e/Math.sqrt(1-n*n)},pj_enfn:function(e){var t=new Array;t[0]=this.C00-e*(this.C02+e*(this.C04+e*(this.C06+e*this.C08)));t[1]=e*(this.C22-e*(this.C04+e*(this.C06+e*this.C08)));var i=e*e;t[2]=i*(this.C44-e*(this.C46+e*this.C48));i*=e;t[3]=i*(this.C66-e*this.C68);t[4]=i*e*this.C88;return t},pj_mlfn:function(e,t,i,n){i*=t;t*=t;return n[0]*e-i*(n[1]+t*(n[2]+t*(n[3]+t*n[4])))},pj_inv_mlfn:function(e,t,i){for(var n=1/(1-t),r=e,s=Proj4js.common.MAX_ITER;s;--s){var a=Math.sin(r),o=1-t*a*a;r-=o=(this.pj_mlfn(r,a,Math.cos(r),i)-e)*(o*Math.sqrt(o))*n;if(Math.abs(o)<Proj4js.common.EPSLN)return r}Proj4js.reportError("cass:pj_inv_mlfn: Convergence error");return r},C00:1,C02:.25,C04:.046875,C06:.01953125,C08:.01068115234375,C22:.75,C44:.46875,C46:.013020833333333334,C48:.007120768229166667,C66:.3645833333333333,C68:.005696614583333333,C88:.3076171875};Proj4js.datum=Proj4js.Class({initialize:function(e){this.datum_type=Proj4js.common.PJD_WGS84;e.datumCode&&"none"==e.datumCode&&(this.datum_type=Proj4js.common.PJD_NODATUM);if(e&&e.datum_params){for(var t=0;t<e.datum_params.length;t++)e.datum_params[t]=parseFloat(e.datum_params[t]);0==e.datum_params[0]&&0==e.datum_params[1]&&0==e.datum_params[2]||(this.datum_type=Proj4js.common.PJD_3PARAM);if(e.datum_params.length>3&&(0!=e.datum_params[3]||0!=e.datum_params[4]||0!=e.datum_params[5]||0!=e.datum_params[6])){this.datum_type=Proj4js.common.PJD_7PARAM;e.datum_params[3]*=Proj4js.common.SEC_TO_RAD;e.datum_params[4]*=Proj4js.common.SEC_TO_RAD;e.datum_params[5]*=Proj4js.common.SEC_TO_RAD;e.datum_params[6]=e.datum_params[6]/1e6+1}}if(e){this.a=e.a;this.b=e.b;this.es=e.es;this.ep2=e.ep2;this.datum_params=e.datum_params}},compare_datums:function(e){if(this.datum_type!=e.datum_type)return!1;if(this.a!=e.a||Math.abs(this.es-e.es)>5e-11)return!1;if(this.datum_type==Proj4js.common.PJD_3PARAM)return this.datum_params[0]==e.datum_params[0]&&this.datum_params[1]==e.datum_params[1]&&this.datum_params[2]==e.datum_params[2];if(this.datum_type==Proj4js.common.PJD_7PARAM)return this.datum_params[0]==e.datum_params[0]&&this.datum_params[1]==e.datum_params[1]&&this.datum_params[2]==e.datum_params[2]&&this.datum_params[3]==e.datum_params[3]&&this.datum_params[4]==e.datum_params[4]&&this.datum_params[5]==e.datum_params[5]&&this.datum_params[6]==e.datum_params[6];if(this.datum_type==Proj4js.common.PJD_GRIDSHIFT||e.datum_type==Proj4js.common.PJD_GRIDSHIFT){alert("ERROR: Grid shift transformations are not implemented.");return!1}return!0},geodetic_to_geocentric:function(e){var t,i,n,r,s,a,o,l=e.x,c=e.y,u=e.z?e.z:0;if(c<-Proj4js.common.HALF_PI&&c>-1.001*Proj4js.common.HALF_PI)c=-Proj4js.common.HALF_PI;else if(c>Proj4js.common.HALF_PI&&c<1.001*Proj4js.common.HALF_PI)c=Proj4js.common.HALF_PI;else if(c<-Proj4js.common.HALF_PI||c>Proj4js.common.HALF_PI){Proj4js.reportError("geocent:lat out of range:"+c);return null}l>Proj4js.common.PI&&(l-=2*Proj4js.common.PI);s=Math.sin(c);o=Math.cos(c);a=s*s;t=((r=this.a/Math.sqrt(1-this.es*a))+u)*o*Math.cos(l);i=(r+u)*o*Math.sin(l);n=(r*(1-this.es)+u)*s;e.x=t;e.y=i;e.z=n;return 0},geocentric_to_geodetic:function(e){var t,i,n,r,s,a,o,l,c,u,h,p,d,f,m,y,g=e.x,C=e.y,v=e.z?e.z:0;!1;t=Math.sqrt(g*g+C*C);i=Math.sqrt(g*g+C*C+v*v);if(t/this.a<1e-12){!0;f=0;if(i/this.a<1e-12){m=Proj4js.common.HALF_PI;y=-this.b;return}}else f=Math.atan2(C,g);n=v/i;r=t/i;s=1/Math.sqrt(1-this.es*(2-this.es)*r*r);l=r*(1-this.es)*s;c=n*s;d=0;do{d++;y=t*l+v*c-(o=this.a/Math.sqrt(1-this.es*c*c))*(1-this.es*c*c);a=this.es*o/(o+y);p=(h=n*(s=1/Math.sqrt(1-a*(2-a)*r*r)))*l-(u=r*(1-a)*s)*c;l=u;c=h}while(p*p>1e-24&&d<30);m=Math.atan(h/Math.abs(u));e.x=f;e.y=m;e.z=y;return e},geocentric_to_geodetic_noniter:function(e){var t,i,n,r,s,a,o,l,c,u,h,p,d,f,m,y,g,C=e.x,v=e.y,T=e.z?e.z:0;C=parseFloat(C);v=parseFloat(v);T=parseFloat(T);g=!1;if(0!=C)t=Math.atan2(v,C);else if(v>0)t=Proj4js.common.HALF_PI;else if(v<0)t=-Proj4js.common.HALF_PI;else{g=!0;t=0;if(T>0)i=Proj4js.common.HALF_PI;else{if(!(T<0)){i=Proj4js.common.HALF_PI;n=-this.b;return}i=-Proj4js.common.HALF_PI}}s=C*C+v*v;r=Math.sqrt(s);a=T*Proj4js.common.AD_C;p=r/(l=Math.sqrt(a*a+s));h=(u=a/l)*u*u;o=T+this.b*this.ep2*h;y=r-this.a*this.es*p*p*p;d=o/(c=Math.sqrt(o*o+y*y));f=y/c;m=this.a/Math.sqrt(1-this.es*d*d);n=f>=Proj4js.common.COS_67P5?r/f-m:f<=-Proj4js.common.COS_67P5?r/-f-m:T/d+m*(this.es-1);0==g&&(i=Math.atan(d/f));e.x=t;e.y=i;e.z=n;return e},geocentric_to_wgs84:function(e){if(this.datum_type==Proj4js.common.PJD_3PARAM){e.x+=this.datum_params[0];e.y+=this.datum_params[1];e.z+=this.datum_params[2]}else if(this.datum_type==Proj4js.common.PJD_7PARAM){var t=this.datum_params[0],i=this.datum_params[1],n=this.datum_params[2],r=this.datum_params[3],s=this.datum_params[4],a=this.datum_params[5],o=this.datum_params[6],l=o*(e.x-a*e.y+s*e.z)+t,c=o*(a*e.x+e.y-r*e.z)+i,u=o*(-s*e.x+r*e.y+e.z)+n;e.x=l;e.y=c;e.z=u}},geocentric_from_wgs84:function(e){if(this.datum_type==Proj4js.common.PJD_3PARAM){e.x-=this.datum_params[0];e.y-=this.datum_params[1];e.z-=this.datum_params[2]}else if(this.datum_type==Proj4js.common.PJD_7PARAM){var t=this.datum_params[0],i=this.datum_params[1],n=this.datum_params[2],r=this.datum_params[3],s=this.datum_params[4],a=this.datum_params[5],o=this.datum_params[6],l=(e.x-t)/o,c=(e.y-i)/o,u=(e.z-n)/o;e.x=l+a*c-s*u;e.y=-a*l+c+r*u;e.z=s*l-r*c+u}}});Proj4js.Point=Proj4js.Class({initialize:function(e,t,i){if("object"==typeof e){this.x=e[0];this.y=e[1];this.z=e[2]||0}else if("string"==typeof e&&void 0===t){var n=e.split(",");this.x=parseFloat(n[0]);this.y=parseFloat(n[1]);this.z=parseFloat(n[2])||0}else{this.x=e;this.y=t;this.z=i||0}},clone:function(){return new Proj4js.Point(this.x,this.y,this.z)},toString:function(){return"x="+this.x+",y="+this.y},toShortString:function(){return this.x+", "+this.y}});Proj4js.PrimeMeridian={greenwich:0,lisbon:-9.131906111111,paris:2.337229166667,bogota:-74.080916666667,madrid:-3.687938888889,rome:12.452333333333,bern:7.439583333333,jakarta:106.807719444444,ferro:-17.666666666667,brussels:4.367975,stockholm:18.058277777778,athens:23.7163375,oslo:10.722916666667};Proj4js.Ellipsoid={MERIT:{a:6378137,rf:298.257,ellipseName:"MERIT 1983"},SGS85:{a:6378136,rf:298.257,ellipseName:"Soviet Geodetic System 85"},GRS80:{a:6378137,rf:298.257222101,ellipseName:"GRS 1980(IUGG, 1980)"},IAU76:{a:6378140,rf:298.257,ellipseName:"IAU 1976"},airy:{a:6377563.396,b:6356256.91,ellipseName:"Airy 1830"},"APL4.":{a:6378137,rf:298.25,ellipseName:"Appl. Physics. 1965"},NWL9D:{a:6378145,rf:298.25,ellipseName:"Naval Weapons Lab., 1965"},mod_airy:{a:6377340.189,b:6356034.446,ellipseName:"Modified Airy"},andrae:{a:6377104.43,rf:300,ellipseName:"Andrae 1876 (Den., Iclnd.)"},aust_SA:{a:6378160,rf:298.25,ellipseName:"Australian Natl & S. Amer. 1969"},GRS67:{a:6378160,rf:298.247167427,ellipseName:"GRS 67(IUGG 1967)"},bessel:{a:6377397.155,rf:299.1528128,ellipseName:"Bessel 1841"},bess_nam:{a:6377483.865,rf:299.1528128,ellipseName:"Bessel 1841 (Namibia)"},clrk66:{a:6378206.4,b:6356583.8,ellipseName:"Clarke 1866"},clrk80:{a:6378249.145,rf:293.4663,ellipseName:"Clarke 1880 mod."},CPM:{a:6375738.7,rf:334.29,ellipseName:"Comm. des Poids et Mesures 1799"},delmbr:{a:6376428,rf:311.5,ellipseName:"Delambre 1810 (Belgium)"},engelis:{a:6378136.05,rf:298.2566,ellipseName:"Engelis 1985"},evrst30:{a:6377276.345,rf:300.8017,ellipseName:"Everest 1830"},evrst48:{a:6377304.063,rf:300.8017,ellipseName:"Everest 1948"},evrst56:{a:6377301.243,rf:300.8017,ellipseName:"Everest 1956"},evrst69:{a:6377295.664,rf:300.8017,ellipseName:"Everest 1969"},evrstSS:{a:6377298.556,rf:300.8017,ellipseName:"Everest (Sabah & Sarawak)"},fschr60:{a:6378166,rf:298.3,ellipseName:"Fischer (Mercury Datum) 1960"},fschr60m:{a:6378155,rf:298.3,ellipseName:"Fischer 1960"},fschr68:{a:6378150,rf:298.3,ellipseName:"Fischer 1968"},helmert:{a:6378200,rf:298.3,ellipseName:"Helmert 1906"},hough:{a:6378270,rf:297,ellipseName:"Hough"},intl:{a:6378388,rf:297,ellipseName:"International 1909 (Hayford)"},kaula:{a:6378163,rf:298.24,ellipseName:"Kaula 1961"},lerch:{a:6378139,rf:298.257,ellipseName:"Lerch 1979"},mprts:{a:6397300,rf:191,ellipseName:"Maupertius 1738"},new_intl:{a:6378157.5,b:6356772.2,ellipseName:"New International 1967"},plessis:{a:6376523,rf:6355863,ellipseName:"Plessis 1817 (France)"},krass:{a:6378245,rf:298.3,ellipseName:"Krassovsky, 1942"},SEasia:{a:6378155,b:6356773.3205,ellipseName:"Southeast Asia"},walbeck:{a:6376896,b:6355834.8467,ellipseName:"Walbeck"},WGS60:{a:6378165,rf:298.3,ellipseName:"WGS 60"},WGS66:{a:6378145,rf:298.25,ellipseName:"WGS 66"},WGS72:{a:6378135,rf:298.26,ellipseName:"WGS 72"},WGS84:{a:6378137,rf:298.257223563,ellipseName:"WGS 84"},sphere:{a:6370997,b:6370997,ellipseName:"Normal Sphere (r=6370997)"}};Proj4js.Datum={WGS84:{towgs84:"0,0,0",ellipse:"WGS84",datumName:"WGS84"},GGRS87:{towgs84:"-199.87,74.79,246.62",ellipse:"GRS80",datumName:"Greek_Geodetic_Reference_System_1987"},NAD83:{towgs84:"0,0,0",ellipse:"GRS80",datumName:"North_American_Datum_1983"},NAD27:{nadgrids:"@conus,@alaska,@ntv2_0.gsb,@ntv1_can.dat",ellipse:"clrk66",datumName:"North_American_Datum_1927"},potsdam:{towgs84:"606.0,23.0,413.0",ellipse:"bessel",datumName:"Potsdam Rauenberg 1950 DHDN"},carthage:{towgs84:"-263.0,6.0,431.0",ellipse:"clark80",datumName:"Carthage 1934 Tunisia"},hermannskogel:{towgs84:"653.0,-212.0,449.0",ellipse:"bessel",datumName:"Hermannskogel"},ire65:{towgs84:"482.530,-130.596,564.557,-1.042,-0.214,-0.631,8.15",ellipse:"mod_airy",datumName:"Ireland 1965"},nzgd49:{towgs84:"59.47,-5.04,187.44,0.47,-0.1,1.024,-4.5993",ellipse:"intl",datumName:"New Zealand Geodetic Datum 1949"},OSGB36:{towgs84:"446.448,-125.157,542.060,0.1502,0.2470,0.8421,-20.4894",ellipse:"airy",datumName:"Airy 1830"}};Proj4js.WGS84=new Proj4js.Proj("WGS84");Proj4js.Datum.OSB36=Proj4js.Datum.OSGB36;Proj4js.wktProjections={"Lambert Tangential Conformal Conic Projection":"lcc",Mercator:"merc","Popular Visualisation Pseudo Mercator":"merc",Mercator_1SP:"merc",Transverse_Mercator:"tmerc","Transverse Mercator":"tmerc","Lambert Azimuthal Equal Area":"laea","Universal Transverse Mercator System":"utm"};Proj4js.Proj.aea={init:function(){if(Math.abs(this.lat1+this.lat2)<Proj4js.common.EPSLN)Proj4js.reportError("aeaInitEqualLatitudes");else{this.temp=this.b/this.a;this.es=1-Math.pow(this.temp,2);this.e3=Math.sqrt(this.es);this.sin_po=Math.sin(this.lat1);this.cos_po=Math.cos(this.lat1);this.t1=this.sin_po;this.con=this.sin_po;this.ms1=Proj4js.common.msfnz(this.e3,this.sin_po,this.cos_po);this.qs1=Proj4js.common.qsfnz(this.e3,this.sin_po,this.cos_po);this.sin_po=Math.sin(this.lat2);this.cos_po=Math.cos(this.lat2);this.t2=this.sin_po;this.ms2=Proj4js.common.msfnz(this.e3,this.sin_po,this.cos_po);this.qs2=Proj4js.common.qsfnz(this.e3,this.sin_po,this.cos_po);this.sin_po=Math.sin(this.lat0);this.cos_po=Math.cos(this.lat0);this.t3=this.sin_po;this.qs0=Proj4js.common.qsfnz(this.e3,this.sin_po,this.cos_po);Math.abs(this.lat1-this.lat2)>Proj4js.common.EPSLN?this.ns0=(this.ms1*this.ms1-this.ms2*this.ms2)/(this.qs2-this.qs1):this.ns0=this.con;this.c=this.ms1*this.ms1+this.ns0*this.qs1;this.rh=this.a*Math.sqrt(this.c-this.ns0*this.qs0)/this.ns0}},forward:function(e){var t=e.x,i=e.y;this.sin_phi=Math.sin(i);this.cos_phi=Math.cos(i);var n=Proj4js.common.qsfnz(this.e3,this.sin_phi,this.cos_phi),r=this.a*Math.sqrt(this.c-this.ns0*n)/this.ns0,s=this.ns0*Proj4js.common.adjust_lon(t-this.long0),a=r*Math.sin(s)+this.x0,o=this.rh-r*Math.cos(s)+this.y0;e.x=a;e.y=o;return e},inverse:function(e){var t,i,n,r,s,a;e.x-=this.x0;e.y=this.rh-e.y+this.y0;if(this.ns0>=0){t=Math.sqrt(e.x*e.x+e.y*e.y);n=1}else{t=-Math.sqrt(e.x*e.x+e.y*e.y);n=-1}r=0;0!=t&&(r=Math.atan2(n*e.x,n*e.y));n=t*this.ns0/this.a;i=(this.c-n*n)/this.ns0;if(this.e3>=1e-10){n=1-.5*(1-this.es)*Math.log((1-this.e3)/(1+this.e3))/this.e3;a=Math.abs(Math.abs(n)-Math.abs(i))>1e-10?this.phi1z(this.e3,i):i>=0?.5*Proj4js.common.PI:-.5*Proj4js.common.PI}else a=this.phi1z(this.e3,i);s=Proj4js.common.adjust_lon(r/this.ns0+this.long0);e.x=s;e.y=a;return e},phi1z:function(e,t){var i,n,r,s,a,o=Proj4js.common.asinz(.5*t);if(e<Proj4js.common.EPSLN)return o;for(var l=e*e,c=1;c<=25;c++){i=Math.sin(o);n=Math.cos(o);o+=a=.5*(s=1-(r=e*i)*r)*s/n*(t/(1-l)-i/s+.5/e*Math.log((1-r)/(1+r)));if(Math.abs(a)<=1e-7)return o}Proj4js.reportError("aea:phi1z:Convergence error");return null}};Proj4js.Proj.sterea={dependsOn:"gauss",init:function(){Proj4js.Proj.gauss.init.apply(this);if(this.rc){this.sinc0=Math.sin(this.phic0);this.cosc0=Math.cos(this.phic0);this.R2=2*this.rc;this.title||(this.title="Oblique Stereographic Alternative")}else Proj4js.reportError("sterea:init:E_ERROR_0")},forward:function(e){var t,i,n,r;e.x=Proj4js.common.adjust_lon(e.x-this.long0);Proj4js.Proj.gauss.forward.apply(this,[e]);t=Math.sin(e.y);i=Math.cos(e.y);n=Math.cos(e.x);r=this.k0*this.R2/(1+this.sinc0*t+this.cosc0*i*n);e.x=r*i*Math.sin(e.x);e.y=r*(this.cosc0*t-this.sinc0*i*n);e.x=this.a*e.x+this.x0;e.y=this.a*e.y+this.y0;return e},inverse:function(e){var t,i,n,r,s;e.x=(e.x-this.x0)/this.a;e.y=(e.y-this.y0)/this.a;e.x/=this.k0;e.y/=this.k0;if(s=Math.sqrt(e.x*e.x+e.y*e.y)){var a=2*Math.atan2(s,this.R2);t=Math.sin(a);i=Math.cos(a);r=Math.asin(i*this.sinc0+e.y*t*this.cosc0/s);n=Math.atan2(e.x*t,s*this.cosc0*i-e.y*this.sinc0*t)}else{r=this.phic0;n=0}e.x=n;e.y=r;Proj4js.Proj.gauss.inverse.apply(this,[e]);e.x=Proj4js.common.adjust_lon(e.x+this.long0);return e}};function phi4z(e,t,i,n,r,s,a,o,l){var c,u,h,p,d,f;l=s;for(f=1;f<=15;f++){c=Math.sin(l);o=Math.tan(l)*Math.sqrt(1-e*c*c);l+=d=(2*(h=t*l-i*(u=Math.sin(2*l))+n*Math.sin(4*l)-r*Math.sin(6*l))+o*(h*h+a)-2*s*(o*h+1))/(e*u*(h*h+a-2*s*h)/(2*o)+(2*(s-h)*(o*(p=t-2*i*Math.cos(2*l)+4*n*Math.cos(4*l)-6*r*Math.cos(6*l))-2/u)-2*p));if(Math.abs(d)<=1e-10)return l}Proj4js.reportError("phi4z: No convergence");return null}function e4fn(e){var t,i;t=1+e;i=1-e;return Math.sqrt(Math.pow(t,t)*Math.pow(i,i))}Proj4js.Proj.poly={init:function(){0==this.lat0&&(this.lat0=90);this.temp=this.b/this.a;this.es=1-Math.pow(this.temp,2);this.e=Math.sqrt(this.es);this.e0=Proj4js.common.e0fn(this.es);this.e1=Proj4js.common.e1fn(this.es);this.e2=Proj4js.common.e2fn(this.es);this.e3=Proj4js.common.e3fn(this.es);this.ml0=Proj4js.common.mlfn(this.e0,this.e1,this.e2,this.e3,this.lat0)},forward:function(e){var t,i,n,r,s,a,o,l=e.x,c=e.y;n=Proj4js.common.adjust_lon(l-this.long0);if(Math.abs(c)<=1e-7){a=this.x0+this.a*n;o=this.y0-this.a*this.ml0}else{t=Math.sin(c);i=Math.cos(c);r=Proj4js.common.mlfn(this.e0,this.e1,this.e2,this.e3,c);s=Proj4js.common.msfnz(this.e,t,i);n=t;a=this.x0+this.a*s*Math.sin(n)/t;o=this.y0+this.a*(r-this.ml0+s*(1-Math.cos(n))/t)}e.x=a;e.y=o;return e},inverse:function(e){var t,i,n,r,s,a;e.x-=this.x0;e.y-=this.y0;t=this.ml0+e.y/this.a;r=0;if(Math.abs(t)<=1e-7){s=e.x/this.a+this.long0;a=0}else{i=t*t+e.x/this.a*(e.x/this.a);if(1!=(r=phi4z(this.es,this.e0,this.e1,this.e2,this.e3,this.al,i,n,a)))return r;s=Proj4js.common.adjust_lon(Proj4js.common.asinz(e.x*n/this.a)/Math.sin(a)+this.long0)}e.x=s;e.y=a;return e}};Proj4js.Proj.equi={init:function(){this.x0||(this.x0=0);this.y0||(this.y0=0);this.lat0||(this.lat0=0);this.long0||(this.long0=0)},forward:function(e){var t=e.x,i=e.y,n=Proj4js.common.adjust_lon(t-this.long0),r=this.x0+this.a*n*Math.cos(this.lat0),s=this.y0+this.a*i;this.t1=r;this.t2=Math.cos(this.lat0);e.x=r;e.y=s;return e},inverse:function(e){e.x-=this.x0;e.y-=this.y0;var t=e.y/this.a;Math.abs(t)>Proj4js.common.HALF_PI&&Proj4js.reportError("equi:Inv:DataError");var i=Proj4js.common.adjust_lon(this.long0+e.x/(this.a*Math.cos(this.lat0)));e.x=i;e.y=t}};Proj4js.Proj.merc={init:function(){this.lat_ts&&(this.sphere?this.k0=Math.cos(this.lat_ts):this.k0=Proj4js.common.msfnz(this.es,Math.sin(this.lat_ts),Math.cos(this.lat_ts)))},forward:function(e){var t,i,n=e.x,r=e.y;if(r*Proj4js.common.R2D>90&&r*Proj4js.common.R2D<-90&&n*Proj4js.common.R2D>180&&n*Proj4js.common.R2D<-180){Proj4js.reportError("merc:forward: llInputOutOfRange: "+n+" : "+r);return null}if(Math.abs(Math.abs(r)-Proj4js.common.HALF_PI)<=Proj4js.common.EPSLN){Proj4js.reportError("merc:forward: ll2mAtPoles");return null}if(this.sphere){t=this.x0+this.a*this.k0*Proj4js.common.adjust_lon(n-this.long0);i=this.y0+this.a*this.k0*Math.log(Math.tan(Proj4js.common.FORTPI+.5*r))}else{var s=Math.sin(r),a=Proj4js.common.tsfnz(this.e,r,s);t=this.x0+this.a*this.k0*Proj4js.common.adjust_lon(n-this.long0);i=this.y0-this.a*this.k0*Math.log(a)}e.x=t;e.y=i;return e},inverse:function(e){var t,i,n=e.x-this.x0,r=e.y-this.y0;if(this.sphere)i=Proj4js.common.HALF_PI-2*Math.atan(Math.exp(-r/this.a*this.k0));else{var s=Math.exp(-r/(this.a*this.k0));if(-9999==(i=Proj4js.common.phi2z(this.e,s))){Proj4js.reportError("merc:inverse: lat = -9999");return null}}t=Proj4js.common.adjust_lon(this.long0+n/(this.a*this.k0));e.x=t;e.y=i;return e}};Proj4js.Proj.utm={dependsOn:"tmerc",init:function(){if(this.zone){this.lat0=0;this.long0=(6*Math.abs(this.zone)-183)*Proj4js.common.D2R;this.x0=5e5;this.y0=this.utmSouth?1e7:0;this.k0=.9996;Proj4js.Proj.tmerc.init.apply(this);this.forward=Proj4js.Proj.tmerc.forward;this.inverse=Proj4js.Proj.tmerc.inverse}else Proj4js.reportError("utm:init: zone must be specified for UTM")}};Proj4js.Proj.eqdc={init:function(){this.mode||(this.mode=0);this.temp=this.b/this.a;this.es=1-Math.pow(this.temp,2);this.e=Math.sqrt(this.es);this.e0=Proj4js.common.e0fn(this.es);this.e1=Proj4js.common.e1fn(this.es);this.e2=Proj4js.common.e2fn(this.es);this.e3=Proj4js.common.e3fn(this.es);this.sinphi=Math.sin(this.lat1);this.cosphi=Math.cos(this.lat1);this.ms1=Proj4js.common.msfnz(this.e,this.sinphi,this.cosphi);this.ml1=Proj4js.common.mlfn(this.e0,this.e1,this.e2,this.e3,this.lat1);if(0!=this.mode){Math.abs(this.lat1+this.lat2)<Proj4js.common.EPSLN&&Proj4js.reportError("eqdc:Init:EqualLatitudes");this.sinphi=Math.sin(this.lat2);this.cosphi=Math.cos(this.lat2);this.ms2=Proj4js.common.msfnz(this.e,this.sinphi,this.cosphi);this.ml2=Proj4js.common.mlfn(this.e0,this.e1,this.e2,this.e3,this.lat2);Math.abs(this.lat1-this.lat2)>=Proj4js.common.EPSLN?this.ns=(this.ms1-this.ms2)/(this.ml2-this.ml1):this.ns=this.sinphi}else this.ns=this.sinphi;this.g=this.ml1+this.ms1/this.ns;this.ml0=Proj4js.common.mlfn(this.e0,this.e1,this.e2,this.e3,this.lat0);this.rh=this.a*(this.g-this.ml0)},forward:function(e){var t=e.x,i=e.y,n=Proj4js.common.mlfn(this.e0,this.e1,this.e2,this.e3,i),r=this.a*(this.g-n),s=this.ns*Proj4js.common.adjust_lon(t-this.long0),a=this.x0+r*Math.sin(s),o=this.y0+this.rh-r*Math.cos(s);e.x=a;e.y=o;return e},inverse:function(e){e.x-=this.x0;e.y=this.rh-e.y+this.y0;var t,i;if(this.ns>=0){i=Math.sqrt(e.x*e.x+e.y*e.y);t=1}else{i=-Math.sqrt(e.x*e.x+e.y*e.y);t=-1}var n=0;0!=i&&(n=Math.atan2(t*e.x,t*e.y));var r=this.g-i/this.a,s=this.phi3z(r,this.e0,this.e1,this.e2,this.e3),a=Proj4js.common.adjust_lon(this.long0+n/this.ns);e.x=a;e.y=s;return e},phi3z:function(e,t,i,n,r){var s,a;s=e;for(var o=0;o<15;o++){s+=a=(e+i*Math.sin(2*s)-n*Math.sin(4*s)+r*Math.sin(6*s))/t-s;if(Math.abs(a)<=1e-10)return s}Proj4js.reportError("PHI3Z-CONV:Latitude failed to converge after 15 iterations");return null}};Proj4js.Proj.tmerc={init:function(){this.e0=Proj4js.common.e0fn(this.es);this.e1=Proj4js.common.e1fn(this.es);this.e2=Proj4js.common.e2fn(this.es);this.e3=Proj4js.common.e3fn(this.es);this.ml0=this.a*Proj4js.common.mlfn(this.e0,this.e1,this.e2,this.e3,this.lat0)},forward:function(e){var t,i,n,r=e.x,s=e.y,a=Proj4js.common.adjust_lon(r-this.long0),o=Math.sin(s),l=Math.cos(s);if(this.sphere){var c=l*Math.sin(a);if(Math.abs(Math.abs(c)-1)<1e-10){Proj4js.reportError("tmerc:forward: Point projects into infinity");return 93}i=.5*this.a*this.k0*Math.log((1+c)/(1-c));t=Math.acos(l*Math.cos(a)/Math.sqrt(1-c*c));s<0&&(t=-t);n=this.a*this.k0*(t-this.lat0)}else{var u=l*a,h=Math.pow(u,2),p=this.ep2*Math.pow(l,2),d=Math.tan(s),f=Math.pow(d,2);t=1-this.es*Math.pow(o,2);var m=this.a/Math.sqrt(t),y=this.a*Proj4js.common.mlfn(this.e0,this.e1,this.e2,this.e3,s);i=this.k0*m*u*(1+h/6*(1-f+p+h/20*(5-18*f+Math.pow(f,2)+72*p-58*this.ep2)))+this.x0;n=this.k0*(y-this.ml0+m*d*(h*(.5+h/24*(5-f+9*p+4*Math.pow(p,2)+h/30*(61-58*f+Math.pow(f,2)+600*p-330*this.ep2)))))+this.y0}e.x=i;e.y=n;return e},inverse:function(e){var t,i,n,r,s,a;if(this.sphere){var o=Math.exp(e.x/(this.a*this.k0)),l=.5*(o-1/o),c=this.lat0+e.y/(this.a*this.k0),u=Math.cos(c);t=Math.sqrt((1-u*u)/(1+l*l));s=Proj4js.common.asinz(t);c<0&&(s=-s);a=0==l&&0==u?this.long0:Proj4js.common.adjust_lon(Math.atan2(l,u)+this.long0)}else{var h=e.x-this.x0,p=e.y-this.y0;i=t=(this.ml0+p/this.k0)/this.a;for(r=0;;r++){i+=n=(t+this.e1*Math.sin(2*i)-this.e2*Math.sin(4*i)+this.e3*Math.sin(6*i))/this.e0-i;if(Math.abs(n)<=Proj4js.common.EPSLN)break;if(r>=6){Proj4js.reportError("tmerc:inverse: Latitude failed to converge");return 95}}if(Math.abs(i)<Proj4js.common.HALF_PI){var d=Math.sin(i),f=Math.cos(i),m=Math.tan(i),y=this.ep2*Math.pow(f,2),g=Math.pow(y,2),C=Math.pow(m,2),v=Math.pow(C,2);t=1-this.es*Math.pow(d,2);var T=this.a/Math.sqrt(t),L=T*(1-this.es)/t,w=h/(T*this.k0),b=Math.pow(w,2);s=i-T*m*b/L*(.5-b/24*(5+3*C+10*y-4*g-9*this.ep2-b/30*(61+90*C+298*y+45*v-252*this.ep2-3*g)));a=Proj4js.common.adjust_lon(this.long0+w*(1-b/6*(1+2*C+y-b/20*(5-2*y+28*C-3*g+8*this.ep2+24*v)))/f)}else{s=Proj4js.common.HALF_PI*Proj4js.common.sign(p);a=this.long0}}e.x=a;e.y=s;return e}};Proj4js.defs.GOOGLE="+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs";Proj4js.defs["EPSG:900913"]=Proj4js.defs.GOOGLE;Proj4js.Proj.gstmerc={init:function(){var e=this.b/this.a;this.e=Math.sqrt(1-e*e);this.lc=this.long0;this.rs=Math.sqrt(1+this.e*this.e*Math.pow(Math.cos(this.lat0),4)/(1-this.e*this.e));var t=Math.sin(this.lat0),i=Math.asin(t/this.rs),n=Math.sin(i);this.cp=Proj4js.common.latiso(0,i,n)-this.rs*Proj4js.common.latiso(this.e,this.lat0,t);this.n2=this.k0*this.a*Math.sqrt(1-this.e*this.e)/(1-this.e*this.e*t*t);this.xs=this.x0;this.ys=this.y0-this.n2*i;this.title||(this.title="Gauss Schreiber transverse mercator")},forward:function(e){var t=e.x,i=e.y,n=this.rs*(t-this.lc),r=this.cp+this.rs*Proj4js.common.latiso(this.e,i,Math.sin(i)),s=Math.asin(Math.sin(n)/Proj4js.common.cosh(r)),a=Proj4js.common.latiso(0,s,Math.sin(s));e.x=this.xs+this.n2*a;e.y=this.ys+this.n2*Math.atan(Proj4js.common.sinh(r)/Math.cos(n));return e},inverse:function(e){var t=e.x,i=e.y,n=Math.atan(Proj4js.common.sinh((t-this.xs)/this.n2)/Math.cos((i-this.ys)/this.n2)),r=Math.asin(Math.sin((i-this.ys)/this.n2)/Proj4js.common.cosh((t-this.xs)/this.n2)),s=Proj4js.common.latiso(0,r,Math.sin(r));e.x=this.lc+n/this.rs;e.y=Proj4js.common.invlatiso(this.e,(s-this.cp)/this.rs);return e}};Proj4js.Proj.ortho={init:function(e){this.sin_p14=Math.sin(this.lat0);this.cos_p14=Math.cos(this.lat0)},forward:function(e){var t,i,n,r,s,a=e.x,o=e.y;n=Proj4js.common.adjust_lon(a-this.long0);t=Math.sin(o);i=Math.cos(o);r=Math.cos(n);s=this.sin_p14*t+this.cos_p14*i*r;1;if(s>0||Math.abs(s)<=Proj4js.common.EPSLN)var l=1*this.a*i*Math.sin(n),c=this.y0+1*this.a*(this.cos_p14*t-this.sin_p14*i*r);else Proj4js.reportError("orthoFwdPointError");e.x=l;e.y=c;return e},inverse:function(e){var t,i,n,r,s,a,o;e.x-=this.x0;e.y-=this.y0;(t=Math.sqrt(e.x*e.x+e.y*e.y))>this.a+1e-7&&Proj4js.reportError("orthoInvDataError");i=Proj4js.common.asinz(t/this.a);n=Math.sin(i);r=Math.cos(i);a=this.long0;Math.abs(t)<=Proj4js.common.EPSLN&&(o=this.lat0);o=Proj4js.common.asinz(r*this.sin_p14+e.y*n*this.cos_p14/t);s=Math.abs(this.lat0)-Proj4js.common.HALF_PI;Math.abs(s)<=Proj4js.common.EPSLN&&(a=this.lat0>=0?Proj4js.common.adjust_lon(this.long0+Math.atan2(e.x,-e.y)):Proj4js.common.adjust_lon(this.long0-Math.atan2(-e.x,e.y)));s=r-this.sin_p14*Math.sin(o);e.x=a;e.y=o;return e}};Proj4js.Proj.krovak={init:function(){this.a=6377397.155;this.es=.006674372230614;this.e=Math.sqrt(this.es);this.lat0||(this.lat0=.863937979737193);this.long0||(this.long0=.4334234309119251);this.k0||(this.k0=.9999);this.s45=.785398163397448;this.s90=2*this.s45;this.fi0=this.lat0;this.e2=this.es;this.e=Math.sqrt(this.e2);this.alfa=Math.sqrt(1+this.e2*Math.pow(Math.cos(this.fi0),4)/(1-this.e2));this.uq=1.04216856380474;this.u0=Math.asin(Math.sin(this.fi0)/this.alfa);this.g=Math.pow((1+this.e*Math.sin(this.fi0))/(1-this.e*Math.sin(this.fi0)),this.alfa*this.e/2);this.k=Math.tan(this.u0/2+this.s45)/Math.pow(Math.tan(this.fi0/2+this.s45),this.alfa)*this.g;this.k1=this.k0;this.n0=this.a*Math.sqrt(1-this.e2)/(1-this.e2*Math.pow(Math.sin(this.fi0),2));this.s0=1.37008346281555;this.n=Math.sin(this.s0);this.ro0=this.k1*this.n0/Math.tan(this.s0);this.ad=this.s90-this.uq},forward:function(e){var t,i,n,r,s,a,o,l=e.x,c=e.y,u=Proj4js.common.adjust_lon(l-this.long0);t=Math.pow((1+this.e*Math.sin(c))/(1-this.e*Math.sin(c)),this.alfa*this.e/2);i=2*(Math.atan(this.k*Math.pow(Math.tan(c/2+this.s45),this.alfa)/t)-this.s45);n=-u*this.alfa;r=Math.asin(Math.cos(this.ad)*Math.sin(i)+Math.sin(this.ad)*Math.cos(i)*Math.cos(n));s=Math.asin(Math.cos(i)*Math.sin(n)/Math.cos(r));a=this.n*s;o=this.ro0*Math.pow(Math.tan(this.s0/2+this.s45),this.n)/Math.pow(Math.tan(r/2+this.s45),this.n);e.y=o*Math.cos(a)/1;e.x=o*Math.sin(a)/1;if(this.czech){e.y*=-1;e.x*=-1}return e},inverse:function(e){var t,i,n,r,s,a,o,l=e.x;e.x=e.y;e.y=l;if(this.czech){e.y*=-1;e.x*=-1}s=Math.sqrt(e.x*e.x+e.y*e.y);r=Math.atan2(e.y,e.x)/Math.sin(this.s0);n=2*(Math.atan(Math.pow(this.ro0/s,1/this.n)*Math.tan(this.s0/2+this.s45))-this.s45);t=Math.asin(Math.cos(this.ad)*Math.sin(n)-Math.sin(this.ad)*Math.cos(n)*Math.cos(r));i=Math.asin(Math.cos(n)*Math.sin(r)/Math.cos(t));e.x=this.long0-i/this.alfa;a=t;o=0;var c=0;do{e.y=2*(Math.atan(Math.pow(this.k,-1/this.alfa)*Math.pow(Math.tan(t/2+this.s45),1/this.alfa)*Math.pow((1+this.e*Math.sin(a))/(1-this.e*Math.sin(a)),this.e/2))-this.s45);Math.abs(a-e.y)<1e-10&&(o=1);a=e.y;c+=1}while(0==o&&c<15);if(c>=15){Proj4js.reportError("PHI3Z-CONV:Latitude failed to converge after 15 iterations");return null}return e}};Proj4js.Proj.somerc={init:function(){var e=this.lat0;this.lambda0=this.long0;var t=Math.sin(e),i=this.a,n=1/this.rf,r=2*n-Math.pow(n,2),s=this.e=Math.sqrt(r);this.R=this.k0*i*Math.sqrt(1-r)/(1-r*Math.pow(t,2));this.alpha=Math.sqrt(1+r/(1-r)*Math.pow(Math.cos(e),4));this.b0=Math.asin(t/this.alpha);this.K=Math.log(Math.tan(Math.PI/4+this.b0/2))-this.alpha*Math.log(Math.tan(Math.PI/4+e/2))+this.alpha*s/2*Math.log((1+s*t)/(1-s*t))},forward:function(e){var t=Math.log(Math.tan(Math.PI/4-e.y/2)),i=this.e/2*Math.log((1+this.e*Math.sin(e.y))/(1-this.e*Math.sin(e.y))),n=-this.alpha*(t+i)+this.K,r=2*(Math.atan(Math.exp(n))-Math.PI/4),s=this.alpha*(e.x-this.lambda0),a=Math.atan(Math.sin(s)/(Math.sin(this.b0)*Math.tan(r)+Math.cos(this.b0)*Math.cos(s))),o=Math.asin(Math.cos(this.b0)*Math.sin(r)-Math.sin(this.b0)*Math.cos(r)*Math.cos(s));e.y=this.R/2*Math.log((1+Math.sin(o))/(1-Math.sin(o)))+this.y0;e.x=this.R*a+this.x0;return e},inverse:function(e){for(var t=e.x-this.x0,i=e.y-this.y0,n=t/this.R,r=2*(Math.atan(Math.exp(i/this.R))-Math.PI/4),s=Math.asin(Math.cos(this.b0)*Math.sin(r)+Math.sin(this.b0)*Math.cos(r)*Math.cos(n)),a=Math.atan(Math.sin(n)/(Math.cos(this.b0)*Math.cos(n)-Math.sin(this.b0)*Math.tan(r))),o=this.lambda0+a/this.alpha,l=0,c=s,u=-1e3,h=0;Math.abs(c-u)>1e-7;){if(++h>20){Proj4js.reportError("omercFwdInfinity");return}l=1/this.alpha*(Math.log(Math.tan(Math.PI/4+s/2))-this.K)+this.e*Math.log(Math.tan(Math.PI/4+Math.asin(this.e*Math.sin(c))/2));u=c;c=2*Math.atan(Math.exp(l))-Math.PI/2}e.x=o;e.y=c;return e}};Proj4js.Proj.stere={ssfn_:function(e,t,i){t*=i;return Math.tan(.5*(Proj4js.common.HALF_PI+e))*Math.pow((1-t)/(1+t),.5*i)},TOL:1e-8,NITER:8,CONV:1e-10,S_POLE:0,N_POLE:1,OBLIQ:2,EQUIT:3,init:function(){this.phits=this.lat_ts?this.lat_ts:Proj4js.common.HALF_PI;var e=Math.abs(this.lat0);Math.abs(e)-Proj4js.common.HALF_PI<Proj4js.common.EPSLN?this.mode=this.lat0<0?this.S_POLE:this.N_POLE:this.mode=e>Proj4js.common.EPSLN?this.OBLIQ:this.EQUIT;this.phits=Math.abs(this.phits);if(this.es){var t;switch(this.mode){case this.N_POLE:case this.S_POLE:if(Math.abs(this.phits-Proj4js.common.HALF_PI)<Proj4js.common.EPSLN)this.akm1=2*this.k0/Math.sqrt(Math.pow(1+this.e,1+this.e)*Math.pow(1-this.e,1-this.e));else{e=Math.sin(this.phits);this.akm1=Math.cos(this.phits)/Proj4js.common.tsfnz(this.e,this.phits,e);e*=this.e;this.akm1/=Math.sqrt(1-e*e)}break;case this.EQUIT:this.akm1=2*this.k0;break;case this.OBLIQ:e=Math.sin(this.lat0);t=2*Math.atan(this.ssfn_(this.lat0,e,this.e))-Proj4js.common.HALF_PI;e*=this.e;this.akm1=2*this.k0*Math.cos(this.lat0)/Math.sqrt(1-e*e);this.sinX1=Math.sin(t);this.cosX1=Math.cos(t)}}else switch(this.mode){case this.OBLIQ:this.sinph0=Math.sin(this.lat0);this.cosph0=Math.cos(this.lat0);case this.EQUIT:this.akm1=2*this.k0;break;case this.S_POLE:case this.N_POLE:this.akm1=Math.abs(this.phits-Proj4js.common.HALF_PI)>=Proj4js.common.EPSLN?Math.cos(this.phits)/Math.tan(Proj4js.common.FORTPI-.5*this.phits):2*this.k0}},forward:function(e){var t=e.x;t=Proj4js.common.adjust_lon(t-this.long0);var i,n,r=e.y;if(this.sphere){var s,a,o,l;s=Math.sin(r);a=Math.cos(r);o=Math.cos(t);l=Math.sin(t);switch(this.mode){case this.EQUIT:(n=1+a*o)<=Proj4js.common.EPSLN&&Proj4js.reportError("stere:forward:Equit");i=(n=this.akm1/n)*a*l;n*=s;break;case this.OBLIQ:(n=1+this.sinph0*s+this.cosph0*a*o)<=Proj4js.common.EPSLN&&Proj4js.reportError("stere:forward:Obliq");i=(n=this.akm1/n)*a*l;n*=this.cosph0*s-this.sinph0*a*o;break;case this.N_POLE:o=-o;r=-r;case this.S_POLE:Math.abs(r-Proj4js.common.HALF_PI)<this.TOL&&Proj4js.reportError("stere:forward:S_POLE");i=l*(n=this.akm1*Math.tan(Proj4js.common.FORTPI+.5*r));n*=o}}else{o=Math.cos(t);l=Math.sin(t);s=Math.sin(r);var c,u;if(this.mode==this.OBLIQ||this.mode==this.EQUIT){var h=2*Math.atan(this.ssfn_(r,s,this.e));c=Math.sin(h-Proj4js.common.HALF_PI);u=Math.cos(h)}switch(this.mode){case this.OBLIQ:n=(p=this.akm1/(this.cosX1*(1+this.sinX1*c+this.cosX1*u*o)))*(this.cosX1*c-this.sinX1*u*o);i=p*u;break;case this.EQUIT:var p;n=(p=2*this.akm1/(1+u*o))*c;i=p*u;break;case this.S_POLE:r=-r;o=-o;s=-s;case this.N_POLE:n=-(i=this.akm1*Proj4js.common.tsfnz(this.e,r,s))*o}i*=l}e.x=i*this.a+this.x0;e.y=n*this.a+this.y0;return e},inverse:function(e){var t,i,n,r,s,a,o=(e.x-this.x0)/this.a,l=(e.y-this.y0)/this.a,c=0,u=0,h=0,p=0;if(this.sphere){var d,f,m,y;f=Math.sqrt(o*o+l*l);d=2*Math.atan(f/this.akm1);m=Math.sin(d);y=Math.cos(d);t=0;switch(this.mode){case this.EQUIT:i=Math.abs(f)<=Proj4js.common.EPSLN?0:Math.asin(l*m/f);0==y&&0==o||(t=Math.atan2(o*m,y*f));break;case this.OBLIQ:i=Math.abs(f)<=Proj4js.common.EPSLN?this.phi0:Math.asin(y*this.sinph0+l*m*this.cosph0/f);0==(d=y-this.sinph0*Math.sin(i))&&0==o||(t=Math.atan2(o*m*this.cosph0,d*f));break;case this.N_POLE:l=-l;case this.S_POLE:i=Math.abs(f)<=Proj4js.common.EPSLN?this.phi0:Math.asin(this.mode==this.S_POLE?-y:y);t=0==o&&0==l?0:Math.atan2(o,l)}e.x=Proj4js.common.adjust_lon(t+this.long0);e.y=i}else{s=Math.sqrt(o*o+l*l);switch(this.mode){case this.OBLIQ:case this.EQUIT:c=2*Math.atan2(s*this.cosX1,this.akm1);n=Math.cos(c);r=Math.sin(c);u=0==s?Math.asin(n*this.sinX1):Math.asin(n*this.sinX1+l*r*this.cosX1/s);c=Math.tan(.5*(Proj4js.common.HALF_PI+u));o*=r;l=s*this.cosX1*n-l*this.sinX1*r;p=Proj4js.common.HALF_PI;h=.5*this.e;break;case this.N_POLE:l=-l;case this.S_POLE:c=-s/this.akm1;u=Proj4js.common.HALF_PI-2*Math.atan(c);p=-Proj4js.common.HALF_PI;h=-.5*this.e}for(a=this.NITER;a--;u=i){r=this.e*Math.sin(u);i=2*Math.atan(c*Math.pow((1+r)/(1-r),h))-p;if(Math.abs(u-i)<this.CONV){this.mode==this.S_POLE&&(i=-i);t=0==o&&0==l?0:Math.atan2(o,l);e.x=Proj4js.common.adjust_lon(t+this.long0);e.y=i;return e}}}}};Proj4js.Proj.nzmg={iterations:1,init:function(){this.A=new Array;this.A[1]=.6399175073;this.A[2]=-.1358797613;this.A[3]=.063294409;this.A[4]=-.02526853;this.A[5]=.0117879;this.A[6]=-.0055161;this.A[7]=.0026906;this.A[8]=-.001333;this.A[9]=67e-5;this.A[10]=-34e-5;this.B_re=new Array;this.B_im=new Array;this.B_re[1]=.7557853228;this.B_im[1]=0;this.B_re[2]=.249204646;this.B_im[2]=.003371507;this.B_re[3]=-.001541739;this.B_im[3]=.04105856;this.B_re[4]=-.10162907;this.B_im[4]=.01727609;this.B_re[5]=-.26623489;this.B_im[5]=-.36249218;this.B_re[6]=-.6870983;this.B_im[6]=-1.1651967;this.C_re=new Array;this.C_im=new Array;this.C_re[1]=1.3231270439;this.C_im[1]=0;this.C_re[2]=-.577245789;this.C_im[2]=-.007809598;this.C_re[3]=.508307513;this.C_im[3]=-.112208952;this.C_re[4]=-.15094762;this.C_im[4]=.18200602;this.C_re[5]=1.01418179;this.C_im[5]=1.64497696;this.C_re[6]=1.9660549;this.C_im[6]=2.5127645;this.D=new Array;this.D[1]=1.5627014243;this.D[2]=.5185406398;this.D[3]=-.03333098;this.D[4]=-.1052906;this.D[5]=-.0368594;this.D[6]=.007317;this.D[7]=.0122;this.D[8]=.00394;this.D[9]=-.0013},forward:function(e){for(var t=e.x,i=e.y-this.lat0,n=t-this.long0,r=i/Proj4js.common.SEC_TO_RAD*1e-5,s=n,a=1,o=0,l=1;l<=10;l++){a*=r;o+=this.A[l]*a}var c,u=o,h=s,p=1,d=0,f=0,m=0;for(l=1;l<=6;l++){c=d*u+p*h;p=p*u-d*h;d=c;f=f+this.B_re[l]*p-this.B_im[l]*d;m=m+this.B_im[l]*p+this.B_re[l]*d}e.x=m*this.a+this.x0;e.y=f*this.a+this.y0;return e},inverse:function(e){for(var t,i=e.x,n=e.y,r=i-this.x0,s=(n-this.y0)/this.a,a=r/this.a,o=1,l=0,c=0,u=0,h=1;h<=6;h++){t=l*s+o*a;o=o*s-l*a;l=t;c=c+this.C_re[h]*o-this.C_im[h]*l;u=u+this.C_im[h]*o+this.C_re[h]*l}for(var p=0;p<this.iterations;p++){var d,f=c,m=u,y=s,g=a;for(h=2;h<=6;h++){d=m*c+f*u;f=f*c-m*u;m=d;y+=(h-1)*(this.B_re[h]*f-this.B_im[h]*m);g+=(h-1)*(this.B_im[h]*f+this.B_re[h]*m)}f=1;m=0;var C=this.B_re[1],v=this.B_im[1];for(h=2;h<=6;h++){d=m*c+f*u;f=f*c-m*u;m=d;C+=h*(this.B_re[h]*f-this.B_im[h]*m);v+=h*(this.B_im[h]*f+this.B_re[h]*m)}var T=C*C+v*v;c=(y*C+g*v)/T;u=(g*C-y*v)/T}var L=c,w=u,b=1,S=0;for(h=1;h<=9;h++){b*=L;S+=this.D[h]*b}var E=this.lat0+S*Proj4js.common.SEC_TO_RAD*1e5,O=this.long0+w;e.x=O;e.y=E;return e}};Proj4js.Proj.mill={init:function(){},forward:function(e){var t=e.x,i=e.y,n=Proj4js.common.adjust_lon(t-this.long0),r=this.x0+this.a*n,s=this.y0+this.a*Math.log(Math.tan(Proj4js.common.PI/4+i/2.5))*1.25;e.x=r;e.y=s;return e},inverse:function(e){e.x-=this.x0;e.y-=this.y0;var t=Proj4js.common.adjust_lon(this.long0+e.x/this.a),i=2.5*(Math.atan(Math.exp(.8*e.y/this.a))-Proj4js.common.PI/4);e.x=t;e.y=i;return e}};Proj4js.Proj.gnom={init:function(e){this.sin_p14=Math.sin(this.lat0);this.cos_p14=Math.cos(this.lat0);this.infinity_dist=1e3*this.a;this.rc=1},forward:function(e){var t,i,n,r,s,a,o,l=e.x,c=e.y;n=Proj4js.common.adjust_lon(l-this.long0);t=Math.sin(c);i=Math.cos(c);r=Math.cos(n);s=this.sin_p14*t+this.cos_p14*i*r;1;if(s>0||Math.abs(s)<=Proj4js.common.EPSLN){a=this.x0+1*this.a*i*Math.sin(n)/s;o=this.y0+1*this.a*(this.cos_p14*t-this.sin_p14*i*r)/s}else{Proj4js.reportError("orthoFwdPointError");a=this.x0+this.infinity_dist*i*Math.sin(n);o=this.y0+this.infinity_dist*(this.cos_p14*t-this.sin_p14*i*r)}e.x=a;e.y=o;return e},inverse:function(e){var t,i,n,r,s,a;e.x=(e.x-this.x0)/this.a;e.y=(e.y-this.y0)/this.a;e.x/=this.k0;e.y/=this.k0;if(t=Math.sqrt(e.x*e.x+e.y*e.y)){r=Math.atan2(t,this.rc);i=Math.sin(r);n=Math.cos(r);a=Proj4js.common.asinz(n*this.sin_p14+e.y*i*this.cos_p14/t);s=Math.atan2(e.x*i,t*this.cos_p14*n-e.y*this.sin_p14*i);s=Proj4js.common.adjust_lon(this.long0+s)}else{a=this.phic0;s=0}e.x=s;e.y=a;return e}};Proj4js.Proj.sinu={init:function(){if(this.sphere){this.n=1;this.m=0;this.es=0;this.C_y=Math.sqrt((this.m+1)/this.n);this.C_x=this.C_y/(this.m+1)}else this.en=Proj4js.common.pj_enfn(this.es)},forward:function(e){var t,i,n=e.x,r=e.y;n=Proj4js.common.adjust_lon(n-this.long0);if(this.sphere){if(this.m)for(var s=this.n*Math.sin(r),a=Proj4js.common.MAX_ITER;a;--a){var o=(this.m*r+Math.sin(r)-s)/(this.m+Math.cos(r));r-=o;if(Math.abs(o)<Proj4js.common.EPSLN)break}else r=1!=this.n?Math.asin(this.n*Math.sin(r)):r;t=this.a*this.C_x*n*(this.m+Math.cos(r));i=this.a*this.C_y*r}else{var l=Math.sin(r),c=Math.cos(r);i=this.a*Proj4js.common.pj_mlfn(r,l,c,this.en);t=this.a*n*c/Math.sqrt(1-this.es*l*l)}e.x=t;e.y=i;return e},inverse:function(e){var t,i,n;e.x-=this.x0;e.y-=this.y0;t=e.y/this.a;if(this.sphere){e.y/=this.C_y;t=this.m?Math.asin((this.m*e.y+Math.sin(e.y))/this.n):1!=this.n?Math.asin(Math.sin(e.y)/this.n):e.y;n=e.x/(this.C_x*(this.m+Math.cos(e.y)))}else{t=Proj4js.common.pj_inv_mlfn(e.y/this.a,this.es,this.en);var r=Math.abs(t);if(r<Proj4js.common.HALF_PI){r=Math.sin(t);i=this.long0+e.x*Math.sqrt(1-this.es*r*r)/(this.a*Math.cos(t));n=Proj4js.common.adjust_lon(i)}else r-Proj4js.common.EPSLN<Proj4js.common.HALF_PI&&(n=this.long0)}e.x=n;e.y=t;return e}};Proj4js.Proj.vandg={init:function(){this.R=6370997},forward:function(e){var t,i,n=e.x,r=e.y,s=Proj4js.common.adjust_lon(n-this.long0);if(Math.abs(r)<=Proj4js.common.EPSLN){t=this.x0+this.R*s;i=this.y0}var a=Proj4js.common.asinz(2*Math.abs(r/Proj4js.common.PI));if(Math.abs(s)<=Proj4js.common.EPSLN||Math.abs(Math.abs(r)-Proj4js.common.HALF_PI)<=Proj4js.common.EPSLN){t=this.x0;i=r>=0?this.y0+Proj4js.common.PI*this.R*Math.tan(.5*a):this.y0+Proj4js.common.PI*this.R*-Math.tan(.5*a)}var o=.5*Math.abs(Proj4js.common.PI/s-s/Proj4js.common.PI),l=o*o,c=Math.sin(a),u=Math.cos(a),h=u/(c+u-1),p=h*h,d=h*(2/c-1),f=d*d,m=Proj4js.common.PI*this.R*(o*(h-f)+Math.sqrt(l*(h-f)*(h-f)-(f+l)*(p-f)))/(f+l);s<0&&(m=-m);t=this.x0+m;m=Math.abs(m/(Proj4js.common.PI*this.R));i=r>=0?this.y0+Proj4js.common.PI*this.R*Math.sqrt(1-m*m-2*o*m):this.y0-Proj4js.common.PI*this.R*Math.sqrt(1-m*m-2*o*m);e.x=t;e.y=i;return e},inverse:function(e){var t,i,n,r,s,a,o,l,c,u,h,p;e.x-=this.x0;e.y-=this.y0;h=Proj4js.common.PI*this.R;s=(n=e.x/h)*n+(r=e.y/h)*r;h=3*(r*r/(l=-2*(a=-Math.abs(r)*(1+s))+1+2*r*r+s*s)+(2*(o=a-2*r*r+n*n)*o*o/l/l/l-9*a*o/l/l)/27)/(c=(a-o*o/3/l)/l)/(u=2*Math.sqrt(-c/3));Math.abs(h)>1&&(h=h>=0?1:-1);p=Math.acos(h)/3;i=e.y>=0?(-u*Math.cos(p+Proj4js.common.PI/3)-o/3/l)*Proj4js.common.PI:-(-u*Math.cos(p+Proj4js.common.PI/3)-o/3/l)*Proj4js.common.PI;Math.abs(n)<Proj4js.common.EPSLN&&(t=this.long0);t=Proj4js.common.adjust_lon(this.long0+Proj4js.common.PI*(s-1+Math.sqrt(1+2*(n*n-r*r)+s*s))/2/n);e.x=t;e.y=i;return e}};Proj4js.Proj.cea={init:function(){},forward:function(e){var t=e.x,i=e.y,n=Proj4js.common.adjust_lon(t-this.long0),r=this.x0+this.a*n*Math.cos(this.lat_ts),s=this.y0+this.a*Math.sin(i)/Math.cos(this.lat_ts);e.x=r;e.y=s;return e},inverse:function(e){e.x-=this.x0;e.y-=this.y0;var t=Proj4js.common.adjust_lon(this.long0+e.x/this.a/Math.cos(this.lat_ts)),i=Math.asin(e.y/this.a*Math.cos(this.lat_ts));e.x=t;e.y=i;return e}};Proj4js.Proj.eqc={init:function(){this.x0||(this.x0=0);this.y0||(this.y0=0);this.lat0||(this.lat0=0);this.long0||(this.long0=0);this.lat_ts||(this.lat_ts=0);this.title||(this.title="Equidistant Cylindrical (Plate Carre)");this.rc=Math.cos(this.lat_ts)},forward:function(e){var t=e.x,i=e.y,n=Proj4js.common.adjust_lon(t-this.long0),r=Proj4js.common.adjust_lat(i-this.lat0);e.x=this.x0+this.a*n*this.rc;e.y=this.y0+this.a*r;return e},inverse:function(e){var t=e.x,i=e.y;e.x=Proj4js.common.adjust_lon(this.long0+(t-this.x0)/(this.a*this.rc));e.y=Proj4js.common.adjust_lat(this.lat0+(i-this.y0)/this.a);return e}};Proj4js.Proj.cass={init:function(){if(!this.sphere){this.en=Proj4js.common.pj_enfn(this.es);this.m0=Proj4js.common.pj_mlfn(this.lat0,Math.sin(this.lat0),Math.cos(this.lat0),this.en)}},C1:.16666666666666666,C2:.008333333333333333,C3:.041666666666666664,C4:.3333333333333333,C5:.06666666666666667,forward:function(e){var t,i,n=e.x,r=e.y;n=Proj4js.common.adjust_lon(n-this.long0);if(this.sphere){t=Math.asin(Math.cos(r)*Math.sin(n));i=Math.atan2(Math.tan(r),Math.cos(n))-this.phi0}else{this.n=Math.sin(r);this.c=Math.cos(r);i=Proj4js.common.pj_mlfn(r,this.n,this.c,this.en);this.n=1/Math.sqrt(1-this.es*this.n*this.n);this.tn=Math.tan(r);this.t=this.tn*this.tn;this.a1=n*this.c;this.c*=this.es*this.c/(1-this.es);this.a2=this.a1*this.a1;t=this.n*this.a1*(1-this.a2*this.t*(this.C1-(8-this.t+8*this.c)*this.a2*this.C2));i-=this.m0-this.n*this.tn*this.a2*(.5+(5-this.t+6*this.c)*this.a2*this.C3)}e.x=this.a*t+this.x0;e.y=this.a*i+this.y0;return e},inverse:function(e){e.x-=this.x0;e.y-=this.y0;var t,i,n=e.x/this.a,r=e.y/this.a;if(this.sphere){this.dd=r+this.lat0;t=Math.asin(Math.sin(this.dd)*Math.cos(n));i=Math.atan2(Math.tan(n),Math.cos(this.dd))}else{var s=Proj4js.common.pj_inv_mlfn(this.m0+r,this.es,this.en);this.tn=Math.tan(s);this.t=this.tn*this.tn;this.n=Math.sin(s);this.r=1/(1-this.es*this.n*this.n);this.n=Math.sqrt(this.r);this.r*=(1-this.es)*this.n;this.dd=n/this.n;this.d2=this.dd*this.dd;t=s-this.n*this.tn/this.r*this.d2*(.5-(1+3*this.t)*this.d2*this.C3);i=this.dd*(1+this.t*this.d2*(-this.C4+(1+3*this.t)*this.d2*this.C5))/Math.cos(s)}e.x=Proj4js.common.adjust_lon(this.long0+i);e.y=t;return e}};Proj4js.Proj.gauss={init:function(){var e=Math.sin(this.lat0),t=Math.cos(this.lat0);t*=t;this.rc=Math.sqrt(1-this.es)/(1-this.es*e*e);this.C=Math.sqrt(1+this.es*t*t/(1-this.es));this.phic0=Math.asin(e/this.C);this.ratexp=.5*this.C*this.e;this.K=Math.tan(.5*this.phic0+Proj4js.common.FORTPI)/(Math.pow(Math.tan(.5*this.lat0+Proj4js.common.FORTPI),this.C)*Proj4js.common.srat(this.e*e,this.ratexp))},forward:function(e){var t=e.x,i=e.y;e.y=2*Math.atan(this.K*Math.pow(Math.tan(.5*i+Proj4js.common.FORTPI),this.C)*Proj4js.common.srat(this.e*Math.sin(i),this.ratexp))-Proj4js.common.HALF_PI;e.x=this.C*t;return e},inverse:function(e){for(var t=e.x/this.C,i=e.y,n=Math.pow(Math.tan(.5*i+Proj4js.common.FORTPI)/this.K,1/this.C),r=Proj4js.common.MAX_ITER;r>0;--r){i=2*Math.atan(n*Proj4js.common.srat(this.e*Math.sin(e.y),-.5*this.e))-Proj4js.common.HALF_PI;if(Math.abs(i-e.y)<1e-14)break;e.y=i}if(!r){Proj4js.reportError("gauss:inverse:convergence failed");return null}e.x=t;e.y=i;return e}};Proj4js.Proj.omerc={init:function(){this.mode||(this.mode=0);if(!this.lon1){this.lon1=0;this.mode=1}this.lon2||(this.lon2=0);this.lat2||(this.lat2=0);var e=this.b/this.a,t=1-Math.pow(e,2);Math.sqrt(t);this.sin_p20=Math.sin(this.lat0);this.cos_p20=Math.cos(this.lat0);this.con=1-this.es*this.sin_p20*this.sin_p20;this.com=Math.sqrt(1-t);this.bl=Math.sqrt(1+this.es*Math.pow(this.cos_p20,4)/(1-t));this.al=this.a*this.bl*this.k0*this.com/this.con;if(Math.abs(this.lat0)<Proj4js.common.EPSLN){this.ts=1;this.d=1;this.el=1}else{this.ts=Proj4js.common.tsfnz(this.e,this.lat0,this.sin_p20);this.con=Math.sqrt(this.con);this.d=this.bl*this.com/(this.cos_p20*this.con);this.d*this.d-1>0?this.lat0>=0?this.f=this.d+Math.sqrt(this.d*this.d-1):this.f=this.d-Math.sqrt(this.d*this.d-1):this.f=this.d;this.el=this.f*Math.pow(this.ts,this.bl)}if(0!=this.mode){this.g=.5*(this.f-1/this.f);this.gama=Proj4js.common.asinz(Math.sin(this.alpha)/this.d);this.longc=this.longc-Proj4js.common.asinz(this.g*Math.tan(this.gama))/this.bl;this.con=Math.abs(this.lat0);if(this.con>Proj4js.common.EPSLN&&Math.abs(this.con-Proj4js.common.HALF_PI)>Proj4js.common.EPSLN){this.singam=Math.sin(this.gama);this.cosgam=Math.cos(this.gama);this.sinaz=Math.sin(this.alpha);this.cosaz=Math.cos(this.alpha);this.lat0>=0?this.u=this.al/this.bl*Math.atan(Math.sqrt(this.d*this.d-1)/this.cosaz):this.u=-this.al/this.bl*Math.atan(Math.sqrt(this.d*this.d-1)/this.cosaz)}else Proj4js.reportError("omerc:Init:DataError")}else{this.sinphi=Math.sin(this.at1);this.ts1=Proj4js.common.tsfnz(this.e,this.lat1,this.sinphi);this.sinphi=Math.sin(this.lat2);this.ts2=Proj4js.common.tsfnz(this.e,this.lat2,this.sinphi);this.h=Math.pow(this.ts1,this.bl);this.l=Math.pow(this.ts2,this.bl);this.f=this.el/this.h;this.g=.5*(this.f-1/this.f);this.j=(this.el*this.el-this.l*this.h)/(this.el*this.el+this.l*this.h);this.p=(this.l-this.h)/(this.l+this.h);this.dlon=this.lon1-this.lon2;this.dlon<-Proj4js.common.PI&&(this.lon2=this.lon2-2*Proj4js.common.PI);this.dlon>Proj4js.common.PI&&(this.lon2=this.lon2+2*Proj4js.common.PI);this.dlon=this.lon1-this.lon2;this.longc=.5*(this.lon1+this.lon2)-Math.atan(this.j*Math.tan(.5*this.bl*this.dlon)/this.p)/this.bl;this.dlon=Proj4js.common.adjust_lon(this.lon1-this.longc);this.gama=Math.atan(Math.sin(this.bl*this.dlon)/this.g);this.alpha=Proj4js.common.asinz(this.d*Math.sin(this.gama));Math.abs(this.lat1-this.lat2)<=Proj4js.common.EPSLN?Proj4js.reportError("omercInitDataError"):this.con=Math.abs(this.lat1);this.con<=Proj4js.common.EPSLN||Math.abs(this.con-Proj4js.common.HALF_PI)<=Proj4js.common.EPSLN?Proj4js.reportError("omercInitDataError"):Math.abs(Math.abs(this.lat0)-Proj4js.common.HALF_PI)<=Proj4js.common.EPSLN&&Proj4js.reportError("omercInitDataError");this.singam=Math.sin(this.gam);this.cosgam=Math.cos(this.gam);this.sinaz=Math.sin(this.alpha);this.cosaz=Math.cos(this.alpha);this.lat0>=0?this.u=this.al/this.bl*Math.atan(Math.sqrt(this.d*this.d-1)/this.cosaz):this.u=-this.al/this.bl*Math.atan(Math.sqrt(this.d*this.d-1)/this.cosaz)}},forward:function(e){var t,i,n,r,s,a,o,l,c,u,h,p=e.x,d=e.y;t=Math.sin(d);u=Proj4js.common.adjust_lon(p-this.longc);a=Math.sin(this.bl*u);if(Math.abs(Math.abs(d)-Proj4js.common.HALF_PI)>Proj4js.common.EPSLN){h=Proj4js.common.tsfnz(this.e,d,t);i=.5*((r=this.el/Math.pow(h,this.bl))+1/r);o=((c=.5*(r-1/r))*this.singam-a*this.cosgam)/i;n=Math.cos(this.bl*u);if(Math.abs(n)<1e-7)s=this.al*this.bl*u;else{s=this.al*Math.atan((c*this.cosgam+a*this.singam)/n)/this.bl;n<0&&(s+=Proj4js.common.PI*this.al/this.bl)}}else{o=d>=0?this.singam:-this.singam;s=this.al*d/this.bl}Math.abs(Math.abs(o)-1)<=Proj4js.common.EPSLN&&Proj4js.reportError("omercFwdInfinity");l=.5*this.al*Math.log((1-o)/(1+o))/this.bl;s-=this.u;var f=this.x0+l*this.cosaz+s*this.sinaz,m=this.y0+s*this.cosaz-l*this.sinaz;e.x=f;e.y=m;return e},inverse:function(e){var t,i,n,r,s,a,o,l,c,u,h,p;e.x-=this.x0;e.y-=this.y0;0;r=e.x*this.cosaz-e.y*this.sinaz;s=e.y*this.cosaz+e.x*this.sinaz;s+=this.u;o=.5*((a=Math.exp(-this.bl*r/this.al))-1/a);i=.5*(a+1/a);u=((c=Math.sin(this.bl*s/this.al))*this.cosgam+o*this.singam)/i;if(Math.abs(Math.abs(u)-1)<=Proj4js.common.EPSLN){h=this.longc;p=u>=0?Proj4js.common.HALF_PI:-Proj4js.common.HALF_PI}else{n=1/this.bl;l=Math.pow(this.el/Math.sqrt((1+u)/(1-u)),n);p=Proj4js.common.phi2z(this.e,l);t=this.longc-Math.atan2(o*this.cosgam-c*this.singam,n)/this.bl;h=Proj4js.common.adjust_lon(t)}e.x=h;e.y=p;return e}};Proj4js.Proj.lcc={init:function(){this.lat2||(this.lat2=this.lat0);this.k0||(this.k0=1);if(Math.abs(this.lat1+this.lat2)<Proj4js.common.EPSLN)Proj4js.reportError("lcc:init: Equal Latitudes");else{var e=this.b/this.a;this.e=Math.sqrt(1-e*e);var t=Math.sin(this.lat1),i=Math.cos(this.lat1),n=Proj4js.common.msfnz(this.e,t,i),r=Proj4js.common.tsfnz(this.e,this.lat1,t),s=Math.sin(this.lat2),a=Math.cos(this.lat2),o=Proj4js.common.msfnz(this.e,s,a),l=Proj4js.common.tsfnz(this.e,this.lat2,s),c=Proj4js.common.tsfnz(this.e,this.lat0,Math.sin(this.lat0));Math.abs(this.lat1-this.lat2)>Proj4js.common.EPSLN?this.ns=Math.log(n/o)/Math.log(r/l):this.ns=t;this.f0=n/(this.ns*Math.pow(r,this.ns));this.rh=this.a*this.f0*Math.pow(c,this.ns);this.title||(this.title="Lambert Conformal Conic")}},forward:function(e){var t=e.x,i=e.y;if(!(i<=90&&i>=-90&&t<=180&&t>=-180)){Proj4js.reportError("lcc:forward: llInputOutOfRange: "+t+" : "+i);return null}var n,r,s=Math.abs(Math.abs(i)-Proj4js.common.HALF_PI);if(s>Proj4js.common.EPSLN){n=Proj4js.common.tsfnz(this.e,i,Math.sin(i));r=this.a*this.f0*Math.pow(n,this.ns)}else{if((s=i*this.ns)<=0){Proj4js.reportError("lcc:forward: No Projection");return null}r=0}var a=this.ns*Proj4js.common.adjust_lon(t-this.long0);e.x=this.k0*(r*Math.sin(a))+this.x0;e.y=this.k0*(this.rh-r*Math.cos(a))+this.y0;return e},inverse:function(e){var t,i,n,r,s,a=(e.x-this.x0)/this.k0,o=this.rh-(e.y-this.y0)/this.k0;if(this.ns>0){t=Math.sqrt(a*a+o*o);i=1}else{t=-Math.sqrt(a*a+o*o);i=-1}var l=0;0!=t&&(l=Math.atan2(i*a,i*o));if(0!=t||this.ns>0){i=1/this.ns;n=Math.pow(t/(this.a*this.f0),i);if(-9999==(r=Proj4js.common.phi2z(this.e,n)))return null}else r=-Proj4js.common.HALF_PI;s=Proj4js.common.adjust_lon(l/this.ns+this.long0);e.x=s;e.y=r;return e}};Proj4js.Proj.laea={S_POLE:1,N_POLE:2,EQUIT:3,OBLIQ:4,init:function(){var e=Math.abs(this.lat0);Math.abs(e-Proj4js.common.HALF_PI)<Proj4js.common.EPSLN?this.mode=this.lat0<0?this.S_POLE:this.N_POLE:Math.abs(e)<Proj4js.common.EPSLN?this.mode=this.EQUIT:this.mode=this.OBLIQ;if(this.es>0){var t;this.qp=Proj4js.common.qsfnz(this.e,1);this.mmf=.5/(1-this.es);this.apa=this.authset(this.es);switch(this.mode){case this.N_POLE:case this.S_POLE:this.dd=1;break;case this.EQUIT:this.rq=Math.sqrt(.5*this.qp);this.dd=1/this.rq;this.xmf=1;this.ymf=.5*this.qp;break;case this.OBLIQ:this.rq=Math.sqrt(.5*this.qp);t=Math.sin(this.lat0);this.sinb1=Proj4js.common.qsfnz(this.e,t)/this.qp;this.cosb1=Math.sqrt(1-this.sinb1*this.sinb1);this.dd=Math.cos(this.lat0)/(Math.sqrt(1-this.es*t*t)*this.rq*this.cosb1);this.ymf=(this.xmf=this.rq)/this.dd;this.xmf*=this.dd}}else if(this.mode==this.OBLIQ){this.sinph0=Math.sin(this.lat0);this.cosph0=Math.cos(this.lat0)}},forward:function(e){var t,i,n=e.x,r=e.y;n=Proj4js.common.adjust_lon(n-this.long0);if(this.sphere){var s;l=Math.sin(r);s=Math.cos(r);a=Math.cos(n);switch(this.mode){case this.OBLIQ:case this.EQUIT:if((i=this.mode==this.EQUIT?1+s*a:1+this.sinph0*l+this.cosph0*s*a)<=Proj4js.common.EPSLN){Proj4js.reportError("laea:fwd:y less than eps");return null}t=(i=Math.sqrt(2/i))*s*Math.sin(n);i*=this.mode==this.EQUIT?l:this.cosph0*l-this.sinph0*s*a;break;case this.N_POLE:a=-a;case this.S_POLE:if(Math.abs(r+this.phi0)<Proj4js.common.EPSLN){Proj4js.reportError("laea:fwd:phi < eps");return null}i=Proj4js.common.FORTPI-.5*r;t=(i=2*(this.mode==this.S_POLE?Math.cos(i):Math.sin(i)))*Math.sin(n);i*=a}}else{var a,o,l,c,u=0,h=0,p=0;a=Math.cos(n);o=Math.sin(n);l=Math.sin(r);c=Proj4js.common.qsfnz(this.e,l);if(this.mode==this.OBLIQ||this.mode==this.EQUIT){u=c/this.qp;h=Math.sqrt(1-u*u)}switch(this.mode){case this.OBLIQ:p=1+this.sinb1*u+this.cosb1*h*a;break;case this.EQUIT:p=1+h*a;break;case this.N_POLE:p=Proj4js.common.HALF_PI+r;c=this.qp-c;break;case this.S_POLE:p=r-Proj4js.common.HALF_PI;c=this.qp+c}if(Math.abs(p)<Proj4js.common.EPSLN){Proj4js.reportError("laea:fwd:b < eps");return null}switch(this.mode){case this.OBLIQ:case this.EQUIT:p=Math.sqrt(2/p);i=this.mode==this.OBLIQ?this.ymf*p*(this.cosb1*u-this.sinb1*h*a):(p=Math.sqrt(2/(1+h*a)))*u*this.ymf;t=this.xmf*p*h*o;break;case this.N_POLE:case this.S_POLE:if(c>=0){t=(p=Math.sqrt(c))*o;i=a*(this.mode==this.S_POLE?p:-p)}else t=i=0}}e.x=this.a*t+this.x0;e.y=this.a*i+this.y0;return e},inverse:function(e){e.x-=this.x0;e.y-=this.y0;var t,i,n=e.x/this.a,r=e.y/this.a;if(this.sphere){var s,a=0,o=0;if((i=.5*(s=Math.sqrt(n*n+r*r)))>1){Proj4js.reportError("laea:Inv:DataError");return null}i=2*Math.asin(i);if(this.mode==this.OBLIQ||this.mode==this.EQUIT){o=Math.sin(i);a=Math.cos(i)}switch(this.mode){case this.EQUIT:i=Math.abs(s)<=Proj4js.common.EPSLN?0:Math.asin(r*o/s);n*=o;r=a*s;break;case this.OBLIQ:i=Math.abs(s)<=Proj4js.common.EPSLN?this.phi0:Math.asin(a*this.sinph0+r*o*this.cosph0/s);n*=o*this.cosph0;r=(a-Math.sin(i)*this.sinph0)*s;break;case this.N_POLE:r=-r;i=Proj4js.common.HALF_PI-i;break;case this.S_POLE:i-=Proj4js.common.HALF_PI}t=0!=r||this.mode!=this.EQUIT&&this.mode!=this.OBLIQ?Math.atan2(n,r):0}else{var l,c,u,h,p=0;switch(this.mode){case this.EQUIT:case this.OBLIQ:n/=this.dd;r*=this.dd;if((h=Math.sqrt(n*n+r*r))<Proj4js.common.EPSLN){e.x=0;e.y=this.phi0;return e}c=2*Math.asin(.5*h/this.rq);l=Math.cos(c);n*=c=Math.sin(c);if(this.mode==this.OBLIQ){p=l*this.sinb1+r*c*this.cosb1/h;u=this.qp*p;r=h*this.cosb1*l-r*this.sinb1*c}else{p=r*c/h;u=this.qp*p;r=h*l}break;case this.N_POLE:r=-r;case this.S_POLE:if(!(u=n*n+r*r)){e.x=0;e.y=this.phi0;return e}p=1-u/this.qp;this.mode==this.S_POLE&&(p=-p)}t=Math.atan2(n,r);i=this.authlat(Math.asin(p),this.apa)}e.x=Proj4js.common.adjust_lon(this.long0+t);e.y=i;return e},P00:.3333333333333333,P01:.17222222222222222,P02:.10257936507936508,P10:.06388888888888888,P11:.0664021164021164,P20:.016415012942191543,authset:function(e){var t,i=new Array;i[0]=e*this.P00;t=e*e;i[0]+=t*this.P01;i[1]=t*this.P10;t*=e;i[0]+=t*this.P02;i[1]+=t*this.P11;i[2]=t*this.P20;return i},authlat:function(e,t){var i=e+e;return e+t[0]*Math.sin(i)+t[1]*Math.sin(i+i)+t[2]*Math.sin(i+i+i)}};Proj4js.Proj.aeqd={init:function(){this.sin_p12=Math.sin(this.lat0);this.cos_p12=Math.cos(this.lat0)},forward:function(e){var t,i=e.x,n=(e.y,Math.sin(e.y)),r=Math.cos(e.y),s=Proj4js.common.adjust_lon(i-this.long0),a=Math.cos(s),o=this.sin_p12*n+this.cos_p12*r*a;if(Math.abs(Math.abs(o)-1)<Proj4js.common.EPSLN){t=1;if(o<0){Proj4js.reportError("aeqd:Fwd:PointError");return}}else{var l=Math.acos(o);t=l/Math.sin(l)}e.x=this.x0+this.a*t*r*Math.sin(s);e.y=this.y0+this.a*t*(this.cos_p12*n-this.sin_p12*r*a);return e},inverse:function(e){e.x-=this.x0;e.y-=this.y0;var t=Math.sqrt(e.x*e.x+e.y*e.y);if(!(t>2*Proj4js.common.HALF_PI*this.a)){var i,n=t/this.a,r=Math.sin(n),s=Math.cos(n),a=this.long0;if(Math.abs(t)<=Proj4js.common.EPSLN)i=this.lat0;else{i=Proj4js.common.asinz(s*this.sin_p12+e.y*r*this.cos_p12/t);var o=Math.abs(this.lat0)-Proj4js.common.HALF_PI;if(Math.abs(o)<=Proj4js.common.EPSLN)a=this.lat0>=0?Proj4js.common.adjust_lon(this.long0+Math.atan2(e.x,-e.y)):Proj4js.common.adjust_lon(this.long0-Math.atan2(-e.x,e.y));else{o=s-this.sin_p12*Math.sin(i);if(Math.abs(o)<Proj4js.common.EPSLN&&Math.abs(e.x)<Proj4js.common.EPSLN);else{Math.atan2(e.x*r*this.cos_p12,o*t);a=Proj4js.common.adjust_lon(this.long0+Math.atan2(e.x*r*this.cos_p12,o*t))}}}e.x=a;e.y=i;return e}Proj4js.reportError("aeqdInvDataError")}};Proj4js.Proj.moll={init:function(){},forward:function(e){for(var t=e.x,i=e.y,n=Proj4js.common.adjust_lon(t-this.long0),r=i,s=Proj4js.common.PI*Math.sin(i),a=0;;a++){var o=-(r+Math.sin(r)-s)/(1+Math.cos(r));r+=o;if(Math.abs(o)<Proj4js.common.EPSLN)break;a>=50&&Proj4js.reportError("moll:Fwd:IterationError")}r/=2;Proj4js.common.PI/2-Math.abs(i)<Proj4js.common.EPSLN&&(n=0);var l=.900316316158*this.a*n*Math.cos(r)+this.x0,c=1.4142135623731*this.a*Math.sin(r)+this.y0;e.x=l;e.y=c;return e},inverse:function(e){e.x-=this.x0;var t=e.y/(1.4142135623731*this.a);Math.abs(t)>.999999999999&&(t=.999999999999);var i=Math.asin(t),n=Proj4js.common.adjust_lon(this.long0+e.x/(.900316316158*this.a*Math.cos(i)));n<-Proj4js.common.PI&&(n=-Proj4js.common.PI);n>Proj4js.common.PI&&(n=Proj4js.common.PI);t=(2*i+Math.sin(2*i))/Proj4js.common.PI;Math.abs(t)>1&&(t=1);var r=Math.asin(t);e.x=n;e.y=r;return e}};Proj4js.defs["EPSG:25830"]="+proj=utm +zone=30 +ellps=GRS80 +units=m +no_defs";Proj4js.Proj.utm={dependsOn:"tmerc",init:function(){if(this.zone){this.lat0=0;this.long0=(6*Math.abs(this.zone)-183)*Proj4js.common.D2R;this.x0=5e5;this.y0=this.utmSouth?1e7:0;this.k0=.9996;Proj4js.Proj.tmerc.init.apply(this);this.forward=Proj4js.Proj.tmerc.forward;this.inverse=Proj4js.Proj.tmerc.inverse}else Proj4js.reportError("utm:init: zone must be specified for UTM")}};!function(e,t){var i,n,r=typeof t,s=e.location,a=e.document,o=a.documentElement,l=e.jQuery,c=e.$,u={},h=[],p=h.concat,d=h.push,f=h.slice,m=h.indexOf,y=u.toString,g=u.hasOwnProperty,C="1.10.2".trim,v=function(e,t){return new v.fn.init(e,t,n)},T=/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source,L=/\S+/g,w=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,b=/^(?:\s*(<[\w\W]+>)[^>]*|#([\w-]*))$/,S=/^<(\w+)\s*\/?>(?:<\/\1>|)$/,E=/^[\],:{}\s]*$/,O=/(?:^|:|,)(?:\s*\[)+/g,A=/\\(?:["\\\/bfnrt]|u[\da-fA-F]{4})/g,x=/"[^"\\\r\n]*"|true|false|null|-?(?:\d+\.|)\d+(?:[eE][+-]?\d+|)/g,P=/^-ms-/,_=/-([\da-z])/gi,N=function(e,t){return t.toUpperCase()},M=function(e){if(a.addEventListener||"load"===e.type||"complete"===a.readyState){k();v.ready()}},k=function(){if(a.addEventListener){a.removeEventListener("DOMContentLoaded",M,!1);e.removeEventListener("load",M,!1)}else{a.detachEvent("onreadystatechange",M);e.detachEvent("onload",M)}};v.fn=v.prototype={jquery:"1.10.2",constructor:v,init:function(e,i,n){var r,s;if(!e)return this;if("string"==typeof e){if(!(r="<"===e.charAt(0)&&">"===e.charAt(e.length-1)&&e.length>=3?[null,e,null]:b.exec(e))||!r[1]&&i)return!i||i.jquery?(i||n).find(e):this.constructor(i).find(e);if(r[1]){i=i instanceof v?i[0]:i;v.merge(this,v.parseHTML(r[1],i&&i.nodeType?i.ownerDocument||i:a,!0));if(S.test(r[1])&&v.isPlainObject(i))for(r in i)v.isFunction(this[r])?this[r](i[r]):this.attr(r,i[r]);return this}if((s=a.getElementById(r[2]))&&s.parentNode){if(s.id!==r[2])return n.find(e);this.length=1;this[0]=s}this.context=a;this.selector=e;return this}if(e.nodeType){this.context=this[0]=e;this.length=1;return this}if(v.isFunction(e))return n.ready(e);if(e.selector!==t){this.selector=e.selector;this.context=e.context}return v.makeArray(e,this)},selector:"",length:0,toArray:function(){return f.call(this)},get:function(e){return null==e?this.toArray():e<0?this[this.length+e]:this[e]},pushStack:function(e){var t=v.merge(this.constructor(),e);t.prevObject=this;t.context=this.context;return t},each:function(e,t){return v.each(this,e,t)},ready:function(e){v.ready.promise().done(e);return this},slice:function(){return this.pushStack(f.apply(this,arguments))},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},eq:function(e){var t=this.length,i=+e+(e<0?t:0);return this.pushStack(i>=0&&i<t?[this[i]]:[])},map:function(e){return this.pushStack(v.map(this,function(t,i){return e.call(t,i,t)}))},end:function(){return this.prevObject||this.constructor(null)},push:d,sort:[].sort,splice:[].splice};v.fn.init.prototype=v.fn;v.extend=v.fn.extend=function(){var e,i,n,r,s,a,o=arguments[0]||{},l=1,c=arguments.length,u=!1;if("boolean"==typeof o){u=o;o=arguments[1]||{};l=2}"object"==typeof o||v.isFunction(o)||(o={});if(c===l){o=this;--l}for(;l<c;l++)if(null!=(s=arguments[l]))for(r in s){e=o[r];if(o!==(n=s[r]))if(u&&n&&(v.isPlainObject(n)||(i=v.isArray(n)))){if(i){i=!1;a=e&&v.isArray(e)?e:[]}else a=e&&v.isPlainObject(e)?e:{};o[r]=v.extend(u,a,n)}else n!==t&&(o[r]=n)}return o};v.extend({expando:"jQuery"+("1.10.2"+Math.random()).replace(/\D/g,""),noConflict:function(t){e.$===v&&(e.$=c);t&&e.jQuery===v&&(e.jQuery=l);return v},isReady:!1,readyWait:1,holdReady:function(e){e?v.readyWait++:v.ready(!0)},ready:function(e){if(!0===e?!--v.readyWait:!v.isReady){if(!a.body)return setTimeout(v.ready);v.isReady=!0;if(!(!0!==e&&--v.readyWait>0)){i.resolveWith(a,[v]);v.fn.trigger&&v(a).trigger("ready").off("ready")}}},isFunction:function(e){return"function"===v.type(e)},isArray:Array.isArray||function(e){return"array"===v.type(e)},isWindow:function(e){return null!=e&&e==e.window},isNumeric:function(e){return!isNaN(parseFloat(e))&&isFinite(e)},type:function(e){return null==e?String(e):"object"==typeof e||"function"==typeof e?u[y.call(e)]||"object":typeof e},isPlainObject:function(e){var i;if(!e||"object"!==v.type(e)||e.nodeType||v.isWindow(e))return!1;try{if(e.constructor&&!g.call(e,"constructor")&&!g.call(e.constructor.prototype,"isPrototypeOf"))return!1}catch(e){return!1}if(v.support.ownLast)for(i in e)return g.call(e,i);for(i in e);return i===t||g.call(e,i)},isEmptyObject:function(e){var t;for(t in e)return!1;return!0},error:function(e){throw new Error(e)},parseHTML:function(e,t,i){if(!e||"string"!=typeof e)return null;if("boolean"==typeof t){i=t;t=!1}t=t||a;var n=S.exec(e),r=!i&&[];if(n)return[t.createElement(n[1])];n=v.buildFragment([e],t,r);r&&v(r).remove();return v.merge([],n.childNodes)},parseJSON:function(t){if(e.JSON&&e.JSON.parse)return e.JSON.parse(t);if(null===t)return t;if("string"==typeof t&&(t=v.trim(t))&&E.test(t.replace(A,"@").replace(x,"]").replace(O,"")))return new Function("return "+t)();v.error("Invalid JSON: "+t)},parseXML:function(i){var n;if(!i||"string"!=typeof i)return null;try{if(e.DOMParser)n=(new DOMParser).parseFromString(i,"text/xml");else{(n=new ActiveXObject("Microsoft.XMLDOM")).async="false";n.loadXML(i)}}catch(e){n=t}n&&n.documentElement&&!n.getElementsByTagName("parsererror").length||v.error("Invalid XML: "+i);return n},noop:function(){},globalEval:function(t){t&&v.trim(t)&&(e.execScript||function(t){e.eval.call(e,t)})(t)},camelCase:function(e){return e.replace(P,"ms-").replace(_,N)},nodeName:function(e,t){return e.nodeName&&e.nodeName.toLowerCase()===t.toLowerCase()},each:function(e,t,i){var n=0,r=e.length,s=R(e);if(i){if(s)for(;n<r&&!1!==t.apply(e[n],i);n++);else for(n in e)if(!1===t.apply(e[n],i))break}else if(s)for(;n<r&&!1!==t.call(e[n],n,e[n]);n++);else for(n in e)if(!1===t.call(e[n],n,e[n]))break;return e},trim:C&&!C.call("\ufeff\xa0")?function(e){return null==e?"":C.call(e)}:function(e){return null==e?"":(e+"").replace(w,"")},makeArray:function(e,t){var i=t||[];null!=e&&(R(Object(e))?v.merge(i,"string"==typeof e?[e]:e):d.call(i,e));return i},inArray:function(e,t,i){var n;if(t){if(m)return m.call(t,e,i);n=t.length;i=i?i<0?Math.max(0,n+i):i:0;for(;i<n;i++)if(i in t&&t[i]===e)return i}return-1},merge:function(e,i){var n=i.length,r=e.length,s=0;if("number"==typeof n)for(;s<n;s++)e[r++]=i[s];else for(;i[s]!==t;)e[r++]=i[s++];e.length=r;return e},grep:function(e,t,i){var n=[],r=0,s=e.length;i=!!i;for(;r<s;r++)i!==!!t(e[r],r)&&n.push(e[r]);return n},map:function(e,t,i){var n,r=0,s=e.length,a=[];if(R(e))for(;r<s;r++)null!=(n=t(e[r],r,i))&&(a[a.length]=n);else for(r in e)null!=(n=t(e[r],r,i))&&(a[a.length]=n);return p.apply([],a)},guid:1,proxy:function(e,i){var n,r,s;if("string"==typeof i){s=e[i];i=e;e=s}if(!v.isFunction(e))return t;n=f.call(arguments,2);(r=function(){return e.apply(i||this,n.concat(f.call(arguments)))}).guid=e.guid=e.guid||v.guid++;return r},access:function(e,i,n,r,s,a,o){var l=0,c=e.length,u=null==n;if("object"===v.type(n)){s=!0;for(l in n)v.access(e,i,l,n[l],!0,a,o)}else if(r!==t){s=!0;v.isFunction(r)||(o=!0);if(u)if(o){i.call(e,r);i=null}else{u=i;i=function(e,t,i){return u.call(v(e),i)}}if(i)for(;l<c;l++)i(e[l],n,o?r:r.call(e[l],l,i(e[l],n)))}return s?e:u?i.call(e):c?i(e[0],n):a},now:function(){return(new Date).getTime()},swap:function(e,t,i,n){var r,s,a={};for(s in t){a[s]=e.style[s];e.style[s]=t[s]}r=i.apply(e,n||[]);for(s in t)e.style[s]=a[s];return r}});v.ready.promise=function(t){if(!i){i=v.Deferred();if("complete"===a.readyState)setTimeout(v.ready);else if(a.addEventListener){a.addEventListener("DOMContentLoaded",M,!1);e.addEventListener("load",M,!1)}else{a.attachEvent("onreadystatechange",M);e.attachEvent("onload",M);var n=!1;try{n=null==e.frameElement&&a.documentElement}catch(e){}n&&n.doScroll&&function e(){if(!v.isReady){try{n.doScroll("left")}catch(t){return setTimeout(e,50)}k();v.ready()}}()}}return i.promise(t)};v.each("Boolean Number String Function Array Date RegExp Object Error".split(" "),function(e,t){u["[object "+t+"]"]=t.toLowerCase()});function R(e){var t=e.length,i=v.type(e);return!v.isWindow(e)&&(!(1!==e.nodeType||!t)||("array"===i||"function"!==i&&(0===t||"number"==typeof t&&t>0&&t-1 in e)))}n=v(a);!function(e,t){var i,n,r,s,a,o,l,c,u,h,p,d,f,m,y,g,C,T="sizzle"+-new Date,L=e.document,w=0,b=0,S=se(),E=se(),O=se(),A=!1,x=function(e,t){if(e===t){A=!0;return 0}return 0},P=1<<31,_={}.hasOwnProperty,N=[],M=N.pop,k=N.push,R=N.push,I=N.slice,D=N.indexOf||function(e){for(var t=0,i=this.length;t<i;t++)if(this[t]===e)return t;return-1},F="checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped",$="[\\x20\\t\\r\\n\\f]",B="(?:\\\\.|[\\w-]|[^\\x00-\\xa0])+",j=B.replace("w","w#"),U="\\["+$+"*("+B+")"+$+"*(?:([*^$|!~]?=)"+$+"*(?:(['\"])((?:\\\\.|[^\\\\])*?)\\3|("+j+")|)|)"+$+"*\\]",G=":("+B+")(?:\\(((['\"])((?:\\\\.|[^\\\\])*?)\\3|((?:\\\\.|[^\\\\()[\\]]|"+U.replace(3,8)+")*)|.*)\\)|)",W=new RegExp("^"+$+"+|((?:^|[^\\\\])(?:\\\\.)*)"+$+"+$","g"),z=new RegExp("^"+$+"*,"+$+"*"),H=new RegExp("^"+$+"*([>+~]|"+$+")"+$+"*"),V=new RegExp($+"*[+~]"),q=new RegExp("="+$+"*([^\\]'\"]*)"+$+"*\\]","g"),Y=new RegExp(G),X=new RegExp("^"+j+"$"),K={ID:new RegExp("^#("+B+")"),CLASS:new RegExp("^\\.("+B+")"),TAG:new RegExp("^("+B.replace("w","w*")+")"),ATTR:new RegExp("^"+U),PSEUDO:new RegExp("^"+G),CHILD:new RegExp("^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\("+$+"*(even|odd|(([+-]|)(\\d*)n|)"+$+"*(?:([+-]|)"+$+"*(\\d+)|))"+$+"*\\)|)","i"),bool:new RegExp("^(?:"+F+")$","i"),needsContext:new RegExp("^"+$+"*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\("+$+"*((?:-\\d)?\\d*)"+$+"*\\)|)(?=[^-]|$)","i")},J=/^[^{]+\{\s*\[native \w/,Z=/^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/,Q=/^(?:input|select|textarea|button)$/i,ee=/^h\d$/i,te=/'|\\/g,ie=new RegExp("\\\\([\\da-f]{1,6}"+$+"?|("+$+")|.)","ig"),ne=function(e,t,i){var n="0x"+t-65536;return n!=n||i?t:n<0?String.fromCharCode(n+65536):String.fromCharCode(n>>10|55296,1023&n|56320)};try{R.apply(N=I.call(L.childNodes),L.childNodes);N[L.childNodes.length].nodeType}catch(e){R={apply:N.length?function(e,t){k.apply(e,I.call(t))}:function(e,t){for(var i=e.length,n=0;e[i++]=t[n++];);e.length=i-1}}}function re(e,t,i,r){var a,o,c,u,d,y,g,v,w,b;(t?t.ownerDocument||t:L)!==p&&h(t);t=t||p;i=i||[];if(!e||"string"!=typeof e)return i;if(1!==(u=t.nodeType)&&9!==u)return[];if(f&&!r){if(a=Z.exec(e))if(c=a[1]){if(9===u){if(!(o=t.getElementById(c))||!o.parentNode)return i;if(o.id===c){i.push(o);return i}}else if(t.ownerDocument&&(o=t.ownerDocument.getElementById(c))&&C(t,o)&&o.id===c){i.push(o);return i}}else{if(a[2]){R.apply(i,t.getElementsByTagName(e));return i}if((c=a[3])&&n.getElementsByClassName&&t.getElementsByClassName){R.apply(i,t.getElementsByClassName(c));return i}}if(n.qsa&&(!m||!m.test(e))){v=g=T;w=t;b=9===u&&e;if(1===u&&"object"!==t.nodeName.toLowerCase()){y=fe(e);(g=t.getAttribute("id"))?v=g.replace(te,"\\$&"):t.setAttribute("id",v);v="[id='"+v+"'] ";d=y.length;for(;d--;)y[d]=v+me(y[d]);w=V.test(e)&&t.parentNode||t;b=y.join(",")}if(b)try{R.apply(i,w.querySelectorAll(b));return i}catch(e){}finally{g||t.removeAttribute("id")}}}return function(e,t,i,r){var a,o,c,u,h,p=fe(e);if(!r&&1===p.length){if((o=p[0]=p[0].slice(0)).length>2&&"ID"===(c=o[0]).type&&n.getById&&9===t.nodeType&&f&&s.relative[o[1].type]){if(!(t=(s.find.ID(c.matches[0].replace(ie,ne),t)||[])[0]))return i;e=e.slice(o.shift().value.length)}a=K.needsContext.test(e)?0:o.length;for(;a--;){c=o[a];if(s.relative[u=c.type])break;if((h=s.find[u])&&(r=h(c.matches[0].replace(ie,ne),V.test(o[0].type)&&t.parentNode||t))){o.splice(a,1);if(!(e=r.length&&me(o))){R.apply(i,r);return i}break}}}l(e,p)(r,t,!f,i,V.test(e));return i}(e.replace(W,"$1"),t,i,r)}function se(){var e=[];return function t(i,n){e.push(i+=" ")>s.cacheLength&&delete t[e.shift()];return t[i]=n}}function ae(e){e[T]=!0;return e}function oe(e){var t=p.createElement("div");try{return!!e(t)}catch(e){return!1}finally{t.parentNode&&t.parentNode.removeChild(t);t=null}}function le(e,t){for(var i=e.split("|"),n=e.length;n--;)s.attrHandle[i[n]]=t}function ce(e,t){var i=t&&e,n=i&&1===e.nodeType&&1===t.nodeType&&(~t.sourceIndex||P)-(~e.sourceIndex||P);if(n)return n;if(i)for(;i=i.nextSibling;)if(i===t)return-1;return e?1:-1}function ue(e){return function(t){return"input"===t.nodeName.toLowerCase()&&t.type===e}}function he(e){return function(t){var i=t.nodeName.toLowerCase();return("input"===i||"button"===i)&&t.type===e}}function pe(e){return ae(function(t){t=+t;return ae(function(i,n){for(var r,s=e([],i.length,t),a=s.length;a--;)i[r=s[a]]&&(i[r]=!(n[r]=i[r]))})})}o=re.isXML=function(e){var t=e&&(e.ownerDocument||e).documentElement;return!!t&&"HTML"!==t.nodeName};n=re.support={};h=re.setDocument=function(e){var t=e?e.ownerDocument||e:L,i=t.defaultView;if(t===p||9!==t.nodeType||!t.documentElement)return p;p=t;d=t.documentElement;f=!o(t);i&&i.attachEvent&&i!==i.top&&i.attachEvent("onbeforeunload",function(){h()});n.attributes=oe(function(e){e.className="i";return!e.getAttribute("className")});n.getElementsByTagName=oe(function(e){e.appendChild(t.createComment(""));return!e.getElementsByTagName("*").length});n.getElementsByClassName=oe(function(e){e.innerHTML="<div class='a'></div><div class='a i'></div>";e.firstChild.className="i";return 2===e.getElementsByClassName("i").length});n.getById=oe(function(e){d.appendChild(e).id=T;return!t.getElementsByName||!t.getElementsByName(T).length});if(n.getById){s.find.ID=function(e,t){if(void 0!==t.getElementById&&f){var i=t.getElementById(e);return i&&i.parentNode?[i]:[]}};s.filter.ID=function(e){var t=e.replace(ie,ne);return function(e){return e.getAttribute("id")===t}}}else{delete s.find.ID;s.filter.ID=function(e){var t=e.replace(ie,ne);return function(e){var i=void 0!==e.getAttributeNode&&e.getAttributeNode("id");return i&&i.value===t}}}s.find.TAG=n.getElementsByTagName?function(e,t){if(void 0!==t.getElementsByTagName)return t.getElementsByTagName(e)}:function(e,t){var i,n=[],r=0,s=t.getElementsByTagName(e);if("*"===e){for(;i=s[r++];)1===i.nodeType&&n.push(i);return n}return s};s.find.CLASS=n.getElementsByClassName&&function(e,t){if(void 0!==t.getElementsByClassName&&f)return t.getElementsByClassName(e)};y=[];m=[];if(n.qsa=J.test(t.querySelectorAll)){oe(function(e){e.innerHTML="<select><option selected=''></option></select>";e.querySelectorAll("[selected]").length||m.push("\\["+$+"*(?:value|"+F+")");e.querySelectorAll(":checked").length||m.push(":checked")});oe(function(e){var i=t.createElement("input");i.setAttribute("type","hidden");e.appendChild(i).setAttribute("t","");e.querySelectorAll("[t^='']").length&&m.push("[*^$]="+$+"*(?:''|\"\")");e.querySelectorAll(":enabled").length||m.push(":enabled",":disabled");e.querySelectorAll("*,:x");m.push(",.*:")})}(n.matchesSelector=J.test(g=d.webkitMatchesSelector||d.mozMatchesSelector||d.oMatchesSelector||d.msMatchesSelector))&&oe(function(e){n.disconnectedMatch=g.call(e,"div");g.call(e,"[s!='']:x");y.push("!=",G)});m=m.length&&new RegExp(m.join("|"));y=y.length&&new RegExp(y.join("|"));C=J.test(d.contains)||d.compareDocumentPosition?function(e,t){var i=9===e.nodeType?e.documentElement:e,n=t&&t.parentNode;return e===n||!(!n||1!==n.nodeType||!(i.contains?i.contains(n):e.compareDocumentPosition&&16&e.compareDocumentPosition(n)))}:function(e,t){if(t)for(;t=t.parentNode;)if(t===e)return!0;return!1};x=d.compareDocumentPosition?function(e,i){if(e===i){A=!0;return 0}var r=i.compareDocumentPosition&&e.compareDocumentPosition&&e.compareDocumentPosition(i);return r?1&r||!n.sortDetached&&i.compareDocumentPosition(e)===r?e===t||C(L,e)?-1:i===t||C(L,i)?1:u?D.call(u,e)-D.call(u,i):0:4&r?-1:1:e.compareDocumentPosition?-1:1}:function(e,i){var n,r=0,s=e.parentNode,a=i.parentNode,o=[e],l=[i];if(e===i){A=!0;return 0}if(!s||!a)return e===t?-1:i===t?1:s?-1:a?1:u?D.call(u,e)-D.call(u,i):0;if(s===a)return ce(e,i);n=e;for(;n=n.parentNode;)o.unshift(n);n=i;for(;n=n.parentNode;)l.unshift(n);for(;o[r]===l[r];)r++;return r?ce(o[r],l[r]):o[r]===L?-1:l[r]===L?1:0};return t};re.matches=function(e,t){return re(e,null,null,t)};re.matchesSelector=function(e,t){(e.ownerDocument||e)!==p&&h(e);t=t.replace(q,"='$1']");if(n.matchesSelector&&f&&(!y||!y.test(t))&&(!m||!m.test(t)))try{var i=g.call(e,t);if(i||n.disconnectedMatch||e.document&&11!==e.document.nodeType)return i}catch(e){}return re(t,p,null,[e]).length>0};re.contains=function(e,t){(e.ownerDocument||e)!==p&&h(e);return C(e,t)};re.attr=function(e,t){(e.ownerDocument||e)!==p&&h(e);var i=s.attrHandle[t.toLowerCase()],r=i&&_.call(s.attrHandle,t.toLowerCase())?i(e,t,!f):void 0;return void 0===r?n.attributes||!f?e.getAttribute(t):(r=e.getAttributeNode(t))&&r.specified?r.value:null:r};re.error=function(e){throw new Error("Syntax error, unrecognized expression: "+e)};re.uniqueSort=function(e){var t,i=[],r=0,s=0;A=!n.detectDuplicates;u=!n.sortStable&&e.slice(0);e.sort(x);if(A){for(;t=e[s++];)t===e[s]&&(r=i.push(s));for(;r--;)e.splice(i[r],1)}return e};a=re.getText=function(e){var t,i="",n=0,r=e.nodeType;if(r){if(1===r||9===r||11===r){if("string"==typeof e.textContent)return e.textContent;for(e=e.firstChild;e;e=e.nextSibling)i+=a(e)}else if(3===r||4===r)return e.nodeValue}else for(;t=e[n];n++)i+=a(t);return i};(s=re.selectors={cacheLength:50,createPseudo:ae,match:K,attrHandle:{},find:{},relative:{">":{dir:"parentNode",first:!0}," ":{dir:"parentNode"},"+":{dir:"previousSibling",first:!0},"~":{dir:"previousSibling"}},preFilter:{ATTR:function(e){e[1]=e[1].replace(ie,ne);e[3]=(e[4]||e[5]||"").replace(ie,ne);"~="===e[2]&&(e[3]=" "+e[3]+" ");return e.slice(0,4)},CHILD:function(e){e[1]=e[1].toLowerCase();if("nth"===e[1].slice(0,3)){e[3]||re.error(e[0]);e[4]=+(e[4]?e[5]+(e[6]||1):2*("even"===e[3]||"odd"===e[3]));e[5]=+(e[7]+e[8]||"odd"===e[3])}else e[3]&&re.error(e[0]);return e},PSEUDO:function(e){var t,i=!e[5]&&e[2];if(K.CHILD.test(e[0]))return null;if(e[3]&&void 0!==e[4])e[2]=e[4];else if(i&&Y.test(i)&&(t=fe(i,!0))&&(t=i.indexOf(")",i.length-t)-i.length)){e[0]=e[0].slice(0,t);e[2]=i.slice(0,t)}return e.slice(0,3)}},filter:{TAG:function(e){var t=e.replace(ie,ne).toLowerCase();return"*"===e?function(){return!0}:function(e){return e.nodeName&&e.nodeName.toLowerCase()===t}},CLASS:function(e){var t=S[e+" "];return t||(t=new RegExp("(^|"+$+")"+e+"("+$+"|$)"))&&S(e,function(e){return t.test("string"==typeof e.className&&e.className||void 0!==e.getAttribute&&e.getAttribute("class")||"")})},ATTR:function(e,t,i){return function(n){var r=re.attr(n,e);if(null==r)return"!="===t;if(!t)return!0;r+="";return"="===t?r===i:"!="===t?r!==i:"^="===t?i&&0===r.indexOf(i):"*="===t?i&&r.indexOf(i)>-1:"$="===t?i&&r.slice(-i.length)===i:"~="===t?(" "+r+" ").indexOf(i)>-1:"|="===t&&(r===i||r.slice(0,i.length+1)===i+"-")}},CHILD:function(e,t,i,n,r){var s="nth"!==e.slice(0,3),a="last"!==e.slice(-4),o="of-type"===t;return 1===n&&0===r?function(e){return!!e.parentNode}:function(t,i,l){var c,u,h,p,d,f,m=s!==a?"nextSibling":"previousSibling",y=t.parentNode,g=o&&t.nodeName.toLowerCase(),C=!l&&!o;if(y){if(s){for(;m;){h=t;for(;h=h[m];)if(o?h.nodeName.toLowerCase()===g:1===h.nodeType)return!1;f=m="only"===e&&!f&&"nextSibling"}return!0}f=[a?y.firstChild:y.lastChild];if(a&&C){d=(c=(u=y[T]||(y[T]={}))[e]||[])[0]===w&&c[1];p=c[0]===w&&c[2];h=d&&y.childNodes[d];for(;h=++d&&h&&h[m]||(p=d=0)||f.pop();)if(1===h.nodeType&&++p&&h===t){u[e]=[w,d,p];break}}else if(C&&(c=(t[T]||(t[T]={}))[e])&&c[0]===w)p=c[1];else for(;h=++d&&h&&h[m]||(p=d=0)||f.pop();)if((o?h.nodeName.toLowerCase()===g:1===h.nodeType)&&++p){C&&((h[T]||(h[T]={}))[e]=[w,p]);if(h===t)break}return(p-=r)===n||p%n==0&&p/n>=0}}},PSEUDO:function(e,t){var i,n=s.pseudos[e]||s.setFilters[e.toLowerCase()]||re.error("unsupported pseudo: "+e);if(n[T])return n(t);if(n.length>1){i=[e,e,"",t];return s.setFilters.hasOwnProperty(e.toLowerCase())?ae(function(e,i){for(var r,s=n(e,t),a=s.length;a--;)e[r=D.call(e,s[a])]=!(i[r]=s[a])}):function(e){return n(e,0,i)}}return n}},pseudos:{not:ae(function(e){var t=[],i=[],n=l(e.replace(W,"$1"));return n[T]?ae(function(e,t,i,r){for(var s,a=n(e,null,r,[]),o=e.length;o--;)(s=a[o])&&(e[o]=!(t[o]=s))}):function(e,r,s){t[0]=e;n(t,null,s,i);return!i.pop()}}),has:ae(function(e){return function(t){return re(e,t).length>0}}),contains:ae(function(e){return function(t){return(t.textContent||t.innerText||a(t)).indexOf(e)>-1}}),lang:ae(function(e){X.test(e||"")||re.error("unsupported lang: "+e);e=e.replace(ie,ne).toLowerCase();return function(t){var i;do{if(i=f?t.lang:t.getAttribute("xml:lang")||t.getAttribute("lang"))return(i=i.toLowerCase())===e||0===i.indexOf(e+"-")}while((t=t.parentNode)&&1===t.nodeType);return!1}}),target:function(t){var i=e.location&&e.location.hash;return i&&i.slice(1)===t.id},root:function(e){return e===d},focus:function(e){return e===p.activeElement&&(!p.hasFocus||p.hasFocus())&&!!(e.type||e.href||~e.tabIndex)},enabled:function(e){return!1===e.disabled},disabled:function(e){return!0===e.disabled},checked:function(e){var t=e.nodeName.toLowerCase();return"input"===t&&!!e.checked||"option"===t&&!!e.selected},selected:function(e){e.parentNode&&e.parentNode.selectedIndex;return!0===e.selected},empty:function(e){for(e=e.firstChild;e;e=e.nextSibling)if(e.nodeName>"@"||3===e.nodeType||4===e.nodeType)return!1;return!0},parent:function(e){return!s.pseudos.empty(e)},header:function(e){return ee.test(e.nodeName)},input:function(e){return Q.test(e.nodeName)},button:function(e){var t=e.nodeName.toLowerCase();return"input"===t&&"button"===e.type||"button"===t},text:function(e){var t;return"input"===e.nodeName.toLowerCase()&&"text"===e.type&&(null==(t=e.getAttribute("type"))||t.toLowerCase()===e.type)},first:pe(function(){return[0]}),last:pe(function(e,t){return[t-1]}),eq:pe(function(e,t,i){return[i<0?i+t:i]}),even:pe(function(e,t){for(var i=0;i<t;i+=2)e.push(i);return e}),odd:pe(function(e,t){for(var i=1;i<t;i+=2)e.push(i);return e}),lt:pe(function(e,t,i){for(var n=i<0?i+t:i;--n>=0;)e.push(n);return e}),gt:pe(function(e,t,i){for(var n=i<0?i+t:i;++n<t;)e.push(n);return e})}}).pseudos.nth=s.pseudos.eq;for(i in{radio:!0,checkbox:!0,file:!0,password:!0,image:!0})s.pseudos[i]=ue(i);for(i in{submit:!0,reset:!0})s.pseudos[i]=he(i);function de(){}de.prototype=s.filters=s.pseudos;s.setFilters=new de;function fe(e,t){var i,n,r,a,o,l,c,u=E[e+" "];if(u)return t?0:u.slice(0);o=e;l=[];c=s.preFilter;for(;o;){if(!i||(n=z.exec(o))){n&&(o=o.slice(n[0].length)||o);l.push(r=[])}i=!1;if(n=H.exec(o)){i=n.shift();r.push({value:i,type:n[0].replace(W," ")});o=o.slice(i.length)}for(a in s.filter)if((n=K[a].exec(o))&&(!c[a]||(n=c[a](n)))){i=n.shift();r.push({value:i,type:a,matches:n});o=o.slice(i.length)}if(!i)break}return t?o.length:o?re.error(e):E(e,l).slice(0)}function me(e){for(var t=0,i=e.length,n="";t<i;t++)n+=e[t].value;return n}function ye(e,t,i){var n=t.dir,s=i&&"parentNode"===n,a=b++;return t.first?function(t,i,r){for(;t=t[n];)if(1===t.nodeType||s)return e(t,i,r)}:function(t,i,o){var l,c,u,h=w+" "+a;if(o){for(;t=t[n];)if((1===t.nodeType||s)&&e(t,i,o))return!0}else for(;t=t[n];)if(1===t.nodeType||s)if((c=(u=t[T]||(t[T]={}))[n])&&c[0]===h){if(!0===(l=c[1])||l===r)return!0===l}else{(c=u[n]=[h])[1]=e(t,i,o)||r;if(!0===c[1])return!0}}}function ge(e){return e.length>1?function(t,i,n){for(var r=e.length;r--;)if(!e[r](t,i,n))return!1;return!0}:e[0]}function Ce(e,t,i,n,r){for(var s,a=[],o=0,l=e.length,c=null!=t;o<l;o++)if((s=e[o])&&(!i||i(s,n,r))){a.push(s);c&&t.push(o)}return a}function ve(e,t,i,n,r,s){n&&!n[T]&&(n=ve(n));r&&!r[T]&&(r=ve(r,s));return ae(function(s,a,o,l){var c,u,h,p=[],d=[],f=a.length,m=s||function(e,t,i){for(var n=0,r=t.length;n<r;n++)re(e,t[n],i);return i}(t||"*",o.nodeType?[o]:o,[]),y=!e||!s&&t?m:Ce(m,p,e,o,l),g=i?r||(s?e:f||n)?[]:a:y;i&&i(y,g,o,l);if(n){c=Ce(g,d);n(c,[],o,l);u=c.length;for(;u--;)(h=c[u])&&(g[d[u]]=!(y[d[u]]=h))}if(s){if(r||e){if(r){c=[];u=g.length;for(;u--;)(h=g[u])&&c.push(y[u]=h);r(null,g=[],c,l)}u=g.length;for(;u--;)(h=g[u])&&(c=r?D.call(s,h):p[u])>-1&&(s[c]=!(a[c]=h))}}else{g=Ce(g===a?g.splice(f,g.length):g);r?r(null,a,g,l):R.apply(a,g)}})}function Te(e){for(var t,i,n,r=e.length,a=s.relative[e[0].type],o=a||s.relative[" "],l=a?1:0,u=ye(function(e){return e===t},o,!0),h=ye(function(e){return D.call(t,e)>-1},o,!0),p=[function(e,i,n){return!a&&(n||i!==c)||((t=i).nodeType?u(e,i,n):h(e,i,n))}];l<r;l++)if(i=s.relative[e[l].type])p=[ye(ge(p),i)];else{if((i=s.filter[e[l].type].apply(null,e[l].matches))[T]){n=++l;for(;n<r&&!s.relative[e[n].type];n++);return ve(l>1&&ge(p),l>1&&me(e.slice(0,l-1).concat({value:" "===e[l-2].type?"*":""})).replace(W,"$1"),i,l<n&&Te(e.slice(l,n)),n<r&&Te(e=e.slice(n)),n<r&&me(e))}p.push(i)}return ge(p)}l=re.compile=function(e,t){var i,n=[],a=[],o=O[e+" "];if(!o){t||(t=fe(e));i=t.length;for(;i--;)(o=Te(t[i]))[T]?n.push(o):a.push(o);o=O(e,function(e,t){var i=0,n=t.length>0,a=e.length>0,o=function(o,l,u,h,d){var f,m,y,g=[],C=0,v="0",T=o&&[],L=null!=d,b=c,S=o||a&&s.find.TAG("*",d&&l.parentNode||l),E=w+=null==b?1:Math.random()||.1;if(L){c=l!==p&&l;r=i}for(;null!=(f=S[v]);v++){if(a&&f){m=0;for(;y=e[m++];)if(y(f,l,u)){h.push(f);break}if(L){w=E;r=++i}}if(n){(f=!y&&f)&&C--;o&&T.push(f)}}C+=v;if(n&&v!==C){m=0;for(;y=t[m++];)y(T,g,l,u);if(o){if(C>0)for(;v--;)T[v]||g[v]||(g[v]=M.call(h));g=Ce(g)}R.apply(h,g);L&&!o&&g.length>0&&C+t.length>1&&re.uniqueSort(h)}if(L){w=E;c=b}return T};return n?ae(o):o}(a,n))}return o};n.sortStable=T.split("").sort(x).join("")===T;n.detectDuplicates=A;h();n.sortDetached=oe(function(e){return 1&e.compareDocumentPosition(p.createElement("div"))});oe(function(e){e.innerHTML="<a href='#'></a>";return"#"===e.firstChild.getAttribute("href")})||le("type|href|height|width",function(e,t,i){if(!i)return e.getAttribute(t,"type"===t.toLowerCase()?1:2)});n.attributes&&oe(function(e){e.innerHTML="<input/>";e.firstChild.setAttribute("value","");return""===e.firstChild.getAttribute("value")})||le("value",function(e,t,i){if(!i&&"input"===e.nodeName.toLowerCase())return e.defaultValue});oe(function(e){return null==e.getAttribute("disabled")})||le(F,function(e,t,i){var n;if(!i)return(n=e.getAttributeNode(t))&&n.specified?n.value:!0===e[t]?t.toLowerCase():null});v.find=re;v.expr=re.selectors;v.expr[":"]=v.expr.pseudos;v.unique=re.uniqueSort;v.text=re.getText;v.isXMLDoc=re.isXML;v.contains=re.contains}(e);var I={};v.Callbacks=function(e){var i,n,r,s,a,o,l=[],c=!(e="string"==typeof e?I[e]||function(e){var t=I[e]={};v.each(e.match(L)||[],function(e,i){t[i]=!0});return t}(e):v.extend({},e)).once&&[],u=function(t){n=e.memory&&t;r=!0;a=o||0;o=0;s=l.length;i=!0;for(;l&&a<s;a++)if(!1===l[a].apply(t[0],t[1])&&e.stopOnFalse){n=!1;break}i=!1;l&&(c?c.length&&u(c.shift()):n?l=[]:h.disable())},h={add:function(){if(l){var t=l.length;!function t(i){v.each(i,function(i,n){var r=v.type(n);"function"===r?e.unique&&h.has(n)||l.push(n):n&&n.length&&"string"!==r&&t(n)})}(arguments);if(i)s=l.length;else if(n){o=t;u(n)}}return this},remove:function(){l&&v.each(arguments,function(e,t){for(var n;(n=v.inArray(t,l,n))>-1;){l.splice(n,1);if(i){n<=s&&s--;n<=a&&a--}}});return this},has:function(e){return e?v.inArray(e,l)>-1:!(!l||!l.length)},empty:function(){l=[];s=0;return this},disable:function(){l=c=n=t;return this},disabled:function(){return!l},lock:function(){c=t;n||h.disable();return this},locked:function(){return!c},fireWith:function(e,t){if(l&&(!r||c)){t=[e,(t=t||[]).slice?t.slice():t];i?c.push(t):u(t)}return this},fire:function(){h.fireWith(this,arguments);return this},fired:function(){return!!r}};return h};v.extend({Deferred:function(e){var t=[["resolve","done",v.Callbacks("once memory"),"resolved"],["reject","fail",v.Callbacks("once memory"),"rejected"],["notify","progress",v.Callbacks("memory")]],i="pending",n={state:function(){return i},always:function(){r.done(arguments).fail(arguments);return this},then:function(){var e=arguments;return v.Deferred(function(i){v.each(t,function(t,s){var a=s[0],o=v.isFunction(e[t])&&e[t];r[s[1]](function(){var e=o&&o.apply(this,arguments);e&&v.isFunction(e.promise)?e.promise().done(i.resolve).fail(i.reject).progress(i.notify):i[a+"With"](this===n?i.promise():this,o?[e]:arguments)})});e=null}).promise()},promise:function(e){return null!=e?v.extend(e,n):n}},r={};n.pipe=n.then;v.each(t,function(e,s){var a=s[2],o=s[3];n[s[1]]=a.add;o&&a.add(function(){i=o},t[1^e][2].disable,t[2][2].lock);r[s[0]]=function(){r[s[0]+"With"](this===r?n:this,arguments);return this};r[s[0]+"With"]=a.fireWith});n.promise(r);e&&e.call(r,r);return r},when:function(e){var t,i,n,r=0,s=f.call(arguments),a=s.length,o=1!==a||e&&v.isFunction(e.promise)?a:0,l=1===o?e:v.Deferred(),c=function(e,i,n){return function(r){i[e]=this;n[e]=arguments.length>1?f.call(arguments):r;n===t?l.notifyWith(i,n):--o||l.resolveWith(i,n)}};if(a>1){t=new Array(a);i=new Array(a);n=new Array(a);for(;r<a;r++)s[r]&&v.isFunction(s[r].promise)?s[r].promise().done(c(r,n,s)).fail(l.reject).progress(c(r,i,t)):--o}o||l.resolveWith(n,s);return l.promise()}});v.support=function(t){var i,n,s,o,l,c,u,h,p,d=a.createElement("div");d.setAttribute("className","t");d.innerHTML="  <link/><table></table><a href='/a'>a</a><input type='checkbox'/>";i=d.getElementsByTagName("*")||[];if(!(n=d.getElementsByTagName("a")[0])||!n.style||!i.length)return t;c=(o=a.createElement("select")).appendChild(a.createElement("option"));s=d.getElementsByTagName("input")[0];n.style.cssText="top:1px;float:left;opacity:.5";t.getSetAttribute="t"!==d.className;t.leadingWhitespace=3===d.firstChild.nodeType;t.tbody=!d.getElementsByTagName("tbody").length;t.htmlSerialize=!!d.getElementsByTagName("link").length;t.style=/top/.test(n.getAttribute("style"));t.hrefNormalized="/a"===n.getAttribute("href");t.opacity=/^0.5/.test(n.style.opacity);t.cssFloat=!!n.style.cssFloat;t.checkOn=!!s.value;t.optSelected=c.selected;t.enctype=!!a.createElement("form").enctype;t.html5Clone="<:nav></:nav>"!==a.createElement("nav").cloneNode(!0).outerHTML;t.inlineBlockNeedsLayout=!1;t.shrinkWrapBlocks=!1;t.pixelPosition=!1;t.deleteExpando=!0;t.noCloneEvent=!0;t.reliableMarginRight=!0;t.boxSizingReliable=!0;s.checked=!0;t.noCloneChecked=s.cloneNode(!0).checked;o.disabled=!0;t.optDisabled=!c.disabled;try{delete d.test}catch(e){t.deleteExpando=!1}(s=a.createElement("input")).setAttribute("value","");t.input=""===s.getAttribute("value");s.value="t";s.setAttribute("type","radio");t.radioValue="t"===s.value;s.setAttribute("checked","t");s.setAttribute("name","t");(l=a.createDocumentFragment()).appendChild(s);t.appendChecked=s.checked;t.checkClone=l.cloneNode(!0).cloneNode(!0).lastChild.checked;if(d.attachEvent){d.attachEvent("onclick",function(){t.noCloneEvent=!1});d.cloneNode(!0).click()}for(p in{submit:!0,change:!0,focusin:!0}){d.setAttribute(u="on"+p,"t");t[p+"Bubbles"]=u in e||!1===d.attributes[u].expando}d.style.backgroundClip="content-box";d.cloneNode(!0).style.backgroundClip="";t.clearCloneStyle="content-box"===d.style.backgroundClip;for(p in v(t))break;t.ownLast="0"!==p;v(function(){var i,n,s,o="padding:0;margin:0;border:0;display:block;box-sizing:content-box;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;",l=a.getElementsByTagName("body")[0];if(l){(i=a.createElement("div")).style.cssText="border:0;width:0;height:0;position:absolute;top:0;left:-9999px;margin-top:1px";l.appendChild(i).appendChild(d);d.innerHTML="<table><tr><td></td><td>t</td></tr></table>";(s=d.getElementsByTagName("td"))[0].style.cssText="padding:0;margin:0;border:0;display:none";h=0===s[0].offsetHeight;s[0].style.display="";s[1].style.display="none";t.reliableHiddenOffsets=h&&0===s[0].offsetHeight;d.innerHTML="";d.style.cssText="box-sizing:border-box;-moz-box-sizing:border-box;-webkit-box-sizing:border-box;padding:1px;border:1px;display:block;width:4px;margin-top:1%;position:absolute;top:1%;";v.swap(l,null!=l.style.zoom?{zoom:1}:{},function(){t.boxSizing=4===d.offsetWidth});if(e.getComputedStyle){t.pixelPosition="1%"!==(e.getComputedStyle(d,null)||{}).top;t.boxSizingReliable="4px"===(e.getComputedStyle(d,null)||{width:"4px"}).width;(n=d.appendChild(a.createElement("div"))).style.cssText=d.style.cssText=o;n.style.marginRight=n.style.width="0";d.style.width="1px";t.reliableMarginRight=!parseFloat((e.getComputedStyle(n,null)||{}).marginRight)}if(typeof d.style.zoom!==r){d.innerHTML="";d.style.cssText=o+"width:1px;padding:1px;display:inline;zoom:1";t.inlineBlockNeedsLayout=3===d.offsetWidth;d.style.display="block";d.innerHTML="<div></div>";d.firstChild.style.width="5px";t.shrinkWrapBlocks=3!==d.offsetWidth;t.inlineBlockNeedsLayout&&(l.style.zoom=1)}l.removeChild(i);i=d=s=n=null}});i=o=l=c=n=s=null;return t}({});var D=/(?:\{[\s\S]*\}|\[[\s\S]*\])$/,F=/([A-Z])/g;function $(e,i,n,r){if(v.acceptData(e)){var s,a,o=v.expando,l=e.nodeType,c=l?v.cache:e,u=l?e[o]:e[o]&&o;if(u&&c[u]&&(r||c[u].data)||n!==t||"string"!=typeof i){u||(u=l?e[o]=h.pop()||v.guid++:o);c[u]||(c[u]=l?{}:{toJSON:v.noop});"object"!=typeof i&&"function"!=typeof i||(r?c[u]=v.extend(c[u],i):c[u].data=v.extend(c[u].data,i));a=c[u];if(!r){a.data||(a.data={});a=a.data}n!==t&&(a[v.camelCase(i)]=n);"string"==typeof i?null==(s=a[i])&&(s=a[v.camelCase(i)]):s=a;return s}}}function B(e,t,i){if(v.acceptData(e)){var n,r,s=e.nodeType,a=s?v.cache:e,o=s?e[v.expando]:v.expando;if(a[o]){if(t&&(n=i?a[o]:a[o].data)){r=(t=v.isArray(t)?t.concat(v.map(t,v.camelCase)):t in n?[t]:(t=v.camelCase(t))in n?[t]:t.split(" ")).length;for(;r--;)delete n[t[r]];if(i?!U(n):!v.isEmptyObject(n))return}if(!i){delete a[o].data;if(!U(a[o]))return}s?v.cleanData([e],!0):v.support.deleteExpando||a!=a.window?delete a[o]:a[o]=null}}}v.extend({cache:{},noData:{applet:!0,embed:!0,object:"clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"},hasData:function(e){return!!(e=e.nodeType?v.cache[e[v.expando]]:e[v.expando])&&!U(e)},data:function(e,t,i){return $(e,t,i)},removeData:function(e,t){return B(e,t)},_data:function(e,t,i){return $(e,t,i,!0)},_removeData:function(e,t){return B(e,t,!0)},acceptData:function(e){if(e.nodeType&&1!==e.nodeType&&9!==e.nodeType)return!1;var t=e.nodeName&&v.noData[e.nodeName.toLowerCase()];return!t||!0!==t&&e.getAttribute("classid")===t}});v.fn.extend({data:function(e,i){var n,r,s=null,a=0,o=this[0];if(e===t){if(this.length){s=v.data(o);if(1===o.nodeType&&!v._data(o,"parsedAttrs")){n=o.attributes;for(;a<n.length;a++)0===(r=n[a].name).indexOf("data-")&&j(o,r=v.camelCase(r.slice(5)),s[r]);v._data(o,"parsedAttrs",!0)}}return s}return"object"==typeof e?this.each(function(){v.data(this,e)}):arguments.length>1?this.each(function(){v.data(this,e,i)}):o?j(o,e,v.data(o,e)):null},removeData:function(e){return this.each(function(){v.removeData(this,e)})}});function j(e,i,n){if(n===t&&1===e.nodeType){var r="data-"+i.replace(F,"-$1").toLowerCase();if("string"==typeof(n=e.getAttribute(r))){try{n="true"===n||"false"!==n&&("null"===n?null:+n+""===n?+n:D.test(n)?v.parseJSON(n):n)}catch(e){}v.data(e,i,n)}else n=t}return n}function U(e){var t;for(t in e)if(("data"!==t||!v.isEmptyObject(e[t]))&&"toJSON"!==t)return!1;return!0}v.extend({queue:function(e,t,i){var n;if(e){t=(t||"fx")+"queue";n=v._data(e,t);i&&(!n||v.isArray(i)?n=v._data(e,t,v.makeArray(i)):n.push(i));return n||[]}},dequeue:function(e,t){t=t||"fx";var i=v.queue(e,t),n=i.length,r=i.shift(),s=v._queueHooks(e,t);if("inprogress"===r){r=i.shift();n--}if(r){"fx"===t&&i.unshift("inprogress");delete s.stop;r.call(e,function(){v.dequeue(e,t)},s)}!n&&s&&s.empty.fire()},_queueHooks:function(e,t){var i=t+"queueHooks";return v._data(e,i)||v._data(e,i,{empty:v.Callbacks("once memory").add(function(){v._removeData(e,t+"queue");v._removeData(e,i)})})}});v.fn.extend({queue:function(e,i){var n=2;if("string"!=typeof e){i=e;e="fx";n--}return arguments.length<n?v.queue(this[0],e):i===t?this:this.each(function(){var t=v.queue(this,e,i);v._queueHooks(this,e);"fx"===e&&"inprogress"!==t[0]&&v.dequeue(this,e)})},dequeue:function(e){return this.each(function(){v.dequeue(this,e)})},delay:function(e,t){e=v.fx&&v.fx.speeds[e]||e;t=t||"fx";return this.queue(t,function(t,i){var n=setTimeout(t,e);i.stop=function(){clearTimeout(n)}})},clearQueue:function(e){return this.queue(e||"fx",[])},promise:function(e,i){var n,r=1,s=v.Deferred(),a=this,o=this.length,l=function(){--r||s.resolveWith(a,[a])};if("string"!=typeof e){i=e;e=t}e=e||"fx";for(;o--;)if((n=v._data(a[o],e+"queueHooks"))&&n.empty){r++;n.empty.add(l)}l();return s.promise(i)}});var G,W,z=/[\t\r\n\f]/g,H=/\r/g,V=/^(?:input|select|textarea|button|object)$/i,q=/^(?:a|area)$/i,Y=/^(?:checked|selected)$/i,X=v.support.getSetAttribute,K=v.support.input;v.fn.extend({attr:function(e,t){return v.access(this,v.attr,e,t,arguments.length>1)},removeAttr:function(e){return this.each(function(){v.removeAttr(this,e)})},prop:function(e,t){return v.access(this,v.prop,e,t,arguments.length>1)},removeProp:function(e){e=v.propFix[e]||e;return this.each(function(){try{this[e]=t;delete this[e]}catch(e){}})},addClass:function(e){var t,i,n,r,s,a=0,o=this.length,l="string"==typeof e&&e;if(v.isFunction(e))return this.each(function(t){v(this).addClass(e.call(this,t,this.className))});if(l){t=(e||"").match(L)||[];for(;a<o;a++)if(n=1===(i=this[a]).nodeType&&(i.className?(" "+i.className+" ").replace(z," "):" ")){s=0;for(;r=t[s++];)n.indexOf(" "+r+" ")<0&&(n+=r+" ");i.className=v.trim(n)}}return this},removeClass:function(e){var t,i,n,r,s,a=0,o=this.length,l=0===arguments.length||"string"==typeof e&&e;if(v.isFunction(e))return this.each(function(t){v(this).removeClass(e.call(this,t,this.className))});if(l){t=(e||"").match(L)||[];for(;a<o;a++)if(n=1===(i=this[a]).nodeType&&(i.className?(" "+i.className+" ").replace(z," "):"")){s=0;for(;r=t[s++];)for(;n.indexOf(" "+r+" ")>=0;)n=n.replace(" "+r+" "," ");i.className=e?v.trim(n):""}}return this},toggleClass:function(e,t){var i=typeof e;return"boolean"==typeof t&&"string"===i?t?this.addClass(e):this.removeClass(e):v.isFunction(e)?this.each(function(i){v(this).toggleClass(e.call(this,i,this.className,t),t)}):this.each(function(){if("string"===i)for(var t,n=0,s=v(this),a=e.match(L)||[];t=a[n++];)s.hasClass(t)?s.removeClass(t):s.addClass(t);else if(i===r||"boolean"===i){this.className&&v._data(this,"__className__",this.className);this.className=this.className||!1===e?"":v._data(this,"__className__")||""}})},hasClass:function(e){for(var t=" "+e+" ",i=0,n=this.length;i<n;i++)if(1===this[i].nodeType&&(" "+this[i].className+" ").replace(z," ").indexOf(t)>=0)return!0;return!1},val:function(e){var i,n,r,s=this[0];if(!arguments.length)return s?(n=v.valHooks[s.type]||v.valHooks[s.nodeName.toLowerCase()])&&"get"in n&&(i=n.get(s,"value"))!==t?i:"string"==typeof(i=s.value)?i.replace(H,""):null==i?"":i:void 0;r=v.isFunction(e);return this.each(function(i){var s;if(1===this.nodeType){null==(s=r?e.call(this,i,v(this).val()):e)?s="":"number"==typeof s?s+="":v.isArray(s)&&(s=v.map(s,function(e){return null==e?"":e+""}));(n=v.valHooks[this.type]||v.valHooks[this.nodeName.toLowerCase()])&&"set"in n&&n.set(this,s,"value")!==t||(this.value=s)}})}});v.extend({valHooks:{option:{get:function(e){var t=v.find.attr(e,"value");return null!=t?t:e.text}},select:{get:function(e){for(var t,i,n=e.options,r=e.selectedIndex,s="select-one"===e.type||r<0,a=s?null:[],o=s?r+1:n.length,l=r<0?o:s?r:0;l<o;l++)if(((i=n[l]).selected||l===r)&&(v.support.optDisabled?!i.disabled:null===i.getAttribute("disabled"))&&(!i.parentNode.disabled||!v.nodeName(i.parentNode,"optgroup"))){t=v(i).val();if(s)return t;a.push(t)}return a},set:function(e,t){for(var i,n,r=e.options,s=v.makeArray(t),a=r.length;a--;)((n=r[a]).selected=v.inArray(v(n).val(),s)>=0)&&(i=!0);i||(e.selectedIndex=-1);return s}}},attr:function(e,i,n){var s,a,o=e.nodeType;if(e&&3!==o&&8!==o&&2!==o){if(typeof e.getAttribute===r)return v.prop(e,i,n);if(1!==o||!v.isXMLDoc(e)){i=i.toLowerCase();s=v.attrHooks[i]||(v.expr.match.bool.test(i)?W:G)}if(n===t)return s&&"get"in s&&null!==(a=s.get(e,i))?a:null==(a=v.find.attr(e,i))?t:a;if(null!==n){if(s&&"set"in s&&(a=s.set(e,n,i))!==t)return a;e.setAttribute(i,n+"");return n}v.removeAttr(e,i)}},removeAttr:function(e,t){var i,n,r=0,s=t&&t.match(L);if(s&&1===e.nodeType)for(;i=s[r++];){n=v.propFix[i]||i;v.expr.match.bool.test(i)?K&&X||!Y.test(i)?e[n]=!1:e[v.camelCase("default-"+i)]=e[n]=!1:v.attr(e,i,"");e.removeAttribute(X?i:n)}},attrHooks:{type:{set:function(e,t){if(!v.support.radioValue&&"radio"===t&&v.nodeName(e,"input")){var i=e.value;e.setAttribute("type",t);i&&(e.value=i);return t}}}},propFix:{for:"htmlFor",class:"className"},prop:function(e,i,n){var r,s,a=e.nodeType;if(e&&3!==a&&8!==a&&2!==a){if(1!==a||!v.isXMLDoc(e)){i=v.propFix[i]||i;s=v.propHooks[i]}return n!==t?s&&"set"in s&&(r=s.set(e,n,i))!==t?r:e[i]=n:s&&"get"in s&&null!==(r=s.get(e,i))?r:e[i]}},propHooks:{tabIndex:{get:function(e){var t=v.find.attr(e,"tabindex");return t?parseInt(t,10):V.test(e.nodeName)||q.test(e.nodeName)&&e.href?0:-1}}}});W={set:function(e,t,i){!1===t?v.removeAttr(e,i):K&&X||!Y.test(i)?e.setAttribute(!X&&v.propFix[i]||i,i):e[v.camelCase("default-"+i)]=e[i]=!0;return i}};v.each(v.expr.match.bool.source.match(/\w+/g),function(e,i){var n=v.expr.attrHandle[i]||v.find.attr;v.expr.attrHandle[i]=K&&X||!Y.test(i)?function(e,i,r){var s=v.expr.attrHandle[i],a=r?t:(v.expr.attrHandle[i]=t)!=n(e,i,r)?i.toLowerCase():null;v.expr.attrHandle[i]=s;return a}:function(e,i,n){return n?t:e[v.camelCase("default-"+i)]?i.toLowerCase():null}});K&&X||(v.attrHooks.value={set:function(e,t,i){if(!v.nodeName(e,"input"))return G&&G.set(e,t,i);e.defaultValue=t}});if(!X){G={set:function(e,i,n){var r=e.getAttributeNode(n);r||e.setAttributeNode(r=e.ownerDocument.createAttribute(n));r.value=i+="";return"value"===n||i===e.getAttribute(n)?i:t}};v.expr.attrHandle.id=v.expr.attrHandle.name=v.expr.attrHandle.coords=function(e,i,n){var r;return n?t:(r=e.getAttributeNode(i))&&""!==r.value?r.value:null};v.valHooks.button={get:function(e,i){var n=e.getAttributeNode(i);return n&&n.specified?n.value:t},set:G.set};v.attrHooks.contenteditable={set:function(e,t,i){G.set(e,""!==t&&t,i)}};v.each(["width","height"],function(e,t){v.attrHooks[t]={set:function(e,i){if(""===i){e.setAttribute(t,"auto");return i}}}})}v.support.hrefNormalized||v.each(["href","src"],function(e,t){v.propHooks[t]={get:function(e){return e.getAttribute(t,4)}}});v.support.style||(v.attrHooks.style={get:function(e){return e.style.cssText||t},set:function(e,t){return e.style.cssText=t+""}});v.support.optSelected||(v.propHooks.selected={get:function(e){var t=e.parentNode;if(t){t.selectedIndex;t.parentNode&&t.parentNode.selectedIndex}return null}});v.each(["tabIndex","readOnly","maxLength","cellSpacing","cellPadding","rowSpan","colSpan","useMap","frameBorder","contentEditable"],function(){v.propFix[this.toLowerCase()]=this});v.support.enctype||(v.propFix.enctype="encoding");v.each(["radio","checkbox"],function(){v.valHooks[this]={set:function(e,t){if(v.isArray(t))return e.checked=v.inArray(v(e).val(),t)>=0}};v.support.checkOn||(v.valHooks[this].get=function(e){return null===e.getAttribute("value")?"on":e.value})});var J=/^(?:input|select|textarea)$/i,Z=/^key/,Q=/^(?:mouse|contextmenu)|click/,ee=/^(?:focusinfocus|focusoutblur)$/,te=/^([^.]*)(?:\.(.+)|)$/;function ie(){return!0}function ne(){return!1}function re(){try{return a.activeElement}catch(e){}}v.event={global:{},add:function(e,i,n,s,a){var o,l,c,u,h,p,d,f,m,y,g,C=v._data(e);if(C){if(n.handler){n=(u=n).handler;a=u.selector}n.guid||(n.guid=v.guid++);(l=C.events)||(l=C.events={});(p=C.handle)||((p=C.handle=function(e){return typeof v===r||e&&v.event.triggered===e.type?t:v.event.dispatch.apply(p.elem,arguments)}).elem=e);c=(i=(i||"").match(L)||[""]).length;for(;c--;){m=g=(o=te.exec(i[c])||[])[1];y=(o[2]||"").split(".").sort();if(m){h=v.event.special[m]||{};m=(a?h.delegateType:h.bindType)||m;h=v.event.special[m]||{};d=v.extend({type:m,origType:g,data:s,handler:n,guid:n.guid,selector:a,needsContext:a&&v.expr.match.needsContext.test(a),namespace:y.join(".")},u);if(!(f=l[m])){(f=l[m]=[]).delegateCount=0;h.setup&&!1!==h.setup.call(e,s,y,p)||(e.addEventListener?e.addEventListener(m,p,!1):e.attachEvent&&e.attachEvent("on"+m,p))}if(h.add){h.add.call(e,d);d.handler.guid||(d.handler.guid=n.guid)}a?f.splice(f.delegateCount++,0,d):f.push(d);v.event.global[m]=!0}}e=null}},remove:function(e,t,i,n,r){var s,a,o,l,c,u,h,p,d,f,m,y=v.hasData(e)&&v._data(e);if(y&&(u=y.events)){c=(t=(t||"").match(L)||[""]).length;for(;c--;){d=m=(o=te.exec(t[c])||[])[1];f=(o[2]||"").split(".").sort();if(d){h=v.event.special[d]||{};p=u[d=(n?h.delegateType:h.bindType)||d]||[];o=o[2]&&new RegExp("(^|\\.)"+f.join("\\.(?:.*\\.|)")+"(\\.|$)");l=s=p.length;for(;s--;){a=p[s];if((r||m===a.origType)&&(!i||i.guid===a.guid)&&(!o||o.test(a.namespace))&&(!n||n===a.selector||"**"===n&&a.selector)){p.splice(s,1);a.selector&&p.delegateCount--;h.remove&&h.remove.call(e,a)}}if(l&&!p.length){h.teardown&&!1!==h.teardown.call(e,f,y.handle)||v.removeEvent(e,d,y.handle);delete u[d]}}else for(d in u)v.event.remove(e,d+t[c],i,n,!0)}if(v.isEmptyObject(u)){delete y.handle;v._removeData(e,"events")}}},trigger:function(i,n,r,s){var o,l,c,u,h,p,d,f=[r||a],m=g.call(i,"type")?i.type:i,y=g.call(i,"namespace")?i.namespace.split("."):[];c=p=r=r||a;if(3!==r.nodeType&&8!==r.nodeType&&!ee.test(m+v.event.triggered)){if(m.indexOf(".")>=0){m=(y=m.split(".")).shift();y.sort()}l=m.indexOf(":")<0&&"on"+m;(i=i[v.expando]?i:new v.Event(m,"object"==typeof i&&i)).isTrigger=s?2:3;i.namespace=y.join(".");i.namespace_re=i.namespace?new RegExp("(^|\\.)"+y.join("\\.(?:.*\\.|)")+"(\\.|$)"):null;i.result=t;i.target||(i.target=r);n=null==n?[i]:v.makeArray(n,[i]);h=v.event.special[m]||{};if(s||!h.trigger||!1!==h.trigger.apply(r,n)){if(!s&&!h.noBubble&&!v.isWindow(r)){u=h.delegateType||m;ee.test(u+m)||(c=c.parentNode);for(;c;c=c.parentNode){f.push(c);p=c}p===(r.ownerDocument||a)&&f.push(p.defaultView||p.parentWindow||e)}d=0;for(;(c=f[d++])&&!i.isPropagationStopped();){i.type=d>1?u:h.bindType||m;(o=(v._data(c,"events")||{})[i.type]&&v._data(c,"handle"))&&o.apply(c,n);(o=l&&c[l])&&v.acceptData(c)&&o.apply&&!1===o.apply(c,n)&&i.preventDefault()}i.type=m;if(!s&&!i.isDefaultPrevented()&&(!h._default||!1===h._default.apply(f.pop(),n))&&v.acceptData(r)&&l&&r[m]&&!v.isWindow(r)){(p=r[l])&&(r[l]=null);v.event.triggered=m;try{r[m]()}catch(e){}v.event.triggered=t;p&&(r[l]=p)}return i.result}}},dispatch:function(e){e=v.event.fix(e);var i,n,r,s,a,o,l=f.call(arguments),c=(v._data(this,"events")||{})[e.type]||[],u=v.event.special[e.type]||{};l[0]=e;e.delegateTarget=this;if(!u.preDispatch||!1!==u.preDispatch.call(this,e)){o=v.event.handlers.call(this,e,c);i=0;for(;(s=o[i++])&&!e.isPropagationStopped();){e.currentTarget=s.elem;a=0;for(;(r=s.handlers[a++])&&!e.isImmediatePropagationStopped();)if(!e.namespace_re||e.namespace_re.test(r.namespace)){e.handleObj=r;e.data=r.data;if((n=((v.event.special[r.origType]||{}).handle||r.handler).apply(s.elem,l))!==t&&!1===(e.result=n)){e.preventDefault();e.stopPropagation()}}}u.postDispatch&&u.postDispatch.call(this,e);return e.result}},handlers:function(e,i){var n,r,s,a,o=[],l=i.delegateCount,c=e.target;if(l&&c.nodeType&&(!e.button||"click"!==e.type))for(;c!=this;c=c.parentNode||this)if(1===c.nodeType&&(!0!==c.disabled||"click"!==e.type)){s=[];for(a=0;a<l;a++){s[n=(r=i[a]).selector+" "]===t&&(s[n]=r.needsContext?v(n,this).index(c)>=0:v.find(n,this,null,[c]).length);s[n]&&s.push(r)}s.length&&o.push({elem:c,handlers:s})}l<i.length&&o.push({elem:this,handlers:i.slice(l)});return o},fix:function(e){if(e[v.expando])return e;var t,i,n,r=e.type,s=e,o=this.fixHooks[r];o||(this.fixHooks[r]=o=Q.test(r)?this.mouseHooks:Z.test(r)?this.keyHooks:{});n=o.props?this.props.concat(o.props):this.props;e=new v.Event(s);t=n.length;for(;t--;)e[i=n[t]]=s[i];e.target||(e.target=s.srcElement||a);3===e.target.nodeType&&(e.target=e.target.parentNode);e.metaKey=!!e.metaKey;return o.filter?o.filter(e,s):e},props:"altKey bubbles cancelable ctrlKey currentTarget eventPhase metaKey relatedTarget shiftKey target timeStamp view which".split(" "),fixHooks:{},keyHooks:{props:"char charCode key keyCode".split(" "),filter:function(e,t){null==e.which&&(e.which=null!=t.charCode?t.charCode:t.keyCode);return e}},mouseHooks:{props:"button buttons clientX clientY fromElement offsetX offsetY pageX pageY screenX screenY toElement".split(" "),filter:function(e,i){var n,r,s,o=i.button,l=i.fromElement;if(null==e.pageX&&null!=i.clientX){s=(r=e.target.ownerDocument||a).documentElement;n=r.body;e.pageX=i.clientX+(s&&s.scrollLeft||n&&n.scrollLeft||0)-(s&&s.clientLeft||n&&n.clientLeft||0);e.pageY=i.clientY+(s&&s.scrollTop||n&&n.scrollTop||0)-(s&&s.clientTop||n&&n.clientTop||0)}!e.relatedTarget&&l&&(e.relatedTarget=l===e.target?i.toElement:l);e.which||o===t||(e.which=1&o?1:2&o?3:4&o?2:0);return e}},special:{load:{noBubble:!0},focus:{trigger:function(){if(this!==re()&&this.focus)try{this.focus();return!1}catch(e){}},delegateType:"focusin"},blur:{trigger:function(){if(this===re()&&this.blur){this.blur();return!1}},delegateType:"focusout"},click:{trigger:function(){if(v.nodeName(this,"input")&&"checkbox"===this.type&&this.click){this.click();return!1}},_default:function(e){return v.nodeName(e.target,"a")}},beforeunload:{postDispatch:function(e){e.result!==t&&(e.originalEvent.returnValue=e.result)}}},simulate:function(e,t,i,n){var r=v.extend(new v.Event,i,{type:e,isSimulated:!0,originalEvent:{}});n?v.event.trigger(r,null,t):v.event.dispatch.call(t,r);r.isDefaultPrevented()&&i.preventDefault()}};v.removeEvent=a.removeEventListener?function(e,t,i){e.removeEventListener&&e.removeEventListener(t,i,!1)}:function(e,t,i){var n="on"+t;if(e.detachEvent){typeof e[n]===r&&(e[n]=null);e.detachEvent(n,i)}};v.Event=function(e,t){if(!(this instanceof v.Event))return new v.Event(e,t);if(e&&e.type){this.originalEvent=e;this.type=e.type;this.isDefaultPrevented=e.defaultPrevented||!1===e.returnValue||e.getPreventDefault&&e.getPreventDefault()?ie:ne}else this.type=e;t&&v.extend(this,t);this.timeStamp=e&&e.timeStamp||v.now();this[v.expando]=!0};v.Event.prototype={isDefaultPrevented:ne,isPropagationStopped:ne,isImmediatePropagationStopped:ne,preventDefault:function(){var e=this.originalEvent;this.isDefaultPrevented=ie;e&&(e.preventDefault?e.preventDefault():e.returnValue=!1)},stopPropagation:function(){var e=this.originalEvent;this.isPropagationStopped=ie;if(e){e.stopPropagation&&e.stopPropagation();e.cancelBubble=!0}},stopImmediatePropagation:function(){this.isImmediatePropagationStopped=ie;this.stopPropagation()}};v.each({mouseenter:"mouseover",mouseleave:"mouseout"},function(e,t){v.event.special[e]={delegateType:t,bindType:t,handle:function(e){var i,n=e.relatedTarget,r=e.handleObj;if(!n||n!==this&&!v.contains(this,n)){e.type=r.origType;i=r.handler.apply(this,arguments);e.type=t}return i}}});v.support.submitBubbles||(v.event.special.submit={setup:function(){if(v.nodeName(this,"form"))return!1;v.event.add(this,"click._submit keypress._submit",function(e){var i=e.target,n=v.nodeName(i,"input")||v.nodeName(i,"button")?i.form:t;if(n&&!v._data(n,"submitBubbles")){v.event.add(n,"submit._submit",function(e){e._submit_bubble=!0});v._data(n,"submitBubbles",!0)}})},postDispatch:function(e){if(e._submit_bubble){delete e._submit_bubble;this.parentNode&&!e.isTrigger&&v.event.simulate("submit",this.parentNode,e,!0)}},teardown:function(){if(v.nodeName(this,"form"))return!1;v.event.remove(this,"._submit")}});v.support.changeBubbles||(v.event.special.change={setup:function(){if(J.test(this.nodeName)){if("checkbox"===this.type||"radio"===this.type){v.event.add(this,"propertychange._change",function(e){"checked"===e.originalEvent.propertyName&&(this._just_changed=!0)});v.event.add(this,"click._change",function(e){this._just_changed&&!e.isTrigger&&(this._just_changed=!1);v.event.simulate("change",this,e,!0)})}return!1}v.event.add(this,"beforeactivate._change",function(e){var t=e.target;if(J.test(t.nodeName)&&!v._data(t,"changeBubbles")){v.event.add(t,"change._change",function(e){!this.parentNode||e.isSimulated||e.isTrigger||v.event.simulate("change",this.parentNode,e,!0)});v._data(t,"changeBubbles",!0)}})},handle:function(e){var t=e.target;if(this!==t||e.isSimulated||e.isTrigger||"radio"!==t.type&&"checkbox"!==t.type)return e.handleObj.handler.apply(this,arguments)},teardown:function(){v.event.remove(this,"._change");return!J.test(this.nodeName)}});v.support.focusinBubbles||v.each({focus:"focusin",blur:"focusout"},function(e,t){var i=0,n=function(e){v.event.simulate(t,e.target,v.event.fix(e),!0)};v.event.special[t]={setup:function(){0==i++&&a.addEventListener(e,n,!0)},teardown:function(){0==--i&&a.removeEventListener(e,n,!0)}}});v.fn.extend({on:function(e,i,n,r,s){var a,o;if("object"==typeof e){if("string"!=typeof i){n=n||i;i=t}for(a in e)this.on(a,i,n,e[a],s);return this}if(null==n&&null==r){r=i;n=i=t}else if(null==r)if("string"==typeof i){r=n;n=t}else{r=n;n=i;i=t}if(!1===r)r=ne;else if(!r)return this;if(1===s){o=r;(r=function(e){v().off(e);return o.apply(this,arguments)}).guid=o.guid||(o.guid=v.guid++)}return this.each(function(){v.event.add(this,e,r,n,i)})},one:function(e,t,i,n){return this.on(e,t,i,n,1)},off:function(e,i,n){var r,s;if(e&&e.preventDefault&&e.handleObj){r=e.handleObj;v(e.delegateTarget).off(r.namespace?r.origType+"."+r.namespace:r.origType,r.selector,r.handler);return this}if("object"==typeof e){for(s in e)this.off(s,i,e[s]);return this}if(!1===i||"function"==typeof i){n=i;i=t}!1===n&&(n=ne);return this.each(function(){v.event.remove(this,e,n,i)})},trigger:function(e,t){return this.each(function(){v.event.trigger(e,t,this)})},triggerHandler:function(e,t){var i=this[0];if(i)return v.event.trigger(e,t,i,!0)}});var se=/^.[^:#\[\.,]*$/,ae=/^(?:parents|prev(?:Until|All))/,oe=v.expr.match.needsContext,le={children:!0,contents:!0,next:!0,prev:!0};v.fn.extend({find:function(e){var t,i=[],n=this,r=n.length;if("string"!=typeof e)return this.pushStack(v(e).filter(function(){for(t=0;t<r;t++)if(v.contains(n[t],this))return!0}));for(t=0;t<r;t++)v.find(e,n[t],i);(i=this.pushStack(r>1?v.unique(i):i)).selector=this.selector?this.selector+" "+e:e;return i},has:function(e){var t,i=v(e,this),n=i.length;return this.filter(function(){for(t=0;t<n;t++)if(v.contains(this,i[t]))return!0})},not:function(e){return this.pushStack(ue(this,e||[],!0))},filter:function(e){return this.pushStack(ue(this,e||[],!1))},is:function(e){return!!ue(this,"string"==typeof e&&oe.test(e)?v(e):e||[],!1).length},closest:function(e,t){for(var i,n=0,r=this.length,s=[],a=oe.test(e)||"string"!=typeof e?v(e,t||this.context):0;n<r;n++)for(i=this[n];i&&i!==t;i=i.parentNode)if(i.nodeType<11&&(a?a.index(i)>-1:1===i.nodeType&&v.find.matchesSelector(i,e))){i=s.push(i);break}return this.pushStack(s.length>1?v.unique(s):s)},index:function(e){return e?"string"==typeof e?v.inArray(this[0],v(e)):v.inArray(e.jquery?e[0]:e,this):this[0]&&this[0].parentNode?this.first().prevAll().length:-1},add:function(e,t){var i="string"==typeof e?v(e,t):v.makeArray(e&&e.nodeType?[e]:e),n=v.merge(this.get(),i);return this.pushStack(v.unique(n))},addBack:function(e){return this.add(null==e?this.prevObject:this.prevObject.filter(e))}});function ce(e,t){do{e=e[t]}while(e&&1!==e.nodeType);return e}v.each({parent:function(e){var t=e.parentNode;return t&&11!==t.nodeType?t:null},parents:function(e){return v.dir(e,"parentNode")},parentsUntil:function(e,t,i){return v.dir(e,"parentNode",i)},next:function(e){return ce(e,"nextSibling")},prev:function(e){return ce(e,"previousSibling")},nextAll:function(e){return v.dir(e,"nextSibling")},prevAll:function(e){return v.dir(e,"previousSibling")},nextUntil:function(e,t,i){return v.dir(e,"nextSibling",i)},prevUntil:function(e,t,i){return v.dir(e,"previousSibling",i)},siblings:function(e){return v.sibling((e.parentNode||{}).firstChild,e)},children:function(e){return v.sibling(e.firstChild)},contents:function(e){return v.nodeName(e,"iframe")?e.contentDocument||e.contentWindow.document:v.merge([],e.childNodes)}},function(e,t){v.fn[e]=function(i,n){var r=v.map(this,t,i);"Until"!==e.slice(-5)&&(n=i);n&&"string"==typeof n&&(r=v.filter(n,r));if(this.length>1){le[e]||(r=v.unique(r));ae.test(e)&&(r=r.reverse())}return this.pushStack(r)}});v.extend({filter:function(e,t,i){var n=t[0];i&&(e=":not("+e+")");return 1===t.length&&1===n.nodeType?v.find.matchesSelector(n,e)?[n]:[]:v.find.matches(e,v.grep(t,function(e){return 1===e.nodeType}))},dir:function(e,i,n){for(var r=[],s=e[i];s&&9!==s.nodeType&&(n===t||1!==s.nodeType||!v(s).is(n));){1===s.nodeType&&r.push(s);s=s[i]}return r},sibling:function(e,t){for(var i=[];e;e=e.nextSibling)1===e.nodeType&&e!==t&&i.push(e);return i}});function ue(e,t,i){if(v.isFunction(t))return v.grep(e,function(e,n){return!!t.call(e,n,e)!==i});if(t.nodeType)return v.grep(e,function(e){return e===t!==i});if("string"==typeof t){if(se.test(t))return v.filter(t,e,i);t=v.filter(t,e)}return v.grep(e,function(e){return v.inArray(e,t)>=0!==i})}function he(e){var t=pe.split("|"),i=e.createDocumentFragment();if(i.createElement)for(;t.length;)i.createElement(t.pop());return i}var pe="abbr|article|aside|audio|bdi|canvas|data|datalist|details|figcaption|figure|footer|header|hgroup|mark|meter|nav|output|progress|section|summary|time|video",de=/ jQuery\d+="(?:null|\d+)"/g,fe=new RegExp("<(?:"+pe+")[\\s/>]","i"),me=/^\s+/,ye=/<(?!area|br|col|embed|hr|img|input|link|meta|param)(([\w:]+)[^>]*)\/>/gi,ge=/<([\w:]+)/,Ce=/<tbody/i,ve=/<|&#?\w+;/,Te=/<(?:script|style|link)/i,Le=/^(?:checkbox|radio)$/i,we=/checked\s*(?:[^=]|=\s*.checked.)/i,be=/^$|\/(?:java|ecma)script/i,Se=/^true\/(.*)/,Ee=/^\s*<!(?:\[CDATA\[|--)|(?:\]\]|--)>\s*$/g,Oe={option:[1,"<select multiple='multiple'>","</select>"],legend:[1,"<fieldset>","</fieldset>"],area:[1,"<map>","</map>"],param:[1,"<object>","</object>"],thead:[1,"<table>","</table>"],tr:[2,"<table><tbody>","</tbody></table>"],col:[2,"<table><tbody></tbody><colgroup>","</colgroup></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],_default:v.support.htmlSerialize?[0,"",""]:[1,"X<div>","</div>"]},Ae=he(a).appendChild(a.createElement("div"));Oe.optgroup=Oe.option;Oe.tbody=Oe.tfoot=Oe.colgroup=Oe.caption=Oe.thead;Oe.th=Oe.td;v.fn.extend({text:function(e){return v.access(this,function(e){return e===t?v.text(this):this.empty().append((this[0]&&this[0].ownerDocument||a).createTextNode(e))},null,e,arguments.length)},append:function(){return this.domManip(arguments,function(e){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){xe(this,e).appendChild(e)}})},prepend:function(){return this.domManip(arguments,function(e){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var t=xe(this,e);t.insertBefore(e,t.firstChild)}})},before:function(){return this.domManip(arguments,function(e){this.parentNode&&this.parentNode.insertBefore(e,this)})},after:function(){return this.domManip(arguments,function(e){this.parentNode&&this.parentNode.insertBefore(e,this.nextSibling)})},remove:function(e,t){for(var i,n=e?v.filter(e,this):this,r=0;null!=(i=n[r]);r++){t||1!==i.nodeType||v.cleanData(Re(i));if(i.parentNode){t&&v.contains(i.ownerDocument,i)&&Ne(Re(i,"script"));i.parentNode.removeChild(i)}}return this},empty:function(){for(var e,t=0;null!=(e=this[t]);t++){1===e.nodeType&&v.cleanData(Re(e,!1));for(;e.firstChild;)e.removeChild(e.firstChild);e.options&&v.nodeName(e,"select")&&(e.options.length=0)}return this},clone:function(e,t){e=null!=e&&e;t=null==t?e:t;return this.map(function(){return v.clone(this,e,t)})},html:function(e){return v.access(this,function(e){var i=this[0]||{},n=0,r=this.length;if(e===t)return 1===i.nodeType?i.innerHTML.replace(de,""):t;if("string"==typeof e&&!Te.test(e)&&(v.support.htmlSerialize||!fe.test(e))&&(v.support.leadingWhitespace||!me.test(e))&&!Oe[(ge.exec(e)||["",""])[1].toLowerCase()]){e=e.replace(ye,"<$1></$2>");try{for(;n<r;n++)if(1===(i=this[n]||{}).nodeType){v.cleanData(Re(i,!1));i.innerHTML=e}i=0}catch(e){}}i&&this.empty().append(e)},null,e,arguments.length)},replaceWith:function(){var e=v.map(this,function(e){return[e.nextSibling,e.parentNode]}),t=0;this.domManip(arguments,function(i){var n=e[t++],r=e[t++];if(r){n&&n.parentNode!==r&&(n=this.nextSibling);v(this).remove();r.insertBefore(i,n)}},!0);return t?this:this.remove()},detach:function(e){return this.remove(e,!0)},domManip:function(e,t,i){e=p.apply([],e);var n,r,s,a,o,l,c=0,u=this.length,h=this,d=u-1,f=e[0],m=v.isFunction(f);if(m||!(u<=1||"string"!=typeof f||v.support.checkClone)&&we.test(f))return this.each(function(n){var r=h.eq(n);m&&(e[0]=f.call(this,n,r.html()));r.domManip(e,t,i)});if(u){n=(l=v.buildFragment(e,this[0].ownerDocument,!1,!i&&this)).firstChild;1===l.childNodes.length&&(l=n);if(n){s=(a=v.map(Re(l,"script"),Pe)).length;for(;c<u;c++){r=l;if(c!==d){r=v.clone(r,!0,!0);s&&v.merge(a,Re(r,"script"))}t.call(this[c],r,c)}if(s){o=a[a.length-1].ownerDocument;v.map(a,_e);for(c=0;c<s;c++){r=a[c];be.test(r.type||"")&&!v._data(r,"globalEval")&&v.contains(o,r)&&(r.src?v._evalUrl(r.src):v.globalEval((r.text||r.textContent||r.innerHTML||"").replace(Ee,"")))}}l=n=null}}return this}});function xe(e,t){return v.nodeName(e,"table")&&v.nodeName(1===t.nodeType?t:t.firstChild,"tr")?e.getElementsByTagName("tbody")[0]||e.appendChild(e.ownerDocument.createElement("tbody")):e}function Pe(e){e.type=(null!==v.find.attr(e,"type"))+"/"+e.type;return e}function _e(e){var t=Se.exec(e.type);t?e.type=t[1]:e.removeAttribute("type");return e}function Ne(e,t){for(var i,n=0;null!=(i=e[n]);n++)v._data(i,"globalEval",!t||v._data(t[n],"globalEval"))}function Me(e,t){if(1===t.nodeType&&v.hasData(e)){var i,n,r,s=v._data(e),a=v._data(t,s),o=s.events;if(o){delete a.handle;a.events={};for(i in o)for(n=0,r=o[i].length;n<r;n++)v.event.add(t,i,o[i][n])}a.data&&(a.data=v.extend({},a.data))}}function ke(e,t){var i,n,r;if(1===t.nodeType){i=t.nodeName.toLowerCase();if(!v.support.noCloneEvent&&t[v.expando]){r=v._data(t);for(n in r.events)v.removeEvent(t,n,r.handle);t.removeAttribute(v.expando)}if("script"===i&&t.text!==e.text){Pe(t).text=e.text;_e(t)}else if("object"===i){t.parentNode&&(t.outerHTML=e.outerHTML);v.support.html5Clone&&e.innerHTML&&!v.trim(t.innerHTML)&&(t.innerHTML=e.innerHTML)}else if("input"===i&&Le.test(e.type)){t.defaultChecked=t.checked=e.checked;t.value!==e.value&&(t.value=e.value)}else"option"===i?t.defaultSelected=t.selected=e.defaultSelected:"input"!==i&&"textarea"!==i||(t.defaultValue=e.defaultValue)}}v.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(e,t){v.fn[e]=function(e){for(var i,n=0,r=[],s=v(e),a=s.length-1;n<=a;n++){i=n===a?this:this.clone(!0);v(s[n])[t](i);d.apply(r,i.get())}return this.pushStack(r)}});function Re(e,i){var n,s,a=0,o=typeof e.getElementsByTagName!==r?e.getElementsByTagName(i||"*"):typeof e.querySelectorAll!==r?e.querySelectorAll(i||"*"):t;if(!o)for(o=[],n=e.childNodes||e;null!=(s=n[a]);a++)!i||v.nodeName(s,i)?o.push(s):v.merge(o,Re(s,i));return i===t||i&&v.nodeName(e,i)?v.merge([e],o):o}function Ie(e){Le.test(e.type)&&(e.defaultChecked=e.checked)}v.extend({clone:function(e,t,i){var n,r,s,a,o,l=v.contains(e.ownerDocument,e);if(v.support.html5Clone||v.isXMLDoc(e)||!fe.test("<"+e.nodeName+">"))s=e.cloneNode(!0);else{Ae.innerHTML=e.outerHTML;Ae.removeChild(s=Ae.firstChild)}if(!(v.support.noCloneEvent&&v.support.noCloneChecked||1!==e.nodeType&&11!==e.nodeType||v.isXMLDoc(e))){n=Re(s);o=Re(e);for(a=0;null!=(r=o[a]);++a)n[a]&&ke(r,n[a])}if(t)if(i){o=o||Re(e);n=n||Re(s);for(a=0;null!=(r=o[a]);a++)Me(r,n[a])}else Me(e,s);(n=Re(s,"script")).length>0&&Ne(n,!l&&Re(e,"script"));n=o=r=null;return s},buildFragment:function(e,t,i,n){for(var r,s,a,o,l,c,u,h=e.length,p=he(t),d=[],f=0;f<h;f++)if((s=e[f])||0===s)if("object"===v.type(s))v.merge(d,s.nodeType?[s]:s);else if(ve.test(s)){o=o||p.appendChild(t.createElement("div"));l=(ge.exec(s)||["",""])[1].toLowerCase();u=Oe[l]||Oe._default;o.innerHTML=u[1]+s.replace(ye,"<$1></$2>")+u[2];r=u[0];for(;r--;)o=o.lastChild;!v.support.leadingWhitespace&&me.test(s)&&d.push(t.createTextNode(me.exec(s)[0]));if(!v.support.tbody){r=(s="table"!==l||Ce.test(s)?"<table>"!==u[1]||Ce.test(s)?0:o:o.firstChild)&&s.childNodes.length;for(;r--;)v.nodeName(c=s.childNodes[r],"tbody")&&!c.childNodes.length&&s.removeChild(c)}v.merge(d,o.childNodes);o.textContent="";for(;o.firstChild;)o.removeChild(o.firstChild);o=p.lastChild}else d.push(t.createTextNode(s));o&&p.removeChild(o);v.support.appendChecked||v.grep(Re(d,"input"),Ie);f=0;for(;s=d[f++];)if(!n||-1===v.inArray(s,n)){a=v.contains(s.ownerDocument,s);o=Re(p.appendChild(s),"script");a&&Ne(o);if(i){r=0;for(;s=o[r++];)be.test(s.type||"")&&i.push(s)}}o=null;return p},cleanData:function(e,t){for(var i,n,s,a,o=0,l=v.expando,c=v.cache,u=v.support.deleteExpando,p=v.event.special;null!=(i=e[o]);o++)if((t||v.acceptData(i))&&(a=(s=i[l])&&c[s])){if(a.events)for(n in a.events)p[n]?v.event.remove(i,n):v.removeEvent(i,n,a.handle);if(c[s]){delete c[s];u?delete i[l]:typeof i.removeAttribute!==r?i.removeAttribute(l):i[l]=null;h.push(s)}}},_evalUrl:function(e){return v.ajax({url:e,type:"GET",dataType:"script",async:!1,global:!1,throws:!0})}});v.fn.extend({wrapAll:function(e){if(v.isFunction(e))return this.each(function(t){v(this).wrapAll(e.call(this,t))});if(this[0]){var t=v(e,this[0].ownerDocument).eq(0).clone(!0);this[0].parentNode&&t.insertBefore(this[0]);t.map(function(){for(var e=this;e.firstChild&&1===e.firstChild.nodeType;)e=e.firstChild;return e}).append(this)}return this},wrapInner:function(e){return v.isFunction(e)?this.each(function(t){v(this).wrapInner(e.call(this,t))}):this.each(function(){var t=v(this),i=t.contents();i.length?i.wrapAll(e):t.append(e)})},wrap:function(e){var t=v.isFunction(e);return this.each(function(i){v(this).wrapAll(t?e.call(this,i):e)})},unwrap:function(){return this.parent().each(function(){v.nodeName(this,"body")||v(this).replaceWith(this.childNodes)}).end()}});var De,Fe,$e,Be=/alpha\([^)]*\)/i,je=/opacity\s*=\s*([^)]*)/,Ue=/^(top|right|bottom|left)$/,Ge=/^(none|table(?!-c[ea]).+)/,We=/^margin/,ze=new RegExp("^("+T+")(.*)$","i"),He=new RegExp("^("+T+")(?!px)[a-z%]+$","i"),Ve=new RegExp("^([+-])=("+T+")","i"),qe={BODY:"block"},Ye={position:"absolute",visibility:"hidden",display:"block"},Xe={letterSpacing:0,fontWeight:400},Ke=["Top","Right","Bottom","Left"],Je=["Webkit","O","Moz","ms"];function Ze(e,t){if(t in e)return t;for(var i=t.charAt(0).toUpperCase()+t.slice(1),n=t,r=Je.length;r--;)if((t=Je[r]+i)in e)return t;return n}function Qe(e,t){e=t||e;return"none"===v.css(e,"display")||!v.contains(e.ownerDocument,e)}function et(e,t){for(var i,n,r,s=[],a=0,o=e.length;a<o;a++)if((n=e[a]).style){s[a]=v._data(n,"olddisplay");i=n.style.display;if(t){s[a]||"none"!==i||(n.style.display="");""===n.style.display&&Qe(n)&&(s[a]=v._data(n,"olddisplay",rt(n.nodeName)))}else if(!s[a]){r=Qe(n);(i&&"none"!==i||!r)&&v._data(n,"olddisplay",r?i:v.css(n,"display"))}}for(a=0;a<o;a++)(n=e[a]).style&&(t&&"none"!==n.style.display&&""!==n.style.display||(n.style.display=t?s[a]||"":"none"));return e}v.fn.extend({css:function(e,i){return v.access(this,function(e,i,n){var r,s,a={},o=0;if(v.isArray(i)){s=Fe(e);r=i.length;for(;o<r;o++)a[i[o]]=v.css(e,i[o],!1,s);return a}return n!==t?v.style(e,i,n):v.css(e,i)},e,i,arguments.length>1)},show:function(){return et(this,!0)},hide:function(){return et(this)},toggle:function(e){return"boolean"==typeof e?e?this.show():this.hide():this.each(function(){Qe(this)?v(this).show():v(this).hide()})}});v.extend({cssHooks:{opacity:{get:function(e,t){if(t){var i=$e(e,"opacity");return""===i?"1":i}}}},cssNumber:{columnCount:!0,fillOpacity:!0,fontWeight:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,widows:!0,zIndex:!0,zoom:!0},cssProps:{float:v.support.cssFloat?"cssFloat":"styleFloat"},style:function(e,i,n,r){if(e&&3!==e.nodeType&&8!==e.nodeType&&e.style){var s,a,o,l=v.camelCase(i),c=e.style;i=v.cssProps[l]||(v.cssProps[l]=Ze(c,l));o=v.cssHooks[i]||v.cssHooks[l];if(n===t)return o&&"get"in o&&(s=o.get(e,!1,r))!==t?s:c[i];if("string"===(a=typeof n)&&(s=Ve.exec(n))){n=(s[1]+1)*s[2]+parseFloat(v.css(e,i));a="number"}if(!(null==n||"number"===a&&isNaN(n))){"number"!==a||v.cssNumber[l]||(n+="px");v.support.clearCloneStyle||""!==n||0!==i.indexOf("background")||(c[i]="inherit");if(!(o&&"set"in o&&(n=o.set(e,n,r))===t))try{c[i]=n}catch(e){}}}},css:function(e,i,n,r){var s,a,o,l=v.camelCase(i);i=v.cssProps[l]||(v.cssProps[l]=Ze(e.style,l));(o=v.cssHooks[i]||v.cssHooks[l])&&"get"in o&&(a=o.get(e,!0,n));a===t&&(a=$e(e,i,r));"normal"===a&&i in Xe&&(a=Xe[i]);if(""===n||n){s=parseFloat(a);return!0===n||v.isNumeric(s)?s||0:a}return a}});if(e.getComputedStyle){Fe=function(t){return e.getComputedStyle(t,null)};$e=function(e,i,n){var r,s,a,o=n||Fe(e),l=o?o.getPropertyValue(i)||o[i]:t,c=e.style;if(o){""!==l||v.contains(e.ownerDocument,e)||(l=v.style(e,i));if(He.test(l)&&We.test(i)){r=c.width;s=c.minWidth;a=c.maxWidth;c.minWidth=c.maxWidth=c.width=l;l=o.width;c.width=r;c.minWidth=s;c.maxWidth=a}}return l}}else if(a.documentElement.currentStyle){Fe=function(e){return e.currentStyle};$e=function(e,i,n){var r,s,a,o=n||Fe(e),l=o?o[i]:t,c=e.style;null==l&&c&&c[i]&&(l=c[i]);if(He.test(l)&&!Ue.test(i)){r=c.left;(a=(s=e.runtimeStyle)&&s.left)&&(s.left=e.currentStyle.left);c.left="fontSize"===i?"1em":l;l=c.pixelLeft+"px";c.left=r;a&&(s.left=a)}return""===l?"auto":l}}function tt(e,t,i){var n=ze.exec(t);return n?Math.max(0,n[1]-(i||0))+(n[2]||"px"):t}function it(e,t,i,n,r){for(var s=i===(n?"border":"content")?4:"width"===t?1:0,a=0;s<4;s+=2){"margin"===i&&(a+=v.css(e,i+Ke[s],!0,r));if(n){"content"===i&&(a-=v.css(e,"padding"+Ke[s],!0,r));"margin"!==i&&(a-=v.css(e,"border"+Ke[s]+"Width",!0,r))}else{a+=v.css(e,"padding"+Ke[s],!0,r);"padding"!==i&&(a+=v.css(e,"border"+Ke[s]+"Width",!0,r))}}return a}function nt(e,t,i){var n=!0,r="width"===t?e.offsetWidth:e.offsetHeight,s=Fe(e),a=v.support.boxSizing&&"border-box"===v.css(e,"boxSizing",!1,s);if(r<=0||null==r){((r=$e(e,t,s))<0||null==r)&&(r=e.style[t]);if(He.test(r))return r;n=a&&(v.support.boxSizingReliable||r===e.style[t]);r=parseFloat(r)||0}return r+it(e,t,i||(a?"border":"content"),n,s)+"px"}function rt(e){var t=a,i=qe[e];if(!i){if("none"===(i=st(e,t))||!i){(t=((De=(De||v("<iframe frameborder='0' width='0' height='0'/>").css("cssText","display:block !important")).appendTo(t.documentElement))[0].contentWindow||De[0].contentDocument).document).write("<!doctype html><html><body>");t.close();i=st(e,t);De.detach()}qe[e]=i}return i}function st(e,t){var i=v(t.createElement(e)).appendTo(t.body),n=v.css(i[0],"display");i.remove();return n}v.each(["height","width"],function(e,t){v.cssHooks[t]={get:function(e,i,n){if(i)return 0===e.offsetWidth&&Ge.test(v.css(e,"display"))?v.swap(e,Ye,function(){return nt(e,t,n)}):nt(e,t,n)},set:function(e,i,n){var r=n&&Fe(e);return tt(0,i,n?it(e,t,n,v.support.boxSizing&&"border-box"===v.css(e,"boxSizing",!1,r),r):0)}}});v.support.opacity||(v.cssHooks.opacity={get:function(e,t){return je.test((t&&e.currentStyle?e.currentStyle.filter:e.style.filter)||"")?.01*parseFloat(RegExp.$1)+"":t?"1":""},set:function(e,t){var i=e.style,n=e.currentStyle,r=v.isNumeric(t)?"alpha(opacity="+100*t+")":"",s=n&&n.filter||i.filter||"";i.zoom=1;if((t>=1||""===t)&&""===v.trim(s.replace(Be,""))&&i.removeAttribute){i.removeAttribute("filter");if(""===t||n&&!n.filter)return}i.filter=Be.test(s)?s.replace(Be,r):s+" "+r}});v(function(){v.support.reliableMarginRight||(v.cssHooks.marginRight={get:function(e,t){if(t)return v.swap(e,{display:"inline-block"},$e,[e,"marginRight"])}});!v.support.pixelPosition&&v.fn.position&&v.each(["top","left"],function(e,t){v.cssHooks[t]={get:function(e,i){if(i){i=$e(e,t);return He.test(i)?v(e).position()[t]+"px":i}}}})});if(v.expr&&v.expr.filters){v.expr.filters.hidden=function(e){return e.offsetWidth<=0&&e.offsetHeight<=0||!v.support.reliableHiddenOffsets&&"none"===(e.style&&e.style.display||v.css(e,"display"))};v.expr.filters.visible=function(e){return!v.expr.filters.hidden(e)}}v.each({margin:"",padding:"",border:"Width"},function(e,t){v.cssHooks[e+t]={expand:function(i){for(var n=0,r={},s="string"==typeof i?i.split(" "):[i];n<4;n++)r[e+Ke[n]+t]=s[n]||s[n-2]||s[0];return r}};We.test(e)||(v.cssHooks[e+t].set=tt)});var at=/%20/g,ot=/\[\]$/,lt=/\r?\n/g,ct=/^(?:submit|button|image|reset|file)$/i,ut=/^(?:input|select|textarea|keygen)/i;v.fn.extend({serialize:function(){return v.param(this.serializeArray())},serializeArray:function(){return this.map(function(){var e=v.prop(this,"elements");return e?v.makeArray(e):this}).filter(function(){var e=this.type;return this.name&&!v(this).is(":disabled")&&ut.test(this.nodeName)&&!ct.test(e)&&(this.checked||!Le.test(e))}).map(function(e,t){var i=v(this).val();return null==i?null:v.isArray(i)?v.map(i,function(e){return{name:t.name,value:e.replace(lt,"\r\n")}}):{name:t.name,value:i.replace(lt,"\r\n")}}).get()}});v.param=function(e,i){var n,r=[],s=function(e,t){t=v.isFunction(t)?t():null==t?"":t;r[r.length]=encodeURIComponent(e)+"="+encodeURIComponent(t)};i===t&&(i=v.ajaxSettings&&v.ajaxSettings.traditional);if(v.isArray(e)||e.jquery&&!v.isPlainObject(e))v.each(e,function(){s(this.name,this.value)});else for(n in e)ht(n,e[n],i,s);return r.join("&").replace(at,"+")};function ht(e,t,i,n){var r;if(v.isArray(t))v.each(t,function(t,r){i||ot.test(e)?n(e,r):ht(e+"["+("object"==typeof r?t:"")+"]",r,i,n)});else if(i||"object"!==v.type(t))n(e,t);else for(r in t)ht(e+"["+r+"]",t[r],i,n)}v.each("blur focus focusin focusout load resize scroll unload click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup error contextmenu".split(" "),function(e,t){v.fn[t]=function(e,i){return arguments.length>0?this.on(t,null,e,i):this.trigger(t)}});v.fn.extend({hover:function(e,t){return this.mouseenter(e).mouseleave(t||e)},bind:function(e,t,i){return this.on(e,null,t,i)},unbind:function(e,t){return this.off(e,null,t)},delegate:function(e,t,i,n){return this.on(t,e,i,n)},undelegate:function(e,t,i){return 1===arguments.length?this.off(e,"**"):this.off(t,e||"**",i)}});var pt,dt,ft=v.now(),mt=/\?/,yt=/#.*$/,gt=/([?&])_=[^&]*/,Ct=/^(.*?):[ \t]*([^\r\n]*)\r?$/gm,vt=/^(?:GET|HEAD)$/,Tt=/^\/\//,Lt=/^([\w.+-]+:)(?:\/\/([^\/?#:]*)(?::(\d+)|)|)/,wt=v.fn.load,bt={},St={},Et="*/".concat("*");try{dt=s.href}catch(e){(dt=a.createElement("a")).href="";dt=dt.href}pt=Lt.exec(dt.toLowerCase())||[];function Ot(e){return function(t,i){if("string"!=typeof t){i=t;t="*"}var n,r=0,s=t.toLowerCase().match(L)||[];if(v.isFunction(i))for(;n=s[r++];)if("+"===n[0]){n=n.slice(1)||"*";(e[n]=e[n]||[]).unshift(i)}else(e[n]=e[n]||[]).push(i)}}function At(e,t,i,n){var r={},s=e===St;function a(o){var l;r[o]=!0;v.each(e[o]||[],function(e,o){var c=o(t,i,n);if("string"==typeof c&&!s&&!r[c]){t.dataTypes.unshift(c);a(c);return!1}if(s)return!(l=c)});return l}return a(t.dataTypes[0])||!r["*"]&&a("*")}function xt(e,i){var n,r,s=v.ajaxSettings.flatOptions||{};for(r in i)i[r]!==t&&((s[r]?e:n||(n={}))[r]=i[r]);n&&v.extend(!0,e,n);return e}v.fn.load=function(e,i,n){if("string"!=typeof e&&wt)return wt.apply(this,arguments);var r,s,a,o=this,l=e.indexOf(" ");if(l>=0){r=e.slice(l,e.length);e=e.slice(0,l)}if(v.isFunction(i)){n=i;i=t}else i&&"object"==typeof i&&(a="POST");o.length>0&&v.ajax({url:e,type:a,dataType:"html",data:i}).done(function(e){s=arguments;o.html(r?v("<div>").append(v.parseHTML(e)).find(r):e)}).complete(n&&function(e,t){o.each(n,s||[e.responseText,t,e])});return this};v.each(["ajaxStart","ajaxStop","ajaxComplete","ajaxError","ajaxSuccess","ajaxSend"],function(e,t){v.fn[t]=function(e){return this.on(t,e)}});v.extend({active:0,lastModified:{},etag:{},ajaxSettings:{url:dt,type:"GET",isLocal:/^(?:about|app|app-storage|.+-extension|file|res|widget):$/.test(pt[1]),global:!0,processData:!0,async:!0,contentType:"application/x-www-form-urlencoded; charset=UTF-8",accepts:{"*":Et,text:"text/plain",html:"text/html",xml:"application/xml, text/xml",json:"application/json, text/javascript"},contents:{xml:/xml/,html:/html/,json:/json/},responseFields:{xml:"responseXML",text:"responseText",json:"responseJSON"},converters:{"* text":String,"text html":!0,"text json":v.parseJSON,"text xml":v.parseXML},flatOptions:{url:!0,context:!0}},ajaxSetup:function(e,t){return t?xt(xt(e,v.ajaxSettings),t):xt(v.ajaxSettings,e)},ajaxPrefilter:Ot(bt),ajaxTransport:Ot(St),ajax:function(e,i){if("object"==typeof e){i=e;e=t}i=i||{};var n,r,s,a,o,l,c,u,h=v.ajaxSetup({},i),p=h.context||h,d=h.context&&(p.nodeType||p.jquery)?v(p):v.event,f=v.Deferred(),m=v.Callbacks("once memory"),y=h.statusCode||{},g={},C={},T=0,w="canceled",b={readyState:0,getResponseHeader:function(e){var t;if(2===T){if(!u){u={};for(;t=Ct.exec(a);)u[t[1].toLowerCase()]=t[2]}t=u[e.toLowerCase()]}return null==t?null:t},getAllResponseHeaders:function(){return 2===T?a:null},setRequestHeader:function(e,t){var i=e.toLowerCase();if(!T){e=C[i]=C[i]||e;g[e]=t}return this},overrideMimeType:function(e){T||(h.mimeType=e);return this},statusCode:function(e){var t;if(e)if(T<2)for(t in e)y[t]=[y[t],e[t]];else b.always(e[b.status]);return this},abort:function(e){var t=e||w;c&&c.abort(t);S(0,t);return this}};f.promise(b).complete=m.add;b.success=b.done;b.error=b.fail;h.url=((e||h.url||dt)+"").replace(yt,"").replace(Tt,pt[1]+"//");h.type=i.method||i.type||h.method||h.type;h.dataTypes=v.trim(h.dataType||"*").toLowerCase().match(L)||[""];if(null==h.crossDomain){n=Lt.exec(h.url.toLowerCase());h.crossDomain=!(!n||n[1]===pt[1]&&n[2]===pt[2]&&(n[3]||("http:"===n[1]?"80":"443"))===(pt[3]||("http:"===pt[1]?"80":"443")))}h.data&&h.processData&&"string"!=typeof h.data&&(h.data=v.param(h.data,h.traditional));At(bt,h,i,b);if(2===T)return b;(l=h.global)&&0==v.active++&&v.event.trigger("ajaxStart");h.type=h.type.toUpperCase();h.hasContent=!vt.test(h.type);s=h.url;if(!h.hasContent){if(h.data){s=h.url+=(mt.test(s)?"&":"?")+h.data;delete h.data}!1===h.cache&&(h.url=gt.test(s)?s.replace(gt,"$1_="+ft++):s+(mt.test(s)?"&":"?")+"_="+ft++)}if(h.ifModified){v.lastModified[s]&&b.setRequestHeader("If-Modified-Since",v.lastModified[s]);v.etag[s]&&b.setRequestHeader("If-None-Match",v.etag[s])}(h.data&&h.hasContent&&!1!==h.contentType||i.contentType)&&b.setRequestHeader("Content-Type",h.contentType);b.setRequestHeader("Accept",h.dataTypes[0]&&h.accepts[h.dataTypes[0]]?h.accepts[h.dataTypes[0]]+("*"!==h.dataTypes[0]?", "+Et+"; q=0.01":""):h.accepts["*"]);for(r in h.headers)b.setRequestHeader(r,h.headers[r]);if(h.beforeSend&&(!1===h.beforeSend.call(p,b,h)||2===T))return b.abort();w="abort";for(r in{success:1,error:1,complete:1})b[r](h[r]);if(c=At(St,h,i,b)){b.readyState=1;l&&d.trigger("ajaxSend",[b,h]);h.async&&h.timeout>0&&(o=setTimeout(function(){b.abort("timeout")},h.timeout));try{T=1;c.send(g,S)}catch(e){if(!(T<2))throw e;S(-1,e)}}else S(-1,"No Transport");function S(e,i,n,r){var u,g,C,L,w,S=i;if(2!==T){T=2;o&&clearTimeout(o);c=t;a=r||"";b.readyState=e>0?4:0;u=e>=200&&e<300||304===e;n&&(L=function(e,i,n){var r,s,a,o,l=e.contents,c=e.dataTypes;for(;"*"===c[0];){c.shift();s===t&&(s=e.mimeType||i.getResponseHeader("Content-Type"))}if(s)for(o in l)if(l[o]&&l[o].test(s)){c.unshift(o);break}if(c[0]in n)a=c[0];else{for(o in n){if(!c[0]||e.converters[o+" "+c[0]]){a=o;break}r||(r=o)}a=a||r}if(a){a!==c[0]&&c.unshift(a);return n[a]}}(h,b,n));L=function(e,t,i,n){var r,s,a,o,l,c={},u=e.dataTypes.slice();if(u[1])for(a in e.converters)c[a.toLowerCase()]=e.converters[a];s=u.shift();for(;s;){e.responseFields[s]&&(i[e.responseFields[s]]=t);!l&&n&&e.dataFilter&&(t=e.dataFilter(t,e.dataType));l=s;if(s=u.shift())if("*"===s)s=l;else if("*"!==l&&l!==s){if(!(a=c[l+" "+s]||c["* "+s]))for(r in c)if((o=r.split(" "))[1]===s&&(a=c[l+" "+o[0]]||c["* "+o[0]])){if(!0===a)a=c[r];else if(!0!==c[r]){s=o[0];u.unshift(o[1])}break}if(!0!==a)if(a&&e.throws)t=a(t);else try{t=a(t)}catch(e){return{state:"parsererror",error:a?e:"No conversion from "+l+" to "+s}}}}return{state:"success",data:t}}(h,L,b,u);if(u){if(h.ifModified){(w=b.getResponseHeader("Last-Modified"))&&(v.lastModified[s]=w);(w=b.getResponseHeader("etag"))&&(v.etag[s]=w)}if(204===e||"HEAD"===h.type)S="nocontent";else if(304===e)S="notmodified";else{S=L.state;g=L.data;u=!(C=L.error)}}else{C=S;if(e||!S){S="error";e<0&&(e=0)}}b.status=e;b.statusText=(i||S)+"";u?f.resolveWith(p,[g,S,b]):f.rejectWith(p,[b,S,C]);b.statusCode(y);y=t;l&&d.trigger(u?"ajaxSuccess":"ajaxError",[b,h,u?g:C]);m.fireWith(p,[b,S]);if(l){d.trigger("ajaxComplete",[b,h]);--v.active||v.event.trigger("ajaxStop")}}}return b},getJSON:function(e,t,i){return v.get(e,t,i,"json")},getScript:function(e,i){return v.get(e,t,i,"script")}});v.each(["get","post"],function(e,i){v[i]=function(e,n,r,s){if(v.isFunction(n)){s=s||r;r=n;n=t}return v.ajax({url:e,type:i,dataType:s,data:n,success:r})}});v.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/(?:java|ecma)script/},converters:{"text script":function(e){v.globalEval(e);return e}}});v.ajaxPrefilter("script",function(e){e.cache===t&&(e.cache=!1);if(e.crossDomain){e.type="GET";e.global=!1}});v.ajaxTransport("script",function(e){if(e.crossDomain){var i,n=a.head||v("head")[0]||a.documentElement;return{send:function(t,r){(i=a.createElement("script")).async=!0;e.scriptCharset&&(i.charset=e.scriptCharset);i.src=e.url;i.onload=i.onreadystatechange=function(e,t){if(t||!i.readyState||/loaded|complete/.test(i.readyState)){i.onload=i.onreadystatechange=null;i.parentNode&&i.parentNode.removeChild(i);i=null;t||r(200,"success")}};n.insertBefore(i,n.firstChild)},abort:function(){i&&i.onload(t,!0)}}}});var Pt=[],_t=/(=)\?(?=&|$)|\?\?/;v.ajaxSetup({jsonp:"callback",jsonpCallback:function(){var e=Pt.pop()||v.expando+"_"+ft++;this[e]=!0;return e}});v.ajaxPrefilter("json jsonp",function(i,n,r){var s,a,o,l=!1!==i.jsonp&&(_t.test(i.url)?"url":"string"==typeof i.data&&!(i.contentType||"").indexOf("application/x-www-form-urlencoded")&&_t.test(i.data)&&"data");if(l||"jsonp"===i.dataTypes[0]){s=i.jsonpCallback=v.isFunction(i.jsonpCallback)?i.jsonpCallback():i.jsonpCallback;l?i[l]=i[l].replace(_t,"$1"+s):!1!==i.jsonp&&(i.url+=(mt.test(i.url)?"&":"?")+i.jsonp+"="+s);i.converters["script json"]=function(){o||v.error(s+" was not called");return o[0]};i.dataTypes[0]="json";a=e[s];e[s]=function(){o=arguments};r.always(function(){e[s]=a;if(i[s]){i.jsonpCallback=n.jsonpCallback;Pt.push(s)}o&&v.isFunction(a)&&a(o[0]);o=a=t});return"script"}});var Nt,Mt,kt=0,Rt=e.ActiveXObject&&function(){var e;for(e in Nt)Nt[e](t,!0)};function It(){try{return new e.XMLHttpRequest}catch(e){}}v.ajaxSettings.xhr=e.ActiveXObject?function(){return!this.isLocal&&It()||function(){try{return new e.ActiveXObject("Microsoft.XMLHTTP")}catch(e){}}()}:It;Mt=v.ajaxSettings.xhr();v.support.cors=!!Mt&&"withCredentials"in Mt;(Mt=v.support.ajax=!!Mt)&&v.ajaxTransport(function(i){if(!i.crossDomain||v.support.cors){var n;return{send:function(r,s){var a,o,l=i.xhr();i.username?l.open(i.type,i.url,i.async,i.username,i.password):l.open(i.type,i.url,i.async);if(i.xhrFields)for(o in i.xhrFields)l[o]=i.xhrFields[o];i.mimeType&&l.overrideMimeType&&l.overrideMimeType(i.mimeType);i.crossDomain||r["X-Requested-With"]||(r["X-Requested-With"]="XMLHttpRequest");try{for(o in r)l.setRequestHeader(o,r[o])}catch(e){}l.send(i.hasContent&&i.data||null);n=function(e,r){var o,c,u,h;try{if(n&&(r||4===l.readyState)){n=t;if(a){l.onreadystatechange=v.noop;Rt&&delete Nt[a]}if(r)4!==l.readyState&&l.abort();else{h={};o=l.status;c=l.getAllResponseHeaders();"string"==typeof l.responseText&&(h.text=l.responseText);try{u=l.statusText}catch(e){u=""}o||!i.isLocal||i.crossDomain?1223===o&&(o=204):o=h.text?200:404}}}catch(e){r||s(-1,e)}h&&s(o,u,h,c)};if(i.async)if(4===l.readyState)setTimeout(n);else{a=++kt;if(Rt){if(!Nt){Nt={};v(e).unload(Rt)}Nt[a]=n}l.onreadystatechange=n}else n()},abort:function(){n&&n(t,!0)}}}});var Dt,Ft,$t=/^(?:toggle|show|hide)$/,Bt=new RegExp("^(?:([+-])=|)("+T+")([a-z%]*)$","i"),jt=/queueHooks$/,Ut=[function(e,t,i){var n,r,s,a,o,l,c=this,u={},h=e.style,p=e.nodeType&&Qe(e),d=v._data(e,"fxshow");if(!i.queue){if(null==(o=v._queueHooks(e,"fx")).unqueued){o.unqueued=0;l=o.empty.fire;o.empty.fire=function(){o.unqueued||l()}}o.unqueued++;c.always(function(){c.always(function(){o.unqueued--;v.queue(e,"fx").length||o.empty.fire()})})}if(1===e.nodeType&&("height"in t||"width"in t)){i.overflow=[h.overflow,h.overflowX,h.overflowY];"inline"===v.css(e,"display")&&"none"===v.css(e,"float")&&(v.support.inlineBlockNeedsLayout&&"inline"!==rt(e.nodeName)?h.zoom=1:h.display="inline-block")}if(i.overflow){h.overflow="hidden";v.support.shrinkWrapBlocks||c.always(function(){h.overflow=i.overflow[0];h.overflowX=i.overflow[1];h.overflowY=i.overflow[2]})}for(n in t){r=t[n];if($t.exec(r)){delete t[n];s=s||"toggle"===r;if(r===(p?"hide":"show"))continue;u[n]=d&&d[n]||v.style(e,n)}}if(!v.isEmptyObject(u)){d?"hidden"in d&&(p=d.hidden):d=v._data(e,"fxshow",{});s&&(d.hidden=!p);p?v(e).show():c.done(function(){v(e).hide()});c.done(function(){var t;v._removeData(e,"fxshow");for(t in u)v.style(e,t,u[t])});for(n in u){a=zt(p?d[n]:0,n,c);if(!(n in d)){d[n]=a.start;if(p){a.end=a.start;a.start="width"===n||"height"===n?1:0}}}}}],Gt={"*":[function(e,t){var i=this.createTween(e,t),n=i.cur(),r=Bt.exec(t),s=r&&r[3]||(v.cssNumber[e]?"":"px"),a=(v.cssNumber[e]||"px"!==s&&+n)&&Bt.exec(v.css(i.elem,e)),o=1,l=20;if(a&&a[3]!==s){s=s||a[3];r=r||[];a=+n||1;do{a/=o=o||".5";v.style(i.elem,e,a+s)}while(o!==(o=i.cur()/n)&&1!==o&&--l)}if(r){a=i.start=+a||+n||0;i.unit=s;i.end=r[1]?a+(r[1]+1)*r[2]:+r[2]}return i}]};function Wt(){setTimeout(function(){Dt=t});return Dt=v.now()}function zt(e,t,i){for(var n,r=(Gt[t]||[]).concat(Gt["*"]),s=0,a=r.length;s<a;s++)if(n=r[s].call(i,t,e))return n}function Ht(e,t,i){var n,r,s=0,a=Ut.length,o=v.Deferred().always(function(){delete l.elem}),l=function(){if(r)return!1;for(var t=Dt||Wt(),i=Math.max(0,c.startTime+c.duration-t),n=1-(i/c.duration||0),s=0,a=c.tweens.length;s<a;s++)c.tweens[s].run(n);o.notifyWith(e,[c,n,i]);if(n<1&&a)return i;o.resolveWith(e,[c]);return!1},c=o.promise({elem:e,props:v.extend({},t),opts:v.extend(!0,{specialEasing:{}},i),originalProperties:t,originalOptions:i,startTime:Dt||Wt(),duration:i.duration,tweens:[],createTween:function(t,i){var n=v.Tween(e,c.opts,t,i,c.opts.specialEasing[t]||c.opts.easing);c.tweens.push(n);return n},stop:function(t){var i=0,n=t?c.tweens.length:0;if(r)return this;r=!0;for(;i<n;i++)c.tweens[i].run(1);t?o.resolveWith(e,[c,t]):o.rejectWith(e,[c,t]);return this}}),u=c.props;!function(e,t){var i,n,r,s,a;for(i in e){n=v.camelCase(i);r=t[n];s=e[i];if(v.isArray(s)){r=s[1];s=e[i]=s[0]}if(i!==n){e[n]=s;delete e[i]}if((a=v.cssHooks[n])&&"expand"in a){s=a.expand(s);delete e[n];for(i in s)if(!(i in e)){e[i]=s[i];t[i]=r}}else t[n]=r}}(u,c.opts.specialEasing);for(;s<a;s++)if(n=Ut[s].call(c,e,u,c.opts))return n;v.map(u,zt,c);v.isFunction(c.opts.start)&&c.opts.start.call(e,c);v.fx.timer(v.extend(l,{elem:e,anim:c,queue:c.opts.queue}));return c.progress(c.opts.progress).done(c.opts.done,c.opts.complete).fail(c.opts.fail).always(c.opts.always)}v.Animation=v.extend(Ht,{tweener:function(e,t){if(v.isFunction(e)){t=e;e=["*"]}else e=e.split(" ");for(var i,n=0,r=e.length;n<r;n++){i=e[n];Gt[i]=Gt[i]||[];Gt[i].unshift(t)}},prefilter:function(e,t){t?Ut.unshift(e):Ut.push(e)}});function Vt(e,t,i,n,r){return new Vt.prototype.init(e,t,i,n,r)}v.Tween=Vt;Vt.prototype={constructor:Vt,init:function(e,t,i,n,r,s){this.elem=e;this.prop=i;this.easing=r||"swing";this.options=t;this.start=this.now=this.cur();this.end=n;this.unit=s||(v.cssNumber[i]?"":"px")},cur:function(){var e=Vt.propHooks[this.prop];return e&&e.get?e.get(this):Vt.propHooks._default.get(this)},run:function(e){var t,i=Vt.propHooks[this.prop];this.options.duration?this.pos=t=v.easing[this.easing](e,this.options.duration*e,0,1,this.options.duration):this.pos=t=e;this.now=(this.end-this.start)*t+this.start;this.options.step&&this.options.step.call(this.elem,this.now,this);i&&i.set?i.set(this):Vt.propHooks._default.set(this);return this}};Vt.prototype.init.prototype=Vt.prototype;Vt.propHooks={_default:{get:function(e){var t;return null==e.elem[e.prop]||e.elem.style&&null!=e.elem.style[e.prop]?(t=v.css(e.elem,e.prop,""))&&"auto"!==t?t:0:e.elem[e.prop]},set:function(e){v.fx.step[e.prop]?v.fx.step[e.prop](e):e.elem.style&&(null!=e.elem.style[v.cssProps[e.prop]]||v.cssHooks[e.prop])?v.style(e.elem,e.prop,e.now+e.unit):e.elem[e.prop]=e.now}}};Vt.propHooks.scrollTop=Vt.propHooks.scrollLeft={set:function(e){e.elem.nodeType&&e.elem.parentNode&&(e.elem[e.prop]=e.now)}};v.each(["toggle","show","hide"],function(e,t){var i=v.fn[t];v.fn[t]=function(e,n,r){return null==e||"boolean"==typeof e?i.apply(this,arguments):this.animate(qt(t,!0),e,n,r)}});v.fn.extend({fadeTo:function(e,t,i,n){return this.filter(Qe).css("opacity",0).show().end().animate({opacity:t},e,i,n)},animate:function(e,t,i,n){var r=v.isEmptyObject(e),s=v.speed(t,i,n),a=function(){var t=Ht(this,v.extend({},e),s);(r||v._data(this,"finish"))&&t.stop(!0)};a.finish=a;return r||!1===s.queue?this.each(a):this.queue(s.queue,a)},stop:function(e,i,n){var r=function(e){var t=e.stop;delete e.stop;t(n)};if("string"!=typeof e){n=i;i=e;e=t}i&&!1!==e&&this.queue(e||"fx",[]);return this.each(function(){var t=!0,i=null!=e&&e+"queueHooks",s=v.timers,a=v._data(this);if(i)a[i]&&a[i].stop&&r(a[i]);else for(i in a)a[i]&&a[i].stop&&jt.test(i)&&r(a[i]);for(i=s.length;i--;)if(s[i].elem===this&&(null==e||s[i].queue===e)){s[i].anim.stop(n);t=!1;s.splice(i,1)}!t&&n||v.dequeue(this,e)})},finish:function(e){!1!==e&&(e=e||"fx");return this.each(function(){var t,i=v._data(this),n=i[e+"queue"],r=i[e+"queueHooks"],s=v.timers,a=n?n.length:0;i.finish=!0;v.queue(this,e,[]);r&&r.stop&&r.stop.call(this,!0);for(t=s.length;t--;)if(s[t].elem===this&&s[t].queue===e){s[t].anim.stop(!0);s.splice(t,1)}for(t=0;t<a;t++)n[t]&&n[t].finish&&n[t].finish.call(this);delete i.finish})}});function qt(e,t){var i,n={height:e},r=0;t=t?1:0;for(;r<4;r+=2-t)n["margin"+(i=Ke[r])]=n["padding"+i]=e;t&&(n.opacity=n.width=e);return n}v.each({slideDown:qt("show"),slideUp:qt("hide"),slideToggle:qt("toggle"),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(e,t){v.fn[e]=function(e,i,n){return this.animate(t,e,i,n)}});v.speed=function(e,t,i){var n=e&&"object"==typeof e?v.extend({},e):{complete:i||!i&&t||v.isFunction(e)&&e,duration:e,easing:i&&t||t&&!v.isFunction(t)&&t};n.duration=v.fx.off?0:"number"==typeof n.duration?n.duration:n.duration in v.fx.speeds?v.fx.speeds[n.duration]:v.fx.speeds._default;null!=n.queue&&!0!==n.queue||(n.queue="fx");n.old=n.complete;n.complete=function(){v.isFunction(n.old)&&n.old.call(this);n.queue&&v.dequeue(this,n.queue)};return n};v.easing={linear:function(e){return e},swing:function(e){return.5-Math.cos(e*Math.PI)/2}};v.timers=[];v.fx=Vt.prototype.init;v.fx.tick=function(){var e,i=v.timers,n=0;Dt=v.now();for(;n<i.length;n++)(e=i[n])()||i[n]!==e||i.splice(n--,1);i.length||v.fx.stop();Dt=t};v.fx.timer=function(e){e()&&v.timers.push(e)&&v.fx.start()};v.fx.interval=13;v.fx.start=function(){Ft||(Ft=setInterval(v.fx.tick,v.fx.interval))};v.fx.stop=function(){clearInterval(Ft);Ft=null};v.fx.speeds={slow:600,fast:200,_default:400};v.fx.step={};v.expr&&v.expr.filters&&(v.expr.filters.animated=function(e){return v.grep(v.timers,function(t){return e===t.elem}).length});v.fn.offset=function(e){if(arguments.length)return e===t?this:this.each(function(t){v.offset.setOffset(this,e,t)});var i,n,s={top:0,left:0},a=this[0],o=a&&a.ownerDocument;if(o){i=o.documentElement;if(!v.contains(i,a))return s;typeof a.getBoundingClientRect!==r&&(s=a.getBoundingClientRect());n=Yt(o);return{top:s.top+(n.pageYOffset||i.scrollTop)-(i.clientTop||0),left:s.left+(n.pageXOffset||i.scrollLeft)-(i.clientLeft||0)}}};v.offset={setOffset:function(e,t,i){var n=v.css(e,"position");"static"===n&&(e.style.position="relative");var r,s,a=v(e),o=a.offset(),l=v.css(e,"top"),c=v.css(e,"left"),u={},h={};if(("absolute"===n||"fixed"===n)&&v.inArray("auto",[l,c])>-1){r=(h=a.position()).top;s=h.left}else{r=parseFloat(l)||0;s=parseFloat(c)||0}v.isFunction(t)&&(t=t.call(e,i,o));null!=t.top&&(u.top=t.top-o.top+r);null!=t.left&&(u.left=t.left-o.left+s);"using"in t?t.using.call(e,u):a.css(u)}};v.fn.extend({position:function(){if(this[0]){var e,t,i={top:0,left:0},n=this[0];if("fixed"===v.css(n,"position"))t=n.getBoundingClientRect();else{e=this.offsetParent();t=this.offset();v.nodeName(e[0],"html")||(i=e.offset());i.top+=v.css(e[0],"borderTopWidth",!0);i.left+=v.css(e[0],"borderLeftWidth",!0)}return{top:t.top-i.top-v.css(n,"marginTop",!0),left:t.left-i.left-v.css(n,"marginLeft",!0)}}},offsetParent:function(){return this.map(function(){for(var e=this.offsetParent||o;e&&!v.nodeName(e,"html")&&"static"===v.css(e,"position");)e=e.offsetParent;return e||o})}});v.each({scrollLeft:"pageXOffset",scrollTop:"pageYOffset"},function(e,i){var n=/Y/.test(i);v.fn[e]=function(r){return v.access(this,function(e,r,s){var a=Yt(e);if(s===t)return a?i in a?a[i]:a.document.documentElement[r]:e[r];a?a.scrollTo(n?v(a).scrollLeft():s,n?s:v(a).scrollTop()):e[r]=s},e,r,arguments.length,null)}});function Yt(e){return v.isWindow(e)?e:9===e.nodeType&&(e.defaultView||e.parentWindow)}v.each({Height:"height",Width:"width"},function(e,i){v.each({padding:"inner"+e,content:i,"":"outer"+e},function(n,r){v.fn[r]=function(r,s){var a=arguments.length&&(n||"boolean"!=typeof r),o=n||(!0===r||!0===s?"margin":"border");return v.access(this,function(i,n,r){var s;if(v.isWindow(i))return i.document.documentElement["client"+e];if(9===i.nodeType){s=i.documentElement;return Math.max(i.body["scroll"+e],s["scroll"+e],i.body["offset"+e],s["offset"+e],s["client"+e])}return r===t?v.css(i,n,o):v.style(i,n,r,o)},i,a?r:t,a,null)}})});v.fn.size=function(){return this.length};v.fn.andSelf=v.fn.addBack;if("object"==typeof module&&module&&"object"==typeof module.exports)module.exports=v;else{e.jQuery=e.$=v;"function"==typeof define&&define.amd&&define("jquery",[],function(){return v})}}(window);!function(e){"function"==typeof define&&define.amd?define(["jquery"],e):e(jQuery)}(function(e){if(!e.support.cors&&e.ajaxTransport&&window.XDomainRequest){var t=/^https?:\/\//i,i=/^get|post$/i,n=new RegExp("^"+location.protocol,"i");e.ajaxTransport("* text html xml json",function(r,s,a){if(r.crossDomain&&r.async&&i.test(r.type)&&t.test(r.url)&&n.test(r.url)){var o=null;return{send:function(t,i){var n="",a=(s.dataType||"").toLowerCase();o=new XDomainRequest;/^\d+$/.test(s.timeout)&&(o.timeout=s.timeout);o.ontimeout=function(){i(500,"timeout")};o.onload=function(){var t="Content-Length: "+o.responseText.length+"\r\nContent-Type: "+o.contentType,n={code:200,message:"success"},r={text:o.responseText};try{if("html"===a||/text\/html/i.test(o.contentType))r.html=o.responseText;else if("json"===a||"text"!==a&&/\/json/i.test(o.contentType))try{r.json=e.parseJSON(o.responseText)}catch(e){n.code=500;n.message="parseerror"}else if("xml"===a||"text"!==a&&/\/xml/i.test(o.contentType)){var s=new ActiveXObject("Microsoft.XMLDOM");s.async=!1;try{s.loadXML(o.responseText)}catch(e){s=void 0}if(!s||!s.documentElement||s.getElementsByTagName("parsererror").length){n.code=500;n.message="parseerror";throw"Invalid XML: "+o.responseText}r.xml=s}}catch(e){throw e}finally{i(n.code,n.message,r,t)}};o.onprogress=function(){};o.onerror=function(){i(500,"error",{text:o.responseText})};s.data&&(n="string"===e.type(s.data)?s.data:e.param(s.data));o.open(r.type,r.url);o.send(n)},abort:function(){o&&o.abort()}}}})}});!function(e){"use strict";e();var t=function(t,n,r){var s=[];if(n)if(r.buildHTML)e(r.target).html(r.buildHTML({results:n}));else{for(var a=0;a<n.length;a++){var o=n[a];e.isPlainObject(o)?s[s.length]='<li><a href="'+r.link+encodeURIComponent(o.id)+'">'+o.label+"</a></li>":s[s.length]='<li><a href="'+r.link+encodeURIComponent(o)+'">'+o+"</a></li>"}e(r.target).html(s.join(""))}null!==r.callback&&e.isFunction(r.callback)&&i(r);t.val().length>0?t.trigger("targetUpdated.autocomplete"):t.trigger("targetCleared.autocomplete")},i=function(t){e("li a",e(t.target)).on("click.autocomplete",function(e){e.stopPropagation();e.preventDefault();t.callback(e)})},n=function(e,t){t.html("").closest("fieldset").removeClass("ui-search-active");e.trigger("targetCleared.autocomplete")},r=function(i){var r,s,a,o,l=e(this),c=l.attr("id"),u=l.data("autocomplete");if(u){var h=u.settings,p=u.openXHR;if((r=l.val()).length<h.minLength)n(l,e(h.target));else if(e.isArray(h.source)){s=h.source.sort().filter(function(t){o=h.matchFromStart?new RegExp("^"+r,"i"):new RegExp(r,"i");a=e.isPlainObject(t)?t.label:t;return o.test(a)});t(l,s,h)}else"function"==typeof h.source?h.source(r,function(e){t(l,e,h)}):e.ajax({type:h.method,url:h.source,data:{term:r},beforeSend:function(e){if(h.cancelRequests){if(p[c])p[c].abort();else{h.target.html('<li><a href="#">Searching...</a></li>');h.target.closest("fieldset").addClass("ui-search-active")}p[c]=e}},success:function(e){t(l,e,h)},complete:function(e,t){h.cancelRequests&&(p[c]=null)},dataType:"json"})}},s={init:function(t){var i=this,s={settings:null};s.settings=e.extend({},s.defaults,t);i.data("autocomplete",s);var a=s.settings;return i.off("keyup.autocomplete").on("keyup.autocomplete",r).next(".ui-input-clear").on("click",function(t){n(i,e(a.target))})},update:function(t){var i=this.data("autocomplete");if(i){i.settings=e.extend(i.settings,t);this.data("autocomplete",i)}return this},clear:function(){var t=this.data("autocomplete");t&&n(this,e(t.settings.target));return this},destroy:function(){var t=this.data("autocomplete");if(t){n(this,e(t.settings.target));this.removeData("autocomplete");this.off(".autocomplete")}return this}};e.fn.autocomplete=function(e){return s[e]?s[e].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof e&&e?void 0:s.init.apply(this,arguments)}}(jQuery);!function(e){e.fn.drag=function(t,i,n){var r="string"==typeof t?t:"",s=e.isFunction(t)?t:e.isFunction(i)?i:null;0!==r.indexOf("drag")&&(r="drag"+r);n=(t==s?i:n)||{};return s?this.bind(r,n,s):this.trigger(r)};var t=e.event,i=t.special,n=i.drag={defaults:{which:1,distance:0,not:":input",handle:null,relative:!1,drop:!0,click:!1},datakey:"dragdata",noBubble:!0,add:function(t){var i=e.data(this,n.datakey),r=t.data||{};i.related+=1;e.each(n.defaults,function(e,t){void 0!==r[e]&&(i[e]=r[e])})},remove:function(){e.data(this,n.datakey).related-=1},setup:function(){if(!e.data(this,n.datakey)){var i=e.extend({related:0},n.defaults);e.data(this,n.datakey,i);t.add(this,"touchstart mousedown",n.init,i);this.attachEvent&&this.attachEvent("ondragstart",n.dontstart)}},teardown:function(){if(!(e.data(this,n.datakey)||{}).related){e.removeData(this,n.datakey);t.remove(this,"touchstart mousedown",n.init);n.textselect(!0);this.detachEvent&&this.detachEvent("ondragstart",n.dontstart)}},init:function(r){if(!n.touched){var s,a=r.data;if(!(0!=r.which&&a.which>0&&r.which!=a.which)&&!e(r.target).is(a.not)&&(!a.handle||e(r.target).closest(a.handle,r.currentTarget).length)){n.touched="touchstart"==r.type?this:null;a.propagates=1;a.mousedown=this;a.interactions=[n.interaction(this,a)];a.target=r.target;a.pageX=r.pageX;a.pageY=r.pageY;a.dragging=null;s=n.hijack(r,"draginit",a);if(a.propagates){if((s=n.flatten(s))&&s.length){a.interactions=[];e.each(s,function(){a.interactions.push(n.interaction(this,a))})}a.propagates=a.interactions.length;!1!==a.drop&&i.drop&&i.drop.handler(r,a);n.textselect(!1);n.touched?t.add(n.touched,"touchmove touchend",n.handler,a):t.add(document,"mousemove mouseup",n.handler,a);return!(!n.touched||a.live)&&void 0}}}},interaction:function(t,i){var r=e(t)[i.relative?"position":"offset"]()||{top:0,left:0};return{drag:t,callback:new n.callback,droppable:[],offset:r}},handler:function(r){var s=r.data;switch(r.type){case!s.dragging&&"touchmove":r.preventDefault();case!s.dragging&&"mousemove":if(Math.pow(r.pageX-s.pageX,2)+Math.pow(r.pageY-s.pageY,2)<Math.pow(s.distance,2))break;r.target=s.target;n.hijack(r,"dragstart",s);s.propagates&&(s.dragging=!0);case"touchmove":r.preventDefault();case"mousemove":if(s.dragging){n.hijack(r,"drag",s);if(s.propagates){!1!==s.drop&&i.drop&&i.drop.handler(r,s);break}r.type="mouseup"}case"touchend":case"mouseup":default:n.touched?t.remove(n.touched,"touchmove touchend",n.handler):t.remove(document,"mousemove mouseup",n.handler);if(s.dragging){!1!==s.drop&&i.drop&&i.drop.handler(r,s);n.hijack(r,"dragend",s)}n.textselect(!0);!1===s.click&&s.dragging&&e.data(s.mousedown,"suppress.click",(new Date).getTime()+5);s.dragging=n.touched=!1}},hijack:function(i,r,s,a,o){if(s){var l,c,u,h={event:i.originalEvent,type:i.type},p=r.indexOf("drop")?"drag":"drop",d=a||0,f=isNaN(a)?s.interactions.length:a;i.type=r;i.originalEvent=null;s.results=[];do{if(c=s.interactions[d]){if("dragend"!==r&&c.cancelled)continue;u=n.properties(i,s,c);c.results=[];e(o||c[p]||s.droppable).each(function(a,o){u.target=o;i.isPropagationStopped=function(){return!1};if(!1===(l=o?t.dispatch.call(o,i,u):null)){if("drag"==p){c.cancelled=!0;s.propagates-=1}"drop"==r&&(c[p][a]=null)}else"dropinit"==r&&c.droppable.push(n.element(l)||o);"dragstart"==r&&(c.proxy=e(n.element(l)||c.drag)[0]);c.results.push(l);delete i.result;if("dropinit"!==r)return l});s.results[d]=n.flatten(c.results);"dropinit"==r&&(c.droppable=n.flatten(c.droppable));"dragstart"!=r||c.cancelled||u.update()}}while(++d<f);i.type=h.type;i.originalEvent=h.event;return n.flatten(s.results)}},properties:function(e,t,i){var r=i.callback;r.drag=i.drag;r.proxy=i.proxy||i.drag;r.startX=t.pageX;r.startY=t.pageY;r.deltaX=e.pageX-t.pageX;r.deltaY=e.pageY-t.pageY;r.originalX=i.offset.left;r.originalY=i.offset.top;r.offsetX=r.originalX+r.deltaX;r.offsetY=r.originalY+r.deltaY;r.drop=n.flatten((i.drop||[]).slice());r.available=n.flatten((i.droppable||[]).slice());return r},element:function(e){if(e&&(e.jquery||1==e.nodeType))return e},flatten:function(t){return e.map(t,function(t){return t&&t.jquery?e.makeArray(t):t&&t.length?n.flatten(t):t})},textselect:function(t){e(document)[t?"unbind":"bind"]("selectstart",n.dontstart).css("MozUserSelect",t?"":"none");document.unselectable=t?"off":"on"},dontstart:function(){return!1},callback:function(){}};n.callback.prototype={update:function(){i.drop&&this.available.length&&e.each(this.available,function(e){i.drop.locate(this,e)})}};var r=t.dispatch;t.dispatch=function(t){if(!(e.data(this,"suppress."+t.type)-(new Date).getTime()>0))return r.apply(this,arguments);e.removeData(this,"suppress."+t.type)};var s=t.fixHooks.touchstart=t.fixHooks.touchmove=t.fixHooks.touchend=t.fixHooks.touchcancel={props:"clientX clientY pageX pageY screenX screenY".split(" "),filter:function(t,i){if(i){var n=i.touches&&i.touches[0]||i.changedTouches&&i.changedTouches[0]||null;n&&e.each(s.props,function(e,i){t[i]=n[i]})}return t}};i.draginit=i.dragstart=i.dragend=n}(jQuery);!function(e){e.fn.drop=function(t,i,n){var r="string"==typeof t?t:"",s=e.isFunction(t)?t:e.isFunction(i)?i:null;0!==r.indexOf("drop")&&(r="drop"+r);n=(t==s?i:n)||{};return s?this.bind(r,n,s):this.trigger(r)};e.drop=function(t){t=t||{};i.multi=!0===t.multi?1/0:!1===t.multi?1:isNaN(t.multi)?i.multi:t.multi;i.delay=t.delay||i.delay;i.tolerance=e.isFunction(t.tolerance)?t.tolerance:null===t.tolerance?null:i.tolerance;i.mode=t.mode||i.mode||"intersect"};var t=e.event.special,i=e.event.special.drop={multi:1,delay:20,mode:"overlap",targets:[],datakey:"dropdata",noBubble:!0,add:function(t){e.data(this,i.datakey).related+=1},remove:function(){e.data(this,i.datakey).related-=1},setup:function(){if(!e.data(this,i.datakey)){e.data(this,i.datakey,{related:0,active:[],anyactive:0,winner:0,location:{}});i.targets.push(this)}},teardown:function(){if(!(e.data(this,i.datakey)||{}).related){e.removeData(this,i.datakey);var t=this;i.targets=e.grep(i.targets,function(e){return e!==t})}},handler:function(n,r){var s;if(r)switch(n.type){case"mousedown":case"touchstart":s=e(i.targets);"string"==typeof r.drop&&(s=s.filter(r.drop));s.each(function(){var t=e.data(this,i.datakey);t.active=[];t.anyactive=0;t.winner=0});r.droppable=s;t.drag.hijack(n,"dropinit",r);break;case"mousemove":case"touchmove":i.event=n;i.timer||i.tolerate(r);break;case"mouseup":case"touchend":i.timer=clearTimeout(i.timer);if(r.propagates){t.drag.hijack(n,"drop",r);t.drag.hijack(n,"dropend",r)}}},locate:function(t,n){var r=e.data(t,i.datakey),s=e(t),a=s.offset()||{},o=s.outerHeight(),l=s.outerWidth(),c={elem:t,width:l,height:o,top:a.top,left:a.left,right:a.left+l,bottom:a.top+o};if(r){r.location=c;r.index=n;r.elem=t}return c},contains:function(e,t){return(t[0]||t.left)>=e.left&&(t[0]||t.right)<=e.right&&(t[1]||t.top)>=e.top&&(t[1]||t.bottom)<=e.bottom},modes:{intersect:function(e,t,i){return this.contains(i,[e.pageX,e.pageY])?1e9:this.modes.overlap.apply(this,arguments)},overlap:function(e,t,i){return Math.max(0,Math.min(i.bottom,t.bottom)-Math.max(i.top,t.top))*Math.max(0,Math.min(i.right,t.right)-Math.max(i.left,t.left))},fit:function(e,t,i){return this.contains(i,t)?1:0},middle:function(e,t,i){return this.contains(i,[t.left+.5*t.width,t.top+.5*t.height])?1:0}},sort:function(e,t){return t.winner-e.winner||e.index-t.index},tolerate:function(n){var r,s,a,o,l,c,u,h,p=0,d=n.interactions.length,f=[i.event.pageX,i.event.pageY],m=i.tolerance||i.modes[i.mode];do{if(h=n.interactions[p]){if(!h)return;h.drop=[];l=[];c=h.droppable.length;m&&(a=i.locate(h.proxy));r=0;do{if(u=h.droppable[r]){if(!(s=(o=e.data(u,i.datakey)).location))continue;o.winner=m?m.call(i,i.event,a,s):i.contains(s,f)?1:0;l.push(o)}}while(++r<c);l.sort(i.sort);r=0;do{if(o=l[r])if(o.winner&&h.drop.length<i.multi){if(!o.active[p]&&!o.anyactive)if(!1!==t.drag.hijack(i.event,"dropstart",n,p,o.elem)[0]){o.active[p]=1;o.anyactive+=1}else o.winner=0;o.winner&&h.drop.push(o.elem)}else if(o.active[p]&&1==o.anyactive){t.drag.hijack(i.event,"dropend",n,p,o.elem);o.active[p]=0;o.anyactive-=1}}while(++r<c)}}while(++p<d);i.last&&f[0]==i.last.pageX&&f[1]==i.last.pageY?delete i.timer:i.timer=setTimeout(function(){i.tolerate(n)},i.delay);i.last=i.event}};t.dropinit=t.dropstart=t.dropend=i}(jQuery);!function(e,t){e.fn.track=function(i){var n=e.extend({properties:null,interval:100,id:"_watcher",watchChildren:!1,callback:null},i);return this.each(function(){var i=this,s=e(this),a={id:n.id,props:n.properties.split(","),vals:[n.properties.split(",").length],func:n.callback,fnc:function(s,a){(function(i){var n=e(this),s=n.data(i);if(s&&s.func){for(var a=!1,o=0;o<s.props.length;o++){var l=s.props[o],c="";if((c=l.startsWith("attr_")?n.attr(l.replace("attr_","")):n.css(l))!=t&&s.vals[o]!=c){s.vals[o]=c;a=!0;break}}if(a){n.untrack(i);s.func.call(this,s,o);r(n,i,s)}}}).call(i,n.id)},origProps:n.properties,interval:n.interval,intervalId:null};e.each(a.props,function(e){a.vals[e]=s.css(a.props[e])});s.data(n.id,a);r(s,n.id,a)});function r(t,i,r){t.each(function(){var t=e(this);if(window.MutationObserver){var i=t.data("__watcherObserver");if(null==i){i=new MutationObserver(r.fnc);t.data("__watcherObserver",i)}i.observe(this,{attributes:!0,subtree:n.watchChildren,childList:n.watchChildren,characterData:!0})}else r.intervalId=setInterval(r.fnc,interval)})}};e.fn.untrack=function(t){this.each(function(){var i=e(this),n=i.data(t);try{if(window.MutationObserver){var r=i.data("__watcherObserver");if(r){r.disconnect();i.removeData("__watcherObserver")}}else clearInterval(n.intervalId)}catch(e){}});return this};String.prototype.startsWith=function(e){return 0!=this.length&&e==this.substr(0,e.length)}}(jQuery,void 0);!function(){function e(e){this.mode=o.MODE_8BIT_BYTE,this.data=e,this.parsedData=[];for(var t=[],i=0,n=this.data.length;n>i;i++){var r=this.data.charCodeAt(i);r>65536?(t[0]=240|(1835008&r)>>>18,t[1]=128|(258048&r)>>>12,t[2]=128|(4032&r)>>>6,t[3]=128|63&r):r>2048?(t[0]=224|(61440&r)>>>12,t[1]=128|(4032&r)>>>6,t[2]=128|63&r):r>128?(t[0]=192|(1984&r)>>>6,t[1]=128|63&r):t[0]=r,this.parsedData=this.parsedData.concat(t)}this.parsedData.length!=this.data.length&&(this.parsedData.unshift(191),this.parsedData.unshift(187),this.parsedData.unshift(239))}function t(e,t){this.typeNumber=e,this.errorCorrectLevel=t,this.modules=null,this.moduleCount=0,this.dataCache=null,this.dataList=[]}function i(e,t){if(void 0==e.length)throw new Error(e.length+"/"+t);for(var i=0;i<e.length&&0==e[i];)i++;this.num=new Array(e.length-i+t);for(var n=0;n<e.length-i;n++)this.num[n]=e[n+i]}function n(e,t){this.totalCount=e,this.dataCount=t}function r(){this.buffer=[],this.length=0}function s(){var e=!1,t=navigator.userAgent;return/android/i.test(t)&&(e=!0,aMat=t.toString().match(/android ([0-9]\.[0-9])/i),aMat&&aMat[1]&&(e=parseFloat(aMat[1]))),e}function a(e,t){for(var i=1,n=function(e){var t=encodeURI(e).toString().replace(/\%[0-9a-fA-F]{2}/g,"a");return t.length+(t.length!=e?3:0)}(e),r=0,s=d.length;s>=r;r++){var a=0;switch(t){case l.L:a=d[r][0];break;case l.M:a=d[r][1];break;case l.Q:a=d[r][2];break;case l.H:a=d[r][3]}if(a>=n)break;i++}if(i>d.length)throw new Error("Too long data");return i}e.prototype={getLength:function(){return this.parsedData.length},write:function(e){for(var t=0,i=this.parsedData.length;i>t;t++)e.put(this.parsedData[t],8)}},t.prototype={addData:function(t){var i=new e(t);this.dataList.push(i),this.dataCache=null},isDark:function(e,t){if(0>e||this.moduleCount<=e||0>t||this.moduleCount<=t)throw new Error(e+","+t);return this.modules[e][t]},getModuleCount:function(){return this.moduleCount},make:function(){this.makeImpl(!1,this.getBestMaskPattern())},makeImpl:function(e,i){this.moduleCount=4*this.typeNumber+17,this.modules=new Array(this.moduleCount);for(var n=0;n<this.moduleCount;n++){this.modules[n]=new Array(this.moduleCount);for(var r=0;r<this.moduleCount;r++)this.modules[n][r]=null}this.setupPositionProbePattern(0,0),this.setupPositionProbePattern(this.moduleCount-7,0),this.setupPositionProbePattern(0,this.moduleCount-7),this.setupPositionAdjustPattern(),this.setupTimingPattern(),this.setupTypeInfo(e,i),this.typeNumber>=7&&this.setupTypeNumber(e),null==this.dataCache&&(this.dataCache=t.createData(this.typeNumber,this.errorCorrectLevel,this.dataList)),this.mapData(this.dataCache,i)},setupPositionProbePattern:function(e,t){for(var i=-1;7>=i;i++)if(!(-1>=e+i||this.moduleCount<=e+i))for(var n=-1;7>=n;n++)-1>=t+n||this.moduleCount<=t+n||(this.modules[e+i][t+n]=i>=0&&6>=i&&(0==n||6==n)||n>=0&&6>=n&&(0==i||6==i)||i>=2&&4>=i&&n>=2&&4>=n)},getBestMaskPattern:function(){for(var e=0,t=0,i=0;8>i;i++){this.makeImpl(!0,i);var n=u.getLostPoint(this);(0==i||e>n)&&(e=n,t=i)}return t},createMovieClip:function(e,t,i){var n=e.createEmptyMovieClip(t,i);this.make();for(var r=0;r<this.modules.length;r++)for(var s=1*r,a=0;a<this.modules[r].length;a++){var o=1*a;this.modules[r][a]&&(n.beginFill(0,100),n.moveTo(o,s),n.lineTo(o+1,s),n.lineTo(o+1,s+1),n.lineTo(o,s+1),n.endFill())}return n},setupTimingPattern:function(){for(var e=8;e<this.moduleCount-8;e++)null==this.modules[e][6]&&(this.modules[e][6]=0==e%2);for(var t=8;t<this.moduleCount-8;t++)null==this.modules[6][t]&&(this.modules[6][t]=0==t%2)},setupPositionAdjustPattern:function(){for(var e=u.getPatternPosition(this.typeNumber),t=0;t<e.length;t++)for(var i=0;i<e.length;i++){var n=e[t],r=e[i];if(null==this.modules[n][r])for(var s=-2;2>=s;s++)for(var a=-2;2>=a;a++)this.modules[n+s][r+a]=-2==s||2==s||-2==a||2==a||0==s&&0==a}},setupTypeNumber:function(e){for(var t=u.getBCHTypeNumber(this.typeNumber),i=0;18>i;i++){var n=!e&&1==(1&t>>i);this.modules[Math.floor(i/3)][i%3+this.moduleCount-8-3]=n}for(i=0;18>i;i++){n=!e&&1==(1&t>>i);this.modules[i%3+this.moduleCount-8-3][Math.floor(i/3)]=n}},setupTypeInfo:function(e,t){for(var i=this.errorCorrectLevel<<3|t,n=u.getBCHTypeInfo(i),r=0;15>r;r++){var s=!e&&1==(1&n>>r);6>r?this.modules[r][8]=s:8>r?this.modules[r+1][8]=s:this.modules[this.moduleCount-15+r][8]=s}for(r=0;15>r;r++){s=!e&&1==(1&n>>r);8>r?this.modules[8][this.moduleCount-r-1]=s:9>r?this.modules[8][15-r-1+1]=s:this.modules[8][15-r-1]=s}this.modules[this.moduleCount-8][8]=!e},mapData:function(e,t){for(var i=-1,n=this.moduleCount-1,r=7,s=0,a=this.moduleCount-1;a>0;a-=2)for(6==a&&a--;;){for(var o=0;2>o;o++)if(null==this.modules[n][a-o]){var l=!1;s<e.length&&(l=1==(1&e[s]>>>r));u.getMask(t,n,a-o)&&(l=!l),this.modules[n][a-o]=l,-1==--r&&(s++,r=7)}if(0>(n+=i)||this.moduleCount<=n){n-=i,i=-i;break}}}},t.PAD0=236,t.PAD1=17,t.createData=function(e,i,s){for(var a=n.getRSBlocks(e,i),o=new r,l=0;l<s.length;l++){var c=s[l];o.put(c.mode,4),o.put(c.getLength(),u.getLengthInBits(c.mode,e)),c.write(o)}var h=0;for(l=0;l<a.length;l++)h+=a[l].dataCount;if(o.getLengthInBits()>8*h)throw new Error("code length overflow. ("+o.getLengthInBits()+">"+8*h+")");for(o.getLengthInBits()+4<=8*h&&o.put(0,4);0!=o.getLengthInBits()%8;)o.putBit(!1);for(;!(o.getLengthInBits()>=8*h)&&(o.put(t.PAD0,8),!(o.getLengthInBits()>=8*h));)o.put(t.PAD1,8);return t.createBytes(o,a)},t.createBytes=function(e,t){for(var n=0,r=0,s=0,a=new Array(t.length),o=new Array(t.length),l=0;l<t.length;l++){var c=t[l].dataCount,h=t[l].totalCount-c;r=Math.max(r,c),s=Math.max(s,h),a[l]=new Array(c);for(var p=0;p<a[l].length;p++)a[l][p]=255&e.buffer[p+n];n+=c;var d=u.getErrorCorrectPolynomial(h),f=new i(a[l],d.getLength()-1).mod(d);o[l]=new Array(d.getLength()-1);for(p=0;p<o[l].length;p++){var m=p+f.getLength()-o[l].length;o[l][p]=m>=0?f.get(m):0}}var y=0;for(p=0;p<t.length;p++)y+=t[p].totalCount;var g=new Array(y),C=0;for(p=0;r>p;p++)for(l=0;l<t.length;l++)p<a[l].length&&(g[C++]=a[l][p]);for(p=0;s>p;p++)for(l=0;l<t.length;l++)p<o[l].length&&(g[C++]=o[l][p]);return g};for(var o={MODE_NUMBER:1,MODE_ALPHA_NUM:2,MODE_8BIT_BYTE:4,MODE_KANJI:8},l={L:1,M:0,Q:3,H:2},c={PATTERN000:0,PATTERN001:1,PATTERN010:2,PATTERN011:3,PATTERN100:4,PATTERN101:5,PATTERN110:6,PATTERN111:7},u={PATTERN_POSITION_TABLE:[[],[6,18],[6,22],[6,26],[6,30],[6,34],[6,22,38],[6,24,42],[6,26,46],[6,28,50],[6,30,54],[6,32,58],[6,34,62],[6,26,46,66],[6,26,48,70],[6,26,50,74],[6,30,54,78],[6,30,56,82],[6,30,58,86],[6,34,62,90],[6,28,50,72,94],[6,26,50,74,98],[6,30,54,78,102],[6,28,54,80,106],[6,32,58,84,110],[6,30,58,86,114],[6,34,62,90,118],[6,26,50,74,98,122],[6,30,54,78,102,126],[6,26,52,78,104,130],[6,30,56,82,108,134],[6,34,60,86,112,138],[6,30,58,86,114,142],[6,34,62,90,118,146],[6,30,54,78,102,126,150],[6,24,50,76,102,128,154],[6,28,54,80,106,132,158],[6,32,58,84,110,136,162],[6,26,54,82,110,138,166],[6,30,58,86,114,142,170]],G15:1335,G18:7973,G15_MASK:21522,getBCHTypeInfo:function(e){for(var t=e<<10;u.getBCHDigit(t)-u.getBCHDigit(u.G15)>=0;)t^=u.G15<<u.getBCHDigit(t)-u.getBCHDigit(u.G15);return(e<<10|t)^u.G15_MASK},getBCHTypeNumber:function(e){for(var t=e<<12;u.getBCHDigit(t)-u.getBCHDigit(u.G18)>=0;)t^=u.G18<<u.getBCHDigit(t)-u.getBCHDigit(u.G18);return e<<12|t},getBCHDigit:function(e){for(var t=0;0!=e;)t++,e>>>=1;return t},getPatternPosition:function(e){return u.PATTERN_POSITION_TABLE[e-1]},getMask:function(e,t,i){switch(e){case c.PATTERN000:return 0==(t+i)%2;case c.PATTERN001:return 0==t%2;case c.PATTERN010:return 0==i%3;case c.PATTERN011:return 0==(t+i)%3;case c.PATTERN100:return 0==(Math.floor(t/2)+Math.floor(i/3))%2;case c.PATTERN101:return 0==t*i%2+t*i%3;case c.PATTERN110:return 0==(t*i%2+t*i%3)%2;case c.PATTERN111:return 0==(t*i%3+(t+i)%2)%2;default:throw new Error("bad maskPattern:"+e)}},getErrorCorrectPolynomial:function(e){for(var t=new i([1],0),n=0;e>n;n++)t=t.multiply(new i([1,h.gexp(n)],0));return t},getLengthInBits:function(e,t){if(t>=1&&10>t)switch(e){case o.MODE_NUMBER:return 10;case o.MODE_ALPHA_NUM:return 9;case o.MODE_8BIT_BYTE:case o.MODE_KANJI:return 8;default:throw new Error("mode:"+e)}else if(27>t)switch(e){case o.MODE_NUMBER:return 12;case o.MODE_ALPHA_NUM:return 11;case o.MODE_8BIT_BYTE:return 16;case o.MODE_KANJI:return 10;default:throw new Error("mode:"+e)}else{if(!(41>t))throw new Error("type:"+t);switch(e){case o.MODE_NUMBER:return 14;case o.MODE_ALPHA_NUM:return 13;case o.MODE_8BIT_BYTE:return 16;case o.MODE_KANJI:return 12;default:throw new Error("mode:"+e)}}},getLostPoint:function(e){for(var t=e.getModuleCount(),i=0,n=0;t>n;n++)for(var r=0;t>r;r++){for(var s=0,a=e.isDark(n,r),o=-1;1>=o;o++)if(!(0>n+o||n+o>=t))for(var l=-1;1>=l;l++)0>r+l||r+l>=t||(0!=o||0!=l)&&a==e.isDark(n+o,r+l)&&s++;s>5&&(i+=3+s-5)}for(n=0;t-1>n;n++)for(r=0;t-1>r;r++){var c=0;e.isDark(n,r)&&c++,e.isDark(n+1,r)&&c++,e.isDark(n,r+1)&&c++,e.isDark(n+1,r+1)&&c++,(0==c||4==c)&&(i+=3)}for(n=0;t>n;n++)for(r=0;t-6>r;r++)e.isDark(n,r)&&!e.isDark(n,r+1)&&e.isDark(n,r+2)&&e.isDark(n,r+3)&&e.isDark(n,r+4)&&!e.isDark(n,r+5)&&e.isDark(n,r+6)&&(i+=40);for(r=0;t>r;r++)for(n=0;t-6>n;n++)e.isDark(n,r)&&!e.isDark(n+1,r)&&e.isDark(n+2,r)&&e.isDark(n+3,r)&&e.isDark(n+4,r)&&!e.isDark(n+5,r)&&e.isDark(n+6,r)&&(i+=40);var u=0;for(r=0;t>r;r++)for(n=0;t>n;n++)e.isDark(n,r)&&u++;return i+10*(Math.abs(100*u/t/t-50)/5)}},h={glog:function(e){if(1>e)throw new Error("glog("+e+")");return h.LOG_TABLE[e]},gexp:function(e){for(;0>e;)e+=255;for(;e>=256;)e-=255;return h.EXP_TABLE[e]},EXP_TABLE:new Array(256),LOG_TABLE:new Array(256)},p=0;8>p;p++)h.EXP_TABLE[p]=1<<p;for(p=8;256>p;p++)h.EXP_TABLE[p]=h.EXP_TABLE[p-4]^h.EXP_TABLE[p-5]^h.EXP_TABLE[p-6]^h.EXP_TABLE[p-8];for(p=0;255>p;p++)h.LOG_TABLE[h.EXP_TABLE[p]]=p;i.prototype={get:function(e){return this.num[e]},getLength:function(){return this.num.length},multiply:function(e){for(var t=new Array(this.getLength()+e.getLength()-1),n=0;n<this.getLength();n++)for(var r=0;r<e.getLength();r++)t[n+r]^=h.gexp(h.glog(this.get(n))+h.glog(e.get(r)));return new i(t,0)},mod:function(e){if(this.getLength()-e.getLength()<0)return this;for(var t=h.glog(this.get(0))-h.glog(e.get(0)),n=new Array(this.getLength()),r=0;r<this.getLength();r++)n[r]=this.get(r);for(r=0;r<e.getLength();r++)n[r]^=h.gexp(h.glog(e.get(r))+t);return new i(n,0).mod(e)}},n.RS_BLOCK_TABLE=[[1,26,19],[1,26,16],[1,26,13],[1,26,9],[1,44,34],[1,44,28],[1,44,22],[1,44,16],[1,70,55],[1,70,44],[2,35,17],[2,35,13],[1,100,80],[2,50,32],[2,50,24],[4,25,9],[1,134,108],[2,67,43],[2,33,15,2,34,16],[2,33,11,2,34,12],[2,86,68],[4,43,27],[4,43,19],[4,43,15],[2,98,78],[4,49,31],[2,32,14,4,33,15],[4,39,13,1,40,14],[2,121,97],[2,60,38,2,61,39],[4,40,18,2,41,19],[4,40,14,2,41,15],[2,146,116],[3,58,36,2,59,37],[4,36,16,4,37,17],[4,36,12,4,37,13],[2,86,68,2,87,69],[4,69,43,1,70,44],[6,43,19,2,44,20],[6,43,15,2,44,16],[4,101,81],[1,80,50,4,81,51],[4,50,22,4,51,23],[3,36,12,8,37,13],[2,116,92,2,117,93],[6,58,36,2,59,37],[4,46,20,6,47,21],[7,42,14,4,43,15],[4,133,107],[8,59,37,1,60,38],[8,44,20,4,45,21],[12,33,11,4,34,12],[3,145,115,1,146,116],[4,64,40,5,65,41],[11,36,16,5,37,17],[11,36,12,5,37,13],[5,109,87,1,110,88],[5,65,41,5,66,42],[5,54,24,7,55,25],[11,36,12],[5,122,98,1,123,99],[7,73,45,3,74,46],[15,43,19,2,44,20],[3,45,15,13,46,16],[1,135,107,5,136,108],[10,74,46,1,75,47],[1,50,22,15,51,23],[2,42,14,17,43,15],[5,150,120,1,151,121],[9,69,43,4,70,44],[17,50,22,1,51,23],[2,42,14,19,43,15],[3,141,113,4,142,114],[3,70,44,11,71,45],[17,47,21,4,48,22],[9,39,13,16,40,14],[3,135,107,5,136,108],[3,67,41,13,68,42],[15,54,24,5,55,25],[15,43,15,10,44,16],[4,144,116,4,145,117],[17,68,42],[17,50,22,6,51,23],[19,46,16,6,47,17],[2,139,111,7,140,112],[17,74,46],[7,54,24,16,55,25],[34,37,13],[4,151,121,5,152,122],[4,75,47,14,76,48],[11,54,24,14,55,25],[16,45,15,14,46,16],[6,147,117,4,148,118],[6,73,45,14,74,46],[11,54,24,16,55,25],[30,46,16,2,47,17],[8,132,106,4,133,107],[8,75,47,13,76,48],[7,54,24,22,55,25],[22,45,15,13,46,16],[10,142,114,2,143,115],[19,74,46,4,75,47],[28,50,22,6,51,23],[33,46,16,4,47,17],[8,152,122,4,153,123],[22,73,45,3,74,46],[8,53,23,26,54,24],[12,45,15,28,46,16],[3,147,117,10,148,118],[3,73,45,23,74,46],[4,54,24,31,55,25],[11,45,15,31,46,16],[7,146,116,7,147,117],[21,73,45,7,74,46],[1,53,23,37,54,24],[19,45,15,26,46,16],[5,145,115,10,146,116],[19,75,47,10,76,48],[15,54,24,25,55,25],[23,45,15,25,46,16],[13,145,115,3,146,116],[2,74,46,29,75,47],[42,54,24,1,55,25],[23,45,15,28,46,16],[17,145,115],[10,74,46,23,75,47],[10,54,24,35,55,25],[19,45,15,35,46,16],[17,145,115,1,146,116],[14,74,46,21,75,47],[29,54,24,19,55,25],[11,45,15,46,46,16],[13,145,115,6,146,116],[14,74,46,23,75,47],[44,54,24,7,55,25],[59,46,16,1,47,17],[12,151,121,7,152,122],[12,75,47,26,76,48],[39,54,24,14,55,25],[22,45,15,41,46,16],[6,151,121,14,152,122],[6,75,47,34,76,48],[46,54,24,10,55,25],[2,45,15,64,46,16],[17,152,122,4,153,123],[29,74,46,14,75,47],[49,54,24,10,55,25],[24,45,15,46,46,16],[4,152,122,18,153,123],[13,74,46,32,75,47],[48,54,24,14,55,25],[42,45,15,32,46,16],[20,147,117,4,148,118],[40,75,47,7,76,48],[43,54,24,22,55,25],[10,45,15,67,46,16],[19,148,118,6,149,119],[18,75,47,31,76,48],[34,54,24,34,55,25],[20,45,15,61,46,16]],n.getRSBlocks=function(e,t){var i=n.getRsBlockTable(e,t);if(void 0==i)throw new Error("bad rs block @ typeNumber:"+e+"/errorCorrectLevel:"+t);for(var r=i.length/3,s=[],a=0;r>a;a++)for(var o=i[3*a+0],l=i[3*a+1],c=i[3*a+2],u=0;o>u;u++)s.push(new n(l,c));return s},n.getRsBlockTable=function(e,t){switch(t){case l.L:return n.RS_BLOCK_TABLE[4*(e-1)+0];case l.M:return n.RS_BLOCK_TABLE[4*(e-1)+1];case l.Q:return n.RS_BLOCK_TABLE[4*(e-1)+2];case l.H:return n.RS_BLOCK_TABLE[4*(e-1)+3];default:return}},r.prototype={get:function(e){var t=Math.floor(e/8);return 1==(1&this.buffer[t]>>>7-e%8)},put:function(e,t){for(var i=0;t>i;i++)this.putBit(1==(1&e>>>t-i-1))},getLengthInBits:function(){return this.length},putBit:function(e){var t=Math.floor(this.length/8);this.buffer.length<=t&&this.buffer.push(0),e&&(this.buffer[t]|=128>>>this.length%8),this.length++}};var d=[[17,14,11,7],[32,26,20,14],[53,42,32,24],[78,62,46,34],[106,84,60,44],[134,106,74,58],[154,122,86,64],[192,152,108,84],[230,180,130,98],[271,213,151,119],[321,251,177,137],[367,287,203,155],[425,331,241,177],[458,362,258,194],[520,412,292,220],[586,450,322,250],[644,504,364,280],[718,560,394,310],[792,624,442,338],[858,666,482,382],[929,711,509,403],[1003,779,565,439],[1091,857,611,461],[1171,911,661,511],[1273,997,715,535],[1367,1059,751,593],[1465,1125,805,625],[1528,1190,868,658],[1628,1264,908,698],[1732,1370,982,742],[1840,1452,1030,790],[1952,1538,1112,842],[2068,1628,1168,898],[2188,1722,1228,958],[2303,1809,1283,983],[2431,1911,1351,1051],[2563,1989,1423,1093],[2699,2099,1499,1139],[2809,2213,1579,1219],[2953,2331,1663,1273]],f=function(){var e=function(e,t){this._el=e,this._htOption=t};return e.prototype.draw=function(e){function t(e,t){var i=document.createElementNS("http://www.w3.org/2000/svg",e);for(var n in t)t.hasOwnProperty(n)&&i.setAttribute(n,t[n]);return i}var i=this._htOption,n=this._el,r=e.getModuleCount();Math.floor(i.width/r),Math.floor(i.height/r),this.clear();var s=t("svg",{viewBox:"0 0 "+String(r)+" "+String(r),width:"100%",height:"100%",fill:i.colorLight});s.setAttributeNS("http://www.w3.org/2000/xmlns/","xmlns:xlink","http://www.w3.org/1999/xlink"),n.appendChild(s),s.appendChild(t("rect",{fill:i.colorDark,width:"1",height:"1",id:"template"}));for(var a=0;r>a;a++)for(var o=0;r>o;o++)if(e.isDark(a,o)){var l=t("use",{x:String(a),y:String(o)});l.setAttributeNS("http://www.w3.org/1999/xlink","href","#template"),s.appendChild(l)}},e.prototype.clear=function(){for(;this._el.hasChildNodes();)this._el.removeChild(this._el.lastChild)},e}(),m="svg"===document.documentElement.tagName.toLowerCase()?f:"undefined"!=typeof CanvasRenderingContext2D?function(){function e(){this._elImage.src=this._elCanvas.toDataURL("image/png"),this._elImage.style.display="block",this._elCanvas.style.display="none"}if(this._android&&this._android<=2.1){var t=1/window.devicePixelRatio,i=CanvasRenderingContext2D.prototype.drawImage;CanvasRenderingContext2D.prototype.drawImage=function(e,n,r,s,a,o,l,c){if("nodeName"in e&&/img/i.test(e.nodeName))for(var u=arguments.length-1;u>=1;u--)arguments[u]=arguments[u]*t;else void 0===c&&(arguments[1]*=t,arguments[2]*=t,arguments[3]*=t,arguments[4]*=t);i.apply(this,arguments)}}var n=function(e,t){this._bIsPainted=!1,this._android=s(),this._htOption=t,this._elCanvas=document.createElement("canvas"),this._elCanvas.width=t.width,this._elCanvas.height=t.height,e.appendChild(this._elCanvas),this._el=e,this._oContext=this._elCanvas.getContext("2d"),this._bIsPainted=!1,this._elImage=document.createElement("img"),this._elImage.style.display="none",this._el.appendChild(this._elImage),this._bSupportDataURI=null};return n.prototype.draw=function(e){var t=this._elImage,i=this._oContext,n=this._htOption,r=e.getModuleCount(),s=n.width/r,a=n.height/r,o=Math.round(s),l=Math.round(a);t.style.display="none",this.clear();for(var c=0;r>c;c++)for(var u=0;r>u;u++){var h=e.isDark(c,u),p=u*s,d=c*a;i.strokeStyle=h?n.colorDark:n.colorLight,i.lineWidth=1,i.fillStyle=h?n.colorDark:n.colorLight,i.fillRect(p,d,s,a),i.strokeRect(Math.floor(p)+.5,Math.floor(d)+.5,o,l),i.strokeRect(Math.ceil(p)-.5,Math.ceil(d)-.5,o,l)}this._bIsPainted=!0},n.prototype.makeImage=function(){this._bIsPainted&&function(e,t){var i=this;if(i._fFail=t,i._fSuccess=e,null===i._bSupportDataURI){var n=document.createElement("img"),r=function(){i._bSupportDataURI=!1,i._fFail&&_fFail.call(i)};return n.onabort=r,n.onerror=r,n.onload=function(){i._bSupportDataURI=!0,i._fSuccess&&i._fSuccess.call(i)},void(n.src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAAFCAYAAACNbyblAAAAHElEQVQI12P4//8/w38GIAXDIBKE0DHxgljNBAAO9TXL0Y4OHwAAAABJRU5ErkJggg==")}!0===i._bSupportDataURI&&i._fSuccess?i._fSuccess.call(i):!1===i._bSupportDataURI&&i._fFail&&i._fFail.call(i)}.call(this,e)},n.prototype.isPainted=function(){return this._bIsPainted},n.prototype.clear=function(){this._oContext.clearRect(0,0,this._elCanvas.width,this._elCanvas.height),this._bIsPainted=!1},n.prototype.round=function(e){return e?Math.floor(1e3*e)/1e3:e},n}():function(){var e=function(e,t){this._el=e,this._htOption=t};return e.prototype.draw=function(e){for(var t=this._htOption,i=this._el,n=e.getModuleCount(),r=Math.floor(t.width/n),s=Math.floor(t.height/n),a=['<table style="border:0;border-collapse:collapse;">'],o=0;n>o;o++){a.push("<tr>");for(var l=0;n>l;l++)a.push('<td style="border:0;border-collapse:collapse;padding:0;margin:0;width:'+r+"px;height:"+s+"px;background-color:"+(e.isDark(o,l)?t.colorDark:t.colorLight)+';"></td>');a.push("</tr>")}a.push("</table>"),i.innerHTML=a.join("");var c=i.childNodes[0],u=(t.width-c.offsetWidth)/2,h=(t.height-c.offsetHeight)/2;u>0&&h>0&&(c.style.margin=h+"px "+u+"px")},e.prototype.clear=function(){this._el.innerHTML=""},e}();(QRCode=function(e,t){if(this._htOption={width:256,height:256,typeNumber:4,colorDark:"#000000",colorLight:"#ffffff",correctLevel:l.H},"string"==typeof t&&(t={text:t}),t)for(var i in t)this._htOption[i]=t[i];"string"==typeof e&&(e=document.getElementById(e)),this._android=s(),this._el=e,this._oQRCode=null,this._oDrawing=new m(this._el,this._htOption),this._htOption.text&&this.makeCode(this._htOption.text)}).prototype.makeCode=function(e){this._oQRCode=new t(a(e,this._htOption.correctLevel),this._htOption.correctLevel),this._oQRCode.addData(e),this._oQRCode.make(),this._el.title=e,this._oDrawing.draw(this._oQRCode),this.makeImage()},QRCode.prototype.makeImage=function(){"function"==typeof this._oDrawing.makeImage&&(!this._android||this._android>=3)&&this._oDrawing.makeImage()},QRCode.prototype.clear=function(){this._oDrawing.clear()},QRCode.CorrectLevel=l}();(void 0!==define&&define.amd?define:function(e,t){var i,n=t();if(void 0!==exports)for(i in n)exports[i]=n[i];else window.jsonpack=n})([],function(){var e=-4,t=function(e){return"string"!=typeof e?e:e.replace(/[\+ \|\^\%]/g,function(e){return{" ":"+","+":"%2B","|":"%7C","^":"%5E","%":"%25"}[e]})},i=function(e){return"string"!=typeof e?e:e.replace(/\+|%2B|%7C|%5E|%25/g,function(e){return{"+":" ","%2B":"+","%7C":"|","%5E":"^","%25":"%"}[e]})},n=function(e){return Number.prototype.toString.call(e,36).toUpperCase()},r=function(e){return parseInt(e,36)},s=Array.prototype.indexOf||function(e,t){for(var i=t||0,n=this.length;i<n;i++)if(this[i]===e)return i;return-1};return{JSON:JSON,pack:function(i,r){var a,o,l;(a=(r=r||{}).verbose||!1)&&console.log("Normalize the JSON Object");i="string"==typeof i?this.JSON.parse(i):i;a&&console.log("Creating a empty dictionary");o={strings:[],integers:[],floats:[]};a&&console.log("Creating the AST");var c=function i(r){var l,c,u,h,p;if(a&&console.log("Calling recursiveAstBuilder with "+this.JSON.stringify(r)),l=typeof r,null===r)return{type:"null",index:-3};if(void 0===r)return{type:"undefined",index:-5};if(r instanceof Array){u=["@"];for(c in r)r.hasOwnProperty(c)&&u.push(i(r[c]));return u}if("object"===l){u=["$"];for(h in r)r.hasOwnProperty(h)&&(u.push(i(h)),u.push(i(r[h])));return u}if(""===r)return{type:"empty",index:e};if("string"===l)return-1==(p=s.call(o.strings,r))&&(o.strings.push(t(r)),p=o.strings.length-1),{type:"strings",index:p};if("number"===l&&r%1==0)return-1==(p=s.call(o.integers,r))&&(o.integers.push(n(r)),p=o.integers.length-1),{type:"integers",index:p};if("number"===l)return-1==(p=s.call(o.floats,r))&&(o.floats.push(r),p=o.floats.length-1),{type:"floats",index:p};if("boolean"===l)return{type:"boolean",index:r?-1:-2};throw new Error("Unexpected argument of type "+typeof r)}(i),u=o.strings.length,h=o.integers.length;o.floats.length;return a&&console.log("Parsing the dictionary"),l=o.strings.join("|"),l+="^"+o.integers.join("|"),l+="^"+o.floats.join("|"),a&&console.log("Parsing the structure"),l+="^"+function t(i){var r,s,o,l;if(a&&console.log("Calling a recursiveParser with "+this.JSON.stringify(i)),i instanceof Array){r=i.shift();for(s in i)i.hasOwnProperty(s)&&(r+=t(i[s])+"|");return("|"===r[r.length-1]?r.slice(0,-1):r)+"]"}if(o=i.type,l=i.index,"strings"===o)return n(l);if("integers"===o)return n(u+l);if("floats"===o)return n(u+h+l);if("boolean"===o)return i.index;if("null"===o)return-3;if("undefined"===o)return-5;if("empty"===o)return e;throw new TypeError("The item is alien!")}(c),a&&console.log("Ending parser"),r.debug?{dictionary:o,ast:c,packed:l}:l},unpack:function(t,n){var s,a,o,l,c,u,h,p;if(n=n||{},s=t.split("^"),n.verbose&&console.log("Building dictionary"),a=[],""!==(o=s[0]))for(o=o.split("|"),n.verbose&&console.log("Parse the strings dictionary"),c=0,l=o.length;c<l;c++)a.push(i(o[c]));if(""!==(o=s[1]))for(o=o.split("|"),n.verbose&&console.log("Parse the integers dictionary"),c=0,l=o.length;c<l;c++)a.push(r(o[c]));if(""!==(o=s[2]))for(o=o.split("|"),n.verbose&&console.log("Parse the floats dictionary"),c=0,l=o.length;c<l;c++)a.push(parseFloat(o[c]));o=null;n.verbose&&console.log("Tokenizing the structure");var d="",f=[],m=s[3].length;for(c=0;c<m;c++)"|"===(u=s[3].charAt(c))||"$"===u||"@"===u||"]"===u?(d&&(f.push(r(d)),d=""),"|"!==u&&f.push(u)):d+=u;return h=f.length,p=0,n.verbose&&console.log("Starting recursive parser"),function t(){var i,r,s,o=f[p++];if(n.verbose&&console.log("Reading collection type "+("$"===o?"object":"Array")),"@"===o){for(i=[];p<h;p++){if(s=f[p],n.verbose&&console.log("Read "+s+" symbol"),"]"===s)return i;if("@"===s||"$"===s)i.push(t());else switch(s){case-1:i.push(!0);break;case-2:i.push(!1);break;case-3:i.push(null);break;case-5:i.push(void 0);break;case e:i.push("");break;default:i.push(a[s])}}return n.verbose&&console.log("Parsed "+this.JSON.stringify(i)),i}if("$"===o){for(i={};p<h;p++){if("]"===(r=f[p]))return i;if(r=r===e?"":a[r],"@"===(s=f[++p])||"$"===s)i[r]=t();else switch(s){case-1:i[r]=!0;break;case-2:i[r]=!1;break;case-3:i[r]=null;break;case-5:i[r]=void 0;break;case e:i[r]="";break;default:i[r]=a[s]}}return n.verbose&&console.log("Parsed "+this.JSON.stringify(i)),i}throw new TypeError("Bad token "+o+" isn't a type")}()}}});!function(e,t){"use strict";var i="model",n="name",r="type",s="vendor",a="version",o="mobile",l="tablet",c={extend:function(e,t){var i={};for(var n in e)t[n]&&t[n].length%2==0?i[n]=t[n].concat(e[n]):i[n]=e[n];return i},has:function(e,t){return"string"==typeof e&&-1!==t.toLowerCase().indexOf(e.toLowerCase())},lowerize:function(e){return e.toLowerCase()},major:function(e){return"string"==typeof e?e.replace(/[^\d\.]/g,"").split(".")[0]:void 0},trim:function(e){return e.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")}},u={rgx:function(e,t){for(var i,n,r,s,a,o,l=0;l<t.length&&!a;){var c=t[l],u=t[l+1];i=n=0;for(;i<c.length&&!a;)if(a=c[i++].exec(e))for(r=0;r<u.length;r++){o=a[++n];"object"==typeof(s=u[r])&&s.length>0?2==s.length?"function"==typeof s[1]?this[s[0]]=s[1].call(this,o):this[s[0]]=s[1]:3==s.length?"function"!=typeof s[1]||s[1].exec&&s[1].test?this[s[0]]=o?o.replace(s[1],s[2]):void 0:this[s[0]]=o?s[1].call(this,o,s[2]):void 0:4==s.length&&(this[s[0]]=o?s[3].call(this,o.replace(s[1],s[2])):void 0):this[s]=o||void 0}l+=2}},str:function(e,t){for(var i in t)if("object"==typeof t[i]&&t[i].length>0){for(var n=0;n<t[i].length;n++)if(c.has(t[i][n],e))return"?"===i?void 0:i}else if(c.has(t[i],e))return"?"===i?void 0:i;return e}},h={browser:{oldsafari:{version:{"1.0":"/8",1.2:"/1",1.3:"/3","2.0":"/412","2.0.2":"/416","2.0.3":"/417","2.0.4":"/419","?":"/"}}},device:{amazon:{model:{"Fire Phone":["SD","KF"]}},sprint:{model:{"Evo Shift 4G":"7373KT"},vendor:{HTC:"APA",Sprint:"Sprint"}}},os:{windows:{version:{ME:"4.90","NT 3.11":"NT3.51","NT 4.0":"NT4.0",2000:"NT 5.0",XP:["NT 5.1","NT 5.2"],Vista:"NT 6.0",7:"NT 6.1",8:"NT 6.2",8.1:"NT 6.3",10:["NT 6.4","NT 10.0"],RT:"ARM"}}}},p={browser:[[/(opera\smini)\/([\w\.-]+)/i,/(opera\s[mobiletab]+).+version\/([\w\.-]+)/i,/(opera).+version\/([\w\.]+)/i,/(opera)[\/\s]+([\w\.]+)/i],[n,a],[/(opios)[\/\s]+([\w\.]+)/i],[[n,"Opera Mini"],a],[/\s(opr)\/([\w\.]+)/i],[[n,"Opera"],a],[/(kindle)\/([\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer)[\/\s]?([\w\.]+)*/i,/(avant\s|iemobile|slim|baidu)(?:browser)?[\/\s]?([\w\.]*)/i,/(?:ms|\()(ie)\s([\w\.]+)/i,/(rekonq)\/([\w\.]+)*/i,/(chromium|flock|rockmelt|midori|epiphany|silk|skyfire|ovibrowser|bolt|iron|vivaldi|iridium|phantomjs|bowser)\/([\w\.-]+)/i],[n,a],[/(trident).+rv[:\s]([\w\.]+).+like\sgecko/i],[[n,"IE"],a],[/(edge)\/((\d+)?[\w\.]+)/i],[n,a],[/(yabrowser)\/([\w\.]+)/i],[[n,"Yandex"],a],[/(puffin)\/([\w\.]+)/i],[[n,"Puffin"],a],[/((?:[\s\/])uc?\s?browser|(?:juc.+)ucweb)[\/\s]?([\w\.]+)/i],[[n,"UCBrowser"],a],[/(comodo_dragon)\/([\w\.]+)/i],[[n,/_/g," "],a],[/(micromessenger)\/([\w\.]+)/i],[[n,"WeChat"],a],[/(QQ)\/([\d\.]+)/i],[n,a],[/m?(qqbrowser)[\/\s]?([\w\.]+)/i],[n,a],[/xiaomi\/miuibrowser\/([\w\.]+)/i],[a,[n,"MIUI Browser"]],[/;fbav\/([\w\.]+);/i],[a,[n,"Facebook"]],[/headlesschrome(?:\/([\w\.]+)|\s)/i],[a,[n,"Chrome Headless"]],[/\swv\).+(chrome)\/([\w\.]+)/i],[[n,/(.+)/,"$1 WebView"],a],[/((?:oculus|samsung)browser)\/([\w\.]+)/i],[[n,/(.+(?:g|us))(.+)/,"$1 $2"],a],[/android.+version\/([\w\.]+)\s+(?:mobile\s?safari|safari)*/i],[a,[n,"Android Browser"]],[/(chrome|omniweb|arora|[tizenoka]{5}\s?browser)\/v?([\w\.]+)/i],[n,a],[/(dolfin)\/([\w\.]+)/i],[[n,"Dolphin"],a],[/((?:android.+)crmo|crios)\/([\w\.]+)/i],[[n,"Chrome"],a],[/(coast)\/([\w\.]+)/i],[[n,"Opera Coast"],a],[/fxios\/([\w\.-]+)/i],[a,[n,"Firefox"]],[/version\/([\w\.]+).+?mobile\/\w+\s(safari)/i],[a,[n,"Mobile Safari"]],[/version\/([\w\.]+).+?(mobile\s?safari|safari)/i],[a,n],[/webkit.+?(gsa)\/([\w\.]+).+?(mobile\s?safari|safari)(\/[\w\.]+)/i],[[n,"GSA"],a],[/webkit.+?(mobile\s?safari|safari)(\/[\w\.]+)/i],[n,[a,u.str,h.browser.oldsafari.version]],[/(konqueror)\/([\w\.]+)/i,/(webkit|khtml)\/([\w\.]+)/i],[n,a],[/(navigator|netscape)\/([\w\.-]+)/i],[[n,"Netscape"],a],[/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo\sbrowser|minimo|conkeror)[\/\s]?([\w\.\+]+)/i,/(firefox|seamonkey|k-meleon|icecat|iceape|firebird|phoenix|palemoon|basilisk|waterfox)\/([\w\.-]+)$/i,/(mozilla)\/([\w\.]+).+rv\:.+gecko\/\d+/i,/(polaris|lynx|dillo|icab|doris|amaya|w3m|netsurf|sleipnir)[\/\s]?([\w\.]+)/i,/(links)\s\(([\w\.]+)/i,/(gobrowser)\/?([\w\.]+)*/i,/(ice\s?browser)\/v?([\w\._]+)/i,/(mosaic)[\/\s]([\w\.]+)/i],[n,a]],cpu:[[/(?:(amd|x(?:(?:86|64)[_-])?|wow|win)64)[;\)]/i],[["architecture","amd64"]],[/(ia32(?=;))/i],[["architecture",c.lowerize]],[/((?:i[346]|x)86)[;\)]/i],[["architecture","ia32"]],[/windows\s(ce|mobile);\sppc;/i],[["architecture","arm"]],[/((?:ppc|powerpc)(?:64)?)(?:\smac|;|\))/i],[["architecture",/ower/,"",c.lowerize]],[/(sun4\w)[;\)]/i],[["architecture","sparc"]],[/((?:avr32|ia64(?=;))|68k(?=\))|arm(?:64|(?=v\d+;))|(?=atmel\s)avr|(?:irix|mips|sparc)(?:64)?(?=;)|pa-risc)/i],[["architecture",c.lowerize]]],device:[[/\((ipad|playbook);[\w\s\);-]+(rim|apple)/i],[i,s,[r,l]],[/applecoremedia\/[\w\.]+ \((ipad)/],[i,[s,"Apple"],[r,l]],[/(apple\s{0,1}tv)/i],[[i,"Apple TV"],[s,"Apple"]],[/(archos)\s(gamepad2?)/i,/(hp).+(touchpad)/i,/(hp).+(tablet)/i,/(kindle)\/([\w\.]+)/i,/\s(nook)[\w\s]+build\/(\w+)/i,/(dell)\s(strea[kpr\s\d]*[\dko])/i],[s,i,[r,l]],[/(kf[A-z]+)\sbuild\/[\w\.]+.*silk\//i],[i,[s,"Amazon"],[r,l]],[/(sd|kf)[0349hijorstuw]+\sbuild\/[\w\.]+.*silk\//i],[[i,u.str,h.device.amazon.model],[s,"Amazon"],[r,o]],[/\((ip[honed|\s\w*]+);.+(apple)/i],[i,s,[r,o]],[/\((ip[honed|\s\w*]+);/i],[i,[s,"Apple"],[r,o]],[/(blackberry)[\s-]?(\w+)/i,/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus|dell|meizu|motorola|polytron)[\s_-]?([\w-]+)*/i,/(hp)\s([\w\s]+\w)/i,/(asus)-?(\w+)/i],[s,i,[r,o]],[/\(bb10;\s(\w+)/i],[i,[s,"BlackBerry"],[r,o]],[/android.+(transfo[prime\s]{4,10}\s\w+|eeepc|slider\s\w+|nexus 7|padfone)/i],[i,[s,"Asus"],[r,l]],[/(sony)\s(tablet\s[ps])\sbuild\//i,/(sony)?(?:sgp.+)\sbuild\//i],[[s,"Sony"],[i,"Xperia Tablet"],[r,l]],[/android.+\s([c-g]\d{4}|so[-l]\w+)\sbuild\//i],[i,[s,"Sony"],[r,o]],[/\s(ouya)\s/i,/(nintendo)\s([wids3u]+)/i],[s,i,[r,"console"]],[/android.+;\s(shield)\sbuild/i],[i,[s,"Nvidia"],[r,"console"]],[/(playstation\s[34portablevi]+)/i],[i,[s,"Sony"],[r,"console"]],[/(sprint\s(\w+))/i],[[s,u.str,h.device.sprint.vendor],[i,u.str,h.device.sprint.model],[r,o]],[/(lenovo)\s?(S(?:5000|6000)+(?:[-][\w+]))/i],[s,i,[r,l]],[/(htc)[;_\s-]+([\w\s]+(?=\))|\w+)*/i,/(zte)-(\w+)*/i,/(alcatel|geeksphone|lenovo|nexian|panasonic|(?=;\s)sony)[_\s-]?([\w-]+)*/i],[s,[i,/_/g," "],[r,o]],[/(nexus\s9)/i],[i,[s,"HTC"],[r,l]],[/d\/huawei([\w\s-]+)[;\)]/i,/(nexus\s6p)/i],[i,[s,"Huawei"],[r,o]],[/(microsoft);\s(lumia[\s\w]+)/i],[s,i,[r,o]],[/[\s\(;](xbox(?:\sone)?)[\s\);]/i],[i,[s,"Microsoft"],[r,"console"]],[/(kin\.[onetw]{3})/i],[[i,/\./g," "],[s,"Microsoft"],[r,o]],[/\s(milestone|droid(?:[2-4x]|\s(?:bionic|x2|pro|razr))?(:?\s4g)?)[\w\s]+build\//i,/mot[\s-]?(\w+)*/i,/(XT\d{3,4}) build\//i,/(nexus\s6)/i],[i,[s,"Motorola"],[r,o]],[/android.+\s(mz60\d|xoom[\s2]{0,2})\sbuild\//i],[i,[s,"Motorola"],[r,l]],[/hbbtv\/\d+\.\d+\.\d+\s+\([\w\s]*;\s*(\w[^;]*);([^;]*)/i],[[s,c.trim],[i,c.trim],[r,"smarttv"]],[/hbbtv.+maple;(\d+)/i],[[i,/^/,"SmartTV"],[s,"Samsung"],[r,"smarttv"]],[/\(dtv[\);].+(aquos)/i],[i,[s,"Sharp"],[r,"smarttv"]],[/android.+((sch-i[89]0\d|shw-m380s|gt-p\d{4}|gt-n\d+|sgh-t8[56]9|nexus 10))/i,/((SM-T\w+))/i],[[s,"Samsung"],i,[r,l]],[/smart-tv.+(samsung)/i],[s,[r,"smarttv"],i],[/((s[cgp]h-\w+|gt-\w+|galaxy\snexus|sm-\w[\w\d]+))/i,/(sam[sung]*)[\s-]*(\w+-?[\w-]*)*/i,/sec-((sgh\w+))/i],[[s,"Samsung"],i,[r,o]],[/sie-(\w+)*/i],[i,[s,"Siemens"],[r,o]],[/(maemo|nokia).*(n900|lumia\s\d+)/i,/(nokia)[\s_-]?([\w-]+)*/i],[[s,"Nokia"],i,[r,o]],[/android\s3\.[\s\w;-]{10}(a\d{3})/i],[i,[s,"Acer"],[r,l]],[/android.+([vl]k\-?\d{3})\s+build/i],[i,[s,"LG"],[r,l]],[/android\s3\.[\s\w;-]{10}(lg?)-([06cv9]{3,4})/i],[[s,"LG"],i,[r,l]],[/(lg) netcast\.tv/i],[s,i,[r,"smarttv"]],[/(nexus\s[45])/i,/lg[e;\s\/-]+(\w+)*/i,/android.+lg(\-?[\d\w]+)\s+build/i],[i,[s,"LG"],[r,o]],[/android.+(ideatab[a-z0-9\-\s]+)/i],[i,[s,"Lenovo"],[r,l]],[/linux;.+((jolla));/i],[s,i,[r,o]],[/((pebble))app\/[\d\.]+\s/i],[s,i,[r,"wearable"]],[/android.+;\s(oppo)\s?([\w\s]+)\sbuild/i],[s,i,[r,o]],[/crkey/i],[[i,"Chromecast"],[s,"Google"]],[/android.+;\s(glass)\s\d/i],[i,[s,"Google"],[r,"wearable"]],[/android.+;\s(pixel c)\s/i],[i,[s,"Google"],[r,l]],[/android.+;\s(pixel xl|pixel)\s/i],[i,[s,"Google"],[r,o]],[/android.+(\w+)\s+build\/hm\1/i,/android.+(hm[\s\-_]*note?[\s_]*(?:\d\w)?)\s+build/i,/android.+(mi[\s\-_]*(?:one|one[\s_]plus|note lte)?[\s_]*(?:\d\w)?)\s+build/i,/android.+(redmi[\s\-_]*(?:note)?(?:[\s_]*[\w\s]+)?)\s+build/i],[[i,/_/g," "],[s,"Xiaomi"],[r,o]],[/android.+(mi[\s\-_]*(?:pad)?(?:[\s_]*[\w\s]+)?)\s+build/i],[[i,/_/g," "],[s,"Xiaomi"],[r,l]],[/android.+;\s(m[1-5]\snote)\sbuild/i],[i,[s,"Meizu"],[r,l]],[/android.+a000(1)\s+build/i],[i,[s,"OnePlus"],[r,o]],[/android.+[;\/]\s*(RCT[\d\w]+)\s+build/i],[i,[s,"RCA"],[r,l]],[/android.+[;\/]\s*(Venue[\d\s]*)\s+build/i],[i,[s,"Dell"],[r,l]],[/android.+[;\/]\s*(Q[T|M][\d\w]+)\s+build/i],[i,[s,"Verizon"],[r,l]],[/android.+[;\/]\s+(Barnes[&\s]+Noble\s+|BN[RT])(V?.*)\s+build/i],[[s,"Barnes & Noble"],i,[r,l]],[/android.+[;\/]\s+(TM\d{3}.*\b)\s+build/i],[i,[s,"NuVision"],[r,l]],[/android.+[;\/]\s*(zte)?.+(k\d{2})\s+build/i],[[s,"ZTE"],i,[r,l]],[/android.+[;\/]\s*(gen\d{3})\s+build.*49h/i],[i,[s,"Swiss"],[r,o]],[/android.+[;\/]\s*(zur\d{3})\s+build/i],[i,[s,"Swiss"],[r,l]],[/android.+[;\/]\s*((Zeki)?TB.*\b)\s+build/i],[i,[s,"Zeki"],[r,l]],[/(android).+[;\/]\s+([YR]\d{2}x?.*)\s+build/i,/android.+[;\/]\s+(Dragon[\-\s]+Touch\s+|DT)(.+)\s+build/i],[[s,"Dragon Touch"],i,[r,l]],[/android.+[;\/]\s*(NS-?.+)\s+build/i],[i,[s,"Insignia"],[r,l]],[/android.+[;\/]\s*((NX|Next)-?.+)\s+build/i],[i,[s,"NextBook"],[r,l]],[/android.+[;\/]\s*(Xtreme\_?)?(V(1[045]|2[015]|30|40|60|7[05]|90))\s+build/i],[[s,"Voice"],i,[r,o]],[/android.+[;\/]\s*(LVTEL\-?)?(V1[12])\s+build/i],[[s,"LvTel"],i,[r,o]],[/android.+[;\/]\s*(V(100MD|700NA|7011|917G).*\b)\s+build/i],[i,[s,"Envizen"],[r,l]],[/android.+[;\/]\s*(Le[\s\-]+Pan)[\s\-]+(.*\b)\s+build/i],[s,i,[r,l]],[/android.+[;\/]\s*(Trio[\s\-]*.*)\s+build/i],[i,[s,"MachSpeed"],[r,l]],[/android.+[;\/]\s*(Trinity)[\-\s]*(T\d{3})\s+build/i],[s,i,[r,l]],[/android.+[;\/]\s*TU_(1491)\s+build/i],[i,[s,"Rotor"],[r,l]],[/android.+(KS(.+))\s+build/i],[i,[s,"Amazon"],[r,l]],[/android.+(Gigaset)[\s\-]+(Q.+)\s+build/i],[s,i,[r,l]],[/\s(tablet|tab)[;\/]/i,/\s(mobile)(?:[;\/]|\ssafari)/i],[[r,c.lowerize],s,i],[/(android.+)[;\/].+build/i],[i,[s,"Generic"]]],engine:[[/windows.+\sedge\/([\w\.]+)/i],[a,[n,"EdgeHTML"]],[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m)\/([\w\.]+)/i,/(khtml|tasman|links)[\/\s]\(?([\w\.]+)/i,/(icab)[\/\s]([23]\.[\d\.]+)/i],[n,a],[/rv\:([\w\.]+).*(gecko)/i],[a,n]],os:[[/microsoft\s(windows)\s(vista|xp)/i],[n,a],[/(windows)\snt\s6\.2;\s(arm)/i,/(windows\sphone(?:\sos)*)[\s\/]?([\d\.\s]+\w)*/i,/(windows\smobile|windows)[\s\/]?([ntce\d\.\s]+\w)/i],[n,[a,u.str,h.os.windows.version]],[/(win(?=3|9|n)|win\s9x\s)([nt\d\.]+)/i],[[n,"Windows"],[a,u.str,h.os.windows.version]],[/\((bb)(10);/i],[[n,"BlackBerry"],a],[/(blackberry)\w*\/?([\w\.]+)*/i,/(tizen)[\/\s]([\w\.]+)/i,/(android|webos|palm\sos|qnx|bada|rim\stablet\sos|meego|contiki)[\/\s-]?([\w\.]+)*/i,/linux;.+(sailfish);/i],[n,a],[/(symbian\s?os|symbos|s60(?=;))[\/\s-]?([\w\.]+)*/i],[[n,"Symbian"],a],[/\((series40);/i],[n],[/mozilla.+\(mobile;.+gecko.+firefox/i],[[n,"Firefox OS"],a],[/(nintendo|playstation)\s([wids34portablevu]+)/i,/(mint)[\/\s\(]?(\w+)*/i,/(mageia|vectorlinux)[;\s]/i,/(joli|[kxln]?ubuntu|debian|[open]*suse|gentoo|(?=\s)arch|slackware|fedora|mandriva|centos|pclinuxos|redhat|zenwalk|linpus)[\/\s-]?(?!chrom)([\w\.-]+)*/i,/(hurd|linux)\s?([\w\.]+)*/i,/(gnu)\s?([\w\.]+)*/i],[n,a],[/(cros)\s[\w]+\s([\w\.]+\w)/i],[[n,"Chromium OS"],a],[/(sunos)\s?([\w\.]+\d)*/i],[[n,"Solaris"],a],[/\s([frentopc-]{0,4}bsd|dragonfly)\s?([\w\.]+)*/i],[n,a],[/(haiku)\s(\w+)/i],[n,a],[/cfnetwork\/.+darwin/i,/ip[honead]+(?:.*os\s([\w]+)\slike\smac|;\sopera)/i],[[a,/_/g,"."],[n,"iOS"]],[/(mac\sos\sx)\s?([\w\s\.]+\w)*/i,/(macintosh|mac(?=_powerpc)\s)/i],[[n,"Mac OS"],[a,/_/g,"."]],[/((?:open)?solaris)[\/\s-]?([\w\.]+)*/i,/(aix)\s((\d)(?=\.|\)|\s)[\w\.]*)*/i,/(plan\s9|minix|beos|os\/2|amigaos|morphos|risc\sos|openvms)/i,/(unix)\s?([\w\.]+)*/i],[n,a]]},d=function(t,i){if("object"==typeof t){i=t;t=void 0}if(!(this instanceof d))return new d(t,i).getResult();var n=t||(e&&e.navigator&&e.navigator.userAgent?e.navigator.userAgent:""),r=i?c.extend(p,i):p;this.getBrowser=function(){var e={name:void 0,version:void 0};u.rgx.call(e,n,r.browser);e.major=c.major(e.version);return e};this.getCPU=function(){var e={architecture:void 0};u.rgx.call(e,n,r.cpu);return e};this.getDevice=function(){var e={vendor:void 0,model:void 0,type:void 0};u.rgx.call(e,n,r.device);return e};this.getEngine=function(){var e={name:void 0,version:void 0};u.rgx.call(e,n,r.engine);return e};this.getOS=function(){var e={name:void 0,version:void 0};u.rgx.call(e,n,r.os);return e};this.getResult=function(){return{ua:this.getUA(),browser:this.getBrowser(),engine:this.getEngine(),os:this.getOS(),device:this.getDevice(),cpu:this.getCPU()}};this.getUA=function(){return n};this.setUA=function(e){n=e;return this};return this};d.VERSION="0.7.17";d.BROWSER={NAME:n,MAJOR:"major",VERSION:a};d.CPU={ARCHITECTURE:"architecture"};d.DEVICE={MODEL:i,VENDOR:s,TYPE:r,CONSOLE:"console",MOBILE:o,SMARTTV:"smarttv",TABLET:l,WEARABLE:"wearable",EMBEDDED:"embedded"};d.ENGINE={NAME:n,VERSION:a};d.OS={NAME:n,VERSION:a};if(void 0!==exports){"undefined"!=typeof module&&module.exports&&(exports=module.exports=d);exports.UAParser=d}else"function"==typeof define&&define.amd?define(function(){return d}):e&&(e.UAParser=d);var f=e&&(e.jQuery||e.Zepto);if(void 0!==f){var m=new d;f.ua=m.getResult();f.ua.get=function(){return m.getUA()};f.ua.set=function(e){m.setUA(e);var t=m.getResult();for(var i in t)f.ua[i]=t[i]}}}("object"==typeof window?window:this);var TC=TC||{};!function(){const e=function(e){return function(t,i,n){return i[e]?n:t}},t=function(e){return function(t,i,n,r){return i.id===e?n:t}},i={layers:[],contains:function(e){return this.layers.some(function(t){return t.id===e})},getIndex:function(e){return this.layers.reduce(t(e),-1)},add:function(e,t,n,r){var s;const a={id:e,deferred:t,isRaster:n,isBase:r};if(n){s=i.getRasterIndex();this.layers.splice(s,0,a)}else{s=this.layers.length;this.layers[s]=a}},remove:function(e){this.layers.splice(this.getIndex(e),1)},getMapLayers:function(){return this.layers.filter(function(e){return"resolved"===e.deferred.state()}).map(function(e){return e.mapLayer})},resolve:function(e,t,i){this.layers[this.getIndex(t.id)].mapLayer=t;e.layers=this.getMapLayers();i?e.baseLayers=e.layers.filter(function(e){return e.isBase}):e.workLayers=e.layers.filter(function(e){return!e.isBase})},getResolvedWorkLayerIndex:function(e,i){return this.layers.filter(function(e){return e.id===i||!e.isBase&&"pending"!==e.deferred.state()}).reduce(t(i),-1)},getResolvedVisibleLayerIndex:function(e,t){var i=this.getResolvedWorkLayerIndex(e,t);e.baseLayer&&(i+=1);return i},getRasterIndex:function(){return this.layers.reduce(e("isRaster"),-1)+1},checkMapLoad:function(e){const t=this;if(e.options.baseLayers.concat(e.options.workLayers).every(function(e){return t.contains(e.id||e)})&&!this.layers.some(function(e){return"pending"===e.deferred.state()})){const t=function(){if(!e.isLoaded){e.isLoaded=!0;e.$events.trigger($.Event(TC.Consts.event.MAPLOAD));e._$div.removeClass(TC.Consts.classes.LOADING)}};if(e.baseLayer)t();else{const i=e.baseLayers.filter(function(e){return!e.mustReproject})[0];e.wrap.setBaseLayer(i.wrap.getLayer());e.baseLayer=i;t()}}}},n=function(e){return(this instanceof TC.Map?this.options.availableBaseLayers:TC.Cfg.availableBaseLayers).filter(function(t){return t.id===e})[0]};TC.Map=TC.Map||function(e,t){var i=this;i.$events=$(i);i.isReady=!1;i.isLoaded=!1;i.controls=[];i.activeControl=null;i.layers=[];i.baseLayers=[];i.workLayers=[];i.baseLayer=null;i.vectors=null;var s=0;i.div=TC.Util.getDiv(e);i._$div=$(i.div);i._$div.addClass(TC.Consts.classes.LOADING);i._$div.data("map",i);i._$div.addClass(TC.Consts.classes.MAP);i._markerDeferreds=[];if(!TC.ready){TC.Cfg=$.extend({},TC.Defaults,TC.Cfg);TC.ready=!0}if(t&&t.controls&&t.controls.search&&t.controls.search.allowedSearchTypes)for(var l in TC.Cfg.controls.search.allowedSearchTypes)t.controls.search.allowedSearchTypes.hasOwnProperty(l)||(t.controls.search.allowedSearchTypes[l]=!1);t=t||{};a.call(i,t);var c=function(){TC.loadJS(i.options.stateful&&!window.jsonpack,[TC.apiLocation+TC.Consts.url.JSONPACK],function(){if(i.options.stateful){u();i.state=i.checkLocation()}i.options.layout&&i.$events.trigger($.Event(TC.Consts.event.LAYOUTLOAD,{map:i}));t&&void 0!==t.workLayers&&(i.options.workLayers=t.workLayers);t&&void 0!==t.baseLayers&&(i.options.baseLayers=t.baseLayers);if(i.options.zoomToFeatures){i.on(TC.Consts.event.FEATURESADD,function e(t){clearTimeout(i._zoomToFeaturesTimeout);i._zoomToFeaturesTimeout=setTimeout(function(){i.zoomToFeatures(t.layer.features,{animate:!1});i.off(TC.Consts.event.FEATURESADD,e)},100)})}else{i.on(TC.Consts.event.LAYERADD,function e(t){if(t.layer.isBase&&t.layer===i.baseLayer){void 0!==i.state&&(i.state.crs?i.loaded(function(){i.setProjection({crs:i.state.crs,extent:i.state.ext})}):i.setExtent(i.state.ext,{animate:!1}));i.off(TC.Consts.event.LAYERADD,e)}})}i.state&&i.state.vw3&&i.loaded(function(){i.getControlsByClass(TC.control.ThreeD)[0].setMapState(i.state.vw3)});i.crs=i.options.crs;i.initialExtent=i.options.initialExtent;i.maxExtent=i.options.maxExtent;i.wrap=new TC.wrap.Map(i);TC.loadJS(!(TC.isLegacy?window[TC.Consts.PROJ4JSOBJ_LEGACY]:window[TC.Consts.PROJ4JSOBJ]),[TC.url.proj4js],function(){TC.loadJSInOrder(!(TC.isLegacy?window[TC.Consts.OLNS_LEGACY]:window[TC.Consts.OLNS]),[TC.url.ol,TC.url.olConnector],function(){TC.loadProjDef({crs:i.options.crs,callback:function(){i.wrap.setMap();for(var e in i.options.controls){const t=i.options.controls[e];t&&i.addControl(e,"boolean"==typeof t?{}:t)}i.on(TC.Consts.event.BEFORELAYERUPDATE,g);i.on(TC.Consts.event.LAYERUPDATE,C);var t,r;for(t=0;t<i.options.baseLayers.length;t++){"string"==typeof(r=i.options.baseLayers[t])&&(r=n.call(i,r));i.addLayer($.extend({},r,{isBase:!0,map:i}))}var s=function(e){e.isRaster()&&!e.names&&e.setVisibility(!1)};i.options.workLayers.map(function(e){return $.extend({},e,{map:i})}).filter(function(e){return!i.state||!i.state.layers||!i.state.layers.some(function(t){const i=t.u===e.url&&e.layerNames.indexOf(t.n)>=0;i&&(t.id=e.id);return i})}).forEach(function(e){i.addLayer(e).then(s)});i.state&&i.state.layers&&i.state.layers.forEach(function(e){var t=e.o,n=e.v;i.addLayer({id:e.id||TC.getUID(),url:TC.Util.isOnCapabilities(e.u,e.u.indexOf(window.location.protocol)<0)||e.u,hideTitle:e.h,layerNames:e.n?e.n.split(","):"",renderOptions:{opacity:e.o,hide:!e.v}}).then(function(e){e.wrap.$events.on(TC.Consts.event.TILELOADERROR,function(e){var t=this.parent;401!==e.error.code&&403!==e.error.code||t.map.toast(e.error.text,{type:TC.Consts.msgType.ERROR});t.map.removeLayer(t)});var i=e.wrap.getRootLayerNode();e.title=i.Title||i.title;e.setOpacity(t);e.setVisibility(n)})});i.isReady=!0;i.$events.trigger($.Event(TC.Consts.event.MAPREADY));d(i._$div)}})})});i.on(TC.Consts.event.FEATURECLICK,function(e){i.activeControl&&i.activeControl.isExclusive()||e.feature.showPopup()});i.on(TC.Consts.event.NOFEATURECLICK,function(e){e.layer._noFeatureClicked=!0;for(var t=!0,n=0,r=i.workLayers.length;n<r;n++)if(!i.workLayers[n]._noFeatureClicked){t=!1;break}if(t){i.workLayers.forEach(function(e){delete e._noFeatureClicked});i.getControlsByClass(TC.control.Popup).forEach(function(e){e.hide()})}})})},u=function(){var e=[TC.Consts.event.LAYERADD,TC.Consts.event.LAYERORDER,TC.Consts.event.LAYERREMOVE,TC.Consts.event.LAYERVISIBILITY,TC.Consts.event.ZOOM,TC.Consts.event.BASELAYERCHANGE].join(" ");i.on(TC.Consts.event.MAPLOAD,function(){i.loaded(function(){i.replaceCurrent=!0;f();i.on(e,$.proxy(f,i));var t;i.on(TC.Consts.event.LAYEROPACITY,function(e){clearTimeout(t);t=setTimeout(function(){f(e)},500)});window.addEventListener("popstate",function(t){var n;n=i.loadingCtrl&&i.loadingCtrl.addWait();setTimeout(function(){if(t&&null!=t.state){i.off(e,$.proxy(f,i));$.when(y(t.state)).then(function(){setTimeout(function(){i.on(e,$.proxy(f,i))},200);i.loadingCtrl&&i.loadingCtrl.removeWait(n)})}},4)})})})},h=null,p=null,f=function(e){var t=m();if(i.replaceCurrent){window.history.replaceState(t,null,null);delete i.replaceCurrent}else{i.lastEventType=e.type;var n=function(){p=h;(h=TC.Util.utf8ToBase64(t))!==p&&window.history.pushState(t,null,window.location.href.split("#").shift()+"#"+h)};if(e)switch(!0){case e.type==TC.Consts.event.BASELAYERCHANGE.replace(".tc",""):case e.type==TC.Consts.event.LAYERORDER.replace(".tc",""):case e.type==TC.Consts.event.ZOOM.replace(".tc",""):n();break;case e.type.toLowerCase().indexOf("LAYER".toLowerCase())>-1:e.layer.type==TC.Consts.layerType.WMS&&n()}}},m=function(e){var t={};i.crs!==i.options.crs&&(t.crs=i.crs);for(var n,r,s=i.getExtent(),a=0;a<s.length;a++)Math.abs(s[a])>180&&(s[a]=Math.floor(1e3*s[a])/1e3);t.ext=s;t.base=i.getBaseLayer().id;t.layers=[];for(a=0;a<i.workLayers.length;a++)if("WMS"==(n=i.workLayers[a]).type&&!n.options.stateless&&n.layerNames&&n.layerNames.length){r={u:TC.Util.isOnCapabilities(n.url),n:$.isArray(n.names)?n.names.join(","):n.names,o:n.getOpacity(),v:n.getVisibility(),h:n.options.hideTitle};t.layers.push(r)}var o=i.getControlsByClass(TC.control.ThreeD);o.length>0&&o[0].mapIs3D&&o[0].map3D.cameraControls&&(t.vw3=o[0].map3D.cameraControls.getCameraState());window.jsonpack||TC.syncLoadJS(TC.apiLocation+TC.Consts.url.JSONPACK);e&&$.extend(t,e);return jsonpack.pack(t)},y=function(e){var t=new $.Deferred,n=[];i.loadingctrl||(i.loadingCtrl=i.getControlsByClass("TC.control.LoadingIndicator")[0]);i.hasWait||(i.hasWait=i.loadingCtrl&&i.loadingCtrl.addWait());var r;if("string"==typeof e)try{r=jsonpack.unpack(e)}catch(t){try{r=JSON.parse(e)}catch(e){TC.error(TC.Util.getLocaleString(i.options.locale,"mapStateNotValid"))}}else r=e;if(r){if(r.crs&&r.crs!==i.crs||void 0===r.crs&&i.crs!==i.options.crs)n.push(i.setProjection({crs:r.crs||i.options.crs,oldCrs:i.crs,extent:r.ext,baseLayer:i.getLayer(r.base)}));else{if(r.base!=i.getBaseLayer().id){i.getLayer(r.base)&&i.setBaseLayer(r.base);const e=i.baseLayers.filter(function(e){return e.options.fallbackLayer===r.base})[0];if(e){const t=i.addLayer(e.getFallbackLayer());n.push(t);t.then(function(e){i.setBaseLayer(e)})}}r.ext&&n.push(i.setExtent(r.ext,{animate:!1}))}!function(){var e=[];i.workLayers.forEach(function(t){t instanceof TC.layer.Vector||e.push(t)});for(var t=0;t<e.length;t++)i.removeLayer(e[t])}();r.layers=r.layers||r.capas||[];if(r.layers.length>0)for(var s=0;s<r.layers.length;s++){var a=r.layers[s],o=a.o,l=a.v,c=!1;for(j=0;j<i.options.workLayers.length;j++){var u=$.extend({},i.options.workLayers[j],{map:i});if(a.u===u.url&&u.layerNames.indexOf(a.n)>=0){c=!0;u.renderOptions={opacity:a.o,hide:!a.v};n.push(i.addLayer(u).then(function(e){e.setVisibility(l);e.setOpacity(o,!0)}))}}c||n.push(i.addLayer({id:TC.getUID(),url:TC.Util.isOnCapabilities(a.u,a.u.indexOf(window.location.protocol)<0)||a.u,hideTitle:a.h,layerNames:a.n?a.n.split(","):"",renderOptions:{opacity:a.o,hide:!a.v}}).then(function(e){var t=e.wrap.getRootLayerNode();e.title=t.Title||t.title;e.setOpacity(o,!0);e.setVisibility(l)}))}$.when.apply($,n).always(function(){!function(){i.loadingCtrl&&i.loadingCtrl.removeWait(i.hasWait);delete i.hasWait;t.resolve()}()})}return t};o.getMapState=function(e){var t=m(e);return TC.Util.utf8ToBase64(t)};o.getPreviousMapState=function(){return p};o.checkLocation=function(){var e=window.location.hash;if(e&&e.length>1){e=e.substr(1);var t;try{t=jsonpack.unpack(TC.Util.base64ToUtf8(e))}catch(n){try{t=JSON.parse(TC.Util.base64ToUtf8(e))}catch(e){TC.error(TC.Util.getLocaleString(i.options.locale,"mapStateNotValid"),TC.Consts.msgErrorMode.TOAST);return}}TC.Util.detectIE()&&2047===window.location.href.length&&TC.error(TC.Util.getLocaleString(i.options.locale,"mapStateNotValidForIE"),TC.Consts.msgErrorMode.TOAST);if(t){var n=!1;if(!t.hasOwnProperty("ext")){n=!0;t.ext=i.options.initialExtent}if(!t.hasOwnProperty("base")){n=!0;t.base=i.options.defaultBaseLayer}if(t.hasOwnProperty("layers"))for(var r=t.layers.length-1;r>=0;r--)if(t.layers[r]&&t.layers[r].hasOwnProperty("u")&&t.layers[r].hasOwnProperty("n")){if(!t.layers[r].hasOwnProperty("o")||!t.layers[r].hasOwnProperty("v")||!t.layers[r].hasOwnProperty("h")){n=!0;jQuery.extend(t.layers[r],{o:t.layers[r].o||1,v:t.layers[r].v||!0,h:t.layers[r].h||!1})}}else{n=!0;t.layers.length=t.layers.length-1}else{n=!0;t.layers=[]}t.hasOwnProperty("vw3")&&(t.vw3?(!t.vw3.cp||t.vw3.cp&&3!=t.vw3.cp.length||!t.vw3.chpr||t.vw3.chpr&&3!=t.vw3.chpr.length||!t.vw3.bcpd)&&(n=!0):n=!0);n&&TC.error(TC.Util.getLocaleString(i.options.locale,"mapStateNotValid"),TC.Consts.msgErrorMode.TOAST);return t}TC.error(TC.Util.getLocaleString(i.options.locale,"mapStateNotValid"),TC.Consts.msgErrorMode.TOAST)}};var g=function(e){if(s<=0){s=0;i.$events.trigger($.Event(TC.Consts.event.BEFOREUPDATE))}s+=1},C=function(e){if((s-=1)<=0){s=0;i.$events.trigger($.Event(TC.Consts.event.UPDATE))}},v=function(e){var t=$.Deferred();if("string"==typeof e){var i=e,n=/^(https?:)?\/\//i.test(i),r=function(t,r){var o=$.Deferred(),l=[i+"/"+r,a+i+"/"+r,a+"layout/responsive/"+r];n&&l.unshift(i+"/"+r);!function i(n){(function(e,t){var i=$.Deferred();$.ajax({type:"HEAD",url:e,complete:function(n,r){i.resolve({resource:t,found:404!==n.status,url:e})}});return i.promise()})(l[n],t).done(function(t){t.found?o.resolve(s(e,t)):i(++n)})}(0);return o.promise()},s=function(e,t){if(!(t.resource in e)){$.extend(!0,{},e);var n=t.found?t.url:a+i+"/"+o[t.resource];e[t.resource]=n}return e},a=TC.apiLocation+"TC/",o=(e={},{script:"script.js",style:"style.css",markup:"markup.html",config:"config.json",i18n:"resources"}),l=Object.keys(o).length;for(var c in o)r(c,o[c]).done(function(e){Object.keys(e).length===l&&t.resolve(e)})}else t.resolve(e);return t.promise()};TC.i18n=TC.i18n||{};TC.i18n.loadResources=TC.i18n.loadResources||function(e,t,i){var n;e?n=$.ajax({url:t+i+".json",type:"GET",dataType:"json",success:function(e){TC.i18n[i]=TC.i18n[i]||{};$.extend(TC.i18n[i],e);"undefined"!=typeof dust&&TC.loadJS(!window.dust.i18n,TC.apiLocation+TC.Consts.url.TEMPLATING_I18N,function(){dust.i18n.add(i,TC.i18n[i])})}}):dust.i18n.add(i,TC.i18n[i]);return n};var T=[],L=i.options.locale,w=$.Deferred();T.push(w);TC.loadJSInOrder(!window.dust||!window.dust.i18n,TC.url.templating,function(){if(L){dust.i18n.setLanguages([L]);T.push(TC.i18n.loadResources(!TC.i18n[L],TC.apiLocation+"TC/resources/",L))}w.resolve()});$.when.apply(this,T).always(function(){const e=TC.Util.getParameterByName(TC.Cfg.layoutURLParamName)||i.options.layout;e?v(e).done(function(e){i.$events.trigger($.Event(TC.Consts.event.BEFORELAYOUTLOAD,{map:i}));var n;"string"==typeof e?n={href:$.trim(e)}:(e.hasOwnProperty("config")||e.hasOwnProperty("markup")||e.hasOwnProperty("style")||e.hasOwnProperty("ie8Style")||e.hasOwnProperty("script")||e.hasOwnProperty("href")||e.hasOwnProperty("i18n"))&&(n=$.extend({},e));n.href&&(n.href+=n.href.match(/\/$/)?"":"/");n.config=n.config||n.href+"config.json";n.markup=n.markup||n.href+"markup.html";n.style=n.style||n.href+"style.css";n.ie8Style=n.ie8Style||n.href+"ie8.css";n.script=n.script||n.href+"script.js";n.i18n=n.i18n||n.href+"resources";n.i18n&&(n.i18n+=n.i18n.match(/\/$/)?"":"/");i.layout=n;var r=[],s=$.Deferred();r.push(s);n.config?r.push($.ajax({url:n.config,type:"GET",dataType:"json",success:function(e){s.resolve(e.i18n);a.call(i,e,t)},error:function(e,t,i){TC.error(t+": "+i);s.resolve(!1)}})):s.resolve(!1);if(n.style){i._$div.addClass("tc-lo");TC.loadCSS(n.style)}!Modernizr.canvas&&n.ie8Style&&TC.loadCSS(n.ie8Style);if(n.markup){var o;if(L){o=$.Deferred();r.push(o)}r.push($.ajax({url:n.markup,type:"GET",dataType:"html",success:function(e){s.then(function(t){if(t&&L)TC.i18n.loadResources(!0,n.i18n,L).always(function(){e=e.replace(/(?:\{\{([^\}\{]+)\}\}|\{@i18n \$key="([^\}\{]+)"\/\})/g,function(e,t,i){return TC.Util.getLocaleString(L,t||i)});i._$div.append(e);o.resolve()});else{i._$div.append(e);L&&o.resolve()}})},error:function(){o.reject()}}))}$.when.apply(this,r).always(function(){TC.loadJS(n.script,n.script,function(){d(i._$div);c()})})}):c()});i.$events.on(TC.Consts.event.UPDATEPARAMS,function(e){r(e.layer)});i.$events.on(TC.Consts.event.ZOOM,function(){for(var e=0;e<i.workLayers.length;e++)r(i.workLayers[e])});var b=TC.error;TC.error=function(e,t,n){TC.isDebug&&console.trace&&console.trace();if(t){var r=function(e,t,n){switch(t){case TC.Consts.msgErrorMode.TOAST:if(!i.toast){console.warn("No existe el objeto Toast");return}i.toast(e,{type:TC.Consts.msgType.ERROR,duration:2*TC.Cfg.toastDuration});break;case TC.Consts.msgErrorMode.EMAIL:TC.Cfg.loggingErrorsEnabled&&JL("onerrorLogger").fatalException(n?{msg:n,errorMsg:e}:e,null);break;case TC.Consts.msgErrorMode.CONSOLE:default:console.error(e)}};if($.isArray(t))for(var s=0;s<t.length;s++)r(e,t[s],n);else r(e,t,n)}else{b(e);i.toast(e,{type:TC.Consts.msgType.ERROR,duration:2*TC.Cfg.toastDuration})}}};var r=function(e){e.type===TC.Consts.layerType.WMS&&(e.tree=null)},s=function(e,t){var i=$.map(e,function(e){var i={};e&&(i[t]=e[t]);return i});"availableBaseLayers"===t&&console.log("layerOptions",i);var r={};r[t]=TC.Cfg[t];i.unshift(r);if("baseLayers"===t&&i[1].baseLayers){r=i[1];for(var s=0;s<r.baseLayers.length;s++)"object"==typeof r.baseLayers[s]&&$.extend(r.baseLayers[s],n.call(this,r.baseLayers[s].id))}else{i.unshift(!0);r=$.extend.apply(this,i);"availableBaseLayers"===t&&console.log("layerOption",r)}return r[t]},a=function(){const e=this.options=$.extend.apply(this,$.merge([!0,{},TC.Cfg],arguments));e.availableBaseLayers=TC.Cfg.availableBaseLayers.concat.apply(TC.Cfg.availableBaseLayers,Array.prototype.map.call(arguments,function(e){return e.availableBaseLayers||[]}));e.baseLayers=s.call(this,arguments,"baseLayers");e.workLayers=s.call(this,arguments,"workLayers");return e},o=TC.Map.prototype,l=function(e,t){var i,n='Layer "'+t.title+'" ("'+t.names+'"): ';i=t.isValidFromNames()?"layerSrsNotCompatible":"layerNameNotValid";n+=TC.Util.getLocaleString(e.options.locale,i);TC.error(n);e.$events.trigger($.Event(TC.Consts.event.LAYERERROR,{layer:t,reason:i}))};o.addLayer=function(e,t){const r=this,s=new $.Deferred;s.then(function(e){i.resolve(r,e,e.isBase);r.$events.trigger($.Event(TC.Consts.event.LAYERADD,{layer:e}));i.checkMapLoad(r);$.isFunction(t)&&t(e)},function(e){i.checkMapLoad(r)});const a=f(e);"object"!=typeof e||e.id||(e.id=TC.getUID());i.add(e.id||e,s,a,e.isBase);const o=function(e){if(e){var t={projection:r.wrap.map.getView().getProjection(),extent:r.initialExtent},i=r.baseLayer.getResolutions();if(i&&i.length)t.resolutions=i;else{t.minZoom=r.wrap.map.getView().getMinZoom();t.maxZoom=r.wrap.map.getView().getMaxZoom();var n=r.baseLayer.wrap.layer.getMinResolution();0!==n&&(t.minResolution=n);var s=r.baseLayer.wrap.layer.getMaxResolution();s!==Number.POSITIVE_INFINITY&&(t.maxResolution=s)}r.wrap.map.setView(new ol.View(t));r.wrap.map.getView().fit(r.initialExtent)}};var c,u,h;if(a){u=!TC.layer||!TC.layer.Raster;h=TC.apiLocation+"TC/layer/Raster"}else{u=!TC.layer||!TC.layer.Vector;h=TC.apiLocation+"TC/layer/Vector"}TC.loadJS(u,[h],function(){if("string"==typeof e)c=new TC.layer.Raster($.extend({},n.call(r,e),{map:r}));else if(e instanceof TC.Layer)(c=e).map=r;else{e.map=r;c=e.type===TC.Consts.layerType.VECTOR||e.type===TC.Consts.layerType.KML||e.type===TC.Consts.layerType.WFS?new TC.layer.Vector(e):new TC.layer.Raster(e)}r.$events.trigger($.Event(TC.Consts.event.BEFORELAYERADD,{layer:c}));$.when(r.wrap.getMap(),c.wrap.getLayer()).then(function(){var t;f(c)&&(t=r.wrap.indexOfFirstVector());-1===t&&(t=r.wrap.getLayerCount());const n=r.state&&r.state.crs||r.crs,a=c.isCompatible(n);if(c.isBase){if(!a)if(!c.type===TC.Consts.layerType.WMTS)c.mustReproject=!0;else{const e=c.wrap.getCompatibleMatrixSets(n)[0];e?c.wrap.setMatrixSet(e):c.mustReproject=!0}r.state?c.isDefault=r.state.base===c.id||r.state.base===c.options.fallbackLayer:"string"==typeof r.options.defaultBaseLayer?r.options.defaultBaseLayer===c.id&&(c.isDefault=!0):"number"==typeof r.options.defaultBaseLayer&&r.options.defaultBaseLayer===r.baseLayers.length&&(c.isDefault=!0);if(c.isDefault)if(c.mustReproject)if(c.options.fallbackLayer&&c.getFallbackLayer){var u=null===r.baseLayer;r.baseLayer=c.getFallbackLayer();r.addLayer(r.baseLayer).then(function(e){r.wrap.setBaseLayer(e.wrap.getLayer());o(u);s.resolve(c)})}else{l(r,c);s.reject(e)}else{u=null===r.baseLayer;r.wrap.setBaseLayer(c.wrap.getLayer());r.baseLayer=c;o(u);s.resolve(c)}else s.resolve(c)}else if(a){r.wrap.insertLayer(c.wrap.getLayer(),i.getResolvedVisibleLayerIndex(r,c.id));s.resolve(c)}else{l(r,c);s.reject(e)}})});return s.promise()};o.removeLayer=function(e){var t=this,n=new $.Deferred;$.when(e.wrap.getLayer()).then(function(r){for(var s=0;s<t.layers.length;s++)t.layers[s]===e&&t.layers.splice(s,1);if(e.isBase){for(s=0;s<t.baseLayers.length;s++)if(t.baseLayers[s]===e){t.baseLayers.splice(s,1);t.baseLayer===e&&t.setBaseLayer(t.baseLayers[0]);break}}else{for(s=0;s<t.workLayers.length;s++)if(t.workLayers[s]===e){t.workLayers.splice(s,1);break}e===t.vectors&&(t.vectors=null)}t.wrap.removeLayer(r);i.remove(e.id);t.$events.trigger($.Event(TC.Consts.event.LAYERREMOVE,{layer:e}));i.checkMapLoad(t);n.resolve(e)});return n};o.insertLayer=function(e,t,i){for(var n=this,r=-1,s=0;s<n.layers.length;s++)if(e===n.layers[s]){r=s;break}var a=[];a.push(e.wrap.getLayer());var o=n.layers[t];o&&a.push(o.wrap.getLayer());$.when.apply(this,a).then(function(s,a){var o=-1;if((o=a?n.wrap.getLayerIndex(a):n.wrap.getLayerCount())>=0){e.map=n;n.wrap.insertLayer(s,o);r>-1&&n.layers.splice(r,1);n.layers.splice(t,0,e);n.workLayers=n.layers.filter(function(e){return!e.isBase});n.$events.trigger($.Event(TC.Consts.event.LAYERORDER,{layer:e,oldIndex:r,newIndex:t}))}$.isFunction(i)&&i()})};o.setLayerIndex=function(e,t){this.wrap.setLayerIndex(e.wrap.getLayer(),t)};o.putLayerOnTop=function(e){var t=this.wrap.getLayerCount();this.setLayerIndex(e,t-1)};o.setBaseLayer=function(e,t){var i=this,r=null,s=!1;if("string"==typeof e){var a;for(a=0;a<i.layers.length;a++)if(i.layers[a].id===e){e=i.layers[a];s=!0;break}if(!s&&(e=n.call(i,e))){e=i.addLayer($.extend(!0,{},e,{isDefault:!0,map:i}));s=!0}}else{if($.inArray(e,i.layers)<0){e.isDefault=!0;e.map=i;i.addLayer(e)}s=!0}if(s)if(e.mustReproject)TC.error("Base layer must be reprojected");else{i.$events.trigger($.Event(TC.Consts.event.BEFOREBASELAYERCHANGE,{oldLayer:i.getBaseLayer(),newLayer:e}));r=e;$.when(i.wrap.getMap(),e).then(function(e,n){$.when(n.wrap.getLayer()).then(function(e){i.wrap.setBaseLayer(e).then(function(){i.baseLayer=n;i.$events.trigger($.Event(TC.Consts.event.BASELAYERCHANGE,{layer:n}));$.isFunction(t)&&t()})})})}else TC.error("Base layer is not available");return r};o.on=function(e,t){this.$events.on(e,t);return this};o.one=function(e,t){this.$events.one(e,t);return this};o.off=function(e,t){this.$events.off(e,t);return this};o.ready=function(e){$.isFunction(e)&&(this.isReady?e():this.one(TC.Consts.event.MAPREADY,e))};o.loaded=function(e){$.isFunction(e)&&(this.isLoaded?e():this.one(TC.Consts.event.MAPLOAD,e))};o.getLayerTree=function(){var e={baseLayers:[],workLayers:[]};this.baseLayer&&(e.baseLayers[0]=this.baseLayer.getTree());for(var t=0;t<this.workLayers.length;t++){var i=this.workLayers[t].getTree();i&&e.workLayers.unshift(i)}return e};o.addControl=function(e,t){var i=this,n=new $.Deferred,r=function(e){i.controls.push(e);e.register(i);$dv=$(e.div);0===$dv.parent().length&&$dv.appendTo(i._$div);i.$events.trigger($.Event(TC.Consts.event.CONTROLADD,{control:e}));n.resolve(e)};if("string"==typeof e){e=e.substr(0,1).toUpperCase()+e.substr(1);TC.loadJS(!TC.Control||!TC.control[e],[TC.apiLocation+"TC/control/"+e],function(){r(new TC.control[e](null,t))})}else r(e);return n.promise()};o.getControlsByClass=function(e){var t=[],i=e;if("string"==typeof e){i=window;for(var n=e.split("."),r=0;r<n.length&&(i=i[n[r]]);r++);}if($.isFunction(i))for(r=0;r<this.controls.length;r++){var s=this.controls[r];s instanceof i&&t.push(s)}return t};o.getControlById=function(e){const t=this;for(var i=0,n=t.controls.length;i<n;i++){const n=t.controls[i];if(n.id===e)return n}return null};o.getDefaultControl=function(){var e=this.getControlsByClass("TC.control.FeatureInfo");return e&&e.length?e[0]:null};o.getLoadingIndicator=function(){var e=null,t=this.getControlsByClass("TC.control.LoadingIndicator");t.length&&(e=t[0]);return e};o.setExtent=function(e,t){return this.wrap.setExtent(e,t)};o.getExtent=function(){return this.wrap.getExtent()};o.setCenter=function(e,t){return this.wrap.setCenter(e,t)};o.getCenter=function(){return this.wrap.getCenter()};o.setRotation=function(e){this.wrap.setRotation(e)};o.getRotation=function(){return this.wrap.getRotation()};o.getViewHTML=function(){return this.wrap.getViewport()};o.getCompatibleCRS=function(e){const t=((e=e||{}).layers||this.workLayers.concat(this.baseLayer)).filter(function(e){return e.isRaster()}).map(function(t){return t.getCompatibleCRS({normalized:!0,includeFallback:e.includeFallbacks})}),i=t.slice(1);return t[0].filter(function(e){return i.every(function(t){return t.indexOf(e)>=0})})};o.loadProjections=function(e){e=e||{};const t=$.Deferred(),i=e.crsList||[];$.when.apply(this,i.map(function(e){return TC.getProjectionData({crs:TC.Util.getCRSCode(e)})})).then(function(){var i=Array.prototype.slice.call(arguments).filter(function(e){return"ok"===e.status&&e.number_result>0}).map(function(e){const t=e.results[0],i="EPSG:"+t.code;TC.loadProjDef({crs:i,def:t.def,name:t.name});return{code:i,name:t.name,proj4:t.proj4,unit:t.unit}});e.orderBy&&(i=i.sort(TC.Util.getSorterByProperty(e.orderBy)));t.resolve(i)},function(e){t.reject(e)});return t.promise()};o.setProjection=function(t){const i=this,n=$.Deferred();var r;if((t=t||{}).crs){t.baseLayer?r=t.baseLayer:t.allowFallbackLayer&&(i.baseLayer.isCompatible(t.crs)||0!==i.baseLayer.wrap.getCompatibleMatrixSets(t.crs).length?i.baseLayer.firstOption&&(i.baseLayer.firstOption.isCompatible(t.crs)||i.baseLayer.firstOption.wrap.getCompatibleMatrixSets(t.crs).length>0)&&(r=i.baseLayer.firstOption):i.baseLayer.options.fallbackLayer&&(r=i.baseLayer.getFallbackLayer()));r||(r=i.baseLayer);if(i.baseLayers.indexOf(r)<0){i.baseLayers.push(r);const t=i.layers.reduce(e("isBase"),-1)+1;i.layers.splice(t,0,r)}TC.loadProjDef({crs:t.crs,callback:function(){r.getCapabilitiesPromise().then(function(){const e=$.extend({},t,{oldCrs:i.crs}),s=function(t){t.setProjection(e)};if(r.isCompatible(t.crs)||r.wrap.getCompatibleMatrixSets(t.crs).length>0){r.setProjection(e);i.wrap.setProjection($.extend({},t,{baseLayer:r}));i.crs=t.crs;i.baseLayers.filter(function(e){return e!==r}).forEach(s);i.workLayers.forEach(s);const a=function(){i.$events.trigger($.Event(TC.Consts.event.PROJECTIONCHANGE,{crs:t.crs}));n.resolve()};r&&r!==i.baseLayer?i.setBaseLayer(r,a):a()}else n.reject()})}})}return n.promise()};o.getMetersPerUnit=function(){return this.wrap.getMetersPerUnit()};o.getCoordinateFromPixel=function(e){return this.wrap.getCoordinateFromPixel(e)};o.getPixelFromCoordinate=function(e){return this.wrap.getPixelFromCoordinate(e)};o.zoomToFeatures=function(e,t){if(e.length>0){var i=[1/0,1/0,-1/0,-1/0],n=t||{},r=n.pointBoundsRadius||this.options.pointBoundsRadius;r/=this.getMetersPerUnit();var s=n.extentMargin;"number"!=typeof s&&(s=this.options.extentMargin);for(var a=0;a<e.length;a++){var o=e[a].getBounds();if(o){i[0]=Math.min(i[0],o[0]);i[1]=Math.min(i[1],o[1]);i[2]=Math.max(i[2],o[2]);i[3]=Math.max(i[3],o[3])}}if(i[2]-i[0]==0){i[0]=i[0]-r;i[2]=i[2]+r}if(i[3]-i[1]==0){i[1]=i[1]-r;i[3]=i[3]+r}if(this.options.extentMargin){var l=(i[2]-i[0])*s/2,c=(i[3]-i[1])*s/2;i[0]=i[0]-l;i[1]=i[1]-c;i[2]=i[2]+l;i[3]=i[3]+c}if(this.options.maxExtent){i[0]=Math.max(i[0],this.options.maxExtent[0]);i[1]=Math.max(i[1],this.options.maxExtent[1]);i[2]=Math.min(i[2],this.options.maxExtent[2]);i[3]=Math.min(i[3],this.options.maxExtent[3])}this.wrap.setExtent(i,n);this.$events.trigger($.Event(TC.Consts.event.ZOOMTO,{extent:i}))}};o.zoomToMarkers=function(e){var t=this;$.when.apply(this,t._markerDeferreds).then(function(){for(var i=[],n=0;n<t.workLayers.length;n++){var r=t.workLayers[n];if(r.type===TC.Consts.layerType.VECTOR)for(var s=0;s<r.features.length;s++){var a=r.features[s];a instanceof TC.feature.Marker&&(i[i.length]=a)}}for(n=0;n<arguments.length;n++)i[i.length]=arguments[n];t.zoomToFeatures(i,e);t._markerDeferreds=[]})};o.getLayer=function(e){var t=null;if("string"==typeof e){for(var i=0;i<this.layers.length;i++)if(this.layers[i].id===e){t=this.layers[i];break}}else TC.Layer&&e instanceof TC.Layer&&(t=e);return t};var c=function(e){var t;if(e.vectors)t=e.vectors;else{t=e.addLayer({id:TC.getUID(),title:TC.i18n[e.options.locale].vectors,type:TC.Consts.layerType.VECTOR});e.vectors=t;t.then(function(t){e.vectors=t})}return t};o.addPoint=function(e,t){if(t&&t.layer){var i=this.getLayer(t.layer);i&&i.addPoint(e,t)}else $.when(c(this)).then(function(i){i.addPoint(e,t)})};o.addMarker=function(e,t){if(t&&t.layer){var i=this.getLayer(t.layer);i&&this._markerDeferreds.push(i.addMarker(e,t))}else{var n=new $.Deferred;this._markerDeferreds.push(n);$.when(c(this)).then(function(i){$.when(i.addMarker(e,t)).then(function(e){n.resolve(e)})})}};o.addPolyline=function(e,t){if(t&&t.layer){this.getLayer(t.layer)&&t.layer.addPolyline(e,t)}else $.when(c(this)).then(function(i){i.addPolyline(e,t)})};o.addPolygon=function(e,t){if(t&&t.layer){this.getLayer(t.layer)&&t.layer.addPolygon(e,t)}else $.when(c(this)).then(function(i){i.addPolygon(e,t)})};o.getBaseLayer=function(){return this.baseLayer||this.baseLayers[0]};o.getResolutions=function(){return this.wrap.getResolutions()};o.getResolution=function(){return this.wrap.getResolution()};o.setResolution=function(e){this.wrap.setResolution(e)};o.exportFeatures=function(e,t){var i=t||{},n=this.getLoadingIndicator(),r=n&&n.addWait(),s=this.wrap.exportFeatures(e,i),a=TC.Consts.mimeType[i.format],o=i.format||"";TC.Util.downloadFile((i.fileName||TC.getUID())+"."+o.toLowerCase(),a,s);n&&n.removeWait(r)};var u={},h=function(){var e=$(this),t=e.parent(".tc-toast-container"),i=e.html();e.addClass(TC.Consts.classes.HIDDEN);void 0!==u[i]&&(u[i]=void 0);setTimeout(function(){e.remove();t.find(".tc-toast").length||t.remove()},1e3)};o.toast=function(e,t){var i=t||{},n=i.duration||TC.Cfg.toastDuration,r=u[e];if(r){clearTimeout(r.timeout);r.$toast.remove()}var s=this._$div.find(".tc-toast-container");s.length||(s=$("<div>").addClass("tc-toast-container").appendTo(this._$div));r=u[e]={$toast:$("<div>").addClass("tc-toast").html(e).appendTo(s).on(TC.Consts.event.CLICK,h)};var a="";switch(i.type){case TC.Consts.msgType.INFO:a=TC.Consts.classes.INFO;break;case TC.Consts.msgType.WARNING:a=TC.Consts.classes.WARNING;break;case TC.Consts.msgType.ERROR:a=TC.Consts.classes.ERROR}r.$toast.addClass(a);r.timeout=setTimeout(function(){h.call(r.$toast)},n)};var p=!1,d=function(e){if(/iPad/i.test(navigator.userAgent)){var t=window.innerHeight;e.height()===t+(Modernizr.mq("only screen and (orientation : landscape)")?20:0)&&(p=!0)}var i=function(){e.toggleClass(TC.Consts.classes.IPAD_IOS7_FIX,Modernizr.mq("only screen and (orientation : landscape)"))};if(p){i();$(window).on("resize",i)}else $(window).off("resize",i)},f=function(e){return"string"==typeof e||e.type!==TC.Consts.layerType.VECTOR&&e.type!==TC.Consts.layerType.KML&&e.type!==TC.Consts.layerType.WFS};o.exportImage=function(){var e=null,t="El mapa actual no es compatible con la exportaci\xf3n de im\xe1genes",i=this.wrap.getViewport({synchronous:!0}).getElementsByTagName("canvas")[0];if(i&&this.options.crossOrigin)try{e=i.toDataURL()}catch(e){TC.error(t+": "+e.message)}else TC.error(t);return e}}();var TC=TC||{};!function(e,t){"object"==typeof exports?module.exports=t():"function"==typeof define&&define.amd?define([],t):e.Util=t()}(TC,function(){String.prototype.soundex=function(){var e=this.toLowerCase().split("");f=e.shift(),r="",codes={a:"",e:"",i:"",o:"",u:"",b:1,f:1,p:1,v:1,c:2,g:2,j:2,k:2,q:2,s:2,x:2,z:2,d:3,t:3,l:4,m:5,n:5,r:6};r=f+e.map(function(e,t,i){return codes[e]}).filter(function(e,t,i){return 0===t?e!==codes[f]:e!==i[t-1]}).join("");return(r+"000").slice(0,4).toUpperCase()};Number.isInteger=Number.isInteger||function(e){return"number"==typeof e&&isFinite(e)&&Math.floor(e)===e};var e=Number.prototype.toLocaleString;Number.prototype.toLocaleString=function(t,i){if("eu-ES"!=t||TC.Util.detectIE())return e.apply(this,arguments);var n=e.apply(this,arguments);n=n.replace(/\,/g,".");Math.floor(this)==this&&Number.isInteger(Math.floor(this))||(n=n.replace(/.([^.]*)$/,",$1"));return n};var t={},s={},a=["Capability","Request","GetMap","DCPType","0","HTTP","Get","OnlineResource"],o=["OperationsMetadata","GetTile","DCP","HTTP","Get","0","href"],l=function(e,t,i){return i<t.length-1?e.hasOwnProperty(t[i])?l(e[t[i]],t,++i):null:e[t[i]]},c={getMapLocale:function(e){return e.options&&e.options.locale&&e.options.locale.replace("_","-")||"es-ES"},regex:{PROTOCOL:/(^https?:)/i},isOnCapabilities:function(e){var t=2!=arguments.length||arguments[1],i=t?e:e.replace(TC.Util.regex.PROTOCOL,"");if(t){if(TC.capabilities[i])return e}else for(var n in TC.capabilities)if(n.replace(TC.Util.regex.PROTOCOL,"")==i)return n;for(n in TC.capabilities){var r=l(TC.capabilities[n],a,0)||l(TC.capabilities[n],o,0);if(r&&t&&e==r)return r;if(r&&e.replace(TC.Util.regex.PROTOCOL,"")==r.replace(TC.Util.regex.PROTOCOL,""))return r}return e},reqGetMapOnCapabilities:function(e){var t,i,n=2!=arguments.length||arguments[1];n||e.replace(TC.Util.regex.PROTOCOL,"");return TC.capabilities[e]?(t=TC.capabilities[e],(i=l(t,a,0)||l(t,o,0))?n?i.split("?")[0]:i.split("?")[0].replace(TC.Util.regex.PROTOCOL,""):null):null},getFNFromString:function(e){var t=window,n=e.split(".");for(i=0;i<n.length-1;i++)if(void 0==(t=t[n[i]]))return;return t[n[n.length-1]]},isURL:function(e){return/^(http|https|ftp|mailto)\:\/\//i.test(e)},isSecureURL:function(e){return!/^(f|ht)tps?:\/\//i.test(e)||/^(f|ht)tps:\/\//i.test(e)},isSameOrigin:function(e){var t=0!==e.indexOf("http")&&0!==e.indexOf("//"),i=!t&&e.match(TC.Consts.url.SPLIT_REGEX);if(i){var n=window.location,r=i[1];t=(r==n.protocol||void 0==r)&&i[3]==n.hostname;var s=i[4],a=n.port;(80!=s&&""!==s||"80"!=a&&""!==a)&&(t=t&&s==a)}return t},formatNumber:function(e,t){var i=typeof e;if("number"===i)return e.toLocaleString(t);if("string"===i){n=parseFloat(e);if(n===new Number(e).valueOf())return n.toLocaleString(t)}return e},addProtocol:function(e){var t=e;e&&0===e.indexOf("//")&&(t=location.protocol+e);return t},getDiv:function(e){return"string"==typeof e?document.getElementById(e):1==$(e).length?e:document.createElement("div")},getScriptLocation:function(){var e,t;if(document.currentScript)t=document.currentScript;else{var i=document.getElementsByTagName("script");t=i[i.length-1]}return(e=t.getAttribute("src"))?e.substr(0,e.lastIndexOf("/")+1):""},getBackgroundUrlFromCss:function(e){var i="";if(e)if(void 0!==t[e])i=t[e];else{var n=$('<div style="display:none">').addClass(e).appendTo("body"),r=/^url\(['"]?(.*?)['"]?\)$/gi.exec(n.css("background-image"));r&&r.length>1&&(i=r[r.length-1]);n.remove();t[e]=i}return i},getPointIconUrl:function e(t){var i=null;if(t.url)i=t.url;else{var n;if("string"==typeof t.cssClass)n=t.cssClass;else{var r=t.classes||TC.Cfg.styles.marker.classes;n=r[0];if(t.group){if(void 0===s[t.group]){var a=0;for(var o in s)a++;a%=r.length;s[t.group]=r[a]}n=s[t.group]}}i=TC.Util.getBackgroundUrlFromCss(n)}i||t===TC.Cfg.styles.point||""===t.cssClass||(i=e(TC.Cfg.styles.point));return i},addArrayToTree:function e(t,i,n){var r=null,s=!1,a=t[n=n||0];if(a){for(var o,l=0,c=i.children.length;l<c;l++)if((o=i.children[l]).name===a){s=!0;var u=e(t,o,n+1);u&&(r=u);break}if(!s){o={name:a,title:a,uid:"/"+t.slice(0,n+1).join("/"),children:[]};i.children.push(o);r=o}}return r},parseCoords:function(e){var t=null,i=function(e){var t=e,i={};i.type=TC.Consts.GEOGRAPHIC;var n=t.indexOf("\xb0");i.value=parseFloat(t.substr(0,n));if((n=(t=t.substr(n+1)).indexOf("'"))>=0){var r=parseFloat(t.substr(0,n))/60;i.value>=0?i.value+=r:i.value-=r;if((n=(t=t.substr(n+1)).indexOf("'"))>=0){r=parseFloat(t.substr(0,n).replace(",","."))/3600;i.value>=0?i.value+=r:i.value-=r}}return i},n=function(e){var t=$.trim(e);if(t.match(/^1?\d{0,2}\s*\u00B0(\s*\d{1,2}\s*'(\s*\d{1,2}([.,]\d+)?\s*'')?)?\s*[NnSsWwOoEe]$/g)){switch(t[t.length-1]){case"S":case"s":case"W":case"w":case"O":case"o":t="-"+t}t=t.substr(0,t.length-1);return i(t)}if(t.match(/^[+-]?1?\d{0,2}\s*\u00B0(\s*\d{1,2}\s*'(\s*\d{1,2}([.,]\d+)?\s*'')?)?$/g))return i(t);if(t.match(/^1?\d{0,2}([.,]\d+)?\s*\u00B0?\s*[NnSsWwOoEe]$/g)){var n={type:TC.Consts.GEOGRAPHIC,value:parseFloat(t.substr(0,t.length-1).replace(",","."))};t.match(/[SsWwOo]$/)&&(n.value=-n.value);return n}return t.match(/^[+-]?1?\d{0,2}([.,]\d+)?\s*\u00B0?$/g)?{type:TC.Consts.GEOGRAPHIC,value:parseFloat(t.replace(",","."))}:t.match(/^\d{6,7}([.,]\d+)?$/g)?{type:TC.Consts.UTM,value:parseFloat(t.replace(",","."))}:null},r=(e=$.trim(e).toUpperCase()).split(",");4===r.length?r=[r.slice(0,1).join("."),r.slice(2,3).join(".")]:1!==r.length&&3!==r.length||(r=e.split(" "));if(2===r.length){var s=n(r[0]),a=n(r[1]);null!==s&&null!==a&&(t=[s,a])}return t},reproject:function(e,t,i){var n,r=!0,s=!0,a=!0;if($.isArray(e[0]))if($.isArray(e[0][0])){if(!$.isArray(e[0][0][0])){a=!1;e=[e]}}else{s=!1;e=[[e]]}else{r=!1;s=!1;a=!1;e=[[[e]]]}TC.loadProjDef({crs:t,sync:!0});TC.loadProjDef({crs:i,sync:!0});var o=new Proj4js.Proj(t),l=new Proj4js.Proj(i);n=new Array(e.length);e.forEach(function(e,t){const i=n[t]=[];e.forEach(function(e,t){const n=i[t]=[];e.forEach(function(e,t){var i=Proj4js.transform(o,l,{x:e[0],y:e[1]});n[t]=[i.x,i.y];e.length>2&&(n[t][2]=e[2])})})});r?s?a||(n=n[0]):n=n[0][0]:n=n[0][0][0];return n},getMetersPerDegree:function(e){var t=void 0;if($.isArray(e)&&e.length>=4){var i=this.degToRad(e[3]-e[1]),n=Math.sin(i/2),r=n*n;t=6370997*(2*Math.atan2(Math.sqrt(r),Math.sqrt(1-r)))/(e[3]-e[1])}return t},radToDeg:function(e){return 180*e/Math.PI},degToRad:function(e){return e*Math.PI/180},mod:function(e){return(e%(2*Math.PI)+2*Math.PI)%(2*Math.PI)},getCRSCode:function(e){var t=null;e=e.trim();if(/^EPSG:\d{4,6}$/g.test(e)||/^urn:ogc:def:crs:EPSG:.*:\d{4,6}/g.test(e)||/http:\/\/www.opengis.net\/gml\/srs\/epsg.xml#\d{4,6}$/g.test(e)){var i=e.trim().match(/^.+[:#](\d{4,6})$/);i&&(t=i[1])}return t},CRSCodesEqual:function(e,t){if(e===t)return!0;var i=this.getCRSCode(e),n=this.getCRSCode(t);return null!==i&&null!==n&&i===n},getLocaleString:function(e,t,i){var n=t;if(TC.i18n&&TC.i18n[e]){var r=TC.i18n[e][t];if(r){n=r;if(i)for(var s in i)n=n.replace("{"+s+"}",i[s])}}return n},getSimpleMimeType:function(e){var t="";if(e){var i=e.indexOf(";");i>0&&(e=e.substring(0,i));t=e}return t},getQueryStringParams:function(e){var t;if(e){var i=e.indexOf("?");if(i>=0){var n=(t=e.substr(i)).indexOf("#");n>=0&&(t=t.substr(0,n))}else t="?"}else t=location.search;var r=$.map(t.replace(/(^\?)/,"").split("&"),function(e){return this[(e=e.split("="))[0]]=e[1],this}.bind({}))[0];delete r[""];return r},fastUnshift:function(e,t){for(var i=e.length;i;){e[i]=e[i-1];i--}e[0]=t},storage:{getCookie:function(e){return $.cookie(e)},setCookie:function(e,t,i){return $.cookie(e,t,i)},getLocalValue:function(e){return localStorage&&localStorage instanceof Storage?localStorage.getItem(e):TC.Util.storage.getCookie(e)},setLocalValue:function(e,t){if(localStorage&&localStorage instanceof Storage)void 0===t?localStorage.removeItem(e):localStorage.setItem(e,t);else if(void 0===t){var i=new Date;i.setDate(i.getDate()-1);TC.Util.storage.setCookie(e,"",{expires:i})}else TC.Util.storage.setCookie(e,t);return e},getSessionLocalValue:function(e){return sessionStorage&&sessionStorage instanceof Storage?sessionStorage.getItem(e):TC.Util.storage.getCookie(e)},setSessionLocalValue:function(e,t){if(sessionStorage&&sessionStorage instanceof Storage)void 0===t?sessionStorage.removeItem(e):sessionStorage.setItem(e,t);else if(void 0===t){var i=new Date;i.setDate(i.getDate()-1);TC.Util.storage.setCookie(e,"",{expires:i})}else TC.Util.storage.setCookie(e,t);return e}},detectFirefox:function(){return!!/Firefox[\/\s](\d+\.\d+)/.test(navigator.userAgent)&&new Number(RegExp.$1)},detectIE:function(){var e=window.navigator.userAgent,t=e.indexOf("MSIE ");if(t>0)return parseInt(e.substring(t+5,e.indexOf(".",t)),10);if(e.indexOf("Trident/")>0){var i=e.indexOf("rv:");return parseInt(e.substring(i+3,e.indexOf(".",i)),10)}var n=e.indexOf("Edge/");return n>0&&parseInt(e.substring(n+5,e.indexOf(".",n)),10)},detectChrome:function(){return window.chrome},detectSafari:function(){return!!navigator.userAgent.match(/Version\/[\d\.]+.*Safari/)},detectMouse:function(){if(Modernizr.mq("(pointer:coarse)")&&Modernizr.mq("(pointer:fine)"))return!0;if(Modernizr.mq("(pointer:coarse)")&&!Modernizr.mq("(pointer:fine)")){return!!function(){var e,t="(hover: hover)",i=!Modernizr.touch;"matchMedia"in window?(e=window.matchMedia(t)).media===t&&(i=e.matches):console.log("no dispone de matchMedia");return i}()}return!(Modernizr.mq("(pointer:coarse)")||!Modernizr.mq("(pointer:fine)"))||!Modernizr.mq("(pointer:none)")&&(!Modernizr.touch||void 0)},detectAndroid:function(){return navigator.userAgent.match(/Android/i)},detectBlackBerry:function(){return navigator.userAgent.match(/BlackBerry/i)},detectIOS:function(){return navigator.userAgent.match(/iPhone|iPad|iPod/i)},detectMobileWindows:function(){return navigator.userAgent.match(/IEMobile/i)},detectMobile:function(){return TC.Util.detectAndroid()||TC.Util.detectIOS()||TC.Util.detectMobileWindows()||TC.Util.detectBlackBerry()},getBrowser:function(){window.UAParser||TC.syncLoadJS(TC.apiLocation+TC.Consts.url.UA_PARSER);var e=(new UAParser).getBrowser();return{name:e.name,version:e.major}},getElementByNodeName:function(e,t){for(var i=t.indexOf(":"),n=t.substr(i+1),r=e.getElementsByTagNameNS("*",n),s=0;s<r.length;s++)if(r[s].nodeName==t)return r},addURLParameters:function(e,t){if(!t)return e;var i=Object.keys(t).map(function(e){return encodeURIComponent(e)+"="+(t[e]?encodeURIComponent(t[e]):"")}).join("&"),n=e.split("?");if(n.length>=2){var r=n[1].split(/[&;]/g);r.push(i);return e=n[0]+"?"+r.join("&")}if((n=e.split("#")).length>=2){n.shift();return e=n[0]+"?"+i+"#"+n.join("#")}return e=e+"?"+i},removeURLParameter:function(e,t){var i=e.split("?");if(i.length>=2){for(var n=encodeURIComponent(t.toLowerCase())+"=",r=i[1].toLowerCase().split(/[&;]/g),s=r.length;s-- >0;)-1!==r[s].lastIndexOf(n,0)&&r.splice(s,1);return e=i[0]+"?"+r.join("&")}return e},showModal:function(e,t){var i=$(e);t=t||{};i.off("click").removeAttr("hidden");i.fadeIn(250,function(){i.on("click",".tc-modal-close",function(e){e.stopPropagation();return TC.Util.closeModal(t.closeCallback)});$.isFunction(t.openCallback)&&t.openCallback()})},closeModal:function(e){$(".tc-modal").hide().find(".tc-modal-window").removeAttr("style").off();e&&e()},closeAlert:function(e){$(e).parents(".tc-alert").hide()},getParameterByName:function(e){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var t=new RegExp("[\\?&]"+e+"=([^&#]*)","i").exec(location.search);return null===t?"":decodeURIComponent(t[1].replace(/\+/g," "))},getLocaleUserChoice:function(e){var t="en-US",i=(e=e||{}).cookieName||"SITNA.language",n=e.paramName||"lang",r=navigator.languages&&navigator.languages.length?navigator.languages[0]:navigator.language||navigator.userLanguage,s=TC.Util.getParameterByName(n)||TC.Util.storage.getCookie(i)||r,a=s.indexOf("-");a>=0&&(s=s.substr(0,a));var o=new Date((new Date).getTime()+31536e6);TC.Util.storage.setCookie(i,s,{expires:o});switch(s){case"eu":t="eu-ES";break;case"es":t="es-ES";break;default:t="en-US"}return t},downloadBlob:function(e,t){var i=document.createElement("a");if(void 0!==i.download){var n=URL.createObjectURL(t);i.setAttribute("href",n);i.setAttribute("download",e);i.style.visibility="hidden";document.body.appendChild(i);i.click();document.body.removeChild(i)}},downloadFile:function(e,t,i){var n=new Blob([i],{type:t});navigator.msSaveBlob?navigator.msSaveBlob(n,e):TC.Util.downloadBlob(e,n)},downloadDataURI:function(e,t,i){for(var n=atob(i.split(",")[1]),r=[],s=0;s<n.length;s++)r.push(n.charCodeAt(s));var a=new Blob([new Uint8Array(r)],{type:t});navigator.msSaveBlob?navigator.msSaveBlob(a,e):TC.Util.downloadBlob(e,a)},shortenUrl:function(e){var t;$.ajax({url:"https://api-ssl.bitly.com/v3/shorten",data:{access_token:"6c466047309f44bd8173d83e81491648b243ee3d",longUrl:e},async:!1}).done(function(e){t=e.data.url});return t},utf8ToBase64:function(e){return window.btoa(unescape(encodeURIComponent(e)))},base64ToUtf8:function(e){var t;try{t=decodeURIComponent(escape(window.atob(e)))}catch(e){t=null}return t},colorArrayToString:function(e){$.isArray(e)&&(e=e.slice(0,3).reduce(function(e,t){const i=t.toString(16);return e+"00".substring(0,2-i.length)+i},"#"));return e},operation:function(e,t,i,n){for(var r=[],s=0;s<e.length;s++){for(var a=e[s],o=!1,l=0;l<t.length;l++)if(i(a,t[l])){o=!0;break}o===n&&r.push(a)}return r},isSecureURL:function(e){return!/^(f|ht)tps?:\/\//i.test(e)||/^(f|ht)tps:\/\//i.test(e)},inBoth:function(e,t,i){return this.operation(e,t,i,!0)},inFirstOnly:function(e,t,i){return this.operation(e,t,i,!1)},inSecondOnly:function(e,t,i){return this.inFirstOnly(t,e,i)},toDataUrl:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{type:"image/png",encoderOptions:.92},n=i.type,r=i.encoderOptions,s=e.getContext("2d");if(!s)return"";var a=e.width,o=e.height,l=s.getImageData(0,0,a,o),c=s.globalCompositeOperation;if(t){s.globalCompositeOperation="destination-over";s.fillStyle=t;s.fillRect(0,0,a,o)}var u=e.toDataURL(n,r);if(t){s.clearRect(0,0,a,o);s.putImageData(l,0,0);s.globalCompositeOperation=c}return u},imgToDataUrl:function(e,t){var i=function(e){var t=document.createElement("CANVAS"),i=t.getContext("2d");t.height=e.height;t.width=e.width;i.drawImage(e,0,0);return t},n=$.Deferred(),r=new Image;r.crossOrigin="anonymous";r.onload=function(){var s,a=i(r);try{s=TC.Util.toDataUrl(a,"#ffffff",{type:t||"image/jpeg",encoderOptions:1});n.resolve(s,a)}catch(t){r.src=TC.proxify(e)}};r.onerror=function(s){var a=new XMLHttpRequest;a.open("GET",TC.proxify(e),!0);a.setRequestHeader("Content-Type","application/x-www-form-urlencoded");a.responseType="arraybuffer";a.onload=function(e){if(200===this.status){for(var s=new Uint8Array(this.response),o=s.length,l=new Array(o);o--;)l[o]=String.fromCharCode(s[o]);var c=l.join(""),u=a.getResponseHeader("content-type");if(0===u.indexOf("image")){r.src="data:"+u+";base64,"+window.btoa(c);r.onload=function(){var e=i(r);dataURL=TC.Util.toDataUrl(e,"#ffffff",{type:t||"image/jpeg",encoderOptions:1});n.resolve(dataURL,e)}}}};a.onreadystatechange=function(){4===a.readyState&&200!==a.status&&n.reject()};a.send()};r.src=e;if(r.complete||void 0===r.complete){r.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==";r.src=e}return n.promise()},imgTagToDataUrl:function(e,t){var i=function(e){var t=document.createElement("CANVAS"),i=t.getContext("2d");t.height=e.height;t.width=e.width;i.drawImage(e,0,0);return t}(e);try{return{base64:TC.Util.toDataUrl(i,"#ffffff",{type:t||"image/jpeg",encoderOptions:1}),canvas:i}}catch(e){return null}},addToCanvas:function(e,t,i){var n=TC.Util.cloneCanvas(e),r=$.Deferred(),s=n.getContext("2d"),a=new Image;t.crossOrigin="anonymous";a.src=t;a.onload=function(){s.drawImage(a,i.x||0,i.y||0);r.resolve(n)};return r.promise()},cloneCanvas:function(e){var t=document.createElement("canvas"),i=t.getContext("2d");t.width=e.width;t.height=e.height;i.drawImage(e,0,0);return t},calculateAspectRatioFit:function(e,t,i,n){var r=Math.min(i/e,n/t);return{width:e*r,height:t*r}},getFormattedDate:function(e,t){function i(e){return e<10?"0"+e:e}var n=new Date(e);return[n.getFullYear(),i(n.getMonth()+1),i(n.getDate())].concat(t?["_",i(n.getHours()),i(n.getMinutes()),i(n.getSeconds())]:[]).join("")},replaceAccent:function(e){var t={"\xe4":"a","\xf6":"o","\xfc":"u","\xc4":"A","\xd6":"O","\xdc":"U","\xe1":"a","\xe9":"e",i:"i","\xf3":"o","\xfa":"u","\xc1":"A","\xc9":"E","\xcd":"I","\xd3":"O","\xda":"U","\xf1":"n","\xd1":"N"};return e.replace(/[\xf6\xe4\xfc\xd6\xc4\xdc\xe1\xe9\xed\xf3\xfa\xc1\xc9\xcd\xd3\xda\xf1\xd1]/g,function(e){return t[e]})},downloadFileForm:function(e,t){var i=function(e,t){var i=$("<form/>",{class:"tc-ctl-download-form",method:"post",enctype:"text/plain",action:TC.Util.detectIE()?TC.proxify(e):e}),n=$("<input/>",{class:"tc-ctl-download-query",name:t.substring(0,t.indexOf("="))});i.append(n);var r=$("iframe").filter(function(t,i){return $(i).data("url-download")===e});if(r.length>0)r=r.first();else{(r=$('<iframe style="visibility: hidden; display:none;"></iframe>')).data("url-download",e);$("body").append(r)}var s=r[0].contentDocument;s.open();s.write(i[0].outerHTML);s.close();$("input",s).val(t.substring(t.indexOf("=")+1));return i=$("form",s)},n=[];if(jQuery.isArray(e))for(var r=e,s=0;s<r.length;s++)n.push(i(r[s].url,r[s].data));else n.push(i(e,t));$(n).submit();setTimeout(function(){$(".tc-ctl-download-form").remove()},1e3)},WFSQueryBuilder:function(e,t,i,n,r){$.isArray(e)||(e=[e]);var s='xsi:schemaLocation="http://www.opengis.net/wfs http://schemas.opengis.net/wfs/1.1.0/wfs.xsd" xmlns:ogc="http://www.opengis.net/ogc" service="WFS" {resultType} {format} ';switch(i.version){case"1.0.0":case"1.1.0":s+='xmlns:gml="http://www.opengis.net/gml" xmlns:wfs="http://www.opengis.net/wfs" ';break;case"2.0.0":s+='xmlns:wfs="http://www.opengis.net/wfs/2.0" xmlns:gml="http://www.opengis.net/gml/3.2" '}for(var a in i)"string"==typeof i[a]&&a.indexOf("gml")<0&&i[a].indexOf("wfs")<0&&(s+=a+'="'+i[a]+'" ');var o="<wfs:GetFeature "+s.format({resultType:r?'resultType="hits"':"",format:'outputFormat="'+n+'"'})+">",l="",c="<wfs:Query typeName"+("2.0.0"===i.version?"s":"")+'="{typeName}">{filter}</wfs:Query>';$.each(e,function(e,n){l+=c.format({typeName:n,filter:t?t.getText(i.version):""})});return o+=l+"</wfs:GetFeature>"},WFSFilterBuilder:function(e,t){var i="";if(jQuery.isPlainObject(e))i='<{prefix}:Filter><{prefix}:Intersects><fes:ValueReference></fes:ValueReference><{prefix}:Function name="querySingle"><{prefix}:Literal>{clipLayer}</{prefix}:Literal><{prefix}:Literal>{geometryName}</{prefix}:Literal><{prefix}:Literal>{where}</{prefix}:Literal></{prefix}:Function></{prefix}:Intersects></{prefix}:Filter>'.format({prefix:"2.0.0"===t?"fes":"ogc",clipLayer:e.clipLayer,geometryName:e.geometryName,where:e.where});else switch(!0){case!e:break;case $.isArray(e):var n="<gml:Envelope><gml:lowerCorner>{lowerCorner}</gml:lowerCorner><gml:upperCorner>{upperCorner}</gml:upperCorner></gml:Envelope>".format({lowerCorner:e[0]+" "+e[1],upperCorner:e[2]+" "+e[3]});switch(!0){case"1.0.0"===t:case"1.1.0"===t:i+="<ogc:Filter><ogc:BBOX>"+n+"</ogc:BBOX></ogc:Filter>";break;case"2.0.0"===t:i+="<fes:Filter><fes:BBOX>"+n+"</fes:BBOX></fes:Filter>"}break;case e instanceof TC.Feature:switch(!0){case"1.0.0"===t:case"1.1.0"===t:i+="<ogc:Filter><ogc:Intersects><ogc:PropertyName></ogc:PropertyName>"+TC.Util.writeGMLGeometry(e,"2.0")+"</ogc:Intersects></ogc:Filter>";break;case"2.0.0"===t:i+="<fes:Filter><fes:Intersects><fes:ValueReference></fes:ValueReference>"+TC.Util.writeGMLGeometry(e,"3.2")+"</fes:Intersects></fes:Filter>"}break;default:TC.error("Geometr\xeda no v\xe1lida")}return i},writeGMLGeometry:function(e,t){var i=function(e){var i;if(0===t.indexOf("3")){i=e.toString();for(;i.indexOf(",")>=0;)i=i.replace(","," ")}else{i=e;jQuery.each(i,function(e,t){return t.join(",")}).join(" ")}return i};switch(t){case"3.1.1":break;case"3.2":switch(!0){case TC.feature.Polyline&&e instanceof TC.feature.Polyline:return'<gml:LineString srsDimension="2"><gml:posList>'+i(e.geometry)+"</gml:posList></gml:LineString>";default:return'<gml:Polygon srsDimension="2"><gml:exterior><gml:LinearRing><gml:posList>'+i(e.geometry[0])+"</gml:posList></gml:LinearRing></gml:exterior></gml:Polygon>"}break;case"2.0":default:switch(!0){case TC.feature.Polyline&&e instanceof TC.feature.Polyline:return"<gml:LineString><gml:coordinates>"+i(e.geometry[0])+"</gml:coordinates></gml:LineString>";default:return"<gml:Polygon><gml:outerBoundaryIs><gml:LinearRing><gml:coordinates>"+i(e.geometry[0])+"</gml:coordinates></gml:LinearRing></gml:outerBoundaryIs></gml:Polygon>"}}},isServiceWorker:function(){return!!navigator.serviceWorker&&!(!navigator.serviceWorker.controller||"activated"!==navigator.serviceWorker.controller.state)},isSameOriginByLocation:function(e,t){var i=0!==e.indexOf("http")&&0!==e.indexOf("//"),n=!i&&e.match(TC.Consts.url.SPLIT_REGEX);if(n){var r=n[1];i=(r==t.protocol||void 0==r)&&n[3]==t.hostname;var s=n[4],a=t.port;(80!=s&&""!==s||"80"!=a&&""!==a)&&(i=i&&s==a)}return i},isSameProtocol:function(e,t){var i=/^(https?:\/\/)/i,n=e.match(i);if(n&&n.length>1){var r=t.match(i);if(r&&r.length>1)return n[0].trim()===r[0].trim()}return!1},consoleRegister:function(e){TC.isDebug&&console.log(e)},getSorterByProperty:function(e){return function(t,i){return t[e]>i[e]?1:t[e]<i[e]?-1:0}},getSoundexDifference:function(e,t){for(var i=0,n=0;n<e.length;n++)e.charAt(n)==t.charAt(n)&&i++;return i},toAbsolutePath:function(e){var t=document.createElement("a");t.href=e;return t.href}};String.prototype.format=function(){var e=this.toString();if(!arguments.length)return e;var t="string"==(t=typeof arguments[0])||"number"==t?arguments:arguments[0];for(arg in t)e=e.replace(RegExp("\\{"+arg+"\\}","gi"),t[arg]);return e};return c});loadjs=function(){var e=function(){},t={},i={},n={};function r(e,t){if(e){var r=n[e];if(i[e]=t,r)for(;r.length;)r[0](e,t),r.splice(0,1)}}function s(t,i){t.call&&(t={success:t}),i.length?(t.error||e)(i):(t.success||e)(t)}function a(t,i,n,r){var s,o,l=document,c=n.async,u=(n.numRetries||0)+1,h=n.before||e;r=r||0,/(^css!|\.css$)/.test(t)?(s=!0,(o=l.createElement("link")).rel="stylesheet",o.href=t.replace(/^css!/,"")):((o=l.createElement("script")).src=t,o.async=void 0===c||c),o.onload=o.onerror=o.onbeforeload=function(e){var l=e.type[0];if(s&&"hideFocus"in o)try{o.sheet.cssText.length||(l="e")}catch(e){l="e"}if("e"==l&&(r+=1)<u)return a(t,i,n,r);i(t,l,e.defaultPrevented)},!1!==h(t,o)&&l.head.appendChild(o)}function o(e,i,n){var o,l;if(i&&i.trim&&(o=i),l=(o?n:i)||{},o){if(o in t)throw"LoadJS";t[o]=!0}!function(e,t,i){var n,r,s=(e=e.push?e:[e]).length,o=s,l=[];for(n=function(e,i,n){if("e"==i&&l.push(e),"b"==i){if(!n)return;l.push(e)}--s||t(l)},r=0;r<o;r++)a(e[r],n,i)}(e,function(e){s(l,e),r(o,e)},l)}return o.ready=function(e,t){return function(e,t){var r,s,a,o=[],l=(e=e.push?e:[e]).length,c=l;for(r=function(e,i){i.length&&o.push(e),--c||t(o)};l--;)s=e[l],(a=i[s])?r(s,a):(n[s]=n[s]||[]).push(r)}(e,function(e){s(t,e)}),o},o.done=function(e){r(e,[])},o.reset=function(){t={},i={},n={}},o.isDefined=function(e){return e in t},o}();var TC=TC||{};TC.version="1.5.0";!function(){if(!TC.apiLocation){var e;if(document.currentScript)e=document.currentScript;else{var t=document.getElementsByTagName("script");e=t[t.length-1]}var i=e.getAttribute("src");TC.apiLocation=i.substr(0,i.lastIndexOf("/")+1)}}();if(!TC.Consts){TC.Consts={};TC.Consts.OLNS_LEGACY="OpenLayers";TC.Consts.OLNS="ol";TC.Consts.PROJ4JSOBJ_LEGACY="Proj4js";TC.Consts.PROJ4JSOBJ="proj4";TC.Consts.GEOGRAPHIC="geographic";TC.Consts.UTM="UTM";TC.Consts.OLD_BROWSER_ALERT="TC.oldBrowserAlert";TC.Consts.CLUSTER_ANIMATION_DURATION=200;TC.Consts.ZOOM_ANIMATION_DURATION=300;TC.Consts.URL_MAX_LENGTH=2048;TC.Consts.METER_PRECISION=0;TC.Consts.DEGREE_PRECISION=5;TC.Consts.EXTENT_TOLERANCE=.9998;TC.Consts.url={SPLIT_REGEX:/([^:]*:)?\/\/([^:]*:?[^@]*@)?([^:\/\?]*):?([^\/\?]*)/,MODERNIZR:"lib/modernizr.js",JQUERY_LEGACY:TC.apiLocation+"lib/jquery/jquery.1.10.2.js",JQUERY:"//ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.js",OL_LEGACY:"lib/OpenLayers/OpenLayers.sitna.js",OL:"lib/ol/build/ol-custom.js",OL_CONNECTOR_LEGACY:"TC/ol/ol2.js",OL_CONNECTOR:"TC/ol/ol.js",TEMPLATING:"lib/dust/dust-full-helpers.min.js",TEMPLATING_I18N:"lib/dust/dustjs-i18n.min.js",TEMPLATING_OVERRIDES:"lib/dust/dust.overrides.js",PROJ4JS_LEGACY:"lib/proj4js/legacy/proj4js-compressed.js",PROJ4JS:"lib/proj4js/proj4-src.js",EPSG:"https://epsg.io/",LOCALFORAGE:TC.apiLocation+"lib/localForage/localforage.min.js",D3C3:TC.apiLocation+"lib/d3c3/d3c3.min.js",CESIUM:TC.apiLocation+"lib/cesium/release/Cesium.js",JSNLOG:"lib/jsnlog/jsnlog.min.js",ERROR_LOGGER:TC.apiLocation+"errors/logger.ashx",PDFMAKE:TC.apiLocation+"lib/pdfmake/pdfmake-fonts.min.js",JSONPACK:"lib/jsonpack/jsonpack.min.js",UA_PARSER:"lib/ua-parser/ua-parser.min.js",HASH:"lib/jshash/md5-min.js",URL_POLYFILL:"lib/polyfill/url.js"};TC.Consts.classes={MAP:"tc-map",POINT:"tc-point",MARKER:"tc-marker",VISIBLE:"tc-visible",HIDDEN:"tc-hidden",COLLAPSED:"tc-collapsed",CHECKED:"tc-checked",DISABLED:"tc-disabled",ACTIVE:"tc-active",DEFAULT:"tc-default",LASTCHILD:"tc-lastchild",TRANSPARENT:"tc-transparent",DROP:"tc-drop",LOADING:"tc-loading",IPAD_IOS7_FIX:"tc-ipad-ios7-fix",INFO:"tc-msg-info",WARNING:"tc-msg-warning",ERROR:"tc-msg-error"};TC.Consts.msgType={INFO:"info",WARNING:"warning",ERROR:"error"};TC.Consts.msgErrorMode={TOAST:"toast",CONSOLE:"console",EMAIL:"email"};TC.Consts.event={MAPLOAD:"mapload.tc",MAPREADY:"mapready.tc",BEFORELAYERADD:"beforelayeradd.tc",LAYERADD:"layeradd.tc",LAYERREMOVE:"layerremove.tc",LAYERORDER:"layerorder.tc",BEFORELAYERUPDATE:"beforelayerupdate.tc",LAYERUPDATE:"layerupdate.tc",LAYERERROR:"layererror.tc",BEFOREBASELAYERCHANGE:"beforebaselayerchange.tc",BASELAYERCHANGE:"baselayerchange.tc",BEFOREUPDATE:"beforeupdate.tc",UPDATE:"update.tc",BEFOREZOOM:"beforezoom.tc",ZOOM:"zoom.tc",BEFOREUPDATEPARAMS:"beforeupdateparams.tc",UPDATEPARAMS:"updateparams.tc",VECTORUPDATE:"vectorupdate.tc",FEATUREADD:"featureadd.tc",BEFOREFEATURESADD:"beforefeaturesadd.tc",FEATURESADD:"featuresadd.tc",FEATUREREMOVE:"featureremove.tc",FEATURESCLEAR:"featuresclear.tc",FEATURESIMPORT:"featuresimport.tc",FEATURESIMPORTERROR:"featuresimporterror.tc",BEFORETILELOAD:"beforetileload.tc",TILELOAD:"tileload.tc",TILELOADERROR:"tileloaderror.tc",CONTROLADD:"controladd.tc",CONTROLACTIVATE:"controlactivate.tc",CONTROLDEACTIVATE:"controldeactivate.tc",BEFORECONTROLRENDER:"beforecontrolrender.tc",CONTROLRENDER:"controlrender.tc",BEFORELAYOUTLOAD:"beforelayoutload.tc",LAYOUTLOAD:"layoutload.tc",LAYERVISIBILITY:"layervisibility.tc",LAYEROPACITY:"layeropacity.tc",FEATURECLICK:"featureclick.tc",NOFEATURECLICK:"nofeatureclick.tc",FEATUREOVER:"featureover.tc",FEATUREOUT:"featureout.tc",BEFOREFEATUREINFO:"beforefeatureinfo.tc",FEATUREINFO:"featureinfo.tc",NOFEATUREINFO:"nofeatureinfo.tc",FEATUREINFOERROR:"featureinfoerror.tc",CLICK:"click.tc",MOUSEUP:"mouseup.tc",MOUSEMOVE:"mousemove.tc",MOUSELEAVE:"mouseleave.tc",STARTLOADING:"startloading.tc",STOPLOADING:"stoploading.tc",EXTERNALSERVICEADDED:"externalserviceadded.tc",ZOOMTO:"zoomto.tc",PROJECTIONCHANGE:"projectionchange.tc"};TC.Consts.layer={IDENA_ORTHOPHOTO:"ortofoto",IDENA_BASEMAP:"mapabase",IDENA_CADASTER:"catastro",IDENA_CARTO:"cartografia",IDENA_ORTHOPHOTO2014:"ortofoto2014",IDENA_ORTHOPHOTO2012:"ortofoto2012",IDENA_DYNBASEMAP:"mapabase_dinamico",IDENA_DYNORTHOPHOTO:"ortofoto_dinamico",IDENA_DYNORTHOPHOTO2014:"ortofoto2014_dinamico",IDENA_DYNORTHOPHOTO2012:"ortofoto2012_dinamico",IDENA_DYNCARTO:"cartografia_dinamico",IDENA_BW_RELIEF:"relieve_bn",IDENA_BASEMAP_ORTHOPHOTO:"base_orto",OSM:"osm",CARTO_VOYAGER:"carto_voyager",CARTO_LIGHT:"carto_light",CARTO_DARK:"carto_dark",MAPBOX_STREETS:"mapbox_streets",MAPBOX_SATELLITE:"mapbox_satellite",BLANK:"ninguno"};TC.Consts.text={API_ERROR:"Error API SITNA",APP_ERROR:"Error de aplicaci\xf3n"};TC.Consts.layerType={WMS:"WMS",WMTS:"WMTS",WFS:"WFS",VECTOR:"vector",KML:"KML",GPX:"GPX",GML:"GML",GEOJSON:"GeoJSON",GROUP:"group"};TC.Consts.geom={POINT:"point",MULTIPOINT:"multipoint",POLYLINE:"polyline",POLYGON:"polygon",MULTIPOLYLINE:"multipolyline",MULTIPOLYGON:"multipolygon",CIRCLE:"circle",RECTANGLE:"rectangle"};TC.Consts.searchType={CADASTRAL:"cadastral",COORDINATES:"coordinates",MUNICIPALITY:"municipality",COUNCIL:"council",LOCALITY:"locality",STREET:"street",NUMBER:"number",URBAN:"urban",COMMONWEALTH:"commonwealth",ROAD:"road",ROADPK:"roadpk",PLACENAME:"placename",PLACENAMEMUNICIPALITY:"placenamemunicipality"};TC.Consts.mapSearchType={MUNICIPALITY:TC.Consts.searchType.MUNICIPALITY,COUNCIL:TC.Consts.searchType.COUNCIL,URBAN:TC.Consts.searchType.URBAN,COMMONWEALTH:TC.Consts.searchType.COMMONWEALTH,GENERIC:"generic"};TC.Consts.comparison={EQUAL_TO:"==",NOT_EQUAL_TO:"!=",LESS_THAN:"<",GREATER_THAN:">",LESS_THAN_EQUAL_TO:"=<",GREATER_THAN_EQUAL_TO:">=",LIKE:"is"};TC.Consts.logicalOperator={AND:"and",OR:"or"};TC.Consts.WMTSEncoding={KVP:"KVP",RESTFUL:"RESTful"};TC.Consts.mimeType={PNG:"image/png",JPEG:"image/jpeg",JSON:"application/json",GEOJSON:"application/vnd.geo+json",KML:"application/vnd.google-earth.kml+xml",GML:"application/gml+xml",GPX:"application/gpx+xml",XML:"application/xml"};TC.Consts.format={JSON:"JSON",KML:"KML",GML:"GML",GML2:"GML2",GML3:"GML2",GEOJSON:"GeoJSON",TOPOJSON:"TopoJSON",GPX:"GPX",WKT:"WKT"};TC.Consts.WFSErrors={GetFeatureNotAvailable:"GetFeatureNotAvailable",LayersNotAvailable:"LayersNotAvailable",NoLayers:"NoLayers",NoValidLayers:"noValidLayers",QueryNotAvailable:"QueryNotAvailable",CapabilitiesParseError:"CapabilitiesParseError",NumMaxFeatures:"NumMaxFeatures",GetCapabilities:"GetCapabilities",Indeterminate:"Indeterminate",NoFeatures:"NoFeatures"};TC.Consts.visibility={NOT_VISIBLE:0,NOT_VISIBLE_AT_RESOLUTION:1,HAS_VISIBLE:2,VISIBLE:4};TC.Consts.MARKER="marker";TC.Defaults=function(){var e={};return{imageRatio:1.05,proxy:"",crs:"EPSG:25830",utmCrs:"EPSG:25830",geoCrs:"EPSG:4326",initialExtent:[541084.221,4640788.225,685574.4632,4796618.764],maxExtent:!1,baselayerExtent:[480408,4599748,742552,4861892],resolutions:[1024,512,256,128,64,32,16,8,4,2,1,.5,.25],pointBoundsRadius:30,extentMargin:.2,mouseWheelZoom:!0,attribution:'<a href="http://sitna.navarra.es/" target="_blank">SITNA</a>',oldBrowserAlert:!0,notifyApplicationErrors:!1,loggingErrorsEnabled:!0,maxErrorCount:10,layoutURLParamName:"layout",titleURLParamName:"title",locale:"es-ES",screenSize:20,pixelTolerance:10,maxResolutionError:.01,toastDuration:5e3,avgTileSize:31e3,availableBaseLayers:[{id:TC.Consts.layer.IDENA_BASEMAP,title:"Mapa base",type:TC.Consts.layerType.WMTS,url:"//idena.navarra.es/ogc/wmts/",matrixSet:"epsg25830extended",layerNames:"mapabase",encoding:TC.Consts.WMTSEncoding.RESTFUL,format:"image/png",isDefault:!0,hideTree:!0,thumbnail:TC.apiLocation+"TC/css/img/thumb-basemap.png",fallbackLayer:TC.Consts.layer.IDENA_DYNBASEMAP},{id:TC.Consts.layer.IDENA_ORTHOPHOTO,title:"Ortofoto 2017",type:TC.Consts.layerType.WMTS,url:"//idena.navarra.es/ogc/wmts/",matrixSet:"epsg25830",layerNames:"ortofoto2017",encoding:TC.Consts.WMTSEncoding.RESTFUL,format:"image/jpeg",isDefault:!1,hideTree:!0,thumbnail:TC.apiLocation+"TC/css/img/thumb-orthophoto.jpg",fallbackLayer:TC.Consts.layer.IDENA_DYNORTHOPHOTO},{id:TC.Consts.layer.IDENA_ORTHOPHOTO2014,title:"Ortofoto 2014",type:TC.Consts.layerType.WMTS,url:"//idena.navarra.es/ogc/wmts/",matrixSet:"epsg25830reduced",layerNames:"ortofoto2014",encoding:TC.Consts.WMTSEncoding.RESTFUL,format:"image/jpeg",isDefault:!1,hideTree:!0,thumbnail:TC.apiLocation+"TC/css/img/thumb-ortho2014.jpg",fallbackLayer:TC.Consts.layer.IDENA_DYNORTHOPHOTO2014},{id:TC.Consts.layer.IDENA_ORTHOPHOTO2012,title:"Ortofoto 2012",type:TC.Consts.layerType.WMTS,url:"//idena.navarra.es/ogc/wmts/",matrixSet:"epsg25830",layerNames:"ortofoto2012",encoding:TC.Consts.WMTSEncoding.RESTFUL,format:"image/jpeg",isDefault:!1,hideTree:!0,thumbnail:TC.apiLocation+"TC/css/img/thumb-ortho2012.jpg",fallbackLayer:TC.Consts.layer.IDENA_DYNORTHOPHOTO2012},{id:TC.Consts.layer.IDENA_CADASTER,title:"Catastro",type:TC.Consts.layerType.WMS,url:"//idena.navarra.es/ogc/wms",layerNames:"catastro,regionesFronterizas",format:"image/png",isDefault:!1,hideTree:!0,thumbnail:TC.apiLocation+"TC/css/img/thumb-cadaster.png"},{id:TC.Consts.layer.IDENA_CARTO,title:"Cartograf\xeda topogr\xe1fica",type:TC.Consts.layerType.WMTS,url:"//idena.navarra.es/ogc/wmts/",matrixSet:"epsg25830",layerNames:"mapaTopografico",encoding:TC.Consts.WMTSEncoding.RESTFUL,format:"image/png",isDefault:!1,hideTree:!0,thumbnail:TC.apiLocation+"TC/css/img/thumb-bta.png",fallbackLayer:TC.Consts.layer.IDENA_DYNCARTO},{id:TC.Consts.layer.IDENA_BW_RELIEF,title:"Relieve",type:TC.Consts.layerType.WMS,url:"//idena.navarra.es/ogc/wms",layerNames:"IDENA:mapa_relieve_bn",format:"image/jpeg",isDefault:!1,hideTree:!0,thumbnail:TC.apiLocation+"TC/css/img/thumb-relief_bw.jpg"},{id:TC.Consts.layer.IDENA_BASEMAP_ORTHOPHOTO,title:"Mapa base/ortofoto",type:TC.Consts.layerType.WMS,url:"//idena.navarra.es/ogc/wms",layerNames:"mapaBase_orto",format:"image/jpeg",isDefault:!1,hideTree:!0,thumbnail:TC.apiLocation+"TC/css/img/thumb-base_ortho.png"},{id:TC.Consts.layer.IDENA_DYNBASEMAP,title:"Mapa base",type:TC.Consts.layerType.WMS,url:"//idena.navarra.es/ogc/wms",layerNames:"mapaBase,regionesFronterizas",format:"image/jpeg",isDefault:!1,hideTree:!0,thumbnail:TC.apiLocation+"TC/css/img/thumb-basemap.png"},{id:TC.Consts.layer.IDENA_DYNORTHOPHOTO,title:"Ortofoto",type:TC.Consts.layerType.WMS,url:"//idena.navarra.es/ogc/wms",layerNames:"ortofoto_maxima_actualidad",format:"image/jpeg",isDefault:!1,hideTree:!0,thumbnail:TC.apiLocation+"TC/css/img/thumb-orthophoto.jpg"},{id:TC.Consts.layer.IDENA_DYNORTHOPHOTO2014,title:"Ortofoto 2014",type:TC.Consts.layerType.WMS,url:"//idena.navarra.es/ogc/wms",layerNames:"ortofoto_5000_2014",format:"image/jpeg",isDefault:!1,hideTree:!0,thumbnail:TC.apiLocation+"TC/css/img/thumb-ortho2014.jpg"},{id:TC.Consts.layer.IDENA_DYNORTHOPHOTO2012,title:"Ortofoto 2012",type:TC.Consts.layerType.WMS,url:"//idena.navarra.es/ogc/wms",layerNames:"ortofoto_5000_2012",format:"image/jpeg",isDefault:!1,hideTree:!0,thumbnail:TC.apiLocation+"TC/css/img/thumb-ortho2012.jpg"},{id:TC.Consts.layer.IDENA_DYNCARTO,title:"Cartograf\xeda topogr\xe1fica",type:TC.Consts.layerType.WMS,url:"//idena.navarra.es/ogc/wms",layerNames:"MTNa5_BTA",format:"image/png",isDefault:!1,hideTree:!0,thumbnail:TC.apiLocation+"TC/css/img/thumb-bta.png"},{id:TC.Consts.layer.OSM,title:"OSM",type:TC.Consts.layerType.WMTS,url:TC.apiLocation+"wmts/osm/",matrixSet:"WorldWebMercatorQuad",layerNames:"osm",encoding:TC.Consts.WMTSEncoding.RESTFUL,format:"image/png",isDefault:!1,hideTree:!0,thumbnail:TC.apiLocation+"TC/css/img/thumb-osm.png"},{id:TC.Consts.layer.CARTO_VOYAGER,title:"CARTO Voyager",type:TC.Consts.layerType.WMTS,url:TC.apiLocation+"wmts/carto/",matrixSet:"WorldWebMercatorQuad",layerNames:"voyager",encoding:TC.Consts.WMTSEncoding.RESTFUL,format:"image/png",isDefault:!1,hideTree:!0,thumbnail:TC.apiLocation+"TC/css/img/thumb-carto-voyager.png"},{id:TC.Consts.layer.CARTO_LIGHT,title:"CARTO light",type:TC.Consts.layerType.WMTS,url:TC.apiLocation+"wmts/carto/",matrixSet:"WorldWebMercatorQuad",layerNames:"light_all",encoding:TC.Consts.WMTSEncoding.RESTFUL,format:"image/png",isDefault:!1,hideTree:!0,thumbnail:TC.apiLocation+"TC/css/img/thumb-carto-light.png"},{id:TC.Consts.layer.CARTO_DARK,title:"CARTO dark",type:TC.Consts.layerType.WMTS,url:TC.apiLocation+"wmts/carto/",matrixSet:"WorldWebMercatorQuad",layerNames:"dark_all",encoding:TC.Consts.WMTSEncoding.RESTFUL,format:"image/png",isDefault:!1,hideTree:!0,thumbnail:TC.apiLocation+"TC/css/img/thumb-carto-dark.png"},{id:TC.Consts.layer.MAPBOX_STREETS,title:"Mapbox Streets",type:TC.Consts.layerType.WMTS,url:TC.apiLocation+"wmts/mapbox/",matrixSet:"WorldWebMercatorQuad",layerNames:"streets",encoding:TC.Consts.WMTSEncoding.RESTFUL,format:"image/png",isDefault:!1,hideTree:!0,thumbnail:TC.apiLocation+"TC/css/img/thumb-mapbox-streets.png"},{id:TC.Consts.layer.MAPBOX_SATELLITE,title:"Mapbox Satellite",type:TC.Consts.layerType.WMTS,url:TC.apiLocation+"wmts/mapbox/",matrixSet:"WorldWebMercatorQuad",layerNames:"satellite",encoding:TC.Consts.WMTSEncoding.RESTFUL,format:"image/jpeg",isDefault:!1,hideTree:!0,thumbnail:TC.apiLocation+"TC/css/img/thumb-mapbox-satellite.jpg"},{id:TC.Consts.layer.BLANK,title:"Mapa en blanco",type:TC.Consts.layerType.VECTOR}],baseLayers:[TC.Consts.layer.IDENA_BASEMAP,TC.Consts.layer.IDENA_ORTHOPHOTO,TC.Consts.layer.IDENA_CADASTER,TC.Consts.layer.IDENA_CARTO],defaultBaseLayer:TC.Consts.layer.IDENA_BASEMAP,workLayers:[],controls:{loadingIndicator:!0,navBar:!1,scaleBar:!1,scale:!1,scaleSelector:!1,overviewMap:!1,basemapSelector:!1,attribution:!0,TOC:!1,coordinates:!0,legend:!1,popup:!1,search:{url:"//idena.navarra.es/ogc/wfs",allowedSearchTypes:{coordinates:{},municipality:{},urban:{},street:{},number:{},cadastral:{}}},measure:!1,streetView:!0,featureInfo:!0},layout:null,styles:{point:{fillColor:"#000",fillOpacity:.1,strokeColor:"#f00",strokeWidth:2,radius:6,labelOutlineWidth:2,labelOutlineColor:"#fff",labelOffset:[0,-16],fontColor:"#000",fontSize:10},marker:{classes:[TC.Consts.classes.MARKER+1,TC.Consts.classes.MARKER+2,TC.Consts.classes.MARKER+3,TC.Consts.classes.MARKER+4,TC.Consts.classes.MARKER+5],anchor:[.5,1],width:32,height:32,labelOutlineWidth:2,labelOutlineColor:"#fff",labelOffset:[0,-32],fontColor:"#000",fontSize:10},line:{strokeColor:"#f00",strokeWidth:2,labelOutlineWidth:2,labelOutlineColor:"#fff",fontColor:"#000",fontSize:10},polygon:{strokeColor:"#f00",strokeWidth:2,fillColor:"#000",fillOpacity:.3,labelOutlineWidth:2,labelOutlineColor:"#fff",fontColor:"#000",fontSize:10},cluster:{point:{fillColor:"#336",fillOpacity:.6,radius:function(t){var i=t.features.length,n=e[i];if(!n){n=2+Math.round(5*Math.sqrt(i));e[i]=n}return n},label:"${features.length}",fontColor:"#fff",fontSize:9}},selection:{point:{fillColor:"#00f",fillOpacity:.5,strokeColor:"#00f",strokeWidth:2,radius:6,labelOutlineWidth:2,labelOutlineColor:"#fff",labelOffset:[0,-16],fontColor:"#000",fontSize:10},line:{strokeColor:"#00f",strokeWidth:2,labelOutlineWidth:2,labelOutlineColor:"#fff",fontColor:"#000",fontSize:10},polygon:{strokeColor:"#00f",strokeWidth:2,fillColor:"#000",fillOpacity:.3,labelOutlineWidth:2,labelOutlineColor:"#fff",fontColor:"#000",fontSize:10}}}}}();!function(){Array.prototype.map||(Array.prototype.map=function(e){"use strict";if(void 0===this||null===this)throw new TypeError;var t=Object(this),i=t.length>>>0;if("function"!=typeof e)throw new TypeError;for(var n=new Array(i),r=arguments.length>=2?arguments[1]:void 0,s=0;s<i;s++)s in t&&(n[s]=e.call(r,t[s],s,t));return n});TC.proxify=function(e){var t=e=$.trim(e);if(TC.Cfg.proxy){var i=!1;if(TC.Cfg.proxyExceptions)for(var n=0;n<TC.Cfg.proxyExceptions.length;n++)if(e.indexOf(TC.Cfg.proxyExceptions[n])>-1){i=!0;break}if(!i&&!TC.Util.isSameOrigin(e))if("function"==typeof TC.Cfg.proxy)t=TC.Cfg.proxy(e);else{t=TC.Cfg.proxy;"http"!=e.substr(0,4)&&(t+=window.location.protocol);t+=encodeURIComponent(e)}}return t};"boolean"!=typeof TC.isDebug&&(TC.isDebug=!1);var e=function(e){var t=$("."+TC.Consts.classes.MAP).data("map");TC.error(TC.Util.getLocaleString(t.options.locale,"urlFailedToLoad",{url:e}),[TC.Consts.msgErrorMode.TOAST,TC.Consts.msgErrorMode.EMAIL],"Error al cargar "+e)};TC.syncLoadJS=function(t){var i=function(e,t){var i,n=new XMLHttpRequest;n.open("GET",e,!1);n.onreadystatechange=function(e){if(4===n.readyState)if(404===n.status)i=!1;else if(200!==n.status){t();i=!1}else i=n.responseText};n.send(null);return i};/(\.js|\/)$/i.test(t)||(t+=TC.isDebug?".js":".min.js");var n=i(t,function(){return i(t,function(){e(t)})});if(n){var r=document.createElement("script");r.type="text/javascript";r.text=n;(function(){var e,t=document,i=t.getElementsByTagName("head");if(0===i.length){e=t.createElement("head");t.documentElement.insertBefore(e,document.body)}else e=i[0];return e})().appendChild(r)}};window.Modernizr||TC.syncLoadJS(TC.apiLocation+TC.Consts.url.MODERNIZR);Modernizr.touch=Modernizr.touchevents;TC.isLegacy=!0;window.jQuery||(Modernizr.canvas&&!TC.isLegacy?TC.syncLoadJS(TC.Consts.url.JQUERY):TC.syncLoadJS(TC.Consts.url.JQUERY_LEGACY));$(document).ready(function(){var e,t="Unknown library",i="OpenLayers 2",n="OpenLayers 4";if(TC.Control){e="Compiled";TC.isLegacy?window.OpenLayers&&(t=i):window.ol&&(t=n)}else{e="On demand";t=TC.isLegacy?i:n}TC.version=TC.version+" ("+e+"; "+t+"; @ "+TC.apiLocation+")"});TC.loadJSInOrder=function(e,t,i){TC.loadJS(e,t,i,!0)};TC.loadJS=function(t,i,n,r){arguments.length<4&&(r=!1);var s=$.isArray(i)?i:[i];s=s.map(function(e){return/\.js$/i.test(e)||0!==e.indexOf(TC.apiLocation)?e:e+(TC.isDebug?".js":".min.js")});if(Modernizr.canvas)t?loadjs(s,{success:function(){n()},error:function(t){e(t)},async:!r,numRetries:1}):n();else{if(t)for(var a=0;a<s.length;a++)TC.syncLoadJS(s[a]);n&&n()}};TC.loadCSS=function(t){(function(e){for(var t=!1,i=0;i<document.styleSheets.length;i++){var n=document.styleSheets[i].href;if(n){var r=n.indexOf(e);if(r>=0&&r===n.length-e.length){t=!0;break}}}return t})(t)||loadjs(t,{error:function(t){e(t)},numRetries:1})};var t={};TC.getProjectionData=function(e){var i=$.Deferred(),n=(e=e||{}).crs.substr(e.crs.indexOf(":")+1);parseInt(n)===Number.NaN&&(n=e.crs.substr(e.crs.lastIndexOf("/")+1));var r=t[n];if(r)i.resolve(r);else{var s=TC.Consts.url.EPSG+"?format=json&q="+n,a={dataType:"json",success:function(e){t[n]=e;i.resolve(e)},error:function(e){i.reject(e)}};e.sync&&(a.async=!1);$.ajax(s,a)}return i.promise()};TC.loadProjDef=function(e){const t=(e=e||{}).crs;var i;if(TC.isLegacy){window[TC.Consts.PROJ4JSOBJ_LEGACY]||TC.syncLoadJS(TC.url.proj4js);i=function(e){return Proj4js.defs[e]}}else{window[TC.Consts.PROJ4JSOBJ]||TC.syncLoadJS(TC.url.proj4js);i=function(e){return proj4.defs(e)}}window.Proj4js||(window.Proj4js={Proj:function(e){return proj4(Proj4js.defs[e])},defs:proj4.defs,transform:proj4});const n=function(e,t){Proj4js.defs[e]=t;TC.isLegacy||proj4.defs(e,t)},r=function(e,r,s){const a="EPSG:"+e,o="urn:ogc:def:crs:EPSG::"+e,l="http://www.opengis.net/gml/srs/epsg.xml#"+e;var c;if("object"==typeof r){c=$.extend({},r);r=$.extend({},r);c.axis&&delete c.axis}else"string"==typeof r&&(c=r.replace("+axis=neu",""));n(a,r);n(o,r);n(l,c);if(0===t.indexOf("http")){n(t,c);i(t).name=s}i(a).name=s;i(l).name=s};var s=t.lastIndexOf("#");s<0&&(s=t.lastIndexOf("/"));s<0&&(s=t.lastIndexOf(":"));var a=t.substr(s+1),o=i(t);if(o){r(a,o,e.name);$.isFunction(e.callback)&&e.callback()}else if(e.def){r(a,e.def,e.name);$.isFunction(e.callback)&&e.callback()}else TC.getProjectionData(e).then(function(t){(function(e){var t="ok"===e.status&&1===e.number_result;if(t){var i=e.results[0];r(i.code,i.proj4,i.name)}return t})(t)&&$.isFunction(e.callback)&&e.callback()})};TC.url={templating:[TC.apiLocation+TC.Consts.url.TEMPLATING,TC.apiLocation+TC.Consts.url.TEMPLATING_I18N,TC.apiLocation+TC.Consts.url.TEMPLATING_OVERRIDES]};if(TC.isLegacy){TC.url.ol=TC.apiLocation+TC.Consts.url.OL_LEGACY;TC.url.olConnector=TC.apiLocation+TC.Consts.url.OL_CONNECTOR_LEGACY;TC.url.proj4js=TC.apiLocation+TC.Consts.url.PROJ4JS_LEGACY}else{TC.url.ol=TC.apiLocation+TC.Consts.url.OL;TC.url.olConnector=TC.apiLocation+TC.Consts.url.OL_CONNECTOR;TC.url.proj4js=TC.apiLocation+TC.Consts.url.PROJ4JS}TC.loadProjDef({crs:"EPSG:25830",name:"ETRS89 / UTM zone 30N",def:"+proj=utm +zone=30 +ellps=GRS80 +units=m +no_defs"});TC.loadProjDef({crs:"EPSG:4258",name:"ETRS89",def:"+proj=longlat +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +no_defs +axis=neu"});TC.loadProjDef({crs:"EPSG:3040",name:"ETRS89 / UTM zone 28N (N-E)",def:"+proj=utm +zone=28 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs +axis=neu"});TC.loadProjDef({crs:"EPSG:3041",name:"ETRS89 / UTM zone 29N (N-E)",def:"+proj=utm +zone=29 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs +axis=neu"});TC.loadProjDef({crs:"EPSG:3042",name:"ETRS89 / UTM zone 30N (N-E)",def:"+proj=utm +zone=30 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs +axis=neu"});TC.loadProjDef({crs:"EPSG:3043",name:"ETRS89 / UTM zone 31N (N-E)",def:"+proj=utm +zone=31 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs +axis=neu"});TC.loadProjDef({crs:"EPSG:4230",name:"ED50",def:"+proj=longlat +ellps=intl +towgs84=-87,-98,-121,0,0,0,0 +no_defs +axis=neu"});TC.Cfg=$.extend(!0,{},TC.Defaults,TC.Cfg);TC.capabilities={};TC.WFScapabilities={};TC.cache={};TC.inherit=function(e,t){function i(){}i.prototype=t.prototype;e._super=t.prototype;e.prototype=new i;e.prototype.constructor=e};TC.alert=function(e){alert(e)};TC.prompt=function(e,t,i){var n=prompt(e,t);$.isFunction(i)&&i(n)};TC.confirm=function(e,t,i){confirm(e)?$.isFunction(t)&&t():$.isFunction(i)&&i()};TC.error=function(e){window.console&&console.error(e)};TC.Object=function(){this.$events=$(this)};TC.Object.prototype.on=function(e,t){this.$events.on(e,t);return this};TC.Object.prototype.one=function(e,t){this.$events.one(e,t);return this};TC.Object.prototype.off=function(e,t){this.$events.off(e,t);return this};TC.wrap={Map:function(e){var t=this;t.parent=e;t.map=null;t.mapDeferred=new $.Deferred;t.getMap=function(){return t.map||t.mapDeferred.promise()}},Layer:function(e){var t=this;t.parent=e;t.layer=null;t.layerDeferred=new $.Deferred;t.getLayer=function(){return t.layer||t.layerDeferred.promise()};t.setLayer=function(e){t.layer=e;e?t.layerDeferred.resolve(e):t.layerDeferred.reject()}},layer:{Raster:function(){TC.wrap.Layer.apply(this,arguments)},Vector:function(){TC.wrap.Layer.apply(this,arguments)}},Control:function(e){this.parent=e},control:{Click:function(){TC.wrap.Control.apply(this,arguments)},ScaleBar:function(){TC.wrap.Control.apply(this,arguments)},NavBar:function(){TC.wrap.Control.apply(this,arguments)},Coordinates:function(){TC.wrap.Control.apply(this,arguments)},Search:function(){TC.wrap.Control.apply(this,arguments)},Measure:function(){TC.wrap.Control.apply(this,arguments)},OverviewMap:function(){TC.wrap.Control.apply(this,arguments)},FeatureInfo:function(){TC.wrap.Control.apply(this,arguments)},Popup:function(){TC.wrap.Control.apply(this,arguments)},GeometryFeatureInfo:function(){TC.wrap.Control.apply(this,arguments)},Geolocation:function(){TC.wrap.Control.apply(this,arguments)},Draw:function(){TC.wrap.Control.apply(this,arguments)},Modify:function(){TC.wrap.Control.apply(this,arguments)},CacheBuilder:function(){TC.wrap.Control.apply(this,arguments)},Edit:function(){TC.wrap.Control.apply(this,arguments)},ResultsPanel:function(){TC.wrap.Control.apply(this,arguments)}},Feature:function(){},Geometry:function(){}};TC.inherit(TC.wrap.layer.Raster,TC.wrap.Layer);TC.inherit(TC.wrap.layer.Vector,TC.wrap.Layer);TC.inherit(TC.wrap.control.Click,TC.wrap.Control);TC.inherit(TC.wrap.control.ScaleBar,TC.wrap.Control);TC.inherit(TC.wrap.control.NavBar,TC.wrap.Control);TC.inherit(TC.wrap.control.Coordinates,TC.wrap.Control);TC.inherit(TC.wrap.control.Measure,TC.wrap.Control);TC.inherit(TC.wrap.control.OverviewMap,TC.wrap.Control);TC.inherit(TC.wrap.control.Popup,TC.wrap.Control);TC.inherit(TC.wrap.control.FeatureInfo,TC.wrap.control.Click);TC.inherit(TC.wrap.control.GeometryFeatureInfo,TC.wrap.control.Click);TC.inherit(TC.wrap.control.Geolocation,TC.wrap.Control);TC.inherit(TC.wrap.control.Draw,TC.wrap.Control);TC.inherit(TC.wrap.control.CacheBuilder,TC.wrap.Control);TC.inherit(TC.wrap.control.Edit,TC.wrap.Control);TC.inherit(TC.wrap.control.ResultsPanel,TC.wrap.Control);TC.loadCSS(TC.apiLocation+"TC/css/tcmap.css");TC.Map||TC.syncLoadJS(TC.apiLocation+"TC/Map");TC.Util||TC.syncLoadJS(TC.apiLocation+"TC/Util");TC.loadJS(!Modernizr.urlparser,TC.apiLocation+TC.Consts.url.URL_POLYFILL,function(){});var i={};TC.getUID=function(e){var t=i[e=e||""];t||(t=i[e]=1);var n=e+t;i[e]=t+1;return n}}();!function(e,t){var i=/\+/g;function n(e){return e}function r(e){return decodeURIComponent(e.replace(i," "))}e.cookie=function(i,s,a){if(arguments.length>1&&(!/Object/.test(Object.prototype.toString.call(s))||null===s)){a=e.extend({},e.cookie.defaults,a);null===s&&(a.expires=-1);if("number"==typeof a.expires){var o=a.expires,l=a.expires=new Date;l.setDate(l.getDate()+o)}s=String(s);return t.cookie=[encodeURIComponent(i),"=",a.raw?s:encodeURIComponent(s),a.expires?";expires="+a.expires.toUTCString():"",a.path?";path="+a.path:"",a.domain?";domain="+a.domain:"",a.secure?";secure":""].join("")}for(var c,u=(a=s||e.cookie.defaults||{}).raw?n:r,h=t.cookie.split("; "),p=0;c=h[p]&&h[p].split("=");p++)if(u(c.shift())===i)return u(c.join("="));return null};e.cookie.defaults={}}(jQuery,document)}$(function(){TC.browser=TC.Util.getBrowser();TC.loadJS(!TC.Cfg.acceptedBrowserVersions,TC.apiLocation+"TC/config/browser-versions.js",function(e){var t=!0,i=TC.Cfg.acceptedBrowserVersions.filter(function(e){return e.name.toLowerCase()===TC.browser.name.toLowerCase()});i.length>0&&!isNaN(i[0].version)&&TC.browser.version<i[0].version&&(t=!1);if(TC.Cfg.oldBrowserAlert&&!t){TC.Cfg.loggingErrorsEnabled=!1;var n=$("."+TC.Consts.classes.MAP).data("map");$.when(TC.i18n.loadResources(!TC.i18n[n.options.locale],TC.apiLocation+"TC/resources/",n.options.locale)).done(function(){TC.error(TC.Util.getLocaleString(n.options.locale,"outdatedBrowser"),TC.Consts.msgErrorMode.TOAST)})}});/ip(ad|hone|od)/i.test(navigator.userAgent)&&(TC.Consts.event.CLICK="touchstart.tc");window.JL||TC.syncLoadJS(TC.apiLocation+TC.Consts.url.JSNLOG);JL.defaultAjaxUrl=TC.Consts.url.ERROR_LOGGER;window.addEventListener("error",(t=0,function(i){e=e||$("."+TC.Consts.classes.MAP).data("map");var n=i.message,r=i.filename,s=i.lineno,a=i.colno,o=i.error,l=r.indexOf(TC.apiLocation)>0;if((TC.Cfg.notifyApplicationErrors||l)&&t<TC.Cfg.maxErrorCount&&TC.Cfg.loggingErrorsEnabled){var c=l?TC.Consts.text.API_ERROR:TC.Consts.text.APP_ERROR;JL("onerrorLogger").fatalException({msg:c,errorMsg:n,url:r,lineNumber:s,column:a,appUrl:location.href,prevState:e.getPreviousMapState(),userAgent:navigator.userAgent},o);t++;TC.isDebug||$.when(TC.i18n.loadResources(!TC.i18n[e.options.locale],TC.apiLocation+"TC/resources/",e.options.locale)).done(function(){TC.error(TC.Util.getLocaleString(e.options.locale,"genericError")+(e.options.contactEmail||"webmaster@itracasa.es"),{type:TC.Consts.msgType.ERROR})})}return!1}),!1);var e,t});TC.Layer=function(e){this.options=e||{};$.extend(this,this.options);this.id=this.options.id||TC.getUID();this.map=this.options.map;this.type=this.options.type||TC.Consts.layerType.WMS;this.customLegend=this.options.customLegend;var t=this.options.isBase?TC.Consts.mimeType.JPEG:TC.Consts.mimeType.PNG;this.options.format=this.options.format||t;void 0===this.options.hideTree&&(this.options.hideTree=!0);void 0===this.options.hideTitle&&(this.options.hideTitle=!1);this._cache={visibilityStates:{}};this.tree=null;this.wrap=null};TC.Layer.state={IDLE:"idle",LOADING:"loading"};TC.Layer.prototype.setVisibility=function(e){this.wrap.setVisibility(e)};TC.Layer.prototype.getVisibility=function(){var e=!1;this.map&&(this.isBase&&this.map.getBaseLayer()!==this||(e=this.wrap.getVisibility()));return e};TC.Layer.prototype.getOpacity=function(){var e=!1;this.map&&(this.isBase&&this.map.getBaseLayer()!==this||(e=this.wrap.getLayer().getOpacity()));return e};TC.Layer.prototype.setOpacity=function(e,t){var i=this;$.when(this.wrap.getLayer()).then(function(n){n.setOpacity(e);i.map&&!t&&i.map.$events.trigger($.Event(TC.Consts.event.LAYEROPACITY,{layer:i,opacity:e}))})};TC.Layer.prototype.isCompatible=function(e){return!0};TC.Layer.prototype.isValidFromNames=function(){return!0};TC.Layer.prototype.isRaster=function(){var e=!0;switch(this.type){case TC.Consts.layerType.VECTOR:case TC.Consts.layerType.KML:case TC.Consts.layerType.WFS:case TC.Consts.layerType.GROUP:e=!1}return e};TC.Layer.prototype.isVisibleByScale=function(e){return!0};TC.Layer.prototype.isVisibleByName=function(e){return!0};TC.Layer.prototype.getTree=function(){return{name:this.name,title:this.title}};TC.Layer.prototype.findNode=function e(t,i){var n=null;if(i.uid==t)n=i;else for(var r=0;r<i.children.length;r++){var s=e(t,i.children[r]);if(s){n=s;break}}return n};TC.Layer.prototype.setNodeVisibility=function(e,t){this.setVisibility(t)};TC.Layer.prototype.getNodeVisibility=function(e){return TC.Consts.visibility.VISIBLE};TC.Layer.prototype.getResolutions=function(){return this.wrap.getResolutions?this.wrap.getResolutions():[]};TC.Layer.prototype.getLegendUrl=function(e){return e};TC.Layer.prototype.setProjection=function(){};TC.control=TC.control||{};TC.Control=function(){this.$events=$(this);this.map=null;this.isActive=!1;this.isDisabled=!1;this._firstRender=$.Deferred();var e=arguments.length;this.options=$.extend({},e>1?arguments[1]:arguments[0]);this.id=this.options.id||TC.getUID(this.CLASS.substr(TC.Control.prototype.CLASS.length+1)+"-");this.div=TC.Util.getDiv(this.options.div?this.options.div:arguments[0]);this._$div=$(this.div);this._$div.addClass(TC.Control.prototype.CLASS).addClass(this.CLASS);this.template=this.options.template||this.template;this.exportsState=!1};TC.Control.prototype.on=function(e,t){this.$events.on(e,t);return this};TC.Control.prototype.one=function(e,t){this.$events.one(e,t);return this};TC.Control.prototype.off=function(e,t){this.$events.off(e,t);return this};TC.Control.prototype.CLASS="tc-ctl";TC.Control.prototype.template="";TC.Control.prototype.show=function(){this._$div.show()};TC.Control.prototype.hide=function(){this._$div.hide()};TC.Control.prototype.render=function(e){this.renderData(null,e)};TC.Control.prototype.renderData=function(e,t){var i=this;if(i.map){var n=$.Event(TC.Consts.event.BEFORECONTROLRENDER,{dataObject:e});i.$events.trigger(n)}i._$div.toggleClass(TC.Consts.classes.DISABLED,i.isDisabled);TC.loadJSInOrder(!window.dust,TC.url.templating,function(){var n,r=function(t){var n=$.Deferred(),r=[];for(var s in t){var a=t[s];if("string"==typeof a)if(dust.cache[i.CLASS])dust.render(i.CLASS,e,function(e,t){i._$div.html(t);e&&TC.error(e)});else{var o=$.ajax({url:a,type:"get",dataType:"html"});o.templateKey=s;r.push(o)}else $.isFunction(a)&&a()}0==r.length?n.resolve():$.when.apply($,r).then(function(){if(3!=arguments.length||$.isArray(arguments[0]))for(var e=0;e<arguments.length;e++){var t=arguments[e];i=t[0],r=t[2].templateKey,s=dust.compile(i,r);dust.loadSource(s)}else{var i=arguments[0],r=arguments[2].templateKey,s=dust.compile(i,r);dust.loadSource(s)}n.resolve()},function(e,t,i){console.error("Deferred fallido")});return n};if("object"==typeof i.template)n=r(i.template);else{var s={};i.template&&(s[i.CLASS]=i.template);n=r(s)}n.then(function(){dust.cache[i.CLASS]&&dust.render(i.CLASS,e,function(e,t){i._$div.html(t);e&&TC.error(e)});i._firstRender.resolve();i.$events.trigger($.Event(TC.Consts.event.CONTROLRENDER));$.isFunction(t)&&t()})})};TC.Control.prototype.getRenderedHtml=function(e,t,i){var n=this,r=$.Deferred(),s=function(){dust.cache[e]&&dust.render(e,t,function(e,t){if(e){TC.error(e);r.reject()}else{$.isFunction(i)&&i(t);r.resolve(t)}})};TC.loadJSInOrder(!window.dust,TC.url.templating,function(){if(dust.cache[e])s();else{var t=n.template[e];if("string"==typeof t)$.ajax({url:t,type:"get",dataType:"html"}).done(function(){var t=arguments[0],i=dust.compile(t,e);dust.loadSource(i);s()});else if($.isFunction(t)){t();s()}}});return r};TC.Control.prototype.register=function(e){this.map=e;this.render();this.options.active&&this.activate()};TC.Control.prototype.activate=function(){if(this.map&&this.map.activeControl&&this.map.activeControl!=this){this.map.previousActiveControl=this.map.activeControl;TC.control.ThreeD&&this instanceof TC.control.ThreeD||this.map.activeControl.deactivate()}this.isActive=!0;if(this.map){this.map.activeControl=this;this.map.$events.trigger($.Event(TC.Consts.event.CONTROLACTIVATE,{control:this}));this.$events.trigger($.Event(TC.Consts.event.CONTROLACTIVATE,{control:this}))}};TC.Control.prototype.deactivate=function(e){0==arguments.length&&(e=!1);this.isActive=!1;if(this.map){this.map.activeControl=null;if(!e){var t=this.map.getDefaultControl();t==this?t=null:this.map.previousActiveControl==this?t=null:t||(t=this.map.previousActiveControl);t&&t.activate()}this.map.$events.trigger($.Event(TC.Consts.event.CONTROLDEACTIVATE,{control:this}));this.$events.trigger($.Event(TC.Consts.event.CONTROLDEACTIVATE,{control:this}))}};TC.Control.prototype.enable=function(){this.isDisabled=!1;this._$div&&this._$div.removeClass(TC.Consts.classes.DISABLED)};TC.Control.prototype.disable=function(){this.isDisabled=!0;this._$div&&this._$div.addClass(TC.Consts.classes.DISABLED)};TC.Control.prototype.renderPromise=function(){return this._firstRender.promise()};TC.Control.prototype.isExclusive=function(){return!1};TC.Control.prototype.getLocaleString=function(e,t){var i=this.map?this.map.options.locale:TC.Cfg.locale;return TC.Util.getLocaleString(i,e,t)};TC.Control.prototype.getUID=function(){return TC.getUID(this.id+"-")};TC.Control.prototype.exportState=function(){return this.exportsState?{}:null};TC.Control.prototype.importState=function(e){};TC.feature=TC.feature||{};TC.Feature=function(e,t){this.wrap=new TC.wrap.Feature;this.wrap.parent=this;if($.isArray(e))this.geometry=e;else if(this.wrap.isNative(e)){this.wrap.feature=e;this.id=this.wrap.getId();this.geometry=this.wrap.getGeometry();this.folders=e._folders;this.data=this.wrap.getData()}var i=this.options=$.extend(!0,{},t);this.id=this.id||i.id||TC.getUID();this.data=i.data||this.data||null;this._visibilityState=TC.Consts.visibility.VISIBLE;void 0===i.showsPopup?this.showsPopup=!0:this.showsPopup=i.showsPopup;this.layer=i.layer||null;this._selected=!1;i.selected&&this.select()};TC.Feature.prototype.STYLETYPE=TC.Consts.geom.POLYGON;TC.Feature.prototype.CLASSNAME="TC.Feature";TC.Feature.prototype.getPath=function(){var e=[];this.folders?e=this.folders:this.options.group&&(e=[this.options.group]);return e};TC.Feature.prototype.setVisibility=function(e){if(e&&this._visibilityState===TC.Consts.visibility.NOT_VISIBLE||!e&&this._visibilityState===TC.Consts.visibility.VISIBLE){this._visibilityState=e?TC.Consts.visibility.VISIBLE:TC.Consts.visibility.NOT_VISIBLE;this.layer.wrap.setFeatureVisibility(this,e)}};TC.Feature.prototype.setId=function(e){this.id=e;this.wrap.setId(e)};TC.Feature.prototype.getBounds=function(){return this.wrap.getBounds()};TC.Feature.prototype.setStyle=function(e){this.wrap.setStyle(e)};TC.Feature.prototype.getLegend=function(){this._legend||(this._legend=this.wrap.getLegend());return this._legend};TC.Feature.prototype.getCoords=function(){return this.wrap.getGeometry()};TC.Feature.prototype.setCoords=function(e){this.geometry=e;return this.wrap.setGeometry(e)};TC.Feature.prototype.getData=function(){return this.data?this.data:this.wrap.getData()};TC.Feature.prototype.setData=function(e){this.data=$.extend(this.data,e);this.wrap.setData(e)};TC.Feature.prototype.getInfo=function(){var e=null,t=this.layer&&this.layer.map&&TC.Util.getMapLocale(this.layer.map),i=this.getData();if("object"==typeof i){var n=this.wrap.getTemplate();if(n)e=n.replace(/\$\[?(?:\w+\/)*(\w+)\]/g,function(e,t){return i[t]});else{var r=[],s=TC.Util.getLocaleString(t,"open");for(var a in i){var o=i[a];if("string"==typeof o||"number"==typeof o||void 0===o){r[r.length]="<tr><th>";r[r.length]=a;r[r.length]="</th><td>";if(TC.Util.isURL(o)){r[r.length]='<a href="';r[r.length]=o;r[r.length]='" target="_blank">';r[r.length]=s;r[r.length]="</a>"}else r[r.length]=void 0!==o?TC.Util.formatNumber(o,t):"&mdash;";r[r.length]="</td></tr>"}}if(r.length>0){r.unshift("<table>");r[r.length]="</table>";e=r.join("")}}}else"string"==typeof i&&(e=i);if(!e){e=this.title;this.group&&(e+=" "+this.group)}e||(e=TC.Util.getLocaleString(t,"noData"));return e};TC.Feature.prototype.clone=function(){var e=this.wrap.cloneFeature();e._wrap=this.wrap;return new this.constructor(e,this.options)};TC.Feature.prototype.getStyle=function(){return this.wrap.getStyle()};TC.Feature.prototype.showPopup=function(e){var t=this;if(t.layer&&t.layer.map){var i,n=e||t.popup;if(!n)for(var r=t.layer.map.getControlsByClass("TC.control.Popup"),s=0,a=r.length;s<a;s++){var o=r[s];if(!o.caller){n=o;break}}n?(i=$.Deferred()).resolve(n):i=t.layer.map.addControl("popup");i.then(function(e){e.currentFeature=t;t.layer.map.getControlsByClass(TC.control.Popup).forEach(function(e){e.isVisible()&&e.hide()});t.wrap.showPopup(e);t.layer.map.$events.trigger($.Event(TC.Consts.event.POPUP,{control:e}));e.fitToView(!0)})}};TC.Feature.prototype.select=function(){this._selected=!0;this.layer&&this.layer.selectedFeatures.push(this);var e=this.options.selection||{};this.setStyle($.extend({},TC.Cfg.styles.selection[this.STYLETYPE],e[this.STYLETYPE]))};TC.Feature.prototype.unselect=function(){this._selected=!1;this.setStyle(this.options);if(this.layer){var e=$.inArray(this,this.layer.selectedFeatures);e>=0&&this.layer.selectedFeatures.splice(e,1)}};TC.Feature.prototype.isSelected=function(){return this._selected};TC.Feature.prototype.toGML=function(e,t){return this.wrap.toGML(e,t)};TC.feature=TC.feature||{};TC.Feature||TC.syncLoadJS(TC.apiLocation+"TC/Feature");TC.feature.Point=function(e,t){var i;TC.Feature.apply(this,arguments);if(this.wrap.isNative(e)){e._wrap=this.wrap;this.wrap.feature=e}else{i=this.options=$.extend(!0,this.options,TC.Cfg.styles.point,t);this.wrap.createPoint(e,i)}};TC.inherit(TC.feature.Point,TC.Feature);TC.feature.Point.prototype.STYLETYPE=TC.Consts.geom.POINT;TC.feature.Point.prototype.CLASSNAME="TC.feature.Point";TC.feature=TC.feature||{};TC.Feature||TC.syncLoadJS(TC.apiLocation+"TC/Feature");TC.feature.Circle=function(e,t){var i;TC.Feature.apply(this,arguments);if(this.wrap.isNative(e)){e._wrap=this.wrap;this.wrap.feature=e}else{i=this.options=$.extend(!0,this.options,TC.Cfg.styles.polygon,t);this.wrap.createCircle(e,i)}};TC.inherit(TC.feature.Circle,TC.Feature);!function(){var e=TC.feature.Circle.prototype;e.STYLETYPE=TC.Consts.geom.POLYGON;e.CLASSNAME="TC.feature.Circle";e.getCoords=function(){return this.wrap.getGeometry()};e.setCoords=function(e){return this.wrap.setGeometry(e)}}();TC.feature=TC.feature||{};TC.feature.Point||TC.syncLoadJS(TC.apiLocation+"TC/feature/Point");TC.feature.Marker=function(e,t){TC.Feature.apply(this,arguments);if(this.wrap.isNative(e)){e._wrap=this.wrap;this.wrap.feature=e}else{var i=this.options=$.extend(!0,this.options,TC.Cfg.styles.marker,t),n=this.layer&&this.layer.map?this.layer.map.options.locale:TC.Cfg.locale;this.title=i.title||TC.i18n[n][TC.Consts.MARKER];this.wrap.createMarker(e,i)}};TC.inherit(TC.feature.Marker,TC.feature.Point);TC.feature.Marker.prototype.STYLETYPE="marker";TC.feature.Marker.prototype.CLASSNAME="TC.feature.Marker";TC.feature=TC.feature||{};TC.Feature||TC.syncLoadJS(TC.apiLocation+"TC/Feature");TC.feature.MultiPolygon=function(e,t){var i;TC.Feature.apply(this,arguments);if(this.wrap.isNative(e)){e._wrap=this.wrap;this.wrap.feature=e}else{i=this.options=$.extend(!0,this.options,TC.Cfg.styles.polygon,t);this.wrap.createMultiPolygon(e,i)}};TC.inherit(TC.feature.MultiPolygon,TC.Feature);TC.feature.MultiPolygon.prototype.STYLETYPE=TC.Consts.geom.POLYGON;TC.feature.MultiPolygon.prototype.CLASSNAME="TC.feature.MultiPolygon";TC.feature=TC.feature||{};TC.Feature||TC.syncLoadJS(TC.apiLocation+"TC/Feature");TC.feature.MultiPolyline=function(e,t){var i;TC.Feature.apply(this,arguments);if(this.wrap.isNative(e)){e._wrap=this.wrap;this.wrap.feature=e}else{i=this.options=$.extend(!0,this.options,TC.Cfg.styles.line,t);this.wrap.createMultiPolyline(e,i)}};TC.inherit(TC.feature.MultiPolyline,TC.Feature);TC.feature.MultiPolyline.prototype.STYLETYPE="line";TC.feature.MultiPolyline.prototype.CLASSNAME="TC.feature.MultiPolyline";TC.feature=TC.feature||{};TC.Feature||TC.syncLoadJS(TC.apiLocation+"TC/Feature");TC.feature.Polygon=function(e,t){var i;TC.Feature.apply(this,arguments);if(this.wrap.isNative(e)){e._wrap=this.wrap;this.wrap.feature=e}else{i=this.options=$.extend(!0,this.options,TC.Cfg.styles.polygon,t);this.wrap.createPolygon(e,i)}};TC.inherit(TC.feature.Polygon,TC.Feature);TC.feature.Polygon.prototype.STYLETYPE=TC.Consts.geom.POLYGON;TC.feature.Polygon.prototype.CLASSNAME="TC.feature.Polygon";TC.feature.Polygon.prototype.getLength=function(e){return this.wrap.getLength(e)};TC.feature.Polygon.prototype.getArea=function(e){return this.wrap.getArea(e)};TC.feature=TC.feature||{};TC.Feature||TC.syncLoadJS(TC.apiLocation+"TC/Feature");TC.feature.Polyline=function(e,t){var i;TC.Feature.apply(this,arguments);if(this.wrap.isNative(e)){e._wrap=this.wrap;this.wrap.feature=e}else{i=this.options=$.extend(!0,this.options,TC.Cfg.styles.line,t);this.wrap.createPolyline(e,i)}};TC.inherit(TC.feature.Polyline,TC.Feature);TC.feature.Polyline.prototype.STYLETYPE="line";TC.feature.Polyline.prototype.CLASSNAME="TC.feature.Polyline";TC.feature.Polyline.prototype.getLength=function(e){return this.wrap.getLength(e)};TC.filter={};TC.filter.Filter=function(e){this.tagName_=e;this._defaultNSURL="http://www.opengis.net/ogc";this._defaultPrefixNS=this._wfsPrefixNS="ogc";this._fieldTitle="PropertyName";this._defaultNSURL=this._wfsNSURL="http://www.opengis.net/ogc";this._wfs2prefixNS="fes";this._wfs2NSURL="http://www.opengis.net/fes/2.0";this._wfs2FieldTitle="ValueReference"};TC.filter.Filter.prototype.getTagName=function(){return this.tagName_};TC.filter.Filter.prototype.writeFilterCondition_=function(){return'<{prefix}:Filter xmlns:{prefix}="{NSURL}">{inner}</{prefix}:Filter>'.format({prefix:this._defaultPrefixNS,NSURL:this._defaultNSURL,tag:this.getTagName(),inner:this.writeInnerCondition_(this)})};TC.filter.Filter.prototype.writeInnerCondition_=function(e){if(e!=this){e._defaultNSURL=this._defaultNSURL;e._defaultPrefixNS=this._defaultPrefixNS}return e instanceof TC.filter.LogicalNary?e.write():e instanceof TC.filter.ComparisonBinary?e.write():e instanceof TC.filter.Comparison?e.write():e instanceof TC.filter.Spatial?e.write():(TC.filter.Function,e.write())};TC.filter.Filter.prototype.writeInnerArrayCondition_=function(e){return e.reduce(function(e,t,i){return(e instanceof TC.filter.Filter?e.writeInnerCondition_(e):e)+t.writeInnerCondition_(t)})};TC.filter.Filter.prototype.getText=function(e){if(e&&parseFloat(e,10)>=2){this._defaultPrefixNS=this._wfs2prefixNS;this._defaultNSURL=this._wfs2NSURL;this._fieldTitle=this._wfs2FieldTitle}return this.writeFilterCondition_()};TC.filter.and=function(e){var t=[null].concat(Array.prototype.slice.call(arguments));return new(Function.prototype.bind.apply(TC.filter.And,t))};TC.filter.or=function(e){var t=[null].concat(Array.prototype.slice.call(arguments));return new(Function.prototype.bind.apply(TC.filter.Or,t))};TC.filter.not=function(e){return new TC.filter.Not(e)};TC.filter.bbox=function(){return"[object String]"!==Object.prototype.toString.call(arguments[0])?new TC.filter.Bbox(null,arguments[0],arguments[1]):new TC.filter.Bbox(arguments[0],arguments[1],arguments[2])};TC.filter.intersects=function(){return"[object String]"!==Object.prototype.toString.call(arguments[0])?new TC.filter.Intersects(null,arguments[0],arguments[1]):new TC.filter.Intersects(arguments[0],arguments[1],arguments[2])};TC.filter.within=function(){return"[object String]"!==Object.prototype.toString.call(arguments[0])?new TC.filter.Within(null,arguments[0],arguments[1]):new TC.filter.Within(arguments[0],arguments[1],arguments[2])};TC.filter.equalTo=function(e,t,i){return new TC.filter.EqualTo(e,t,i)};TC.filter.notEqualTo=function(e,t,i){return new TC.filter.NotEqualTo(e,t,i)};TC.filter.lessThan=function(e,t){return new TC.filter.LessThan(e,t)};TC.filter.lessThanOrEqualTo=function(e,t){return new TC.filter.LessThanOrEqualTo(e,t)};TC.filter.greaterThan=function(e,t){return new TC.filter.GreaterThan(e,t)};TC.filter.greaterThanOrEqualTo=function(e,t){return new TC.filter.GreaterThanOrEqualTo(e,t)};TC.filter.isNull=function(e){return new TC.filter.IsNull(e)};TC.filter.between=function(e,t,i){return new TC.filter.IsBetween(e,t,i)};TC.filter.function=function(e,t){return new TC.filter.Function(e,t)};TC.filter.like=function(e,t,i,n,r,s){return new TC.filter.IsLike(e,t,i,n,r,s)};TC.filter.LogicalNary=function(e,t){TC.filter.Filter.call(this,e);this.conditions=Array.prototype.slice.call(arguments,1)};TC.inherit(TC.filter.LogicalNary,TC.filter.Filter);TC.filter.And=function(e){var t=["And"].concat(Array.prototype.slice.call(arguments));TC.filter.LogicalNary.apply(this,t)};TC.inherit(TC.filter.And,TC.filter.LogicalNary);TC.filter.Or=function(e){var t=["Or"].concat(Array.prototype.slice.call(arguments));TC.filter.LogicalNary.apply(this,t)};TC.inherit(TC.filter.Or,TC.filter.LogicalNary);TC.filter.LogicalNary.prototype.write=function(){return"<{prefix}:{tag}>{inner}</{prefix}:{tag}>".format({prefix:this._defaultPrefixNS,tag:this.getTagName(),inner:this.writeInnerArrayCondition_(this.conditions)})};TC.filter.Not=function(e){this.condition=e;TC.filter.Filter.call(this,"Not")};TC.inherit(TC.filter.Not,TC.filter.Filter);TC.filter.Filter.prototype.write=function(){return"<{prefix}:{tag}>{inner}</{prefix}:{tag}>".format({prefix:this._defaultPrefixNS,tag:this.getTagName(),inner:this.writeInnerCondition_(this.condition)})};TC.filter.Bbox=function(e,t,i){TC.filter.Filter.call(this,"BBOX");this.geometryName=e;this.extent=t;this.srsName=i};TC.inherit(TC.filter.Bbox,TC.filter.Filter);TC.filter.Comparison=function(e,t){TC.filter.Filter.call(this,e);this.propertyName=t};TC.inherit(TC.filter.Comparison,TC.filter.Filter);TC.filter.Comparison.prototype.write=function(){var e="";this.lowerBoundary&&this.upperBoundary&&(e="<{prefix}:LowerBoundary><{prefix}:Literal>{LowerBoundary}</{prefix}:Literal></{prefix}:LowerBoundary><{prefix}:UpperBoundary><{prefix}:Literal>{UpperBoundary}</{prefix}:Literal></{prefix}:UpperBoundary>".format({prefix:this._defaultPrefixNS,LowerBoundary:this.lowerBoundary,UpperBoundary:this.upperBoundary}));this.pattern&&(e="<{prefix}:Literal>{Pattern}</{prefix}:Literal>".format({prefix:this._defaultPrefixNS,Pattern:this.pattern}));this.params&&(e=$.isArray(this.params)?this.params.reduce(function(e,t,i){var n=function(e){return"<{prefix}:Literal>{value}</{prefix}:Literal>".format({prefix:this._defaultPrefixNS,value:e})};return(i>0?e:n(e))+n(t)}):"<{prefix}:Literal>{value}</{prefix}:Literal>".format({prefix:this._defaultPrefixNS,value:this.params}));return"<{prefix}:{tag}{matchCase}{escape}{singleChar}{wildCard}><{prefix}:{fieldTitle}>{name}</{prefix}:{fieldTitle}>{values}</{prefix}:{tag}>".format({prefix:this._defaultPrefixNS,tag:this.getTagName(),matchCase:void 0!==this.matchCase?' matchCase="'+this.matchCase+'"':"",escape:void 0!==this.escapeChar?' escape="'+this.escapeChar+'"':"",singleChar:void 0!==this.singleChar?' singleChar="'+this.singleChar+'"':"",wildCard:void 0!==this.wildCard?' wildCard="'+this.wildCard+'"':"",name:this.propertyName,values:e,fieldTitle:this._fieldTitle})};TC.filter.ComparisonBinary=function(e,t,i,n){TC.filter.Comparison.call(this,e,t);this.expression=i;this.matchCase=n};TC.inherit(TC.filter.ComparisonBinary,TC.filter.Comparison);TC.filter.ComparisonBinary.prototype.write=function(){return"<{prefix}:{tag}{matchCase}><{prefix}:{fieldTitle}>{name}</{prefix}:{fieldTitle}><{prefix}:Literal>{value}</{prefix}:Literal></{prefix}:{tag}>".format({prefix:this._defaultPrefixNS,tag:this.getTagName(),matchCase:void 0!==this.matchCase?' matchCase="'+this.matchCase+'"':"",name:this.propertyName,value:this.expression,fieldTitle:this._fieldTitle})};TC.filter.EqualTo=function(e,t,i){TC.filter.ComparisonBinary.call(this,"PropertyIsEqualTo",e,t,i)};TC.inherit(TC.filter.EqualTo,TC.filter.ComparisonBinary);TC.filter.GreaterThan=function(e,t){TC.filter.ComparisonBinary.call(this,"PropertyIsGreaterThan",e,t)};TC.inherit(TC.filter.GreaterThan,TC.filter.ComparisonBinary);TC.filter.GreaterThanOrEqualTo=function(e,t){TC.filter.ComparisonBinary.call(this,"PropertyIsGreaterThanOrEqualTo",e,t)};TC.inherit(TC.filter.GreaterThanOrEqualTo,TC.filter.ComparisonBinary);TC.filter.LessThan=function(e,t){TC.filter.ComparisonBinary.call(this,"PropertyIsLessThan",e,t)};TC.inherit(TC.filter.LessThan,TC.filter.ComparisonBinary);TC.filter.LessThanOrEqualTo=function(e,t){TC.filter.ComparisonBinary.call(this,"PropertyIsLessThanOrEqualTo",e,t)};TC.inherit(TC.filter.LessThanOrEqualTo,TC.filter.ComparisonBinary);TC.filter.NotEqualTo=function(e,t,i){TC.filter.ComparisonBinary.call(this,"PropertyIsNotEqualTo",e,t,i)};TC.inherit(TC.filter.NotEqualTo,TC.filter.ComparisonBinary);TC.filter.IsLike=function(e,t,i,n,r,s){TC.filter.Comparison.call(this,"PropertyIsLike",e);this.pattern=t;this.wildCard=void 0!==i?i:"*";this.singleChar=void 0!==n?n:".";this.escapeChar=void 0!==r?r:"!";this.matchCase=s};TC.inherit(TC.filter.IsLike,TC.filter.Comparison);TC.filter.IsNull=function(e){TC.filter.Comparison.call(this,"PropertyIsNull",e)};TC.inherit(TC.filter.IsNull,TC.filter.Comparison);TC.filter.IsBetween=function(e,t,i){TC.filter.Comparison.call(this,"PropertyIsBetween",e);this.lowerBoundary=t;this.upperBoundary=i};TC.inherit(TC.filter.IsBetween,TC.filter.Comparison);TC.filter.Function=function(e,t){TC.filter.Filter.call(this,e);this.params=t};TC.inherit(TC.filter.Function,TC.filter.Filter);TC.filter.Function.prototype.write=function(){var e="";if(this.params)if($.isArray(this.params)){var t=this._defaultPrefixNS;e=this.params.reduce(function(e,i,n){var r=function(e){return"<{prefix}:Literal>{value}</{prefix}:Literal>".format({prefix:t,value:e})};return(n>1?e:r(e))+r(i)})}else e="<{prefix}:Literal>{value}</{prefix}:Literal>".format({prefix:this._defaultPrefixNS,value:this.params});return'<{prefix}:Function name="{tag}">{inner}</{prefix}:Function>'.format({prefix:this._defaultPrefixNS,tag:this.getTagName(),inner:e})};TC.filter.Spatial=function(e,t,i,n){TC.filter.Filter.call(this,e);this.geometryName=t;this.geometry=i;this.srsName=n};TC.inherit(TC.filter.Spatial,TC.filter.Filter);TC.filter.Spatial.prototype.write=function(){return(this.geometryName?"<{prefix}:{tag}><{prefix}:{fieldTitle}>{name}</{prefix}:{fieldTitle}>{geometry}</{prefix}:{tag}>":"<{prefix}:{tag}><{prefix}:{fieldTitle}/>{geometry}</{prefix}:{tag}>").format({prefix:this._defaultPrefixNS,tag:this.getTagName(),name:this.geometryName,srsName:void 0!==this.srsName?' srsName="'+this.srsName+'"':"",geometry:this.geometry instanceof TC.filter.Function?this.writeInnerCondition_(this.geometry):this.geometry.wrap.toGML(),fieldTitle:this._fieldTitle})};TC.filter.Bbox=function(e,t,i){TC.filter.Filter.call(this,"BBOX");this.geometryName=e;this.extent=t;this.srsName=i};TC.inherit(TC.filter.Bbox,TC.filter.Filter);TC.filter.Bbox.prototype.write=function(){var e="<gml:Envelope{srsName}><gml:lowerCorner>{lowerCorner}</gml:lowerCorner><gml:upperCorner>{upperCorner}</gml:upperCorner></gml:Envelope>".format({srsName:void 0!==this.srsName?' srsName="'+this.srsName+'"':"",lowerCorner:this.extent[0]+" "+this.extent[1],upperCorner:this.extent[2]+" "+this.extent[3]});return(this.geometryName?"<{prefix}:{tag}><{prefix}:{fieldTitle}>{name}</{prefix}:{fieldTitle}>{BBOX}</{prefix}:{tag}>":"<{prefix}:{tag}><{prefix}:{fieldTitle}/>{BBOX}</{prefix}:{tag}>").format({prefix:this._defaultPrefixNS,tag:this.getTagName(),fieldTitle:this._fieldTitle,name:this.geometryName,BBOX:e})};TC.filter.Intersects=function(e,t,i){TC.filter.Spatial.call(this,"Intersects",e,t,i)};TC.inherit(TC.filter.Intersects,TC.filter.Spatial);TC.filter.Within=function(e,t,i){TC.filter.Spatial.call(this,"Within",e,t,i)};TC.inherit(TC.filter.Within,TC.filter.Spatial);TC.control=TC.control||{};TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control");TC.control.MapContents=function(){TC.Control.apply(this,arguments);this.layerTrees={}};TC.inherit(TC.control.MapContents,TC.Control);!function(){var e=TC.control.MapContents.prototype;e.CLASS="tc-ctl-mc";var t="tcLayer",i="tcImg";e.render=function(e){this.map&&this.renderData(this.map.getLayerTree(),e)};e.register=function(e){var t=this;TC.Control.prototype.register.call(t,e);t.render(function(){for(var i=0,n=e.layers.length;i<n;i++)t.updateLayerTree(e.layers[i]);e.on(TC.Consts.event.ZOOM+" "+TC.Consts.event.PROJECTIONCHANGE,function(){t.updateScale()}).on(TC.Consts.event.UPDATEPARAMS,function(e){var i=e.layer.names;!function e(t){var n=!1;if(t)if($.inArray(t.name,i)>=0)n=!0;else for(var r=0;r<t.children.length;r++)if(e(t.children[r])){n=!0;break}return n}(t.layerTrees[e.layer.id])&&0!==i.length?t.updateLayerTree(e.layer):t.update()}).on(TC.Consts.event.LAYERVISIBILITY,function(e){t.updateLayerVisibility(e.layer)}).on(TC.Consts.event.LAYERADD,function(e){t.updateLayerTree(e.layer)}).on(TC.Consts.event.VECTORUPDATE+" "+TC.Consts.event.FEATUREADD+" "+TC.Consts.event.FEATURESADD,function(e){t._updateLayerTreeTimeout&&clearTimeout(t._updateLayerTreeTimeout);t._updateLayerTreeTimeout=setTimeout(function(){if(t.map.workLayers.indexOf(e.layer)>-1){t.updateLayerTree(e.layer);delete t._updateLayerTreeTimeout}},100)}).on(TC.Consts.event.LAYERREMOVE,function(e){t.removeLayer(e.layer)}).on(TC.Consts.event.LAYERORDER,function(e){t.updateLayerOrder(e.layer,e.oldIndex,e.newIndex)})})};e.updateScale=function(){};e.updateLayerVisibility=function(e){};e.updateLayerTree=function(e){this.layerTrees[e.id]=e.getTree()};e.updateLayerOrder=function(e,i,n){if(i>=0&&i!==n)for(var r,s,a=this.getLayerUIElements(),o=this.map.workLayers.length-1;o>=0;o--){var l=this.map.workLayers[o];s=r;a.each(function(e,i){var n=$(i);if(n.data(t)===l){r=n;return!1}});if(l===e){s?s.after(r):a.parent().prepend(r);break}}};e.removeLayer=function(e){this.update()};e.getLayerUIElements=function(){return this._$div.find("ul").first().children()};e.styleLegendImage=function(e,t){if(!e.attr("src")){var n=e.data(i);e.off("error.tc").on("error.tc",function(){var i=e.attr("src");if(-1===i.indexOf(t.url)){var n=/^(https?:\/\/)/i;n.test(i)&&n.test(t.url)&&(i=i.replace(i.match(n)[1],t.url.match(n)[1]))}e.off("error.tc");e.attr("src",t instanceof TC.layer.Raster?t.getByProxy_(i):TC.proxify(i))}.bind(t));if(t&&t.options.method&&"POST"===t.options.method)t.getLegendGraphicImage().done(function(i){e.attr("src",t.getLegendUrl(i))}).fail(function(e){TC.error(e)});else{if(/[&?]REQUEST=getLegendGraphic/i.test(n)){var r=e.parent(),s=r.css("color"),a=s.indexOf("("),o=s.indexOf(")");if(a>=0&&o>a){color=s.substr(0,o).substr(a+1).split(",");s="0x";for(var l=0;l<3;l++){var c=parseInt(color[l]).toString(16);s+=1===c.length?"0"+c:c}}else s.replace("#","0x");n+="&LEGEND_OPTIONS=fontName:"+r.css("font-family")+";fontSize:"+parseInt(r.css("font-size"))+";fontColor:"+s+";fontAntiAliasing:true";t.params&&t.params.sld_body&&(n=TC.Util.addURLParameters(n,{sld_body:t.params.sld_body}));e.data(i,t.getLegendUrl(n))}e.attr("src",t.getLegendUrl(n))}}}}();TC.control=TC.control||{};TC.control.MapContents||TC.syncLoadJS(TC.apiLocation+"TC/control/MapContents");TC.control.TOC=function(){TC.control.MapContents.apply(this,arguments)};TC.inherit(TC.control.TOC,TC.control.MapContents);!function(){var e=TC.control.TOC.prototype;e.CLASS="tc-ctl-toc";e.template={};if(TC.isDebug){e.template[e.CLASS]=TC.apiLocation+"TC/templates/TOC.html";e.template[e.CLASS+"-branch"]=TC.apiLocation+"TC/templates/TOCBranch.html";e.template[e.CLASS+"-node"]=TC.apiLocation+"TC/templates/TOCNode.html"}else{e.template[e.CLASS]=function(){dust.register(e.CLASS,t);function t(e,t){return e.w("<h2>").h("i18n",t,{},{$key:"worklayers"}).w('</h2><div class="tc-ctl-toc-tree"><form><div class="tc-ctl-toc-empty">').h("i18n",t,{},{$key:"noData"}).w('</div><ul class="tc-ctl-toc-branch tc-ctl-toc-wl">').s(t.get(["workLayers"],!1),t,{block:i},{}).w("</ul></form></div>")}t.__dustBody=!0;function i(e,t){return e.p("tc-ctl-toc-wlbranch",t,t.rebase(t.getPath(!0,[])),{})}i.__dustBody=!0;return t};e.template[e.CLASS+"-branch"]=function(){dust.register(e.CLASS+"-branch",t);function t(e,t){return e.w("<li ").x(t.get(["children"],!1),t,{else:i,block:n},{}).w(' data-tc-layer-name="').f(t.get(["name"],!1),t,"h").w('" data-tc-layer-uid="').f(t.get(["uid"],!1),t,"h").w('"><input type="checkbox" class="tc-ctl-toc-branch-cb" name="toc" value="').f(t.get(["name"],!1),t,"h").w('"').x(t.get(["isVisible"],!1),t,{block:r},{}).w(" /><span>").f(t.get(["title"],!1),t,"h").w('</span><ul class="tc-ctl-toc-branch">').s(t.get(["children"],!1),t,{block:s},{}).w("</ul></li>")}t.__dustBody=!0;function i(e,t){return e.w('class="tc-ctl-toc-node tc-ctl-toc-leaf"')}i.__dustBody=!0;function n(e,t){return e.w('class="tc-ctl-toc-node"')}n.__dustBody=!0;function r(e,t){return e.w(" checked")}r.__dustBody=!0;function s(e,t){return e.p("tc-ctl-toc-node",t,t.rebase(t.getPath(!0,[])),{})}s.__dustBody=!0;return t};e.template[e.CLASS+"-node"]=function(){dust.register(e.CLASS+"-node",t);function t(e,t){return e.w("<li ").x(t.get(["children"],!1),t,{else:i,block:n},{}).w(' data-tc-layer-name="').f(t.get(["name"],!1),t,"h").w('" data-tc-layer-uid="').f(t.get(["uid"],!1),t,"h").w('"><input type="checkbox" name="toc" value="').f(t.get(["name"],!1),t,"h").w('"').x(t.get(["isVisible"],!1),t,{block:r},{}).w(" /><span>").f(t.get(["title"],!1),t,"h").w('</span><ul class="tc-ctl-toc-branch">').s(t.get(["children"],!1),t,{block:s},{}).w("</ul></li>")}t.__dustBody=!0;function i(e,t){return e.w('class="tc-ctl-toc-node tc-ctl-toc-leaf"')}i.__dustBody=!0;function n(e,t){return e.w('class="tc-ctl-toc-node"')}n.__dustBody=!0;function r(e,t){return e.w(" checked")}r.__dustBody=!0;function s(e,t){return e.p("tc-ctl-toc-node",t,t.rebase(t.getPath(!0,[])),{})}s.__dustBody=!0;return t}}var t="tcLayer",i="tcLayerUid";e.register=function(e){var t=this;TC.control.MapContents.prototype.register.call(t,e);t._addBrowserEventHandlers();e.on(TC.Consts.event.EXTERNALSERVICEADDED,function(i){if(i&&i.layer){i.layer.map=e;e.addLayer(i.layer);t.updateLayerTree(i.layer)}})};e._addBrowserEventHandlers=function(){var e=this;e._$div.on("click.tc","input[type=checkbox]",function(n){var r=$(n.target),s=r.closest("ul."+e.CLASS+"-wl").children("li").has(r).data(t),a=r.parents("li").first().data(i),o=r.prop("checked");s.setNodeVisibility(a,o);n.stopPropagation()}).on(TC.Consts.event.MOUSEUP,"li",function(t){var i=$(t.target);if(!i.hasClass(e.CLASS+"-leaf")){i.toggleClass(TC.Consts.classes.COLLAPSED);i.find("ul").first().toggleClass(TC.Consts.classes.COLLAPSED);t.stopPropagation()}})};e.update=function(){var e=function(e){return e.children("input[type=checkbox]")};this._$div.find("ul."+this.CLASS+"-wl").first().children("li").each(function(n,r){var s=$(r),a=s.data(t);if(a){var o=a.getVisibility();e(s).prop("checked",o);a.tree=null;s.find("li").each(function(t,n){var r=$(n),s=e(r),o=r.data(i);switch(a.getNodeVisibility(o)){case TC.Consts.visibility.VISIBLE:case TC.Consts.visibility.NOT_VISIBLE_AT_RESOLUTION:s.prop("checked",!0);s.prop("indeterminate",!1);break;case TC.Consts.visibility.HAS_VISIBLE:s.prop("checked",!1);s.prop("indeterminate",!0);break;default:s.prop("checked",!1);s.prop("indeterminate",!1)}})}});this.updateScale()};e.updateScale=function(){var e=this;e._$div.find("ul."+e.CLASS+"-wl").children("li").each(function(n,r){var s=$(r),a=s.data(t);s.find("li").each(function(t,n){var r=$(n);r.toggleClass(e.CLASS+"-node-notvisible",!a.isVisibleByScale(r.data(i)))})})};e.updateLayerTree=function(e){var n=this;if(!e.isBase&&!e.options.stealth){TC.control.MapContents.prototype.updateLayerTree.call(n,e);n._$div.find("."+n.CLASS+"-empty").addClass(TC.Consts.classes.HIDDEN);var r=n.CLASS+"-branch";TC.loadJSInOrder(!window.dust,TC.url.templating,function(){dust.render(r,n.layerTrees[e.id],function(r,s){var a=$(s);Modernizr.canvas||a.find("li:last-child").addClass(TC.Consts.classes.LASTCHILD);var o=a.data(i),l=n._$div.find("."+n.CLASS+"-wl"),c=l.find('li[data-tc-layer-uid="'+o+'"]');if(1===c.length){c.html(a.html());c.data(t)||c.data(t,e)}else{a.data(t,e);l.prepend(a)}r&&TC.error(r)});var s="ul."+n.CLASS+"-wl",a="ul."+n.CLASS+"-branch",o="li."+n.CLASS+"-node",l="li."+n.CLASS+"-leaf";n._$div.find(s+" "+a+" "+a+","+s+" "+a+" "+o).not(l).addClass(TC.Consts.classes.COLLAPSED);n.update()})}};e.removeLayer=function(e){if(!e.isBase){var i=this,n=function(){return i._$div.find("."+i.CLASS+"-wl").children("li")},r=n();r.each(function(i,s){var a=$(s);if(a.data(t)===e){a.remove();r=n();return!1}});0===r.length&&i._$div.find("."+i.CLASS+"-empty").removeClass(TC.Consts.classes.HIDDEN)}};e.updateLayerVisibility=function(e){var i=this;i._$div.find("."+i.CLASS+"-wl").children("li").each(function(n,r){var s=$(r);if(s.data(t)===e){var a=!e.getVisibility(),o=s.find("input[type=checkbox]"),l=o.filter("."+i.CLASS+"-branch-cb");l.prop("checked",!a);o.not(l).prop("disabled",a);return!1}})};e.updateLayerOrder=function(e,t,i){};e.render=function(e){var t=this;TC.Control.prototype.render.call(t,function(){var i=t.options.controls||[];if(i.length>0){var n=i[0],r=$("<div/>");t._$div.append(r);t.map.addControl(n.name,$.extend({div:r},n.options))}$.isFunction(e)&&e()})}}();TC.control=TC.control||{};TC.control.TOC||TC.syncLoadJS(TC.apiLocation+"TC/control/TOC");TC.control.WorkLayerManager=function(){TC.control.TOC.apply(this,arguments);this.layers=[]};TC.inherit(TC.control.WorkLayerManager,TC.control.TOC);!function(){var e=TC.control.WorkLayerManager.prototype;e.CLASS="tc-ctl-wlm";e.CLICKEVENT="click.tc";TC.Consts.classes.DRAG=TC.Consts.classes.DRAG||"tc-drag";TC.Consts.classes.DRAGEND=TC.Consts.classes.DRAGEND||"tc-dragend";TC.Consts.event.TOOLSOPEN=TC.Consts.event.TOOLSOPEN||"toolsopen.tc";e.template={};if(TC.isDebug){e.template[e.CLASS]=TC.apiLocation+"TC/templates/WorkLayerManager.html";e.template[e.CLASS+"-elm"]=TC.apiLocation+"TC/templates/WorkLayerManagerElement.html";e.template[e.CLASS+"-type-sgl"]=TC.apiLocation+"TC/templates/WorkLayerManagerTooltipSingle.html";e.template[e.CLASS+"-type-grp"]=TC.apiLocation+"TC/templates/WorkLayerManagerTooltipGroup.html";e.template[e.CLASS+"-type-grp-node"]=TC.apiLocation+"TC/templates/WorkLayerManagerTooltipGroupNode.html"}else{e.template[e.CLASS]=function(){dust.register(e.CLASS,t);function t(e,t){return e.w("<h2>").h("i18n",t,{},{$key:"loadedLayers"}).w('<span class="tc-ctl-wlm-n"></span><button class="tc-ctl-wlm-del-all tc-hidden" title="').h("i18n",t,{},{$key:"removeAllLayersFromMap"}).w('"></button></h2><div class="tc-ctl-wlm-empty">').h("i18n",t,{},{$key:"noData"}).w('</div><div class="tc-ctl-wlm-content tc-hidden"><form><ul>').s(t.get(["workLayers"],!1),t,{block:i},{}).w("</ul></form></div>")}t.__dustBody=!0;function i(e,t){return e.p("tc-ctl-wlm-elm",t,t.rebase(t.getPath(!0,[])),{})}i.__dustBody=!0;return t};e.template[e.CLASS+"-elm"]=function(){dust.register(e.CLASS+"-elm",t);function t(e,t){return e.w('<li class="tc-ctl-wlm-elm" tabindex="-1"><div class="tc-ctl-wlm-lyr">').x(t.get(["path"],!1),t,{block:i},{}).w('</div><div class="tc-ctl-wlm-type"></div><div class="tc-ctl-wlm-path" title="').s(t.get(["path"],!1),t,{else:n,block:r},{}).w('">').s(t.get(["path"],!1),t,{else:a,block:o},{}).w('</div><div><div class="tc-ctl-wlm-btn-info" title="').h("i18n",t,{},{$key:"infoFromThisLayer"}).w('"></div><input type="range" value="').f(t.get(["opacity"],!1),t,"h").w('" title="').h("i18n",t,{},{$key:"transparencyOfThisLayer"}).w('" /><input type="checkbox" ').nx(t.get(["hide"],!1),t,{block:c},{}).w(' title="').h("i18n",t,{},{$key:"visibilityOfThisLayer"}).w('" /></div><div class="tc-ctl-wlm-info tc-hidden">').x(t.get(["abstract"],!1),t,{block:u},{}).x(t.get(["customLegend"],!1),t,{else:h,block:f},{}).x(t.get(["metadata"],!1),t,{block:m},{}).w('</div><div class="tc-ctl-wlm-dd ').x(t.get(["hide"],!1),t,{block:g},{}).w('" title="').h("i18n",t,{},{$key:"dragToReorder"}).w('"></div><div class="tc-ctl-wlm-del ').nx(t.get(["hide"],!1),t,{block:C},{}).w('" title="').h("i18n",t,{},{$key:"removeLayerFromMap"}).w('"></div></li>')}t.__dustBody=!0;function i(e,t){return e.f(t.get(["title"],!1),t,"h")}i.__dustBody=!0;function n(e,t){return e.f(t.get(["title"],!1),t,"h")}n.__dustBody=!0;function r(e,t){return e.f(t.getPath(!0,[]),t,"h").h("sep",t,{block:s},{})}r.__dustBody=!0;function s(e,t){return e.w(" &bull; ")}s.__dustBody=!0;function a(e,t){return e.f(t.get(["title"],!1),t,"h")}a.__dustBody=!0;function o(e,t){return e.f(t.getPath(!0,[]),t,"h").h("sep",t,{block:l},{})}o.__dustBody=!0;function l(e,t){return e.w(" &bull; ")}l.__dustBody=!0;function c(e,t){return e.w('checked="checked"')}c.__dustBody=!0;function u(e,t){return e.w('<div class="tc-ctl-wlm-abstract"><h4>').h("i18n",t,{},{$key:"abstract"}).w("</h4><div><pre>").f(t.get(["abstract"],!1),t,"h",["s"]).w("</pre></div></div>")}u.__dustBody=!0;function h(e,t){return e.x(t.get(["legend"],!1),t,{block:p},{})}h.__dustBody=!0;function p(e,t){return e.w('<div class="tc-ctl-wlm-legend" data-tc-layer-name="').f(t.get(["layerNames"],!1),t,"h").w('"><h4>').h("i18n",t,{},{$key:"content"}).w("</h4>").s(t.get(["legend"],!1),t,{block:d},{}).w("</div>")}p.__dustBody=!0;function d(e,t){return e.w("<div><p>").f(t.get(["title"],!1),t,"h").w('</p><img data-tc-img="').f(t.get(["src"],!1),t,"h").w('" /></div>')}d.__dustBody=!0;function f(e,t){return e.w('<ul class="tc-ctl-wlm-custom-legend">').f(t.get(["customLegend"],!1),t,"h",["s"]).w("</ul>")}f.__dustBody=!0;function m(e,t){return e.w('<div class="tc-ctl-wlm-metadata"><h4>').h("i18n",t,{},{$key:"metadata"}).w("</h4><ul>").s(t.get(["metadata"],!1),t,{block:y},{}).w("</ul></div>")}m.__dustBody=!0;function y(e,t){return e.w('<li><a href="').f(t.get(["url"],!1),t,"h",["s"]).w('" type="').f(t.get(["format"],!1),t,"h").w('" title="').f(t.get(["formatDescription"],!1),t,"h").w('" target="_blank">').f(t.get(["formatDescription"],!1),t,"h").w("</a></li>")}y.__dustBody=!0;function g(e,t){return e.w("tc-hidden")}g.__dustBody=!0;function C(e,t){return e.w("tc-hidden")}C.__dustBody=!0;return t};e.template[e.CLASS+"-type-sgl"]=function(){dust.register(e.CLASS+"-type-sgl",t);function t(e,t){return e.h("i18n",t,{},{$key:"singleLayer"})}t.__dustBody=!0;return t};e.template[e.CLASS+"-type-grp"]=function(){dust.register(e.CLASS+"-type-grp",t);function t(e,t){return e.w("<div>").h("i18n",t,{},{$key:"groupLayerThatContains"}).w(":</div><ul>").s(t.get(["Layer"],!1),t,{block:i},{}).w("</ul>")}t.__dustBody=!0;function i(e,t){return e.p("tc-ctl-wlm-type-grp-node",t,t.rebase(t.getPath(!0,[])),{})}i.__dustBody=!0;return t};e.template[e.CLASS+"-type-grp-node"]=function(){dust.register(e.CLASS+"-type-grp-node",t);function t(e,t){return e.w('<li class="tc-ctl-wlm-tip-grp-elm"><span>').f(t.get(["Title"],!1),t,"h").w("</span><ul>").s(t.get(["Layer"],!1),t,{block:i},{}).w("</ul></li>")}t.__dustBody=!0;function i(e,t){return e.p("tc-ctl-wlm-type-grp-node",t,t.rebase(t.getPath(!0,[])),{})}i.__dustBody=!0;return t}}var t="tcLayer",i=function(e,i){var n;e._$div.find("li."+e.CLASS+"-elm").each(function(e,r){var s=$(r);if(s.data(t)===i){n=s;return!1}});return n},n=function(e){return $.grep(e.map.workLayers,function(e){return!e.stealth}).length};e.register=function(e){var t=this;TC.control.TOC.prototype.register.call(t,e);e.off(TC.Consts.event.EXTERNALSERVICEADDED);e.on(TC.Consts.event.LAYEROPACITY,function(e){var n=i(t,e.layer);n&&n.find("input[type=range]").val(Math.round(100*e.opacity))}).on(TC.Consts.event.FEATURESIMPORT,function(i){var n=i.fileName;if(i.features&&i.features.length>0){var r="."+TC.Consts.format.GPX.toLowerCase();if(i.fileName.toLowerCase().indexOf(r)===i.fileName.length-r.length)return;e.one(TC.Consts.event.LAYERADD,function(e){if(e&&e.layer&&e.layer.title==n){if(t.map&&t.map.layout&&t.map.layout.accordion&&t._$div.hasClass(TC.Consts.classes.COLLAPSED))for(var i=0;i<t.map.controls.length;i++)t.map.controls[i]!==t&&t.map.controls[i]._$div.addClass(TC.Consts.classes.COLLAPSED);t.map.$events.trigger($.Event(TC.Consts.event.TOOLSOPEN),{});t._$div.removeClass(TC.Consts.classes.COLLAPSED)}})}})};e._addBrowserEventHandlers=function(){var e=this;e._$div.on(e.CLICKEVENT,"input[type=checkbox]",function(i){var n=$(i.target),r=n.parents("li."+e.CLASS+"-elm").first().data(t),s=n.prop("checked");r.setVisibility(s);i.stopPropagation()}).on("change input","input[type=range]",function(e){var i=$(e.target);i.parents("li").first().data(t).setOpacity(i.val()/100)}).on(e.CLICKEVENT,"."+e.CLASS+"-del",function(i){var n=$(i.target).parents("li").first().data(t);e.map.removeLayer(n)}).on(e.CLICKEVENT,"."+e.CLASS+"-del-all",function(i){TC.confirm(e.getLocaleString("layersRemove.confirm"),function(){var i=e._$div.find("li."+e.CLASS+"-elm"),n=new Array(i.length);i.each(function(e,i){n[e]=$(i).data(t)});for(var r=0,s=n.length;r<s;r++)e.map.removeLayer(n[r])})}).on(e.CLICKEVENT,"."+e.CLASS+"-btn-info",function(i){var n=$(i.target),r=n.parents("li").first(),s=r.find("."+e.CLASS+"-info");s.find("."+e.CLASS+"-legend img").each(function(i,n){var s=r.data(t);e.styleLegendImage($(n),s)});s.toggleClass(TC.Consts.classes.HIDDEN);r.find('input[type="checkbox"]').is(":checked")&&r.find("."+e.CLASS+"-dd").toggleClass(TC.Consts.classes.HIDDEN,!s.hasClass(TC.Consts.classes.HIDDEN));n.toggleClass(TC.Consts.classes.CHECKED)})};e.updateLayerVisibility=function(e){var t=i(this,e);if(t){var n=e.getVisibility();t.find("."+this.CLASS+"-del").toggleClass(TC.Consts.classes.HIDDEN,n);t.find("."+this.CLASS+"-info").hasClass(TC.Consts.classes.HIDDEN)&&t.find("."+this.CLASS+"-dd").toggleClass(TC.Consts.classes.HIDDEN,!n)}};e.updateLayerTree=function(e){var i=this,r=function(e,n,r){if(e!==n){for(var s=e.data(t),a=n.data(t),o=-1,l=0;l<i.map.layers.length;l++)if(a===i.map.layers[l]){o=l;break}o>=1&&o<i.map.layers.length&&i.map.insertLayer(s,o,r)}};if(!e.isBase&&!e.options.stealth){TC.control.MapContents.prototype.updateLayerTree.call(i,e);for(var s=!1,a=0,o=i.layers.length;a<o;a++)if(e===i.layers[a]){s=!0;break}if(!s){var l=i.CLASS+"-elm";i.layers.push(e);TC.loadJSInOrder(!window.dust,TC.url.templating,function(){TC.loadJS(!$.fn.drag,[TC.apiLocation+"lib/jQuery/jquery.event.drag.js"],function(){var n=e.title||e.wrap.getServiceTitle(),s={title:e.options.hideTitle?"":n,hide:!(!e.renderOptions||!e.renderOptions.hide),opacity:e.renderOptions&&e.renderOptions.opacity?100*e.renderOptions.opacity:100,customLegend:e.customLegend},a=e.isRaster();if(a){s.layerNames=e.layerNames;var o=e.getPath();o.shift();s.path=o;var c=e.names[0],u=e.wrap.getInfo(c);s.legend=u.legend;s.abstract=u.abstract;var h,p=u.hasOwnProperty("abstract")||u.hasOwnProperty("legend")||u.hasOwnProperty("metadata");if(e.tree&&e.tree.children&&e.tree.children.length&&e.tree.children[0].children&&e.tree.children[0].children.length)h=null;else if(h=u.metadata)for(var d=0,f=h.length;d<f;d++){var m=h[d];m.formatDescription=i.getLocaleString(TC.Util.getSimpleMimeType(m.format))||i.getLocaleString("viewMetadata")}s.metadata=h}(function(e){var t=$.Deferred();e&&e.options.method&&"POST"===e.options.method?e.getLegendGraphicImage().done(function(e){t.resolve(e)}).fail(function(e){TC.error(e)}):t.resolve();return t.promise()})(e).done(function(n){n&&(legend.src=e.getLegendUrl(n));dust.render(l,s,function(n,s){var o,l=$(s),u=!1;if(a&&!(u=e.names.length>1))for(var h=e.wrap.getAllLayerNodes(),d=0;d<h.length;d++){var f=h[d];if(e.wrap.getName(f)===c){o=f;e.wrap.getLayerNodes(f).length>0&&(u=!0);break}}var m=l.find("."+i.CLASS+"-type"),y=u?i.CLASS+"-type-grp":i.CLASS+"-type-sgl";m.addClass(y);p||l.find("."+i.CLASS+"-btn-info").addClass(TC.Consts.classes.HIDDEN);if(o){e.wrap.normalizeLayerNode(o);dust.render(y,o,function(e,t){var n;m.on("mouseover",function(e){var r=m.offset(),s=$(i.map.div).offset();n=$("<div>").addClass(i.CLASS+"-tip").html(t).css({top:r.top-s.top+"px",right:$(i.map.div).width()-(r.left-s.left)+"px"}).appendTo(i.map.div)}).on("mouseout",function(e){n.remove()})})}var g=i._$div.find("ul").first();l.data(t,e);l.drag("start",function(e,t){var i=$(this),n=g.children("li");n.not(i).addClass(TC.Consts.classes.DRAGEND);n.index(i);i.css("zIndex",100).addClass(TC.Consts.classes.DRAG);var r=n.last(),s=i.position();t.limit={top:n.first().position().top-s.top,bottom:r.height()+r.position().top-s.top-i.height()-1};t.dropTargetIndex=-1}).drag("end",function(e,t){var i=$(this);i.removeClass(TC.Consts.classes.DRAG).addClass(TC.Consts.classes.DRAGEND);var n,s,a=function(e){return parseInt(e.substr(e.lastIndexOf(",")+1))},o=a(i.css("transform")),l=this.getBoundingClientRect().top-o;if(t.dropTargetIndex>=0){n=g.children("li").get(t.dropTargetIndex);var c=a((s=$(n)).css("transform")),u=n.getBoundingClientRect().top-c}i.css("transform",s?"translateY("+(u-l)+"px)":"");i.on("transitionend.tc",function e(t){if("transform"===t.originalEvent.propertyName){i.off("transitionend.tc",e).removeClass(TC.Consts.classes.DRAGEND).css("zIndex","");s&&r(i,s,function(){g.children("li").css("transform","").removeClass(TC.Consts.classes.DRAGEND)})}})}).drag(function(e,t){var i,n,r=$(this),s=Math.min(Math.max(t.limit.top,Math.round(t.deltaY)),t.limit.bottom),a=this.getBoundingClientRect(),o=a.height-1,l=(a.top+a.bottom)/2,c=[];g.children("li").each(function(e,n){var r=n.getBoundingClientRect();c[e]={elm:n,top:r.top,bottom:r.bottom};n===t.drag&&(i=e)});for(var u=-1,h=0,p=c.length;h<p;h++){var d=c[h];if(h<i){if(l<d.bottom)if(l>d.top&&t.deltaY>t.prevDeltaY)n="";else{n="translateY("+o+"px)";u<0&&(u=h)}else n="";$(d.elm).css("transform",n)}else if(h>i){if(l>d.top)if(l<d.bottom&&t.deltaY<t.prevDeltaY)n="";else{n="translateY(-"+o+"px)";u=h}else n="";$(d.elm).css("transform",n)}}t.dropTargetIndex=u;r.css("transform","translateY("+s+"px)");t.prevDeltaY=t.deltaY},{handle:"."+i.CLASS+"-dd"}).on("keydown",function(e){var t=this,i=function(){t.focus()},n=$(this);switch(!0){case/Up$/.test(e.key):var s=n.prev();s.length&&r(n,s,i);break;case/Down$/.test(e.key):var a=n.next();a.length&&r(n,a,i)}});const C=i.map.workLayers.filter(function(e){return!e.stealth}).reverse().indexOf(e),v=g.find("li."+i.CLASS+"-elm");v.length<=C?g.append(l):l.insertBefore(v[C]);i.updateScale()})})})});var c=n(i);$("."+i.CLASS+"-n").text(c).toggleClass(TC.Consts.classes.VISIBLE,c>0);i._$div.find("."+i.CLASS+"-empty").toggleClass(TC.Consts.classes.HIDDEN,c>0);i._$div.find("."+i.CLASS+"-content").toggleClass(TC.Consts.classes.HIDDEN,0===c);i._$div.find("."+i.CLASS+"-del-all").toggleClass(TC.Consts.classes.HIDDEN,!1)}}};e.updateScale=function(){var e=this;e._$div.find("ul").find("li."+e.CLASS+"-elm").each(function(i,n){var r=$(n),s=r.data(t);if(s.names){for(var a=!1,o=0;o<s.names.length;o++)if(s.isVisibleByScale(s.names[o])){a=!0;break}r.toggleClass(e.CLASS+"-elm-notvisible",!a)}})};e.updateLayerOrder=function(e,t,i){TC.control.MapContents.prototype.updateLayerOrder.call(this,e,t,i)};e.removeLayer=function(e){var i=this.layers.indexOf(e);i>=0&&this.layers.splice(i,1);this._$div.find("ul").first().find("li."+this.CLASS+"-elm").each(function(i,n){var r=$(n);if(r.data(t)===e){r.remove();return!1}});var r=n(this);this._$div.find("."+this.CLASS+"-del-all").toggleClass(TC.Consts.classes.HIDDEN,0===r);this._$div.find("."+this.CLASS+"-content").toggleClass(TC.Consts.classes.HIDDEN,0===r);this._$div.find("."+this.CLASS+"-empty").toggleClass(TC.Consts.classes.HIDDEN,r>0);$("."+this.CLASS+"-n").text(r).toggleClass(TC.Consts.classes.VISIBLE,r>0)};e.getLayerUIElements=function(){return this._$div.find("ul").first().children("li."+this.CLASS+"-elm")}}();TC.control=TC.control||{};TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control");TC.control.Click=function(){TC.Control.apply(this,arguments);this.options&&this.options.callback&&(this.callback=this.options.callback);this.wrap=new TC.wrap.control.Click(this)};TC.inherit(TC.control.Click,TC.Control);!function(){var e=TC.control.Click.prototype;e.CLASS="tc-ctl-click";e.register=function(e){this.wrap.register(e);TC.Control.prototype.register.call(this,e)};e.activate=function(){TC.Control.prototype.activate.call(this);this.wrap.activate()};e.deactivate=function(){this.wrap.deactivate();TC.Control.prototype.deactivate.call(this)};e.callback=function(e,t){console.log("[Click]["+e[0]+", "+e[1]+"]["+t[0]+", "+t[1]+"]")}}();TC.control=TC.control||{};TC.control.Click||TC.syncLoadJS(TC.apiLocation+"TC/control/Click");TC.Consts.event.POPUPHIDE=TC.Consts.event.POPUPHIDE||"popuphide.tc";TC.Consts.event.RESULTSPANELCLOSE=TC.Consts.event.RESULTSPANELCLOSE||"resultspanelclose.tc";TC.control.FeatureInfoCommons=function(){const e=this;TC.control.Click.apply(e,arguments);e.resultsLayer=null;e.filterLayer=null;e._layersDeferred=$.Deferred();e.filterFeature=null;e.info=null;e.popup=null;e.resultsPanel=null;e.lastFeatureCount=null;e.tools=[];e._$dialogDiv=$(TC.Util.getDiv(e.options.dialogDiv));e.options.dialogDiv||e._$dialogDiv.appendTo("body")};TC.control.FeatureInfoCommons.displayMode={POPUP:"popup",RESULTS_PANEL:"resultsPanel"};!function(){var e=function(e){return e.info.services?e.info.services.reduce(function(e,t){return e+t.layers.reduce(function(e,t){return e+1},0)},0):0},t="ul.tc-ctl-finfo-features li",i=function(e){$(e.getDisplayTarget()).find("ul."+e.CLASS+"-services li").removeClass(TC.Consts.classes.CHECKED).removeClass(TC.Consts.classes.DISABLED).removeClass(TC.Consts.classes.FROMLEFT).removeClass(TC.Consts.classes.FROMRIGHT)};TC.inherit(TC.control.FeatureInfoCommons,TC.control.Click);var n=TC.control.FeatureInfoCommons.prototype;n.CLASS="tc-ctl-finfo";n.template={};if(TC.isDebug){n.template[n.CLASS]=TC.apiLocation+"TC/templates/FeatureInfo.html";n.template[n.CLASS+"-dialog"]=TC.apiLocation+"TC/templates/FeatureInfoDialog.html";n.template[n.CLASS+"-del-btn"]=TC.apiLocation+"TC/templates/FeatureInfoDeleteButton.html"}else{n.template[n.CLASS]=function(){dust.register(n.CLASS,e);function e(e,i){return e.x(i.get(["elevation"],!1),i,{block:t},{}).w('<ul class="tc-ctl-finfo-services">').s(i.get(["services"],!1),i,{else:s,block:o},{}).w("</ul>").x(i.get(["featureCount"],!1),i,{block:M},{})}e.__dustBody=!0;function t(e,t){return e.w('<div class="tc-ctl-finfo-coords"><span class="tc-ctl-finfo-coords-pair tc-ctl-finfo-coords-crs">CRS: <span class="tc-ctl-finfo-coords-val">').f(t.get(["crs"],!1),t,"h").w("</span></span> ").x(t.get(["isGeo"],!1),t,{else:i,block:r},{}).w(' <span class="tc-ctl-finfo-coords-pair">').h("i18n",t,{},{$key:"ele"}).w(': <span class="tc-ctl-finfo-coords-val">').f(t.get(["elevation"],!1),t,"h").w(" m</span></span></div>")}t.__dustBody=!0;function i(e,t){return e.w('<span class="tc-ctl-finfo-coords-pair tc-ctl-finfo-coords-x">x: <span class="tc-ctl-finfo-coords-val">').f(t.getPath(!1,["coords","0"]),t,"h").w('</span></span> <span class="tc-ctl-finfo-coords-pair tc-ctl-finfo-coords-x">y: <span class="tc-ctl-finfo-coords-val">').f(t.getPath(!1,["coords","1"]),t,"h").w("</span></span> ")}i.__dustBody=!0;function r(e,t){return e.w('<span class="tc-ctl-finfo-coords-pair tc-ctl-finfo-coords-lat">').h("i18n",t,{},{$key:"lat"}).w(': <span class="tc-ctl-finfo-coords-val">').f(t.getPath(!1,["coords","1"]),t,"h").w('</span></span> <span class="tc-ctl-finfo-coords-pair tc-ctl-finfo-coords-lon">').h("i18n",t,{},{$key:"lon"}).w(': <span class="tc-ctl-finfo-coords-val">').f(t.getPath(!1,["coords","0"]),t,"h").w("</span></span> ")}r.__dustBody=!0;function s(e,t){return e.nx(t.get(["elevation"],!1),t,{block:a},{})}s.__dustBody=!0;function a(e,t){return e.w('<li class="tc-ctl-finfo-empty">').h("i18n",t,{},{$key:"noData"}).w("</li>")}a.__dustBody=!0;function o(e,t){return e.w("<li><h3>").x(t.get(["title"],!1),t,{else:l,block:h},{}).w('</h3><div class="tc-ctl-finfo-service-content">').s(t.get(["hasLimits"],!1),t,{else:p,block:N},{}).w("</div></li>")}o.__dustBody=!0;function l(e,t){return e.x(t.getPath(!1,["mapLayer","title"]),t,{else:c,block:u},{})}l.__dustBody=!0;function c(e,t){return e.f(t.getPath(!1,["mapLayer","id"]),t,"h")}c.__dustBody=!0;function u(e,t){return e.f(t.getPath(!1,["mapLayer","title"]),t,"h")}u.__dustBody=!0;function h(e,t){return e.f(t.get(["title"],!1),t,"h")}h.__dustBody=!0;function p(e,t){return e.w('<ul class="tc-ctl-finfo-layers">').s(t.get(["layers"],!1),t,{else:d,block:f},{}).w("</ul>")}p.__dustBody=!0;function d(e,t){return e.w('<li class="tc-ctl-finfo-empty">').h("i18n",t,{},{$key:"noDataAtThisService"}).w("</li>")}d.__dustBody=!0;function f(e,t){return e.w('<li><h4><span class="tc-ctl-finfo-layer-n">').f(t.getPath(!1,["features","length"]),t,"h").w("</span> ").s(t.get(["path"],!1),t,{block:m},{}).w(' </h4> <div class="tc-ctl-finfo-layer-content"><ul class="tc-ctl-finfo-features">').s(t.get(["features"],!1),t,{else:g,block:C},{}).w("</ul></div></li>")}f.__dustBody=!0;function m(e,t){return e.f(t.getPath(!0,[]),t,"h").h("sep",t,{block:y},{})}m.__dustBody=!0;function y(e,t){return e.w(" &bull; ")}y.__dustBody=!0;function g(e,t){return e.w('<li class="tc-ctl-finfo-empty">').h("i18n",t,{},{$key:"noDataInThisLayer"}).w("</li>")}g.__dustBody=!0;function C(e,t){return e.w("<li>").x(t.get(["rawContent"],!1),t,{else:v,block:E},{}).w("</li>")}C.__dustBody=!0;function v(e,t){return e.x(t.get(["error"],!1),t,{else:T,block:S},{})}v.__dustBody=!0;function T(e,t){return e.w("<h5>").f(t.get(["id"],!1),t,"h").w("</h5><table").x(t.get(["geometry"],!1),t,{block:L},{}).w("><tbody>").s(t.get(["attributes"],!1),t,{block:w},{}).w("</tbody></table>").x(t.get(["geometry"],!1),t,{block:b},{})}T.__dustBody=!0;function L(e,t){return e.w(' title="').h("i18n",t,{},{$key:"clickToCenter"}).w('"')}L.__dustBody=!0;function w(e,t){return e.w('<tr><th class="tc-ctl-finfo-attr">').f(t.get(["name"],!1),t,"h").w('</th><td class="tc-ctl-finfo-val">').f(t.get(["value"],!1),t,"h").w("</td></tr>")}w.__dustBody=!0;function b(e,t){return e.w('<div class="tc-ctl-finfo-tools"><button class="tc-ctl-finfo-tools-btn" title="').h("i18n",t,{},{$key:"download"}).w("/").h("i18n",t,{},{$key:"share"}).w('">').h("i18n",t,{},{$key:"download"}).w("/").h("i18n",t,{},{$key:"share"}).w("</button></div>")}b.__dustBody=!0;function S(e,t){return e.w('<span class="tc-ctl-finfo-errors">').h("i18n",t,{},{$key:"fi.error"}).w('<span class="tc-ctl-finfo-error-text">').f(t.get(["error"],!1),t,"h").w("</span></span>")}S.__dustBody=!0;function E(e,t){return e.w("<h5>").h("i18n",t,{},{$key:"feature"}).w("</h5>").h("eq",t,{else:O,block:A},{key:t.get(["rawFormat"],!1),value:"text/html"})}E.__dustBody=!0;function O(e,t){return e.w("<pre>").f(t.get(["rawContent"],!1),t,"h").w("</pre>")}O.__dustBody=!0;function A(e,t){return e.w(" ").x(t.get(["expandUrl"],!1),t,{block:x},{})}A.__dustBody=!0;function x(e,t){return e.h("ne",t,{else:P,block:_},{key:t.get(["expandUrl"],!1),value:""})}x.__dustBody=!0;function P(e,t){return e.w('<iframe src="').f(t.get(["rawUrl"],!1),t,"h").w('" />')}P.__dustBody=!0;function _(e,t){return e.w('<div class="tc-ctl-finfo-features-iframe-cnt"><iframe src="').f(t.get(["rawUrl"],!1),t,"h").w('" /><a class="tc-ctl-finfo-open" onclick="window.open(\'').f(t.get(["expandUrl"],!1),t,"h").w("', '_blank')\" title=\"").h("i18n",t,{},{$key:"expand"}).w('"></a></div>')}_.__dustBody=!0;function N(e,t){return e.w('<span class="tc-ctl-finfo-errors">').f(t.get(["hasLimits"],!1),t,"h").w("</span>")}N.__dustBody=!0;function M(e,t){return e.h("gt",t,{block:k},{key:t.get(["featureCount"],!1),value:"1",type:"number"})}M.__dustBody=!0;function k(e,t){return e.w('<a class="tc-ctl-btn tc-ctl-finfo-btn-prev">').h("i18n",t,{},{$key:"previous"}).w('</a><div class="tc-ctl-finfo-counter"><span class="tc-ctl-finfo-counter-current"></span>/').f(t.get(["featureCount"],!1),t,"h").w('</div><a class="tc-ctl-btn tc-ctl-finfo-btn-next">').h("i18n",t,{},{$key:"next"}).w("</a>")}k.__dustBody=!0;return e};n.template[n.CLASS+"-dialog"]=function(){dust.register(n.CLASS+"-dialog",e);function e(e,t){return e.w('<div class="tc-ctl-finfo-dialog tc-modal"><div class="tc-modal-background tc-modal-close"></div><div class="tc-modal-window"><div class="tc-modal-header"><h3>').h("i18n",t,{},{$key:"feature"}).w('</h3><div class="tc-ctl-popup-close tc-modal-close"></div></div><div class="tc-modal-body"><div class="tc-ctl-finfo-dialog-dl"><h2>').h("i18n",t,{},{$key:"download"}).w('</h2><div><button class="tc-button tc-btn-dl tc-ctl-finfo-dl-btn-kml" data-format="KML" title="KML">KML</button><button class="tc-button tc-btn-dl tc-ctl-finfo-dl-btn-gml" data-format="GML" title="GML">GML</button><button class="tc-button tc-btn-dl tc-ctl-finfo-dl-btn-geojson" data-format="GeoJSON" title="GeoJSON">GeoJSON</button><button class="tc-button tc-btn-dl tc-ctl-finfo-dl-btn-wkt" data-format="WKT" title="WKT">WKT</button></div></div><div class="tc-ctl-finfo-dialog-share"></div></div></div></div>')}e.__dustBody=!0;return e};n.template[n.CLASS+"-del-btn"]=function(){dust.register(n.CLASS+"-del-btn",e);function e(e,t){return e.w('<button class="tc-ctl-finfo-del-btn" title="').h("i18n",t,{},{$key:"deleteFeature"}).w('">').h("i18n",t,{},{$key:"deleteFeature"}).w("</button>")}e.__dustBody=!0;return e}}n.register=function(e){var t,i,n=this;TC.control.Click.prototype.register.call(n,e);t=n.options.resultsLayer?n.options.resultsLayer:{id:n.getUID(),title:n.CLASS+": Results layer",type:TC.Consts.layerType.VECTOR,stealth:!0};i=n.options.filterLayer?n.options.filterLayer:{id:n.getUID(),title:n.CLASS+": Filter layer",stealth:!0,type:TC.Consts.layerType.VECTOR,styles:{line:{strokeColor:n.lineColor,strokeWidth:2},polygon:{strokeColor:n.lineColor,strokeWidth:2,fillColor:"#000",fillOpacity:.3}}};e.loaded(function(){$.when(e.addLayer(t),e.addLayer(i)).then(function(e,t){n.resultsLayer=e;n.filterLayer=t;n._layersDeferred.resolve()})});n.displayMode=n.options.displayMode||TC.control.FeatureInfoCommons.displayMode.POPUP;n.setDisplayMode(n.displayMode);e.on(TC.Consts.event.POPUPHIDE+" "+TC.Consts.event.RESULTSPANELCLOSE,function(e){if(e.control===n.getDisplayControl()&&n.resultsLayer){n.resultsLayer.clearFeatures();clearTimeout(n._removeFilterFeatureTimeout);n._removeFilterFeatureTimeout=setTimeout(function(){n.querying||n.filterLayer.clearFeatures()},0)}})};n.render=function(e){var t=this;t._$div.addClass(TC.Consts.classes.HIDDEN);t.getRenderedHtml(t.CLASS+"-dialog",null,function(e){t._$dialogDiv.html(e).on(TC.Consts.event.CLICK,"button[data-format]",function(e){TC.Util.closeModal();var i=t.resultsLayer.features[t.resultsLayer.features.length-1];t.map.exportFeatures([i],{fileName:i.id,format:$(e.target).data("format")})})})};n.responseCallback=function(e){const t=this;t.querying=!1;if(e.featureCount){t.map.$events.trigger($.Event(TC.Consts.event.FEATUREINFO,$.extend({control:t},e)));t.lastFeatureCount=e.featureCount}else{t.map.$events.trigger($.Event(TC.Consts.event.NOFEATUREINFO,{control:t}));t.lastFeatureCount=0;t.closeResults()}};n.responseError=function(e){const t=this;404===e.status&&t.map.toast(t.getLocaleString("featureInfo.tooManyLayers"),{type:TC.Consts.msgType.ERROR});t.responseCallback({})};n.markerStyle={cssClass:TC.Consts.classes.POINT,anchor:[.5,.5],width:15,height:15,noPrint:!0};n.setDisplayMode=function(e){var t=this;t.displayMode=e;var i=t.map;switch(e){case TC.control.FeatureInfoCommons.displayMode.RESULTS_PANEL:if(!t.resultsPanel){var n=i.getControlsByClass("TC.control.ResultsPanel")[0];if(n)t.resultsPanel=n;else{i.on(TC.Consts.event.CONTROLADD,function e(n){if(TC.control.ResultsPanel&&n.control instanceof TC.control.ResultsPanel){t.resultsPanel=n.control;i.off(TC.Consts.event.CONTROLADD,e)}})}}break;default:t.displayMode=TC.control.FeatureInfoCommons.displayMode.POPUP;t.popup||$.when(i.addControl("popup",{closeButton:!0,draggable:t.options.draggable})).then(function(e){t.popup=e;e.caller=t;i.on(TC.Consts.event.POPUP,function(e){t.onShowPopUp(e)});i.on(TC.Consts.event.POPUPHIDE,function(i){i.control===e&&t.popup.$popupDiv.css("width","auto")})})}};n.getDisplayControl=function(){switch(this.displayMode){case TC.control.FeatureInfoCommons.displayMode.RESULTS_PANEL:return this.resultsPanel;default:return this.popup}};n.getDisplayTarget=function(){switch(this.displayMode){case TC.control.FeatureInfoCommons.displayMode.RESULTS_PANEL:return this.resultsPanel.$divTable.get(0);default:return this.popup.$popupDiv.get(0)}};n.displayResults=function(){this.filterFeature.data=$("<div>").append(this._$div.clone().removeClass(TC.Consts.classes.HIDDEN)).html();switch(this.displayMode){case TC.control.FeatureInfoCommons.displayMode.RESULTS_PANEL:$(this.getDisplayTarget()).html(this.filterFeature.data);this.resultsPanel.open(this.filterFeature.data);this.displayResultsCallback();break;default:this.popup&&this.filterFeature.showPopup(this.popup)}};n.getFeatureElement=function(e){var i,n=this;$(n.getDisplayTarget()).find(t).each(function(t,r){var s=$(r),a=s.parents("li").first(),o=a.parents("li").first();n.getFeature(n.info,o.index(),a.index(),s.index())===e&&(i=s)});return i&&i.get(0)};n.getNextFeatureElement=function(e){var t=$(this.getDisplayTarget()).find("ul."+this.CLASS+"-features > li"),i=t.length,n=t.filter("."+TC.Consts.classes.CHECKED),r=t.index(n.get(0));return t.get((r+e+i)%i)};n.closeResults=function(){switch(this.displayMode){case TC.control.FeatureInfoCommons.displayMode.RESULTS_PANEL:this.resultsPanel&&this.resultsPanel.isVisible()&&this.resultsPanel.close();break;default:this.popup&&this.popup.isVisible()&&this.popup.hide()}};n.displayResultsCallback=function(){var n,r=this,s=$(r.getDisplayTarget()).find("."+r.CLASS).first(),a="click";s.on(a,t,function(e){r.highlightFeature(this)});a="mouseenter";s.on(a,t,function(e){$(this).parents("."+r.CLASS+"-layers > li").hasClass(TC.Consts.classes.CHECKED)&&r.highlightFeature(this)});a=TC.Consts.event.CLICK;n="."+r.CLASS+"-btn-next";s.on(a,n,function(e){r.highlightFeature(r.getNextFeatureElement(1),1);return!1});n="."+r.CLASS+"-btn-prev";s.on(a,n,function(e){r.highlightFeature(r.getNextFeatureElement(-1),-1);return!1});n="ul."+r.CLASS+"-layers h4";s.on(a,n,function(n){var a=$(n.target).parents("li").first();if(a.hasClass(TC.Consts.classes.CHECKED))"none"===s.find(".tc-ctl-finfo-btn-next").css("display")&&e(r)>1&&i(r);else{r.highlightFeature(a.find(t).first()[0]);r.displayMode===TC.control.FeatureInfoCommons.displayMode.POPUP&&r.popup.fitToView(!0)}});n="."+r.CLASS+"-tools-btn";s.on(a,n,function(e){var t=new $.Deferred;r._shareCtl?t.resolve():r.map.addControl("share",{div:r._$dialogDiv.find(".tc-modal-body .tc-ctl-finfo-dialog-share")}).then(function(e){r._shareCtl=e;t.resolve()});$.when(t).then(function(){TC.Util.showModal(r._$dialogDiv.find("."+r.CLASS+"-dialog"),{openCallback:function(){r.onShowModal()}})})});if(r.info)if(r.info.defaultFeature){$(r.getFeatureElement(r.info.defaultFeature)).addClass(TC.Consts.classes.DEFAULT);r.highlightFeature(r.info.defaultFeature)}else r.highlightFeature(s.find(t).first()[0]);s.find("table").on("click",function(e){if(!$(this).parent().hasClass(TC.Consts.classes.DISABLED)){if(r.resultsLayer.features[0]){r.map.on(TC.Consts.event.ZOOM,function e(){r._zooming=!1;r.map.off(TC.Consts.event.ZOOM,e)});r._zooming=!0;r.map.zoomToFeatures([r.resultsLayer.features[0]],{animate:!0})}e.stopPropagation()}});s.find("table a").on("click",function(e){e.stopPropagation()});if(Modernizr.touch&&r.displayMode===TC.control.FeatureInfoCommons.displayMode.RESULTS_PANEL&&"none"!==s.find("."+r.CLASS+"-btn-prev").css("display")){r.resultsPanel&&r.resultsPanel._$div.swipe("disable");e(r)>1&&s.swipe({swipeLeft:function(e){r.highlightFeature(r.getNextFeatureElement(1),1);e.stopPropagation()},swipeRight:function(e){r.highlightFeature(r.getNextFeatureElement(-1),-1);e.stopPropagation()}})}};n.onShowPopUp=function(e){this.map;if(e.control===this.popup){this.displayResultsCallback();this.fitSize()}};n.onShowModal=function(){};n.insertLinks=function(){const e=this.getLocaleString("open"),t=this.getLocaleString("linkInNewWindow");this._$div.find("td."+this.CLASS+"-val").each(function(i,n){const r=$(n),s=r.text();TC.Util.isURL(s)&&r.html('<a href="'+s+'" target="_blank" title="'+t+'">'+e+"</a>")})};n.highlightFeature=function(e,t){(function(e,t){if(!e._zooming){var n,r,s,a;if(this instanceof TC.Feature){n=this;var o=e.getFeatureElement(n);o&&(r=$(o))}else r=$(this);a=(s=r.parents("li").first()).parents("li").first();i(e);r.addClass(TC.Consts.classes.CHECKED);s.addClass(TC.Consts.classes.CHECKED);a.addClass(TC.Consts.classes.CHECKED);if(t>0){r.addClass(TC.Consts.classes.FROMLEFT);s.addClass(TC.Consts.classes.FROMLEFT);a.addClass(TC.Consts.classes.FROMLEFT)}else if(t<0){r.addClass(TC.Consts.classes.FROMRIGHT);s.addClass(TC.Consts.classes.FROMRIGHT);a.addClass(TC.Consts.classes.FROMRIGHT)}var l=a.index(),c=s.index(),u=r.index();n=n||e.getFeature(e.info,l,c,u);$(e.getDisplayTarget()).find("."+e.CLASS+"-counter-current").html(e.getFeatureIndex(e.info,l,c,u)+1);var h=e.resultsLayer.features.slice();if(h.filter(function(e){return n&&n.id===e.id}).length>0)return;for(var p=0;p<h.length;p++){var d=h[p];d!==e.filterFeature&&e.resultsLayer.removeFeature(d)}n&&n.geometry?e.resultsLayer.addFeature(n):r.addClass(TC.Consts.classes.DISABLED)}}).call(e,this,t)};n.fitSize=function(){var e=this,t=$(e.getDisplayTarget()),i=0;t.find(".tc-ctl-finfo-features li").each(function(e,t){i=Math.max(i,$(t).position().left+$(t).width())});i&&t.width(i+50)};n.getFeature=function(e,t,i,n){var r;e&&e.services&&(r=e.services[t])&&(r=r.layers[i])&&(r=r.features[n]);return r};n.getFeatureIndex=function(e,t,i,n){var r=-1;if(e)for(var s=0;s<=t;s++)for(var a=e.services[s],o=s===t?i:a.layers.length-1,l=0;l<=o;l++)for(var c=a.layers[l],u=l===i?n:c.features.length-1,h=0;h<=u;h++)r+=1;return r};n.beforeRequest=function(e){this.querying=!0;this.map.$events.trigger($.Event(TC.Consts.event.BEFOREFEATUREINFO,{xy:e.xy,control:this}));this.closeResults();if(this.map&&this.resultsLayer){this.lastFeatureCount=null;this.resultsLayer.clearFeatures();this.info=null}};n.activate=function(){this.wrap&&this.wrap.activate();TC.Control.prototype.activate.call(this)};n.deactivate=function(e){this.popup&&this.popup.hide();this.resultsLayer.clearFeatures();this.filterLayer.clearFeatures();this.wrap&&this.wrap.deactivate();TC.Control.prototype.deactivate.call(this,e)}}();TC.control=TC.control||{};TC.Consts=TC.Consts||{};TC.Consts.SCREEN_SIZE_KEY="TC.Map.screenSize";TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control");TC.control.Scale=function(){TC.Control.apply(this,arguments)};TC.inherit(TC.control.Scale,TC.Control);!function(){var e=TC.control.Scale.prototype;e.CLASS="tc-ctl-scl";TC.isDebug?e.template=TC.apiLocation+"TC/templates/Scale.html":e.template=function(){dust.register(e.CLASS,t);function t(e,t){return e.w('<div class="ol-scale-line ol-unselectable"><span>1:').h("math",t,{},{key:i,method:"round"}).w('</span> <input type="button" value="').f(t.get(["screenSize"],!1),t,"h").w("''\" title=\"").h("i18n",t,{},{$key:"estimatedMapSize"}).w('" /></div>')}t.__dustBody=!0;function i(e,t){return e.f(t.get(["scale"],!1),t,"h")}i.__dustBody=!0;return t};e.render=function(e){var t=this;$("input[type=button]",t._$div).off();t.renderData({scale:t.getScale(),screenSize:TC.Cfg.screenSize},function(){var i=t._$div.find("span");i.text("1:"+t.format(i.text().substr(2)));t._$div.find('input[type="button"]').on(TC.Consts.event.CLICK,function(){t.setScreenSize.call(t)});$.isFunction(e)&&e()})};e.register=function(e){var t=this;TC.Control.prototype.register.call(t,e);var i=TC.Util.storage.getLocalValue(TC.Consts.SCREEN_SIZE_KEY);i&&(TC.Cfg.screenSize=i);t.render(function(){e.on(TC.Consts.event.ZOOM,function(){delete t.metersPerDegree;t.update()})})};e.update=function(){this.render()};e.setScreenSize=function(){var e=this;TC.prompt(e.getLocaleString("selectScreenSize"),TC.Cfg.screenSize,function(t){if(t){TC.Cfg.screenSize=parseFloat(t);TC.Util.storage.setLocalValue(TC.Consts.SCREEN_SIZE_KEY,TC.Cfg.screenSize);e.update()}})};e.getScale=function(e){var t=0,i=!e&&this.map?this.map.wrap.getResolution():e;if(i){t=i*this.getDpi(TC.Cfg.screenSize)/.0254;window.devicePixelRatio&&(t*=window.devicePixelRatio)}if(this.map&&this.map.wrap.isGeo()){if(!this.metersPerDegree){var n=this.map.getExtent();n&&(this.metersPerDegree=TC.Util.getMetersPerDegree(n))}this.metersPerDegree&&(t*=this.metersPerDegree)}return t};e.getDpi=function(e){this.dpi=Math.sqrt(screen.width*screen.width+screen.height*screen.height)/e;return this.dpi};e.format=function(e){for(var t=new Number(e).toFixed(0),i=[];t.length>3;){var n=t.length-3;i.unshift(t.substr(n));t=t.substr(0,n)}t&&i.unshift(t);return i.join(".")}}();TC.control=TC.control||{};TC.control.MapContents||TC.syncLoadJS(TC.apiLocation+"TC/Control");!function(){TC.control.SWCacheClient=function(){this.serviceWorkerEnabled=!1;this._serviceWorkerDeferred=$.Deferred()};TC.inherit(TC.control.SWCacheClient,TC.Control);var e=TC.control.SWCacheClient.prototype;e.CLASS="tc-ctl-swcc";e.register=function(e){var t=this;TC.Control.prototype.register.call(t,e);navigator.serviceWorker?navigator.serviceWorker.register("tc-cb-service-worker.js",{scope:"./"}).then(function(e){t.serviceWorkerEnabled=!0;e.installing?t._serviceWorkerDeferred.resolve(e.installing):e.waiting?t._serviceWorkerDeferred.resolve(e.waiting):e.active&&t._serviceWorkerDeferred.resolve(e.active);console.log(e.scope,"register")},function(e){t.serviceWorkerEnabled=!1;t._serviceWorkerDeferred.reject();console.error("Could not register service worker: "+e)}):t._serviceWorkerDeferred.reject()};e.getServiceWorker=function(){return this._serviceWorkerDeferred.promise()};var t=function(e,t,i,n){navigator.serviceWorker.addEventListener("message",function r(s){if(s.data.name===t){s.data.action===i&&s.data.event===n?e.resolve(t):"error"===s.data.event&&e.reject();navigator.serviceWorker.removeEventListener("message",r)}})};e.createCache=function(e,i){var n=$.Deferred();this.getServiceWorker().then(function(r){var s=i||{};t(n,e,"create","cached");r.postMessage({action:"create",name:e,list:s.urlList||[],silent:s.silent})},function(){n.resolve(!1)});return n.promise()};e.deleteCache=function(e,i){var n=$.Deferred();this.getServiceWorker().then(function(r){var s=i||{};t(n,e,"delete","deleted");r.postMessage({action:"delete",name:e,silent:s.silent})},function(){n.resolve(!1)});return n.promise()}}();TC.control=TC.control||{};TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control");TC.Consts.event.POINT="point.tc";TC.control.Measure=function(){var e=this;TC.Control.apply(e,arguments);e.drawControls=[];e.persistentDrawControls=!1;e.NOMEASURE="-";this.renderPromise().then(function(){e.measureMode=e.options.mode;e.history=[];e.historyIndex=0;e.reset=!0;e.wrap=new TC.wrap.control.Measure(e);e._$len=e._$div.find(".tc-ctl-meas-val-len");e._$area=e._$div.find(".tc-ctl-meas-val-area");e._$peri=e._$div.find(".tc-ctl-meas-val-peri");e.setMode(e.options.mode)})};TC.inherit(TC.control.Measure,TC.Control);!function(){var e=TC.control.Measure.prototype;e.CLASS="tc-ctl-meas";TC.isDebug?e.template=TC.apiLocation+"TC/templates/Measure.html":e.template=function(){dust.register(e.CLASS,t);function t(e,t){return e.w("<h2>").h("i18n",t,{},{$key:"measure"}).w('</h2><div class="tc-ctl-meas-select"><form><label class="tc-ctl-meas-btn-len"><input type="radio" name="mode" value="polyline" /><span>').h("i18n",t,{},{$key:"length"}).w('</span></label><label class="tc-ctl-meas-btn-area"><input type="radio" name="mode" value="polygon" /><span>').h("i18n",t,{},{$key:"areaAndPerimeter"}).w('</span></label></form></div><div class="tc-ctl-meas-mode tc-ctl-meas-len tc-hidden"><div class="tc-ctl-meas-line"></div><div class="tc-ctl-meas-txt">').h("i18n",t,{},{$key:"length"}).w(': <span class="tc-ctl-meas-val-len"></span></div></div><div class="tc-ctl-meas-mode tc-ctl-meas-area tc-hidden"><div class="tc-ctl-meas-polygon"></div><div class="tc-ctl-meas-txt">').h("i18n",t,{},{$key:"area"}).w(': <span class="tc-ctl-meas-val-area"></span>, ').h("i18n",t,{},{$key:"perimeter"}).w(': <span class="tc-ctl-meas-val-peri"></span></div></div>')}t.__dustBody=!0;return t};e.render=function(e){var t=this;TC.Control.prototype.render.call(t,function(){TC.loadJS(!TC.control.Draw,TC.apiLocation+"TC/control/Draw",function(){t.options.mode&&t._$div.find(".tc-ctl-meas-select").addClass(TC.Consts.classes.HIDDEN);t._$div.find("span").on(TC.Consts.event.CLICK,function(e){var i=$(this).closest("label").find("input[type=radio][name=mode]"),n=i.val();i.prop("checked",!0);t.setMode(n,!0)});$.isFunction(e)&&e()})})};e.register=function(e){const t=this;TC.Control.prototype.register.call(t,e);const i=t.getUID(),n=t.getUID(),r=t.getUID();t.layerPromise=e.addLayer({id:i,title:t.getLocaleString("measure"),stealth:!0,type:TC.Consts.layerType.VECTOR,styles:{point:e.options.styles.point,line:e.options.styles.line,polygon:e.options.styles.polygon}});$.when(t.layerPromise,t.renderPromise()).then(function(i){t.layer=i;t.layer.map.putLayerOnTop(t.layer);t._drawLinesPromise=e.addControl("draw",{id:n,div:t._$div.find(".tc-ctl-meas-line"),mode:TC.Consts.geom.POLYLINE,measure:!0,persistent:t.persistentDrawControls,styleTools:t.persistentDrawControls,layer:t.layer});t._drawPolygonsPromise=e.addControl("draw",{id:r,div:t._$div.find(".tc-ctl-meas-polygon"),mode:TC.Consts.geom.POLYGON,measure:!0,persistent:t.persistentDrawControls,styleTools:t.persistentDrawControls,layer:t.layer});$.when(t._drawLinesPromise,t._drawPolygonsPromise).then(function(e,i){t.drawLines=e;t.drawPolygons=i;[e,i].forEach(function(e){e.containerControl=t;t.drawControls.push(e);e.$events.on(TC.Consts.event.MEASURE+" "+TC.Consts.event.MEASUREPARTIAL,function(e){t.showMeasures(e)}).on(TC.Consts.event.DRAWCANCEL,function(e){t.cancel()});e.exportsState=!1});t.setMode(t.options.mode)})})};e.displayMode=function(e){const t=this,i=t._$div.find(".tc-ctl-meas-mode");switch(e){case TC.Consts.geom.POLYLINE:t._$activeMode=i.filter(".tc-ctl-meas-len");break;case TC.Consts.geom.POLYGON:t._$activeMode=i.filter(".tc-ctl-meas-area");break;case null:case void 0:t._$activeMode=$()}const n=i.not(t._$activeMode);e?t._$div.find("input[type=radio][name=mode][value="+e+"]").prop("checked",!0).addClass(TC.Consts.classes.CHECKED).next().addClass(TC.Consts.classes.CHECKED):t._$div.find("input[type=radio][name=mode]").prop("checked",!1).removeClass(TC.Consts.classes.CHECKED).next().removeClass(TC.Consts.classes.CHECKED);t._$activeMode.removeClass(TC.Consts.classes.HIDDEN);t._$activeMode.find(".tc-ctl").removeClass(TC.Consts.classes.COLLAPSED);n.addClass(TC.Consts.classes.HIDDEN);return t};e.setMode=function(e){const t=this;t.mode=e;t.displayMode(e);var i;switch(e){case TC.Consts.geom.POLYLINE:t.drawLines.activate();i=TC.Consts.event.CONTROLACTIVATE;break;case TC.Consts.geom.POLYGON:t.drawPolygons.activate();i=TC.Consts.event.CONTROLACTIVATE;break;case null:case void 0:t.drawControls.forEach(function(e){e.isActive&&e.cancel()});i=TC.Consts.event.CONTROLDEACTIVATE;break;default:i=TC.Consts.event.CONTROLACTIVATE}t.resetValues();i&&t.map&&t.map.$events.trigger($.Event(i,{control:t}));return t};e.cancel=function(){this.setMode(null,!1);return this};e.showMeasures=function(e){const t=this;var i,n=(e=e||{}).units;const r=t.map.options.locale||TC.Cfg.locale;if(e.area){var s=e.area;if(s>1e4){s/=1e6;n="km"}i="m"===n?0:3;t._$area.html(TC.Util.formatNumber(s.toFixed(i),r)+" "+n+"&sup2;")}if(e.perimeter){var a=e.perimeter;if(a>1e3){a/=1e3;n="km"}i="m"===n?0:3;t._$peri.html(TC.Util.formatNumber(a.toFixed(i),r)+" "+n)}if(e.length){var o=e.length;if(o>1e3){o/=1e3;n="km"}i="m"===n?0:3;t._$len.html(TC.Util.formatNumber(o.toFixed(i),r)+" "+n)}return t};e.resetValues=function(){const e=this;if(e._$len){e._$len.text(e.NOMEASURE);e._$area.text(e.NOMEASURE);e._$peri.text(e.NOMEASURE)}return e};e.getDrawLines=function(){};e.exportState=function(){return{id:this.id,layer:this.layer.exportState()}};e.importState=function(e){this.layerPromise.then(function(t){t.importState(e.layer)})}}();TC.control=TC.control||{};TC.control.MapContents||TC.syncLoadJS(TC.apiLocation+"TC/Control");!function(){TC.control.ProjectionSelector=function(){const e=this;TC.Control.apply(e,arguments);e._cssClasses={LOAD_CRS_BUTTON:e.CLASS+"-crs-btn-load",CRS_DIALOG:e.CLASS+"-crs-dialog",CRS_LIST:e.CLASS+"-crs-list",CURRENT_CRS_NAME:e.CLASS+"-cur-crs-name",CURRENT_CRS_CODE:e.CLASS+"-cur-crs-code",CHANGE:e.CLASS+"-change",NO_CHANGE:e.CLASS+"-no-change"};e._$dialogDiv=$(TC.Util.getDiv(e.options.dialogDiv));e.options.dialogDiv||e._$dialogDiv.appendTo("body");e._$dialogDiv.on(TC.Consts.event.CLICK,"button",function(i){const n=$(i.target).data(t.PROJCODE);n&&e.setProjection({crs:n,allowFallbackLayer:!0})}).on(TC.Consts.event.CLICK,"button."+e._cssClasses.LOAD_CRS_BUTTON,function(t){e.loadFallbackProjections()})};TC.inherit(TC.control.ProjectionSelector,TC.Control);const e=TC.control.ProjectionSelector.prototype;e.CLASS="tc-ctl-projs";const t={LAYER:"tcLayer",FALLBACK_LAYER:"tcFallbackLayer",PROJCODE:"tcProjCode"};e.render=function(e){const t=this;TC.Control.prototype.render.call(t,e);t.getRenderedHtml(t.CLASS+"-dialog",null,function(e){t._$dialogDiv.html(e)})};e.getAvailableCRS=function(e){return this.map.getCompatibleCRS({includeFallbacks:!0})};e.showProjectionChangeDialog=function(e){const i=this,n=i._$dialogDiv.find("."+i._cssClasses.CRS_DIALOG),r=n.find(".tc-modal-body").addClass(TC.Consts.classes.LOADING),s=r.find("ul."+i._cssClasses.CRS_LIST).empty(),a=i.map.baseLayer.firstOption||i.map.baseLayer,o=a.getFallbackLayer(),l=a.getCompatibleCRS(),c=function(){i.map.loadProjections({crsList:i.getAvailableCRS(e),orderBy:"name"}).then(function(e){var a=!1;e.forEach(function(e){if(TC.Util.CRSCodesEqual(i.map.crs,e.code)){n.find("."+i._cssClasses.CURRENT_CRS_NAME).html(e.name);n.find("."+i._cssClasses.CURRENT_CRS_CODE).html(e.code)}else{const i=$("<button>").html(e.name+" ("+e.code+")").data(t.PROJCODE,e.code),n=$("<li>").append(i);if(0===l.filter(function(t){return TC.Util.CRSCodesEqual(t,e.code)}).length){a=!0;n.addClass(TC.Consts.classes.HIDDEN);i.addClass(TC.Consts.classes.WARNING)}s.append(n)}});a&&s.append($("<li>").append($("<button>").addClass(i._cssClasses.LOAD_CRS_BUTTON).html(i.getLocaleString("showOnTheFlyProjections"))));0===s.find("li").length&&s.append($("<li>").append(i.getLocaleString("thereAreNoCompatibleCRS")));const o=s.find("li").not("."+TC.Consts.classes.HIDDEN);n.find("."+i._cssClasses.CHANGE).css("display",o.length>1?"":"none");n.find("."+i._cssClasses.NO_CHANGE).css("display",o.length>1?"none":"");n.find("ul."+i._cssClasses.CRS_LIST).css("display",o.length>0||a?"":"none");r.removeClass(TC.Consts.classes.LOADING)})};o?o.getCapabilitiesPromise().then(c):c();TC.Util.showModal(n,e)};e.setProjection=function(e){const t=this;e=e||{};TC.loadProjDef({crs:e.crs,callback:function(){t.map.setProjection(e)}})};e.loadFallbackProjections=function(){const e=this._$dialogDiv.find("."+this._cssClasses.CRS_DIALOG).find("ul."+this._cssClasses.CRS_LIST+" li").removeClass(TC.Consts.classes.HIDDEN);e.has("button."+this._cssClasses.LOAD_CRS_BUTTON).addClass(TC.Consts.classes.HIDDEN);this._$dialogDiv.find("p."+TC.Consts.classes.WARNING).removeClass(TC.Consts.classes.HIDDEN);this._$dialogDiv.find("."+this._cssClasses.CHANGE).css("display",e.length>1?"":"none");this._$dialogDiv.find("."+this._cssClasses.NO_CHANGE).css("display",e.length>1?"none":"")}}();TC.control=TC.control||{};TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control");TC.control.TabContainer=function(){TC.Control.apply(this,arguments);var e=this._classSelector="."+this.CLASS;this._selectors={TAB:e+"-tab",RADIOBUTTON:"input[type=radio][name=sctnr-sel]",ELEMENT:e+"-elm"};this.controlOptions=this.options.controls||[];var t=this.controlOptions.length;this._ctlDeferreds=new Array(t);for(var i=0;i<t;i++)this._ctlDeferreds[i]=$.Deferred();this.defaultSelection=this.options.defaultSelection};TC.inherit(TC.control.TabContainer,TC.Control);!function(){var e=TC.control.TabContainer.prototype;e.CLASS="tc-ctl-tctr";TC.isDebug?e.template=TC.apiLocation+"TC/templates/TabContainer.html":e.template=function(){dust.register(e.CLASS,t);function t(e,t){return e.w("<h2>").f(t.get(["title"],!1),t,"h").w('</h2><div class="tc-ctl-tctr-select"><form>').s(t.get(["controls"],!1),t,{block:i},{}).w("</form></div>").s(t.get(["controls"],!1),t,{block:n},{})}t.__dustBody=!0;function i(e,t){return e.w('<label class="tc-ctl-tctr-tab tc-ctl-tctr-tab-').f(t.get(["$idx"],!1),t,"h").w('" style="width:calc(100%/').f(t.get(["$len"],!1),t,"h").w(' - 1px)"><input type="radio" name="sctnr-sel" value="').f(t.get(["$idx"],!1),t,"h").w('" /><span>').f(t.get(["title"],!1),t,"h").w("</span></label>")}i.__dustBody=!0;function n(e,t){return e.w('<div class="tc-ctl-tctr-elm tc-ctl-tctr-elm-').f(t.get(["$idx"],!1),t,"h").w(' tc-hidden"></div>')}n.__dustBody=!0;return t};e.register=function(e){var t=this;TC.Control.prototype.register.call(t,e);const i=new Array(t.controlOptions.length);i.forEach(function(e,i,n){n[i]=t.getUID()});t.renderPromise().then(function(){t.title=t.title||t.getLocaleString(t.options.title||"moreControls");t._$div.find("h2").first().html(t.title);for(var n=new Array(t.controlOptions.length),r=0,s=t.controlOptions.length;r<s;r++){var a=t.controlOptions[r];n[r]=e.addControl(a.name,$.extend({id:i[r],div:t._$div.find("."+t.CLASS+"-elm-"+r)},a.options))}var o=function(e,i){e.renderPromise().then(function(){var n=t.getLocaleString(t.controlOptions[i].title)||e._$div.find("h2").first().html();e._$div.parents(t._classSelector).first().find(t._selectors.TAB+"-"+i+" span").html(n)})};$.when.apply(t,n).then(function(){for(var e=0,i=arguments.length;e<i;e++){var n=arguments[e];n.containerControl=t;o(n,e);t._ctlDeferreds[e].resolve(n)}})})};e.render=function(e){var t=this;t.renderData({title:t.title,controls:t.controlOptions},function(){var e=function(e){var i=$(this).closest(t._selectors.TAB).find(t._selectors.RADIOBUTTON),n=i.val(),r=t._$div.find(t._selectors.ELEMENT);if(t._oldValue===n&&t.options.deselectable){setTimeout(function(){i.prop("checked",!1)},0);t._oldValue=null;$active=$();$hidden=r}else{$active=r.filter(t._selectors.ELEMENT+"-"+n);$hidden=r.not($active);t._oldValue=n}$active.removeClass(TC.Consts.classes.HIDDEN);$hidden.addClass(TC.Consts.classes.HIDDEN);i.prop("checked",!0)};t._$div.find("span").on(TC.Consts.event.CLICK,e);"number"==typeof t.defaultSelection&&e.call(t._$div.find(t._selectors.RADIOBUTTON).get(t.defaultSelection))})};e.getControl=function(e){var t=this._ctlDeferreds[e];t||(t=$.Deferred()).reject();return t.promise()}}();window.OpenLayers||TC.syncLoadJS(TC.url.ol);!function(){OpenLayers._getScriptLocation=function(){var e=OpenLayers._getScriptLocation();e||(e=TC.url.ol.substr(0,TC.url.ol.lastIndexOf("/")+1));return function(){return e}}();OpenLayers.CustomTheme=TC.apiLocation+"OpenLayers/theme/tcsa/style.css";OpenLayers.Util.extend(OpenLayers.Feature.Vector.style.default,{fillColor:TC.Cfg.styles.polygon.fillColor,fillOpacity:TC.Cfg.styles.polygon.fillOpacity,strokeColor:TC.Cfg.styles.line.strokeColor,strokeWidth:TC.Cfg.styles.line.strokeWidth});OpenLayers.Format.XML.prototype._write=OpenLayers.Format.XML.prototype.write;OpenLayers.Format.XML.prototype.write=function(){var e=OpenLayers.Format.XML.prototype._write.apply(this,arguments);return e=e.replace(new RegExp('xmlns:NS\\d+="" NS\\d+:',"g"),"")};OpenLayers.Control.PanZoom.prototype.onButtonClick=function(e){switch(e.buttonElement.action){case"panup":this.map.pan(0,-this.getSlideFactor("h"));break;case"pandown":this.map.pan(0,this.getSlideFactor("h"));break;case"panleft":this.map.pan(-this.getSlideFactor("w"),0);break;case"panright":this.map.pan(this.getSlideFactor("w"),0);break;case"zoomin":this.map.zoomIn();break;case"zoomout":this.map.zoomOut();break;case"zoomworld":this.map.zoomToExtent(this.map.options.extent)}};OpenLayers.Control.OverviewMap.prototype._updateOverview=OpenLayers.Control.OverviewMap.prototype.updateOverview;OpenLayers.Control.OverviewMap.prototype.updateOverview=function(){(this.active||null===this.active)&&this._updateOverview()};OpenLayers.Format.WMSGetFeatureInfo=OpenLayers.Class(OpenLayers.Format.XML,{layerIdentifier:"_layer",featureIdentifier:"_feature",regExes:{trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g},gmlFormat:null,read:function(e){var t;"string"==typeof e&&(e=OpenLayers.Format.XML.prototype.read.apply(this,[e]));var i=e.documentElement;if(i){var n=this["read_"+i.nodeName];t=n?n.call(this,i):new OpenLayers.Format.GML(this.options?this.options:{}).read(e)}else t=e;return t},read_msGMLOutput:function(e){var t=[],i=this.getSiblingNodesByTagCriteria(e,this.layerIdentifier);if(i)for(var n=0,r=i.length;n<r;++n){var s=i[n],a=s.nodeName;s.prefix&&(a=a.split(":")[1]);a=a.replace(this.layerIdentifier,"");var o=this.getSiblingNodesByTagCriteria(s,this.featureIdentifier);if(o)for(var l=0;l<o.length;l++){var c=o[l],u=this.parseGeometry(c),h=this.parseAttributes(c),p=new OpenLayers.Feature.Vector(u.geometry,h,null);p.bounds=u.bounds;p.type=a;t.push(p)}}return t},read_FeatureInfoResponse:function(e){for(var t=[],i=this.getElementsByTagNameNS(e,"*","FIELDS"),n=0,r=i.length;n<r;n++){var s,a=i[n],o={},l=a.attributes.length;if(l>0)for(s=0;s<l;s++){var c=a.attributes[s];o[c.nodeName]=c.nodeValue}else{var u=a.childNodes;for(s=0,l=u.length;s<l;++s){var h=u[s];3!=h.nodeType&&(o[h.getAttribute("name")]=h.getAttribute("value"))}}t.push(new OpenLayers.Feature.Vector(null,o,null))}return t},getSiblingNodesByTagCriteria:function(e,t){var i,n,r,s,a,o=[];if(e&&e.hasChildNodes()){r=(i=e.childNodes).length;for(var l=0;l<r;l++){a=i[l];for(;a&&1!=a.nodeType;){a=a.nextSibling;l++}(n=a?a.nodeName:"").length>0&&n.indexOf(t)>-1?o.push(a):(s=this.getSiblingNodesByTagCriteria(a,t)).length>0&&(0==o.length?o=s:o.push(s))}}return o},parseAttributes:function(e){var t={};if(1==e.nodeType)for(var i=e.childNodes,n=i.length,r=0;r<n;++r){var s=i[r];if(1==s.nodeType){var a=s.childNodes,o=s.prefix?s.nodeName.split(":")[1]:s.nodeName;if(0==a.length)t[o]=null;else if(1==a.length){var l=a[0];if(3==l.nodeType||4==l.nodeType){var c=l.nodeValue.replace(this.regExes.trimSpace,"");t[o]=c}}}}return t},parseGeometry:function(e){this.gmlFormat||(this.gmlFormat=new OpenLayers.Format.GML);var t,i=this.gmlFormat.parseFeature(e),n=null;if(i){t=i.geometry&&i.geometry.clone();n=i.bounds&&i.bounds.clone();i.destroy()}return{geometry:t,bounds:n}},CLASS_NAME:"OpenLayers.Format.WMSGetFeatureInfo"});OpenLayers.Format.GML.prototype._oldParseFeature=OpenLayers.Format.GML.prototype.parseFeature;OpenLayers.Format.GML.prototype.parseFeature=function(e){this.externalProjection=null;for(var t,i,n=["MultiPolygon","Polygon","MultiLineString","LineString","MultiPoint","Point","Envelope"],r=0;r<n.length;++r){t=n[r];if((i=this.getElementsByTagNameNS(e,this.gmlns,t)).length>0){var s=i[0].getAttribute("srsName");if(s){TC.loadProjDef({crs:s,sync:!0});this.externalProjection=new OpenLayers.Projection("EPSG:"+s.substr(s.lastIndexOf("#")+1))}break}}return this._oldParseFeature(e)};OpenLayers.Control.WMSGetFeatureInfo=OpenLayers.Class(OpenLayers.Control,{hover:!1,drillDown:!1,maxFeatures:10,clickCallback:"click",output:"features",layers:null,queryVisible:!1,url:null,layerUrls:null,infoFormat:"text/html",vendorParams:{},format:null,formatOptions:null,handler:null,hoverRequest:null,initialize:function(e){(e=e||{}).handlerOptions=e.handlerOptions||{};OpenLayers.Control.prototype.initialize.apply(this,[e]);this.format||(this.format=new OpenLayers.Format.WMSGetFeatureInfo(e.formatOptions));!0===this.drillDown&&(this.hover=!1);if(this.hover)this.handler=new OpenLayers.Handler.Hover(this,{move:this.cancelHover,pause:this.getInfoForHover},OpenLayers.Util.extend(this.handlerOptions.hover||{},{delay:250}));else{var t={};t[this.clickCallback]=this.getInfoForClick;this.handler=new OpenLayers.Handler.Click(this,t,this.handlerOptions.click||{})}},getInfoForClick:function(e){this.events.triggerEvent("beforegetfeatureinfo",{xy:e.xy});OpenLayers.Element.addClass(this.map.viewPortDiv,"olCursorWait");this.request(e.xy,{})},getInfoForHover:function(e){this.events.triggerEvent("beforegetfeatureinfo",{xy:e.xy});this.request(e.xy,{hover:!0})},cancelHover:function(){if(this.hoverRequest){this.hoverRequest.abort();this.hoverRequest=null}},findLayers:function(){for(var e,t,i=this.layers||this.map.layers,n=[],r=i.length-1;r>=0;--r)if((e=i[r])instanceof OpenLayers.Layer.WMS&&(!this.queryVisible||e.getVisibility())){t=OpenLayers.Util.isArray(e.url)?e.url[0]:e.url;!1!==this.drillDown||this.url||(this.url=t);(!0===this.drillDown||this.urlMatches(t))&&n.push(e)}return n},urlMatches:function(e){var t=OpenLayers.Util.isEquivalentUrl(this.url,e);if(!t&&this.layerUrls)for(var i=0,n=this.layerUrls.length;i<n;++i)if(OpenLayers.Util.isEquivalentUrl(this.layerUrls[i],e)){t=!0;break}return t},buildWMSOptions:function(e,t,i,n){for(var r=[],s=[],a=0,o=t.length;a<o;a++)if(null!=t[a].params.LAYERS){r=r.concat(t[a].params.LAYERS);s=s.concat(this.getStyleNames(t[a]))}var l=t[0],c=this.map.getProjection(),u=l.projection;u&&u.equals(this.map.getProjectionObject())&&(c=u.getCode());var h=OpenLayers.Util.extend({service:"WMS",version:l.params.VERSION,request:"GetFeatureInfo",exceptions:l.params.EXCEPTIONS,bbox:this.map.getExtent().toBBOX(null,l.reverseAxisOrder()),feature_count:this.maxFeatures,height:this.map.getSize().h,width:this.map.getSize().w,format:n,info_format:l.params.INFO_FORMAT||this.infoFormat},parseFloat(l.params.VERSION)>=1.3?{crs:c,i:parseInt(i.x),j:parseInt(i.y)}:{srs:c,x:parseInt(i.x),y:parseInt(i.y)});0!=r.length&&(h=OpenLayers.Util.extend({layers:r,query_layers:r,styles:s},h));OpenLayers.Util.applyDefaults(h,this.vendorParams);return{url:e,params:OpenLayers.Util.upperCaseObject(h),callback:function(t){this.handleResponse(i,t,e)},scope:this}},getStyleNames:function(e){return e.params.STYLES?e.params.STYLES:OpenLayers.Util.isArray(e.params.LAYERS)?new Array(e.params.LAYERS.length):e.params.LAYERS.replace(/[^,]/g,"")},request:function(e,t){if(0!=(r=this.findLayers()).length){t=t||{};if(!1===this.drillDown){var i=this.buildWMSOptions(this.url,r,e,r[0].params.FORMAT),n=OpenLayers.Request.GET(i);!0===t.hover&&(this.hoverRequest=n)}else{this._requestCount=0;this._numRequests=0;this.features=[];for(var r,s={},a=0,o=r.length;a<o;a++){var l=r[a];if((c=OpenLayers.Util.isArray(l.url)?l.url[0]:l.url)in s)s[c].push(l);else{this._numRequests++;s[c]=[l]}}for(var c in s){r=s[c];i=this.buildWMSOptions(c,r,e,r[0].params.FORMAT);OpenLayers.Request.GET(i)}}}else{this.events.triggerEvent("nogetfeatureinfo");OpenLayers.Element.removeClass(this.map.viewPortDiv,"olCursorWait")}},triggerGetFeatureInfo:function(e,t,i){this.events.triggerEvent("getfeatureinfo",{text:e.responseText,features:i,request:e,xy:t});OpenLayers.Element.removeClass(this.map.viewPortDiv,"olCursorWait")},handleResponse:function(e,t,i){var n=t.responseXML;n&&n.documentElement||(n=t.responseText);var r=this.format.read(n);if(!1===this.drillDown)this.triggerGetFeatureInfo(t,e,r);else{this._requestCount++;"object"===this.output?this._features=(this._features||[]).concat({url:i,features:r}):this._features=(this._features||[]).concat(r);if(this._requestCount===this._numRequests){this.triggerGetFeatureInfo(t,e,this._features.concat());delete this._features;delete this._requestCount;delete this._numRequests}}},CLASS_NAME:"OpenLayers.Control.WMSGetFeatureInfo"});OpenLayers.Format.WMSGetFeatureInfo.prototype._defaultRead_FeatureInfoResponse=OpenLayers.Format.WMSGetFeatureInfo.prototype.read_FeatureInfoResponse;OpenLayers.Format.WMSGetFeatureInfo.prototype["read_esri_wms:FeatureInfoResponse"]=function(e){for(var t=[],i=this.getElementsByTagNameNS(e,"http://www.esri.com/wms","FeatureInfoCollection"),n=0;n<i.length;n++)for(var r=i[n],s=this.getElementsByTagNameNS(r,"http://www.esri.com/wms","FeatureInfo"),a=0;a<s.length;a++){for(var o=s[a],l=this.getElementsByTagNameNS(o,"http://www.esri.com/wms","FieldName"),c=this.getElementsByTagNameNS(o,"http://www.esri.com/wms","FieldValue"),u={},h=0;h<l.length;h++){var p=l[h],d=c[h],f=void 0===p.textContent?"text":"textContent";u[p[f]]=d[f]}var m=new OpenLayers.Feature.Vector(null,u,null);m.type=r.getAttribute("layername");t.push(m)}return t};OpenLayers.Format.WMSGetFeatureInfo.prototype.read_FeatureInfoResponse=function(e){return"http://www.esri.com/wms"===e.namespaceURI?OpenLayers.Format.WMSGetFeatureInfo.prototype["read_esri_wms:FeatureInfoResponse"].call(this,e):OpenLayers.Format.WMSGetFeatureInfo.prototype._defaultRead_FeatureInfoResponse.call(this,e)};!function(){var e=!!window.controllers,t=window.document.all&&!window.opera;t&&window.navigator.userAgent.match(/MSIE 7.0/);function i(e){OpenLayers.Request.XMLHttpRequest.onreadystatechange&&OpenLayers.Request.XMLHttpRequest.onreadystatechange.apply(e);e.dispatchEvent({type:"readystatechange",bubbles:!1,cancelable:!1,timeStamp:new Date+0})}function n(e){try{e.responseText=e._object.responseText}catch(e){}try{e.responseXML=fGetDocument(e._object)}catch(e){}try{e.status=e._object.status}catch(e){}try{e.statusText=e._object.statusText}catch(e){}}function r(e){e._object.onreadystatechange=new window.Function}OpenLayers.Request.XMLHttpRequest.prototype.open=function(s,a,o,l,c){(function(e){var t=0!==e.indexOf("http")&&0!==e.indexOf("//"),i=!t&&e.match(this.URL_SPLIT_REGEX);if(i){var n=window.location;t=i[1]==n.protocol&&i[3]==n.hostname;var r=i[4],s=n.port;(80!=r&&""!=r||"80"!=s&&""!=s)&&(t=t&&r==s)}return t})(a)||"withCredentials"in this._object||!window.XDomainRequest||(this._object=new window.XDomainRequest);delete this._headers;arguments.length<3&&(o=!0);this._async=o;var u,h=this,p=this.readyState;if(t&&o){u=function(){if(p!=OpenLayers.Request.XMLHttpRequest.DONE){r(h);h.abort()}};window.attachEvent("onunload",u)}OpenLayers.Request.XMLHttpRequest.onopen&&OpenLayers.Request.XMLHttpRequest.onopen.apply(this,arguments);arguments.length>4?this._object.open(s,a,o,l,c):arguments.length>3?this._object.open(s,a,o,l):this._object.open(s,a,o);this.readyState=OpenLayers.Request.XMLHttpRequest.OPENED;i(this);"withCredentials"in this._object||"onreadystatechange"in this._object?this._object.onreadystatechange=function(){if(!e||o){h.readyState=h._object.readyState;n(h);if(h._aborted)h.readyState=OpenLayers.Request.XMLHttpRequest.UNSENT;else{if(h.readyState==OpenLayers.Request.XMLHttpRequest.DONE){delete h._data;r(h);t&&o&&window.detachEvent("onunload",u)}p!=h.readyState&&i(h);p=h.readyState}}}:this._object.onload=function(){if(!e||o){h.readyState=OpenLayers.Request.XMLHttpRequest.DONE;h._object.status=200;h._object.statusText="OK";n(h);delete h._data;t&&o&&window.detachEvent("onunload",u);h.onreadystatechange()}}};OpenLayers.Request.XMLHttpRequest.prototype.setRequestHeader=function(e,t){this._headers||(this._headers={});this._headers[e]=t;return"setRequestHeader"in this._object?this._object.setRequestHeader(e,t):void this._object}}();OpenLayers.Format.KML.prototype._getNodeText=function(e){var t="";void 0!==e.textContent?t=e.textContent:void 0!==e.innerHTML?t=e.innerHTML:void 0!==e.text&&(t=e.text);return t};OpenLayers.Format.KML.prototype._getFolderHierarchy=function(e){var t=[],i=e;if(i.parentNode)do{if("folder"==(i=i.parentNode).nodeName.toLowerCase()){var n;i.childNodes&&i.childNodes.length&&i.childNodes.length>0&&("name"==i.childNodes[0].nodeName?n=this._getNodeText(i.childNodes[0]):i.childNodes.length>1&&(n=this._getNodeText(i.childNodes[1])));n&&t.push(n)}}while(null!==i.parentNode&&"document"!==i.parentNode.nodeName.toLowerCase());t.reverse();this._folderTree||(this._folderTree={children:[]});TC.Util.addArrayToTree(t,this._folderTree);return t};OpenLayers.Format.KML.prototype.parserTimeout=0;OpenLayers.Format.KML.prototype.parseFeatures=function(e,t){for(var i,n,r=[],s=new Date,a=0,o=e.length;a<o;a++){if(this.parserTimeout>0&&a%10==0&&a>0){i=new Date;if((n=parseInt(i.getTime()-s.getTime()))>this.parserTimeout)throw"El archivo KML es demasiado complejo para este navegador."+n+"ms, "+a+" features"}var l=e[a],c=this.parseFeature.apply(this,[l]);if(!c)throw"Bad Placemark: "+a;this.extractStyles&&c.attributes&&c.attributes.styleUrl&&(c.style=this.getStyle(c.attributes.styleUrl,t));if(this.extractStyles){var u=this.getElementsByTagNameNS(l,"*","Style")[0];if(u){var h=this.parseStyle(u);h&&(c.style=OpenLayers.Util.extend(c.style,h))}}this.parseFolders&&(c._folders=this._getFolderHierarchy(l));if(this.extractTracks){var p=this.getElementsByTagNameNS(l,this.namespaces.gx,"Track");if(p&&p.length>0){var d=p[0],f={features:[],feature:c};this.readNode(d,f);f.features.length>0&&r.push.apply(r,f.features)}}else r.push(c)}this.features=this.features.concat(r)};OpenLayers.Format.KML.prototype._read=OpenLayers.Format.KML.prototype.read;OpenLayers.Format.KML.prototype.read=function(e){var t=this.getChildEl(e.documentElement,"Document");if(t){var i=this.getChildEl(t,"name");i&&(this._documentName=this._getNodeText(i))}return this._read.call(this,e)};OpenLayers.Popup.Anchored.prototype.calculateRelativePosition=function(){return"tr"};OpenLayers.Control.PanZoomBar.prototype._draw=OpenLayers.Control.PanZoomBar.prototype.draw;OpenLayers.Control.PanZoomBar.prototype.draw=function(e){var t=OpenLayers.Control.PanZoomBar.prototype._draw.call(this,e);$(this.div).removeAttr("style").addClass("tc-ctl-nav");var i=$(this.buttons[0]),n=i.height();i.removeAttr("style").addClass("tc-ctl-nav-btn tc-ctl-nav-btn-zoomin");i.height();var r=$(this.zoombarDiv);n=r.css("height");r.removeAttr("style").addClass("tc-ctl-nav-bar").css("height",n);var s=$(this.slider);n=s.css("height");s.removeAttr("style").addClass("tc-ctl-nav-slider").css("height",n);$(this.buttons[1]).removeAttr("style").addClass("tc-ctl-nav-btn tc-ctl-nav-btn-zoomout");$(this.buttons[2]).removeAttr("style").addClass("tc-ctl-nav-btn tc-ctl-nav-btn-home");return t};TC.wrap.Map.prototype.setMap=function(){var e,t=this,i=t.parent.options;i.proxy&&(OpenLayers.ProxyHost=i.proxy);t.map=new OpenLayers.Map(t.parent.div,{projection:i.crs,extent:i.initialExtent,maxExtent:i.maxExtent,restrictedExtent:i.maxExtent,controls:[new OpenLayers.Control.Navigation({dragPanOptions:{enableKinetic:!0},pinchZoomOptions:{autoActivate:!0},zoomWheelEnabled:i.mouseWheelZoom})],theme:OpenLayers.CustomTheme});t.map.events.register("zoomstart",t.parent,function(){t.parent.$events.trigger($.Event(TC.Consts.event.BEFOREZOOM))});t.map.events.register("zoomend",t.parent,function(){t.parent.$events.trigger($.Event(TC.Consts.event.ZOOM))});t.map.events.register("featureclick",t.parent,function(e){e.feature&&e.feature._wrap&&t.parent.$events.trigger($.Event(TC.Consts.event.FEATURECLICK,{feature:e.feature._wrap.parent}))});t.map.events.register("nofeatureclick",t.parent,function(e){for(var i=0;i<t.parent.workLayers.length;i++){var n=t.parent.workLayers[i];n.wrap.layer===e.layer&&t.parent.$events.trigger($.Event(TC.Consts.event.NOFEATURECLICK,{layer:n}))}});$(t.parent.div).on("resize",function(){clearTimeout(e);e=setTimeout(function(){t.map.updateSize()},200)});t.mapDeferred.resolve(t.map)};TC.wrap.Map.prototype.getMetersPerUnit=function(){TC.error("TC.wrap.Map.prototype.getMetersPerUnit no est\xe1 soportada con OpenLayers 2")};TC.wrap.Map.prototype.setProjection=function(e){TC.error("TC.wrap.Map.prototype.setProjection no est\xe1 soportada con OpenLayers 2")};TC.wrap.Map.prototype.insertLayer=function(e,t){for(var i=!1,n=0;n<this.map.layers.length;n++)if(this.map.layers[n]===e){i=!0;break}i||this.map.addLayer(e);this.map.setLayerIndex(e,t)};TC.wrap.Map.prototype.removeLayer=function(e){this.map.removeLayer(e)};TC.wrap.Map.prototype.getLayerCount=function(){return this.map.getNumLayers()};TC.wrap.Map.prototype.indexOfFirstVector=function(){for(var e=-1,t=0,i=this.map.layers.length;t<i;t++)if(this.map.layers[t]instanceof OpenLayers.Layer.Vector){e=t;break}return e};TC.wrap.Map.prototype.getLayerIndex=function(e){return this.map.getLayerIndex(e)};TC.wrap.Map.prototype.setLayerIndex=function(e,t){this.map.setLayerIndex(e,t)};TC.wrap.Map.prototype.setBaseLayer=function(e){var t=new $.Deferred;this.map.addLayer(e);this.map.setBaseLayer(e);this.parent.baseLayer&&this.map.removeLayer(this.parent.baseLayer.wrap.getLayer());t.resolve();return t};TC.wrap.Map.prototype.setExtent=function(e){this.map.updateSize();this.map.zoomToExtent(e)};TC.wrap.Map.prototype.getExtent=function(){var e=null,t=this.map.getExtent();t&&(e=[t.left,t.bottom,t.right,t.top]);return e};TC.wrap.Map.prototype.setCenter=function(e){this.map.panTo(e)};TC.wrap.Map.prototype.getResolution=function(){return this.map.getResolution()};TC.wrap.Map.prototype.setResolution=function(e){$.when(this.getMap()).then(function(t){t.zoomTo(t.getZoomForResolution(e))})};TC.wrap.Map.prototype.getResolutions=function(){var e=[];if(this.map.resolutions)e=this.map.resolutions;else{this.map.baseLayer&&(e=this.map.baseLayer.resolutions);if(!e)for(var t=0;t<this.map.layers.length&&!e;t++)e=this.map.layers[t].resolutions}return e};TC.wrap.Map.prototype.getCoordinateFromPixel=function(e){var t=this.map.getLonLatFromPixel({x:e[0],y:e[1]});return[t.lon,t.lat]};TC.wrap.Map.prototype.getPixelFromCoordinate=function(e){var t=this.map.getPixelFromLonLat({lon:e[0],lat:e[1]});return[t.x,t.y]};TC.wrap.Map.prototype.getViewport=function(e){if((e||{}).synchronous)t=this.map.getViewport();else{var t=new $.Deferred;$.when(this.getMap()).then(function(e){t.resolve(e.getViewport())})}return t};TC.wrap.Map.prototype.isNative=function(e){return e instanceof OpenLayers.Map};TC.wrap.Map.prototype.isGeo=function(){var e=this.map.getProjectionObject();null===e&&(e=new OpenLayers.Projection(this.map.projection));var t=e.getUnits();return"degrees"===t||!t};TC.wrap.Map.prototype.addPopup=function(e){e.$popupDiv=$("<div>")};TC.wrap.Map.prototype.hidePopup=function(e){var t=this.parent;e&&$.when(t.wrap.getMap()).then(function(i){if(e.wrap.popup&&t.popup===e){i.removePopup(e.wrap.popup);e.wrap.popup.destroy();delete e.wrap.popup;t.popup=null}})};TC.wrap.Map.prototype.exportFeatures=function(e,t){TC.error("TC.wrap.Map.prototype.exportFeatures no implementado en OpenLayers 2")};TC.wrap.Map.prototype.enableDragAndDrop=function(e){TC.error("TC.wrap.Map.prototype.enableDragAndDrop no implementado en OpenLayers 2")};TC.wrap.Map.prototype.loadFiles=function(e){TC.error("TC.wrap.Map.prototype.loadFiles no implementado en OpenLayers 2")};TC.wrap.Layer.prototype.getVisibility=function(){var e=!1;this.layer&&(e=this.layer.getVisibility());return e};TC.wrap.Layer.prototype.setVisibility=function(e){$.when(this.getLayer()).then(function(t){t.setVisibility(e)})};TC.wrap.Layer.prototype.isNative=function(e){return e instanceof OpenLayers.Layer};TC.wrap.Layer.prototype.setProjection=function(e){};TC.wrap.Layer.prototype.WmsParser=OpenLayers.Format.WMSCapabilities;TC.wrap.Layer.prototype.WmtsParser=OpenLayers.Format.WMTSCapabilities;TC.wrap.Layer.prototype.addCommonEvents=function(e){var t=this;e.events.register("loadstart",t.parent.map,function(){t.parent.state=TC.Layer.state.LOADING;t.parent.map&&t.parent.map.$events.trigger($.Event(TC.Consts.event.BEFORELAYERUPDATE,{layer:t.parent}))});e.events.register("loadend",t.parent.map,function(){t.parent.state=TC.Layer.state.IDLE;t.parent.map&&t.parent.map.$events.trigger($.Event(TC.Consts.event.LAYERUPDATE,{layer:t.parent}))});e.events.register("visibilitychanged",t.parent.map,function(){t.parent.map&&t.parent.map.$events.trigger($.Event(TC.Consts.event.LAYERVISIBILITY,{layer:t.parent}))})};TC.wrap.layer.Raster.prototype.getGetMapUrl=function(){var e=null;switch(this.getServiceType()){case TC.Consts.layerType.WMS:e=this.parent.capabilities.capability.request.getmap.href;break;case TC.Consts.layerType.WMTS:e=this.parent.capabilities.operationsMetadata.GetTile.dcp.http.get[0].url}return e};TC.wrap.layer.Raster.prototype.getInfoFormats=function(){var e=null,t=this.parent.capabilities;t.capability&&t.capability.request.getfeatureinfo&&(e=t.capability.request.getfeatureinfo.formats);return e};TC.wrap.layer.Raster.infoFormatPreference=["application/vnd.ogc.gml","application/json","application/vnd.esri.wms_featureinfo_xml","application/vnd.esri.wms_raw_xml","application/vnd.ogc.wms_xml","text/xml","text/html","text/plain"];TC.wrap.layer.Raster.prototype.getWMTSLayer=function(){var e=null,t=this.parent.capabilities;if(t&&t.contents)for(var i=0;i<t.contents.layers.length;i++)for(var n=t.contents.layers[i],r=0;r<n.tileMatrixSetLinks.length;r++)if(this.parent.options.matrixSet===n.tileMatrixSetLinks[r].tileMatrixSet){e=n;break}return e};TC.wrap.layer.Raster.prototype.getTileMatrix=function(e){var t=null,i=this.parent.capabilities;i&&i.contents&&i.contents.tileMatrixSets[e]&&(t=_layer.capabilities.contents.tileMatrixSets[_layer.options.matrixSet].matrixIds);return t};TC.wrap.layer.Raster.prototype.getScaleDenominators=function(e){var t=[];e.scaleDenominator?t=[e.scaleDenominator,e.scaleDenominator]:(e.minScale||e.maxScale)&&(t=[e.minScale,e.maxScale]);if(!t.length&&!this.getName(e)){for(var i=this.getLayerNodes(e),n=-1/0,r=1/0,s=0,a=i.length;s<a;s++){var o=this.getScaleDenominators(i[s]);o[0]>n&&(n=o[0]);o[1]<r&&(r=o[1])}n>-1/0&&r<1/0&&(t=[n,r])}return t};TC.wrap.layer.Raster.prototype.getAttribution=function(e){var t={};if(e)if(e.serviceProvider){t.name=e.serviceProvider.providerName.trim();t.site=e.serviceProvider.providerSite;t.site.href&&(t.site=t.site.href)}else e.serviceIdentification?t.name=e.serviceIdentification.title.trim():t.name=e.service.title.trim();return t};TC.wrap.layer.Raster.prototype.getInfo=function(e){var t={},i=this.parent.capabilities;if(i&&i.capability)for(var n=function(e,t){var i=e.prefix.length&&0!==t.indexOf(e.prefix)?e.prefix+":"+t:t;return e.name===i},r=0;r<i.capability.layers.length;r++){var s=i.capability.layers[r];if(n(s,e)){s.title&&(t.title=s.title);s.abstract&&(t.abstract=s.abstract);s.styles.length&&(t.legend=s.styles[0].legend.href);if(s.metadataURLs.length){t.metadata=[];for(var a=0;a<s.metadataURLs.length;a++){var o=s.metadataURLs[a];t.metadata.push({format:o.format,type:o.type,url:o.href})}}t.queryable=s.queryable;break}}return t};TC.wrap.layer.Raster.prototype.getServiceType=function(){var e=null,t=this.parent.capabilities;t.capability&&t.capability.request&&t.capability.request.getmap?e=TC.Consts.layerType.WMS:t.operationsMetadata&&t.operationsMetadata.GetTile&&(e=TC.Consts.layerType.WMTS);return e};TC.wrap.layer.Raster.prototype.getServiceTitle=function(){var e=null,t=this.parent.capabilities;t.capability&&t.service?e=t.service.title:t.serviceIdentification&&(e=t.serviceIdentification.title);return e};TC.wrap.layer.Raster.prototype.getRootLayerNode=function(){var e;this.getServiceType()===TC.Consts.layerType.WMS&&(e=this.parent.capabilities.capability.nestedLayers[0]);return e};TC.wrap.layer.Raster.prototype.getName=function(e,t){var i=e.name;if(i&&t){var n=i.indexOf(":");n>=0&&(i=i.substr(n+1))}return i};TC.wrap.layer.Raster.prototype.getIdentifier=function(e){return e.identifier};TC.wrap.layer.Raster.prototype.getLayerNodes=function(e){var t=e.nestedLayers;$.isArray(t)||(t=[]);return t};TC.wrap.layer.Raster.prototype.normalizeLayerNode=function(e){e.Layer=e.nestedLayers;if(e.Layer)for(var t=0;t<e.Layer.length;t++)TC.wrap.layer.Raster.prototype.normalizeLayerNode(e.Layer[t]);e.Title=e.title;e.Abstract=e.abstract;return e};TC.wrap.layer.Raster.prototype.normalizeCapabilities=function(e){return{Capability:{Exception:cap.capability.exception,Layer:cap.capability.nestedLayers[0]},Service:cap.service,version:cap.version}};TC.wrap.layer.Raster.prototype.getAllLayerNodes=function(){var e=this.parent.capabilities;switch(this.getServiceType()){case TC.Consts.layerType.WMS:return e.capability.layers;case TC.Consts.layerType.WMTS:return e.contents.layers;default:return[]}};TC.wrap.layer.Raster.prototype.getLegend=function(e){var t={},i=e.styles;if(i&&i.length){var n=i[0].legend||{};t.src=n.href}return t};TC.wrap.layer.Raster.prototype.isCompatible=function(e){var t=!1,i=this.parent;switch(this.getServiceType()){case TC.Consts.layerType.WMS:if(i.capabilities&&i.capabilities.capability&&i.capabilities.capability.layers)if(0===i.names.length)t=!0;else for(var n=i.names.slice(0),r=0;r<i.capabilities.capability.layers.length;r++){var s=i.capabilities.capability.layers[r],a=$.inArray(this.getName(s),n);if(a>=0){n.splice(a,1);if(!(t=s.srs[e])||!n.length)break}}break;case TC.Consts.layerType.WMTS:var o=i.capabilities&&i.capabilities.contents&&i.capabilities.contents.tileMatrixSets[i.options.matrixSet]&&i.capabilities.contents.tileMatrixSets[i.options.matrixSet].supportedCRS,l=new RegExp("^urn:ogc:def:crs:"+e.replace(":",":.*:")+"$","g");t=o&&(l.test(o)||o===e)}return t};TC.wrap.layer.Raster.prototype.getCompatibleCRS=function(){return[]};TC.wrap.layer.Raster.prototype.getCompatibleLayers=function(e){var t=[],i=this.parent;switch(this.getServiceType()){case TC.Consts.layerType.WMS:if(i.capabilities&&i.capabilities.capability&&i.capabilities.capability.layers)for(var n=0;n<i.capabilities.capability.layers.length;n++){var r=i.capabilities.capability.layers[n],s=this.getName(r);r.srs[e]&&s&&(t[t.length]=s)}break;case TC.Consts.layerType.WMTS:var a=i.capabilities&&i.capabilities.contents&&i.capabilities.contents.tileMatrixSets;if(a){var o=new RegExp("^urn:ogc:def:crs:"+e.replace(":",":.*:")+"$","g");for(var l in a){var c=a[l].supportedCRS;c&&(o.test(c)||c===e)&&(t[t.length]=l)}}}return t};TC.wrap.layer.Raster.prototype.createWMSLayer=function(e,t,i){var n=new OpenLayers.Layer.WMS(i&&i.id?i.id:t.LAYERS,e,t,{isBaseLayer:1==(i&&i.isBase),singleTile:!0,transitionEffect:"resize",projection:this.parent.crs,units:"m",ratio:TC.Cfg.imageRatio});n._wrap=this;t.LAYERS.length||n.setVisibility(!1);this.addCommonEvents(n);n._originalGetURL=n.getURL;n._noGetURL=function(){return TC.Consts.BLANK_IMAGE};n.getURL=n.params.LAYERS.length>0?n._originalGetURL:n._noGetURL;return n};TC.wrap.layer.Raster.prototype.createWMTSLayer=function(e){var t=(new OpenLayers.Format.WMTSCapabilities).createLayer(this.parent.capabilities,{isBaseLayer:1==(e&&e.isBase),name:e&&e.id?e.id:TC.Consts.layerType.WMTS,matrixSet:e.matrixSet,layer:e.layerNames,requestEncoding:e.encoding===TC.Consts.WMTSEncoding.RESTFUL?"REST":"KVP"});t._wrap=self;this.addCommonEvents(t);return t};TC.wrap.layer.Raster.prototype.getParams=function(){return this.layer.params};TC.wrap.layer.Raster.prototype.setParams=function(e){this.layer.getURL=e.LAYERS.length>0?this.layer._originalGetURL:this.layer._noGetURL;this.layer.mergeNewParams(e)};TC.wrap.layer.Raster.prototype.setMatrixSet=function(e){};TC.wrap.layer.Raster.prototype.getResolutions=function(){return[]};TC.wrap.layer.Raster.prototype.getCompatibleMatrixSets=function(){return[]};TC.wrap.layer.Raster.prototype.setWMTSUrl=function(){};TC.wrap.Geometry={getNearest:function(e,t){var i=new OpenLayers.Geometry.LineString($.map(t,function(e){return new OpenLayers.Geometry.Point(e[0],e[1])})).distanceTo(new OpenLayers.Geometry.Point(e[0],e[1]),{details:!0});return[i.x0,i.y0]}};TC.wrap.layer.Vector.prototype.createVectorLayer=function(){var e=this,t=null,i=$.extend({},TC.Cfg,e.parent.options),n=OpenLayers.Feature.Vector.style.default,r=function(e,t){var r=OpenLayers.Style.prototype.getSymbolizerPrefix(t.geometry).toLowerCase();return i.styles[r]&&i.styles[r][e]||n[e]},s={strokeColor:"${getStrokeColor}",strokeWidth:"${getStrokeWidth}",strokeOpacity:"${getStrokeOpacity}",fillColor:"${getFillColor}",fillOpacity:"${getFillOpacity}",strokeLinecap:"${getStrokeLinecap}",strokeDashstyle:"${getStrokeDashstyle}"},a={getStrokeColor:function(e){return r("strokeColor",e)},getStrokeWidth:function(e){return r("strokeWidth",e)},getStrokeOpacity:function(e){return r("strokeOpacity",e)},getStrokeLinecap:function(e){return r("strokeLinecap",e)},getStrokeDashstyle:function(e){return r("strokeDashstyle",e)},getFillColor:function(e){return r("fillColor",e)},getFillOpacity:function(e){return r("fillOpacity",e)}},o=function(e){var t=e;if($.isFunction(e)){var i="f"+TC.getUID();a[i]=e;t="${"+i+"}"}return t};if(i.styles.point){s.pointRadius=o(i.styles.point.radius);s.graphic=i.styles.point.graphic;s.label=o(i.styles.point.label);s.fontColor=o(i.styles.point.fontColor);s.fontSize=o(i.styles.point.fontSize);s.fontWeight=o(i.styles.point.fontWeight);s.angle=o(i.styles.point.angle)}var l={styleMap:new OpenLayers.StyleMap({default:new OpenLayers.Style($.extend({},n,s),{context:a})}),projection:TC.Cfg.crs};i.isLabeling&&(l.renderers=[OpenLayers.Class(OpenLayers.Renderer.SVG,{drawText:function(e,t,i){var n=!!t.labelOutlineWidth;if(n){var r=OpenLayers.Util.extend({},t);r.fontColor=o(r.labelOutlineColor);r.fontStrokeColor=o(r.labelOutlineColor);r.fontStrokeWidth=o(t.labelOutlineWidth);t.labelOutlineOpacity&&(r.fontOpacity=o(t.labelOutlineOpacity));delete r.labelOutlineWidth;this.drawText(e,r,i)}var s=this.getResolution(),a=(i.x-this.featureDx)/s+this.left,l=i.y/s-this.top,c=n?this.LABEL_OUTLINE_SUFFIX:this.LABEL_ID_SUFFIX,u=this.nodeFactory(e+c,"text");u.setAttributeNS(null,"x",a);u.setAttributeNS(null,"y",-l);if(t.angle||0==t.angle){var h="rotate(-"+t.angle+","+a+","+-l+")";u.setAttributeNS(null,"transform",h)}t.fontColor&&u.setAttributeNS(null,"fill",t.fontColor);t.fontStrokeColor&&u.setAttributeNS(null,"stroke",t.fontStrokeColor);t.fontStrokeWidth&&u.setAttributeNS(null,"stroke-width",t.fontStrokeWidth);t.fontOpacity&&u.setAttributeNS(null,"opacity",t.fontOpacity);t.fontFamily&&u.setAttributeNS(null,"font-family",t.fontFamily);t.fontSize&&u.setAttributeNS(null,"font-size",t.fontSize);t.fontWeight&&u.setAttributeNS(null,"font-weight",t.fontWeight);t.fontStyle&&u.setAttributeNS(null,"font-style",t.fontStyle);if(!0===t.labelSelect){u.setAttributeNS(null,"pointer-events","visible");u._featureId=e}else u.setAttributeNS(null,"pointer-events","none");var p=t.labelAlign||OpenLayers.Renderer.defaultSymbolizer.labelAlign;u.setAttributeNS(null,"text-anchor",OpenLayers.Renderer.SVG.LABEL_ALIGN[p[0]]||"middle");!0===OpenLayers.IS_GECKO&&u.setAttributeNS(null,"dominant-baseline",OpenLayers.Renderer.SVG.LABEL_ALIGN[p[1]]||"central");for(var d=t.label.split("\n"),f=d.length;u.childNodes.length>f;)u.removeChild(u.lastChild);for(var m=0;m<f;m++){var y=this.nodeFactory(e+c+"_tspan_"+m,"tspan");if(!0===t.labelSelect){y._featureId=e;y._geometry=i;y._geometryClass=i.CLASS_NAME}!1===OpenLayers.IS_GECKO&&y.setAttributeNS(null,"baseline-shift",OpenLayers.Renderer.SVG.LABEL_VSHIFT[p[1]]||"-35%");y.setAttribute("x",a);if(0==m){var g=OpenLayers.Renderer.SVG.LABEL_VFACTOR[p[1]];null==g&&(g=-.5);y.setAttribute("dy",g*(f-1)+"em")}else y.setAttribute("dy","1em");y.textContent=""===d[m]?" ":d[m];y.parentNode||u.appendChild(y)}u.parentNode||this.textRoot.appendChild(u)},CLASS_NAME:"OpenLayers.Control.CustomSVG"})]);var c=new OpenLayers.Strategy.Fixed;if(e.parent.type===TC.Consts.layerType.KML){l.strategies=[c];l.protocol=new OpenLayers.Protocol.HTTP({url:TC.proxify(i.url),format:new OpenLayers.Format.KML({extractStyles:!0,extractAttributes:!0,parseFolders:!0,internalProjection:new OpenLayers.Projection(TC.Cfg.crs),externalProjection:new OpenLayers.Projection("EPSG:4326")})})}else if(i.type===TC.Consts.layerType.WFS){var u={};if(i.properties)for(var h=0;h<i.properties.length;h++){var p=i.properties[h];p.name&&p.type?u[p.name]={value:p.value||"",type:p.type,ignoreHyphens:p.ignoreHyphens}:u[p]=""}l.strategies=[c];l.protocol=new OpenLayers.Protocol.WFS({url:i.url,version:i.version,featureType:i.featureType,geometryName:i.geometryName,featurePrefix:i.namespace,outputFormat:i.outputFormat,srsName:TC.Cfg.crs});l.filter=function(e){var t,i=[];for(var n in e){var r,s,a,o=e[n];if(o.type){r=o.type;s=o.value;var l=new OpenLayers.Filter.Comparison({type:r,property:n,value:s});if(o.ignoreHyphens){l=[l,new OpenLayers.Filter.Comparison({type:r,property:n,value:s.replace(/-/g,"")})];a=new OpenLayers.Filter.Logical({type:OpenLayers.Filter.Logical.OR,filters:l})}else a=l}else{r=OpenLayers.Filter.Comparison.EQUAL_TO;s=o;a=new OpenLayers.Filter.Comparison({type:r,property:n,value:s})}i.push(a)}switch(i.length){case 0:t=null;break;case 1:t=i[0];break;default:t=new OpenLayers.Filter.Logical({type:OpenLayers.Filter.Logical.AND,filters:i})}return t}(u)}if(i.cluster){$.isArray(l.strategies)||(l.strategies=[]);l.strategies.push(new OpenLayers.Strategy.Cluster({distance:i.cluster.distance}))}(t=new OpenLayers.Layer.Vector("Vectors",l))._wrap=e;this.addCommonEvents(t);t.events.register("beforefeaturesadded",null,function(){e.parent.map.$events.trigger($.Event(TC.Consts.event.BEFOREFEATURESADD,{layer:e.parent}))});t.events.register("featuresadded",null,function(t){for(var i=[],n=[],r=[],s=0;s<t.features.length;s++){var a=t.features[s];a._wrap||(a.geometry instanceof OpenLayers.Geometry.Point?i[i.length]=a:a.geometry instanceof OpenLayers.Geometry.LineString||a.geometry instanceof OpenLayers.Geometry.MultiLineString?n[n.length]=a:(a.geometry instanceof OpenLayers.Geometry.Polygon||a.geometry instanceof OpenLayers.Geometry.MultiPolygon)&&(r[r.length]=a))}var o=[];i.length>0&&o.push(e.parent.addMarkers(i));n.length>0&&o.push(e.parent.addPolylines(n));r.length>0&&o.push(e.parent.addPolygons(r));$.when.apply(e,o).then(function(){var t=[];if(arguments.length)for(var i=0;i<arguments[0].length;i++){var n=t[i]=arguments[0][i];$.isArray(n.wrap.feature.cluster)&&(n.features=$.map(n.wrap.feature.cluster,function(e){return new n.constructor(e)}))}e.parent.map.$events.trigger($.Event(TC.Consts.event.FEATURESADD,{layer:e.parent,features:t}))})});t.events.register("featureremoved",null,function(t){var i=t.feature;if(i._wrap){var n=$.inArray(i._wrap.parent,e.parent.features);if(n>-1){e.parent.features.splice(n,1);e.parent.map.$events.trigger($.Event(TC.Consts.event.FEATUREREMOVE,{layer:e.parent,feature:i._wrap.parent}))}}});$(e.parent.map);t.events.register("featuresadded",null,function(){e.parent.map.$events.trigger($.Event(TC.Consts.event.VECTORUPDATE,{layer:e.parent}))});t.events.register("featuresremoved",null,function(){e.parent.map.$events.trigger($.Event(TC.Consts.event.VECTORUPDATE,{layer:e.parent}))});if(e.parent.type===TC.Consts.layerType.KML){t.events.register("added",null,function(){c.activate()});if(!e.parent.options.title){t.events.register("loadend",null,function i(){t.protocol.format._documentName&&(e.parent.title=t.protocol.format._documentName);t.events.unregister("loadend",null,i)})}}return t};TC.wrap.layer.Vector.prototype.getGetFeatureUrl=function(){return null};TC.wrap.layer.Vector.prototype.import=function(e){TC.error("TC.wrap.layer.Vector.prototype.import no est\xe1 soportada con OpenLayers 2")};TC.wrap.layer.Vector.prototype.addFeatures=function(e){$.when(this.getLayer()).then(function(t){t.addFeatures(e)})};TC.wrap.layer.Vector.prototype.getFeatures=function(){var e=this.getLayer();if(e instanceof OpenLayers.Layer){if(e.strategies)for(var t=0;t<e.strategies.length;t++){var i=e.strategies[t];i instanceof OpenLayers.Strategy.Filter&&i.setFilter(i.filter)}return e.features}return[]};TC.wrap.layer.Vector.prototype.getFeatureById=function(e){var t=this.getLayer();if(t instanceof OpenLayers.Layer){if(t.strategies)for(var i=0;i<t.strategies.length;i++){var n=t.strategies[i];n instanceof OpenLayers.Strategy.Filter&&n.setFilter(n.filter)}return t.getFeatureById(e)}return null};TC.wrap.layer.Vector.prototype.removeFeature=function(e){$.when(this.getLayer()).then(function(t){t.removeFeatures([e.wrap.feature])})};TC.wrap.layer.Vector.prototype.clearFeatures=function(){$.when(this.getLayer()).then(function(e){e.removeAllFeatures()})};TC.wrap.layer.Vector.prototype.setFeatureVisibility=function(e,t){var i=this;if($.inArray(e,i.parent.features)>=0){t?delete e.wrap.feature.style.display:e.wrap.feature.style.display="none";i._redrawTimeout&&clearTimeout(i._redrawTimeout);i._redrawTimeout=setTimeout(function(){$.when(i.getLayer()).then(function(e){e.redraw();i.parent.map.$events.trigger($.Event(TC.Consts.event.VECTORUPDATE,{layer:i.parent}))});delete i._redrawTimeout},100)}};TC.wrap.layer.Vector.prototype.getRGBA=function(e,t){var i=[0,0,0,1];if("string"==typeof e){var n=4===e.length?1:2;i[0]=parseInt(e.substr(1,n),16);i[1]=parseInt(e.substr(1+n,n),16);i[2]=parseInt(e.substr(1+2*n,n),16);if(1===n){i[0]=17*i[0];i[1]=17*i[1];i[2]=17*i[2]}void 0!==t&&(i[3]=t)}return i};TC.wrap.layer.Vector.prototype.findFeature=function(e){$.when(this.getLayer()).then(function(t){var i=t.filter;if(i){if(i.filters&&i.filters.length<=e.length)for(var n=0;n<i.filters.length;n++){var r=i.filters[n];if(r.type===OpenLayers.Filter.Logical.OR){r.filters[0].value=e[n];r.filters[1].value=e[n].replace("-","")}else r.value=e[n]}else i.value=e[0];t.removeAllFeatures();t.setVisibility(!0);t.strategies[0].active||t.strategies[0].activate();t.refresh()}})};TC.wrap.layer.Vector.prototype.sendTransaction=function(e,t,i){var n=$.Deferred();TC.error('"sendTransaction" no est\xe1 soportado por la versi\xf3n OpenLayers 2 de la API SITNA');n.reject();return n};TC.wrap.layer.Vector.prototype.setDraggable=function(e,t,i){var n=this;$.when(n.parent.map.wrap.getMap(),n.getLayer()).then(function(r,s){if(e){if(!n._ctl){var a={};$.isFunction(t)&&(a.onComplete=function(e,i){t.call(this,e._wrap.parent,[i.x,i.y])});$.isFunction(i)&&(a.onStart=function(e,t){i.call(this,e._wrap.parent,[t.x,t.y])});n._ctl=new OpenLayers.Control.DragFeature(s,a);r.addControl(n._ctl)}n._ctl.activate()}else n._ctl&&n._ctl.deactivate()})};TC.wrap.control.Click.prototype.register=function(e){var t=this;t._ctl=new OpenLayers.Control;$.when(e.wrap.getMap()).then(function(i){t._ctl.handler=new OpenLayers.Handler.Click(this,{click:function(e){var n=i.getLonLatFromPixel(e.xy);t.parent.callback([n.lon,n.lat],[e.xy.x,e.xy.y])}},{single:!0,double:!1,pixelTolerance:e.options.pixelTolerance,stopSingle:!1,stopDouble:!1});i.addControl(t._ctl)})};TC.wrap.control.Click.prototype.activate=function(){this._ctl.activate()};TC.wrap.control.Click.prototype.deactivate=function(){this._ctl.deactivate()};TC.wrap.control.ScaleBar.prototype.render=function(){this.ctl?this.ctl.draw():this.ctl=new OpenLayers.Control.ScaleLine({div:this.parent.div,bottomInUnits:"",bottomOutUnits:""})};TC.wrap.control.NavBar.prototype.register=function(e){var t=this;$.when(e.wrap.getMap()).then(function(e){t.zsCtl=new OpenLayers.Control.PanZoomBar({panIcons:!1,zoomWorldIcon:!0});e.addControl(t.zsCtl);e.events.register("changebaselayer",null,function(){t.zsCtl.moveZoomBar()})})};TC.wrap.control.NavBar.prototype.refresh=function(){};TC.wrap.control.Coordinates.prototype.register=function(e){var t=this,i=new $.Deferred;$.when(e.wrap.getMap()).then(function(n){var r=n.getProjectionObject();null===r&&(r=new OpenLayers.Projection(n.projection));t.parent.crs=r.getCode();t.parent.units=r.getUnits();t.parent.isGeo=e.wrap.isGeo();i.resolve()});return i};TC.wrap.control.Coordinates.prototype.onMouseMove=function(e){var t=this;$.when(t.parent.map.wrap.getMap()).then(function(i){var n=i.getLonLatFromPixel(i.events.getMousePosition(e.originalEvent));if(n){t.parent.isGeo?t.parent.latLon=[n.lat,n.lon]:t.parent.xy=[n.lon,n.lat];t.parent.update.apply(t.parent,arguments)}})};TC.wrap.control.Geolocation.prototype.register=function(e){};TC.wrap.Parser=function(){};TC.wrap.Parser.prototype.read=function(e){var t=[];if(this.parser){TC.Feature||TC.syncLoadJS(TC.apiLocation+"TC/Feature");t=$.map(this.parser.read(e),function(e){return new TC.Feature(null,{id:e.fid,data:e.data})})}return t};TC.wrap.parser={WFS:function(e){this.parser=new OpenLayers.Format.GML(e)},JSON:function(e){this.parser=new OpenLayers.Format.GeoJSON(e)}};TC.inherit(TC.wrap.parser.WFS,TC.wrap.Parser);TC.inherit(TC.wrap.parser.JSON,TC.wrap.Parser);TC.wrap.control.Search.prototype.addEvents=function(){var e=this;$.when(e.parent.layer.wrap.getLayer()).then(function(t){var i=e.parent.layer.map,n=i.wrap.isGeo()?i.options.pointBoundsRadius/TC.Util.getMetersPerDegree(i.getExtent()):i.options.pointBoundsRadius;t.events.register("featuresadded",t,function(t){for(var i=t.features[0].geometry.getBounds(),r=1;r<t.features.length;r++)i.extend(t.features[r].geometry.getBounds());if(i.left===i.right){i.left-=n;i.right+=n}if(i.top===i.bottom){i.bottom-=n;i.top+=n}e.parent.layer.map.setExtent(i)})})};TC.wrap.control.NavBar.prototype.setInitialExtent=function(e){};TC.wrap.control.OverviewMap.prototype.register=function(e){var t=this,i=function(){var e=new OpenLayers.Size(t.parent._$div.width(),t.parent._$div.height());0===e.w&&(e.w=100);0===e.h&&(e.h=100);return e},n=i();$.when(t.parent.layer.wrap.getLayer()).then(function(r){t.ovMap=new OpenLayers.Control.OverviewMap({div:t.parent.div,size:n,layers:[r],minRatio:24,maxRatio:48,autoPan:!0,theme:OpenLayers.CustomTheme,mapOptions:{projection:e.crs,displayProjection:e.crs,baseLayer:r,maxExtent:e.maxExtent,minRatio:24,maxRatio:48,minRectSize:30,theme:OpenLayers.CustomTheme},maximized:!0});var s=$(t.parent.div).find("."+t.parent.CLASS+"-load");r.events.register("loadstart",t.parent.layer,function(){s.removeClass(TC.Consts.classes.HIDDEN).addClass(TC.Consts.classes.VISIBLE)});r.events.register("loadend",t.parent.layer,function(){s.removeClass(TC.Consts.classes.VISIBLE).addClass(TC.Consts.classes.HIDDEN)});$.when(e.wrap.getMap()).then(function(e){e.addControl(t.ovMap);t.parent.isLoaded=!0;t.parent.$events.trigger($.Event(TC.Consts.event.MAPLOAD));e.events.register("updatesize",t.parent,function(){i();if(t.ovMap.ovmap){$ovmap=$(t.ovMap.ovmap.div);$ovmap.css("width",t.parent._$div.css("width")).css("height",t.parent._$div.css("height"));t.ovMap.ovmap.updateSize();t.ovMap.updateRectToMap()}})})})};TC.wrap.control.OverviewMap.prototype.reset=function(){TC.error("TC.wrap.control.OverviewMap.prototype.reset no implementado en OpenLayers 2")};TC.wrap.control.OverviewMap.prototype.get3DCameraLayer=function(){TC.error("TC.wrap.control.OverviewMap.prototype.get3DCameraLayer no implementado en OpenLayers 2")};TC.wrap.control.OverviewMap.prototype.draw3DCamera=function(e){TC.error("TC.wrap.control.OverviewMap.prototype.draw3DCamera no implementado en OpenLayers 2")};TC.wrap.control.OverviewMap.prototype.enable=function(){this.ovMap.activate();this.ovMap.update()};TC.wrap.control.OverviewMap.prototype.disable=function(){this.ovMap.deactivate()};TC.wrap.control.FeatureInfo.prototype.register=function(e){var t=this;t._map=e;$.when(e.wrap.getMap()).then(function(i){TC.wrap.control.Click.prototype.register.call(t,e);for(var n=[],r=function(e){var t=!1;e instanceof TC.layer.Raster&&!e.isBase&&e.wrap.getInfoFormats()&&(t=!0);return t},s=0;s<e.workLayers.length;s++){var a=e.workLayers[s];r(a)&&n.push(a.wrap.layer)}t._gfi=new OpenLayers.Control.WMSGetFeatureInfo({layers:n,autoActivate:!1,drillDown:!0,maxFeatures:1e3,queryVisible:!0,output:"object",formatOptions:{internalProjection:i.projection}});e.options.pixelTolerance&&(t._gfi.vendorParams={radius:e.options.pixelTolerance,buffer:e.options.pixelTolerance});i.addControl(t._gfi);e.on(TC.Consts.event.LAYERADD,function(e){r(e.layer)&&t._gfi.layers.push(e.layer.wrap.layer)}).on(TC.Consts.event.LAYERREMOVE,function(e){var i=$.inArray(e.layer.wrap.layer,t._gfi.layers);i>=0&&t._gfi.layers.splice(i,1)});var o={};t._gfi.events.register("beforegetfeatureinfo",t.parent,function(i){for(var n=0;n<i.object.layers.length;n++)for(var r=0;r<e.workLayers.length;r++)e.workLayers[r].wrap.layer===i.object.layers[n]&&(o[i.object.layers[n].url]=e.workLayers[r]);e.wrap.map.getLonLatFromPixel(i.xy);t.parent.beforeRequest({xy:[i.xy.x,i.xy.y]})});t._gfi.events.register("getfeatureinfo",t.parent,function(i){for(var n,r=0,s=[],a=[],l=[],c=0;c<i.features.length;c++){var u=i.features[c];n={layers:[],text:i.text};var h=o[u.url];if(h){n.mapLayer=h;delete o[u.url]}for(var p=0;p<u.features.length;p++){for(var d=u.features[p],f=d.fid?d.fid.substr(0,d.fid.lastIndexOf(".")):d.type||"",m=n.mapLayer?n.mapLayer.wrap.getInfo(f).title||f:"[Sin t\xedtulo]",y=null,g=0;g<n.layers.length;g++)if(n.layers[g].name===f){y=n.layers[g];break}if(!y){y={name:f,title:m,features:[]};n.layers.push(y)}s.push(TC.wrap.Feature.createFeature(d));a.push(y.features);r+=1}if(!u.features.length){contentType=i.request.getResponseHeader("Content-Type");if(0===contentType.indexOf("text/")){y={name:f,title:m,features:[]};n.layers.push(y);y.features.push({rawUrl:i.request._object.responseURL,rawContent:i.text});r+=1}}l.push(n)}$.when.apply(this,s).then(function(){if(arguments.length)for(var n=0;n<arguments.length;n++){var s=arguments[n];s.attributes=[];for(var o in s.data)s.attributes.push({name:o,value:s.data[o]});a[n].push(s)}var c=e.wrap.map.getLonLatFromPixel(i.xy);t.parent.responseCallback({coords:[c.lon,c.lat],resolution:t._gfi._resolution,services:l,featureCount:r})})});t._gfi.events.register("exception",t.parent,function(e){t.parent.responseError({status:e.request.status,message:e.request.responseText})})})};TC.wrap.control.FeatureInfo.prototype.getFeatureInfo=function(e,t){if(this._map&&this._gfi.layers.length>0){var i=map.wrap.map.getPixelFromLonLat({lon:e[0],lat:e[1]});this._gfi._resolution=t;this._gfi.getInfoForClick({xy:{x:i[0],y:i[1]}})}};TC.wrap.control.Popup.prototype=function(){this.popup=null};TC.wrap.control.Popup.prototype.fitToView=function(){var e=this;setTimeout(function(){e.popup.updateSize()},100)};TC.wrap.control.Popup.prototype.setDragged=function(e){};TC.wrap.Feature.prototype.getLegend=function(){var e={},t=this.feature.style;if(t.externalGraphic){e.src=t.externalGraphic;e.width=t.graphicWidth;e.height=t.graphicHeight}else{t.strokeColor&&(e.strokeColor=t.strokeColor);t.strokeWidth&&(e.strokeWidth=t.strokeWidth);t.fillColor&&(e.fillColor=t.fillColor);t.pointRadius&&(e.height=e.width=2*t.pointRadius)}return e};TC.wrap.Feature.prototype.createPoint=function(e,t){if($.isArray(e)){var i={pointRadius:t.radius||(t.height+t.width)/4};if(t.fillColor){i.fillColor=t.fillColor;i.fillOpacity=t.fillOpacity}else i.fill=!1;if(t.strokeColor){i.strokeColor=t.strokeColor;i.strokeWidth=t.strokeWidth}else i.stroke=!1;this.feature=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(e[0],e[1]),null,i)}else if(this.isNative(e)){this.feature=e;this.parent.geometry=[e.geometry.x,e.geometry.y];if(e.style){this.parent.options.radius=e.style.pointRadius;this.parent.options.fillColor=e.style.fillColor;this.parent.options.fillOpacity=e.style.fillOpacity;this.parent.options.strokeColor=e.style.strokeColor}}t&&t.id&&(this.feature.id=t.id);this.feature._wrap=this};TC.wrap.Feature.prototype.createMarker=function(e,t){if(TC.Util.getPointIconUrl(t)){if($.isArray(e)){var i={externalGraphic:TC.Util.getPointIconUrl(t),graphicWidth:t.width,graphicHeight:t.height,graphicXOffset:-Math.round(t.anchor[0]*t.width),graphicYOffset:-Math.round(t.anchor[1]*t.height)};this.feature=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(e[0],e[1]),null,i)}else if(this.isNative(e)){this.feature=e;this.parent.geometry=[e.geometry.x,e.geometry.y];if(e.style){this.parent.options.url=e.style.externalGraphic;this.parent.options.width=e.style.graphicWidth;this.parent.options.height=e.style.graphicHeight;this.parent.options.anchor=[-e.style.graphicXOffset/e.style.graphicWidth,-e.style.graphicYOffset/e.style.graphicHeight]}}t&&t.id&&(this.feature.id=t.id);this.feature._wrap=this}else this.createPoint(e,t)};TC.wrap.Feature.prototype.createPolyline=function(e,t){if($.isArray(e)){var i=$.map(e,function(e){return new OpenLayers.Geometry.Point(e[0],e[1])});this.feature=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.LineString(i),null,{stroke:!0,strokeColor:t.strokeColor,strokeWidth:t.strokeWidth})}else if(this.isNative(e)){this.feature=e;for(var n=this.parent.geometry=e.geometry.getVertices(),r=0;r<n.length;r++)n[r]=[n[r].x,n[r].y];if(e.style){this.parent.options.strokeColor=e.style.strokeColor;this.parent.options.strokeWidth=e.style.strokeWidth}}this.feature._wrap=this};TC.wrap.Feature.prototype.createPolygon=function(e,t){if($.isArray(e)){var i,n=function(e){return new OpenLayers.Geometry.LinearRing($.map(e,function(e){return new OpenLayers.Geometry.Point(e[0],e[1])}))};if(e.length>0&&$.isArray(e[0])&&e[0].length>0&&$.isArray(e[0][0])){i=new Array(e.length);for(var r=0,s=e.length;r<s;r++)i[r]=n(e[r])}else i=[n(e)];this.feature=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Polygon(i),null,{stroke:!0,strokeColor:t.strokeColor,strokeWidth:t.strokeWidth,fillColor:t.fillColor,fillOpacity:t.fillOpacity})}else if(this.isNative(e)){this.feature=e;if(e.geometry){var a=this.parent.geometry=e.geometry.getVertices();for(r=0;r<a.length;r++)a[r]=[a[r].x,a[r].y]}if(e.style){this.parent.options.strokeColor=e.style.strokeColor;this.parent.options.strokeWidth=e.style.strokeWidth;this.parent.options.fillColor=e.style.fillColor;this.parent.options.fillOpacity=e.style.fillOpacity}}this.feature._wrap=this};TC.wrap.Feature.prototype.createCircle=function(e,t){};TC.wrap.Feature.createFeature=function(e){var t=new $.Deferred,i={id:e.fid,data:e.attributes};e.geometry instanceof OpenLayers.Geometry.Point?TC.loadJS(!TC.feature||TC.feature&&!TC.feature.Point,[TC.apiLocation+"TC/feature/Point"],function(){t.resolve(new TC.feature.Point(e,i))}):e.geometry instanceof OpenLayers.Geometry.LineString?TC.loadJS(!TC.feature||TC.feature&&!TC.feature.Polyline,[TC.apiLocation+"TC/feature/Polyline"],function(){t.resolve(new TC.feature.Polyline(e,i))}):e.geometry instanceof OpenLayers.Geometry.MultiLineString?TC.loadJS(!TC.feature||TC.feature&&!TC.feature.MultiPolyline,[TC.apiLocation+"TC/feature/MultiPolyline"],function(){t.resolve(new TC.feature.MultiPolyline(e,i))}):e.geometry instanceof OpenLayers.Geometry.Polygon?TC.loadJS(!TC.feature||TC.feature&&!TC.feature.Polygon,[TC.apiLocation+"TC/feature/Polygon"],function(){t.resolve(new TC.feature.Polygon(e,i))}):e.geometry instanceof OpenLayers.Geometry.MultiPolygon?TC.loadJS(!TC.feature||TC.feature&&!TC.feature.MultiPolygon,[TC.apiLocation+"TC/feature/MultiPolygon"],function(){t.resolve(new TC.feature.MultiPolygon(e,i))}):TC.loadJS(!TC.Feature,[TC.apiLocation+"TC/Feature"],function(){t.resolve(new TC.Feature(e,i))});return t};TC.wrap.Feature.prototype.cloneFeature=function(){return new this.feature.constructor(this.feature.geometry.clone(),this.feature.attributes,this.feature.style)};TC.wrap.Feature.prototype.getStyle=function(){var e=this.feature.style,t={};if(e.fillColor){t.fillColor=e.fillColor;t.fillOpacity=e.fillOpacity}if(e.strokeColor){t.strokeColor=e.strokeColor;t.strokeWidth=e.strokeWidth}if(e.externalGraphic){t.url=e.externalGraphic;t.anchor=[e.graphicXOffset/e.graphicWidth,e.graphicYOffset/e.graphicHeight]}if(e.label){t.label=e.label;t.labelOffset=[e.labelXOffset,e.labelYOffset];t.fontColor=e.fontColor;t.labelOutlineColor=e.labelOutlineColor;t.labelOutlineWidth=e.labelOutlineWidth;t.fontSize=e.fontSize}return t};TC.wrap.Feature.prototype.getGeometry=function(){var e;if(this.feature&&this.feature.geometry){var t=function(e){return[e.x,e.y]},i=function(e){for(var i=e.getVertices(),n=0,r=i.length;n<r;n++)i[n]=t(i[n]);return i},n=function(e){for(var t=new Array(e.components.length),n=0,r=e.components.length;n<r;n++)t[n]=i(e.components[n]);return t},r=this.feature.geometry;r instanceof OpenLayers.Geometry.Point?e=t(r):r instanceof OpenLayers.Geometry.LineString?e=i(r):r instanceof OpenLayers.Geometry.MultiLineString?e=i(r.components[0]):r instanceof OpenLayers.Geometry.Polygon?e=n(r):r instanceof OpenLayers.Geometry.MultiPolygon&&(e=n(r.components[0]))}return e};TC.wrap.Feature.prototype.setGeometry=function(e){var t=!1;if(this.feature&&this.feature.geometry){var i=this.feature.geometry;if(i instanceof OpenLayers.Geometry.Point&&$.isArray(e)&&"number"==typeof e[0]&&"number"==typeof e[1]){i.move(e[0]-i.x,e[1]-i.y);t=!0}}return t};TC.wrap.Feature.prototype.getId=function(){var e;this.feature&&(e=this.feature.fid);return e};TC.wrap.Feature.prototype.setId=function(e){this.feature&&(this.feature.fid=e)};const e=function(e){return e.map(function(e){return{x:e[0],y:e[1]}})},t=function(e){return e.map(function(e){return[e.x,e.y]})};TC.wrap.Feature.prototype.getLength=function(i){const n=this;i=i||{};const r=n.feature.geometry;var s;if(r instanceof OpenLayers.Geometry.Polygon){s=t(r.getVertices());i.crs&&(s=TC.Util.reproject(s,n.parent.map.crs,i.crs));return new OpenLayers.Geometry.LinearRing(e(s)).getLength()}if(r instanceof OpenLayers.Geometry.LineString){s=t(r.getVertices());i.crs&&(s=TC.Util.reproject(s,n.parent.map.crs,i.crs));return new OpenLayers.Geometry.LineString(e(s)).getLength()}};TC.wrap.Feature.prototype.getArea=function(i){const n=this;i=i||{};const r=n.feature.geometry;var s;if(r instanceof OpenLayers.Geometry.Polygon){s=t(r.getVertices());i.crs&&(s=TC.Util.reproject(s,n.parent.map.crs,i.crs));return new OpenLayers.Geometry.Polygon([new OpenLayers.Geometry.LinearRing(e(s))]).getArea()}};TC.wrap.Feature.prototype.setStyle=function(e){var t=this.feature.style||new OpenLayers.Style;e instanceof OpenLayers.Style||(e=new OpenLayers.Style(e));e=e.createLiterals(OpenLayers.Util.extend({},e.defaultStyle),this.feature);if(this.feature.geometry instanceof OpenLayers.Geometry.Point){t.externalGraphic=e.url;t.graphicWidth=e.width;t.graphicHeight=e.height;e.anchor&&e.width&&(t.graphicXOffset=-Math.round(e.anchor[0]*e.width));e.anchor&&e.height&&(t.graphicYOffset=-Math.round(e.anchor[1]*e.height));t.graphic=e.graphic;e.label&&(t.label=e.label.toCamelCase());e.angle&&(t.angle=e.angle);t.fontColor=e.fontColor;t.labelOutlineColor=e.labelOutlineColor;t.labelOutlineWidth=e.labelOutlineWidth}else if(this.feature.geometry.components&&this.feature.geometry.components instanceof Array&&this.feature.geometry.components[0].CLASS_NAME==(new OpenLayers.Geometry.LineString).CLASS_NAME||!this.feature.geometry.components&&this.feature.geometry instanceof new OpenLayers.Geometry.LineString){t.stroke=!0;t.strokeColor=e.strokeColor;t.strokeWidth=e.strokeWidth}else if(this.feature.geometry.components&&this.feature.geometry.components instanceof Array&&this.feature.geometry.components[0].CLASS_NAME==(new OpenLayers.Geometry.Polygon).CLASS_NAME||!this.feature.geometry.components&&this.feature.geometry instanceof new OpenLayers.Geometry.Polygon){t.stroke=!0;t.strokeColor=e.strokeColor;t.strokeWidth=e.strokeWidth;t.fillColor=e.fillColor;t.fillOpacity=e.fillOpacity}this.feature.layer&&this.feature.layer.drawFeature(this.feature,t)};TC.wrap.Feature.prototype.getInnerPoint=function(e){var t=this.feature,i=t.geometry.getCentroid(!0);if(!result.intersects(t.geometry)){var n=t.geometry.distanceTo(result,{details:!0});i=new OpenLayers.Geometry.Point(n.x0,n.y0)}return[i.x,i.y]};TC.wrap.Feature.prototype.showPopup=function(e){var t=this;t.feature;Modernizr.canvas&&-1===OpenLayers.Popup.Anchored.prototype.displayClass.indexOf(TC.control.Popup.prototype.CLASS)&&(OpenLayers.Popup.Anchored.prototype.displayClass=OpenLayers.Popup.Anchored.prototype.displayClass+" "+TC.control.Popup.prototype.CLASS+" "+TC.Consts.classes.VISIBLE);var i=Modernizr.canvas?OpenLayers.Popup.Anchored:OpenLayers.Popup.FramedCloud;t._innerCentroid||(t._innerCentroid=t.getInnerPoint());e.currentFeature=t.parent;var n=e.map;n&&$.when(n.wrap.getMap()).then(function(r){if(n.popup){r.removePopup(n.popup.wrap.popup);n.popup.wrap.popup.destroy();delete n.popup.wrap.popup;n.popup=null}var s=t.parent.getInfo();if(s){var a=t.parent.options,o=null;Modernizr.canvas&&a.anchor&&a.height&&(o={size:new OpenLayers.Size(0,a.height),offset:new OpenLayers.Pixel(0,-a.height*a.anchor[1])});var l=new i(null,new OpenLayers.LonLat(t._innerCentroid[0],t._innerCentroid[1]),null,s,o,e.options.closeButton,function(t){this.hide();OpenLayers.Event.stop(t);n.$events.trigger($.Event(TC.Consts.event.POPUPHIDE,{control:e}))});l.autoSize=!0;l.panMapIfOutOfView=!0;l.keepInMap=!0;l.maxSize=new OpenLayers.Size(r.size.w/2,r.size.h/2);e.$popupDiv=$(l.div);e.wrap.popup=l;n.popup=e;r.addPopup(l);if(Modernizr.canvas){e.$popupDiv.css("overflow","").css("border","").css("width","").css("height","");var c=$(l.contentDiv).css("position","");l.updateSize();c.css("width","");var u=$(l.groupDiv).find(".olPopupCloseBox").attr("style","").addClass(e.CLASS+"-close").attr("title",e.getLocaleString("close"));u.length&&c.css("margin-right",u.width())}}})};TC.wrap.Feature.prototype.isNative=function(e){return e instanceof OpenLayers.Feature};TC.wrap.Feature.prototype.getPath=function(){var e=[];this.feature&&this.feature._folders&&(e=this.feature._folders);return e};TC.wrap.Feature.prototype.getBounds=function(){var e=null;if(this.feature&&this.feature.geometry){var t=this.feature.geometry.getBounds();e=[t.left,t.bottom,t.right,t.top]}return e};TC.wrap.Feature.prototype.getTemplate=function(){var e=null;this.feature.style&&(e=this.feature.style.balloonStyle)&&(e=e.replace(/\$\{(\w+)\}/g,"$$[$1]"));return e};TC.wrap.Feature.prototype.getData=function(){var e=$.extend({},this.feature.attributes);for(var t in e)e[t].value&&(e[t]=e[t].value);return e};TC.wrap.control.Draw.prototype.activate=function(e){var t=this,i=e===TC.Consts.geom.POLYGON?OpenLayers.Handler.Polygon:OpenLayers.Handler.Path;t.parent.map&&$.when(t.parent.map.wrap.getMap()).then(function(n){if(t.control){t.control.deactivate();n.removeControl(t.control)}if(e){var r=function(e){var i="measurepartial"===e.type?TC.Consts.event.MEASUREPARTIAL:TC.Consts.event.MEASURE,n={units:e.units};if(1===e.order)n.length=e.measure;else if(2===e.order){n.area=e.measure;n.perimeter=t.control.getLength(e.geometry,e.units)}t.parent.measure&&t.parent.$events.trigger($.Event(i,n));t.parent.$events.trigger($.Event(TC.Consts.event.DRAWEND,{feature:new TC.feature.Polygon(e.geometry.components)}))};t.control=new OpenLayers.Control.Measure(i,{geodesic:!0,persist:!0,immediate:!0});t.control.handler.callbacks.point=function(e){t.parent.$events.trigger($.Event(TC.Consts.event.POINT,{point:[e.x,e.y]}))};t.parent.measure?t.control.events.on({measure:r,measurepartial:r}):t.control.events.on({measure:r});n.addControl(t.control);t.control.activate()}})};TC.wrap.control.Draw.prototype.deactivate=function(){this.control&&this.control.deactivate()};TC.wrap.control.Draw.prototype.undo=function(){var e=!1;this.control&&this.control.handler&&(e=this.control.handler.undo());return e};TC.wrap.control.Draw.prototype.redo=function(){var e=!1;this.control&&this.control.handler&&(e=this.control.handler.redo());return e};TC.wrap.control.Draw.prototype.end=function(){if(this.control&&this.control.handler){this.control.handler.finishGeometry();this.control.handler.layer&&this.control.handler.layer.redraw()}};TC.wrap.control.Draw.prototype.setStyle=function(){TC.error("TC.wrap.control.Draw.prototype.setStyle no implementado en OpenLayers 2")};TC.wrap.control.CacheBuilder.prototype.getRequestSchema=function(e){return{}};TC.wrap.control.CacheBuilder.prototype.getGetTilePattern=function(e){return""}}();TC.control=TC.control||{};TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control");TC.control.Attribution=function(){TC.Control.apply(this,arguments);this.apiAttribution="";this.mainDataAttribution="";this.dataAttributions=[];this.options.dataAttributions&&(this.dataAttributions=this.options.dataAttributions instanceof Array?this.options.dataAttributions:[this.options.dataAttributions])};TC.inherit(TC.control.Attribution,TC.Control);!function(){var e=TC.control.Attribution.prototype;e.CLASS="tc-ctl-attrib";TC.isDebug?e.template=TC.apiLocation+"TC/templates/Attribution.html":e.template=function(){dust.register(e.CLASS,t);function t(e,t){return e.w("<div><span>&copy; ").f(t.get(["api"],!1),t,"h",["s"]).w("</span> - ").h("i18n",t,{},{$key:"data"}).w(": ").x(t.getPath(!1,["mainData","site"]),t,{else:i,block:n},{}).x(t.get(["otherData"],!1),t,{block:r},{}).w('<div class="tc-ctl-attrib-other tc-collapsed">').s(t.get(["otherData"],!1),t,{block:s},{}).w("</div></div>")}t.__dustBody=!0;function i(e,t){return e.w("<span>&copy; ").f(t.getPath(!1,["mainData","name"]),t,"h").w("</span>")}i.__dustBody=!0;function n(e,t){return e.w('<span>&copy; <a href="').f(t.getPath(!1,["mainData","site"]),t,"h").w('" target="_blank">').f(t.getPath(!1,["mainData","name"]),t,"h").w("</a></span>")}n.__dustBody=!0;function r(e,t){return e.w(' - <span class="tc-ctl-attrib-cmd">').h("i18n",t,{},{$key:"others"}).w("...</span>")}r.__dustBody=!0;function s(e,t){return e.x(t.getPath(!1,["otherData",t.get(["$idx"],!1),"site"]),t,{else:a,block:o},{}).h("sep",t,{block:l},{})}s.__dustBody=!0;function a(e,t){return e.w("<span>&copy; ").f(t.getPath(!1,["otherData",t.get(["$idx"],!1),"name"]),t,"h").w("</span>")}a.__dustBody=!0;function o(e,t){return e.w('<span>&copy; <a href="').f(t.getPath(!1,["otherData",t.get(["$idx"],!1),"site"]),t,"h").w('" target="_blank">').f(t.getPath(!1,["otherData",t.get(["$idx"],!1),"name"]),t,"h").w("</a></span>")}o.__dustBody=!0;function l(e,t){return e.w(", ")}l.__dustBody=!0;return t};e.register=function(e){var t=this;TC.Control.prototype.register.call(t,e);t.apiAttribution=t.map.options.attribution||t.apiAttribution;var i=function(e){if(e){var i=e.wrap.getAttribution(TC.capabilities[e.url]);if(i)if(/IDENA/.test(i.name))t.mainDataAttribution={name:"IDENA",site:"http://idena.navarra.es/"};else{for(var n=!1,r=0;r<t.dataAttributions.length;r++)if(i.name===t.dataAttributions[r].name){n=!0;break}n||t.dataAttributions.push(i)}}},n=function(e){if(e){if(function(){if(e.map.workLayers.length>0){for(var t=e.map.workLayers.slice().reverse(),i=0;i<t.length;i++)if(t[i].url==e.url&&t[i].getVisibility())return!1;return!0}return!0}()){var i=e.wrap.getAttribution(TC.capabilities[e.url]);if(i){var n=t.dataAttributions.reduce(function(e,t,n){return t.name===i.name?n:e},-1);n>-1&&t.dataAttributions.splice(n,1)}}}};t.render();e.on(TC.Consts.event.LAYERADD,function(e){if(e.layer.wrap.getAttribution){i(e.layer);t.render()}});e.on(TC.Consts.event.LAYERREMOVE,function(e){if(e.layer.wrap.getAttribution){n(e.layer);t.render()}});e.on(TC.Consts.event.LAYERVISIBILITY,function(e){if(e.layer.wrap.getAttribution){e.layer.getVisibility()?i(e.layer):n(e.layer);t.render()}})};e.render=function(e){var t=this;t.renderData({api:t.apiAttribution,mainData:t.mainDataAttribution,otherData:t.dataAttributions},function(){t._$div.find("."+t.CLASS+"-cmd").on(TC.Consts.event.CLICK,function(){t._$div.find("."+t.CLASS+"-other").toggleClass(TC.Consts.classes.COLLAPSED)});$.isFunction(e)&&e()})}}();TC.control=TC.control||{};TC.control.MapContents||TC.syncLoadJS(TC.apiLocation+"TC/control/MapContents");!function(){TC.control.BasemapSelector=function(){var e=this;TC.control.MapContents.apply(e,arguments);e._$dialogDiv=$(TC.Util.getDiv(e.options.dialogDiv));e.options.dialogDiv||e._$dialogDiv.appendTo("body");e._$dialogDiv.on(TC.Consts.event.CLICK,"button",function(i){TC.Util.closeModal();const n=$(i.target),r=n.data(t.PROJCODE),s=e._$dialogDiv.find("."+e.CLASS+"-crs-dialog").data(t.LAYER);if(s)if(r)TC.loadProjDef({crs:r,callback:function(){e.map.setProjection({crs:r,baseLayer:s})}});else{const i=n.data(t.FALLBACK_LAYER);i&&e.map.setBaseLayer(i)}})};TC.inherit(TC.control.BasemapSelector,TC.control.MapContents);var e=TC.control.BasemapSelector.prototype;e.CLASS="tc-ctl-bms";var t={LAYER:"tcLayer",FALLBACK_LAYER:"tcFallbackLayer",PROJCODE:"tcProjCode"};e.template={};if(TC.isDebug){e.template[e.CLASS]=TC.apiLocation+"TC/templates/BasemapSelector.html";e.template[e.CLASS+"-node"]=TC.apiLocation+"TC/templates/BasemapSelectorNode.html";e.template[e.CLASS+"-dialog"]=TC.apiLocation+"TC/templates/BasemapSelectorDialog.html"}else{e.template[e.CLASS]=function(){dust.register(e.CLASS,t);function t(e,t){return e.w("<h2>").h("i18n",t,{},{$key:"backgroundMaps"}).w('</h2><div class="tc-ctl-bms-tree"><form><ul class="tc-ctl-bms-branch">').s(t.get(["baseLayers"],!1),t,{block:i},{}).w("</ul></form></div>")}t.__dustBody=!0;function i(e,t){return e.p("tc-ctl-bms-node",t,t.rebase(t.getPath(!0,[])),{})}i.__dustBody=!0;return t};e.template[e.CLASS+"-node"]=function(){dust.register(e.CLASS+"-node",t);function t(e,t){return e.w('<li class="tc-ctl-bms-node" data-tc-layer-name="').f(t.get(["name"],!1),t,"h").w('" data-tc-layer-uid="').f(t.get(["uid"],!1),t,"h").w('"><label').x(t.get(["legend"],!1),t,{block:i},{}).w('><input type="radio" name="bms" value="').f(t.get(["name"],!1),t,"h").w('"').x(t.get(["mustReproject"],!1),t,{block:n},{}).w(" /><span>").f(t.get(["title"],!1),t,"h").w("</span></label></li>")}t.__dustBody=!0;function i(e,t){return e.w(' style="background-image: url(').f(t.getPath(!1,["legend","src"]),t,"h").w(')"')}i.__dustBody=!0;function n(e,t){return e.w(' class="tc-disabled"')}n.__dustBody=!0;return t};e.template[e.CLASS+"-dialog"]=function(){dust.register(e.CLASS+"-dialog",t);function t(e,t){return e.w('<div class="tc-ctl-bms-crs-dialog tc-modal"><div class="tc-modal-background tc-modal-close"></div><div class="tc-modal-window"><div class="tc-modal-header"><h3>').h("i18n",t,{},{$key:"baseLayerNotCompatible"}).w('</h3><div class="tc-ctl-popup-close tc-modal-close"></div></div><div class="tc-modal-body"><p>').h("i18n",t,{},{$key:"baseLayerNotCompatible.instructions|h"}).w('</p><ul class="tc-ctl-bms-crs-list tc-crs-list"></ul></div><div class="tc-modal-footer"><button type="button" class="tc-button tc-modal-close">').h("i18n",t,{},{$key:"close"}).w("</button></div></div></div>")}t.__dustBody=!0;return t}}e.register=function(e){var i=this;TC.control.MapContents.prototype.register.call(i,e);e.on(TC.Consts.event.BASELAYERCHANGE+" "+TC.Consts.event.PROJECTIONCHANGE,function(){i.update()});i._$div.on("change","input[type=radio]",function(e){var n=$(e.target).closest("li").data(t.LAYER);if(n!=n.map.getBaseLayer())if(n.mustReproject){i._$currentSelection.prop("checked",!0);const e={layer:n},t=n.getFallbackLayer();t?t._capabilitiesPromise.then(function(){t.isCompatible(i.map.crs)&&(e.fallbackLayer=t);i.showProjectionChangeDialog(e)}):i.showProjectionChangeDialog(e)}else n.map.setBaseLayer(n);e.stopPropagation()})};e.render=function(e){var t=this;TC.control.MapContents.prototype.render.call(t,e);t.getRenderedHtml(t.CLASS+"-dialog",null,function(e){t._$dialogDiv.html(e)})};e.update=function(){var e=this;e._$currentSelection=null;e._$div.find("ul."+e.CLASS+"-branch").children("li").each(function(i,n){var r=$(n),s=r.data(t.LAYER),a=r.find("input[type=radio]").first(),o=e.map.baseLayer===s||s.getFallbackLayer&&e.map.baseLayer===s.getFallbackLayer();a.prop("checked",o).toggleClass(TC.Consts.classes.DISABLED,s.mustReproject||!1);r.attr("title",s.mustReproject?e.getLocaleString("reprojectionNeeded"):null);o&&(e._$currentSelection=a)});e.updateScale()};e.updateLayerTree=function(e){var i=this;if(e.isBase&&!e.options.stealth){TC.control.MapContents.prototype.updateLayerTree.call(i,e);var n=i.CLASS+"-node";TC.loadJSInOrder(!window.dust,TC.url.templating,function(){dust.render(n,i.layerTrees[e.id],function(n,r){var s=$(r),a=s.data("tcLayerUid"),o=i._$div.find("."+i.CLASS+"-branch"),l=o.find('li[data-tc-layer-uid="'+a+'"]');if(1===l.length)l.html(s.html());else{s.data(t.LAYER,e);const n=i.map.baseLayers.reduce(function(t,n,r){return i.map.baseLayers[r].id===e.id?r:t},-1);if(n<0)o.append(s);else{n>=o.find("li").length?o.append(s):s.insertBefore(o.find("li").get(n))}}n&&TC.error(n)});i.update()})}};e.updateLayerOrder=function(e,t,i){};e.removeLayer=function(e){if(e.isBase){this._$div.find("."+this.CLASS+"-branch").children("li").each(function(i,n){var r=$(n);if(r.data(t.LAYER)===e){r.remove();return!1}})}};e.showProjectionChangeDialog=function(e){const i=this,n=(e=e||{}).layer,r=i._$dialogDiv.find("."+i.CLASS+"-crs-dialog");r.data(t.LAYER,n);const s=r.find("ul."+i.CLASS+"-crs-list").empty();i.map.loadProjections({crsList:i.map.getCompatibleCRS({layers:i.map.workLayers.concat(n)}),orderBy:"name"}).then(function(n){n.forEach(function(e){s.append($("<li>").append($("<button>").html(i.getLocaleString("changeMapToCrs",{crs:e.name+" ("+e.code+")"})).data(t.PROJCODE,e.code)))});e.fallbackLayer&&s.append($("<li>").append($("<button>").html(i.getLocaleString("reprojectOnTheFly")).data(t.FALLBACK_LAYER,e.fallbackLayer)))});r.find("."+i.CLASS+"-name").html(n.title||n.name);TC.Util.showModal(r)}}();TC.control=TC.control||{};TC.control.SWCacheClient||TC.syncLoadJS(TC.apiLocation+"TC/control/SWCacheClient");!function(){TC.Consts.classes.CONNECTION_OFFLINE=TC.Consts.classes.CONNECTION_OFFLINE||"tc-conn-offline";TC.Consts.classes.CONNECTION_WIFI=TC.Consts.classes.CONNECTION_WIFI||"tc-conn-wifi";TC.Consts.classes.CONNECTION_MOBILE=TC.Consts.classes.CONNECTION_MOBILE||"tc-conn-mobile";TC.Consts.classes.OFFLINE=TC.Consts.classes.OFFLINE||"tc-offline";var e=window.applicationCache;TC._appCacheBuilders||(TC._appCacheBuilders=[]);TC._appCacheUpdater||(TC._appCacheUpdater=function(e,t){TC.Util.getQueryStringParams(t);for(var i=0,n=TC._appCacheBuilders.length;i<n;i++){var r=TC._appCacheBuilders[i];switch(e.type){case"cached":r.$events.trigger($.Event(TC.Consts.event.MAPCACHEDOWNLOAD,{url:t}));break;case"obsolete":r.$events.trigger($.Event(TC.Consts.event.MAPCACHEDELETE,{url:t}));break;case"checking":break;case"progress":r.$events.trigger($.Event(TC.Consts.event.MAPCACHEPROGRESS,{url:t,loaded:e.loaded,total:e.total}));break;case"error":r.$events.trigger($.Event(TC.Consts.event.MAPCACHEERROR,{url:t,reason:e.reason,status:e.status}));break;case"noupdate":case"updateready":r.$events.trigger($.Event(TC.Consts.event.MAPCACHEERROR,{url:t,reason:"already_exists",status:e.status}))}}});var t,i=(t=window.parent!==window&&document.referrer&&TC.Util.isSameOrigin(document.referrer)&&parent.TC&&parent.TC._appCacheUpdater,function(e){t&&parent.TC._appCacheUpdater(e,location.href)}),n=function(){var e=$.Deferred(),t=$("html").attr("manifest");t?$.ajax({url:t,type:"GET",dataType:"text"}).done(function(t){TC.loadJS(!window.hex_md5,[TC.apiLocation+TC.Consts.url.HASH],function(){var i=hex_md5(t),n=t.indexOf("NETWORK:");n>=0&&(t=t.substr(0,n));(n=t.indexOf("FALLBACK:"))>=0&&(t=t.substr(0,n));(n=t.indexOf("SETTINGS:"))>=0&&(t=t.substr(0,n));var r=$.grep(t.split(/[\n\r]/),function(e){return e.length>0&&0!==e.indexOf("#")&&"CACHE:"!==e});r.shift();e.resolve({hash:i,urls:r})})}).fail(function(){e.reject()}):e.reject();return e};e.addEventListener("cached",i,!1);e.addEventListener("error",i,!1);e.addEventListener("noupdate",i,!1);e.addEventListener("obsolete",i,!1);e.addEventListener("progress",i,!1);e.addEventListener("updateready",i,!1);TC.control.CacheBuilder=function(){var e=this;TC.control.SWCacheClient.apply(this,arguments);var t=e._classSelector="."+e.CLASS;e._selectors={DRAW:t+"-draw",DRAWING:t+"-drawing",PROGRESS:t+"-progress",NEW:t+"-new",LIST:t+"-list",LISTITEM:t+"-list > li",DELBTN:t+"-btn-del",OKBTN:t+"-btn-ok",NEWBTN:t+"-btn-new",SAVEBTN:".tc-btn-save",CANCELBTN:".tc-btn-cancel",EDITBTN:".tc-btn-edit",VIEWBTN:".tc-btn-view",DELETEBTN:".tc-btn-delete",TILECOUNT:t+"-tile-count",NAMETB:t+"-txt-name",TEXTBOX:"input.tc-textbox",EXIT:t+"-link-exit",OFFPANEL:t+"-off-panel",BLLIST:t+"-bl-list",BLLISTITEM:t+"-bl-list > li",BLLISTTEXT:t+"-bl-panel-txt",RNGMAXRES:t+"-rng-maxres",SEARCH:t+"-map-available-srch",EMPTYLIST:t+"-map-available-empty",OFFLINEHIDDEN:"[data-no-cb]"};e.storedMaps=[];TC._appCacheBuilders.push(e);try{if(window.localStorage){for(var i=0,n=localStorage.length;i<n;i++){var r=localStorage.key(i);if(0===r.indexOf(e.LOCAL_STORAGE_KEY_PREFIX)&&r!==e.LOCAL_STORAGE_KEY_PREFIX+e.ROOT_CACHE_NAME+".hash"){var a=localStorage.getItem(r).split(" "),o=s(a.shift()),l={name:a.join(" "),extent:o,url:decodeURIComponent(r.substr(e.LOCAL_STORAGE_KEY_PREFIX.length))};e.storedMaps.push(l)}}e.storedMaps.sort(function(e,t){return e.name>t.name?1:e.name<t.name?-1:0})}}catch(t){TC.error(e.getLocaleString("couldNotAccessLocalStorage"))}var c=$.extend({},n>1?arguments[1]:arguments[0]);e._$dialogDiv=$(TC.Util.getDiv(c.dialogDiv));c.dialogDiv||e._$dialogDiv.appendTo("body");e.mapIsOffline=location.pathname.indexOf("/"+e.CACHE_REQUEST_PATH)===location.pathname.length-e.CACHE_REQUEST_PATH.length-1;e.mapIsOffline&&$(e._selectors.OFFLINEHIDDEN).addClass(TC.Consts.classes.HIDDEN);TC.Control.apply(e,arguments);e.wrap=new TC.wrap.control.CacheBuilder(e);e.isDownloading=!1;e.baseLayers=[];e.options.avgTileSize=e.options.avgTileSize||TC.Cfg.avgTileSize;e.requestSchemas=[];e.minResolution=0;e.currentMap=null;e._loadedCount=0;var u=history.pushState;history.pushState=function(t){var i;i=u.apply(history,arguments);if(e._$offlinePanelDiv){var n=location.pathname.replace("/"+e.CACHE_REQUEST_PATH,"/"),r=TC.Util.getQueryStringParams();delete r[e.MAP_DEFINITION_PARAM_NAME];delete r[e.MAP_EXTENT_PARAM_NAME];delete r[e.SERVICE_WORKER_FLAG];var s=$.param(r);s.length&&(s="?"+s);var a=n+s+location.hash;e._$offlinePanelDiv.find(e._selectors.EXIT).attr("href",a)}return i};var h=navigator.connection||navigator.mozConnection||navigator.webkitConnection||{},p=function(){if(e._$offlinePanelDiv){var t=e._$offlinePanelDiv.find(e._selectors.OFFPANEL);t.removeClass(TC.Consts.classes.CONNECTION_OFFLINE).removeClass(TC.Consts.classes.CONNECTION_MOBILE).removeClass(TC.Consts.classes.CONNECTION_WIFI);switch(h.type){case 1:case 2:case void 0:t.addClass(TC.Consts.classes.CONNECTION_WIFI);break;default:t.addClass(TC.Consts.classes.CONNECTION_MOBILE)}}};h.addEventListener&&h.addEventListener("typechange",p);window.addEventListener("online",p);window.addEventListener("offline",function(){e._$offlinePanelDiv&&e._$offlinePanelDiv.find(e._selectors.OFFPANEL).addClass(TC.Consts.classes.CONNECTION_OFFLINE).removeClass(TC.Consts.classes.CONNECTION_MOBILE).removeClass(TC.Consts.classes.CONNECTION_WIFI)})};TC.inherit(TC.control.CacheBuilder,TC.control.SWCacheClient);var r=TC.control.CacheBuilder.prototype;r.CLASS="tc-ctl-cbuild";r.MAP_DEFINITION_PARAM_NAME="map-def";r.MAP_EXTENT_PARAM_NAME="map-extent";r.LOCAL_STORAGE_KEY_PREFIX="TC.offline.map.";r.ROOT_CACHE_NAME="root";r.COOKIE_KEY_PREFIX="TC.offline.map.";r.CACHE_REQUEST_PATH="offline";r.SERVICE_WORKER_FLAG="sw";r._states={READY:"ready",EDIT:"editing",DOWNLOADING:"downloading",DELETING:"deleting"};r._actions={CREATE:"create",DELETE:"delete"};r.offlineControls=["attribution","basemapSelector","cacheBuilder","click","coordinates","draw","edit","geolocation","loadingIndicator","measure","navBar","popup","print","scale","scaleBar","scaleSelector","state","fullScreen"];TC.Consts.event.MAPCACHEDOWNLOAD=TC.Consts.event.MAPCACHEDOWNLOAD||"mapcachedownload.tc";TC.Consts.event.MAPCACHEDELETE=TC.Consts.event.MAPCACHEDELETE||"mapcachedelete.tc";TC.Consts.event.MAPCACHEPROGRESS=TC.Consts.event.MAPCACHEPROGRESS||"mapcacheprogress.tc";TC.Consts.event.MAPCACHEERROR=TC.Consts.event.MAPCACHEERROR||"mapcacheerror.tc";r.template={};if(TC.isDebug){r.template[r.CLASS]=TC.apiLocation+"TC/templates/CacheBuilder.html";r.template[r.CLASS+"-map-node"]=TC.apiLocation+"TC/templates/CacheBuilderMapNode.html";r.template[r.CLASS+"-bl-node"]=TC.apiLocation+"TC/templates/CacheBuilderBaseLayerNode.html";r.template[r.CLASS+"-dialog"]=TC.apiLocation+"TC/templates/CacheBuilderDialog.html";r.template[r.CLASS+"-off-panel"]=TC.apiLocation+"TC/templates/CacheBuilderOfflinePanel.html"}else{r.template[r.CLASS]=function(){dust.register(r.CLASS,e);function e(e,r){return e.w("<h2>").h("i18n",r,{},{$key:"offlineMaps"}).w('</h2><div class="tc-ctl-cbuild-content"><div class="tc-ctl-cbuild-draw tc-hidden"></div><i class="tc-ctl-cbuild-map-search-icon"></i><input type="search" list="').f(r.get(["listId"],!1),r,"h").w('" class="tc-ctl-cbuild-map-available-srch tc-textbox" placeholder="').h("i18n",r,{},{$key:"cb.filter.plhr"}).w('"').x(r.get(["storedMaps"],!1),r,{else:t,block:i},{}).w(' maxlength="200" /> <ul id="').f(r.get(["listId"],!1),r,"h").w('" class="tc-ctl-cbuild-list"><li class="tc-ctl-cbuild-map-available-empty"').x(r.get(["storedMaps"],!1),r,{block:n},{}).w("><span>").h("i18n",r,{},{$key:"cb.noMaps"}).w('</span></li><li class="tc-ctl-cbuild-map-not" hidden><span>').h("i18n",r,{},{$key:"noMatches"}).w("</span></li>").s(r.get(["storedMaps"],!1),r,{block:s},{}).w('</ul><div class="tc-ctl-cbuild-new"><button class="tc-button tc-icon-button tc-ctl-cbuild-btn-new" disabled title="').h("i18n",r,{},{$key:"newofflinemap"}).w('">').h("i18n",r,{},{$key:"newOfflineMap"}).w('</button></div><div class="tc-ctl-cbuild-drawing tc-hidden"><div class="tc-ctl-cbuild-tile-cmd"><button class="tc-button tc-icon-button tc-ctl-cbuild-btn-cancel-draw" title="').h("i18n",r,{},{$key:"cancel"}).w('">').h("i18n",r,{},{$key:"cancel"}).w('</button></div></div><div class="tc-ctl-cbuild-progress tc-hidden"><p>').h("i18n",r,{},{$key:"cb.DownloadingMap|s"}).w(': <span class="tc-ctl-cbuild-progress-count"></span></p><div class="tc-ctl-cbuild-progress-bar"><div class="tc-ctl-cbuild-progress-ratio" style="width:0"></div></div><button class="tc-button tc-icon-button tc-ctl-cbuild-btn-cancel-dl" title="').h("i18n",r,{},{$key:"cancel"}).w('">').h("i18n",r,{},{$key:"cancel"}).w("</button></div></div>")}e.__dustBody=!0;function t(e,t){return e.w(" disabled")}t.__dustBody=!0;function i(e,t){return e}i.__dustBody=!0;function n(e,t){return e.w(" hidden")}n.__dustBody=!0;function s(e,t){return e.p("tc-ctl-cbuild-map-node",t,t.rebase(t.getPath(!0,[])),{})}s.__dustBody=!0;return e};r.template[r.CLASS+"-map-node"]=function(){dust.register(r.CLASS+"-map-node",e);function e(e,t){return e.w('<li data-extent="').f(t.get(["extent"],!1),t,"h").w('"><span><a href="').f(t.get(["url"],!1),t,"h").w('" title="').f(t.get(["name"],!1),t,"h").w('">').f(t.get(["name"],!1),t,"h").w('</a></span><input class="tc-textbox tc-hidden" type="text" value="').f(t.get(["name"],!1),t,"h").w('" /><button class="tc-btn-save tc-hidden" title="').h("i18n",t,{},{$key:"save"}).w('"></button><button class="tc-btn-cancel tc-hidden" title="').h("i18n",t,{},{$key:"cancel"}).w('"></button><button class="tc-btn-edit" title="').h("i18n",t,{},{$key:"editMapName"}).w('">').h("i18n",t,{},{$key:"editMapName"}).w('</button><button class="tc-btn-view" title="').h("i18n",t,{},{$key:"viewMapExtent"}).w('">').h("i18n",t,{},{$key:"viewMapExtent"}).w('</button><button class="tc-btn-delete" title="').h("i18n",t,{},{$key:"deleteMap"}).w('">').h("i18n",t,{},{$key:"deleteMap"}).w("</button></li>")}e.__dustBody=!0;return e};r.template[r.CLASS+"-bl-node"]=function(){dust.register(r.CLASS+"-bl-node",e);function e(e,t){return e.w('<li class="tc-ctl-cbuild-bl-node" data-tc-layer-uid="').f(t.get(["id"],!1),t,"h").w('"><label style="background-size: 100% 100%; background-image: url(').f(t.get(["thumbnail"],!1),t,"h").w(')"><input type="checkbox" name="cbbl" value="').f(t.get(["id"],!1),t,"h").w('" disabled><span>').f(t.get(["title"],!1),t,"h").w("</span></label></li>")}e.__dustBody=!0;return e};r.template[r.CLASS+"-dialog"]=function(){dust.register(r.CLASS+"-dialog",e);function e(e,t){return e.w('<div class="tc-ctl-cbuild-dialog tc-modal"><div class="tc-modal-background tc-modal-close"></div><div class="tc-modal-window"><div class="tc-modal-header"><h3>').h("i18n",t,{},{$key:"newOfflineMap"}).w('</h3><div class="tc-ctl-popup-close tc-modal-close"></div></div><div class="tc-modal-body"><input type="text" class="tc-ctl-cbuild-txt-name" placeholder="').h("i18n",t,{},{$key:"nameRequired"}).w('" required /><div class="tc-ctl-cbuild-bl-panel"><h4>').h("i18n",t,{},{$key:"availableOfflineMaps"}).w("</h4><p>").h("i18n",t,{},{$key:"selectAtLeastOne"}).w(':</p><ul class="tc-ctl-cbuild-bl-list"></ul></div><div class="tc-ctl-cbuild-res-panel"><h4>').h("i18n",t,{},{$key:"maxRes"}).w('</h4><div class="tc-ctl-cbuild-res"></div><input type="range" class="tc-ctl-cbuild-rng-maxres" disabled value="0" title="').h("i18n",t,{},{$key:"maxRes"}).w('"></div><div class="tc-ctl-cbuild-tile-count"></div></div><div class="tc-modal-footer"><button class="tc-button tc-modal-close tc-ctl-cbuild-btn-ok" disabled>').h("i18n",t,{},{$key:"ok"}).w('</button><button type="button" class="tc-button tc-modal-close tc-ctl-cbuild-btn-cancel">').h("i18n",t,{},{$key:"cancel"}).w("</button></div></div></div>")}e.__dustBody=!0;return e};r.template[r.CLASS+"-off-panel"]=function(){dust.register(r.CLASS+"-off-panel",e);function e(e,t){return e.w('<div class="tc-ctl-cbuild-off-panel tc-conn-wifi"><span>').h("i18n",t,{},{$key:"offlineMap"}).w('</span> <a href="" class="tc-ctl-cbuild-link-exit" title="').h("i18n",t,{},{$key:"returnToOnlineMaps"}).w('"><span>').h("i18n",t,{},{$key:"returnToOnlineMaps"}).w("</span></a></div>")}e.__dustBody=!0;return e}}var s=function(e){return $.map(decodeURIComponent(e).split(","),function(e){return parseFloat(e)})},a=function(e){e._state=e._states.READY;e.showDownloadProgress(0,1);e._$div.find(e._selectors.DRAWING).addClass(TC.Consts.classes.HIDDEN);e._$div.find(e._selectors.PROGRESS).addClass(TC.Consts.classes.HIDDEN);e._$div.find(e._selectors.NEW).removeClass(TC.Consts.classes.HIDDEN);e._$div.find(e._selectors.LISTITEM).removeClass(TC.Consts.classes.DISABLED);e._$div.find(e._selectors.DELBTN).prop("disabled",!1);e._$dialogDiv.find(e._selectors.OKBTN).prop("disabled",!0);e._$div.find(e._selectors.NEWBTN).prop("disabled",!1);e._$dialogDiv.find(e._selectors.TILECOUNT).html("");e.extent=null;e._loadedCount=0;e.boxDraw&&e.boxDraw.cancel()},o=function(e,t){t.find("span").first().removeClass(TC.Consts.classes.HIDDEN);t.find(e._selectors.TEXTBOX).addClass(TC.Consts.classes.HIDDEN);t.find(e._selectors.SAVEBTN).addClass(TC.Consts.classes.HIDDEN);t.find(e._selectors.CANCELBTN).addClass(TC.Consts.classes.HIDDEN);t.find(e._selectors.EDITBTN).removeClass(TC.Consts.classes.HIDDEN);t.find(e._selectors.VIEWBTN).removeClass(TC.Consts.classes.HIDDEN);t.find(e._selectors.DELETEBTN).removeClass(TC.Consts.classes.HIDDEN)},l=function(e){return e.toString().replace(/\B(?=(\d{3})+(?!\d))/g,".")},c=function(e,t){var i,n,r,s=t||{},a=e._$dialogDiv.find(e._classSelector+"-res"),o=e._$dialogDiv.find(e._selectors.RNGMAXRES),l=e.getResolutions();if(l.length){if(e.minResolution){if(void 0===s.rangeValue)for(var c=0,u=l.length;c<u;c++)if(e.minResolution>=l[c]){o.val(c);break}}else void 0===s.rangeValue&&o.val(Math.floor(l.length/2));n=parseInt(o.attr("max",l.length-1).val());var h=Math.floor(1e3*new Number(l[n]))/1e3;i=e.getLocaleString("metersPerPixel",{value:h.toLocaleString((e.map?e.map.options.locale:TC.Cfg.locale).replace("_","-"))});r=100*(n+1)/(l.length+1)+"%";o.prop("disabled",!1);e.minResolution=l[o.val()]}else{n=0;i="";o.val(0);r="0";e.minResolution=0;o.prop("disabled",!0)}a.css("left",r).html(i)},u=function(e){e._$dialogDiv.find(e._classSelector+"-bl-node input[type=checkbox]").each(function(t,i){var n=$(i);if(n.prop("checked")){var r=e.requestSchemas.filter(function(e){return e.layerId===n.val()})[0];if(r){var s=function(e,t){for(var i=null,n=0,r=e.tileMatrixLimits.length;n<r&&!((i=e.tileMatrixLimits[n]).res<=t);n++);return i}(r,e.minResolution);if(s){var a=r.url;if(a.indexOf("{TileMatrix}")<0){var o=a.indexOf("?");o>=0&&(a=a.substr(0,o));for(var l=0,c=e.baseLayers.length;l<c;l++){var u=e.baseLayers[l];if(u.id===r.layerId){a=a+"?layer="+u.layerNames+"&style=default&tilematrixset="+u.matrixSet+"&Service=WMTS&Request=GetTile&Version=1.0.0&Format="+u.format+"&TileMatrix={TileMatrix}&TileRow={TileRow}&TileCol={TileCol}";break}}}n.parent("label").css("background-size","auto").css("background-position","left bottom").css("background-image","url("+a.replace("{TileMatrix}",s.mId).replace("{TileRow}",s.rt).replace("{TileCol}",s.cl)+")")}}}})},h=function(e,t){return t<1?e.getLocaleString("lessThan1Mb"):e.getLocaleString("approxXMb",{quantity:l(t)})},p=function(e){var t="";e.tileCount=0;for(var i=0,n=e.requestSchemas.length;i<n;i++)for(var r=e.requestSchemas[i],s=0,a=r.tileMatrixLimits.length;s<a;s++){var o=r.tileMatrixLimits[s];e.tileCount+=(o.cr-o.cl+1)*(o.rb-o.rt+1);if(o.res<e.minResolution)break}if(e.tileCount){e.estimatedMapSize=Math.round(e.tileCount*e.options.avgTileSize/1048576);t=e.getLocaleString("xTiles",{quantity:l(e.tileCount)})+" ("+h(e,e.estimatedMapSize)+")"}e._$dialogDiv.find(e._selectors.TILECOUNT).html(t)},d=function(e,t){var i=t.indexOf("#");i>=0&&(t=t.substr(0,i));return e._$div.find(e._selectors.LISTITEM).filter(function(e,i){return $(i).find("a").first().attr("href")===t})},f=function(e,t){$("<iframe>").css("display","none").attr("src",t).appendTo(e._$div)},y=function(e,t){e._$div.find('iframe[src="'+t+'"]').remove()},g=function(e,t){var i=!1;if(window.localStorage){localStorage.setItem(e.LOCAL_STORAGE_KEY_PREFIX+encodeURIComponent(t.url),t.extent+" "+t.name);i=!0}return i},C=function(e,t){var i=e.findStoredMap({url:t});if(i){(function(e,t){var i=!1;if(window.localStorage){localStorage.removeItem(e.LOCAL_STORAGE_KEY_PREFIX+encodeURIComponent(t));i=!0}return i})(e,t)&&function(e,t){return e._$div.find(e._selectors.LISTITEM).filter(function(e,i){return $(i).find("a").first().html()===t})}(e,i.name).remove();var n=$.inArray(i,e.storedMaps);e.storedMaps.splice(n,1);if(!e.storedMaps.length){e._$div.find(e._selectors.SEARCH).prop("disabled",!0);e._$div.find(e._selectors.EMPTYLIST).removeAttr("hidden")}return i.name}return null},v=function(e){e._$dialogDiv.find(e._selectors.OKBTN).prop("disabled",!e.extent||0===e._$dialogDiv.find(e._selectors.NAMETB).val().length||e._$dialogDiv.find(e._selectors.RNGMAXRES).prop("disabled"))};r.render=function(e){var t=this,i={storedMaps:t.storedMaps,listId:t.CLASS+"-list-"+TC.getUID()};t.getRenderedHtml(t.CLASS+"-dialog",null,function(e){t._$dialogDiv.html(e);t._$dialogDiv.find(t._selectors.NAMETB).on(TC.Consts.event.CLICK,function(e){e.preventDefault();this.selectionStart=0;this.selectionEnd=this.value.length;this.focus()})}).then(function(){t.renderData(i,function(){t._$dialogDiv.find(t._selectors.OKBTN).on(TC.Consts.event.CLICK,function(){var e={mapName:t._$dialogDiv.find(t._selectors.NAMETB).val()};if(t.findStoredMap({name:e.mapName}))TC.alert(t.getLocaleString("cb.mapNameAlreadyExists.error",e));else{var i=function(){t._$div.find(t._classSelector+"-name").html(e.mapName);t.map.toast(t.getLocaleString("downloadingMap",{mapName:e.mapName}));!function(e){e._state=e._states.DOWNLOADING;TC.Util.closeModal();e.showDownloadProgress(0,1);e._$div.find(e._selectors.NEW).addClass(TC.Consts.classes.HIDDEN);e._$div.find(e._selectors.DRAWING).addClass(TC.Consts.classes.HIDDEN);e._$div.find(e._selectors.PROGRESS).removeClass(TC.Consts.classes.HIDDEN);e._$dialogDiv.find(e._selectors.OKBTN).prop("disabled",!0);e._$div.find(e._selectors.NEWBTN).prop("disabled",!0);e.layer.clearFeatures();e.boxDraw.cancel()}(t);t.requestCache(e)},r=navigator.temporaryStorage||navigator.webkitTemporaryStorage||{};if(r.queryUsageAndQuota)r.queryUsageAndQuota(function(n,r){var s=(r-n)/1048576;t.estimatedMapSize<s?i():TC.confirm(t.getLocaleString("cb.mapCreation.warning.reasonSize",{mapName:e.mapName,mapSize:h(t,t.estimatedMapSize),availableStorage:h(t,Math.round(s))}),i)},function(e){TC.error(e)});else{var s=TC.Util.detectIE();if(s){var a=s<12?1e3:2e3,o=0,c=function(){var n=t.tileCount+o;n>a?TC.confirm(t.getLocaleString("cb.mapCreation.warning.reasonCount",{mapName:e.mapName,resourceCount:l(n),maxResourceCount:l(a)}),i):i()};n().done(function(e){o=e.urls.length;c()}).fail(c)}else i()}}});t._$dialogDiv.find(t._selectors.NAMETB).on("input",function(){v(t)});t._$div.find(t._selectors.NEWBTN).on(TC.Consts.event.CLICK,function(){!function(e){e._state=e._states.EDITING;e.showDownloadProgress(0,1);e._$div.find(e._selectors.NEW).addClass(TC.Consts.classes.HIDDEN);e._$div.find(e._selectors.PROGRESS).addClass(TC.Consts.classes.HIDDEN);e._$div.find(e._selectors.DRAWING).removeClass(TC.Consts.classes.HIDDEN);e.map.toast(e.getLocaleString("clickOnDownloadAreaFirstCorner"),{type:TC.Consts.msgType.INFO});e._$dialogDiv.find(e._selectors.OKBTN).prop("disabled",!0);e._$div.find(e._selectors.NEWBTN).prop("disabled",!0);e._$dialogDiv.find(e._selectors.NAMETB).val("");e.boxDraw.activate()}(t)});t._$div.find(t._classSelector+"-btn-cancel-draw").on(TC.Consts.event.CLICK,function(){a(t)});t._$div.find(t._classSelector+"-btn-cancel-dl").on(TC.Consts.event.CLICK,function(){t.cancelCacheRequest()});t._$div.find(t._selectors.LIST).on(TC.Consts.event.CLICK,t._selectors.DELETEBTN,function(e){if(navigator.onLine){$btn=$(e.target);var i=$btn.parent().find("a").html();if(i){var n=t.getLocaleString("cb.delete.confirm",{mapName:i});t.serviceWorkerEnabled||(n=n+" "+t.getLocaleString("cb.delete.confirm.connect.warning"));if(confirm(n))if(navigator.onLine){!function(e){e._state=e._states.DELETING;e.showDownloadProgress(0,1);e._$div.find(e._selectors.DRAWING).addClass(TC.Consts.classes.HIDDEN);e._$div.find(e._selectors.PROGRESS).addClass(TC.Consts.classes.HIDDEN);e._$div.find(e._selectors.NEW).removeClass(TC.Consts.classes.HIDDEN);e._$div.find(e._selectors.LISTITEM).addClass(TC.Consts.classes.DISABLED);e._$div.find(e._selectors.DELBTN).prop("disabled",!0);e._$dialogDiv.find(e._selectors.OKBTN).prop("disabled",!0);e._$div.find(e._selectors.NEWBTN).prop("disabled",!1);e._$dialogDiv.find(e._selectors.TILECOUNT).html("");e.boxDraw.cancel()}(t);t.deleteMap(i)}else TC.alert(t.getLocaleString("cb.delete.conn.alert"))}}else TC.alert(t.getLocaleString("cb.delete.conn.alert"))}).on(TC.Consts.event.CLICK,t._selectors.EDITBTN,function(e){!function(e,t){t.find("span").first().addClass(TC.Consts.classes.HIDDEN);t.find(e._selectors.TEXTBOX).removeClass(TC.Consts.classes.HIDDEN).val(t.find("span a").html()).focus();t.find(e._selectors.SAVEBTN).removeClass(TC.Consts.classes.HIDDEN);t.find(e._selectors.CANCELBTN).removeClass(TC.Consts.classes.HIDDEN);t.find(e._selectors.EDITBTN).addClass(TC.Consts.classes.HIDDEN);t.find(e._selectors.VIEWBTN).addClass(TC.Consts.classes.HIDDEN);t.find(e._selectors.DELETEBTN).addClass(TC.Consts.classes.HIDDEN)}(t,$(e.target).parent())}).on(TC.Consts.event.CLICK,t._selectors.CANCELBTN,function(e){var i=$(e.target).parent();i.find(t._selectors.TEXTBOX).val(i.find("a").html());o(t,$(e.target).parent())}).on(TC.Consts.event.CLICK,t._selectors.SAVEBTN,function(e){var i=$(e.target).parent();o(t,i);var n=i.find("a"),r=(n.html(),i.find(t._selectors.TEXTBOX).val()),s=t.findStoredMap({url:n.attr("href")});if(s){s.name=r;n.html(r);n.attr("title",r);g(t,s)}}).on(TC.Consts.event.CLICK,t._selectors.VIEWBTN,function(e){$btn=$(e.target);var i=!$btn.hasClass(TC.Consts.classes.ACTIVE);t._$div.find(t._selectors.VIEWBTN).removeClass(TC.Consts.classes.ACTIVE).parent().removeClass(TC.Consts.classes.ACTIVE);var n=$btn.parent().find("a").html();if(n){var r=t.findStoredMap({name:n});if(r){var a=s(r.extent);t.layer.clearFeatures();if(i){t.layer.addPolygon([[[a[0],a[1]],[a[0],a[3]],[a[2],a[3]],[a[2],a[1]]]],{showsPopup:!1}).then(function(){t.layer.map.zoomToFeatures(t.layer.features)});$btn.addClass(TC.Consts.classes.ACTIVE);$btn.parent().addClass(TC.Consts.classes.ACTIVE);$btn.attr("title",t.getLocaleString("removeMapExtent"))}}}});var i=function(e){e=e.toLowerCase();var i=t._$div.find(t._selectors.LISTITEM).hide(),n=i.filter("li:not([class]),li."+TC.Consts.classes.ACTIVE);if(0===e.length){n.show();t._$div.find(t._classSelector+"-map-search-icon").css("visibility","visible")}else{t._$div.find(t._classSelector+"-map-search-icon").css("visibility","hidden");var r=new RegExp(e,"i");n.each(function(){var e=$(this);e.toggle(r.test(e.find("a").text()))});0===n.filter(":visible").length&&i.filter('[class^="tc-ctl-cbuild-map-not"]').show()}},r=t._$div.find(t._selectors.SEARCH);r.on("keyup search",function(){i($(this).val().toLowerCase().trim())});try{if(r.has($("::-ms-clear"))){r.on("mouseup",function(e){""!==r.val()&&setTimeout(function(){var e=r.val();""===e&&i(e)},1)})}}catch(e){}t._$dialogDiv.find(t._selectors.BLLIST).on("change","input[type=checkbox]",function(e){t.baseLayers.length=0;t._$dialogDiv.find(t._selectors.BLLIST+" input[type=checkbox]").each(function(e,i){var n=$(i);if(n.prop("checked"))for(var r=n.val(),s=0,a=t.map.baseLayers.length;s<a;s++){var o=t.map.baseLayers[s];if(o.id===r&&o.type===TC.Consts.layerType.WMTS){t.baseLayers[t.baseLayers.length]=o;break}}});t.updateRequestSchemas();c(t);u(t);v(t);p(t)});t._$dialogDiv.find(t._selectors.RNGMAXRES).on("input change",function(e){c(t,{rangeValue:$(e.target).val()});u(t);p(t)});TC.Util.getQueryStringParams();d(t,location.href).addClass(TC.Consts.classes.ACTIVE);$.isFunction(e)&&e()})});window.addEventListener("beforeunload",function(e){if(t.isDownloading){var i=t.getLocaleString("cb.mapDownloading.warning");e.returnValue=i;return i}},!0)};r.register=function(e){var t=this;TC.control.SWCacheClient.prototype.register.call(t,e);if(navigator.serviceWorker){navigator.serviceWorker.addEventListener("message",function(e){switch(e.data.event){case"progress":t.$events.trigger($.Event(TC.Consts.event.MAPCACHEPROGRESS,{url:e.data.name,loaded:e.data.count,total:e.data.total}));break;case"cached":t.$events.trigger($.Event(TC.Consts.event.MAPCACHEDOWNLOAD,{url:e.data.name}));break;case"deleted":t.$events.trigger($.Event(TC.Consts.event.MAPCACHEDELETE,{url:e.data.name}));break;case"error":e.data.action===t._actions.CREATE&&TC.error(t.getLocaleString("cb.resourceDownload.error",{url:e.data.url}))}});n().then(function(e){const i=t.LOCAL_STORAGE_KEY_PREFIX+t.ROOT_CACHE_NAME+".hash";var n;window.localStorage&&(n=localStorage.getItem(i));if(n!==e.hash){t.cacheUrlList(e.urls);t.one(TC.Consts.event.MAPCACHEDOWNLOAD,function(){window.localStorage&&localStorage.setItem(i,e.hash)})}})}if(t.mapIsOffline){e._$div.addClass(TC.Consts.classes.OFFLINE);t._$offlinePanelDiv=$(TC.Util.getDiv(t.options.offlinePanelDiv));t.options.offlinePanelDiv||t._$offlinePanelDiv.appendTo(e._$div);t.getRenderedHtml(t.CLASS+"-off-panel",null,function(e){t._$offlinePanelDiv.html(e);navigator.onLine||t._$offlinePanelDiv.find(t._selectors.OFFPANEL).addClass(TC.Consts.classes.CONNECTION_OFFLINE).removeClass(TC.Consts.classes.CONNECTION_MOBILE).removeClass(TC.Consts.classes.CONNECTION_WIFI);t._$offlinePanelDiv.find(t._selectors.EXIT).on(TC.Consts.event.CLICK,function(e){TC.confirm(t.getLocaleString("offlineMapExit.confirm"),null,function(){e.preventDefault()})})})}const i=t.getUID(),r=t.getUID();t.layer=null;$.when(t.renderPromise(),e.addControl("draw",{id:i,div:t._$div.find(t._selectors.DRAW),mode:TC.Consts.geom.RECTANGLE,persistent:!1}),e.addLayer({id:r,type:TC.Consts.layerType.VECTOR,stealth:!0,styles:{line:e.options.styles.line}})).then(function(i,n,r){t.boxDraw=n;t.layer=r;n.setLayer(r);n.$events.on(TC.Consts.event.DRAWSTART,function(e){t.map.toast(t.getLocaleString("clickOnDownloadAreaOppositeCorner"),{type:TC.Consts.msgType.INFO})}).on(TC.Consts.event.DRAWEND,function(e){var i=e.feature.geometry[0],n=i[0],r=i[2],s=Math.min(n[0],r[0]),a=Math.max(n[0],r[0]),o=Math.min(n[1],r[1]),l=Math.max(n[1],r[1]);t.setExtent([s,o,a,l]);var c,h=t._$dialogDiv.find("input[type=checkbox]");h.each(function(e,i){for(var n=0,r=t.map.baseLayers.length;n<r;n++){var s=t.map.baseLayers[n];if(i.value===s.id){var a=$(i),o=a.parents("li").first(),l=s.getResolutions(),c=t.wrap.getRequestSchemas({extent:t.extent,layers:[s]})[0].tileMatrixLimits;if(c.length&&l[l.length-1]==c[c.length-1].res)o.removeClass(TC.Consts.classes.HIDDEN);else{a.prop("checked",!1);o.addClass(TC.Consts.classes.HIDDEN)}break}}});c=t._$dialogDiv.find(t._selectors.BLLISTITEM).filter(":not(."+TC.Consts.classes.HIDDEN+")").length?"selectAtLeastOne":"cb.noMapsAtSelectedExtent";t._$dialogDiv.find(t._selectors.BLLISTTEXT).html(t.getLocaleString(c));u(t);p(t);TC.Util.showModal(t._$dialogDiv.find(t._classSelector+"-dialog"),{openCallback:function(){h.prop("disabled",!1);var e;if(Date.prototype.toLocaleString){var i={};i.year=i.month=i.day=i.hour=i.minute=i.second="numeric";e=(new Date).toLocaleString(t.map.options.locale.replace("_","-"),i)}else e=(new Date).toString();t._$dialogDiv.find(t._selectors.NAMETB).val(e)[0];v(t)},closeCallback:function(){h.prop("disabled",!0);t.layer.clearFeatures()}})});e.on(TC.Consts.event.CONTROLDEACTIVATE,function(e){n===e.control&&t._state===t._states.EDITING&&a(t)})});var o=function(e){var i=!1,n=t._$dialogDiv.find(t._selectors.BLLIST),r=function(){return n.find('li[data-tc-layer-uid="'+e.id+'"]').length>0},s=e.type===TC.Consts.layerType.WMTS&&!e.mustReproject;TC.Util.detectSafari()&&TC.Util.detectIOS()&&(s=s&&TC.Util.isSameOrigin(e.url));if(s&&!r()){i=!0;t.getRenderedHtml(t.CLASS+"-bl-node",e,function(e){r()||n.append(e)})}return i};e.on(TC.Consts.event.LAYERADD,function(e){o(e.layer)}).on(TC.Consts.event.LAYERREMOVE,function(e){e.layer.type===TC.Consts.layerType.WMTS&&t._$dialogDiv.find(t._selectors.BLLIST).find('li[data-tc-layer-uid="'+e.layer.id+'"]').remove()});var l=TC.Util.getQueryStringParams(),c=l[t.MAP_DEFINITION_PARAM_NAME],h=l[t.MAP_EXTENT_PARAM_NAME];e.ready(function(){if(t.mapIsOffline){for(var i=[],n=0,r=t.offlineControls.length;n<r;n++){var s=t.offlineControls[n];s=s.substr(0,1).toUpperCase()+s.substr(1);i=i.concat(e.getControlsByClass("TC.control."+s))}for(n=0,r=e.controls.length;n<r;n++){var a=e.controls[n];i.indexOf(a)<0&&a.disable()}$(t._selectors.OFFLINEHIDDEN).addClass(TC.Consts.classes.HIDDEN)}});e.loaded(function(){e.putLayerOnTop(t.layer);t._firstRender.then(function(){t._$div.find(t._selectors.NEWBTN).prop("disabled",!1);for(var i=0,n=e.baseLayers.length;i<n;i++)o(e.baseLayers[i])});if(t.mapIsOffline){var i=JSON.parse(window.atob(decodeURIComponent(c))),n=[],r=$.grep(e.baseLayers,function(e){var t=!1;if(e.type===TC.Consts.layerType.WMTS)for(var r=0,s=i.layers.length;r<s;r++){var a=i.layers[r];if((0===e.url.indexOf("//")?location.protocol+e.url:e.url)===i.url[a.urlIdx]&&e.layerNames===a.id&&e.matrixSet===i.tms[a.tmsIdx]){t=!0;break}}t||e.type!==TC.Consts.layerType.VECTOR&&(n[n.length]=e);return t})[0];r&&e.setBaseLayer(r);for(var a=0,l=n.length;a<l;a++)e.removeLayer(n[a]);e.setExtent(s(h))}});t.$events.on(TC.Consts.event.MAPCACHEDOWNLOAD,function(i){t.isDownloading=!1;var n=function(e){var t=e.indexOf("#");return t>=0?e.substr(0,t):e}(i.url),r=d(t,n);if(r.length&&!t.serviceWorkerEnabled){r.removeClass(TC.Consts.classes.DISABLED);r.find(t._selectors.DELBTN).prop("disabled",!1);TC.alert(t.getLocaleString("cb.delete.error"))}else if(t.currentMap&&n===t.currentMap.url){!function(e){var t=e.currentMap;if(g(e,t)){e.getRenderedHtml(e.CLASS+"-map-node",{name:t.name,url:t.url},function(t){e._$div.find(e._selectors.LIST).append(t);e._$div.find(e._selectors.EMPTYLIST).attr("hidden","hidden");e._$div.find(e._selectors.SEARCH).prop("disabled",!1)});e.storedMaps.push(t)}}(t);e.toast(t.getLocaleString("mapDownloaded",{mapName:t.currentMap.name}))}t.currentMap=null;y(t,i.url);a(t)}).on(TC.Consts.event.MAPCACHEDELETE,function(i){t.isDownloading=!1;var n=C(t,i.url)||t.currentMap&&t.currentMap.name;y(t,i.url);t.currentMap=null;if(n){document.cookie=t.COOKIE_KEY_PREFIX+"delete=; expires=Thu, 01 Jan 1970 00:00:01 GMT;";e.toast(t.getLocaleString("mapDeleted",{mapName:n}))}a(t)}).on(TC.Consts.event.MAPCACHEPROGRESS,function(e){var i=e.total;!i&&t.requestSchemas&&(i=t.requestSchemas[0].tileCount);var n=e.loaded;if(n)t._loadedCount=n;else{t._loadedCount+=1;n=t._loadedCount}t.showDownloadProgress(n,i)}).on(TC.Consts.event.MAPCACHEERROR,function(e){t.isDownloading=!1;y(t,e.url);a(t);var i=t.getLocaleString("cb.mapCreation.error"),n=!0;switch(e.reason){case"quota":i+=". "+t.getLocaleString("cb.mapCreation.error.reasonQuota");break;case"resource":i+=". "+t.getLocaleString("cb.mapCreation.error.reasonResource");break;case"manifest":"410"==e.status&&C(t,e.url);n=!1;break;case"already_exists":i+=". "+t.getLocaleString("cb.mapCreation.error.reasonAlreadyExists")}if(n)if(TC.Util.detectIE()){TC.error(i);TC.alert(t.getLocaleString("cb.mapCreation.error.reasonIE"))}else TC.alert(i);t.currentMap=null})};r.setExtent=function(e){if($.isArray(e)&&e.length>=4){this.extent=e;this.updateRequestSchemas()}};r.cacheUrlList=function(e,t){var i=t||{};this.createCache(i.name||this.LOCAL_STORAGE_KEY_PREFIX+this.ROOT_CACHE_NAME,{urlList:e,silent:i.silent})};r.requestCache=function(e){var t=this,i=e||{};if(t.map){var n=i.extent||t.extent||t.map.getExtent();t.updateRequestSchemas({extent:n});if(t.requestSchemas){for(var r=function(e,i,n){var r=e.res>=t.minResolution;!r&&i>0&&(r=n[i-1].res>t.minResolution);return r},s=function(e){return{mId:e.mId,cl:e.cl,cr:e.cr,rt:e.rt,rb:e.rb}},a=t.requestSchemas.map(function(e){return{layerId:e.layerId,tileMatrixLimits:e.tileMatrixLimits.filter(r)}}),o=[Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY],l=0,c=a.length;l<c;l++){var u=a[l],h=(N=u.tileMatrixLimits[u.tileMatrixLimits.length-1]).res*N.tSize;o[0]=Math.min(o[0],N.origin[0]+h*N.cl);o[1]=Math.min(o[1],N.origin[1]-h*(N.rb+1));o[2]=Math.max(o[2],N.origin[0]+h*(N.cr+1));o[3]=Math.max(o[3],N.origin[1]-h*N.rt);u.tileMatrixLimits=u.tileMatrixLimits.map(s)}var p=Math.pow(10,t.map.wrap.isGeo()?TC.Consts.DEGREE_PRECISION:TC.Consts.METER_PRECISION),d={bBox:o=o.map(function(e,t){return(t<3?Math.ceil:Math.floor)(e*p)/p}),res:Math.floor(1e3*t.minResolution)/1e3,url:[],tms:[],format:[],layers:new Array(t.baseLayers.length)};for(l=0,c=t.baseLayers.length;l<c;l++){var y=t.baseLayers[l],g=0===y.url.indexOf("//")?location.protocol+y.url:y.url,C=$.inArray(g,d.url);C<0&&(C=d.url.push(g)-1);var v=$.inArray(y.matrixSet,d.tms);v<0&&(v=d.tms.push(y.matrixSet)-1);var T=y.format.substr(y.format.indexOf("/")+1),L=$.inArray(T,d.format);L<0&&(L=d.format.push(T)-1);d.layers[l]={urlIdx:C,id:y.layerNames,tmsIdx:v,formatIdx:L}}var w=TC.Util.getQueryStringParams(),b=w[t.MAP_EXTENT_PARAM_NAME]=o.toString();w[t.MAP_DEFINITION_PARAM_NAME]=btoa(JSON.stringify(d));t.serviceWorkerEnabled&&(w[t.SERVICE_WORKER_FLAG]=1);var S=location.origin+location.pathname.substr(0,location.pathname.lastIndexOf("/")+1)+t.CACHE_REQUEST_PATH+"?"+$.param(w);t.currentMap={name:i.mapName,extent:b,url:S};t.isDownloading=!0;if(t.serviceWorkerEnabled)for(l=0,c=a.length;l<c;l++){for(var E=a[l],O=null,A=0,x=t.baseLayers.length;A<x;A++){var P=t.baseLayers[A];if(P.id===E.layerId){O=t.wrap.getGetTilePattern(P);break}}if(O){urlList=[];var _=0;for(k=0,lenk=E.tileMatrixLimits.length;k<lenk;k++){var N;for(P=(N=E.tileMatrixLimits[k]).cl;P<=N.cr;P++)for(m=N.rt;m<=N.rb;m++)urlList[_++]=O.replace("{TileMatrix}",N.mId).replace("{TileCol}",P).replace("{TileRow}",m)}urlList.push(S);t.cacheUrlList(urlList,{name:S})}}else f(t,S)}}};r.cancelCacheRequest=function(){var e=this;if(e.currentMap){y(e,e.currentMap.url);e.deleteCache(e.currentMap.url).then(function(t){t||(e.currentMap=null)})}e.isDownloading=!1;a(e)};r.deleteMap=function(e){var t=this,i=t.findStoredMap({name:e});if(i){var n=TC.Util.getQueryStringParams(i.url);t.deleteCache(i.url).then(function(e){if(!e){document.cookie=t.COOKIE_KEY_PREFIX+"delete="+atob(decodeURIComponent(n[t.MAP_DEFINITION_PARAM_NAME]));f(t,i.url)}})}};r.findStoredMap=function(e){return $.grep(this.storedMaps,function(t){var i=!0;e.name&&e.name!==t.name&&(i=!1);i&&e.url&&e.url!==t.url&&(i=!1);return i})[0]};r.showDownloadProgress=function(e,t){var i=this._classSelector,n=this._$div.find(i+"-progress-count");if(t){var r=Math.min(Math.round(100*e/t),100)+"%";this._$div.find(i+"-progress-ratio").css("width",r);n.html(r)}else{this._$div.find(i+"-progress-bar").addClass(TC.Consts.classes.HIDDEN);n.html(this.getLocaleString("xFiles",{quantity:e}))}};r.updateRequestSchemas=function(e){var t=e||{};t.extent=t.extent||this.extent;t.layers=t.layers||this.baseLayers;this.requestSchemas=this.wrap.getRequestSchemas(t);return this.requestSchemas};r.getResolutions=function(){for(var e=[],t=function(e){return e.res},i=this.requestSchemas.map(function(e){return e.tileMatrixLimits.map(t)}),n=Number.POSITIVE_INFINITY,r=0,s=0,a=i.length;s<a;s++){var o=i[s];n=Math.min(n,o[0]);r=Math.max(r,o[o.length-1])}for(s=0,a=i.length;s<a;s++)e=e.concat(i[s].filter(function(t){return t<=n&&t>=r&&e.indexOf(t)<0}));e.sort(function(e,t){return t-e});return e}}();TC.control=TC.control||{};TC.control.ProjectionSelector||TC.syncLoadJS(TC.apiLocation+"TC/control/ProjectionSelector");!function(){TC.control.Coordinates=function(e){e=e||{};this.crs="";this.xy=[0,0,0];this.latLon=[0,0,0];this.x=0;this.y=0;this.lat=0;this.lon=0;this.units="m";this.isGeo=!1;TC.control.ProjectionSelector.apply(this,arguments);$.extend(this._cssClasses,{CRS:this.CLASS+"-crs",GEOCRS:this.CLASS+"-geocrs",X:this.CLASS+"-x",Y:this.CLASS+"-y",LAT:this.CLASS+"-lat",LON:this.CLASS+"-lon",ELEVATION:this.CLASS+"-elevation"});this.geoCrs=this.options.geoCrs||TC.Cfg.geoCrs;this.wrap=new TC.wrap.control.Coordinates(this)};TC.inherit(TC.control.Coordinates,TC.control.ProjectionSelector);var e=TC.control.Coordinates.prototype;e.CLASS="tc-ctl-coords";var t;e.template={};if(TC.isDebug){e.template[e.CLASS]=TC.apiLocation+"TC/templates/Coordinates.html";e.template[e.CLASS+"-dialog"]=TC.apiLocation+"TC/templates/CoordinatesDialog.html"}else{e.template[e.CLASS]=function(){dust.register(e.CLASS,t);function t(e,t){return e.w('<div>CRS: <span class="tc-ctl-coords-crs">').f(t.get(["crs"],!1),t,"h").w('</span><button class="tc-ctl-coords-crs" title="').h("i18n",t,{},{$key:"changeCRS"}).w('">').f(t.get(["crs"],!1),t,"h").w('</button></div><div class="tc-ctl-coords-xy">').x(t.get(["isGeo"],!1),t,{else:i,block:r},{}).w("</div>").x(t.get(["showGeo"],!1),t,{block:a},{}).w('<span class="close"></span>')}t.__dustBody=!0;function i(e,t){return e.w('x: <span class="tc-ctl-coords-x">').f(t.get(["x"],!1),t,"h").w('</span> y: <span class="tc-ctl-coords-y">').f(t.get(["y"],!1),t,"h").w("</span> ").x(t.get(["ele"],!1),t,{block:n},{})}i.__dustBody=!0;function n(e,t){return e.w(' z: <span class="tc-ctl-coords-elevation">').f(t.get(["ele"],!1),t,"h").w("</span> ")}n.__dustBody=!0;function r(e,t){return e.h("i18n",t,{},{$key:"lat"}).w(': <span class="tc-ctl-coords-lat">').f(t.get(["lat"],!1),t,"h").w("</span> ").h("i18n",t,{},{$key:"lon"}).w(': <span class="tc-ctl-coords-lon">').f(t.get(["lon"],!1),t,"h").w("</span> ").x(t.get(["ele"],!1),t,{block:s},{})}r.__dustBody=!0;function s(e,t){return e.w(" ").h("i18n",t,{},{$key:"ele"}).w(': <span class="tc-ctl-coords-elevation">').f(t.get(["ele"],!1),t,"h").w("</span> ")}s.__dustBody=!0;function a(e,t){return e.w('<div class="tc-ctl-coords-alt">CRS: <span class="tc-ctl-coords-geocrs">').f(t.get(["geoCrs"],!1),t,"h").w('</span></div><div class="tc-ctl-coords-xy">').h("i18n",t,{},{$key:"lat"}).w(': <span class="tc-ctl-coords-lat">').f(t.get(["lat"],!1),t,"h").w("</span> ").h("i18n",t,{},{$key:"lon"}).w(': <span class="tc-ctl-coords-lon">').f(t.get(["lon"],!1),t,"h").w("</span> ").x(t.get(["ele"],!1),t,{block:o},{}).w(" </div>")}a.__dustBody=!0;function o(e,t){return e.w(" ").h("i18n",t,{},{$key:"ele"}).w(': <span class="tc-ctl-coords-elevation">').f(t.get(["ele"],!1),t,"h").w("</span> ")}o.__dustBody=!0;return t};e.template[e.CLASS+"-dialog"]=function(){dust.register(e.CLASS+"-dialog",t);function t(e,t){return e.w('<div class="tc-ctl-coords-crs-dialog tc-modal"><div class="tc-modal-background tc-modal-close"></div><div class="tc-modal-window"><div class="tc-modal-header"><h3>').h("i18n",t,{},{$key:"changeCRS"}).w('</h3><div class="tc-ctl-popup-close tc-modal-close"></div></div><div class="tc-modal-body"><p>').h("i18n",t,{},{$key:"coords.currentProjection|h"}).w('</p><p class="tc-ctl-coords-no-change">').h("i18n",t,{},{$key:"coords.noCrs.warning|s"}).w('</p><div class="tc-ctl-coords-change"><p>').h("i18n",t,{},{$key:"coords.instructions|s"}).w('</p><p class="tc-msg-warning tc-hidden">').h("i18n",t,{},{$key:"coords.instructions.warning|s"}).w('</p></div><ul class="tc-ctl-coords-crs-list tc-crs-list"></ul></div><div class="tc-modal-footer"><button type="button" class="tc-button tc-modal-close">').h("i18n",t,{},{$key:"close"}).w("</button></div></div></div>")}t.__dustBody=!0;return t}}e.register=function(e){var t=this;TC.control.ProjectionSelector.prototype.register.call(t,e);t.crs=t.map.crs;t.clear();e.loaded(function(){t.wrap.register(e).then(function(){t.render(function(){t.clear()})});if(TC.Util.detectMobile()){t.getLayer();t.activateCoords()}e.on(TC.Consts.event.PROJECTIONCHANGE,function(i){t.isGeo=e.wrap.isGeo();t.crs=i.crs;t.render()});$.when(t.map.wrap.getViewport()).then(function(e){$(e).on(TC.Consts.event.MOUSEMOVE+".coords",function(e){t.onMouseMove(e)}).on(TC.Consts.event.MOUSELEAVE+".coords",function(e){t.onMouseLeave(e)})})})};e.render=function(e){var t=this;t.getRenderedHtml(t.CLASS+"-dialog",null,function(e){t._$dialogDiv.html(e)}).then(function(){TC.Control.prototype.renderData.call(t,{x:t.x,y:t.y,lat:t.lat,lon:t.lon,ele:t.isGeo&&t.latLon.length>2?t.latLon[2]:!t.isGeo&&t.xy.length>2?t.xy[2]:null,crs:t.crs,geoCrs:t.geoCrs,isGeo:t.isGeo,showGeo:!t.isGeo&&t.options.showGeo},function(){t.$crs=t._$div.find("."+t._cssClasses.CRS);t.$geoCrs=t._$div.find("."+t._cssClasses.GEOCRS);t.$x=t._$div.find("."+t._cssClasses.X);t.$y=t._$div.find("."+t._cssClasses.Y);t.$lat=t._$div.find("."+t._cssClasses.LAT);t.$lon=t._$div.find("."+t._cssClasses.LON);t.$ele=t._$div.find("."+t._cssClasses.ELEVATION);t.$crs.filter("button").on(TC.Consts.event.CLICK,function(e){t.showProjectionChangeDialog()});$.isFunction(e)&&e()})})};e.onMouseMove=function(e){this.wrap.onMouseMove(e)};e.onMouseLeave=function(e){var t=this;setTimeout(function(){t.div.getBoundingClientRect();if(!t.isPointerOver(e)){t._$div.css("visibility","hidden");t.clear()}},200)};e.isPointerOver=function(e){var t=this.div.getBoundingClientRect();return t.left<=e.clientX&&t.left+t.width>=e.clientX&&t.top<=e.clientY&&t.top+t.height>=e.clientY};e.formatCoord=function(e,t){var i;i=e.toFixed(t);t<=3&&(i=i.replace(/\B(?=(\d{3})+(?!\d))/g,"|"));return i=i.replace(".",",").replace(/\|/g,".")};e.update=function(){var e=this;!e.isGeo&&e.options.showGeo&&(e.latLon=TC.Util.reproject(e.xy,e.crs,e.geoCrs).reverse());if(!e.isGeo){e.x=e.formatCoord(e.xy[0],TC.Consts.METER_PRECISION);e.y=e.formatCoord(e.xy[1],TC.Consts.METER_PRECISION)}if(e.isGeo||e.options.showGeo){e.lat=e.formatCoord(e.latLon[0],TC.Consts.DEGREE_PRECISION);e.lon=e.formatCoord(e.latLon[1],TC.Consts.DEGREE_PRECISION)}e.render(function(){if(TC.Util.detectMobile()){e._$div.find("span.close").click(function(){e._$div.toggleClass(TC.Consts.classes.HIDDEN,!0);e.clear()});e._$div.find("span.close").show()}else{e._$div.removeClass(TC.Consts.classes.HIDDEN);e._$div.css("visibility","visible");e._$div.find("span.close").hide()}})};e.clear=function(){this._$div.addClass(TC.Consts.classes.HIDDEN);this._$div.css("visibility","hidden");delete this.currentCoordsMarker;this.getLayer().then(function(e){e.clearFeatures()})};e.deactivateCoords=function(){this._$div.toggleClass(TC.Consts.classes.HIDDEN,!0);this.clear();this.wrap.coordsDeactivate()};e.activateCoords=function(){this.wrap.coordsActivate()};e.getCoords=function(){var e=this.map.getControlsByClass(TC.control.Popup);if(e&&e.length>0&&e[0].isVisible())this.coordsToPopup(e[0]);else{this.updateCoordsCtrl([(this.map.getExtent()[0]+this.map.getExtent()[2])/2,(this.map.getExtent()[1]+this.map.getExtent()[3])/2]);this.coordsToClick.call(this,{coordinate:this.xy})}};e.coordsToPopup=function(e){e&&this.updateCoordsCtrl(e.wrap.popup.getPosition())};e.updateCoordsCtrl=function(e){if(e){if(!this.isGeo){this.x=e[0];this.y=e[1];this.xy=[this.x,this.y];e.length>2&&this.xy.push(e[2])}if(this.isGeo||this.options.showGeo){this.lat=e[0];this.lon=e[1];this.latLon=[this.lat,this.lon];e.length>2&&this.latLon.push(e[2])}this.update()}};e.coordsToClick=function(e){var i=this;if(!$(i.map._$div).hasClass("tc-ctl-sv-active "+TC.Consts.classes.COLLAPSED)){var n=i._$div[0].getBoundingClientRect();if(n.left<=e.clientX&&e.clientX<=n.right&&n.top<=e.clientY&&e.clientY<=n.bottom){i._$div.toggleClass(TC.Consts.classes.HIDDEN,!0);i.clear();return}$(i._$div).stop(!0,!0);t&&clearTimeout(t);i.updateCoordsCtrl(e.coordinate);i.coordsMarkerAdd(e.coordinate,e.cssClass);i._$div.removeClass(TC.Consts.classes.HIDDEN);i._$div.css("visibility","visible");$(i._$div).css({opacity:.7});t=setTimeout(function(){$(i._$div).animate({opacity:0},3e3,"linear",function(){i.clear()})},5e3)}};e.coordsMarkerAdd=function(e,t){var i=this;i.currentCoordsMarker?i.currentCoordsMarker.setCoords(e):i.getLayer().then(function(n){$.when(n.addMarker(e,{title:"Coord",showsPopup:!1,cssClass:t||TC.Consts.classes.POINT,anchor:[.5,.5]})).then(function(e){i.currentCoordsMarker=e})})};e.getLayer=function(){var e=this,t=new $.Deferred;void 0==e.layer?e.map.addLayer({id:e.getUID(),type:TC.Consts.layerType.VECTOR,stealth:!0,title:"Coordenadas"}).then(function(i){e.layer=i;e.layer.map.putLayerOnTop(e.layer);t.resolve(e.layer)}):t.resolve(e.layer);return t}}();TC.control=TC.control||{};TC.control.TabContainer||TC.syncLoadJS(TC.apiLocation+"TC/control/TabContainer");TC.control.DataLoader=function(){TC.control.TabContainer.apply(this,arguments);this.controlOptions=[{name:"externalWMS",title:"addWMS",options:{suggestions:this.options.wmsSuggestions}},{name:"fileImport",options:{enableDragAndDrop:this.options.enableDragAndDrop}}];this._ctlDeferreds.length=2;this._ctlDeferreds[0]=$.Deferred();this._ctlDeferreds[1]=$.Deferred();this.defaultSelection=0};TC.inherit(TC.control.DataLoader,TC.control.TabContainer);TC.control.DataLoader.prototype.register=function(e){this.title=this.getLocaleString("addMaps");TC.control.TabContainer.prototype.register.call(this,e)};TC.control=TC.control||{};TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control");TC.filter||TC.syncLoadJS(TC.apiLocation+"TC/Filter");TC.control.Download=function(e){this._classSelector="."+this.CLASS;TC.Control.apply(this,arguments);var t=e||{};this._$dialogDiv=$(TC.Util.getDiv(t.dialogDiv));t.dialogDiv||this._$dialogDiv.appendTo("body")};TC.inherit(TC.control.Download,TC.Control);!function(){var e=TC.control.Download.prototype;e.CLASS="tc-ctl-download";e.template={};if(TC.isDebug){e.template[e.CLASS]=TC.apiLocation+"TC/templates/Download.html";e.template[e.CLASS+"-dialog"]=TC.apiLocation+"TC/templates/DownloadDialog.html"}else{e.template[e.CLASS]=function(){dust.register(e.CLASS,t);function t(e,t){return e.w("<h2>").h("i18n",t,{},{$key:"download"}).w(' </h2><div class="tc-ctl-tctr tc-ctl-tctr-select"><form><label class="tc-ctl-tctr-tab tc-ctl-download-image" style="width:calc(100%/2 - 1px)"><input type="radio" name="sctnr-sel" value="image" /><span>').h("i18n",t,{},{$key:"dl.export.map"}).w('</span></label><label class="tc-ctl-tctr-tab tc-ctl-download-data" style="width:calc(100%/2 - 1px)"><input type="radio" name="sctnr-sel" value="data" /><span>').h("i18n",t,{},{$key:"dl.export.vector"}).w('</span></label></form></div><div class="tc-ctl tc-ctl-tctr-elm tc-ctl-tctr-elm-image tc-group tc-ctl-download-cnt tc-ctl-download-image tc-hidden"><label>').h("i18n",t,{},{$key:"format"}).w(':</label><select id="download-format-image" class="tc-combo"><option value="image/png">PNG</option><option value="image/jpeg">JPEG</option></select><div class="tc-ctl-download-div"><input id="tc-ctl-download-image-qr" class="tc-hidden" type="checkbox" checked style="display:none;" /><label for="tc-ctl-download-image-qr" class="tc-ctl-download-image-qr-label" title="').h("i18n",t,{},{$key:"createQrCodeToImage"}).w('">').h("i18n",t,{},{$key:"appendQRCode"}).w('</label></div><div class="tc-group tc-group tc-ctl-download-cnt" style="text-align:right;"><button type="button" class="tc-ctl-download-btn tc-button tc-icon-button" title="').h("i18n",t,{},{$key:"downloadImageFromCurrentMap"}).w('" name="descargar">').h("i18n",t,{},{$key:"download"}).w('</button></div></div><div class="tc-ctl tc-ctl-tctr-elm tc-ctl-tctr-elm-data tc-group tc-ctl-download-cnt tc-hidden"><label>').h("i18n",t,{},{$key:"format"}).w(':</label><select id="download-format" class="tc-combo"><option value="GML32">GML</option><option value="application/json">GeoJSON</option><option value="application/vnd.google-earth.kml+xml">KML (Google Earth)</option><option value="shape-zip">Shape (ESRI)</option></select><div class="tc-ctl-download-div"><i class="tc-ctl-download-help icon-question-sign" data-toggle="tooltip" data-placement="top" title="').h("i18n",t,{},{$key:"showDownloadHelp"}).w('"></i></div><div class="tc-group tc-group tc-ctl-download-cnt" style="text-align:right;"><button type="button" class="tc-ctl-download-btn tc-button tc-icon-button" title="').h("i18n",t,{},{$key:"downloadLayersFromCurrentExtent"}).w('" name="descargar">').h("i18n",t,{},{$key:"download"}).w('</button></div><div class="tc-alert alert-warning tc-hidden"><p id="zoom-msg"><strong>').h("i18n",t,{},{$key:"tooManyFeatures"}).w(": </strong>").h("i18n",t,{},{$key:"tooManyFeatures.instructions"}).w('</p><p id="layers-msg"><strong>').h("i18n",t,{},{$key:"noLayersLoaded"}).w(": </strong>").h("i18n",t,{},{$key:"noLayersLoaded.instructions"}).w('</p><p id="url-msg"><strong>').h("i18n",t,{},{$key:"tooManySelectedLayers"}).w(": </strong>").h("i18n",t,{},{$key:"tooManySelectedLayers.instructions"}).w('</p><p id="noFeatures-msg"><strong>').h("i18n",t,{},{$key:"noData"}).w(": </strong>").h("i18n",t,{},{$key:"noData.instructions"}).w('</p><p id="novalid-msg"><strong>').h("i18n",t,{},{$key:"noValidService"}).w(": </strong>").h("i18n",t,{},{$key:"noValidService.instructions"}).w("</p></div></div>")}t.__dustBody=!0;return t};e.template[e.CLASS+"-dialog"]=function(){dust.register(e.CLASS+"-dialog",t);function t(e,t){return e.w(' <div class="tc-ctl-download-help-dialog tc-modal"><div class="tc-modal-background tc-modal-close"></div><div class="tc-modal-window"><div class="tc-modal-header"><h3>').h("i18n",t,{},{$key:"downloadData"}).w('</h3><div class="tc-ctl-popup-close tc-modal-close"></div></div><div class="tc-modal-body"><p>').h("i18n",t,{},{$key:"dl.instructions.1|s"}).w("</p><ul><li>").h("i18n",t,{},{$key:"dl.instructions.2|s"}).w("</li><li>").h("i18n",t,{},{$key:"dl.instructions.3|s"}).w("</li><li>").h("i18n",t,{},{$key:"dl.instructions.4|s"}).w("<ul><li>").h("i18n",t,{},{$key:"dl.instructions.5|s"}).w("</li><li>").h("i18n",t,{},{$key:"dl.instructions.6|s"}).w('</li></ul></li></ul></div><div class="tc-modal-footer"><button type="button" class="tc-button tc-modal-close">').h("i18n",t,{},{$key:"close"}).w("</button></div></div></div>")}t.__dustBody=!0;return t}}e.render=function(e){var t=this;t.getRenderedHtml(t.CLASS+"-dialog",null,function(e){t._$dialogDiv.html(e)}).then(function(){TC.Control.prototype.render.call(t,function(){t.CLASS;var i=".tc-ctl-tctr";t._selectors={TAB:i+"-tab",RADIOBUTTON:"input[type=radio][name=sctnr-sel]",ELEMENT:i+"-elm"};t._$div.find("span").on(TC.Consts.event.CLICK,function(e){var i=$(this).closest(t._selectors.TAB).find(t._selectors.RADIOBUTTON),n=i.val(),r=t._$div.find(t._selectors.ELEMENT);if(t._oldValue===n&&t.options.deselectable){setTimeout(function(){i.prop("checked",!1)},0);t._oldValue=null;$active=$();$hidden=r}else{$active=r.filter(t._selectors.ELEMENT+"-"+n);$hidden=r.not($active);t._oldValue=n}$active.removeClass(TC.Consts.classes.HIDDEN);$hidden.addClass(TC.Consts.classes.HIDDEN);i.prop("checked",!0)});e&&e()})})};e.register=function(e){var t=this;TC.Control.prototype.register.call(t,e);t.map.mustBeExportable=!0;var i=function(){for(var e=[],i=0;i<t.map.workLayers.length;i++){var n=t.map.workLayers[i];n.type===TC.Consts.layerType.WMS&&n.getVisibility()&&n.names.length>0&&e.push(n)}return e},n=function(e,i){var n,r=t._$div.find(".alert-warning");switch(e.key){case TC.Consts.WFSErrors.NumMaxFeatures:n=r.find("#zoom-msg").html().format({serviceName:e.params.serviceTitle});break;case TC.Consts.WFSErrors.NoLayers:n=t.getLocaleString("noLayersLoaded");break;case TC.Consts.WFSErrors.GetCapabilities:n=r.find("#novalid-msg").html().format({serviceName:e.params.serviceTitle});break;case TC.Consts.WFSErrors.NoFeatures:n=r.find("#noFeatures-msg").html();break;case TC.Consts.WFSErrors.Indeterminate:n=t.getLocaleString("wfs.IndeterminateError");t.map.toast(n,{type:TC.Consts.msgType.ERROR});TC.error("Error:{error} \r\n Descripcion:{descripcion} \r\n Servicio:{serviceName}".format({error:e.params.err,descripcion:e.params.errorThrown,serviceName:e.params.serviceTitle}),TC.Consts.msgErrorMode.CONSOLE);t.map.getLoadingIndicator().removeWait(i);return;default:n=t.getLocaleString("wfs."+e.key,e.params)}t.map.toast(n,{type:TC.Consts.msgType.WARNING});t.map.getLoadingIndicator().removeWait(i)};t._$div.on(TC.Consts.event.CLICK,".tc-ctl-download-btn",function(){var e=t.map.getLoadingIndicator().addWait(),r=$active.find("select").val();if($active.find("select").val().indexOf("image")>-1){var s,a=$.Deferred(),o=t.map.wrap.getViewport({synchronous:!0}).getElementsByTagName("canvas")[0],l=TC.Util.cloneCanvas(o),c=t.map.getControlsByClass(TC.control.ScaleBar);if(0==c.length){(c=new TC.control.ScaleBar).register(t.map);c.render()}if(c){var u=l.getContext("2d");u.save();var h,p,d=document.getElementsByClassName("ol-scale-line-inner"),f=d.item(0),m=$.extend({},f.getBoundingClientRect()),y=(d=document.getElementsByClassName(c[0].CLASS)).item(0),g=$.extend({},y.getBoundingClientRect()),C=f.textContent;u.beginPath();u.strokeStyle=window.getComputedStyle(f).borderColor;if(m.width>m.height){h=m.width;p=m.height}else{h=m.height;p=m.width}g.left=m.left=15;g.left=g.left-2;g.top=m.top=15;g.top--;u.moveTo(m.left,m.top);u.lineTo(m.left,m.top+p);u.lineTo(m.left+h,m.top+p);u.lineTo(m.left+h,m.top);u.stroke();u.measureText(C);var v={x:m.left+h/2,y:m.top+p/2};u.globalAlpha=.5;u.fillStyle=window.getComputedStyle(y).backgroundColor;h+=4;p+=4;u.fillRect(g.left,g.top,h,p);u.globalAlpha=1;u.fillStyle=window.getComputedStyle(f).color;u.font=window.getComputedStyle(f).fontSize+" "+window.getComputedStyle(f).fontFamily;u.textAlign="center";u.textBaseline="middle";u.fillText(C,v.x,v.y)}$active.find("#tc-ctl-download-image-qr:checked").length>0?$.when(function(e){var t=$.Deferred();e?TC.loadJS(void 0===QRCode,[TC.apiLocation+"lib/qrcode/qrcode.min.js"],function(){e.length>150&&(e=TC.Util.shortenUrl(e));$("body").append('<div id="qrcode"></div>');var i=$("#qrcode");new QRCode(i.get(0),{text:e,width:85,height:85});setTimeout(function(){var e=i.find("img").attr("src");i.remove();t.resolve(e)},100)}):t.resolve(imgBase64);return t.promise()}(function(){var e=window.location.href,t=e.indexOf("?"),i=e.indexOf("#");t>0&&(e=t<i?e.replace(e.substring(t,i),""):e.replace(e.substring(t,e.length-1),""));return e}())).then(function(i){if(i){var n=l.getContext("2d");n.fillStyle="#ffffff";n.fillRect(l.width-91,l.height-91,91,91);$.when(TC.Util.addToCanvas(l,i,{x:l.width-88,y:l.height-88})).then(function(e){a.resolve(e)})}else{TC.error(t.getLocaleString("dl.export.map.error")+": QR");t.map.getLoadingIndicator().removeWait(e)}}):a.resolve(l);$.when(a).then(function(i){try{s=i.toDataURL(r);TC.Util.downloadDataURI(window.location.hostname+"_"+TC.Util.getFormattedDate((new Date).toString(),!0)+"."+r.split("/")[1],r,s)}catch(e){TC.error(t.getLocaleString("dl.export.map.error")+": "+e.message)}t.map.getLoadingIndicator().removeWait(e)})}else{i();var T=t.map.getExtent(),L=TC.Util.reproject(T.slice(0,2),t.map.crs,TC.Defaults.crs),w=TC.Util.reproject(T.slice(2),t.map.crs,TC.Defaults.crs),b=TC.WFSGetFeatureBuilder(t.map,new TC.filter.bbox([L[0],L[1],w[0],w[1]]),r,!0);$.when.apply($,b).then(function(){var i=$.grep(arguments,function(e){return null!=e});if(0!==i.length){for(var r=[],s=0;s<i.length;s++)if(i[s].errors&&i[s].errors.length)for(var a=0;a<i[s].errors.length;a++){var o=i[s].errors[a];n(o,e)}else{var l=i[s].data,c=i[s].url;l&&c&&r.push({url:c+"?download=zip",data:l})}TC.Util.downloadFileForm(r);t.map.getLoadingIndicator().removeWait(e)}else n({key:TC.Consts.WFSErrors.NoLayers},e)})}});t._$div.on(TC.Consts.event.CLICK,".tc-ctl-download-help",function(e){e.stopPropagation();TC.Util.showModal(t._$dialogDiv.find(t._classSelector+"-help-dialog"))})}}();TC.control=TC.control||{};TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control");TC.Feature&&TC.feature.Point||TC.syncLoadJS(TC.apiLocation+"TC/feature/Point");TC.Feature&&TC.feature.Polyline||TC.syncLoadJS(TC.apiLocation+"TC/feature/Polyline");TC.Feature&&TC.feature.Polygon||TC.syncLoadJS(TC.apiLocation+"TC/feature/Polygon");TC.Consts.event.DRAWSTART="drawstart.tc";TC.Consts.event.DRAWEND="drawend.tc";TC.Consts.event.DRAWCANCEL="drawcancel.tc";TC.Consts.event.DRAWUNDO="drawundo.tc";TC.Consts.event.DRAWREDO="drawredo.tc";TC.Consts.event.MEASURE="measure.tc";TC.Consts.event.MEASUREPARTIAL="measurepartial.tc";TC.Consts.event.STYLECHANGE="stylechange.tc";TC.Consts.event.CHANGE="change.tc";!function(){TC.control.Draw=function(){var e=this;TC.Control.apply(e,arguments);e._classSelector="."+e.CLASS;e._pointClass=e.CLASS+"-point";e._lineClass=e.CLASS+"-line";e._polygonClass=e.CLASS+"-polygon";e.history=[];e.historyIndex=0;e.exportsState=!0;e.$events.on(TC.Consts.event.DRAWSTART,function(t){e.resetValues()});e.$events.on(TC.Consts.event.POINT,function(i){e.layer&&!e.persistent&&e.layer.features&&e.layer.features.length>0&&e.layer.clearFeatures();e.history.length=e.historyIndex;e.history[e.historyIndex++]=i.point;t(e)});e.$events.on(TC.Consts.event.DRAWEND,function(t){i(e);e.callBack&&e.callBack(t.feature)});e.layerPromise=$.Deferred();this.renderPromise().then(function(){e.reset=!0;e.callBack=null;e.measure=!1;e._cancelClick=!1;e.mode=e.options.mode||TC.Consts.geom.POLYLINE;e.options.measure&&(e.measure=e.options.measure);$.isFunction(e.options.callback)&&(e.callBack=e.options.callback);void 0===e.options.persistent?e.persistent=!0:e.persistent=e.options.persistent;e.wrap=new TC.wrap.control.Draw(e);e._$newBtn=e._$div.find(e._classSelector+"-btn-new").on(TC.Consts.event.CLICK,function(){e.new()});e._$cancelBtn=e._$div.find(e._classSelector+"-btn-cancel").on(TC.Consts.event.CLICK,function(){e.cancel()});e._$endBtn=e._$div.find(e._classSelector+"-btn-end").on(TC.Consts.event.CLICK,function(){e.end()});e._$undoBtn=e._$div.find(e._classSelector+"-btn-undo").on(TC.Consts.event.CLICK,function(){e.undo()});e._$redoBtn=e._$div.find(e._classSelector+"-btn-redo").on(TC.Consts.event.CLICK,function(){e.redo()});if(e.options.styleTools){e._$strokeColorPicker=e._$div.find(e._classSelector+"-str-c").on(TC.Consts.event.CHANGE,function(t){e.setStrokeColor(t.target.value)});e._$strokeWidthSelector=e._$div.find(e._classSelector+"-str-w").on(TC.Consts.event.CHANGE,function(t){e.setStrokeWidth(t.target.value)});e._$strokeWidthWatch=e._$div.find(e._classSelector+"-str-w-watch")}})};TC.inherit(TC.control.Draw,TC.Control);var e=TC.control.Draw.prototype;e.CLASS="tc-ctl-draw";var t=function(e){e._$endBtn.prop("disabled",0===e.historyIndex||e.mode===TC.Consts.geom.POLYGON&&e.historyIndex<3||e.mode===TC.Consts.geom.POLYLINE&&e.historyIndex<2);e._$redoBtn.prop("disabled",e.history.length===e.historyIndex);e._$undoBtn.prop("disabled",0===e.historyIndex)},i=function(e){e.resetValues();e._$endBtn.prop("disabled",!0);e._$cancelBtn.prop("disabled",!1)};TC.isDebug?e.template=TC.apiLocation+"TC/templates/Draw.html":e.template=function(){dust.register(e.CLASS,t);function t(e,t){return e.w('<div class="tc-ctl-draw-tools"><button class="tc-ctl-btn tc-ctl-draw-btn-new" title="').f(t.get(["tooltip"],!1),t,"h").w('">').h("i18n",t,{},{$key:"new"}).w('</button><button class="tc-ctl-btn tc-ctl-draw-btn-undo" disabled title="').h("i18n",t,{},{$key:"undo"}).w('">').h("i18n",t,{},{$key:"undo"}).w('</button><button class="tc-ctl-btn tc-ctl-draw-btn-redo" disabled title="').h("i18n",t,{},{$key:"redo"}).w('">').h("i18n",t,{},{$key:"redo"}).w('</button><button class="tc-ctl-btn tc-ctl-draw-btn-end" disabled title="').h("i18n",t,{},{$key:"end"}).w('">').h("i18n",t,{},{$key:"end"}).w('</button><button class="tc-ctl-btn tc-ctl-draw-btn-cancel" title="').h("i18n",t,{},{$key:"cancel"}).w('">').h("i18n",t,{},{$key:"cancel"}).w("</button></div>").x(t.get(["styleTools"],!1),t,{block:i},{})}t.__dustBody=!0;function i(e,t){return e.w('<div class="tc-ctl-draw-style">').h("i18n",t,{},{$key:"strokeColor"}).w('<input type="color" class="tc-ctl-col tc-ctl-draw-str-c" value="').f(t.get(["strokeColor"],!1),t,"h").w('" title="').h("i18n",t,{},{$key:"selectColor"}).w('" />').h("i18n",t,{},{$key:"strokeWidth"}).w('<div class="tc-ctl-draw-str-w-watch" style="border-bottom-width:').f(t.get(["strokeWidth"],!1),t,"h").w('px;"> </div><input type="number" class="tc-ctl-draw-str-w tc-textbox" value="').f(t.get(["strokeWidth"],!1),t,"h").w('" min="1" max="15" /></div>')}i.__dustBody=!0;return t};e.render=function(e){var t,i,n,r=this;switch(r.options.mode){case TC.Consts.geom.POLYLINE:case TC.Consts.geom.MULTIPOLYLINE:t=r.getLocaleString("drawLine");r._$div.addClass(r._lineClass);i=TC.Cfg.styles.line.strokeColor;n=TC.Cfg.styles.line.strokeWidth;break;case TC.Consts.geom.POLYGON:case TC.Consts.geom.MULTIPOLYGON:t=r.getLocaleString("drawPolygon");r._$div.addClass(r._polygonClass);i=TC.Cfg.styles.polygon.strokeColor;n=TC.Cfg.styles.polygon.strokeWidth;break;case TC.Consts.geom.POINT:case TC.Consts.geom.MULTIPOINT:t=r.getLocaleString("drawPoint");r._$div.addClass(r._pointClass);i=TC.Cfg.styles.point.strokeColor;n=TC.Cfg.styles.point.strokeWidth;break;default:t=r.getLocaleString("draw");i=TC.Cfg.styles.line.strokeColor;n=TC.Cfg.styles.line.strokeWidth}const s={tooltip:t,strokeColor:function(e){const t=e.match(/^#([0-9a-f])([0-9a-f])([0-9a-f])$/i);return t&&t.length?"#"+t[1]+t[1]+t[2]+t[2]+t[3]+t[3]:e}(i),strokeWidth:n,styleTools:r.options.styleTools};r.renderData(s,function(){Modernizr.inputtypes.color?$.isFunction(e)&&e():TC.loadJS(!$.fn.spectrum,TC.apiLocation+"lib/spectrum/spectrum.min.js",function(){TC.loadCSS(TC.apiLocation+"lib/spectrum/spectrum.css");r._$div.find("input[type=color]").spectrum({preferredFormat:"hex",showPalette:!0,palette:[],selectionPalette:[],cancelText:r.getLocaleString("cancel"),chooseText:r.getLocaleString("ok"),replacerClassName:r.CLASS+"-str-c"});$.isFunction(e)&&e()})})};e.register=function(e){var t=this;TC.Control.prototype.register.call(t,e);const i=function(){t.styles={};$.extend(!0,t.styles,t.options.styles||t.layer.options.styles)};e.loaded(function(){if(t.options.layer){t.setLayer(t.options.layer);i()}else"boolean"!=typeof t.options.layer&&e.addLayer({id:t.getUID(),title:"DrawControl",stealth:!0,type:TC.Consts.layerType.VECTOR,styles:{point:e.options.styles.point,line:e.options.styles.line,polygon:e.options.styles.polygon}}).then(function(n){t.layer=n;i();e.putLayerOnTop(t.layer);t.layerPromise.resolve(n)})})};e.new=function(){this.layer&&!this.persistent&&this.layer.clearFeatures();this._$cancelBtn.prop("disabled",!1);this.setMode(this.mode,!0);return this};e.undo=function(){var e=this.wrap.undo();if(e){this.historyIndex--;t(this);this.historyIndex<=0&&this.resetValues();this.$events.trigger($.Event(TC.Consts.event.DRAWUNDO))}return e};e.redo=function(){var e=this.wrap.redo();if(e){this.historyIndex++;t(this);this.$events.trigger($.Event(TC.Consts.event.DRAWREDO))}return e};e.cancel=function(){this._cancelClick=!0;this.setMode(null,!1);this.resetValues();i(this);this._$cancelBtn.prop("disabled",!0);this.$events.trigger($.Event(TC.Consts.event.DRAWCANCEL,{ctrl:this}));return this};e.activate=function(){this._$newBtn.addClass(TC.Consts.classes.ACTIVE);this._$cancelBtn.prop("disabled",!1);TC.Control.prototype.activate.call(this);this.wrap.activate(this.mode);this._$div.removeClass(this._pointClass).removeClass(this._lineClass).removeClass(this._polygonClass);switch(this.mode){case TC.Consts.geom.POINT:this._$div.addClass(this._pointClass);break;case TC.Consts.geom.POLYLINE:this._$div.addClass(this._lineClass);break;case TC.Consts.geom.POLYGON:this._$div.addClass(this._polygonClass)}};e.deactivate=function(){this._$newBtn&&this._$newBtn.removeClass(TC.Consts.classes.ACTIVE);this._$cancelBtn&&this._$cancelBtn.prop("disabled",!0);TC.Control.prototype.deactivate.call(this,!this._cancelClick);this.wrap&&this.wrap.deactivate();this.resetValues();this._cancelClick=!1};e.clear=function(){const e=this;e.layer&&e.layer.clearFatures();e.resetValues();return e};e.isExclusive=function(){return!0};e.end=function(){this.wrap.end();this.resetValues();return this};e.setMode=function(e,t){const i=this;e&&(i.mode=e);if(t&&e){i.layer&&i.layer.map.putLayerOnTop(i.layer);i.activate()}else i.deactivate();var n=t?TC.Consts.event.CONTROLACTIVATE:TC.Consts.event.CONTROLDEACTIVATE;i.map&&i.map.$events.trigger($.Event(n,{control:i}));return i};e.setStyle=function(e){const t=this;if(e)$.extend(t.style,e);else switch(t.options.mode){case TC.Consts.geom.POLYLINE:case TC.Consts.geom.MULTIPOLYLINE:e={line:t.styles.line};break;case TC.Consts.geom.POLYGON:case TC.Consts.geom.MULTIPOLYGON:e={polygon:t.styles.polygon};break;case TC.Consts.geom.POINT:case TC.Consts.geom.MULTIPOINT:e={point:t.styles.point};break;default:e={}}t.isActive&&t.wrap.setStyle(e)};e.getModeStyle=function(e){const t=this;switch(e=e||t.options.mode){case TC.Consts.geom.POLYLINE:case TC.Consts.geom.MULTIPOLYLINE:return t.styles.line;case TC.Consts.geom.POLYGON:case TC.Consts.geom.MULTIPOLYGON:return t.styles.polygon;case TC.Consts.geom.POINT:case TC.Consts.geom.MULTIPOINT:return t.styles.point;default:return null}};e.setStrokeColorWatch=function(e){const t=this;if(t.options.styleTools){void 0===e&&(e=t.getModeStyle().strokeColor);const i=e.match(/^#([0-9a-f])([0-9a-f])([0-9a-f])$/i);i&&i.length&&(e="#"+i[1]+i[1]+i[2]+i[2]+i[3]+i[3]);t._$strokeColorPicker.val(e);Modernizr.inputtypes.color||t._$strokeColorPicker.spectrum("set",e)}return t};e.setStrokeColor=function(e){const t=this,i=t.getModeStyle();i&&(i.strokeColor=e);t.isActive&&t.setStyle();t.setStrokeColorWatch(e);t.$events.trigger($.Event(TC.Consts.event.STYLECHANGE,{property:"strokeColor",value:e}));return t};e.setStrokeWidthWatch=function(e){const t=this;if(t.options.styleTools){void 0===e&&(e=t.getModeStyle().strokeWidth);if((e=parseInt(e,10))!==Number.NaN){t._$strokeWidthSelector.val(e);t._$strokeWidthWatch.css("border-bottom-width",e+"px")}}return t};e.setStrokeWidth=function(e){const t=this;if((e=parseInt(e,10))!==Number.NaN){const i=t.getModeStyle();i&&(i.strokeWidth=e);t.isActive&&t.setStyle();t.setStrokeWidthWatch(e);t.$events.trigger($.Event(TC.Consts.event.STYLECHANGE,{property:"strokeWidth",value:e}))}return t};e.getLayer=function(){return this.options&&"boolean"==typeof this.options.layer&&!this.options.layer?null:this.layer?this.layer:this.layerPromise};e.setLayer=function(e){if(this.map){this.layer="string"==typeof e?this.map.getLayer(e):e;this.layerPromise.resolve(this.layer)}};e.resetValues=function(){this.history.length=0;this.historyIndex=0;t(this);return this};e.exportState=function(){const e=this;return e.exportsState?{id:e.id,layer:e.layer.exportState()}:null};e.importState=function(e){$.when(this.getLayer()).then(function(t){t.importState(e.layer)})}}();TC.control=TC.control||{};TC.control.Measure||TC.syncLoadJS(TC.apiLocation+"TC/control/Measure");TC.control.DrawMeasureModify=function(){var e=this;TC.control.Measure.apply(e,arguments);e.persistentDrawControls=!0;e.renderPromise().then(function(){e._$coord=e._$div.find(".tc-ctl-meas-val-coord")});e._$dialogDiv=$(TC.Util.getDiv(e.options.dialogDiv));e.options.dialogDiv||e._$dialogDiv.appendTo("body");if(e.options.displayElevation){e.elevationActive=!0;e.elevationProfileActive=!0;TC.loadJS(!TC.tool||!TC.tool.Elevation,TC.apiLocation+"TC/tool/Elevation",function(){const t="boolean"==typeof e.options.displayElevation?{}:e.options.displayElevation;e.elevation=new TC.tool.Elevation(t)})}};TC.inherit(TC.control.DrawMeasureModify,TC.control.Measure);!function(){var e=TC.control.DrawMeasureModify.prototype;e.CLASS="tc-ctl-dmm";TC.Consts.event.DRAWCHART=TC.Consts.event.DRAWCHART||"drawchart.tc";const t=[],i=function(e){return t.filter(function(t){return t.feature===e})[0]},n=function(e){const i=t.reduce(function(t,i,n){return i.feature===e?n:t},-1);i>=0&&t.splice(i,1)};e.template={};if(TC.isDebug){e.template[e.CLASS]=TC.apiLocation+"TC/templates/DrawMeasureModify.html";e.template[e.CLASS+"-dialog"]=TC.apiLocation+"TC/templates/DrawMeasureModifyDialog.html"}else{e.template[e.CLASS]=function(){dust.register(e.CLASS,t);function t(e,t){return e.w("<h2>").h("i18n",t,{},{$key:"drawAndMeasure"}).w(' <span class="tc-beta">').h("i18n",t,{},{$key:"beta"}).w('</span></h2><div class="tc-ctl-meas-select"><form><label class="tc-ctl-meas-btn-pt"><input type="radio" name="mode" value="point" /><span>').h("i18n",t,{},{$key:"points"}).w('</span></label><label class="tc-ctl-meas-btn-len"><input type="radio" name="mode" value="polyline" /><span>').h("i18n",t,{},{$key:"lines"}).w('</span></label><label class="tc-ctl-meas-btn-area"><input type="radio" name="mode" value="polygon" /><span>').h("i18n",t,{},{$key:"polygons"}).w('</span></label></form></div><div class="tc-ctl-meas-mode tc-ctl-meas-pt tc-hidden"><div class="tc-ctl-meas-point"></div><div class="tc-ctl-meas-txt">').h("i18n",t,{},{$key:"search.list.coordinates"}).w(': <span class="tc-ctl-meas-val-coord"></span></div></div><div class="tc-ctl-meas-mode tc-ctl-meas-len tc-hidden"><div class="tc-ctl-meas-line"></div><div class="tc-ctl-meas-txt">').h("i18n",t,{},{$key:"2dLength"}).w(': <span class="tc-ctl-meas-val-len"></span><button class="tc-ctl-meas-prof-btn tc-active" title="').h("i18n",t,{},{$key:"deactivateElevationProfile"}).w('">').h("i18n",t,{},{$key:"geo.trk.chart.chpe"}).w('</button></div></div><div class="tc-ctl-meas-mode tc-ctl-meas-area tc-hidden"><div class="tc-ctl-meas-polygon"></div><div class="tc-ctl-meas-txt">').h("i18n",t,{},{$key:"area"}).w(': <span class="tc-ctl-meas-val-area"></span>, ').h("i18n",t,{},{$key:"2dPerimeter"}).w(': <span class="tc-ctl-meas-val-peri"></span></div></div><div class="tc-ctl-dmm-tool"><div class="tc-ctl-dmm-mod"></div><div class="tc-ctl-dmm-cmd"><button class="tc-ctl-dmm-btn-clr" disabled title="').h("i18n",t,{},{$key:"deleteAll"}).w('">').h("i18n",t,{},{$key:"deleteAll"}).w('</button><button class="tc-ctl-dmm-btn-dl" disabled title="').h("i18n",t,{},{$key:"download"}).w('">').h("i18n",t,{},{$key:"download"}).w("...</button></div></div>")}t.__dustBody=!0;return t};e.template[e.CLASS+"-dialog"]=function(){dust.register(e.CLASS+"-dialog",t);function t(e,t){return e.w('<div class="tc-ctl-dmm-dialog tc-modal"><div class="tc-modal-background tc-modal-close"></div><div class="tc-modal-window"><div class="tc-modal-header"><h3>').h("i18n",t,{},{$key:"downloadSketch"}).w('</h3><div class="tc-ctl-popup-close tc-modal-close"></div></div><div class="tc-modal-body"><div class="tc-ctl-dmm-dialog-ip"><h4>').h("i18n",t,{},{$key:"interpolateCoordsFromElevProfile"}).w('</h4><label><input type="radio" name="ip-coords" value="0" checked /><span>').h("i18n",t,{},{$key:"no"}).w('</span></label><label><input type="radio" name="ip-coords" value="1"/><span>').h("i18n",t,{},{$key:"yes"}).w('</span></label><div class="tc-ctl-dmm-dialog-ip-m tc-hidden">').h("i18n",t,{},{$key:"interpolateEveryXMeters.1"}).w('<input type="number" min="1" step="1" class="tc-textbox" value="').f(t.get(["interpolationInterval"],!1),t,"h").w('" />').h("i18n",t,{},{$key:"interpolateEveryXMeters.2"}).w('</div></div><div class="tc-ctl-dmm-dialog-dl"><button class="tc-button tc-btn-dl tc-ctl-dmm-dl-btn-kml" data-format="KML" title="KML">KML</button><button class="tc-button tc-btn-dl tc-ctl-dmm-dl-btn-gml" data-format="GML" title="GML">GML</button><button class="tc-button tc-btn-dl tc-ctl-dmm-dl-btn-geojson" data-format="GeoJSON" title="GeoJSON">GeoJSON</button><button class="tc-button tc-btn-dl tc-ctl-dmm-dl-btn-wkt" data-format="WKT" title="WKT">WKT</button><button class="tc-button tc-btn-dl tc-ctl-dmm-dl-btn-gpx" data-format="GPX" title="GPX">GPX</button></div></div></div></div>')}t.__dustBody=!0;return t}}e.render=function(e){var t=this;TC.control.Measure.prototype.render.call(t,function(){t._$clearBtn=t._$div.find(".tc-ctl-dmm-cmd button.tc-ctl-dmm-btn-clr").on(TC.Consts.event.CLICK,function(e){TC.confirm(t.getLocaleString("deleteAll.confirm"),function(){t.clear()})});t._$downloadBtn=t._$div.find(".tc-ctl-dmm-cmd button.tc-ctl-dmm-btn-dl").on(TC.Consts.event.CLICK,function(e){t.showSketchDownloadDialog()});t._$elevProfileBtn=t._$div.find(".tc-ctl-meas-prof-btn").on(TC.Consts.event.CLICK,function(e){t.elevationProfileActive?t.deactivateElevationProfile():t.activateElevationProfile()});t.options.displayElevation||t._$elevProfileBtn.hide();$.isFunction(e)&&e()});const i={};t.options.displayElevation&&(i.interpolationInterval=t.options.displayElevation.resolution);t.getRenderedHtml(t.CLASS+"-dialog",i,function(e){const i=function(e){const i={fileName:t.getLocaleString("sketch").toLowerCase().replace(" ","_")+"_"+TC.Util.getFormattedDate((new Date).toString(),!0),format:e};if(t.options.displayElevation){const e="1"===t._$dialogDiv.find("input[type=radio][name=ip-coords]:checked").val(),n={crs:t.map.crs,sampleNumber:0};n.resolution=e?t._$dialogDiv.find("."+t.CLASS+"-dialog-ip-m input[type=number]").val()||t.options.displayElevation.resolution:0;if(n.resolution){if(t.layer.features.reduce(function(e,t){switch(!0){case TC.feature.Polyline&&t instanceof TC.feature.Polyline:case TC.feature.Polygon&&t instanceof TC.feature.Polygon:return e+t.getLength();default:return e}},0)/n.resolution>t.options.displayElevation.maxCoordLength){TC.alert(t.getLocaleString("tooManyCoordinatesForElevation.warning"));return}}TC.Util.closeModal();const r=t.map.getLoadingIndicator(),s=r&&r.addWait();$.when.apply(this,t.layer.features.map(function(e){const r=TC.feature.Polygon&&e instanceof TC.feature.Polygon;if(r||TC.feature.Polyline&&e instanceof TC.feature.Polyline){const s=$.Deferred(),a=e.getData(),o=$.extend({coordinates:e.geometry},n);t.elevation.getElevation(o).then(function(t){const n=i.format===TC.Consts.format.GPX?Number.NaN:0;t.forEach(function(e){null===e[2]&&(e[2]=n)});const o=r?new TC.feature.Polygon([t],e.options):new TC.feature.Polyline(t,e.options);o.setData(a);o.setStyle(e.getStyle());s.resolve(o)},function(e){s.reject(e)});return s.promise()}return e})).then(function(){r&&r.removeWait(s);t.map.exportFeatures(Array.prototype.slice.call(arguments),i)},function(e){r&&r.removeWait(s);TC.error(t.getLocaleString("elevation.error"))})}else{TC.Util.closeModal();t.map.exportFeatures(t.layer.features,i)}};t._$dialogDiv.html(e).on("change","input[type=radio][name=ip-coords]",function(e){t._$dialogDiv.find("."+t.CLASS+"-dialog-ip-m").toggleClass(TC.Consts.classes.HIDDEN,"0"===e.target.value)}).on(TC.Consts.event.CLICK,"button[data-format]",function(e){const n=$(e.target).data("format");n===TC.Consts.format.GPX&&t.layer.features.some(function(e){return TC.feature.Polygon&&e instanceof TC.feature.Polygon})?TC.confirm(t.getLocaleString("gpxNotCompatible.confirm"),function(){i(n)}):i(n)})})};e.register=function(e){const r=this;TC.control.Measure.prototype.register.call(r,e);const s=r.getUID(),a=r.getUID();$.when(r.layerPromise,r.renderPromise()).then(function(o){r._modifyPromise=e.addControl("modify",{id:a,div:r._$div.find("."+r.CLASS+"-mod"),layer:o});r._modifyPromise.then(function(t){r.modify=t;t.on(TC.Consts.event.FEATURESSELECT,function(e){const t=e.features[e.features.length-1];if(t){r.showMeasures(r.getFeatureMeasureData(t));const e=t._originalStyle||t.getStyle();switch(!0){case TC.feature.Polygon&&t instanceof TC.feature.Polygon:r.displayMode(TC.Consts.geom.POLYGON);r.drawPolygons.setStrokeColorWatch(e.strokeColor).setStrokeWidthWatch(e.strokeWidth);break;case TC.feature.Polyline&&t instanceof TC.feature.Polyline:r.displayMode(TC.Consts.geom.POLYLINE);r.drawLines.setStrokeColorWatch(e.strokeColor).setStrokeWidthWatch(e.strokeWidth);const n=i(t);n&&r.renderElevationChart(n.data);break;case TC.feature.Point&&t instanceof TC.feature.Point:r.displayMode(TC.Consts.geom.POINT);r.drawPoints.setStrokeColorWatch(e.strokeColor).setStrokeWidthWatch(e.strokeWidth)}r.modify.setFontColorWatch(e.fontColor).setFontSizeWatch(e.fontSize)}}).on(TC.Consts.event.FEATURESUNSELECT,function(e){r.modify.getSelectedFeatures().length||r.resetDrawWatches();r.resetElevationProfile();r.resultsPanelChart&&r.resultsPanelChart.hide()}).on(TC.Consts.event.FEATUREMODIFY,function(e){if(e.layer===r.layer){n(e.feature);const t=function(e){const t=r.getFeatureMeasureData(e);r.showMeasures(t);r.setFeatureMeasureData(e)};t(e.feature);r.options.displayElevation&&r.elevation.setGeometry({feature:e.feature,crs:r.map.crs}).then(t);r.map.getControlsByClass("TC.control.Popup").forEach(function(t){t.isVisible()&&t.currentFeature===e.feature&&t.hide()})}});e.on(TC.Consts.event.CONTROLDEACTIVATE,function(e){if(e.control===r.modify){r.resetDrawWatches();r.resetElevationProfile();r.resultsPanelChart&&r.resultsPanelChart.hide()}else if(e.control===r.drawLines){r.resetElevationProfile();r.resultsPanelChart&&r.resultsPanelChart.hide()}}).on(TC.Consts.event.FEATURECLICK,function(t){if(TC.feature.Polyline&&t.feature instanceof TC.feature.Polyline&&r.layer.features.indexOf(t.feature)>=0){const n=i(t.feature);n?r.renderElevationChart(n.data):r.displayElevationProfile(t.feature.geometry);r.elevationProfileActive&&e.getControlsByClass("TC.control.Popup").forEach(function(e){e.currentFeature===t.feature&&e.hide()})}})});r._drawLinesPromise.then(function(e){e.$events.on(TC.Consts.event.DRAWSTART,function(){r.resetValues()}).on(TC.Consts.event.DRAWUNDO+" "+TC.Consts.event.DRAWREDO,function(){r.displayElevationProfile(this.history.slice(0,this.historyIndex))}).on(TC.Consts.event.POINT,function(e){const t=this.history.slice(0,this.historyIndex),i=t[t.length-1];i[0]===e.point[0]&&i[1]===e.point[1]||t.push(e.point);r.displayElevationProfile(t)}).on(TC.Consts.event.STYLECHANGE,function(e){r.onStyleChange(e)})});r._drawPolygonsPromise.then(function(e){e.$events.on(TC.Consts.event.DRAWSTART,function(){r.resetValues()}).on(TC.Consts.event.DRAWEND,function(e){r.options.displayElevation&&r.elevation.setGeometry({feature:e.feature,crs:r.map.crs})}).on(TC.Consts.event.STYLECHANGE,function(e){r.onStyleChange(e)})});r._drawPointsPromise=e.addControl("draw",{id:s,div:r._$div.find("."+TC.control.Measure.prototype.CLASS+"-point"),mode:TC.Consts.geom.POINT,persistent:r.persistentDrawControls,styleTools:!0,layer:r.layer});r._drawPointsPromise.then(function(t){t.containerControl=r;r.drawControls.push(t);r.drawPoints=t;r.resetValues();t.$events.on(TC.Consts.event.DRAWEND,function(t){const i=function(t){r.showMeasures({coords:t.geometry,units:e.wrap.isGeo()?"degrees":"m"});r.setFeatureMeasureData(t)};i(t.feature);r.options.displayElevation&&r.elevation.setGeometry({feature:t.feature,crs:r.map.crs}).then(i)}).on(TC.Consts.event.DRAWCANCEL,function(e){r.cancel()}).on(TC.Consts.event.STYLECHANGE,function(e){r.onStyleChange(e)});t.exportsState=!1});r.setMode(r.options.mode);e.on(TC.Consts.event.FEATUREADD,function(e){if(e.layer===r.layer){r.setFeatureMeasureData(e.feature);r._modifyPromise.then(function(t){t.displayLabelText(e.feature.getStyle().label)});r._$clearBtn.prop("disabled",!1);r._$downloadBtn.prop("disabled",!1)}}).on(TC.Consts.event.FEATUREREMOVE+" "+TC.Consts.event.FEATURESCLEAR,function(e){if(e.layer===r.layer)if(0===r.layer.features.length){r._$clearBtn.prop("disabled",!0);r._$downloadBtn.prop("disabled",!0);r.resetValues();t.length=0}else e.feature&&n(e.feature)})})};e.displayMode=function(e){const t=this;e===TC.Consts.geom.POINT&&(t._$activeMode=t._$div.find(".tc-ctl-meas-pt"));t.modify&&t.modify._$div.removeClass(TC.Consts.classes.COLLAPSED);return TC.control.Measure.prototype.displayMode.call(t,e)};e.setMode=function(e){const t=this;e===TC.Consts.geom.POINT&&t.drawPoints.activate();return TC.control.Measure.prototype.setMode.call(t,e)};e.setFeatureMeasureData=function(e){const t=this,i={};switch(!0){case TC.feature.Point&&e instanceof TC.feature.Point:i[t.getLocaleString("search.list.coordinates")]=t._$coord.html();e.setData(i);break;case TC.feature.Polyline&&e instanceof TC.feature.Polyline:i[t.getLocaleString("2dLength")]=t._$len.html();e.setData(i);break;case TC.feature.Polygon&&e instanceof TC.feature.Polygon:i[t.getLocaleString("area")]=t._$area.html();i[t.getLocaleString("2dPerimeter")]=t._$peri.html();e.setData(i)}return t};e.getFeatureMeasureData=function(e){const t=this,n={units:"m"},r={};t.map.wrap.isGeo()&&(r.crs=TC.Cfg.utmCrs);switch(!0){case TC.feature.Polygon&&e instanceof TC.feature.Polygon:n.area=e.getArea(r);n.perimeter=e.getLength(r);break;case TC.feature.Polyline&&e instanceof TC.feature.Polyline:n.length=e.getLength(r);const s=i(e);s?t.renderElevationChart(s.data):t.displayElevationProfile(e.geometry);break;case TC.feature.Point&&e instanceof TC.feature.Point:n.coords=e.geometry}return n};e.showMeasures=function(e){const t=this;TC.control.Measure.prototype.showMeasures.call(t,e);(e=e||{}).units;const i=t.map.options.locale||TC.Cfg.locale;if(e.coords){var n="m"===e.units?"x: "+TC.Util.formatNumber(e.coords[0].toFixed(TC.Consts.METER_PRECISION),i)+", y: "+TC.Util.formatNumber(e.coords[1].toFixed(TC.Consts.METER_PRECISION),i):TC.Util.formatNumber(e.coords[1].toFixed(TC.Consts.DEGREE_PRECISION),i)+", "+TC.Util.formatNumber(e.coords[0].toFixed(TC.Consts.DEGREE_PRECISION),i);e.coords.length>2&&(n+=", "+t.getLocaleString("ele")+": "+TC.Util.formatNumber(e.coords[2].toFixed(TC.Consts.METER_PRECISION)));t._$coord.html(n)}return t};e.resetValues=function(){const e=this;TC.control.Measure.prototype.resetValues.call(e);e._$coord&&e._$coord.text(e.NOMEASURE);return e};e.resetDrawWatches=function(){this.drawControls.forEach(function(e){e.setStrokeColorWatch().setStrokeWidthWatch()})};e.clear=function(){const e=this;e.resetValues();e.layer.clearFeatures();e.modify.isActive&&e.modify.deactivate();if(e.options.displayElevation){e.resetElevationProfile();e.resultsPanelChart&&e.resultsPanelChart.hide()}e._$clearBtn.prop("disabled",!0);e._$downloadBtn.prop("disabled",!0);return e};e.showSketchDownloadDialog=function(e){const t=this._$dialogDiv.find("."+this.CLASS+"-dialog");t.find("."+this.CLASS+"-dialog-ip").toggleClass(TC.Consts.classes.HIDDEN,!this.layer.features.some(function(e){return TC.feature.Polyline&&e instanceof TC.feature.Polyline||TC.feature.Polygon&&e instanceof TC.feature.Polygon}));TC.Util.showModal(t,e);return this};e.onStyleChange=function(e){const t=this;var i;switch(e.target.mode){case TC.Consts.geom.POLYGON:i=TC.feature.Polygon;break;case TC.Consts.geom.POLYLINE:i=TC.feature.Polyline;break;case TC.Consts.geom.POINT:i=TC.feature.Point}i&&t.modify.getSelectedFeatures().forEach(function(t){if(t instanceof i){const i={};i[e.property]=e.value;t.setStyle(i)}})};e.displayElevationProfile=function(n){const r=this;1===n.length&&(n=n.slice()).push(n[0]);const s=r.map.getLoadingIndicator(),a=s&&s.addWait();r.elevation.getElevation({crs:r.map.crs,coordinates:n}).then(function(o){s&&s.removeWait(a);var l=0,c=Number.NEGATIVE_INFINITY,u=Number.POSITIVE_INFINITY;const h=o.map(function(e,t,i){const n=0===t?e:i[t-1],r=e[0]-n[0],s=e[1]-n[1];l+=Math.sqrt(r*r+s*s);var a=e[2];if("number"==typeof a){c=Math.max(a,c);u=Math.min(a,u)}return[l,a]});r.elevationProfileData={x:h.map(function(e){return e[0]}),ele:h.map(function(e){return e[1]}),coords:o};const p={coords:o};"object"==typeof r.options.displayElevation&&(p.hillDeltaThreshold=r.options.displayElevation.hillDeltaThreshold);$.extend(r.elevationProfileData,TC.tool.Elevation.getElevationGain(p));const d=r.layer.features.filter(function(e){return TC.feature.Polyline&&e instanceof TC.feature.Polyline}).filter(function(e){for(var t=0,i=n.length;t<i;t++){const i=n[t],r=e.geometry[t];if(i[0]!==r[0]||i[1]!==r[1])return!1}return!0})[0];d&&function(e,n){var r=i(e);if(!r){r={feature:e};t.push(r)}r.data=n}(d,r.elevationProfileData);if(r.resultsPanelChart)r.renderElevationChart();else{const t=r.map.getControlsByClass(TC.control.ResultsPanel).filter(function(e){return"chart"===e.options.content})[0],i=t?t._$div:$("<div>").appendTo(r.map._$div);r.map.addControl("resultsPanel",{id:r.getUID(),div:i,content:"chart",titles:{main:r.getLocaleString("geo.trk.chart.chpe"),max:r.getLocaleString("geo.trk.chart.chpe")},chart:{ctx:r,onmouseout:e.removeElevationTooltip,tooltip:e.getElevationTooltip}}).then(function(e){r.resultsPanelChart=e;r.resultsPanelChart.render(function(){r.renderElevationChart()})})}},function(e){r.resetElevationProfile();s&&s.removeWait(a)})};e.renderElevationChart=function(e){const t=this;t.elevationProfileData=e||t.elevationProfileData;if(t.resultsPanelChart&&t.elevationProfileActive){t.resultsPanelChart.openChart(t.elevationProfileData);t.resultsPanelChart.isMinimized()||t.resultsPanelChart.show()}};e.getElevationTooltip=function(e){this.resultsPanelChart.wrap.showElevationMarker({data:e,layer:this.layer,coords:this.elevationProfileData.coords});return this.resultsPanelChart.getElevationChartTooltip(e)};e.removeElevationTooltip=function(){this.resultsPanelChart.wrap.hideElevationMarker()};e.activateElevationProfile=function(){const e=this;e.elevationProfileActive=!0;e._$elevProfileBtn.addClass(TC.Consts.classes.ACTIVE).attr("title",e.getLocaleString("deactivateElevationProfile"));var t=!1;if(e.drawLines.historyIndex>1){e.displayElevationProfile(e.drawLines.history.slice(0,e.drawLines.historyIndex));t=!0}else{const i=e.modify.getActiveFeatures().filter(function(e){return TC.feature.Polyline&&e instanceof TC.feature.Polyline});if(i.length){const n=i[i.length-1];e.displayElevationProfile(n.geometry);t=!0}}t||e.resetElevationProfile();e.resultsPanelChart&&e.resultsPanelChart.show()};e.deactivateElevationProfile=function(){const e=this;e.elevationProfileActive=!1;e._$elevProfileBtn.removeClass(TC.Consts.classes.ACTIVE).attr("title",e.getLocaleString("activateElevationProfile"));e.resetElevationProfile();e.resultsPanelChart&&e.resultsPanelChart.hide()};e.resetElevationProfile=function(){const e=this;if(e.options.displayElevation){e.elevationProfileData={x:[0],ele:[0],coords:[0,0,0],upHill:0,downHill:0};e.resultsPanelChart&&e.renderElevationChart()}}}();TC.control=TC.control||{};TC.control.SWCacheClient||TC.syncLoadJS(TC.apiLocation+"TC/control/SWCacheClient");TC.Consts.editMode={SELECT:"select",ADDPOINT:"addpoint",ADDLINE:"addline",ADDPOLYGON:"addpolygon"};TC.Consts.editStyles={NEW:"temporary",SELECTED:"select",DEFAULT:"default"};TC.Consts.event.POINT="point.tc";TC.Consts.event.BEFOREFEATUREMODIFY="beforefeaturemodify.tc";TC.Consts.event.FEATUREMODIFY="featuremodify.tc";TC.Consts.event.FEATURESSELECT="featureselect.tc";TC.Consts.event.FEATURESUNSELECT="featureunselect.tc";!function(){var e=0,t=function(e,t){var i=$.Deferred();TC.loadJS(!window.localforage,[TC.Consts.url.LOCALFORAGE],function(){var n,r;switch(!0){case t instanceof TC.feature.Polygon:r=TC.Consts.geom.POLYGON;break;case t instanceof TC.feature.Polyline:r=TC.Consts.geom.POLYLINE;break;case t instanceof TC.feature.Point:r=TC.Consts.geom.POINT;break;case t instanceof TC.feature.MultiPolygon:r=TC.Consts.geom.MULTIPOLYGON;break;case t instanceof TC.feature.MultiPolyline:r=TC.Consts.geom.MULTIPOLYLINE}n={id:t.id||t.provId,attributes:t.data,type:r,geometry:t.geometry};localforage.setItem(e,n).then(function(){i.resolve({feature:t})}).catch(function(e){i.reject({feature:t,error:e})})});return i.promise()},i=function(e){var t=$.Deferred();TC.loadJS(!window.localforage,[TC.Consts.url.LOCALFORAGE],function(){localforage.removeItem(e).then(function(){t.resolve(e)}).catch(function(e){t.reject(e)})});return t.promise()},n=function(e){var t=$.Deferred();TC.loadJS(!window.localforage,[TC.Consts.url.LOCALFORAGE],function(){localforage.getItem(e).then(function(i){t.resolve({key:e,feature:i})}).catch(function(e){t.reject(e)})});return t.promise()},r=function(e,t){return e.LOCAL_STORAGE_KEY_PREFIX+(t||e.layer.id)},s=function(e,t){return r(e,t)+e.LOCAL_STORAGE_ADDED_KEY_PREFIX},a=function(e,t){return r(e,t)+e.LOCAL_STORAGE_MODIFIED_KEY_PREFIX},o=function(e,t){return r(e,t)+e.LOCAL_STORAGE_REMOVED_KEY_PREFIX},l=function(e){var t=!1;(TC.feature.MultiPolygon&&e instanceof TC.feature.MultiPolygon||TC.feature.MultiPolyline&&e instanceof TC.feature.MultiPolyline)&&e.geometry.length>1&&(t=!0);return t},c=function(e,t){e._$deleteBtn.prop("disabled",0===t.length);e._$joinBtn.prop("disabled",t.length<2);e._$splitBtn.prop("disabled",0===t.filter(l).length)},u=function(e,t){e._$saveBtn.prop("disabled",t);e._$discardBtn.prop("disabled",t);self.checkedOut=!t},h=function(e,t){void 0!==t?u(e,!t):TC.loadJS(!window.localforage,[TC.Consts.url.LOCALFORAGE],function(){var t=r(e);localforage.keys().then(function(i){if(i){for(var n=!0,r=0,s=i.length;r<s;r++)if(0===i[r].indexOf(t)){n=!1;break}u(e,n)}})})},p=function(e,t){var i=$.Deferred(),n=e._changesLayers[t.id];if(n)i.resolve(n);else{n=e._changesLayers[t.id]=new TC.layer.Vector({id:TC.getUID(),title:t.title+" - cambios pendientes",stealth:!0,styles:e.getChangesLayerStyle(t)});var r=e.map.layers.indexOf(t);e.map.insertLayer(n,r+1,function(){i.resolve(n)})}return i.promise()};TC.control.Edit=function(){var n=this;TC.control.SWCacheClient.apply(this,arguments);n._classSelector="."+n.CLASS;n.$events=$(n);n.wrap=new TC.wrap.control.Edit(n);n._layerDeferred=$.Deferred();n.layer=null;n.checkedOut=!1;n.callback=arguments[2]&&$.isFunction(arguments[2])?arguments[2]:n.options.callback?n.options.callback:null;n.multi=!!n.options.multi&&n.options.multi;n.eraseActionConfirmTxt=n.options.eraseText?n.options.eraseText:"\xbfEst\xe1 seguro de eliminar esta(s) geometr\xeda(s)?";n.cancelActionConfirmTxt=n.options.cancelText?n.options.eraseText:"Si continua todos los cambios se perder\xe1n. \xbfDesea continuar?";n.styles=n.options.styles;n.features={};n.attributeEditor=null;n.pointDraw=null;n.lineDraw=null;n.polygonDraw=null;n.snapping="boolean"!=typeof n.options.snapping||n.options.snapping;n._changesLayers={};n._showsChanges="boolean"!=typeof n.options.showChanges||n.options.showChanges;$.isFunction(n.options.getChangesLayerStyleFunction)&&(n.getChangesLayerStyleFunction=n.getChangesLayerStyle);n.$events.on(TC.Consts.event.FEATUREADD,function(i){var r=i.feature;r.provId="NewFeature."+e++;var a=n._changesLayers[n.layer.id];n.features[n.layer.id].added.push(r);a.addFeature(r);t(s(n)+r.provId,r).then(function(){h(n,!0);TC.toast("Adici\xf3n guardada")},function(){TC.error("Fallo al guardar adici\xf3n")})}).on(TC.Consts.event.FEATUREREMOVE,function(e){var r=e.feature,l=r.provId||r.id,c=function(){h(n);TC.toast("Eliminaci\xf3n guardada")},u=function(){TC.error("Fallo al guardar eliminaci\xf3n")},p=n._changesLayers[n.layer.id],d=n.features[n.layer.id],f=d.added.indexOf(r);if(f<0){var m=o(n);if((f=d.modified.indexOf(r))<0){if((f=d.removed.indexOf(r))<0){d.removed.push(r);p.addFeature(r);t(m+r.id,r).then(c,u)}}else{d.modified.splice(f,1);d.removed.push(r);i(a(n)+r.id).then(function(){c();t(m+r.id,r).then(c,u)},u)}}else{p.removeFeature(r);d.added.splice(f,1);i(s(n)+l).then(c,u)}}).on(TC.Consts.event.FEATUREMODIFY,function(e){var i=e.feature,r=i.provId||i.id,o=function(){h(n,!0);TC.toast("Modificaci\xf3n guardada")},l=function(){TC.error("Fallo al guardar modificaci\xf3n")},c=n._changesLayers[n.layer.id],u=n.features[n.layer.id],p=u.added.indexOf(i);if(p<0){if((p=u.modified.indexOf(i))<0){c.addFeature(i);u.modified.push(i)}t(a(n)+r,i).then(o,l)}else t(s(n)+r,i).then(o,l)}).on(TC.Consts.event.FEATUREADD+" "+TC.Consts.event.FEATUREREMOVE+" "+TC.Consts.event.FEATUREMODIFY,function(e){if(n.serviceWorkerEnabled&&navigator.onLine){var t=n.layer.wrap.getGetFeatureUrl(),i=n.layer.wrap.getDescribeFeatureTypeUrl();t&&i&&n.createCache(n.LOCAL_STORAGE_KEY_PREFIX+n.layer.id,{urlList:[t,i]})}}).on(TC.Consts.event.CONTROLDEACTIVATE,function(e){}).on(TC.Consts.event.FEATURESSELECT,function(e){var t=n.getSelectedFeatures();c(n,t);t.length&&t[0].showPopup(n.attributeEditor)}).on(TC.Consts.event.FEATURESUNSELECT,function(e){c(n,n.getSelectedFeatures())})};TC.inherit(TC.control.Edit,TC.control.SWCacheClient);var d=TC.control.Edit.prototype;d.CLASS="tc-ctl-edit";d.LOCAL_STORAGE_KEY_PREFIX="TC.offline.edit.";d.LOCAL_STORAGE_ADDED_KEY_PREFIX=".added.";d.LOCAL_STORAGE_MODIFIED_KEY_PREFIX=".modified.";d.LOCAL_STORAGE_REMOVED_KEY_PREFIX=".removed.";d.template={};if(TC.isDebug){d.template[d.CLASS]=TC.apiLocation+"TC/templates/Edit.html";d.template[d.CLASS+"-attr"]=TC.apiLocation+"TC/templates/EditAttributes.html"}else{d.template[d.CLASS]=function(){dust.register(d.CLASS,e);function e(e,n){return e.w("<h2>").h("i18n",n,{},{$key:"featureEdit"}).w(' <span class="tc-beta">').h("i18n",n,{},{$key:"beta"}).w('</span></h2><div class="tc-ctl-edit-layer"><select class="tc-combo tc-ctl-edit-layer-sel"><option value="">').h("i18n",n,{},{$key:"selectLayerToEdit"}).w("</option>").s(n.get(["layers"],!1),n,{block:t},{}).w('</select><input type="checkbox" id="tc-ctl-edit-view-changes-cb"').x(n.get(["showChanges"],!1),n,{block:i},{}).w(' /><label class="tc-ctl-edit-view-changes" for="tc-ctl-edit-view-changes-cb">').h("i18n",n,{},{$key:"highlightUnsyncedChanges"}).w('</label></div><div class="tc-ctl-edit-mode"><form><label class="tc-ctl-edit-btn-select" title="').h("i18n",n,{},{$key:"select"}).w('"><input type="radio" name="mode" value="select" /><span>').h("i18n",n,{},{$key:"select"}).w('</span></label><label class="tc-ctl-edit-btn-point" title="').h("i18n",n,{},{$key:"newPoint"}).w('"><input type="radio" name="mode" value="addpoint" /><span>').h("i18n",n,{},{$key:"newPoint"}).w('</span></label><label class="tc-ctl-edit-btn-line" title="').h("i18n",n,{},{$key:"newLine"}).w('"><input type="radio" name="mode" value="addline" /><span>').h("i18n",n,{},{$key:"newLine"}).w('</span></label><label class="tc-ctl-edit-btn-polygon" title="').h("i18n",n,{},{$key:"newPolygon"}).w('"><input type="radio" name="mode" value="addpolygon" /><span>').h("i18n",n,{},{$key:"newPolygon"}).w('</span></label></form></div><div class="tc-ctl-edit-select tc-hidden"><button class="tc-ctl-btn tc-ctl-edit-btn-delete" disabled title="').h("i18n",n,{},{$key:"delete"}).w('">').h("i18n",n,{},{$key:"delete"}).w('</button><button class="tc-ctl-btn tc-ctl-edit-btn-join" disabled title="').h("i18n",n,{},{$key:"joinGeometries.tooltip"}).w('">').h("i18n",n,{},{$key:"joinGeometries"}).w('</button><button class="tc-ctl-btn tc-ctl-edit-btn-split" disabled title="').h("i18n",n,{},{$key:"splitGeometry"}).w('">').h("i18n",n,{},{$key:"splitGeometry"}).w('</button><button class="tc-ctl-btn tc-ctl-edit-btn-cancel" disabled title="').h("i18n",n,{},{$key:"cancel"}).w('">').h("i18n",n,{},{$key:"cancel"}).w('</button></div><div class="tc-ctl-edit-point tc-hidden"></div><div class="tc-ctl-edit-line tc-hidden"></div><div class="tc-ctl-edit-polygon tc-hidden"></div><div class="tc-ctl-edit-save"><button class="tc-button tc-icon-button tc-ctl-edit-btn-save" disabled title="').h("i18n",n,{},{$key:"syncChanges"}).w('">').h("i18n",n,{},{$key:"syncChanges"}).w('</button><button class="tc-button tc-icon-button tc-ctl-edit-btn-discard" disabled title="').h("i18n",n,{},{$key:"discardChanges"}).w('">').h("i18n",n,{},{$key:"discardChanges"}).w("</button></div>")}e.__dustBody=!0;function t(e,t){return e.w('<option value="').f(t.get(["id"],!1),t,"h").w('">').f(t.get(["title"],!1),t,"h").w("</option>")}t.__dustBody=!0;function i(e,t){return e.w(" checked")}i.__dustBody=!0;return e};d.template[d.CLASS+"-attr"]=function(){dust.register(d.CLASS+"-attr",t);var e={inputText:P,inputNumber:_,inputCheckbox:N,inputDate:k,inputTime:R,inputDatetime:I};function t(t,n){n=n.shiftBlocks(e);return t.w('<div class="tc-ctl-edit-attr"><h3>').h("i18n",n,{},{$key:"attributeEdit"}).w('</h3><div class="tc-ctl-edit-attr-body"><table><tbody>').s(n.get(["data"],!1),n,{block:i},{}).w('</tbody></table></div><div class="tc-ctl-edit-attr-footer"><button class="tc-button tc-ctl-edit-btn-attr-ok">').h("i18n",n,{},{$key:"ok"}).w('</button><button class="tc-button tc-ctl-edit-btn-attr-cancel">').h("i18n",n,{},{$key:"cancel"}).w("</button></div></div>")}t.__dustBody=!0;function i(t,i){i=i.shiftBlocks(e);return t.w("<tr><th>").f(i.get(["name"],!1),i,"h").w("</th><td>").x(i.get(["readOnly"],!1),i,{else:n,block:D},{}).w("</td></tr>")}i.__dustBody=!0;function n(t,i){i=i.shiftBlocks(e);return t.x(i.get(["availableValues"],!1),i,{block:r},{}).h("select",i,{block:a},{key:i.get(["type"],!1)})}n.__dustBody=!0;function r(t,i){i=i.shiftBlocks(e);return t.w('<select class="tc-combo" name="').f(i.get(["name"],!1),i,"h").w('"><option value=""></option>').s(i.get(["availableValues"],!1),i,{block:s},{}).w("</select>")}r.__dustBody=!0;function s(t,i){i=i.shiftBlocks(e);return t.w('<option value="').f(i.getPath(!0,[]),i,"h").w('">').f(i.getPath(!0,[]),i,"h").w("</option>")}s.__dustBody=!0;function a(t,i){i=i.shiftBlocks(e);return t.h("none",i,{block:o},{}).h("eq",i,{block:l},{value:"int"}).h("eq",i,{block:c},{value:"integer"}).h("eq",i,{block:u},{value:"double"}).h("eq",i,{block:h},{value:"boolean"}).h("eq",i,{block:p},{value:"date"}).h("eq",i,{block:f},{value:"time"}).h("eq",i,{block:m},{value:"dateTime"}).h("eq",i,{block:y},{value:"byte"}).h("eq",i,{block:g},{value:"long"}).h("eq",i,{block:C},{value:"negativeInteger"}).h("eq",i,{block:v},{value:"nonNegativeInteger"}).h("eq",i,{block:T},{value:"nonPositiveInteger"}).h("eq",i,{block:L},{value:"positiveInteger"}).h("eq",i,{block:w},{value:"short"}).h("eq",i,{block:b},{value:"unsignedLong"}).h("eq",i,{block:S},{value:"unsignedInt"}).h("eq",i,{block:E},{value:"unsignedShort"}).h("eq",i,{block:O},{value:"unsignedByte"}).h("eq",i,{block:A},{value:"float"}).h("eq",i,{block:x},{value:"decimal"})}a.__dustBody=!0;function o(t,i){i=i.shiftBlocks(e);return t.b(i.getBlock("inputText"),i,{},{})}o.__dustBody=!0;function l(t,i){i=i.shiftBlocks(e);return t.b(i.getBlock("inputNumber"),i,{},{})}l.__dustBody=!0;function c(t,i){i=i.shiftBlocks(e);return t.b(i.getBlock("inputNumber"),i,{},{})}c.__dustBody=!0;function u(t,i){i=i.shiftBlocks(e);return t.b(i.getBlock("inputNumber"),i,{},{})}u.__dustBody=!0;function h(t,i){i=i.shiftBlocks(e);return t.b(i.getBlock("inputCheckbox"),i,{},{})}h.__dustBody=!0;function p(t,i){i=i.shiftBlocks(e);return t.b(i.getBlock("inputDate"),i,{},{})}p.__dustBody=!0;function f(t,i){i=i.shiftBlocks(e);return t.b(i.getBlock("inputTime"),i,{},{})}f.__dustBody=!0;function m(t,i){i=i.shiftBlocks(e);return t.b(i.getBlock("inputDatetime"),i,{},{})}m.__dustBody=!0;function y(t,i){i=i.shiftBlocks(e);return t.b(i.getBlock("inputNumber"),i,{},{})}y.__dustBody=!0;function g(t,i){i=i.shiftBlocks(e);return t.b(i.getBlock("inputNumber"),i,{},{})}g.__dustBody=!0;function C(t,i){i=i.shiftBlocks(e);return t.b(i.getBlock("inputNumber"),i,{},{})}C.__dustBody=!0;function v(t,i){i=i.shiftBlocks(e);return t.b(i.getBlock("inputNumber"),i,{},{})}v.__dustBody=!0;function T(t,i){i=i.shiftBlocks(e);return t.b(i.getBlock("inputNumber"),i,{},{})}T.__dustBody=!0;function L(t,i){i=i.shiftBlocks(e);return t.b(i.getBlock("inputNumber"),i,{},{})}L.__dustBody=!0;function w(t,i){i=i.shiftBlocks(e);return t.b(i.getBlock("inputNumber"),i,{},{})}w.__dustBody=!0;function b(t,i){i=i.shiftBlocks(e);return t.b(i.getBlock("inputNumber"),i,{},{})}b.__dustBody=!0;function S(t,i){i=i.shiftBlocks(e);return t.b(i.getBlock("inputNumber"),i,{},{})}S.__dustBody=!0;function E(t,i){i=i.shiftBlocks(e);return t.b(i.getBlock("inputNumber"),i,{},{})}E.__dustBody=!0;function O(t,i){i=i.shiftBlocks(e);return t.b(i.getBlock("inputNumber"),i,{},{})}O.__dustBody=!0;function A(t,i){i=i.shiftBlocks(e);return t.b(i.getBlock("inputNumber"),i,{},{})}A.__dustBody=!0;function x(t,i){i=i.shiftBlocks(e);return t.b(i.getBlock("inputNumber"),i,{},{})}x.__dustBody=!0;function P(t,i){i=i.shiftBlocks(e);return t.w('<input type="text" class="tc-textbox" name="').f(i.get(["name"],!1),i,"h").w('" value="').f(i.get(["value"],!1),i,"h").w('" />')}P.__dustBody=!0;function _(t,i){i=i.shiftBlocks(e);return t.w('<input type="number" class="tc-textbox" name="').f(i.get(["name"],!1),i,"h").w('" value="').f(i.get(["value"],!1),i,"h").w('" />')}_.__dustBody=!0;function N(t,i){i=i.shiftBlocks(e);return t.w('<input type="checkbox" name="').f(i.get(["name"],!1),i,"h").w('"').x(i.get(["value"],!1),i,{block:M},{}).w("/>")}N.__dustBody=!0;function M(t,i){i=i.shiftBlocks(e);return t.w(" checked")}M.__dustBody=!0;function k(t,i){i=i.shiftBlocks(e);return t.w('<input type="date" class="tc-textbox" name="').f(i.get(["name"],!1),i,"h").w('" value="').f(i.get(["value"],!1),i,"h").w('" />')}k.__dustBody=!0;function R(t,i){i=i.shiftBlocks(e);return t.w('<input type="time" class="tc-textbox" name="').f(i.get(["name"],!1),i,"h").w('" value="').f(i.get(["value"],!1),i,"h").w('" />')}R.__dustBody=!0;function I(t,i){i=i.shiftBlocks(e);return t.w('<input type="datetime" class="tc-textbox" name="').f(i.get(["name"],!1),i,"h").w('" value="').f(i.get(["value"],!1),i,"h").w('" />')}I.__dustBody=!0;function D(t,i){i=i.shiftBlocks(e);return t.f(i.get(["value"],!1),i,"h")}D.__dustBody=!0;return t}}d.register=function(t){var i=this;TC.control.SWCacheClient.prototype.register.call(i,t);const l=i.getUID(),c=i.getUID(),u=i.getUID();t.addControl("popup",{closeButton:!0}).then(function(e){i.attributeEditor=e});t.on(TC.Consts.event.LAYERUPDATE,function(t){if(t.layer.type===TC.Consts.layerType.WFS&&!t.layer.options.stealth){var l=t.layer,c=i.features[t.layer.id]=i.features[t.layer.id]||{added:[],modified:[],removed:[]};p(i,l).then(function(t){i.layer!==l&&t.setVisibility(!1);var u=r(i,l.id),h=s(i,l.id),p=a(i,l.id),d=o(i,l.id);TC.loadJS(!window.localforage,[TC.Consts.url.LOCALFORAGE],function(){TC.getUID();localforage.keys().then(function(i){if(i)for(var r=0,s=i.length;r<s;r++){var a=i[r];0===a.indexOf(u)&&n(a).then(function(i){var n,r=i.key;if(0===r.indexOf(d)){n=r.substr(d.length);var s=l.getFeatureById(n);l.removeFeature(s);t.addFeature(s);c.removed.push(s)}else if(0===r.indexOf(p)){n=r.substr(p.length);if(s=l.getFeatureById(n)){t.addFeature(s);c.modified.push(s);s.wrap.setGeometry(i.feature.geometry);s.setData(i.feature.attributes)}}else if(0===r.indexOf(h)){n=r.substr(h.length);var a,o=parseInt(n.substr(n.lastIndexOf(".")+1));e=Math.max(e,o+1);switch(i.feature.type){case TC.Consts.geom.POINT:a=l.addPoint(i.feature.geometry);break;case TC.Consts.geom.POLYLINE:a=l.addPolyline(i.feature.geometry);break;case TC.Consts.geom.POLYGON:a=l.addPolygon(i.feature.geometry);break;case TC.Consts.geom.MULTIPOLYLINE:a=l.addMultiPolyline(i.feature.geometry);break;case TC.Consts.geom.MULTIPOLYGON:a=l.addMultiPolygon(i.feature.geometry)}a.then(function(e){t.addFeature(e);c.added.push(e);e.provId=n;e.setData(i.feature.attributes)})}})}})})})}}).on(TC.Consts.event.LAYERADD,function(e){if(e.layer.type===TC.Consts.layerType.WFS&&!e.layer.options.stealth){i.features[e.layer.id]=i.features[e.layer.id]||{added:[],modified:[],removed:[]};$("<option>").attr("value",e.layer.id).html(e.layer.title||e.layer.id).appendTo(i._$layerSelect)}}).on(TC.Consts.event.LAYERREMOVE,function(e){if(e.layer.type===TC.Consts.layerType.WFS&&!e.layer.options.stealth){var t=i._$layerSelect.find("option[value="+e.layer.id+"]");t.filter(":selected").length>0&&i.setLayer(null);t.remove()}}).on(TC.Consts.event.POPUP,function(e){if(e.control===i.attributeEditor){for(var t=e.control.currentFeature,n=i.attributes.slice(),r={},s=i._joinedFeatureAttributes||[],a=0,o=n.length;a<o;a++){var l=t.getData()||{},c=n[a];c.value=l[c.name];"id"===c.name&&(c.readOnly=!0);c.availableValues=[];for(var u=0,h=s.length;u<h;u++){var p=s[u][c.name];void 0!==p&&""!==p&&(c.availableValues[c.availableValues.length]=p)}r[c.name]=c.type}n.sort(function(e,t){return(e.readOnly?!t.readOnly:t.readOnly)?!e.readOnly-!t.readOnly:e.name>t.name?1:e.name<t.name?-1:0});i.getRenderedHtml(i.CLASS+"-attr",{data:n},function(e){var n=i.attributeEditor.$contentDiv;n.html(e);var s=n.find("input"),a=n.find("select");s.on("input",function(e){var t=$(e.target),i=a.filter("[name="+t.attr("name")+"]");i.val()!==t.val()&&i.val("")});a.on("change",function(e){var t=$(e.target);s.filter("[name="+t.attr("name")+"]").val(t.val())});n.find("."+i.CLASS+"-btn-attr-ok").on("click",function(){var e={};s.each(function(t,i){var n=(s=$(i)).attr("name"),a=s.val();switch(r[n]){case"int":case"integer":case"byte":case"long":case"negativeInteger":case"nonNegativeInteger":case"nonPositiveInteger":case"positiveInteger":case"short":case"unsignedLong":case"unsignedInt":case"unsignedShort":case"unsignedByte":a=parseInt(a);Number.isNaN(a)||(e[n]=a);break;case"double":case"float":case"decimal":a=parseFloat(a);Number.isNaN(a)||(e[n]=a);break;case"date":case"time":case"dateTime":e[n]=new Date(a);break;case"boolean":e[n]=!!a;break;case void 0:break;default:e[n]=a}});t.setData(e);i.$events.trigger($.Event(TC.Consts.event.FEATUREMODIFY,{feature:t,layer:i.layer}));i.attributeEditor.hide()});n.find("."+i.CLASS+"-btn-attr-cancel").on("click",function(){i.attributeEditor.hide()})})}});t.loaded(function(){if(i.options.layer)i.setLayer(i.options.layer);else{var e=t.workLayers.filter(function(e){return e.type===TC.Consts.layerType.WFS&&!e.options.stealth});1===e.length?i.setLayer(e[0].id):i.setLayer(null)}i.showChanges(i._showsChanges);i.renderPromise().then(function(){$.when.apply(i,[t.addControl("draw",{id:l,div:i._$div.find("."+i.CLASS+"-point"),mode:TC.Consts.geom.POINT,layer:!1}),t.addControl("draw",{id:c,div:i._$div.find("."+i.CLASS+"-line"),mode:TC.Consts.geom.POLYLINE,layer:!1}),t.addControl("draw",{id:u,div:i._$div.find("."+i.CLASS+"-polygon"),mode:TC.Consts.geom.POLYGON,layer:!1})]).then(function(e,t,n){i.pointDraw=e;i.lineDraw=t;i.polygonDraw=n;var r=function(e){var t,n=e.feature;switch(i.geometryType){case TC.Consts.geom.POINT:t=TC.feature.Point;break;case TC.Consts.geom.POLYLINE:t=TC.feature.Polyline;break;case TC.Consts.geom.POLYGON:t=TC.feature.Polygon;break;case TC.Consts.geom.MULTIPOLYLINE:t=TC.feature.MultiPolyline;break;case TC.Consts.geom.MULTIPOLYGON:t=TC.feature.MultiPolygon}t&&(n=new t(n.geometry,{geometryName:i.layer.options.geometryName}));i.layer.addFeature(n);i.$events.trigger($.Event(TC.Consts.event.FEATUREADD,{feature:n}))},s=function(){i.cancel()};e.on(TC.Consts.event.DRAWEND,r).on(TC.Consts.event.DRAWCANCEL,s);t.on(TC.Consts.event.DRAWEND,r).on(TC.Consts.event.DRAWCANCEL,s);n.on(TC.Consts.event.DRAWEND,r).on(TC.Consts.event.DRAWCANCEL,s);i.options.modes&&$.isArray(i.options.modes)&&1==i.options.modes.length&&i.setMode(i.options.modes[0],null)})})})};d.render=function(e){var t=this,i=[];if(t.map)for(var n=0,r=t.map.workLayers.length;n<r;n++){var s=t.map.workLayers[n];s.type!==TC.Consts.layerType.WFS||s.options.stealth||i.push({id:s.id,title:s.title||s.id})}TC.Control.prototype.renderData.call(t,{layers:i,showChanges:t.showChanges},function(){t._$layerDiv=t._$div.find(t._classSelector+"-layer");t._$layerSelect=t._$layerDiv.find(t._classSelector+"-layer-sel").on("change",function(e){t.setLayer(t._$layerSelect.val())});t._$layerDiv.find("#"+t.CLASS+"-view-changes-cb").on("change",function(e){t.showChanges($(e.target).prop("checked"))});t._$cancelBtn=t._$div.find(t._classSelector+"-btn-cancel").on("click",function(){t.cancel()});t._$deleteBtn=t._$div.find(t._classSelector+"-btn-delete").on("click",function(){TC.confirm(t.eraseActionConfirmTxt,function(){t.deleteFeatures(t.getSelectedFeatures())})});t._$joinBtn=t._$div.find(t._classSelector+"-btn-join").on("click",function(){t.joinFeatures(t.getSelectedFeatures())});t._$splitBtn=t._$div.find(t._classSelector+"-btn-split").on("click",function(){t.splitFeatures(t.getSelectedFeatures())});t._$saveBtn=t._$div.find(t._classSelector+"-btn-save").on("click",function(){t.applyEdits()});t._$discardBtn=t._$div.find(t._classSelector+"-btn-discard").on("click",function(){t.discardEdits()});if(t.options.modes&&$.isArray(t.options.modes)&&t.options.modes.length>0){for(var i in TC.Consts.editMode)if("string"==typeof i&&t.options.modes.indexOf(TC.Consts.editMode[i])<0){$("label"+t._classSelector+"-btn-"+TC.Consts.editMode[i],t._$div).remove();$("div"+t._classSelector+"-"+TC.Consts.editMode[i],t._$div).remove()}if(1==t.options.modes.length){var n=t.options.modes[0];$("label"+t._classSelector+"-btn-"+n,t._$div).css("display","none")}}t._$div.find("input[type=radio][name=mode]").on("change",function(){var e=$(this).val(),i=t.mode===e?void 0:e;t.setMode(i)});$.isFunction(e)&&e()})};d.setLayer=function(e){var t=this;t.layer=map.getLayer(e);t.setMode(null);if(t.layer){p(t,t.layer).then(function(e){for(var i in t._changesLayers){var n=t._changesLayers[i];n.setVisibility(t._showsChanges&&n===e)}});t.layer.describeFeatureType().then(function(e){t.attributes=e.filter(function(e){switch(e.type){case"gml:LinearRingPropertyType":case"gml:PolygonPropertyType":t.geometryType=TC.Consts.geom.POLYGON;return!1;case"gml:MultiPolygonPropertyType":case"gml:MultiSurfacePropertyType":t.geometryType=TC.Consts.geom.MULTIPOLYGON;return!1;case"gml:LineStringPropertyType":t.geometryType=TC.Consts.geom.POLYLINE;return!1;case"gml:MultiLineStringPropertyType":t.geometryType=TC.Consts.geom.MULTIPOLYLINE;return!1;case"gml:PointPropertyType":case"gml:MultiPointPropertyType":t.geometryType=TC.Consts.geom.POINT;return!1;case"gml:BoxPropertyType":t.geometryType=TC.Consts.geom.RECTANGLE;return!1;case"gml:GeometryCollectionPropertyType":case"gml:GeometryAssociationType":return!1;default:return!0}});for(var i=0,n=t.attributes.length;i<n;i++){var r=t.attributes[i];r.type=r.type.substr(r.type.indexOf(":")+1)}t.renderPromise().then(function(){h(t);t._$div.find(t._classSelector+"-layer-sel").val(t.layer.id);$rb=t._$div.find("input[type=radio][name=mode]");var e;switch(t.geometryType){case TC.Consts.geom.POINT:e="[value=select],[value="+TC.Consts.editMode.ADDPOINT+"]";break;case TC.Consts.geom.POLYLINE:case TC.Consts.geom.MULTIPOLYLINE:e="[value=select],[value="+TC.Consts.editMode.ADDLINE+"]";break;case TC.Consts.geom.POLYGON:case TC.Consts.geom.MULTIPOLYGON:e="[value=select],[value="+TC.Consts.editMode.ADDPOLYGON+"]";break;default:e="[value]"}var i=$rb.filter(e).attr("disabled",!1);$rb.not(i).attr("disabled",!0)})});t._layerDeferred.resolve(t.layer)}else{t.renderPromise().then(function(){h(t,!1);$rb=t._$div.find("input[type=radio][name=mode]").attr("disabled",!0);$rb.each(function(e,t){$(t).prop("checked",!1)})});t._layerDeferred.resolve(null)}};d.setMode=function(e){var t=this;t.mode=e;!function(e){e._$deleteBtn.prop("disabled",!0);e._$joinBtn.prop("disabled",!0);e._$splitBtn.prop("disabled",!0)}(t);var i,n,r=function(e){if(e){t.snapping&&(e.snapping=t.layer);e.activate()}};switch(e){case TC.Consts.editMode.SELECT:i=t._$div.find(t._classSelector+"-select");n=t._$div.find(t._classSelector+"-point,"+t._classSelector+"-line,"+t._classSelector+"-polygon");t.activate();break;case TC.Consts.editMode.ADDPOINT:i=t._$div.find(t._classSelector+"-point");n=t._$div.find(t._classSelector+"-select,"+t._classSelector+"-line,"+t._classSelector+"-polygon");r(t.pointDraw);break;case TC.Consts.editMode.ADDLINE:i=t._$div.find(t._classSelector+"-line");n=t._$div.find(t._classSelector+"-select,"+t._classSelector+"-point,"+t._classSelector+"-polygon");r(t.lineDraw);break;case TC.Consts.editMode.ADDPOLYGON:i=t._$div.find(t._classSelector+"-polygon");n=t._$div.find(t._classSelector+"-select,"+t._classSelector+"-point,"+t._classSelector+"-line");r(t.polygonDraw);break;default:i=$();n=t._$div.find(t._classSelector+"-select,"+t._classSelector+"-point,"+t._classSelector+"-line,"+t._classSelector+"-polygon");t.isActive&&t.deactivate();t.pointDraw&&t.pointDraw.isActive&&t.pointDraw.deactivate();t.lineDraw&&t.lineDraw.isActive&&t.lineDraw.deactivate();t.polygonDraw&&t.polygonDraw.isActive&&t.polygonDraw.deactivate()}e?t._$div.find("input[type=radio][name=mode][value="+e+"]").prop("checked",!0).addClass(TC.Consts.classes.CHECKED).next().addClass(TC.Consts.classes.CHECKED):t._$div.find("input[type=radio][name=mode]").prop("checked",!1).removeClass(TC.Consts.classes.CHECKED).next().removeClass(TC.Consts.classes.CHECKED);i.removeClass(TC.Consts.classes.HIDDEN);n.addClass(TC.Consts.classes.HIDDEN)};d.showChanges=function(e){this._showsChanges=e;for(var t in this._changesLayers){this._changesLayers[t].setVisibility(e&&this.layer&&t===this.layer.id)}};d.cancel=function(){this.options.modes&&$.isArray(this.options.modes)&&1==this.options.modes.length?this.setMode(this.options.modes[0],null):this.setMode(null,!1);this.wrap.cancel(!0,this.cancelActionConfirmTxt)};d.onFeatureClick=function(e){self.activeControl&&self.activeControl.isExclusive()||e.feature.show()};d.activate=function(e){var t=this;TC.Control.prototype.activate.call(t);var i=e||{};t._$cancelBtn.prop("disabled",!1);$.when(t.getLayer()).then(function(){t.wrap.activate(i.mode?i.mode:t.mode);TC.Control.prototype.activate.call(t)})};d.deactivate=function(){TC.Control.prototype.deactivate.call(this);this.wrap.cancel(!0);this._$cancelBtn.prop("disabled",!0);this.wrap.deactivate()};d.isExclusive=function(){return!0};d.joinFeatures=function(e){var t=this;if(t.geometryType===TC.Consts.geom.MULTIPOLYLINE||t.geometryType===TC.Consts.geom.MULTIPOLYGON||t.geometryType===TC.Consts.geom.MULTIPOINT){t._joinedFeatureAttributes=[];if(e.length>1){for(var i=e.map(function(e){t._joinedFeatureAttributes[t._joinedFeatureAttributes.length]=e.getData();return e.geometry}).reduce(function(e,t){return e.concat(t)}),n=new e[0].constructor(i),r=0,s=e.length;r<s;r++){var a=e[r];t.layer.removeFeature(a);t.$events.trigger($.Event(TC.Consts.event.FEATUREREMOVE,{feature:a}))}t.layer.addFeature(n).then(function(e){t.setSelectedFeatures([n]);t.$events.trigger($.Event(TC.Consts.event.FEATUREADD,{feature:e}));e.showPopup(t.attributeEditor)})}c(t,[n])}};d.splitFeatures=function(e){for(var t=this,i=e.filter(l),n=i.map(function(e){return e.geometry}),r=[],s=0,a=i.length;s<a;s++)for(var o=(f=i[s]).getData(),u=n[s],h=0,p=u.length;h<p;h++)r[r.length]=new f.constructor([u[h]],{data:o});s=0;for(var d=i.length;s<d;s++){var f=i[s];t.layer.removeFeature(f);t.$events.trigger($.Event(TC.Consts.event.FEATUREREMOVE,{feature:f}))}var m=new Array(r.length);for(s=0,d=r.length;s<d;s++){(m[s]=t.layer.addFeature(r[s])).then(function(e){t.$events.trigger($.Event(TC.Consts.event.FEATUREADD,{feature:e}))})}$.when.apply(this,m).then(function(){t.setSelectedFeatures(r)});c(t,r)};d.deleteFeatures=function(e){this.wrap.deleteFeatures(e);0===this.layer.features.length&&this._$deleteBtn.prop("disabled",!0)};d.applyEdits=function(){var e=this;if(e.layer){var t=e.features[e.layer.id];e.layer.applyEdits(t.added,t.modified,t.removed).then(function(){e.discardEdits();e.map.toast("Cambios sincronizados con \xe9xito con el servidor")},function(e){TC.error("Error ["+e.code+"] al guardar cambios: "+e.reason)})}};d.discardEdits=function(){var e=this;e._joinedFeatureAttributes=[];var t=r(e);TC.loadJS(!window.localforage,[TC.Consts.url.LOCALFORAGE],function(){localforage.keys().then(function(i){if(i){for(var n=0,r=i.length;n<r;n++){var s=i[n];0===s.indexOf(t)&&localforage.removeItem(s)}if(e.layer){var a=e.features[e.layer.id];a.added.length=0;a.modified.length=0;a.removed.length=0;e.setSelectedFeatures([]);e.attributeEditor.hide();e._changesLayers[e.layer.id].clearFeatures();e.deleteCache(t).then(function(){e.layer.refresh()})}h(e,!1)}})})};d.getSelectedFeatures=function(){return this.wrap.getSelectedFeatures()};d.setSelectedFeatures=function(e){return this.wrap.setSelectedFeatures(e)};d.getLayer=function(){return this.layer||this._layerDeferred};d.getChangesLayerStyle=function(e){var t=function(t){for(var i,n=e.wrap.getRGBA(t),r=0;r<3;r++)n[r]=255-n[r];4===(i=(65536*n[0]+256*n[1]+n[2]).toString(16)).length?i="00"+i:5===i.length&&(i="0"+i);return"#"+i},i=[1,3],n=$.extend(!0,{},e.options.styles);if(n.point){n.point.strokeColor=t(n.point.strokeColor);n.point.lineDash=i}if(n.line){n.line.strokeColor=t(n.line.strokeColor);n.line.lineDash=i}if(n.polygon){n.polygon.strokeColor=t(n.polygon.strokeColor);n.polygon.lineDash=i}return n}}();TC.control=TC.control||{};TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control");TC.control.ExternalWMS=function(e){if(TC.isLegacy)console.warn("El control ExternalWMS no soporta modo legacy");else{this.count=0;this._addedUrls=[];TC.Control.apply(this,arguments);this.allowReprojection="boolean"!=typeof this.options.allowReprojection||this.options.allowReprojection}};TC.inherit(TC.control.ExternalWMS,TC.Control);!function(){var e=TC.control.ExternalWMS.prototype;e.CLASS="tc-ctl-xwms";e.markServicesAsSelected=function(e){if(e.length>0){var t=$(e[0]);t.attr("disabled","true");t.addClass("tc-ctl-xwms-option-selected")}};e.register=function(e){if(TC.isLegacy)console.warn("El control ExternalWMS no soporta modo legacy");else{var t=this;TC.Control.prototype.register.call(t,e);t._$div.on("change","select",function(e){if(""!=this.value){var i=this.value;0===i.indexOf("//")&&(i=location.protocol+i);t._$div.find("input").val(i);$(this).val("")}});t._$div.on("click","button[name='agregar']",function(e){var i=t._$div.find("input").val().trim();if(i)if(/^((https?|ftp):)?(\/\/)?(((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?(((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?)(:\d*)?)(\/((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)?(\?((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(\#((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/i.test(i))if(t._addedUrls.indexOf(i)>-1)TC.alert(t.getLocaleString("serviceAlreadyAdded"));else{var n=t.map.getControlsByClass("TC.control.LoadingIndicator")[0];n.show();var r=TC.Util.getQueryStringParams(i),s=["version","service","request"],a=function(e,t){for(var i=0;i<t.length;i++)e=TC.Util.removeURLParameter(e,t[i]);e.match(/\?$/)&&(e=e.substr(0,e.length-1));return e}(i,Object.keys(r));for(var o in r)s.indexOf(o.toLowerCase())>=0&&delete r[o];var l=t._$div.find("button");l.attr("disabled","true");for(var c={id:"xwms"+ ++t.count,type:"WMS",url:a,hideTree:!1,queryParams:r},u=0;u<t.options.suggestions.length;u++){var h=$.grep(t.options.suggestions[u].items,function(e,t){return e.url===i});if(h.length>0&&h[0].layerNames){c.layerNames=h[0].layerNames;break}}var p=new TC.layer.Raster(c);p.getCapabilitiesPromise().then(function(e){if(void 0!==e.Capability){var r=e.Capability.Layer;if(!r.CRS||-1!=r.CRS.indexOf(t.map.crs)||t.allowReprojection){t.map.$events.trigger($.Event(TC.Consts.event.EXTERNALSERVICEADDED,{layer:p}));t._$div.find("input").val("");var s=t._$div.find("select option[value='"+i+"']");t.markServicesAsSelected(s);t._addedUrls.push(i);n.hide();l.removeAttr("disabled")}else{TC.alert(t.getLocaleString("serviceSrsNotCompatible"));n.hide();l.removeAttr("disabled")}}else{TC.alert(t.getLocaleString("noLayersFoundInService"));n.hide();l.removeAttr("disabled")}},function(e){TC.alert(t.getLocaleString("serviceCouldNotBeLoaded")+":\n"+e);n.hide();l.removeAttr("disabled")})}else TC.alert(t.getLocaleString("typeAValidAddress"));else TC.alert(t.getLocaleString("typeAnAddress"))});e.on(TC.Consts.event.LAYERADD,function(e){if(e.layer&&!e.layer.isBase){var i=e.layer.url;if(i){t.pending_markServicesAsSelected=t.pending_markServicesAsSelected||[];0===t._$div.find("select option").length&&i&&-1===t.pending_markServicesAsSelected.indexOf(i)&&t.pending_markServicesAsSelected.push(i);var n=t._$div.find("select option").filter(function(e,t){return TC.Util.addProtocol(t.value)===TC.Util.addProtocol(i)});t.markServicesAsSelected(n);t._addedUrls.push(i)}}})}};e.template={};TC.isDebug?e.template[e.CLASS]=TC.apiLocation+"TC/templates/ExternalWMS.html":e.template[e.CLASS]=function(){dust.register(e.CLASS,t);function t(e,t){return e.x(t.get(["title"],!1),t,{block:i},{}).w('<div><div class="tc-group tc-ctl-xwms-cnt"> <select id="add-wms-select" class="tc-combo" title="WMS (Web Map Service)"><option value="">WMS</option>').s(t.get(["suggestions"],!1),t,{block:n},{}).w('</select><input type="text" class="tc-textbox" placeholder="').h("i18n",t,{},{$key:"writeAddressOrSelect"}).w('" /></div><div class="tc-group tc-group tc-ctl-xwms-cnt" style="text-align:right;"><button type="button" class="tc-button tc-icon-button" title="').h("i18n",t,{},{$key:"addService.title"}).w('" name="agregar">').h("i18n",t,{},{$key:"addService"}).w("</button></div></div>")}t.__dustBody=!0;function i(e,t){return e.w("<h2>").h("i18n",t,{},{$key:"addMaps"}).w("</h2>")}i.__dustBody=!0;function n(e,t){return e.x(t.get(["group"],!1),t,{block:r},{}).s(t.get(["items"],!1),t,{block:s},{}).x(t.get(["group"],!1),t,{block:a},{})}n.__dustBody=!0;function r(e,t){return e.w('<optgroup label="').f(t.get(["group"],!1),t,"h").w('">')}r.__dustBody=!0;function s(e,t){return e.w('<option value="').f(t.get(["url"],!1),t,"h").w('">').f(t.get(["name"],!1),t,"h").w("</option>")}s.__dustBody=!0;function a(e,t){return e.w("\t</optgroup>")}a.__dustBody=!0;return t};e.render=function(e){var t=this;t.renderData(t.options,function(){t.pending_markServicesAsSelected=t.pending_markServicesAsSelected||[];t.pending_markServicesAsSelected.forEach(function(e){var i=t._$div.find("select option").filter(function(t,i){return TC.Util.addProtocol(i.value)===TC.Util.addProtocol(e)});t.markServicesAsSelected(i);t._addedUrls.push(e)});t.pending_markServicesAsSelected=[]})}}();TC.control=TC.control||{};TC.control.FeatureInfoCommons||TC.syncLoadJS(TC.apiLocation+"TC/control/FeatureInfoCommons");!function(){TC.control.FeatureInfo=function(){var e=this;TC.control.FeatureInfoCommons.apply(this,arguments);e.wrap=new TC.wrap.control.FeatureInfo(e);TC.Consts.classes.FROMLEFT="tc-fromleft";TC.Consts.classes.FROMRIGHT="tc-fromright";e.options.displayElevation&&TC.loadJS(!TC.tool||!TC.tool.Elevation,TC.apiLocation+"TC/tool/Elevation",function(){const t="boolean"==typeof e.options.displayElevation?{}:e.options.displayElevation;e.elevation=new TC.tool.Elevation(t)})};TC.inherit(TC.control.FeatureInfo,TC.control.FeatureInfoCommons);var e=TC.control.FeatureInfo.prototype;e.FEATURE_PARAM="showfeature";var t=function e(t,i){var n;if($.isArray(t))for(var r=0,s=(n=t.slice()).length;r<s;r++)n[r]=e(n[r]);else n="number"==typeof t?Math.round(t.toFixed(i)):t;return n};e.register=function(e){var t=this;TC.control.FeatureInfoCommons.prototype.register.call(t,e);t._$div.appendTo("<div>");e.loaded(function(){t._layersDeferred.then(function(){var e=TC.Util.getParameterByName(t.FEATURE_PARAM);if(e){var i;try{i=JSON.parse(decodeURIComponent(escape(window.atob(e))))}catch(e){TC.error(TC.Util.getLocaleString(t.map.options.locale,"sharedFeatureNotValid"),TC.Consts.msgErrorMode.TOAST)}i&&function(e,t){if(0!==jQuery.grep(e.map.workLayers,function(e,i){return e.type===TC.Consts.layerType.WMS&&e.url===t.s&&e.getDisgregatedLayerNames().indexOf(t.l)>=0}).length){e.sharedFeatureInfo=t;TC.loadJS(!window.hex_md5,[TC.apiLocation+TC.Consts.url.HASH],function(){const i=[-100,-100];e.beforeRequest({xy:i});e.filterLayer.clearFeatures();$.when(e.filterLayer.addMarker(i)).then(function(i){e.filterFeature=i;e.wrap.getFeatureInfo(t.xy,t.r,{serviceUrl:t.s,layerName:t.l,featureId:t.f})})})}else TC.error(TC.Util.getLocaleString(e.map.options.locale,"sharedFeatureNotValid"),TC.Consts.msgErrorMode.TOAST)}(t,i)}})})};e.onShowModal=function(){var e=this,i=$(e.getDisplayTarget()).find("ul."+e.CLASS+"-features li."+TC.Consts.classes.CHECKED),n=e._shareCtl;n.extraParams=null;var r=i.parents("li").first(),s=r.parents("li").first(),a=e.info.services[s.index()];if(a){var o=a.layers[r.index()];if(o){var l=o.features[i.index()];TC.loadJS(!window.hex_md5,[TC.apiLocation+TC.Consts.url.HASH],function(){var i=hex_md5(JSON.stringify({data:l.getData(),geometry:t(l.geometry,TC.Consts.DEGREE_PRECISION)}));n.extraParams={};n.extraParams[e.FEATURE_PARAM]=window.btoa(unescape(encodeURIComponent(JSON.stringify({xy:l.wrap.getInnerPoint(),r:e.map.getResolution(),s:a.mapLayer.url,l:o.name,f:l.id,h:i}))));var r=n._$div;r.find(".tc-url input[type=text]").val(n.generateLink());r.find(".tc-iframe input[type=text]").val(n.generateIframe())})}}};e.callback=function(e,t){var i=this;if(i.elevation){i.querying=!0;i.elevationRequest=i.elevation.getElevation({crs:i.map.crs,coordinates:e})}if(i.map&&i.filterLayer){var n=i.getLocaleString("featureInfo"),r=$.extend({},i.map.options.styles.marker,i.markerStyle,{title:n,set:n});i.displayMode!==TC.control.FeatureInfoCommons.POPUP&&(r.showsPopup=!1);i.filterLayer.clearFeatures();$.when(i.filterLayer.addMarker(e,r)).then(function(t){i.map.putLayerOnTop(i.filterLayer);i.filterFeature=t;for(var n=!1,r=0;r<i.map.workLayers.length;r++){var s=i.map.workLayers[r];if(s.type===TC.Consts.layerType.WMS&&s.getVisibility()&&s.names.length>0){n=!0;break}}var a=i.map.getResolution();n?i.wrap.getFeatureInfo(e,a):i.responseCallback({coords:e})})}};e.responseCallback=function(e){var i=this;const n=function(n){TC.control.FeatureInfoCommons.prototype.responseCallback.call(i,e);i.querying=!0;if(i.filterFeature){var r=e.services;i.info={services:r,defaultFeature:e.defaultFeature};if(r)for(var s=0;s<r.length;s++){for(var a=r[s],o=0;o<a.layers.length;o++)if(!a.layers[o].features.length){a.layers.splice(o,1);o-=1}if(!a.layers.length){r.splice(s,1);s-=1}}var l=i.map.options.locale||TC.Cfg.locale;e.isGeo=i.map.wrap.isGeo();if(n.length){const t=n[0][2];e.elevation=null===t?null:TC.Util.formatNumber(Math.round(t),l)}if(e.coords){e.crs=i.map.crs;e.coords=e.coords.map(function(t){return TC.Util.formatNumber(t.toFixed(e.isGeo?TC.Consts.DEGREE_PRECISION:TC.Consts.METER_PRECISION),l)})}if(r&&r.length||null!==e.elevation)i.renderData(e,function(){i.insertLinks();if(i.sharedFeatureInfo){i._$div.find("ul."+i.CLASS+"-services li").addClass(TC.Consts.classes.CHECKED);for(var e,n=i.sharedFeatureInfo,r=0,s=i.info.services.length;r<s;r++){var a=i.info.services[r];if(a.mapLayer.url===n.s){for(var o=0,l=a.layers.length;o<l;o++){var c=a.layers[o];if(c.name===n.l){for(var u=0,h=c.features.length;u<h;u++){var p=c.features[u];if(p.id===n.f){e=p;var d=hex_md5(JSON.stringify({data:p.getData(),geometry:t(p.geometry,TC.Consts.DEGREE_PRECISION)}));n.h!==d&&TC.alert(i.getLocaleString("finfo.featureChanged.warning"));break}}break}}break}}e&&i.map.addControl("popup",{div:TC.Util.getDiv(),closeButton:!0}).then(function(t){e.data=i._$div.html();t.$popupDiv.addClass(i.CLASS+"-lite");i.getLocaleString("deleteFeature");i.getRenderedHtml(i.CLASS+"-del-btn",null,function(e){t.$popupDiv.append(e);t.$popupDiv.find("."+i.CLASS+"-del-btn").on(TC.Consts.event.CLICK,function(e){TC.confirm(i.getLocaleString("deleteFeature.confirm"),function(){i.map.removeLayer(i.sharedFeatureLayer);delete i.sharedFeatureLayer})})});e.showsPopup=!0;e.popup=t;i.map.addLayer({id:i.getUID(),type:TC.Consts.layerType.VECTOR,title:i.getLocaleString("foi")}).then(function(t){i.sharedFeatureLayer=t;i.filterLayer.clearFeatures();t.addFeature(e);i.map.zoomToFeatures([e])});i.map.on(TC.Consts.event.POPUP,function(n){n.control===t&&t.$popupDiv.find("table").on(TC.Consts.event.CLICK,function(t){i.map.zoomToFeatures([e])})})});delete i.sharedFeatureInfo}else i.displayResults()});else{i.resultsLayer.clearFeatures();i.filterLayer.clearFeatures()}i.querying=!1}};i.elevationRequest?i.elevationRequest.then(n):n([])}}();TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control");TC.control.FileImport=function(){TC.Control.apply(this,arguments);$.isArray(this.options.formats)?this.formats=this.options.formats:this.formats=[TC.Consts.format.KML,TC.Consts.format.GML,TC.Consts.format.GML2,TC.Consts.format.GEOJSON,TC.Consts.format.WKT,TC.Consts.format.GPX];this.apiAttribution="";this.mainDataAttribution="";this.dataAttributions=[]};TC.inherit(TC.control.FileImport,TC.Control);!function(){var e=TC.control.FileImport.prototype;e.CLASS="tc-ctl-file";TC.isDebug?e.template=TC.apiLocation+"TC/templates/FileImport.html":e.template=function(){dust.register(e.CLASS,t);function t(e,t){return e.w("<h2>").h("i18n",t,{},{$key:"openFile"}).w("</h2><div><p>").h("i18n",t,{},{$key:"fileImport.instructions"}).w('</p><div class="tc-ctl-file-open"><label class="tc-button tc-ctl-file-open-label tc-icon-button"><input type="file" class="tc-ctl-file-open-ipt tc-button" accept="').s(t.get(["formats"],!1),t,{block:i},{}).w('" />').h("i18n",t,{},{$key:"openFile"}).w("</label></div></div>")}t.__dustBody=!0;function i(e,t){return e.w(".").f(t.getPath(!0,[]),t,"h").h("sep",t,{block:n},{})}i.__dustBody=!0;function n(e,t){return e.w(",")}n.__dustBody=!0;return t};e.register=function(e){var t=this;TC.Control.prototype.register.call(t,e);t.options.enableDragAndDrop&&e.wrap.enableDragAndDrop(t.options);e.on(TC.Consts.event.FEATURESIMPORT,function(i){var n="."+TC.Consts.format.GPX.toLowerCase();i.fileName.toLowerCase().indexOf(n)!==i.fileName.length-n.length&&e.addLayer({id:t.getUID(),title:i.fileName,type:TC.Consts.layerType.VECTOR}).then(function(n){const r=function(e,t){return e.concat(t)};for(var s=function(e){var i=e.geometry;if(i){var n;switch(!0){case TC.feature.Point&&e instanceof TC.feature.Point:n=[i];break;case TC.feature.MultiPoint&&e instanceof TC.feature.MultiPoint:case TC.feature.Polyline&&e instanceof TC.feature.Polyline:n=i;break;case TC.feature.MultiPolyline&&e instanceof TC.feature.MultiPolyline:case TC.feature.Polygon&&e instanceof TC.feature.Polygon:n=i.reduce(r);break;case TC.feature.MultiPolygon&&e instanceof TC.feature.MultiPolygon:n=i.reduce(r).reduce(r)}n.every(function(e){return Math.abs(e[0])<=180&&Math.abs(e[1])<=90})&&e.setCoords(TC.Util.reproject(i,"EPSG:4326",t.map.crs))}return e},a=0,o=i.features.length;a<o;a++){var l=s(i.features[a]);n.addFeature(l)}setTimeout(function(){e.zoomToFeatures(n.features)},100)})}).on(TC.Consts.event.FEATURESIMPORTERROR,function(e){var i,n=e.file.name;i=".kmz"===n.toLowerCase().substr(n.length-4)?"fileImport.error.reasonKmz":"fileImport.error.reasonUnknown";TC.error(t.getLocaleString(i,{fileName:n}),TC.Consts.msgErrorMode.TOAST);var r=new FileReader;r.onload=function(e){TC.error("Nombre del archivo: "+n+" \n Contenido del archivo: \n\n"+e.target.result,TC.Consts.msgErrorMode.EMAIL,"Error en la subida de un archivo")};r.readAsText(e.file)})};e.render=function(){var e=this;e.renderData({formats:e.formats},function(){e._$div.find("input[type=file]").on(TC.Consts.event.CLICK,function(e){$(this).wrap("<form>").closest("form").get(0).reset();$(this).unwrap()}).on("change",function(t){if(e.map){console.log("salta el change");e.map.wrap.loadFiles(t.target.files)}})})}}();TC.control=TC.control||{};TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control");TC.control.FullScreen=function(){TC.Control.apply(this,arguments);this.fullScreenElement=document.documentElement};TC.inherit(TC.control.FullScreen,TC.Control);!function(){var e=TC.control.FullScreen.prototype;e.CLASS="tc-ctl-fscreen";TC.isDebug?e.template=TC.apiLocation+"TC/templates/FullScreen.html":e.template=function(){dust.register(e.CLASS,t);function t(e,t){return e.w('<button class="tc-ctl-fscreen-btn" title="').h("i18n",t,{},{$key:"fscreen.tip"}).w('"></button>')}t.__dustBody=!0;return t};e.register=function(e){var t=this;TC.Control.prototype.register.call(t,e);t.renderPromise().then(function(){var e=t._$div.find("."+t.CLASS+"-btn");if(t.enabledFullScreen()){e.on("click",function(){t.toggleFullScreen()});$(document).on("fullscreenchange mozfullscreenchange webkitfullscreenchange MSFullscreenChange",function(){e.toggleClass(TC.Consts.classes.ACTIVE,t.isFullScreen());e.attr("title",t.isFullScreen()?t.getLocaleString("fscreen.tip.return"):t.getLocaleString("fscreen.tip"))})}else e.addClass(TC.Consts.classes.HIDDEN)})};e.requestFullScreen=function(){var e=this.fullScreenElement;document.documentElement.requestFullScreen?e.requestFullScreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullScreen?e.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT):e.msRequestFullscreen&&e.msRequestFullscreen()};e.cancelFullScreen=function(){document.cancelFullScreen?document.cancelFullScreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitCancelFullScreen?document.webkitCancelFullScreen():document.msExitFullscreen&&document.msExitFullscreen()};e.isFullScreen=function(){return document.fullScreenElement||document.mozFullScreen||document.webkitIsFullScreen||document.msFullscreenElement};e.toggleFullScreen=function(){this.isFullScreen()?this.cancelFullScreen():this.requestFullScreen()};e.enabledFullScreen=function(){var e=this.fullScreenElement,t=document.documentElement.requestFullScreen||e.mozRequestFullScreen||e.webkitRequestFullScreen||e.msRequestFullscreen;return t&&"function"==typeof t}}();Math.hypot=Math.hypot||function(){for(var e=0,t=arguments.length,i=0;i<t;i++){if(arguments[i]===1/0||arguments[i]===-1/0)return 1/0;e+=arguments[i]*arguments[i]}return Math.sqrt(e)};!function(){for(var e=0,t=["ms","moz","webkit","o"],i=!(!window.performance||!window.performance.now),n=0,r=t.length;n<r&&!window.requestAnimationFrame;n+=1){window.requestAnimationFrame=window[t[n]+"RequestAnimationFrame"];window.cancelAnimationFrame=window[t[n]+"CancelAnimationFrame"]||window[t[n]+"CancelRequestAnimationFrame"]}window.requestAnimationFrame||(window.requestAnimationFrame=function(t,i){var n=(new Date).getTime(),r=Math.max(0,16-(n-e)),s=window.setTimeout(function(){t(n+r)},r);e=n+r;return s});window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)});if(!i){var s=window.requestAnimationFrame,a=+new Date;window.requestAnimationFrame=function(e,t){s(function(t){return e(t<1e12?t:t-a)},t)}}}();!function(){if(window.performance){if(window.performance&&!window.performance.now){window.performance.offset=Date.now();window.performance.now=function(){return Date.now()-window.performance.offset}}}else window.performance={offset:Date.now(),now:function(){return Date.now()-this.offset}}}();TC.control=TC.control||{};TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control");TC.control.Geolocation=function(e){this.$events=$(this);this._classSelector="."+this.CLASS;this.Const={Classes:{ACTIVE:"tc-ctl-geolocation-active",CLOSED:"closed",SELECTEDTRACK:"selectedTrack",DRAWACTIVATED:"draw-activated",SIMULATIONACTIVATED:"simulation-activated"},Selector:{SIMULATE:".tc-btn-simulate",DRAW:".tc-draw",EDIT:".tc-btn-edit",DELETE:".tc-btn-delete",SAVE:".tc-btn-save",CANCEL:".tc-btn-cancel",EXPORT_GPX:".tc-btn-export-gpx",EXPORT_KML:".tc-btn-export-kml",STOP:".tc-btn-stop",PAUSE:".tc-btn-pause",BACKWARD:".tc-btn-backward",FORWARD:".tc-btn-forward",SPEED:".tc-spn-speed"},LocalStorageKey:{TRACKING:"trk",TRACKINGTEMP:"trktemp",TRACKINGSHOWADVERTISEMENT:"trkAdvertisement",GPSSHOWADVERTISEMENT:"gpsAdvertisement",TEST:"test"},Message:{VALIDATENAME:""},Event:{POSITIONCHANGE:"positionchange.tc.geolocation",GPSPOSITIONCHANGE:"gpspositionchange.tc.geolocation",GPSPOSITIONERROR:"positionerror.tc.geolocation",STATEUPDATED:"stateupdated.tc.geolocation",GPSADD:"gpsadd.tc.geolocation",TRACKSNAPPING:"tracksnapping.tc.geolocation",DRAWTRACK:"drawtrack.tc.geolocation",CLEARTRACK:"cleartrack.tc.geolocation",IMPORTEDTRACK:"importedtrack.tc.geolocation"},MimeMap:{KML:"application/vnd.google-earth.kml+xml",GPX:"application/gpx+xml"},SupportedFileExtensions:[".kml",".gpx"],Tabs:{GPS:"gps"},Layers:{GPS:"gps",TRACK:"track",TRACKING:"tracking"}};TC.Control.apply(this,arguments);var t=e||{};this._$dialogDiv=$(TC.Util.getDiv(t.dialogDiv));t.dialogDiv||this._$dialogDiv.appendTo("body");this.delta=500;this.walkingSpeed=5e3;this.gapHill=this.options.gapHill||20;this._trackingLayerDeferred=$.Deferred()};TC.inherit(TC.control.Geolocation,TC.Control);!function(){var e=TC.control.Geolocation.prototype;e.CLASS="tc-ctl-geolocation";e.CHART_SIZE={MIN_HEIGHT:70,MAX_HEIGHT:128,MIN_WIDTH:215,MEDIUM_WIDTH:310,MAX_WIDTH:445};TC.Consts.event.TOOLSCLOSE=TC.Consts.event.TOOLSCLOSE||"toolsclose.tc";TC.Consts.event.TOOLSOPEN=TC.Consts.event.TOOLSOPEN||"toolsopen.tc";e.template={};if(TC.isDebug){e.template[e.CLASS]=TC.apiLocation+"TC/templates/Geolocation.html";e.template[e.CLASS+"-track-node"]=TC.apiLocation+"TC/templates/GeolocationTrackNode.html";e.template[e.CLASS+"-track-snapping-node"]=TC.apiLocation+"TC/templates/GeolocationTrackSnappingNode.html";e.template[e.CLASS+"-dialog"]=TC.apiLocation+"TC/templates/GeolocationDialog.html";e.template[e.CLASS+"-tracking-toast"]=TC.apiLocation+"TC/templates/GeolocationTrackingToast.html"}else{e.template[e.CLASS]=function(){dust.register(e.CLASS,t);function t(e,t){return e.w("<h2>").h("i18n",t,{},{$key:"geo"}).w(' <span class="tc-beta tc-hidden">').h("i18n",t,{},{$key:"beta"}).w('</span></h2><div class="tc-ctl-geolocation-content"> <div class="tc-ctl-geolocation-track"><div class="tc-ctl-geolocation-track-snap-info"></div><div class="tc-ctl-geolocation-info-tracking tc-hidden"><div class="tc-ctl-p-results"><div class="prpanel-group prsidebar-body "><div class="prpanel prpanel-default"><div class="prpanel-heading"><h4 class="prpanel-title"><label>').h("i18n",t,{},{$key:"geo.mylocation"}).w('</label> <span id="trackingInfoClose" class="prcollapsed-pull-right prcollapsed-slide-submenu prcollapsed-slide-submenu-close" title="').h("i18n",t,{},{$key:"close"}).w('"><i class="fa fa-times"></i></span><span id="trackingInfoMin" class="prcollapsed-pull-right prcollapsed-slide-submenu prcollapsed-slide-submenu-min" title="').h("i18n",t,{},{$key:"hide"}).w('"><i class="fa fa-chevron-left"></i></span> </h4></div><div id="results" class="prpanel-collapse"><div class="prpanel-body list-group"> </div> </div></div></div><div id="trackingInfoMax" class="prcollapsed prcollapsed-max prcollapsed-pull-left" style="display: none;" title="').h("i18n",t,{},{$key:"geo.trk.panel.3"}).w('"><i class="fa fa-list-alt tracking"></i></div></div></div>\x3c!-- img se insertan en el div del mapa--\x3e <div id="tc-ctl-geolocation-track-elevation-marker" class="tc-ctl-geolocation-trackMarker elevation" style="display: none;" /> <div class="tc-ctl-geolocation-track-panel-block" ><input id="tc-ctl-geolocation-track-panel-opened" type="checkbox" checked/><label for="tc-ctl-geolocation-track-panel-opened" title="').h("i18n",t,{},{$key:"geo.trk.panel.help.1"}).w('">').h("i18n",t,{},{$key:"geo.trk.panel.help.2"}).w('</label><i class="tc-ctl-geolocation-track-panel-help icon-question-sign" title="').h("i18n",t,{},{$key:"geo.trk.panel.help.3"}).w('"></i></div><div class="tc-ctl-geolocation-track-mng"><div class="tc-ctl-geolocation-select"><form> <label class="tc-ctl-geolocation-btn-track" title="').h("i18n",t,{},{$key:"geo.track.title"}).w('"><input type="radio" name="mode" checked value="tracks" /><span>').h("i18n",t,{},{$key:"geo.gps"}).w('</span></label><label class="tc-ctl-geolocation-btn-tracks" title="').h("i18n",t,{},{$key:"geo.tracks.title"}).w('"><input type="radio" name="mode" value="track-available" /><span>').h("i18n",t,{},{$key:"geo.tracks"}).w('</span></label> </form></div> <div class="tc-ctl-geolocation-track-available tc-ctl-geolocation-track-cnt tc-ctl-geolocation-panel tc-hidden"><i class="tc-ctl-geolocation-track-search-icon"></i><input id="tc-ctl-geolocation-track-available-srch" type="search" list="tc-ctl-geolocation-track-available-lst" class="tc-ctl-geolocation-track-available-srch tc-textbox" placeholder="').h("i18n",t,{},{$key:"geo.filter.plhr"}).w('" maxlength="200" /> <ol id="tc-ctl-geolocation-track-available-lst" class="tc-ctl-geolocation-track-available-lst"><li class="tc-ctl-geolocation-track-available-empty"><span>').h("i18n",t,{},{$key:"geo.noTracks"}).w('</span></li><li class="tc-ctl-geolocation-track-not" hidden><span>').h("i18n",t,{},{$key:"noMatches"}).w('</span></li></ol><div class="tc-ctl-geolocation-track-cnt"><input name="uploaded-file" id="uploaded-file" type="file" class="tc-ctl-geolocation-track-import tc-button" accept=".gpx,.kml" disabled /><label class="tc-button tc-icon-button" for="uploaded-file" title="').h("i18n",t,{},{$key:"geo.trk.import.upload"}).w('">').h("i18n",t,{},{$key:"geo.trk.import.lbl"}).w('</label></div></div><div class="tc-ctl-geolocation-tracks tc-ctl-geolocation-panel"> <div class="tc-alert alert-warning tc-hidden" ><p id="panel-msg">').h("i18n",t,{},{$key:"geo.trk.panel.1"}).w(" <ul><li>").h("i18n",t,{},{$key:"geo.trk.panel.2"}).w("</li><li>").h("i18n",t,{},{$key:"geo.trk.panel.3"}).w("</li><li>").h("i18n",t,{},{$key:"geo.trk.panel.4"}).w("</li><li>").h("i18n",t,{},{$key:"geo.trk.panel.5"}).w('</li></ul></p></div> <div class="tc-ctl-geolocation-track-ui"> <div class="tc-ctl-geolocation-track-render"><input id="tc-ctl-geolocation-track-render" type="checkbox" hidden checked /><label for="tc-ctl-geolocation-track-render" class="tc-ctl-geolocation-track-render" title="').h("i18n",t,{},{$key:"geo.trk.render"}).w('">').h("i18n",t,{},{$key:"geo.trk.render"}).w('</label></div><button class="tc-button tc-icon-button tc-ctl-geolocation-track-ui-activate" title="').h("i18n",t,{},{$key:"geo.track.activate.title"}).w('">').h("i18n",t,{},{$key:"geo.track.activate"}).w('</button><button class="tc-button tc-icon-button tc-ctl-geolocation-track-ui-deactivate tc-hidden" title="').h("i18n",t,{},{$key:"geo.track.deactivate.title"}).w('">').h("i18n",t,{},{$key:"geo.track.deactivate"}).w('</button></div><div class="tc-ctl-geolocation-track-current tc-ctl-geolocation-track-cnt"><input type="text" class="tc-ctl-geolocation-track-title tc-textbox" disabled placeholder="').h("i18n",t,{},{$key:"geo.trk.name.plhr"}).w('" maxlength="200" /><button class="tc-button tc-icon-button tc-ctl-geolocation-track-save" disabled title="').h("i18n",t,{},{$key:"geo.trk.name.save"}).w('"></button><input type="text" class="tc-ctl-geolocation-track-waypoint tc-textbox" disabled placeholder="').h("i18n",t,{},{$key:"geo.trk.wyp.plhr"}).w('" maxlength="200" /><button class="tc-button tc-icon-button tc-ctl-geolocation-track-add-wpt" disabled title="').h("i18n",t,{},{$key:"geo.trk.wyp.save"}).w('"></button></div></div></div></div></div>\x3c!--se inserta en el div del mapa--\x3e<div class="tc-ctl-geolocation-track-center tc-hidden"> <button class="tc-ctl-btn tc-button tc-icon-button" title="').h("i18n",t,{},{$key:"geo.trk.center"}).w('"></button></div>')}t.__dustBody=!0;return t};e.template[e.CLASS+"-track-node"]=function(){dust.register(e.CLASS+"-track-node",t);function t(e,t){return e.w('<li data-id="').f(t.get(["id"],!1),t,"h").w('" data-uid="').f(t.get(["uid"],!1),t,"h").w('"><span class="tc-draw tc-selectable" title="').f(t.get(["name"],!1),t,"h").w('">').f(t.get(["name"],!1),t,"h").w('</span><input class="tc-textbox tc-hidden" type="text" value="').f(t.get(["name"],!1),t,"h").w('" /> <button class="tc-btn-simulate" title="').h("i18n",t,{},{$key:"tr.lst.simulate"}).w('"></button><button hidden class="tc-btn-stop" title="').h("i18n",t,{},{$key:"tr.lst.stop"}).w('"></button><button class="tc-btn-edit" title="').h("i18n",t,{},{$key:"tr.lst.edit"}).w('"></button><button hidden class="tc-btn-pause" title="').h("i18n",t,{},{$key:"tr.lst.pause"}).w('"></button> <button hidden class="tc-btn-backward" title="').h("i18n",t,{},{$key:"tr.lst.backward"}).w('"></button><label hidden class="tc-spn-speed" title="').h("i18n",t,{},{$key:"tr.lst.velocity"}).w('"></label><button hidden class="tc-btn-forward" title="').h("i18n",t,{},{$key:"tr.lst.forward"}).w('"></button> <button class="tc-btn-save tc-hidden" title="').h("i18n",t,{},{$key:"save"}).w('"></button><button class="tc-btn-cancel tc-hidden" title="').h("i18n",t,{},{$key:"tr.lst.cancel"}).w('"></button><button class="tc-btn-delete" title="').h("i18n",t,{},{$key:"tr.lst.delete"}).w('"></button><button class="tc-btn-export-gpx" title="').h("i18n",t,{},{$key:"tr.lst.exportGPX"}).w('"></button><button class="tc-btn-export-kml" title="').h("i18n",t,{},{$key:"tr.lst.exportKML"}).w('"></button> </li>')}t.__dustBody=!0;return t};e.template[e.CLASS+"-track-snapping-node"]=function(){dust.register(e.CLASS+"-track-snapping-node",t);function t(e,t){return e.w("<ul>").x(t.get(["n"],!1),t,{block:i},{}).w("<li> <span>X:</span> ").f(t.get(["x"],!1),t,"h").w(" </li><li> <span>Y:</span> ").f(t.get(["y"],!1),t,"h").w(" </li>").x(t.get(["z"],!1),t,{block:n},{}).x(t.get(["m"],!1),t,{block:s},{}).w("</ul>")}t.__dustBody=!0;function i(e,t){return e.w("<li> <span>").h("i18n",t,{},{$key:"geo.trk.snapping.name"}).w(":</span> ").f(t.get(["n"],!1),t,"h").w(" </li>")}i.__dustBody=!0;function n(e,t){return e.h("ne",t,{block:r},{key:t.get(["z"],!1),value:0}).w(" ")}n.__dustBody=!0;function r(e,t){return e.w("<li> <span>Z:</span> ").f(t.get(["z"],!1),t,"h").w(" </li>")}r.__dustBody=!0;function s(e,t){return e.w("<li> ").f(t.get(["m"],!1),t,"h").w(" </li>")}s.__dustBody=!0;return t};e.template[e.CLASS+"-dialog"]=function(){dust.register(e.CLASS+"-dialog",t);function t(e,t){return e.w('<div class="tc-ctl-geolocation-continue-track-dialog tc-modal" ><div class="tc-modal-background tc-modal-close"></div><div class="tc-modal-window"><div class="tc-modal-header"><h3>').h("i18n",t,{},{$key:"geo.gps"}).w('</h3><div class="tc-ctl-popup-close tc-modal-close"></div></div><div class="tc-modal-body"><button class="tc-button tc-ctl-geolocation-track-continue"> ').h("i18n",t,{},{$key:"geo.trk.dialog.cnt"}).w(' </button><button class="tc-button tc-ctl-geolocation-track-new"> ').h("i18n",t,{},{$key:"geo.trk.dialog.new"}).w(' </button> <button class="tc-button tc-modal-close"> ').h("i18n",t,{},{$key:"geo.trk.dialog.cancel"}).w(' </button></div></div></div><div class="tc-ctl-geolocation-track-advert-dialog tc-modal" ><div class="tc-modal-background tc-modal-close"></div><div class="tc-modal-window"><div class="tc-modal-header"><h3>').h("i18n",t,{},{$key:"geo.track.activate.title"}).w('</h3><div class="tc-ctl-popup-close tc-modal-close"></div></div><div class="tc-modal-body"><p id="pageBlurMsg">').h("i18n",t,{},{$key:"geo.trk.page.blur"}).w('</p><p class="tc-ctl-geolocation-track-advertisement p"> <label> <input type="checkbox" name="checkbox" id="advertisement"> ').h("i18n",t,{},{$key:"geo.trk.dialog.advertisement"}).w(' </label> </p></div><div class="tc-modal-footer"><button class="tc-button tc-ctl-geolocation-track-advert-ok"> ').h("i18n",t,{},{$key:"ok"}).w(" </button></div></div></div>")}t.__dustBody=!0;return t};e.template[e.CLASS+"-tracking-toast"]=function(){dust.register(e.CLASS+"-tracking-toast",t);function t(e,t){return e.w("<ul><li><span>").x(t.get(["isGeo"],!1),t,{else:i,block:n},{}).w(":</span> ").f(t.get(["x"],!1),t,"h").w("<br /><span>").x(t.get(["isGeo"],!1),t,{else:r,block:s},{}).w(":</span> ").f(t.get(["y"],!1),t,"h").w("<br />").x(t.get(["z"],!1),t,{block:a},{}).w("</li><li>").x(t.get(["accuracy"],!1),t,{block:c},{}).x(t.get(["speed"],!1),t,{block:u},{}).x(t.get(["mdt"],!1),t,{block:h},{}).w("</li></ul>")}t.__dustBody=!0;function i(e,t){return e.w("X")}i.__dustBody=!0;function n(e,t){return e.h("i18n",t,{},{$key:"lon"})}n.__dustBody=!0;function r(e,t){return e.w("Y")}r.__dustBody=!0;function s(e,t){return e.h("i18n",t,{},{$key:"lat"})}s.__dustBody=!0;function a(e,t){return e.w("<span>").x(t.get(["isGeo"],!1),t,{else:o,block:l},{}).w(":</span> ").f(t.get(["z"],!1),t,"h").w(" m<br />")}a.__dustBody=!0;function o(e,t){return e.w("Z")}o.__dustBody=!0;function l(e,t){return e.h("i18n",t,{},{$key:"ele"})}l.__dustBody=!0;function c(e,t){return e.w("<span>").h("i18n",t,{},{$key:"geo.trk.accuracy"}).w(":</span> ").f(t.get(["accuracy"],!1),t,"h").w(" m<br />")}c.__dustBody=!0;function u(e,t){return e.w("<span>").h("i18n",t,{},{$key:"geo.trk.speed"}).w(":</span> ").f(t.get(["speed"],!1),t,"h").w(" km/h<br />")}u.__dustBody=!0;function h(e,t){return e.w('<span title="').h("i18n",t,{},{$key:"mdt.title"}).w('">').h("i18n",t,{},{$key:"ele"}).w(" (").h("i18n",t,{},{$key:"mdt"}).w("):</span> ").f(t.get(["mdt"],!1),t,"h").w(" m<br />")}h.__dustBody=!0;return t}}e.register=function(e){var t=this;TC.Control.prototype.register.call(t,e);t.wrap=new TC.wrap.control.Geolocation(t);t.wrap.register(e);e.addLayer({id:t.getUID(),type:TC.Consts.layerType.VECTOR,stealth:!0,title:"Posicionar.GPS"}).then(function(e){t.layerGPS=e});e.addLayer({id:t.getUID(),type:TC.Consts.layerType.VECTOR,stealth:!0,title:"Posicionar.Tracking",styles:{point:{radius:3,fillColor:"#00ced1",fillOpacity:function(){return this.track.renderTrack.checked?1:0}.bind(t),strokeColor:"#ffffff",fontColor:"#00ced1",labelOutlineColor:"#ffffff",labelOutlineWidth:1,label:function(e){var t=e.getData().name;return t=t&&(t+"").trim().length>0?(t+"").trim().toLowerCase():""}},line:{strokeOpacity:function(){return this.track.renderTrack.checked?1:0}.bind(t),strokeWidth:2,strokeColor:"#00ced1",lineDash:[.1,6]}}}).then(function(e){t.layerTracking=e;t._trackingLayerDeferred.resolve(e)});var i=function(e){if(e.layer==this.layerTrack)switch(!0){case e.type+"."+e.namespace===TC.Consts.event.LAYERREMOVE:this.wrap.deactivateSnapping();this.getSelectedTrack()&&this.clearSelectedTrack();this.resultsPanelChart&&this.resultsPanelChart.close();this.layerTrack=void 0;break;case e.opacity>0&&e.opacity<1:return;case 0==e.layer.getVisibility():this.resultsPanelChart&&this.resultsPanelChart.minimize();case 0==e.opacity:this.wrap.deactivateSnapping();break;case 1==e.layer.getVisibility():this.resultsPanelChart&&this.resultsPanelChart.maximize();case 1==e.opacity:this.wrap.activateSnapping()}}.bind(t);t._trackLayerBindEvents=function(t){t?e.on(TC.Consts.event.LAYERVISIBILITY+" "+TC.Consts.event.LAYEROPACITY+" "+TC.Consts.event.LAYERREMOVE,i):e.off(TC.Consts.event.LAYERVISIBILITY+" "+TC.Consts.event.LAYEROPACITY+" "+TC.Consts.event.LAYERREMOVE,i)};e.on(TC.Consts.event.FEATURESIMPORT,function(e){const t=this,i=/.kml$/g.test(e.fileName.toLowerCase())&&t.importedByMe||!1;if(/.gpx$/g.test(e.fileName.toLowerCase())||i){if(i){for(var n=0;n<t.map.workLayers.slice().reverse().length;n++){var r=t.map.workLayers.slice().reverse()[n];if(r.title&&r.title.toLowerCase().trim()===e.fileName.toLowerCase().trim()){t.map.removeLayer(r);break}}t.importedByMe=!1}t.importTrack(e);i&&t.layerTrack&&t.layerTrack.styles&&t.layerTrack.features.forEach(function(e){e instanceof TC.feature.Point&&t.layerTrack.styles.point?e.setStyle(t.layerTrack.styles.point):e instanceof TC.feature.Polyline&&t.layerTrack.styles.line&&e.setStyle(t.layerTrack.styles.line)})}}.bind(t))};e.render=function(e){var t=this;t.getRenderedHtml(t.CLASS+"-dialog",null,function(e){t._$dialogDiv.html(e)}).then(function(){TC.Control.prototype.render.call(t,e)})};e.importTrack=function(e){var t=this;if(t.isDisabled)/.gpx$/g.test(e.fileName.toLowerCase())&&t.map.toast(t.getLocaleString("geo.trk.import.disabled"),{type:TC.Consts.msgType.WARNING});else if(e.fileName&&e.features&&e.features.length>0){if(t.layerTrack){t.map.removeLayer(t.layerTrack);t.layerTrack=void 0}t.getLayer(t.Const.Layers.TRACK).then(function(i){t._trackLayerBindEvents(!1);t.layerTrack.setVisibility(!1);t._trackLayerBindEvents(!0);var n=t.getLoadingIndicator().addWait();t.importedFileName=e.fileName;for(var r=0,s=e.features.length;r<s;r++)t.layerTrack.addFeature(e.features[r]);t.wrap.processImportedFeatures(n);if(t.layerTrack){t.map&&t.map.layout&&t.map.layout.accordion&&t._$div.hasClass(TC.Consts.classes.COLLAPSED)&&t.map.controls.filter(function(e){return e!==t&&!e.containerControl}).forEach(function(e){e._$div.addClass(TC.Consts.classes.COLLAPSED)});t._$div.removeClass(TC.Consts.classes.COLLAPSED);$("."+t.CLASS+"-btn-tracks > span").click();t.map.$events.trigger($.Event(TC.Consts.event.TOOLSOPEN),{})}})}};var t=!0;e.renderData=function(a,o){var l=this,c=function(e,t){return(t.match(/(moveTop.*)/g)||[]).join(" ")};l.trackingActive={isTrackingActive:!1,get:function(){return this.isTrackingActive},set:function(e){this.isTrackingActive=e;l.$geoInfoResult||(l.$geoInfoResult=$("."+l.CLASS+"-info-tracking div.tc-ctl-p-results"));switch(this.isTrackingActive){case!0:if(l.elevationActiveCollapsed.get()){l.$geoInfoResult.removeClass(c).addClass("moveTop57");l.$geoInfoResult.find(".prcollapsed").removeClass("prcollapsed-samehw");l.$geoInfoResult.find(".prpanel-heading").removeClass("prpanel-heading-samehw")}else if(l.elevationActive.get()){l.$geoInfoResult.removeClass(c).addClass("moveTop159");l.$geoInfoResult.find(".prcollapsed").addClass("prcollapsed-samehw");l.$geoInfoResult.find(".prpanel-heading").addClass("prpanel-heading-samehw")}else{l.$geoInfoResult.removeClass(c).addClass("moveTop33");l.$geoInfoResult.find(".prcollapsed").removeClass("prcollapsed-samehw");l.$geoInfoResult.find(".prpanel-heading").removeClass("prpanel-heading-samehw")}}}};l.elevationActive={isElevationActive:!1,get:function(){return this.isElevationActive},set:function(e){this.isElevationActive=e;l.$geoInfoResult||(l.$geoInfoResult=$("."+l.CLASS+"-info-tracking div.tc-ctl-p-results"));switch(this.isElevationActive){case!0:if(l.trackingActive.get()){l.$geoInfoResult.removeClass(c).addClass("moveTop159");l.$geoInfoResult.find(".prcollapsed").addClass("prcollapsed-samehw");l.$geoInfoResult.find(".prpanel-heading").addClass("prpanel-heading-samehw")}break;case!1:if(l.trackingActive.get()){l.$geoInfoResult.removeClass(c).addClass("moveTop33");l.$geoInfoResult.find(".prcollapsed").removeClass("prcollapsed-samehw");l.$geoInfoResult.find(".prpanel-heading").removeClass("prpanel-heading-samehw")}}}};l.elevationActiveCollapsed={isElevationActiveCollapsed:!1,get:function(){return this.isElevationActiveCollapsed},set:function(e){this.isElevationActiveCollapsed=e;l.$geoInfoResult||(l.$geoInfoResult=$("."+l.CLASS+"-info-tracking div.tc-ctl-p-results"));switch(this.isElevationActiveCollapsed){case!0:if(l.trackingActive.get()){l.$geoInfoResult.removeClass(c).addClass("moveTop57");l.$geoInfoResult.find(".prcollapsed").removeClass("prcollapsed-samehw");l.$geoInfoResult.find(".prpanel-heading").removeClass("prpanel-heading-samehw")}break;case!1:if(l.trackingActive.get()){l.$geoInfoResult.removeClass(c).addClass("moveTop159");l.$geoInfoResult.find(".prcollapsed").addClass("prcollapsed-samehw");l.$geoInfoResult.find(".prpanel-heading").addClass("prpanel-heading-samehw")}}}};var h=l.Const.Selector;TC.Control.prototype.renderData.call(l,a,function(){var a=l._$div.find(l._classSelector+"-panel");l._$div.find(".tc-ctl-geolocation-select span").on(TC.Consts.event.CLICK,function(e){var t=$(this).closest("label").find("input[type=radio][name=mode]").val();a.removeClass(TC.Consts.classes.HIDDEN);a.not(".tc-ctl-geolocation-"+t).addClass(TC.Consts.classes.HIDDEN)});l.gps={};l.gps.$activateButton=l._$div.find(l._classSelector+"-locate-show");l.gps.$deactivateButton=l._$div.find(l._classSelector+"-locate-hide");l.track={};l.track.$activateButton=l._$div.find(l._classSelector+"-track-ui-activate");l.track.$deactivateButton=l._$div.find(l._classSelector+"-track-ui-deactivate");l.track.$info=l._$div.find(l._classSelector+"-info-tracking").appendTo(l.map._$div);$(document).on("click","#trackingInfoMin",function(){var e=$(this).closest("div.tc-ctl-p-results");e.find(".prsidebar-body").toggle("slide",function(){e.find(".prcollapsed-max").fadeIn()})});$(document).on("click","#trackingInfoMax",function(){var e=$(this).closest("div.tc-ctl-p-results");e.find(".prsidebar-body").toggle("slide");e.find(".prcollapsed-max").hide()});$(document).on("click","#trackingInfoClose",function(){$(this).closest("div.tc-ctl-p-results").find(".prsidebar-body").fadeOut("slide")});l.track.$trackSearch=l._$div.find(l._classSelector+"-track-available-srch");l.track.$trackList=l._$div.find(l._classSelector+"-track-available-lst");l.track.$trackToolPanelOpened=l._$div.find("#tc-ctl-geolocation-track-panel-opened");l._$div.find("."+e.CLASS+"-track-panel-help").on("click",function(){s.call(l)});l.track.$trackName=l._$div.find(l._classSelector+"-track-title");l.track.$trackSave=l._$div.find(l._classSelector+"-track-save");l.track.$trackWPT=l._$div.find(l._classSelector+"-track-waypoint");l.track.$trackAdd=l._$div.find(l._classSelector+"-track-add-wpt");l.track.$trackContinue=l._$dialogDiv.find(".tc-ctl-geolocation-track-continue");l.track.$trackRenew=l._$dialogDiv.find(".tc-ctl-geolocation-track-new");l.track.$trackClose=l._$dialogDiv.find(".tc-ctl-geolocation-continue-track-dialog button.tc-modal-close");l.track.$trackAddSegment=l._$div.find("#tc-ctl-geolocation-track-segment");l.track.$trackAdvertisementOK=l._$dialogDiv.find(".tc-ctl-geolocation-track-advert-ok");l.track.$trackImportFile=l._$div.find(l._classSelector+"-track-import");TC.Util.detectMobile()&&Modernizr.mq("screen and (max-height: 50em) and (max-width: 50em)")&&l.track.$trackToolPanelOpened.prop("checked",!1);if(window.File&&window.FileReader&&window.FileList&&window.Blob){l.track.$trackImportFile.prop("disabled",!1);l.track.$trackImportFile.on(TC.Consts.event.CLICK,function(e){$(this).wrap("<form>").closest("form").get(0).reset();$(this).unwrap()});l.track.$trackImportFile.on("change",function(e){if(!l._cleaning){l.clear(l.Const.Layers.TRACK);if(l.map){l.map.on(TC.Consts.event.LAYERERROR,i);l.importedByMe=!0;l.map.wrap.loadFiles(e.target.files)}}})}else console.log("no es posible la importaci\xf3n");l.gps.$activateButton.on("click",function(){l.activateGPS()});l.gps.$deactivateButton.on("click",function(){l.deactivateGPS()});l.track.$activateButton.on("click",function(){l.activateTracking();n.call(l)});l.track.$deactivateButton.on("click",function(){l.deactivateTracking();r.call(l)});var o=function(e){e=e.toLowerCase();var t=l.track.$trackList.find("li").hide(),i=t.filter("li:not([class]),li."+l.Const.Classes.SELECTEDTRACK);if(0===e.length){i.show();l._$div.find(l._classSelector+"-track-search-icon").css("visibility","visible")}else{l._$div.find(l._classSelector+"-track-search-icon").css("visibility","hidden");var n=new RegExp(e,"i");i.each(function(){var e=$(this);e.toggle(n.test(e.children("span").text()))});0===i.filter(":visible").length&&t.filter('[class^="tc-ctl-geolocation-track-not"]').show()}};l.track.$trackSearch.on("keyup search",function(){o($(this).val().toLowerCase().trim())});try{if(l.track.$trackSearch.has($("::-ms-clear"))){l.track.$trackSearch.on("mouseup",function(e){""!==l.track.$trackSearch.val()&&setTimeout(function(){var e=l.track.$trackSearch.val();""===e&&o(e)},1)})}}catch(e){}l.track.$trackSave.on("click",$.proxy(l.saveTrack,l));l.track.$trackAdd.on("click",$.proxy(l.addWaypoint,l));var c=function(e,t){t.is("li")||(t=t.parent());if(e){t.find("input").first().removeClass(TC.Consts.classes.HIDDEN);t.find("span").first().addClass(TC.Consts.classes.HIDDEN);t.find("input").first().focus().val(t.find("span").first().text());t.find(h.SIMULATE).first().addClass(TC.Consts.classes.HIDDEN);t.find(h.EDIT).first().addClass(TC.Consts.classes.HIDDEN);t.find(h.DELETE).first().addClass(TC.Consts.classes.HIDDEN);t.find(h.DRAW).first().addClass(TC.Consts.classes.HIDDEN);t.find(h.EXPORT_GPX).first().addClass(TC.Consts.classes.HIDDEN);t.find(h.EXPORT_KML).first().addClass(TC.Consts.classes.HIDDEN);t.find(h.SAVE).first().removeClass(TC.Consts.classes.HIDDEN);t.find(h.CANCEL).first().removeClass(TC.Consts.classes.HIDDEN)}else{t.find("input").first().addClass(TC.Consts.classes.HIDDEN);t.find("span").first().removeClass(TC.Consts.classes.HIDDEN);t.find(h.SIMULATE).first().removeClass(TC.Consts.classes.HIDDEN);t.find(h.EDIT).first().removeClass(TC.Consts.classes.HIDDEN);t.find(h.DELETE).first().removeClass(TC.Consts.classes.HIDDEN);t.find(h.DRAW).first().removeClass(TC.Consts.classes.HIDDEN);t.find(h.EXPORT_GPX).first().removeClass(TC.Consts.classes.HIDDEN);t.find(h.EXPORT_KML).first().removeClass(TC.Consts.classes.HIDDEN);t.find(h.SAVE).first().addClass(TC.Consts.classes.HIDDEN);t.find(h.CANCEL).first().addClass(TC.Consts.classes.HIDDEN)}};l.uiSimulate=function(e,t){var i=[h.SIMULATE,h.EDIT,h.DELETE,h.EXPORT_GPX,h.EXPORT_KML],n=[h.STOP,h.PAUSE,h.BACKWARD,h.FORWARD,h.SPEED],r=t.is("li")?t:t.parent();if(e){for(var s=0;s<i.length;s++)$(r).find(i[s]).first().attr("hidden","hidden");for(s=0;s<n.length;s++)$(r).find(n[s]).first().removeAttr("hidden")}else{for(s=0;s<n.length;s++)$(r).find(n[s]).first().attr("hidden","hidden");for(s=0;s<i.length;s++)$(r).find(i[s]).first().removeAttr("hidden")}};$(document).on("click",h.SIMULATE,function(){var e=l.getLoadingIndicator().addWait();$(this).parent().find(h.SPEED).text("x 1");$.when(f(l,this)).then(function(){l.getLoadingIndicator().removeWait(e)})});$(document).on("click",h.DRAW,function(){var e=l.getLoadingIndicator().addWait();$.when(d(l,this)).then(function(){l.getLoadingIndicator().removeWait(e)})});l.$events.on(l.Const.Event.IMPORTEDTRACK,function(e,t){if(l.isDisabled)l.map.toast(l.getLocaleString("geo.trk.import.disabled"),{type:TC.Consts.msgType.WARNING});else{var i=l.track.$trackList.find('li[data-id="'+t+'"]');d(l,i.find(h.DRAW));l.track.$trackList.animate({scrollTop:t*i.outerHeight()},"slow")}});var p=function(e,t){for(var i=e.track.$trackList.find("li[data-id]"),n=0;n<i.length;n++){var r=$(i[n]);if(r&&r.attr("data-id")!==t){var s=r.find(h.SIMULATE),a=r.find(h.PAUSE);s.toggleClass(e.Const.Classes.SIMULATIONACTIVATED,!1);s.attr("title",e.getLocaleString("tr.lst.simulate"));a.toggleClass("play",!1);a.attr("title",e.getLocaleString("tr.lst.pause"));e.uiSimulate(!1,r);c(!1,r)}}e.clear(e.Const.Layers.TRACK)},d=function(e,t){var i=$.Deferred(),n=$(t).parent();setTimeout(function(){if(n.hasClass(e.Const.Classes.SELECTEDTRACK)){e.uiSimulate(!1,$(t));e.clear(e.Const.Layers.TRACK);$(t).attr("title",$(t).text());e.elevationActive.set(!1);if(void 0!==e.layerTrack){e.map.removeLayer(e.layerTrack);e.layerTrack=void 0}}else if(e.getSelectedTrack().length>0){p(e,n.attr("data-id"));e.drawTrack(n)}else e.drawTrack(n);i.resolve()},0);return i.promise()},f=function(e,t){var i=$.Deferred();setTimeout(function(){var n=$(t).parent();e.getLayer(e.Const.Layers.TRACK).then(function(r){p(e,n.attr("data-id"));e.uiSimulate(!1,e.getSelectedTrack());$(this).parent().addClass(e.Const.Classes.SELECTEDTRACK);e.uiSimulate(!0,$(t));e.simulate_paused=!1;e.simulateTrack($(t).parent());i.resolve()})},0);return i.promise()};$(document).on("click",l._classSelector+" "+h.EDIT,function(){c(!0,$(this))});$(document).on("click",l._classSelector+" "+h.DELETE,function(){l.removeTrack($(this).parent())});$(document).on("click",l._classSelector+" "+h.SAVE,function(){if(0==$(this).parent().find("input").first().val().trim().length)TC.alert(l.getLocaleString("geo.trk.edit.alert"));else{l.editTrackName($(this).parent().attr("data-id"),$(this).parent().find("input").first().val());c(!1,$(this))}});$(document).on("click",l._classSelector+" "+h.CANCEL,function(){c(!1,$(this))});$(document).on("click",l._classSelector+" "+h.EXPORT_GPX+","+l._classSelector+" "+h.EXPORT_KML,function(){var e=this,t=$.grep($(this).attr("class").split(" "),function(e){return 0===e.indexOf("tc-btn-export-")})[0].replace("tc-btn-export-","").toUpperCase();l.export(t,$(this).parent()).then(function(i){if(i){var n=$(e).parent().find("span").first().text(),r=new RegExp(l.Const.SupportedFileExtensions.join("|"),"gi"),s=n.replace(r,"");TC.Util.downloadFile(s+"."+t.toLowerCase(),l.Const.MimeMap[t],i)}else TC.alert(l.getLocaleString("geo.error.export"))})});$(document).on("click",l._classSelector+" "+h.STOP,function(){l.uiSimulate(!1,$(this));l.wrap.simulateTrackEnd();var e=$(this).parent().find(h.PAUSE);e.toggleClass("play",!1);e.attr("title",l.getLocaleString("tr.lst.pause"));$(this).parent().find(h.SPEED).text("x 1");l.simulate_speed=1});$(document).on("click",l._classSelector+" "+h.PAUSE,function(){l.simulate_paused=!$(this).hasClass("play");l.simulate_paused&&(l.simulate_pausedElapse=-1);$(this).attr("title",l.getLocaleString(l.simulate_paused?"tr.lst.play":"tr.lst.pause"));$(this).toggleClass("play",l.simulate_paused)});$(document).on("click",l._classSelector+" "+h.BACKWARD,function(){1==l.simulate_speed?l.simulate_speed=.5:l.simulate_speed=l.simulate_speed/2;$(l._classSelector+" "+h.FORWARD).removeAttr("disabled");$(this).parent().find(h.SPEED).text(l.simulate_speed<1?"/ "+1/l.simulate_speed:"x "+l.simulate_speed);.000244140625==l.simulate_speed&&$(this).attr("disabled","disabled")});$(document).on("click",l._classSelector+" "+h.FORWARD,function(){l.simulate_speed=l.simulate_speed/.5;$(this).parent().find(h.SPEED).text(l.simulate_speed<1?"/ "+1/l.simulate_speed:"x "+l.simulate_speed);$(l._classSelector+" "+h.BACKWARD).removeAttr("disabled");4096==l.simulate_speed&&$(this).attr("disabled","disabled")});l.track.$trackContinue.on("click",function(){TC.Util.closeModal();u.call(l)});l.track.$trackRenew.on("click",function(){delete l.sessionTracking;TC.Util.storage.setSessionLocalValue(l.Const.LocalStorageKey.TRACKINGTEMP,void 0);localforage.removeItem(l.Const.LocalStorageKey.TRACKINGTEMP);TC.Util.closeModal();u.call(l)});l.track.$trackClose.on("click",function(){r.call(l)});l.track.$trackAddSegment.on("click",function(){TC.alert("pendiente");TC.Util.closeModal()});l.track.$trackAdvertisementOK.on("click",function(){var e=$("body").find('input[name*="Advertisement"]:checked');if(e.length>0){var t=new $.Deferred;window.localforage?t.resolve():TC.loadJS(!window.localforage,[TC.Consts.url.LOCALFORAGE],function(){t.resolve()});t.then(function(){localforage.setItem(e.first().attr("name"),!1)})}TC.Util.closeModal()});l.track.renderTrack=$("#tc-ctl-geolocation-track-render").on("change",function(){l.track.$activateButton.hasClass(TC.Consts.classes.HIDDEN)&&l.layerTracking.setVisibility(this.checked);t=this.checked});window.localforage?l.bindTracks():TC.loadJS(!window.localforage,[TC.Consts.url.LOCALFORAGE],function(){l.bindTracks()})});$.isFunction(o)&&o()};e.activate=function(){};e.deactivate=function(){TC.Util.closeModal();this.clearSelection();this.deactivateTracking()};var i=function(){this.map.off(TC.Consts.event.LAYERERROR,i);this.clearFileInput(this.track.$trackImportFile);TC.alert(this.getLocaleString("geo.trk.upload.error3"))},n=function(){this.track.$activateButton.toggleClass(TC.Consts.classes.HIDDEN,!0);this.track.$deactivateButton.toggleClass(TC.Consts.classes.HIDDEN,!1)},r=function(){this.track.$activateButton.toggleClass(TC.Consts.classes.HIDDEN,!1);this.track.$deactivateButton.toggleClass(TC.Consts.classes.HIDDEN,!0)},s=function(){this.map.toast(this._$div.find(".alert-warning").html(),{duration:1e4})};e.markerStyle={radius:7,fillColor:[255,0,0,100],strokeColor:[255,255,255,255],strokeWidth:2};e.lineStyle={strokeWidth:2,strokeColor:[0,206,209,255]};e.getLayer=function(e){var t,i=this,n="";switch(!0){case e==i.Const.Layers.TRACKING:void 0!==i.layerTracking;n="layerTracking";break;case e==i.Const.Layers.TRACK:void 0!==i.layerTrack;n="layerTrack";t={line:{strokeWidth:2,strokeColor:"#C52737"},point:{radius:function(e){var t=e.getData().name;return t&&(t+"").trim().length>0?3:6},fillColor:"#C52737",strokeColor:"#ffffff",fontColor:"#C52737",fontSize:10,labelOutlineColor:"#ffffff",labelOutlineWidth:2,label:function(e){var t=e.getData().name;return t=t&&(t+"").trim().length>0?(t+"").trim().toLowerCase():""}}};break;case e==i.Const.Layers.GPS:void 0!==i.layerGPS;n="layerGPS"}if(this[n]){var r=new $.Deferred;r.resolve(this[n]);return r}if(i.layerPromise&&"resolved"!==i.layerPromise.state())return i.layerPromise;i.layerPromise=new $.Deferred;var s={id:i.getUID(),type:TC.Consts.layerType.VECTOR,title:i.getLocaleString("geo")+" - "+e,stealth:!0};t&&(s.styles=t);i.map.addLayer(s).then(function(e){this[n]=e;this[n].map.putLayerOnTop(e);i.layerPromise.resolve(this[n])}.bind(i));return i.layerPromise};e.activateGPS=function(){var e=this;e.deactivateTracking();v.call(e,e.Const.LocalStorageKey.GPSSHOWADVERTISEMENT);h.apply(e);m.apply(e);e.gps.$activateButton.toggleClass(TC.Consts.classes.HIDDEN,!0);e.gps.$deactivateButton.toggleClass(TC.Consts.classes.HIDDEN,!1);e.track.$trackToolPanelOpened.prop("checked")||e.map.$events.trigger($.Event(TC.Consts.event.TOOLSCLOSE),{});$.when(e.getLayer(e.Const.Layers.GPS)).then(function(t){e.currentPositionWaiting=e.getLoadingIndicator().addWait();if(navigator.geolocation){var i=function(i){i=i.coords;e.geopositionGPS=!0;var n=TC.Util.reproject([i.longitude,i.latitude],"EPSG:4326",e.map.crs);e.getLoadingIndicator().removeWait(e.currentPositionWaiting);t&&t.clearFeatures();var r;r=n,function(e,t){return!(e instanceof Array)||t[0]>=e[0]&&t[0]<=e[2]&&t[1]>=e[1]&&t[1]<=e[3]}(e.map.options.maxExtent,r)?$.when(t.addCircle([n,i.accuracy/e.map.getMetersPerUnit()]),t.addMarker(n,{title:"GPS",cssClass:TC.Consts.classes.POINT,anchor:[.5,.5]})).then(function(i,n){e.gps.accuracyCircle=i;e.gps.geoPosition=n;if(!e.wrap.pulsated){e.map.zoomToFeatures(t.features,{animate:!1});e.wrap.pulsate(i)}}):TC.alert(e.getLocaleString("geo.error.out"))};if(navigator.geolocation){navigator.geolocation.getCurrentPosition(function(t){e.data=t;i(t);e.currentPosition=navigator.geolocation.watchPosition(i,e.onGeolocateError.bind(e))},e.onGeolocateError.bind(e));setTimeout(function(){if(!e.data){e.getLoadingIndicator().removeWait(e.currentPositionWaiting);e.map.toast(e.getLocaleString("geo.error.permission_denied"),{type:TC.Consts.msgType.WARNING});e.gps.$activateButton.toggleClass(TC.Consts.classes.HIDDEN,!1);e.gps.$deactivateButton.toggleClass(TC.Consts.classes.HIDDEN,!0)}},61e3)}else alert("not supported")}else e.onGeolocateError()})};e.deactivateGPS=function(){delete this.geopositionGPS;p();y();delete this.wrap.pulsated;navigator.geolocation&&this.currentPosition&&navigator.geolocation.clearWatch(this.currentPosition);$.when(this.getLayer(this.Const.Layers.GPS)).then(function(e){e&&e.clearFeatures()});this.gps.$activateButton.toggleClass(TC.Consts.classes.HIDDEN,!1);this.gps.$deactivateButton.toggleClass(TC.Consts.classes.HIDDEN,!0);this.currentPositionWaiting&&this.getLoadingIndicator().removeWait(this.currentPositionWaiting);return!0};e.setFormatInfoNewPosition=function(e){var t={},i=TC.Util.getMapLocale(this.map);t.x=Math.round(e.position[0]).toLocaleString(i);t.y=Math.round(e.position[1]).toLocaleString(i);t.z=Math.round(e.altitude).toLocaleString(i);t.accuracy=Math.round(e.accuracy).toLocaleString(i);t.speed=e.speed.toLocaleString(i,{minimumFractionDigits:1,maximumFractionDigits:1});return t};e.renderInfoNewPosition=function(e){var t=this;t.getRenderedHtml(t.CLASS+"-tracking-toast",t.setFormatInfoNewPosition(e.pd),function(e){t.track.$info.find(".prpanel-body").html(e);t.track.$info.hasClass(TC.Consts.classes.HIDDEN)&&t.track.$info.removeClass(TC.Consts.classes.HIDDEN);t.trackingActive.set(!0)})};var a,o,l,c=function(){this.track.$trackToolPanelOpened.prop("checked")||this.map.$events.trigger($.Event(TC.Consts.event.TOOLSCLOSE),{})},u=function(){var e=this;e.activate();n.call(e);c.call(e);e.track.$info.find(".prsidebar-body").show();e.$events.on(e.Const.Event.POSITIONCHANGE,function(t){e.currentPoint=t.pd;e.renderInfoNewPosition(t);e.track.$trackName.removeAttr("disabled");e.track.$trackSave.removeAttr("disabled");e.track.$trackWPT.removeAttr("disabled");e.track.$trackAdd.removeAttr("disabled");TC.Util.storage.setSessionLocalValue(e.Const.LocalStorageKey.TRACKINGTEMP,e.wrap.formattedToStorage(e.layerTracking).features)});e.$events.on(e.Const.Event.STATEUPDATED,function(e){});e.clear(e.Const.Layers.TRACKING);v.call(e,e.Const.LocalStorageKey.TRACKINGSHOWADVERTISEMENT);e.wrap.setTracking(!0)},h=function(){if(!this.videoScreenOn){var e={WebM:"data:video/webm;base64,GkXfo0AgQoaBAUL3gQFC8oEEQvOBCEKCQAR3ZWJtQoeBAkKFgQIYU4BnQI0VSalmQCgq17FAAw9CQE2AQAZ3aGFtbXlXQUAGd2hhbW15RIlACECPQAAAAAAAFlSua0AxrkAu14EBY8WBAZyBACK1nEADdW5khkAFVl9WUDglhohAA1ZQOIOBAeBABrCBCLqBCB9DtnVAIueBAKNAHIEAAIAwAQCdASoIAAgAAUAmJaQAA3AA/vz0AAA=",MP4:"data:video/mp4;base64,AAAAHGZ0eXBpc29tAAACAGlzb21pc28ybXA0MQAAAAhmcmVlAAAAG21kYXQAAAGzABAHAAABthADAowdbb9/AAAC6W1vb3YAAABsbXZoZAAAAAB8JbCAfCWwgAAAA+gAAAAAAAEAAAEAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIAAAIVdHJhawAAAFx0a2hkAAAAD3wlsIB8JbCAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAQAAAAAAIAAAACAAAAAABsW1kaWEAAAAgbWRoZAAAAAB8JbCAfCWwgAAAA+gAAAAAVcQAAAAAAC1oZGxyAAAAAAAAAAB2aWRlAAAAAAAAAAAAAAAAVmlkZW9IYW5kbGVyAAAAAVxtaW5mAAAAFHZtaGQAAAABAAAAAAAAAAAAAAAkZGluZgAAABxkcmVmAAAAAAAAAAEAAAAMdXJsIAAAAAEAAAEcc3RibAAAALhzdHNkAAAAAAAAAAEAAACobXA0dgAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAIAAgASAAAAEgAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABj//wAAAFJlc2RzAAAAAANEAAEABDwgEQAAAAADDUAAAAAABS0AAAGwAQAAAbWJEwAAAQAAAAEgAMSNiB9FAEQBFGMAAAGyTGF2YzUyLjg3LjQGAQIAAAAYc3R0cwAAAAAAAAABAAAAAQAAAAAAAAAcc3RzYwAAAAAAAAABAAAAAQAAAAEAAAABAAAAFHN0c3oAAAAAAAAAEwAAAAEAAAAUc3RjbwAAAAAAAAABAAAALAAAAGB1ZHRhAAAAWG1ldGEAAAAAAAAAIWhkbHIAAAAAAAAAAG1kaXJhcHBsAAAAAAAAAAAAAAAAK2lsc3QAAAAjqXRvbwAAABtkYXRhAAAAAQAAAABMYXZmNTIuNzguMw=="};this.videoScreenOn=document.createElement("video");this.videoScreenOn.setAttribute("loop","");this.videoScreenOn.setAttribute("muted","");this.videoScreenOn.setAttribute("webkit-playsinline","");this.videoScreenOn.setAttribute("playsinline","");this.videoScreenOn.setAttribute("style","transform: translateZ(0px);");var t=document.createElement("source");t.src=e.WebM;t.type="video/webm";this.videoScreenOn.appendChild(t);var i=document.createElement("source");i.src=e.MP4;i.type="video/mp4";this.videoScreenOn.appendChild(i)}this.videoScreenOn.play()},p=function(){this.videoScreenOn&&this.videoScreenOn.pause()},d=function(){this.videoScreenOn.paused&&this.videoScreenOn.play();C.apply(this)},f=function(){var e=function(){var e=["webkit","moz","ms","o"];if("hidden"in document)return"hidden";for(var t=0;t<e.length;t++)if(e[t]+"Hidden"in document)return e[t]+"Hidden";return null}();document[e]||d.apply(this);console.log("video is: "+this.videoScreenOn.paused)},m=function(){l||(l=f.bind(this));a||(a=function(){g.apply(this)}.bind(this));o||(o=d.bind(this));window.addEventListener("visibilitychange",l,!1);if(TC.Util.detectSafari()&&Modernizr.touch&&!navigator.userAgent.match(/Android/i)&&!navigator.userAgent.match(/CriOS/i)){window.addEventListener("pagehide",a,!1);window.addEventListener("pageshow",o,!1)}else{window.addEventListener("blur",a,!1);window.addEventListener("focus",o,!1)}},y=function(){window.removeEventListener("visibilitychange",l,!1);if(TC.Util.detectSafari()&&Modernizr.touch&&!navigator.userAgent.match(/Android/i)&&!navigator.userAgent.match(/CriOS/i)){window.removeEventListener("pagehide",a,!1);window.removeEventListener("pageshow",o,!1)}else{window.removeEventListener("blur",a,!1);window.removeEventListener("focus",o,!1)}},g=function(){var e=TC.Util.storage.getSessionLocalValue(this.Const.LocalStorageKey.TRACKINGTEMP);e&&e.length>0&&localforage.setItem(this.Const.LocalStorageKey.TRACKINGTEMP,"string"==typeof e?e:JSON.stringify(e))},C=function(){var e=this;localforage.getItem(e.Const.LocalStorageKey.TRACKINGTEMP).then(function(t){null!==t&&"null"!==t&&t.length>0&&TC.Util.storage.setSessionLocalValue(e.Const.LocalStorageKey.TRACKINGTEMP,t)})},v=function(e){var t=this,i=new $.Deferred;window.localforage?i.resolve():TC.loadJS(!window.localforage,[TC.Consts.url.LOCALFORAGE],function(){i.resolve()});i.then(function(){localforage.getItem(e).then(function(i){if(null==i){var n=t._$dialogDiv.find(".tc-ctl-geolocation-track-advert-dialog");n.find('input[type="checkbox"]').first().attr("name",e).removeAttr("checked");TC.Util.detectMobile()?$("#pageBlurMsg").text(t.getLocaleString("geo.trk.page.blur")):$("#pageBlurMsg").text(t.getLocaleString("geo.trk.page.blur.desktop"));e==t.Const.LocalStorageKey.GPSSHOWADVERTISEMENT?n.find("h3").text(t.getLocaleString("geo.track.activate")+" "+t.getLocaleString("geo.gps")):n.find("h3").text(t.getLocaleString("geo.track.activate.title"));TC.Util.showModal(t._$dialogDiv.find(".tc-ctl-geolocation-track-advert-dialog"))}})});t.map.toast(TC.Util.detectMobile()?t.getLocaleString("geo.trk.page.blur"):t.getLocaleString("geo.trk.page.blur.desktop"),{type:TC.Consts.msgType.WARNING})};e._askTracking=function(e){TC.Util.showModal(this._$dialogDiv.find(".tc-ctl-geolocation-continue-track-dialog"),{closeCallback:function(){$.isFunction(e)&&e()}});return!0};e.activateTracking=function(){var e=this,t=!0;e.isActive||e.activate();e.clear(e.Const.Layers.TRACKING);try{TC.Util.storage.setSessionLocalValue(e.Const.LocalStorageKey.TEST,e.Const.LocalStorageKey.TEST)}catch(i){i.code===DOMException.QUOTA_EXCEEDED_ERR?TC.alert(e.getLocaleString("geo.error.trackinglocalstorage")):TC.error(i);t=!1}if(t){h.apply(e);m.apply(e);e.sessionTracking=TC.Util.storage.getSessionLocalValue(e.Const.LocalStorageKey.TRACKINGTEMP);if(e.sessionTracking){e._askTracking(function(){r.call(e)})||e.track.$trackRenew.click()}else u.call(e)}else r.call(e)};e.deactivateTracking=function(){var e=this,i=function(){e.track.$info.addClass(TC.Consts.classes.HIDDEN);$("#trackingInfoMax").hide();g.apply(e);e.wrap.setTracking(!1);delete e.geopositionTracking;t||$(e._classSelector+"-track-render").find("label").click();p.apply(e);y.apply(e);e.$events.off(e.Const.Event.POSITIONCHANGE);e.$events.off(e.Const.Event.STATEUPDATED);r.call(e);e.trackingActive.set(!1);e.track.$trackName.val("");e.track.$trackName.attr("disabled","disabled");e.track.$trackSave.attr("disabled","disabled");e.track.$trackWPT.val("");e.track.$trackWPT.attr("disabled","disabled");e.track.$trackAdd.attr("disabled","disabled");e.clear(e.Const.Layers.TRACKING);e.clear(e.Const.Layers.GPS);return!0};if(e.wrap.hasCoordinates()){e.map.toast(e.getLocaleString("geo.trk.deactivate.alert"),{duration:1e4});return i()}return i()};e.getStoredTracks=function(){var e=this,t=new $.Deferred,i=[];localforage.keys().then(function(n){var r=[];if(0==(n=n.filter(function(t){if(!t.startsWith(e.Const.LocalStorageKey.TRACKINGTEMP)&&t.startsWith(e.Const.LocalStorageKey.TRACKING)){if(/trk#\d/i.exec(t)){r.push(new $.Deferred);return!0}return!1}return!1})).length){e.availableTracks=i;t.resolve(i)}r.forEach(function(e,t){localforage.getItem(n[t],function(t,i){e.resolve(i)})});$.when.apply($,r).then(function(){var n=Array.prototype.slice.call(arguments,0);if(n&&n.length){n.forEach(function(e){(e=JSON.parse(e))instanceof Array?i=i.concat(e):i.push(e)});var r=i.length>1?T(i):i;e.availableTracks=r;t.resolve(r)}})});return t};var T=function(e){var t=[];for(var i in e)if(e[i]&&"object"==typeof e[i]){t.push(e[i]);t.sort(function(e,t){return"string"==typeof e.name&&$.isFunction(e.name.localeCompare)?e.name.localeCompare(t.name):0})}return t};e.setStoredTracks=function(e){var t=this,i=new $.Deferred,n=[];e.forEach(function(e){n.push(new $.Deferred);var i=n[n.length-1];localforage.setItem(t.Const.LocalStorageKey.TRACKING+"#"+e.uid,JSON.stringify(e),function(e,t){i.resolve(t)})});$.when.apply($,n).then(function(){t.getStoredTracks().then(function(){t.bindTracks();i.resolve()})});return i};e.getAvailableTracks=function(){var e=new $.Deferred;this.availableTracks?e.resolve(this.availableTracks):this.getStoredTracks().then(function(t){e.resolve(t)});return e};e.bindTracks=function(){var e=this;e.track.$trackList.find('li:not([class^="tc-ctl-geolocation-track-available-empty"])').hide();e.track.$trackList.find('li[class^="tc-ctl-geolocation-track-available-empty"]').hide();e.getAvailableTracks().then(function(t){if(L(t)){e.track.$trackList.find('li[class^="tc-ctl-geolocation-track-available-empty"]').show();e.track.$trackSearch.attr("disabled","disabled")}else{var i=$(e.getSelectedTrack()[0]).attr("data-uid");e.track.$trackList.find("li[data-id]").remove();for(var n=0;n<t.length;n++){var r=t[n];"object"==typeof r&&e.getRenderedHtml(e.CLASS+"-track-node",{id:n,uid:r.uid,name:r.name?r.name.trim():""},function(t){e.track.$trackList.append(t)})}i&&e.setSelectedTrack(e.track.$trackList.find('li[data-uid="'+i+'"]'));e.track.$trackSearch.removeAttr("disabled")}})};e.chartProgressInit=function(){window.d3||TC.syncLoadJS(TC.Consts.url.D3C3);var e=d3.select(".c3-event-rects,.c3-event-rects-single").node().getBoundingClientRect();$("body").append('<div class="miDiv">');this.miDiv=$("div.miDiv");this.miDiv.width(e.width);this.miDiv.height(e.height);this.miDiv.append('<div class="miProgressDiv">');this.miProgressDiv=$("div.miProgressDiv");this.miProgressDiv.addClass("tc-ctl-geolocation-track-elevation-chart-progress");this.miProgressDiv.width("0%");this.miProgressDiv.height(e.height);this.miProgressDiv.append('<div class="miProgressTextDiv">');this.miProgressTextDiv=$("div.miProgressTextDiv");this.miProgressTextDiv.addClass("tc-ctl-geolocation-track-elevation-chart-progress text");this.miProgressTextDiv.width(e.width);this.miProgressTextDiv.height(e.height);this.miDiv.css({top:e.top,left:e.left,bottom:e.bottom,right:e.right,position:"absolute","z-index":10007})};e.chartProgressClear=function(){$(this.miProgressTextDiv).remove();$(this.miProgressDiv).remove();$(this.miDiv).remove()};e.chartSetProgress=function(e,t,i,n){var r=e.d,s=(r+Math.hypot(e.p[0]-t[0],e.p[1]-t[1]))/i*100;this.miProgressDiv.width(s+"%");var a,o,l=this.map.options.locale&&this.map.options.locale.replace("_","-")||void 0,c=parseInt(t[2].toFixed(0)).toLocaleString(l);if(r/1e3<1){a=Math.round(r/1e3*1e3);o=" m"}else{a=Math.round(r/1e3*100)/100;o=" km"}a=a.toLocaleString(l);this.miProgressTextDiv.html("<div><span>"+c+" m</span><br><span>"+a+o+"</span></div>"+(n?"<br><span>"+n.toString+"</span>":""))};e._getTime=function(e,t){var i=t-e,n={s:Math.floor(i/1e3%60),m:Math.floor(i/6e4%60),h:Math.floor(i/36e5%24)};return $.extend({},n,{toString:("00000"+n.h).slice(-2)+":"+("00000"+n.m).slice(-2)+":"+("00000"+n.s).slice(-2)})};e.simulateTrack=function(e){this.simulate_speed=1;this.drawTrack(e,!1);this.wrap.simulateTrack()};e.drawTrack=function(e,t){var i=this;c.call(i);i.getLayer(i.Const.Layers.TRACK).then(function(t){i.setSelectedTrack(e);i.drawTrackingData(e);i.elevationTrack(e);i.activate()})};e.elevationTrack=function(t,i){var n=this;if(i){n.resultsPanelChart.close();n.wrap.simulateTrackEnd();n.uiSimulate(!1,t)}if(!n.onResize){n.onResize=n.elevationTrack.bind(n,t,!0);window.addEventListener("resize",n.onResize,!1)}n.chart={coordinates:[]};n.track.elevationChart&&(n.track.elevationChart=n.track.elevationChart.destroy());(function(e){var t=new $.Deferred;TC.loadJS(!TC.tool||!TC.tool.Elevation,TC.apiLocation+"TC/tool/Elevation",function(){n.getTrackingData(e).then(function(e){var i=e.data;if(i){var r,s;r=[];s=[];var a,o,l,c=!0,u={},h={},p=function(){if(l.getLayout()==ol.geom.GeometryLayout.XYZ||l.getLayout()==ol.geom.GeometryLayout.XYZM){var e=l.getLength();return parseFloat((e/1e3).toFixed(2))}return null},d=function(){if(l.getLayout()==ol.geom.GeometryLayout.XYZM||l.getLayout()==ol.geom.GeometryLayout.XYM){var e=l.getLastCoordinate()[3]-l.getFirstCoordinate()[3];return{s:Math.floor(e/1e3%60),m:Math.floor(e/6e4%60),h:Math.floor(e/36e5%24)}}return null},f=function(e){if(n.chart.coordinates.length>0){var t=0;e.push(t);for(var i=1;i<=n.chart.coordinates.length-1;i++){var r=n.chart.coordinates[i],s=n.chart.coordinates[i-1];t+=Math.hypot(r[0]-s[0],r[1]-s[1]);e.push(parseFloat(t.toFixed(2)))}}},m=function(e){for(var i=0;i<n.chart.coordinates.length;i++){if(!(n.chart.coordinates[i].length>2))return t.resolve(null);var r=Math.round(10*n.chart.coordinates[i][2])/10;c&&r>0&&(c=!1);e.push(r);0==i&&(a=o=r);a=Math.min(a,r);o=Math.max(o,r)}};(new ol.format.GeoJSON).readFeatures(i).filter(function(e){return"linestring"===e.getGeometry().getType().toLowerCase()||"multilinestring"===e.getGeometry().getType().toLowerCase()}).forEach(function(t){switch((l=t.getGeometry()).getType().toLowerCase()){case"linestring":if(e.layout===ol.geom.GeometryLayout.XYZM||e.layout===ol.geom.GeometryLayout.XYZ){h=d();p();u=TC.tool.Elevation.getElevationGain({coords:l.getCoordinates(),hillDeltaThreshold:n.gapHill});n.chart.coordinates=n.chart.coordinates.concat(l.getCoordinates());f(r);m(s)}break;case"multilinestring":if(e.layout===ol.geom.GeometryLayout.XYZM||e.layout===ol.geom.GeometryLayout.XYZ)for(var i,a=l.getLineStrings(),o=0;o<a.length;o++){p(a[o]);a[o].getLayout()==ol.geom.GeometryLayout.XYZM&&(i+=a[o].getLastCoordinate()[3]-a[o].getFirstCoordinate()[3]);n.chart.coordinates=n.chart.coordinates.concat(a[o].getCoordinates());i&&(h=d());f(r);m(s)}break;default:return null}});s instanceof Array&&0==s.length&&(c=!0);n.chartData=c?null:$.extend({},{time:h,ele:s,x:r,miny:a,maxy:o},u);return t.resolve(n.chartData)}return t.resolve(null)})});return t})(t).then(function(t){TC.Util.getMapLocale(n.map);if(null!=t){t.time&&(t.time=("00000"+t.time.h).slice(-2)+":"+("00000"+t.time.m).slice(-2)+":"+("00000"+t.time.s).slice(-2));t.coords=n.chart.coordinates;n.hasElevation=!0;n.elevationActive.set(!0)}else{n.hasElevation=!1;t={msg:n.getLocaleString("geo.trk.chart.chpe.empty")};n.elevationActive.set(!1)}t.minHeight=n.CHART_SIZE.MIN_HEIGHT;t.maxHeight=n.CHART_SIZE.MAX_HEIGHT;t.minWidth=n.CHART_SIZE.MIN_WIDTH;t.mediumWidth=n.CHART_SIZE.MEDIUM_WIDTH;t.maxWidth=n.CHART_SIZE.MAX_WIDTH;if(n.resultsPanelChart){n.resultsPanelChart.show();n.map.$events.trigger($.Event(n.Const.Event.DRAWTRACK),{data:t})}else{window.c3||TC.syncLoadJS(TC.Consts.url.D3C3||TC.apiLocation+"lib/d3c3/d3c3.min.js");const i=n.map.getControlsByClass(TC.control.ResultsPanel).filter(function(e){return"chart"===e.options.content})[0],r=i?i._$div:$("<div>").appendTo(n.map._$div);n.map.addControl("resultsPanel",{div:r,content:"chart",titles:{main:n.getLocaleString("geo.trk.chart.chpe"),max:n.getLocaleString("geo.trk.chart.chpe")},openOn:n.Const.Event.DRAWTRACK,closeOn:n.Const.Event.CLEARTRACK,chart:{ctx:n,onmouseout:e.removeElevationTooltip,tooltip:e.getElevationTooltip}}).then(function(e){n.resultsPanelChart=e;e.render(function(){e.activateSnapping=function(e){n.layerTrack&&!n.layerTrack.getVisibility()&&0==n.layerTrack.getOpacity()&&n.wrap.deactivateSnapping.call(n.wrap)};e.deactivateSnapping=function(e){n.layerTrack&&n.layerTrack.getVisibility()&&n.layerTrack.getOpacity()>0&&n.wrap.activateSnapping.call(n.wrap)};e._$div.on("mouseover",e.deactivateSnapping);e._$div.on("mouseout",e.activateSnapping);n.map.$events.on(TC.Consts.event.RESULTSPANELMIN,function(){$(n.miDiv).hide();n.elevationActiveCollapsed.set(!0)}).on(TC.Consts.event.RESULTSPANELMAX,function(){$(n.miDiv).show();n.elevationActiveCollapsed.set(!1)}).on(TC.Consts.event.RESULTSPANELCLOSE,function(){$(n.miDiv).hide();n.elevationActive.set(!1)});e.show();n.map.$events.trigger($.Event(n.Const.Event.DRAWTRACK),{data:t})})})}})};e.clear=function(e){var t=this;if(t.onResize){window.removeEventListener("resize",t.onResize,!1);t.onResize=void 0}if(e==t.Const.Layers.TRACK){t.resultsPanelChart&&t.resultsPanelChart.close();delete t.chartData;t.wrap.simulateTrackEnd();t.wrap.clear();t.track.$trackList.find("li").removeClass(t.Const.Classes.SELECTEDTRACK);if(void 0!==t.layerTrack){t.map.removeLayer(t.layerTrack);t.layerTrack=void 0}t.map.$events.trigger($.Event(t.Const.Event.CLEARTRACK),{})}else t.getLayer(e).then(function(e){t.wrap.clear(e)})};e.saveTrack=function(){var e=this,t=new $.Deferred,i=arguments.length>0&&"string"==typeof arguments[0]?arguments[0]:e.getLocaleString("geo.trk.save.alert"),n=function(n){e.getLayer(n).then(function(n){var r;r=e.getLoadingIndicator().addWait();var s=e.importedFileName||e.track.$trackName.val().trim(),a=e.availableTracks;a||(a=[]);var o=TC.getUID(),l=e.wrap.formattedToStorage(n,!0);a.push({name:s,data:l.features,layout:l.layout,uid:parseInt(o)});a=T(a);var u=function(t){e.track.$trackName.val("");e.track.$trackName.attr("disabled","disabled");e.track.$trackSave.attr("disabled","disabled");e.track.$trackWPT.val("");e.track.$trackWPT.attr("disabled","disabled");e.track.$trackAdd.attr("disabled","disabled");e.getLoadingIndicator().removeWait(t);c.call(e)};try{e.setStoredTracks(a).then(function(){e.map.toast(i,{duration:3e3});u(r);for(var n,s=0;s<a.length;s++)if(parseInt(a[s].uid)===parseInt(o)){n=s;break}t.resolve(n)})}catch(i){TC.alert(e.getLocaleString("geo.error.savelocalstorage")+": "+i.message);u(r);t.reject()}})};if(e.importedFileName)n(e.Const.Layers.TRACK);else if(0==e.track.$trackName.val().trim().length){e.track.$trackName.val((new Date).toLocaleString());n(e.Const.Layers.TRACKING)}else n(e.Const.Layers.TRACKING);return t};e.addWaypoint=function(){var e=this.track.$trackWPT.val().trim();e||(e=(new Date).toLocaleString());var t=this.getLoadingIndicator().addWait();c.call(this);this.wrap.addWaypoint(this.currentPoint.position,{name:e,ele:this.currentPoint.heading,time:(new Date).getTime()});this.track.$trackWPT.val("");this.track.$trackWPT.attr("disabled","disabled");this.track.$trackAdd.attr("disabled","disabled");TC.Util.storage.setSessionLocalValue(this.Const.LocalStorageKey.TRACKINGTEMP,this.wrap.formattedToStorage(this.layerTracking).features);this.getLoadingIndicator().removeWait(t)};e.editTrackName=function(e,t){var i=this;i.getAvailableTracks().then(function(n){if(n&&n[e]){n[e].name=t;i.setStoredTracks(n)}})};e.removeTrack=function(e){var t=this;t.getAvailableTracks().then(function(i){if(i){var n=$(e).attr("data-id");if(i[n]){var r=i[n].uid;TC.confirm(t.getLocaleString("geo.trk.delete.alert"),function(){t.getSelectedTrack().length>0&&$(t.getSelectedTrack()[0]).attr("data-id")==n&&t.clear(t.Const.Layers.TRACK);localforage.removeItem(t.Const.LocalStorageKey.TRACKING+"#"+r).then(function(){t.getStoredTracks().then(function(){t.bindTracks()})}).catch(function(e){console.log(e)})},function(){})}}})};e.setSelectedTrack=function(e){this.isActive||this.activate();this.track.$trackList.find("li[data-id] > span").each(function(){$(this).attr("title",$(this).text())});this.track.$trackList.find("li").removeClass(this.Const.Classes.SELECTEDTRACK);e.addClass(this.Const.Classes.SELECTEDTRACK);$(e).attr("title",this.getLocaleString("tr.lst.clear")+" "+$(e).find("span").text());$(e).find(this.Const.Selector.DRAW).attr("title",$(e).attr("title"))};e.getSelectedTrack=function(){return this.track.$trackList.find("li."+this.Const.Classes.SELECTEDTRACK)};e.clearSelectedTrack=function(){var e=this.getSelectedTrack();if(e){if(this.onResize){window.removeEventListener("resize",this.onResize,!1);this.onResize=void 0}e.removeClass(this.Const.Classes.SELECTEDTRACK);e.attr("title",e.text());e.find(this.Const.Selector.DRAW).attr("title",e.attr("title"))}};e.clearSelection=function(){this.wrap.deactivateSnapping();this.getSelectedTrack()&&this.clearSelectedTrack();if(this.resultsPanelChart){this.resultsPanelChart._$div.off("mouseover",this.resultsPanelChart.deactivateSnapping);this.resultsPanelChart._$div.off("mouseout",this.resultsPanelChart.activateSnapping);this.resultsPanelChart.close()}this.clear(this.Const.Layers.TRACK)};e.drawTrackingData=function(e){var t=this;t.wrap.clear();t.getTrackingData(e).then(function(e){e.data;e.data&&t.wrap.drawTrackingData(e).then(function(){var e=t.layerTrack.features;if(e&&e.length>0){var i=e.filter(function(e){e.showsPopup=!1;return!!(TC.feature.MultiPolyline&&e instanceof TC.feature.MultiPolyline)||e instanceof TC.feature.Polyline}).map(function(e){return TC.feature.MultiPolyline&&e instanceof TC.feature.MultiPolyline?e.geometry[0]:e instanceof TC.feature.Polyline?e.geometry:void 0})[0];if(i){var n=i[0],r=i[i.length-1];n&&n!==r&&t.layerTrack.addMarker(n.slice().splice(0,2),{showsPopup:!1,cssClass:t.CLASS+"-track-marker-icon-end",anchor:[.5,1]});r&&t.layerTrack.addMarker(r.slice().splice(0,2),{showsPopup:!1,cssClass:t.CLASS+"-track-marker-icon",anchor:[.5,1]})}}t.layerTrack.setVisibility(!0)})})};e.getTrackingData=function(e){var t=e,i=new $.Deferred;this.getAvailableTracks().then(function(e){if(e){var n=$(t).attr("data-id");if(e[n])return i.resolve({data:e[n].data,layout:e[n].layout})}return i.resolve()});return i};e.export=function(e,t){return this.wrap.export(e,t)};e.getElevationTooltip=function(e){this.wrap.showElevationMarker(e);return this.resultsPanelChart.getElevationChartTooltip(e)};e.removeElevationTooltip=function(){this.wrap.hideElevationMarker()};e.clearFileInput=function(e){var t=$(e);t.wrap("<form>").closest("form").get(0).reset();t.unwrap()};e.getLoadingIndicator=function(){if(!this.loading){this.loading=this.map.getControlsByClass(TC.control.LoadingIndicator);this.loading&&this.loading.length>0&&(this.loading=this.loading[0])}return this.loading};e.onGeolocateError=function(e){var t;if(navigator.geolocation){this.currentPosition&&navigator.geolocation.clearWatch(this.currentPosition);this.currentPositionTrk&&navigator.geolocation.clearWatch(this.currentPositionTrk)}this.currentPositionWaiting&&this.getLoadingIndicator().removeWait(this.currentPositionWaiting);switch(e.code){case e.PERMISSION_DENIED:t=this.getLocaleString("geo.error.permission_denied");break;case e.POSITION_UNAVAILABLE:t=this.getLocaleString("geo.error.position_unavailable");break;case e.TIMEOUT:t=this.getLocaleString("geo.error.timeout");break;default:t=this.getLocaleString("geo.error.default")}this.map.toast(t,{type:TC.Consts.msgType.WARNING});if(!this.geopositionTracking&&this.track){this.track.$activateButton.toggleClass(TC.Consts.classes.HIDDEN,!1);this.track.$deactivateButton.toggleClass(TC.Consts.classes.HIDDEN,!0)}};e.getTrackingLayer=function(){return this._trackingLayerDeferred};var L=function(e){return!e||0===e.length};e.exportState=function(){const e=this,t={};if(e.layerTrack){const i=e.layerTrack.exportState();i.features=i.features.filter(function(e){return e.type===TC.Consts.geom.POLYLINE});t.id=e.id;t.track=i.features[0];t.trackName=e.getSelectedTrack().find("span").html()}return t};e.importState=function(e){const t=this;if(t.map&&e.track){t.enable();const i=new TC.layer.Vector;i.importState({features:[e.track]}).then(function(){t.importTrack({features:i.features,fileName:e.trackName})})}}}();TC.control=TC.control||{};TC.control.FeatureInfoCommons||TC.syncLoadJS(TC.apiLocation+"TC/control/FeatureInfoCommons");TC.filter||TC.syncLoadJS(TC.apiLocation+"TC/Filter");!function(){TC.control.GeometryFeatureInfo=function(){TC.control.FeatureInfoCommons.apply(this,arguments);this.wrap=new TC.wrap.control.GeometryFeatureInfo(this);this.lineColor=this.options.lineColor?this.options.lineColor:"#c00";this._isDrawing=!1;this._isSearching=!1;this._drawToken=!1};TC.inherit(TC.control.GeometryFeatureInfo,TC.control.FeatureInfoCommons);var e=TC.control.GeometryFeatureInfo.prototype;e.register=function(e){var t=this;TC.control.FeatureInfoCommons.prototype.register.call(t,e);t.$events.on(TC.Consts.event.CONTROLDEACTIVATE,function(e){t.wrap.cancelDraw()})};e.callback=function(e,t){var i=this;if(!i._drawToken){i.closeResults();for(var n=!1,r=0;r<i.map.workLayers.length;r++){var s=i.map.workLayers[r];if(s.type===TC.Consts.layerType.WMS&&s.getVisibility()&&s.names.length>0){n=!0;break}}if(n){i.closeResults();i.wrap.beginDraw({geometryType:i.geometryType,xy:e,layer:i.filterLayer,callback:function(e){i.wrap.getFeaturesByGeometry(e)}})}}};e.responseCallback=function(e){var t=this;TC.control.FeatureInfoCommons.prototype.responseCallback.call(t,e);if(t.filterFeature){var i=e.services;t.info={services:i};for(var n=0;n<i.length;n++){var r=i[n];if(r.hasLimits){delete r.layers;r.hasLimits=r.hasLimits}else{for(var s=0;s<r.layers.length;s++)if(!r.layers[s].features.length){r.layers.splice(s,1);s-=1}if(!r.layers.length){i.splice(n,1);n-=1}}}i.length?t.renderData(e,function(){t.insertLinks();t.displayResults()}):t.resultsLayer.clearFeatures()}}}();TC.control=TC.control||{};TC.control.ProjectionSelector||TC.syncLoadJS(TC.apiLocation+"TC/control/ProjectionSelector");!function(){TC.control.LayerCatalog=function(){var e=this;e.layers=[];e.searchInit=!1;TC.control.ProjectionSelector.apply(e,arguments);e._selectors={LAYER_ROOT:"div."+e.CLASS+"-tree > ul."+e.CLASS+"-branch > li."+e.CLASS+"-node"};e._readyDeferred=$.Deferred();TC.Consts.classes.SELECTABLE||(TC.Consts.classes.SELECTABLE="tc-selectable");TC.Consts.classes.INCOMPATIBLE||(TC.Consts.classes.INCOMPATIBLE="tc-incompatible");TC.Consts.classes.ACTIVE||(TC.Consts.classes.ACTIVE="tc-active");e._$div.on("mouseup.tc","li",function(t){var i=$(t.target);if(!i.hasClass(e.CLASS+"-leaf")){i.toggleClass(TC.Consts.classes.COLLAPSED);i.find("ul").first().toggleClass(TC.Consts.classes.COLLAPSED);t.stopPropagation()}})};TC.inherit(TC.control.LayerCatalog,TC.control.ProjectionSelector);var e=TC.control.LayerCatalog.prototype;e.CLASS="tc-ctl-lcat";e.template={};if(TC.isDebug){e.template[e.CLASS]=TC.apiLocation+"TC/templates/LayerCatalog.html";e.template[e.CLASS+"-branch"]=TC.apiLocation+"TC/templates/LayerCatalogBranch.html";e.template[e.CLASS+"-node"]=TC.apiLocation+"TC/templates/LayerCatalogNode.html";e.template[e.CLASS+"-info"]=TC.apiLocation+"TC/templates/LayerCatalogInfo.html";e.template[e.CLASS+"-results"]=TC.apiLocation+"TC/templates/LayerCatalogResults.html";e.template[e.CLASS+"-dialog"]=TC.apiLocation+"TC/templates/LayerCatalogDialog.html"}else{e.template[e.CLASS]=function(){dust.register(e.CLASS,t);function t(e,t){return e.w("<h2>").h("i18n",t,{},{$key:"availableLayers"}).x(t.get(["enableSearch"],!1),t,{block:i},{}).w('</h2><div class="tc-ctl-lcat-search tc-hidden tc-collapsed"><div class="tc-group"><input type="search" class="tc-ctl-lcat-input tc-textbox" placeholder="').h("i18n",t,{},{$key:"textToSearchInLayers"}).w('" /></div><ul></ul></div><div class="tc-ctl-lcat-tree">').x(t.get(["layerTrees"],!1),t,{else:r,block:s},{}).w('</div><div class="tc-ctl-lcat-info tc-hidden">').p("tc-ctl-lcat-info",t,t.rebase(t.getPath(!0,[])),{}).w("</div>")}t.__dustBody=!0;function i(e,t){return e.x(t.get(["layerTrees"],!1),t,{block:n},{})}i.__dustBody=!0;function n(e,t){return e.w('<button class="tc-ctl-lcat-btn-search" title="').h("i18n",t,{},{$key:"searchLayersbytext"}).w('"></button>')}n.__dustBody=!0;function r(e,t){return e.w('<div class="tc-ctl tc-ctl-lcat-loading"><span>').h("i18n",t,{},{$key:"loadingLayerTree"}).w("...</span></div>")}r.__dustBody=!0;function s(e,t){return e.w('<ul class="tc-ctl-lcat-branch">').s(t.get(["layerTrees"],!1),t,{block:a},{}).w("</ul>")}s.__dustBody=!0;function a(e,t){return e.p("tc-ctl-lcat-branch",t,t.rebase(t.getPath(!0,[])),{})}a.__dustBody=!0;return t};e.template[e.CLASS+"-branch"]=function(){dust.register(e.CLASS+"-branch",t);function t(e,t){return e.w("<li ").x(t.get(["children"],!1),t,{else:i,block:n},{}).w(' data-tc-layer-name="').f(t.get(["name"],!1),t,"h").w('" data-tc-layer-uid="').f(t.get(["uid"],!1),t,"h").w('"><span>').f(t.get(["title"],!1),t,"h").w('</span><ul class="tc-ctl-lcat-branch tc-collapsed">').s(t.get(["children"],!1),t,{block:r},{}).w("</ul></li>")}t.__dustBody=!0;function i(e,t){return e.w('class="tc-ctl-lcat-node tc-ctl-lcat-leaf"')}i.__dustBody=!0;function n(e,t){return e.w('class="tc-ctl-lcat-node tc-collapsed"')}n.__dustBody=!0;function r(e,t){return e.p("tc-ctl-lcat-node",t,t.rebase(t.getPath(!0,[])),{})}r.__dustBody=!0;return t};e.template[e.CLASS+"-node"]=function(){dust.register(e.CLASS+"-node",t);function t(e,t){return e.x(t.get(["isVisible"],!1),t,{block:i},{})}t.__dustBody=!0;function i(e,t){return e.w("<li ").x(t.get(["children"],!1),t,{else:n,block:r},{}).w(' data-tc-layer-name="').f(t.get(["name"],!1),t,"h").w('" data-tc-layer-uid="').f(t.get(["uid"],!1),t,"h").w('"><span data-tooltip="').x(t.get(["name"],!1),t,{block:s},{}).w('">').f(t.get(["title"],!1),t,"h").w("</span>").x(t.get(["name"],!1),t,{block:a},{}).w('<ul class="tc-ctl-lcat-branch tc-collapsed">').s(t.get(["children"],!1),t,{block:o},{}).w("</ul></li>")}i.__dustBody=!0;function n(e,t){return e.w('class="tc-ctl-lcat-node tc-ctl-lcat-leaf"')}n.__dustBody=!0;function r(e,t){return e.w('class="tc-ctl-lcat-node tc-collapsed"')}r.__dustBody=!0;function s(e,t){return e.h("i18n",t,{},{$key:"clickToAddToMap"})}s.__dustBody=!0;function a(e,t){return e.w('<button class="tc-ctl-lcat-btn-info"/>')}a.__dustBody=!0;function o(e,t){return e.p("tc-ctl-lcat-node",t,t.rebase(t.getPath(!0,[])),{})}o.__dustBody=!0;return t};e.template[e.CLASS+"-info"]=function(){dust.register(e.CLASS+"-info",t);function t(e,t){return e.w('<a class="tc-ctl-lcat-info-close"></a><h2>').h("i18n",t,{},{$key:"layerInfo"}).w('</h2><h3 class="tc-ctl-lcat-title">').f(t.get(["title"],!1),t,"h").w("</h3>").x(t.get(["abstract"],!1),t,{block:i},{}).x(t.get(["metadata"],!1),t,{block:n},{})}t.__dustBody=!0;function i(e,t){return e.w('<div class="tc-ctl-lcat-abstract"><h4>').h("i18n",t,{},{$key:"abstract"}).w("</h4><div>").f(t.get(["abstract"],!1),t,"h").w("</div></div>")}i.__dustBody=!0;function n(e,t){return e.w('<div class="tc-ctl-lcat-metadata"><h4>').h("i18n",t,{},{$key:"metadata"}).w("</h4><ul>").s(t.get(["metadata"],!1),t,{block:r},{}).w("</ul></div>")}n.__dustBody=!0;function r(e,t){return e.w('<li><a href="').f(t.get(["url"],!1),t,"h",["s"]).w('" type="').f(t.get(["format"],!1),t,"h").w('" title="').f(t.get(["formatDescription"],!1),t,"h").w('" target="_blank">').f(t.get(["formatDescription"],!1),t,"h").w("</a></li>")}r.__dustBody=!0;return t};e.template[e.CLASS+"-results"]=function(){dust.register(e.CLASS+"-results",t);function t(e,t){return e.s(t.get(["servicesFound"],!1),t,{else:i,block:n},{})}t.__dustBody=!0;function i(e,t){return e.w('<li class="tc-ctl-lcat-no-results"><h5>').h("i18n",t,{},{$key:"noMatches"}).w("</h5></li>")}i.__dustBody=!0;function n(e,t){return e.h("gt",t,{block:r},{key:t.get(["servicesLooked"],!1),value:1}).s(t.get(["founds"],!1),t,{block:a},{}).h("gt",t,{block:c},{key:t.get(["servicesLooked"],!1),value:1})}n.__dustBody=!0;function r(e,t){return e.w('<li class="tc-ctl-lcat-search-group ').x(t.getPath(!1,["service","isCollapsed"]),t,{block:s},{}).w('" data-tc-service-index="').f(t.getPath(!1,["service","index"]),t,"h").w('"><h5>').f(t.getPath(!1,["service","title"]),t,"h").w("</h5><ul>")}r.__dustBody=!0;function s(e,t){return e.w("tc-collapsed")}s.__dustBody=!0;function a(e,t){return e.w('<li data-tc-layer-name="').f(t.get(["Name"],!1),t,"h").w('" ').x(t.get(["alreadyAdded"],!1),t,{else:o,block:l},{}).w('><h5 class="tc-selectable">').f(t.get(["Title"],!1),t,"h").w('</h5><button class="tc-ctl-lcat-search-btn-info" /></li>')}a.__dustBody=!0;function o(e,t){return e.w(' data-tooltip="').h("i18n",t,{},{$key:"clickToAddToMap"}).w('" ')}o.__dustBody=!0;function l(e,t){return e.w(' data-tooltip="').h("i18n",t,{},{$key:"layerAlreadyAdded"}).w('" class="tc-checked" ')}l.__dustBody=!0;function c(e,t){return e.w("</ul></li>")}c.__dustBody=!0;return t};e.template[e.CLASS+"-dialog"]=function(){dust.register(e.CLASS+"-dialog",t);function t(e,t){return e.w('<div class="tc-ctl-lcat-crs-dialog tc-modal"><div class="tc-modal-background tc-modal-close"></div><div class="tc-modal-window"><div class="tc-modal-header"><h3>').h("i18n",t,{},{$key:"changeCRS"}).w('</h3><div class="tc-ctl-popup-close tc-modal-close"></div></div><div class="tc-modal-body"><p>').h("i18n",t,{},{$key:"wmsLayerNotCompatible.instructions|h"}).w('</p><ul class="tc-ctl-lcat-crs-list tc-crs-list"></ul></div><div class="tc-modal-footer"><button type="button" class="tc-button tc-modal-close">').h("i18n",t,{},{$key:"close"}).w("</button></div></div></div>")}t.__dustBody=!0;return t}}var t="tcLayer",i="tcLayerName",n="tcLayerInfo",r="tcServiceIndex";const s=function(e,t){e.showProjectionChangeDialog({layer:t,closeCallback:function(){$(e.getLayerNodes(t)).removeClass(TC.Consts.classes.LOADING).find("span").attr(a,e.getLocaleString("clickToAddToMap"))}})};var a="data-tooltip";e.register=function(e){var n=this;TC.control.ProjectionSelector.prototype.register.call(n,e);var r=function(){if($.isArray(n.options.layers)){for(var e=0;e<n.options.layers.length;e++){var t=n.options.layers[e];if(!t.type||t.type===TC.Consts.layerType.WMS){t.id||(t.id=TC.getUID());$.isPlainObject(t)&&(t=new TC.layer.Raster(t));n.layers.push(t)}}n.render(function(){n._readyDeferred.resolve()})}else n._readyDeferred.resolve()},s=function(t){if(t.layer===e.baseLayer){r();e.off(TC.Consts.event.LAYERUPDATE,s)}};e.loaded(function(){e.baseLayer.state&&e.baseLayer.state!==TC.Layer.state.IDLE?e.on(TC.Consts.event.LAYERUPDATE,s):r()});var o=function(){if("createEvent"in document){var e=document.createEvent("HTMLEvents");e.initEvent("keyup",!1,!0);n.$text&&n.$text[0].dispatchEvent(e)}else n.$text&&n.$text[0].fireEvent("keyup")},l=n.getLocaleString("layerAlreadyAdded"),c=n.getLocaleString("clickToAddToMap");e.on(TC.Consts.event.BEFORELAYERADD+" "+TC.Consts.event.BEFOREUPDATEPARAMS,function(e){const t=$(n.getLayerNodes(e.layer));t.hasClass(TC.Consts.classes.LOADING)||t.addClass(TC.Consts.classes.LOADING).find("span").removeAttr(a)}).on(TC.Consts.event.LAYERADD+" "+TC.Consts.event.UPDATEPARAMS,function(e){var t=e.layer;t.isBase||t.type!==TC.Consts.layerType.WMS||n._readyDeferred.then(function(){var e=$(n.getLayerRootNode(t)),i=function(){$(n.getLayerNodes(t)).removeClass(TC.Consts.classes.LOADING).addClass(TC.Consts.classes.CHECKED).find("span").attr(a,l);o()};if(e.length)i();else{for(var r=!1,s=0,c=n.layers.length;s<c;s++){var u=n.layers[s];if(u.type===t.type&&u.options.url===t.options.url){r=!0;break}}r||n.addLayer(new TC.layer.Raster({url:t.options.url,type:t.type,layerNames:[],title:t.title||t.wrap.getServiceTitle(),hideTitle:!0,hideTree:!1})).then(function(){e=$(n.getLayerRootNode(t));i()})}})}).on(TC.Consts.event.LAYERERROR,function(e){e.reason&&TC.alert(n.getLocaleString(e.reason,{url:e.layer.url}));$(n.getLayerNodes(e.layer)).removeClass(TC.Consts.classes.LOADING)}).on(TC.Consts.event.LAYERREMOVE,function(e){$(n.getLayerNodes(e.layer)).removeClass(TC.Consts.classes.CHECKED).find("span").attr(a,c);(function(e){var i=$();if(!e.isBase){var r=e.options.url;n.$list&&n.$list.find("li").each(function(n,s){var a=$(s),o=a.data(t);if(o&&o.type===e.type&&o.options.url===r)for(var l=0;l<e.names.length;l++)a.is('li[data-tc-layer-name="'+e.names[l]+'"]')&&(i=i.add(a))})}return i})(e.layer).removeClass(TC.Consts.classes.CHECKED).attr(a,c);!function(e){var t=n.map.getControlsByClass(TC.control.WorkLayers)[0];if(t)for(var i=t.layers,r=0;r<i.length;r++){var s=i[r];s!==e&&$(n.getLayerNodes(s)).addClass(TC.Consts.classes.CHECKED).find("span").attr(a,l)}}(e.layer);o()}).on(TC.Consts.event.EXTERNALSERVICEADDED,function(e){if(e&&e.layer){n.addLayer(e.layer);n._$div.removeClass("tc-collapsed")}}).on(TC.Consts.event.PROJECTIONCHANGE,function(e){n.update()});n._$div.on(TC.Consts.event.CLICK,"span",function(e){var r=$(e.target).parent();if(!r.hasClass(TC.Consts.classes.LOADING)&&!r.hasClass(TC.Consts.classes.CHECKED)){e.preventDefault;var s=r.data(i);s=void 0!==s?s.toString():"";var o=n._$roots.has(r).data(t);o||(o=r.data(t));if(o&&s){var l=1;/iPad/i.test(navigator.userAgent)?l=10:TC.Util.detectFirefox()&&(l=250);o.title||(o.title=o.getTree().title);r.addClass(TC.Consts.classes.LOADING).find("span").attr(a,"");(function(e){var t=new $.Deferred;setTimeout(function(){e[0].offsetHeight=e[0].offsetHeight;e[0].offsetWidth=e[0].offsetWidth;t.resolve()},l);return t.promise()})(r).then(function(){n.addLayerToMap(o,s);e.stopPropagation()})}}})};e.render=function(e){var o=this,l=$.map(o.layers,function(e){return e.wrap.getLayer()});$.when.apply(o,l).then(function(){var l=$.map(o.layers,function(e){var t=e.getTree();!function t(i){for(var n=!1,r=0;r<i.children.length;r++)t(i.children[r])&&(n=!0);i.hasOwnProperty("isVisible")&&(i.isVisible=!e.names||!e.names.length||n||i.isVisible);return i.isVisible}(t);return t});o.renderData({layerTrees:l,enableSearch:o.options.enableSearch},function(){var l=o.getLocaleString("layerAlreadyAdded");o._$roots=o._$div.find(o._selectors.LAYER_ROOT);o._$roots.each(function(e,r){var s=o.layers[e],c={};$(r).data(t,s).find("."+o.CLASS+"-btn-info").each(function(e,t){var r=$(t),u=r.parent().find("span").first(),h=r.parent().data(i).toString();if(h){u.addClass(TC.Consts.classes.SELECTABLE);var p=s.wrap.getInfo(h);if(p.hasOwnProperty("abstract")||p.hasOwnProperty("legend")||p.hasOwnProperty("metadata")){if(p.metadata)for(var d=0,f=p.metadata.length;d<f;d++){var m=p.metadata[d];m.formatDescription=c[m.format]=c[m.format]||o.getLocaleString(TC.Util.getSimpleMimeType(m.format))||o.getLocaleString("viewMetadata")}r.data(n,p);r.on(TC.Consts.event.CLICK,function(){if($(this).hasClass(TC.Consts.classes.CHECKED)){$(this).removeClass(TC.Consts.classes.CHECKED);o.hideLayerInfo()}else{o.showLayerInfo(s,h);$(this).addClass(TC.Consts.classes.CHECKED)}})}else r.remove();s.compatibleLayers&&s.compatibleLayers.indexOf(h)<0&&u.addClass(TC.Consts.classes.INCOMPATIBLE).attr("title",o.getLocaleString("reprojectionNeeded"));if(o.map)for(d=0,f=o.map.workLayers.length;d<f;d++){var y=o.map.workLayers[d];if(y.type===TC.Consts.layerType.WMS&&y.url===s.url&&1===y.names.length&&y.names[0]===h){u.parent().addClass(TC.Consts.classes.CHECKED);u.attr(a,l)}}}else{u.attr(a,"");r.remove()}})});o.getRenderedHtml(o.CLASS+"-dialog",null,function(e){o._$dialogDiv.html(e)});o.$text=o._$div.find("."+o.CLASS+"-input");o.$list=o._$div.find("."+o.CLASS+"-search ul");o.$text.on("mouseup",function(e){""!==o.$text.val()&&setTimeout(function(){""===o.$text.val()&&o.$list.empty()},1)});var c=[];TC._search=TC._search||{};TC._search.retryTimeout=null;TC.loadJS(!o.$text.autocomplete,[TC.apiLocation+"lib/jQuery/autocomplete.js"],function(){o.$text.autocomplete({link:"#",target:o.$list,minLength:0,source:function(e,t){c=[];o._$roots.find("li."+TC.Consts.classes.CHECKED).each(function(e,t){c.push($(t).data(i).toString())});if((e=e.trim()).length<3)o.$list.html("");else if(e.length>=3){TC._search.retryTimeout&&clearTimeout(TC._search.retryTimeout);TC._search.retryTimeout=setTimeout(function(){for(var i=[],n=0;n<o.layers.length;n++){var r=o.layers[n].searchSubLayers(e);r.length&&i.push({service:{index:n,title:o.layers[n].title||o.layers[n].id},founds:r})}t({servicesFound:i,servicesLooked:o.layers.length})},TC._search.interval)}},callback:function(e){o.$text.val(e.target.text||e.target.innerText);TC._search.lastPattern=o.$text.val();o.goToResult(unescape(e.target.hash).substring(1));o.$text.autocomplete("clear")},buildHTML:function(e){if(e.results&&e.results.servicesFound.length>0)for(var t=o.map.getLayerTree().workLayers,i=0;i<e.results.servicesFound.length;i++){for(var n=e.results.servicesFound[i].founds,r=0;r<n.length;r++){delete n[r].alreadyAdded;for(var s=0;s<t.length;s++)if(c.indexOf(n[r].Name)>=0){n[r].alreadyAdded=!0;break}if(!n[r].Name){n.splice(r,1);r--}}e.results.servicesFound[i].founds.length?e.results.servicesFound[i].service.isCollapsed=$(o._$div.find(".tc-ctl-lcat-search-group")[i]).hasClass(TC.Consts.classes.COLLAPSED):e.results.servicesFound.splice(i,1)}var a="";dust.render(o.CLASS+"-results",e.results,function(e,t){a=t});return a}})});if(!o.searchInit){o._$div.on("click","h2 button",function(){var e=o._$div.hasClass("tc-collapsed");o._$div.removeClass("tc-collapsed");var t=o._$div.find("."+o.CLASS+"-search"),i=o._$div.find("."+o.CLASS+"-tree"),n=o._$div.find("."+o.CLASS+"-info");if(t.hasClass(TC.Consts.classes.HIDDEN)||e){t.removeClass(TC.Consts.classes.HIDDEN);i.addClass(TC.Consts.classes.HIDDEN);o.$text[0].focus();$(this).addClass(o.CLASS+"-btn-tree");$(this).attr("title",o.getLocaleString("viewAvailableLayersTree"));$(this).removeClass(o.CLASS+"-btn-search");0===$(".tc-ctl-lcat-search li button.tc-checked").length&&n.addClass(TC.Consts.classes.HIDDEN)}else{t.addClass(TC.Consts.classes.HIDDEN);i.removeClass(TC.Consts.classes.HIDDEN);$(this).addClass(o.CLASS+"-btn-search");$(this).attr("title",o.getLocaleString("searchLayersByText"));$(this).removeClass(o.CLASS+"-btn-tree");$(".tc-ctl-lcat-tree li button.tc-checked").length>0&&n.removeClass(TC.Consts.classes.HIDDEN)}});o._$div.on("click","."+o.CLASS+"-search button."+o.CLASS+"-search-btn-info",function(e){e.stopPropagation();if($(this).hasClass(TC.Consts.classes.CHECKED)){$(this).removeClass(TC.Consts.classes.CHECKED);o.hideLayerInfo()}else{var t=$(this).parent();o.showLayerInfo(o.layers[t.parents("li").data(r)],t.data(i));$(this).addClass(TC.Consts.classes.CHECKED)}});o._$div.on("click",".tc-ctl-lcat-search li",function(e){e.stopPropagation();var n=$(this);if(!n.hasClass("tc-ctl-lcat-no-results"))if(n.hasClass("tc-ctl-lcat-search-group"))n.toggleClass(TC.Consts.classes.COLLAPSED);else{var c=n.data(i);c=void 0!==c?c.toString():"";if(!$(this).hasClass(TC.Consts.classes.CHECKED)){var u=n.parents("li.tc-ctl-lcat-search-group"),h=o.layers[0==u.length?0:u.data(r)].options.url,p=o.layers[0==u.length?0:u.data(r)].title;const e=new TC.layer.Raster({id:o.getUID(),url:h,title:p,hideTitle:!0,layerNames:[c]});if(e.isCompatible(o.map.crs)){o.map.addLayer(e,function(e){n.data(t,e);e.wrap.$events.on(TC.Consts.event.TILELOADERROR,function(e){var t=this.parent;401!==e.error.code&&403!==e.error.code||t.map.toast(e.error.text,{type:TC.Consts.msgType.ERROR});t.map.removeLayer(t)})});$(this).addClass(TC.Consts.classes.CHECKED);$(this).attr(a,l)}else s(o,e)}}});o.searchInit=!0}$.isFunction(e)&&e()})})};e.getLayerRootNode=function(e){const i=this;var n=null;if(!e.isBase){var r=e.options.url;i._$roots&&i._$roots.each(function(i,s){var a=$(s).data(t);a&&a.type===e.type&&a.options.url===r&&(n=s)})}return n};e.getLayerNodes=function(e){var t=[],i=$(this.getLayerRootNode(e));if(i.length)for(var n=0;n<e.names.length;n++){const r=i.find('li[data-tc-layer-name="'+e.names[n]+'"]');if(0!=r.length){t[t.length]=r[0];r.find("li").each(function(e,i){t[t.length]=i})}}return t};e.showLayerInfo=function(e,r){var s=this,a=null,o=s._$div.find("."+s.CLASS+"-info");s._$div.find("."+s.CLASS+"-btn-info, ."+s.CLASS+"-search-btn-info").removeClass(TC.Consts.classes.CHECKED);s._$roots.each(function(l,c){var u=$(c);if(u.data(t)===e){u.find("."+s.CLASS+"-btn-info").each(function(e,t){var l=$(t),c=l.parent().data(i).toString();if(c===r){var u=l.data(n);s._$div.find('li [data-tc-layer-name="'+c+'"] > button').toggleClass(TC.Consts.classes.CHECKED,function(e,t){var n=!1;o.data(i);if(t){n=!0;o.data(i,e);o.removeClass(TC.Consts.classes.HIDDEN);dust.render(s.CLASS+"-info",t,function(e,t){o.html(t);e&&TC.error(e);o.find("."+s.CLASS+"-info-close").on(TC.Consts.event.CLICK,function(){s.hideLayerInfo()})})}return n}(c,u));a=u;return!1}});return!1}});return a};e.update=function(){const e=this;e.layers.forEach(function(t){t.getCapabilitiesPromise().then(function(){t.compatibleLayers=t.wrap.getCompatibleLayers(e.map.crs);$(e.getLayerRootNode(t)).find("li[data-tc-layer-name]").each(function(n,r){const s=$(r),a=s.data(i),o=s.find("span."+TC.Consts.classes.SELECTABLE);t.compatibleLayers.indexOf(a)<0?o.addClass(TC.Consts.classes.INCOMPATIBLE).attr("title",e.getLocaleString("reprojectionNeeded")):o.removeClass(TC.Consts.classes.INCOMPATIBLE).attr("title",null)})})})};e.hideLayerInfo=function(){this._$div.find("."+this.CLASS+"-btn-info, ."+this.CLASS+"-search-btn-info").removeClass(TC.Consts.classes.CHECKED);this._$div.find("."+this.CLASS+"-info").addClass(TC.Consts.classes.HIDDEN)};e.addLayer=function(e){var t=$.Deferred(),i=this,n=[];i.options.layers&&i.options.layers.length&&(n=$.grep(i.options.layers,function(t){var i=TC.Util.reqGetMapOnCapabilities(t.url);return i&&i.replace(TC.Util.regex.PROTOCOL)==e.url.replace(TC.Util.regex.PROTOCOL)}));0==n.length&&(n=$.grep(i.layers,function(t){return t.url.replace(TC.Util.regex.PROTOCOL)==e.url.replace(TC.Util.regex.PROTOCOL)}));if(0==n.length){i.layers.push(e);e.getCapabilitiesPromise().then(function(){e.compatibleLayers=e.wrap.getCompatibleLayers(i.map.crs);e.title=e.title||e.wrap.getServiceTitle();i.render(function(){t.resolve()})})}else t.resolve();return t};e.addLayerToMap=function(e,t){const i=this,n=$.extend({},e.options);n.id=i.getUID();n.layerNames=[t];n.title=e.title;const r=new TC.layer.Raster(n);r.isCompatible(i.map.crs)?i.map.addLayer(n).then(function(e){e.wrap.$events.on(TC.Consts.event.TILELOADERROR,function(e){var t=this.parent;401!==e.error.code&&403!==e.error.code||t.map.toast(e.error.text,{type:TC.Consts.msgType.ERROR});t.map.removeLayer(t)})}):s(i,r)};e.loaded=function(){return this._readyDeferred.promise()};e.getAvailableCRS=function(e){e=e||{};return this.map.getCompatibleCRS({layers:this.map.workLayers.concat(this.map.baseLayer,e.layer),includeFallbacks:!0})};e.setProjection=function(e){const t=this;e=e||{};TC.loadProjDef({crs:e.crs,callback:function(){t.map.setProjection(e).then(function(){t._layerToAdd&&t.map.addLayer(t._layerToAdd);TC.Util.closeModal()})}})};e.showProjectionChangeDialog=function(e){this._layerToAdd=e.layer;TC.control.ProjectionSelector.prototype.showProjectionChangeDialog.call(this,e)}}();TC.control=TC.control||{};TC.control.MapContents||TC.syncLoadJS(TC.apiLocation+"TC/control/MapContents");TC.control.Legend=function(){TC.control.MapContents.apply(this,arguments)};TC.inherit(TC.control.Legend,TC.control.MapContents);!function(){var e=TC.control.Legend.prototype;e.CLASS="tc-ctl-legend";e.template={};if(TC.isDebug){e.template[e.CLASS]=TC.apiLocation+"TC/templates/Legend.html";e.template[e.CLASS+"-node"]=TC.apiLocation+"TC/templates/LegendNode.html"}else{e.template[e.CLASS]=function(){dust.register(e.CLASS,t);function t(e,t){return e.w("<h2>").h("i18n",t,{},{$key:"legend"}).w('</h2><div class="tc-ctl-legend-tree"><ul class="tc-ctl-legend-branch">').s(t.get(["workLayers"],!1),t,{else:i,block:n},{}).w("</ul></div>")}t.__dustBody=!0;function i(e,t){return e.w('<li class="tc-ctl-legend-empty">').h("i18n",t,{},{$key:"noData"}).w("</li>")}i.__dustBody=!0;function n(e,t){return e.p("tc-ctl-legend-node",t,t.rebase(t.getPath(!0,[])),{})}n.__dustBody=!0;return t};e.template[e.CLASS+"-node"]=function(){dust.register(e.CLASS+"-node",t);function t(e,t){return e.x(t.get(["customLegend"],!1),t,{else:i,block:p},{})}t.__dustBody=!0;function i(e,t){return e.w("<li ").x(t.get(["children"],!1),t,{else:n,block:r},{}).w(' data-tc-layer-name="').f(t.get(["name"],!1),t,"h").w('" data-tc-layer-uid="').f(t.get(["uid"],!1),t,"h").w('"><div class="tc-ctl-legend-title">').f(t.get(["title"],!1),t,"h").w("</div>").x(t.get(["legend"],!1),t,{block:s},{}).w('<ul class="tc-ctl-legend-branch">').s(t.get(["children"],!1),t,{block:h},{}).w("</ul></li>")}i.__dustBody=!0;function n(e,t){return e.w('class="tc-ctl-legend-node tc-ctl-legend-leaf" ')}n.__dustBody=!0;function r(e,t){return e.w('class="tc-ctl-legend-node" ')}r.__dustBody=!0;function s(e,t){return e.w('<div class="tc-ctl-legend-watch">').x(t.getPath(!1,["legend","src"]),t,{else:a,block:c},{}).w('</div><div class="tc-ctl-legend-nvr">').h("i18n",t,{},{$key:"notVisibleAtCurrentResolution"}).w("</div>")}s.__dustBody=!0;function a(e,t){return e.x(t.getPath(!1,["legend","width"]),t,{block:o},{})}a.__dustBody=!0;function o(e,t){return e.w('<div class="tc-ctl-legend-img" style="border:solid ').f(t.getPath(!1,["legend","strokeWidth"]),t,"h").w("px ").f(t.getPath(!1,["legend","strokeColor"]),t,"h").w(";background-color:").f(t.getPath(!1,["legend","fillColor"]),t,"h").x(t.getPath(!1,["legend","width"]),t,{block:l},{}).w('"></div>')}o.__dustBody=!0;function l(e,t){return e.w(";width:").f(t.getPath(!1,["legend","width"]),t,"h").w("px;height:").f(t.getPath(!1,["legend","height"]),t,"h").w("px;border-radius:50%")}l.__dustBody=!0;function c(e,t){return e.w('<img src="" data-tc-img="').f(t.getPath(!1,["legend","src"]),t,"h").w('" ').x(t.getPath(!1,["legend","width"]),t,{block:u},{}).w(" />")}c.__dustBody=!0;function u(e,t){return e.w('style="width:').f(t.getPath(!1,["legend","width"]),t,"h").w("px;height:").f(t.getPath(!1,["legend","height"]),t,"h").w('px;" ')}u.__dustBody=!0;function h(e,t){return e.p("tc-ctl-legend-node",t,t.rebase(t.getPath(!0,[])),{})}h.__dustBody=!0;function p(e,t){return e.f(t.get(["customLegend"],!1),t,"h",["s"])}p.__dustBody=!0;return t}}var t="tcLayer",i="tcLayerUid";e.register=function(e){TC.control.MapContents.prototype.register.call(this,e)};e.loadGraphics=function(){var e=this;e._$div.find("ul."+e.CLASS+"-branch").first().children("li").not("."+e.CLASS+"-empty").each(function(i,n){var r=$(n),s=r.data(t);s&&r.find("li.tc-ctl-legend-node-visible").each(function(t,i){var n=$(i).find("img").first();n&&void 0!=n.attr("src")&&0==n.attr("src").length&&e.styleLegendImage(n,s)})})};e.updateScale=function(){var e=this,n=e.CLASS+"-node-inscale",r=e.CLASS+"-node-outofscale";e._$div.find("ul."+e.CLASS+"-branch").first().children("li").not("."+e.CLASS+"-empty").each(function(s,a){var o=$(a),l=o.data(t);if(l){var c=!1;o.find("li").each(function(t,s){var a=$(s);if(a.hasClass(e.CLASS+"-node-visible")){var o=a.data(i);if(l.isVisibleByScale(o)){c=!0;a.removeClass(r).addClass(n);var u=a.find("img").first();u.length>0&&e.styleLegendImage(u,l)}else a.addClass(r).removeClass(n)}});o.toggleClass(n,c);o.toggleClass(r,!c)}})};e.update=function(){var e=this;e._$div.find("ul."+e.CLASS+"-branch").first().children("li").each(function(n,r){var s=$(r),a=s.data(t);if(a){a.getTree();s.find("li").each(function(t,n){var r=$(n),s=r.data(i),o=e.CLASS+"-node-visible",l=e.CLASS+"-node-notvisible",c=e.CLASS+"-node-hasvisible";switch(a._cache.visibilityStates[s]){case TC.Consts.visibility.NOT_VISIBLE:r.removeClass(o+" "+c).addClass(l);break;case TC.Consts.visibility.HAS_VISIBLE:r.removeClass(o+" "+l).addClass(c);break;default:r.removeClass(l+" "+c).addClass(o)}});e.updateLayerVisibility(a)}});e.updateScale()};e.updateLayerTree=function(e){var n=this;if(!e.isBase&&!e.options.stealth){TC.control.MapContents.prototype.updateLayerTree.call(n,e);n._$div.find("."+n.CLASS+"-empty").addClass(TC.Consts.classes.HIDDEN);TC.loadJSInOrder(!window.dust,TC.url.templating,function(){dust.render(n.CLASS+"-node",n.layerTrees[e.id],function(r,s){var a=$(s),o=a.data(i),l=n._$div.find("ul."+n.CLASS+"-branch").first(),c=l.find('li[data-tc-layer-uid="'+o+'"]');if(1===c.length)c.html(a.html());else{a.data(t,e);l.prepend(a)}r&&TC.error(r)});n.update()})}};e.removeLayer=function(e){var i=this,n=function(){return i._$div.find("."+i.CLASS+"-branch").first().children("li").not("."+i.CLASS+"-empty")};if(!e.isBase){var r=n();r.each(function(i,s){var a=$(s);if(a.data(t)===e){a.remove();r=n();return!1}});0===r.length&&i._$div.find("."+i.CLASS+"-empty").removeClass(TC.Consts.classes.HIDDEN)}};e.updateLayerVisibility=function(e){var i=this;i._$div.find("."+i.CLASS+"-branch").first().children("li").each(function(n,r){var s=$(r);if(s.data(t)===e){s.toggleClass(i.CLASS+"-node-notvisible",!e.getVisibility());return!1}})};e.getLayerUIElements=function(){return this._$div.find("ul."+this.CLASS+"-branch").first().children("li."+this.CLASS+"-node")}}();TC.control=TC.control||{};TC.control.GeometryFeatureInfo||TC.syncLoadJS(TC.apiLocation+"TC/control/GeometryFeatureInfo");!function(){TC.control.LineFeatureInfo=function(){TC.control.GeometryFeatureInfo.apply(this,arguments);this.geometryType=TC.Consts.geom.POLYLINE};TC.inherit(TC.control.LineFeatureInfo,TC.control.GeometryFeatureInfo);var e=TC.control.LineFeatureInfo.prototype;e.CLASS="tc-ctl-finfo";e.template={};if(TC.isDebug){e.template[e.CLASS]=TC.apiLocation+"TC/templates/FeatureInfo.html";e.template[e.CLASS+"-dialog"]=TC.apiLocation+"TC/templates/FeatureInfoDialog.html"}else{e.template[e.CLASS]=function(){dust.register(e.CLASS,t);function t(e,t){return e.w('<ul class="tc-ctl-finfo-services">').s(t.get(["services"],!1),t,{else:i,block:n},{}).w("</ul>").x(t.get(["featureCount"],!1),t,{block:O},{})}t.__dustBody=!0;function i(e,t){return e.w('<li class="tc-ctl-finfo-empty">').h("i18n",t,{},{$key:"noData"}).w("</li>")}i.__dustBody=!0;function n(e,t){return e.w("<li><h3>").x(t.getPath(!1,["mapLayer","title"]),t,{else:r,block:s},{}).w('</h3><div class="tc-ctl-finfo-service-content">').s(t.get(["hasLimits"],!1),t,{else:a,block:E},{}).w("</div></li>")}n.__dustBody=!0;function r(e,t){return e.f(t.getPath(!1,["mapLayer","id"]),t,"h")}r.__dustBody=!0;function s(e,t){return e.f(t.getPath(!1,["mapLayer","title"]),t,"h")}s.__dustBody=!0;function a(e,t){return e.w('<ul class="tc-ctl-finfo-layers">').s(t.get(["layers"],!1),t,{else:o,block:l},{}).w("</ul>")}a.__dustBody=!0;function o(e,t){return e.w('<li class="tc-ctl-finfo-empty">').h("i18n",t,{},{$key:"noDataAtThisService"}).w("</li>")}o.__dustBody=!0;function l(e,t){return e.w("<li><h4>").s(t.get(["path"],!1),t,{block:c},{}).w(' <span class="tc-ctl-finfo-layer-n">').f(t.getPath(!1,["features","length"]),t,"h").w('</span> </h4> <div class="tc-ctl-finfo-layer-content"><ul class="tc-ctl-finfo-features">').s(t.get(["features"],!1),t,{else:h,block:p},{}).w("</ul></div></li>")}l.__dustBody=!0;function c(e,t){return e.f(t.getPath(!0,[]),t,"h").h("sep",t,{block:u},{})}c.__dustBody=!0;function u(e,t){return e.w(" &bull; ")}u.__dustBody=!0;function h(e,t){return e.w('<li class="tc-ctl-finfo-empty">').h("i18n",t,{},{$key:"noDataInThisLayer"}).w("</li>")}h.__dustBody=!0;function p(e,t){return e.w("<li>").x(t.get(["rawContent"],!1),t,{else:d,block:v},{}).w("</li>")}p.__dustBody=!0;function d(e,t){return e.x(t.get(["error"],!1),t,{else:f,block:C},{})}d.__dustBody=!0;function f(e,t){return e.w("<h5>").f(t.get(["id"],!1),t,"h").w("</h5><table").x(t.get(["geometry"],!1),t,{block:m},{}).w("><tbody>").s(t.get(["attributes"],!1),t,{block:y},{}).w("</tbody></table>").x(t.get(["geometry"],!1),t,{block:g},{})}f.__dustBody=!0;function m(e,t){return e.w(' title="').h("i18n",t,{},{$key:"clickToCenter"}).w('"')}m.__dustBody=!0;function y(e,t){return e.w('<tr><th class="tc-ctl-finfo-attr">').f(t.get(["name"],!1),t,"h").w('</th><td class="tc-ctl-finfo-val">').f(t.get(["value"],!1),t,"h").w("</td></tr>")}y.__dustBody=!0;function g(e,t){return e.w('<div class="tc-ctl-finfo-tools"><button class="tc-ctl-finfo-tools-btn" title="').h("i18n",t,{},{$key:"download"}).w("/").h("i18n",t,{},{$key:"share"}).w('">').h("i18n",t,{},{$key:"download"}).w("/").h("i18n",t,{},{$key:"share"}).w("</button></div>")}g.__dustBody=!0;function C(e,t){return e.w('<span class="tc-ctl-finfo-errors">').h("i18n",t,{},{$key:"fi.error"}).w('<span class="tc-ctl-finfo-error-text">').f(t.get(["error"],!1),t,"h").w("</span></span>")}C.__dustBody=!0;function v(e,t){return e.w("<h5>").h("i18n",t,{},{$key:"feature"}).w("</h5>").h("eq",t,{else:T,block:L},{key:t.get(["rawFormat"],!1),value:"text/html"})}v.__dustBody=!0;function T(e,t){return e.w("<pre>").f(t.get(["rawContent"],!1),t,"h").w("</pre>")}T.__dustBody=!0;function L(e,t){return e.w(" ").x(t.get(["expandUrl"],!1),t,{block:w},{})}L.__dustBody=!0;function w(e,t){return e.h("ne",t,{else:b,block:S},{key:t.get(["expandUrl"],!1),value:""})}w.__dustBody=!0;function b(e,t){return e.w('<iframe src="').f(t.get(["rawUrl"],!1),t,"h").w('" />')}b.__dustBody=!0;function S(e,t){return e.w('<div class="tc-ctl-finfo-features-iframe-cnt"><iframe src="').f(t.get(["rawUrl"],!1),t,"h").w('" /><a class="tc-ctl-finfo-open" onclick="window.open(\'').f(t.get(["expandUrl"],!1),t,"h").w("', '_blank')\" title=\"").h("i18n",t,{},{$key:"expand"}).w('"></a></div>')}S.__dustBody=!0;function E(e,t){return e.w('<span class="tc-ctl-finfo-errors">').f(t.get(["hasLimits"],!1),t,"h").w("</span>")}E.__dustBody=!0;function O(e,t){return e.h("gt",t,{block:A},{key:t.get(["featureCount"],!1),value:"1",type:"number"})}O.__dustBody=!0;function A(e,t){return e.w('<a class="tc-ctl-btn tc-ctl-finfo-btn-prev">').h("i18n",t,{},{$key:"previous"}).w('</a><div class="tc-ctl-finfo-counter"><span class="tc-ctl-finfo-idx"></span>/').f(t.get(["featureCount"],!1),t,"h").w('</div><a class="tc-ctl-btn tc-ctl-finfo-btn-next">').h("i18n",t,{},{$key:"next"}).w("</a>")}A.__dustBody=!0;return t};e.template[e.CLASS+"-dialog"]=function(){dust.register(e.CLASS+"-dialog",t);function t(e,t){return e.w('<div class="tc-ctl-finfo-dialog tc-modal"><div class="tc-modal-background tc-modal-close"></div><div class="tc-modal-window"><div class="tc-modal-header"><h3>').h("i18n",t,{},{$key:"feature"}).w('</h3><div class="tc-ctl-popup-close tc-modal-close"></div></div><div class="tc-modal-body"><div class="tc-ctl-finfo-dialog-dl"><h2>').h("i18n",t,{},{$key:"download"}).w('</h2><div><button class="tc-button tc-ctl-finfo-dl-btn-kml" data-format="KML" title="KML">KML</button><button class="tc-button tc-ctl-finfo-dl-btn-gml" data-format="GML" title="GML">GML</button><button class="tc-button tc-ctl-finfo-dl-btn-geojson" data-format="GeoJSON" title="GeoJSON">GeoJSON</button><button class="tc-button tc-ctl-finfo-dl-btn-wkt" data-format="WKT" title="WKT">WKT</button></div></div><div class="tc-ctl-finfo-dialog-share"></div></div><div class="tc-modal-footer"><button type="button" class="tc-button tc-modal-close">').h("i18n",t,{},{$key:"close"}).w("</button></div></div></div>")}t.__dustBody=!0;return t}}}();TC.control=TC.control||{};TC.control.WorkLayerManager||TC.syncLoadJS(TC.apiLocation+"TC/control/WorkLayerManager");TC.control.ListTOC=TC.control.WorkLayerManager;TC.control=TC.control||{};TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control");TC.control.LoadingIndicator=function(){var e=this;TC.Control.apply(e,arguments);window.addEventListener("error",function(){e.reset();return!1},!1)};TC.inherit(TC.control.LoadingIndicator,TC.Control);!function(){var e=TC.control.LoadingIndicator.prototype;e.CLASS="tc-ctl-load";TC.isDebug?e.template=TC.apiLocation+"TC/templates/LoadingIndicator.html":e.template=function(){dust.register(e.CLASS,t);function t(e,t){return e.w('<div class="tc-ctl-load-bar"><div class="tc-ctl-load-dots tc-ctl-load-dot1"> </div><div class="tc-ctl-load-dots tc-ctl-load-dot2"> </div><div class="tc-ctl-load-dots tc-ctl-load-dot3"> </div><div class="tc-ctl-load-dots tc-ctl-load-dot4"> </div><div class="tc-ctl-load-dots tc-ctl-load-dot5"> </div><div class="tc-ctl-load-dots tc-ctl-load-dot6"> </div><div class="tc-ctl-load-dots tc-ctl-load-dot7"> </div><div class="tc-ctl-load-dots tc-ctl-load-dot8"> </div></div>')}t.__dustBody=!0;return t};e.waits={};e.startWait=function(t){void 0===e.waits[t.layer.id]&&(e.waits[t.layer.id]=0);e.waits[t.layer.id]=e.waits[t.layer.id]+1;this.show();this.map.$events.trigger($.Event(TC.Consts.event.STARTLOADING))};e.stopWait=function(t){var i=e.waits[t.layer.id];i>0&&(i=e.waits[t.layer.id]=i-1);i||delete e.waits[t.layer.id];var n=0;for(var r in e.waits)n++;if(!n){this.map?this.map.isLoaded&&this.hide():this.hide();this.map.$events.trigger($.Event(TC.Consts.event.STOPLOADING))}};e.reset=function(t){e.waits={};this.hide();this.map.$events.trigger($.Event(TC.Consts.event.STOPLOADING))};e.register=function(e){var t=this;TC.Control.prototype.register.call(t,e);e.on(TC.Consts.event.BEFORELAYERADD+" "+TC.Consts.event.BEFORELAYERUPDATE+" "+TC.Consts.event.BEFOREFEATURESADD,function(e){t.startWait(e)}).on(TC.Consts.event.LAYERADD+" "+TC.Consts.event.LAYERERROR+" "+TC.Consts.event.LAYERUPDATE+" "+TC.Consts.event.FEATURESADD,function(e){t.stopWait(e)}).on(TC.Consts.event.BEFOREFEATUREINFO,function(e){t.addWait(TC.Consts.event.FEATUREINFO)}).on(TC.Consts.event.FEATUREINFO+" "+TC.Consts.event.NOFEATUREINFO+" "+TC.Consts.event.FEATUREINFOERROR,function(e){t.removeWait(TC.Consts.event.FEATUREINFO)});if(!TC.isDebug){window.addEventListener("error",function(e,i,n,r,s){t.reset();return!1});$(document).ajaxError(function(e,i,n){t.reset()})}};e.addWait=function(e){var t=e||TC.getUID();this.startWait({layer:{id:t}});return t};e.removeWait=function(e){this.stopWait({layer:{id:e}})}}();TC.control=TC.control||{};TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control");TC.Consts.event.BEFOREFEATUREMODIFY="beforefeaturemodify.tc";TC.Consts.event.FEATUREMODIFY="featuremodify.tc";TC.Consts.event.FEATURESSELECT="featureselect.tc";TC.Consts.event.FEATURESUNSELECT="featureunselect.tc";TC.Consts.event.CHANGE="change.tc";!function(){TC.control.Modify=function(){TC.Control.apply(this,arguments);this.__firstRender=$.Deferred();this.styles=$.extend(!0,TC.Cfg.styles.selection,this.options.styles);this.styles.text=this.styles.text||{fontSize:this.styles.line.fontSize,fontColor:this.styles.line.fontColor,labelOutlineColor:this.styles.line.labelOutlineColor,labelOutlineWidth:this.styles.line.labelOutlineWidth};this._classSelector="."+this.CLASS;this.wrap=new TC.wrap.control.Modify(this);this._layerPromise=$.Deferred()};TC.inherit(TC.control.Modify,TC.Control);var e=TC.control.Modify.prototype;e.CLASS="tc-ctl-mod";TC.isDebug?e.template=TC.apiLocation+"TC/templates/Modify.html":e.template=function(){dust.register(e.CLASS,t);function t(e,t){return e.w('<button class="tc-ctl-btn tc-ctl-mod-btn-select" disabled title="').h("i18n",t,{},{$key:"select"}).w('">').h("i18n",t,{},{$key:"select"}).w('</button><button class="tc-ctl-btn tc-ctl-mod-btn-delete" disabled title="').h("i18n",t,{},{$key:"deleteSelection"}).w('">').h("i18n",t,{},{$key:"deleteSelection"}).w('</button><button class="tc-ctl-btn tc-ctl-mod-btn-join" disabled title="').h("i18n",t,{},{$key:"joinGeometries.tooltip"}).w('">').h("i18n",t,{},{$key:"joinGeometries"}).w('</button><button class="tc-ctl-btn tc-ctl-mod-btn-split" disabled title="').h("i18n",t,{},{$key:"splitGeometry"}).w('">').h("i18n",t,{},{$key:"splitGeometry"}).w('</button><button class="tc-ctl-btn tc-ctl-mod-btn-text" contenteditable="true" disabled title="').h("i18n",t,{},{$key:"addText"}).w('">').h("i18n",t,{},{$key:"addText"}).w('</button><div class="tc-ctl-mod-style tc-hidden"><input type="text" class="tc-ctl-mod-txt tc-textbox" placeholder="').h("i18n",t,{},{$key:"writeTextForSketch"}).w('" style="font-size:').f(t.get(["fontSize"],!1),t,"h").w("pt;font-color:").f(t.get(["fontColor"],!1),t,"h").w(";text-shadow: 0 0 ").f(t.get(["labelOutlineWidth"],!1),t,"h").w("px ").f(t.get(["labelOutlineColor"],!1),t,"h").w(';" />').h("i18n",t,{},{$key:"textColor"}).w('<input type="color" class="tc-ctl-mod-fnt-c" value="').f(t.get(["fontColor"],!1),t,"h").w('" />').h("i18n",t,{},{$key:"fontSize"}).w('<input type="number" class="tc-ctl-mod-fnt-s tc-textbox" value="').f(t.get(["fontSize"],!1),t,"h").w('" min="7" max="20" /></div>')}t.__dustBody=!0;return t};const t=function(e,t){e._$deleteBtn.prop("disabled",0===t.length);e._$joinBtn.prop("disabled",t.length<2);e._$splitBtn.prop("disabled",0===t.filter(i).length);e.displayLabelText()},i=function(e){var t=!1;(TC.feature.MultiPolygon&&e instanceof TC.feature.MultiPolygon||TC.feature.MultiPolyline&&e instanceof TC.feature.MultiPolyline)&&e.geometry.length>1&&(t=!0);return t};e.register=function(e){var i=this;TC.Control.prototype.register.call(i,e);if(i.options.layer){i.setLayer(i.options.layer);e.on(TC.Consts.event.FEATUREADD+" "+TC.Consts.event.FEATURESADD,function(e){$.when(i.getLayer(),i.renderPromise()).then(function(t){if(e.layer===t){i._$selectBtn.prop("disabled",!1);i._$textBtn.prop("disabled",!1)}})}).on(TC.Consts.event.FEATUREREMOVE+" "+TC.Consts.event.FEATURESCLEAR,function(e){$.when(i.getLayer(),i.renderPromise()).then(function(n){if(e.layer===n){e.feature?i.unselectFeatures([e.feature]):i.unselectFeatures();t(i,i.getSelectedFeatures());if(0===i.layer.features.length){i._$selectBtn.prop("disabled",!0);i.setTextMode(!1);i._$textBtn.prop("disabled",!0)}}})});i.on(TC.Consts.event.FEATURESSELECT,function(e){const n=i.getSelectedFeatures();t(i,n)}).on(TC.Consts.event.FEATURESUNSELECT,function(e){t(i,i.getSelectedFeatures())})}};e.render=function(e){const t=this,i=function(){t._$selectBtn=t._$div.find("."+t.CLASS+"-btn-select").on(TC.Consts.event.CLICK,function(e){e.target.disabled||(t.isActive?t.deactivate():t.activate())});t._$deleteBtn=t._$div.find("."+t.CLASS+"-btn-delete").on(TC.Consts.event.CLICK,function(){t.deleteSelectedFeatures()});t._$textBtn=t._$div.find("."+t.CLASS+"-btn-text").on(TC.Consts.event.CLICK,function(){t.setTextMode(!t.textActive)});t._$joinBtn=t._$div.find("."+t.CLASS+"-btn-join");t._$splitBtn=t._$div.find("."+t.CLASS+"-btn-split");t._$text=t._$div.find("input."+t.CLASS+"-txt").on("input.tc",function(e){t.labelFeatures(e.target.value)});t._$styleSection=t._$div.find("."+t.CLASS+"-style");t._$fontColorPicker=t._$div.find(t._classSelector+"-fnt-c").on(TC.Consts.event.CHANGE,function(e){t.setFontColor(e.target.value)});t._$fontSizeSelector=t._$div.find("."+t.CLASS+"-fnt-s").on(TC.Consts.event.CHANGE,function(e){t.setFontSize(e.target.value)});t.__firstRender.resolve();$.isFunction(e)&&e()},n={fontSize:t.styles.text.fontSize,fontColor:t.styles.text.fontColor,labelOutlineColor:t.styles.text.labelOutlineColor,labelOutlineWidth:t.styles.text.labelOutlineWidth};Modernizr.inputtypes.color?t.renderData(n,i):TC.loadJS(!$.fn.spectrum,TC.apiLocation+"lib/spectrum/spectrum.min.js",function(){TC.loadCSS(TC.apiLocation+"lib/spectrum/spectrum.css");t.renderData(n,function(){t._$div.find("input[type=color]").spectrum({preferredFormat:"hex",showPalette:!0,palette:[],selectionPalette:[],cancelText:t.getLocaleString("cancel"),chooseText:t.getLocaleString("ok"),replacerClassName:t.CLASS+"-str-c"});i()})})};e.renderPromise=function(){return this.__firstRender.promise()};e.activate=function(){this._$selectBtn.addClass(TC.Consts.classes.ACTIVE);TC.Control.prototype.activate.call(this);this.wrap.activate(this.mode)};e.deactivate=function(){this._$selectBtn&&this._$selectBtn.removeClass(TC.Consts.classes.ACTIVE);TC.Control.prototype.deactivate.call(this);this._$selectBtn&&t(this,[]);this.wrap&&this.wrap.deactivate()};e.clear=function(){const e=this;e.layer&&e.layer.clearFatures();return e};e.isExclusive=function(){return!0};e.end=function(){this.wrap.end();return this};e.setMode=function(e,t){const i=this;e&&(i.mode=e);if(t&&e){i.layer&&i.layer.map.putLayerOnTop(i.layer);i.activate()}else i.deactivate();var n=t?TC.Consts.event.CONTROLACTIVATE:TC.Consts.event.CONTROLDEACTIVATE;i.map&&i.map.$events.trigger($.Event(n,{control:i}));return i};e.getLayer=function(){return this.options&&"boolean"==typeof this.options.layer&&!this.options.layer?null:this.layer?this.layer:this._layerPromise};e.setLayer=function(e){var t=this;if(t.map)if("string"==typeof e)t.map.loaded(function(){t.layer=t.map.getLayer(e);t._layerPromise.resolve(t.layer)});else{t.layer=e;t._layerPromise.resolve(t.layer)}};e.getSelectedFeatures=function(){return this.wrap.getSelectedFeatures()};e.setSelectedFeatures=function(e){const t=this.wrap.setSelectedFeatures(e);this.displayLabelText();return t};e.getActiveFeatures=function(){const e=this,t=e.getSelectedFeatures();!t.length&&e.layer.features.length&&t.push(e.layer.features[e.layer.features.length-1]);return t};e.unselectFeatures=function(e){e=e||[];this.wrap.unselectFeatures(e.map(function(e){return e.wrap.feature}));return this};e.deleteSelectedFeatures=function(){const e=this,t=e.getSelectedFeatures();e.wrap.unselectFeatures(t);t.forEach(function(t){e.layer.removeFeature(t)});return e};e.styleFunction=function(e,t){var i;const n=this.map.options.styles.selection;switch(!0){case TC.feature.Polygon&&e instanceof TC.feature.Polygon:case TC.feature.MultiPolygon&&e instanceof TC.feature.MultiPolygon:i=$.extend({},n.polygon);break;case TC.feature.Point&&e instanceof TC.feature.Point:case TC.feature.MultiPoint&&e instanceof TC.feature.MultiPoint:i=$.extend({},n.point);break;default:i=$.extend({},n.line)}const r=e.getStyle();if(r.label){i.label=r.label;i.fontSize=r.fontSize;i.fontColor=r.fontColor;i.labelOutlineColor=r.labelOutlineColor;i.labelOutlineWidth=r.labelOutlineWidth}return i};e.setTextMode=function(e){this.textActive=e;this._$textBtn.toggleClass(TC.Consts.classes.ACTIVE,e);this._$styleSection.toggleClass(TC.Consts.classes.HIDDEN,!e);this.displayLabelText();return this};e.setFontColorWatch=function(e,t){const i=this;void 0===e&&(e=i.styles.text.fontColor);e=TC.Util.colorArrayToString(e);t=t||i.getLabelOutlineColor(e);i.renderPromise().then(function(){i._$fontColorPicker.val(e);Modernizr.inputtypes.color||i._$fontColorPicker.spectrum("set",e);i._$text.css("color",e);i._$text.css("text-shadow","0 0 "+i.styles.text.labelOutlineWidth+"px "+t)});return i};e.setFontColor=function(e){const t=this;t.styles.text.fontColor=e;t.styles.text.labelOutlineColor=t.getLabelOutlineColor(e);t.setFontColorWatch(e,t.styles.text.labelOutlineColor);t.getActiveFeatures().forEach(function(i){const n=i.getStyle();n.fontColor=e;n.labelOutlineColor=t.styles.text.labelOutlineColor;i.setStyle(n)});return t};e.setFontSizeWatch=function(e){const t=this;void 0===e&&(e=t.styles.text.fontSize);const i=parseInt(e);i!==Number.NaN&&t.renderPromise().then(function(){t._$fontSizeSelector.val(i);t._$text.css("font-size",i+"pt")});return t};e.setFontSize=function(e){const t=this,i=parseInt(e);if(i!==Number.NaN){t.styles.text.fontSize=i;t.setFontSizeWatch(i);t.getActiveFeatures().forEach(function(e){const t=e.getStyle();t.fontSize=i;e.setStyle(t)})}return t};e.getLabelOutlineColor=function(e){if(e){const t=(e=TC.Util.colorArrayToString(e)).match(/^#([0-9a-f])([0-9a-f])([0-9a-f])$/i);t&&t.length&&(e="#"+t[1]+t[1]+t[2]+t[2]+t[3]+t[3]);const i=e.match(/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/i);if(i&&i.length){return(parseInt(i[1],16)+parseInt(i[2],16)+parseInt(i[3],16))/3<128?"#fff":"#000"}}return"#fff"};e.displayLabelText=function(){const e=this,t=e.getSelectedFeatures();var i,n,r;if(e.isActive&&t.length){const e=t[t.length-1].getStyle();i=e.label;r=e.fontColor;n=e.fontSize}else{i="";r=e.styles.text.fontColor;n=e.styles.text.fontSize}e.renderPromise().then(function(){e.setFontSizeWatch(n).setFontColorWatch(r)._$text.val(i)});return e};e.labelFeatures=function(e){const t=this,i=t.getActiveFeatures();if(i.length){const n=i[0].getStyle();i.forEach(function(i){const r=$.extend({},t.styles.text,n);n.label=e;n.labelOffset=r.labelOffset;n.fontColor=r.fontColor;n.fontSize=r.fontSize;n.labelOutlineColor=r.labelOutlineColor;n.labelOutlineWidth=r.labelOutlineWidth;i.setStyle(n)})}return t}}();TC.control=TC.control||{};TC.control.FeatureInfoCommons||TC.syncLoadJS(TC.apiLocation+"TC/control/FeatureInfoCommons");!function(){TC.control.MultiFeatureInfo=function(){this.lineColor=null;TC.Control.apply(this,arguments);this.modes=this.options.modes||{};void 0===this.modes[TC.Consts.geom.POINT]&&(this.modes[TC.Consts.geom.POINT]=!0);void 0===this.modes[TC.Consts.geom.POLYGON]&&(this.modes[TC.Consts.geom.POLYGON]=!0);this.fInfoCtrl=null;this.lineFInfoCtrl=null;this.polygonFInfoCtrl=null;this.lastCtrlActive=null;this.popup=null};TC.inherit(TC.control.MultiFeatureInfo,TC.control.FeatureInfoCommons);var e=TC.control.MultiFeatureInfo.prototype;e.CLASS="tc-ctl-m-finfo";TC.isDebug?e.template=TC.apiLocation+"TC/templates/MultiFeatureInfo.html":e.template=function(){dust.register(e.CLASS,t);function t(e,t){return e.w('<div class="tc-ctl-m-finfo-select"><form><span>').h("i18n",t,{},{$key:"selection"}).w("</span>").x(t.get(["pointSelectValue"],!1),t,{block:i},{}).x(t.get(["lineSelectValue"],!1),t,{block:n},{}).x(t.get(["polygonSelectValue"],!1),t,{block:r},{}).w("</form></div>")}t.__dustBody=!0;function i(e,t){return e.w('<label class="tc-ctl-m-finfo-btn-point" title="').h("i18n",t,{},{$key:"selectionByPoint"}).w('"><input type="radio" name="selectmode" value="').f(t.get(["pointSelectValue"],!1),t,"h").w('" checked /><span class="tc-ctl-btn">').h("i18n",t,{},{$key:"byPoint"}).w("</span></label>")}i.__dustBody=!0;function n(e,t){return e.w('<label class="tc-ctl-m-finfo-btn-line" title="').h("i18n",t,{},{$key:"selectionByLine"}).w('"><input type="radio" name="selectmode" value="').f(t.get(["lineSelectValue"],!1),t,"h").w('" /><span class="tc-ctl-btn">').h("i18n",t,{},{$key:"byLine"}).w("</span></label>")}n.__dustBody=!0;function r(e,t){return e.w('<label class="tc-ctl-m-finfo-btn-polygon" title="').h("i18n",t,{},{$key:"selectionByPrecinct"}).w('"><input type="radio" name="selectmode" value="').f(t.get(["polygonSelectValue"],!1),t,"h").w('" /><span class="tc-ctl-btn">').h("i18n",t,{},{$key:"byPrecinct"}).w("</span></label>")}r.__dustBody=!0;return t};e.register=function(e){var t=this;TC.Control.prototype.register.call(t,e);e.loaded(function(){var i=[];if(t.modes[TC.Consts.geom.POINT]){var n=$.Deferred();i.push(n);$.when(e.addControl("featureInfo",{displayMode:t.options.displayMode})).then(function(e){t.fInfoCtrl=e;n.resolve()})}if(t.modes[TC.Consts.geom.POLYLINE]){var r=$.Deferred();i.push(r);$.when(e.addControl("lineFeatureInfo",{displayMode:t.options.displayMode,lineColor:t.lineColor})).then(function(e){t.lineFInfoCtrl=e;r.resolve()})}if(t.modes[TC.Consts.geom.POLYGON]){var s=$.Deferred();i.push(s);$.when(e.addControl("polygonFeatureInfo",{displayMode:t.options.displayMode,lineColor:t.lineColor})).then(function(e){t.polygonFInfoCtrl=e;s.resolve()})}$.when.apply(this,i).then(function(){if(t.fInfoCtrl){t.fInfoCtrl.activate();t.lastCtrlActive=t.fInfoCtrl}})})};e.render=function(e){var t=this;t.lineColor=t.options.lineColor?t.options.lineColor:"#c00";var i={};t.modes[TC.Consts.geom.POINT]&&(i.pointSelectValue=TC.Consts.geom.POINT);t.modes[TC.Consts.geom.POLYLINE]&&(i.lineSelectValue=TC.Consts.geom.POLYLINE);t.modes[TC.Consts.geom.POLYGON]&&(i.polygonSelectValue=TC.Consts.geom.POLYGON);TC.Control.prototype.renderData.call(t,i,function(){t._$div.find("input[type=radio]").on("change",function(){switch(this.value){case TC.Consts.geom.POLYLINE:console.log("seleccion por l\xednea");t.map.activeControl!==t.fInfoCtrl&&t.map.activeControl!==t.polygonFInfoCtrl||t.lineFInfoCtrl.activate();t.lastCtrlActive=t.lineFInfoCtrl;break;case TC.Consts.geom.POLYGON:console.log("seleccion por pol\xedgono");t.map.activeControl!==t.fInfoCtrl&&t.map.activeControl!==t.lineFInfoCtrl||t.polygonFInfoCtrl.activate();t.lastCtrlActive=t.polygonFInfoCtrl;break;default:console.log("seleccion por punto");t.map.activeControl!==t.polygonFInfoCtrl&&t.map.activeControl!==t.lineFInfoCtrl||t.fInfoCtrl.activate();t.lastCtrlActive=t.fInfoCtrl}});$.isFunction(e)&&e()})};e.activate=function(){this.lastCtrlActive&&this.lastCtrlActive.activate()};e.deactivate=function(){this.lastCtrlActive.deactivate(!1)};TC.Map.prototype.getDefaultControl=function(){var e=this.getControlsByClass("TC.control.MultiFeatureInfo");return e&&e.length?e[0].lastCtrlActive:(e=this.getControlsByClass("TC.control.FeatureInfo"))&&e.length?e[0]:null}}();TC.control=TC.control||{};TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control");TC.control.NavBar=function(){TC.Control.apply(this,arguments)};TC.inherit(TC.control.NavBar,TC.Control);!function(){var e=TC.control.NavBar.prototype;e.CLASS="tc-ctl-nav";e.render=function(){this.wrap||(this.wrap=new TC.wrap.control.NavBar(this))};e.register=function(e){var t=this;TC.Control.prototype.register.call(t,e);t.wrap.register(e);e.loaded(function(){t.wrap.refresh()});e.on(TC.Consts.event.PROJECTIONCHANGE,function(i){var n=TC.Util.reproject([e.options.initialExtent[0],e.options.initialExtent[1]],e.options.crs,i.crs),r=TC.Util.reproject([e.options.initialExtent[2],e.options.initialExtent[3]],e.options.crs,i.crs);t.wrap.setInitialExtent([n[0],n[1],r[0],r[1]])})}}();TC.control=TC.control||{};TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control");TC.control.OverviewMap=function(){TC.Control.apply(this,arguments);this.$events=$(this);this.isLoaded=!1;this.layer=null;this.wrap=new TC.wrap.control.OverviewMap(this)};TC.inherit(TC.control.OverviewMap,TC.Control);!function(){var e=TC.control.OverviewMap.prototype;e.CLASS="tc-ctl-ovmap";TC.isDebug?e.template=TC.apiLocation+"TC/templates/OverviewMap.html":e.template=function(){dust.register(e.CLASS,t);function t(e,t){return e.w('<div class="tc-ctl-ovmap-load tc-hidden"></div>')}t.__dustBody=!0;return t};e.register=function(e){var t=this,i=t.options.layer;TC.Control.prototype.register.call(t,e);e.loaded(function(){var n;if("string"==typeof i){var r=function(e,t){for(var i=null,n=0;n<t.length;n++){var r=t[n];if((r.id||r)===e){i=r;break}}return i},s=r(i,e.options.availableBaseLayers);$.isPlainObject(s)||(s=r(i,e.options.baseLayers));$.isPlainObject(s)&&(n=new TC.layer.Raster(s))}else n=i instanceof TC.Layer?i:i.type===TC.Consts.layerType.VECTOR||i.type===TC.Consts.layerType.KML||i.type===TC.Consts.layerType.WFS?new TC.layer.Vector(i):new TC.layer.Raster(i);n.map=e;t.layer=n;t.wrap.register(e);const a=function(i){const n={};t.layer.getCapabilitiesPromise().then(function(){t.layer.isCompatible(e.crs)||0!==t.layer.wrap.getCompatibleMatrixSets(e.crs).length||(n.layer=t.layer.getFallbackLayer());t.wrap.reset(n)})};a(e.crs);e.on(TC.Consts.event.PROJECTIONCHANGE,a)})};e.loaded=function(e){$.isFunction(e)&&(this.isLoaded&&this.map&&this.map.isLoaded?e():this.$events.on(TC.Consts.event.MAPLOAD,e))};e.activate=function(){this.enable()};e.deactivate=function(){this.disable()};e.enable=function(){TC.Control.prototype.enable.call(this);this.wrap.enable()};e.disable=function(){TC.Control.prototype.disable.call(this);this.wrap.disable()}}();TC.control=TC.control||{};TC.control.GeometryFeatureInfo||TC.syncLoadJS(TC.apiLocation+"TC/control/GeometryFeatureInfo");!function(){TC.control.PolygonFeatureInfo=function(){TC.control.GeometryFeatureInfo.apply(this,arguments);this.geometryType=TC.Consts.geom.POLYGON};TC.inherit(TC.control.PolygonFeatureInfo,TC.control.GeometryFeatureInfo);var e=TC.control.PolygonFeatureInfo.prototype;e.CLASS="tc-ctl-finfo";e.template={};if(TC.isDebug){e.template[e.CLASS]=TC.apiLocation+"TC/templates/FeatureInfo.html";e.template[e.CLASS+"-dialog"]=TC.apiLocation+"TC/templates/FeatureInfoDialog.html"}else{e.template[e.CLASS]=function(){dust.register(e.CLASS,t);function t(e,t){return e.w('<ul class="tc-ctl-finfo-services">').s(t.get(["services"],!1),t,{else:i,block:n},{}).w("</ul>").x(t.get(["featureCount"],!1),t,{block:O},{})}t.__dustBody=!0;function i(e,t){return e.w('<li class="tc-ctl-finfo-empty">').h("i18n",t,{},{$key:"noData"}).w("</li>")}i.__dustBody=!0;function n(e,t){return e.w("<li><h3>").x(t.getPath(!1,["mapLayer","title"]),t,{else:r,block:s},{}).w('</h3><div class="tc-ctl-finfo-service-content">').s(t.get(["hasLimits"],!1),t,{else:a,block:E},{}).w("</div></li>")}n.__dustBody=!0;function r(e,t){return e.f(t.getPath(!1,["mapLayer","id"]),t,"h")}r.__dustBody=!0;function s(e,t){return e.f(t.getPath(!1,["mapLayer","title"]),t,"h")}s.__dustBody=!0;function a(e,t){return e.w('<ul class="tc-ctl-finfo-layers">').s(t.get(["layers"],!1),t,{else:o,block:l},{}).w("</ul>")}a.__dustBody=!0;function o(e,t){return e.w('<li class="tc-ctl-finfo-empty">').h("i18n",t,{},{$key:"noDataAtThisService"}).w("</li>")}o.__dustBody=!0;function l(e,t){return e.w("<li><h4>").s(t.get(["path"],!1),t,{block:c},{}).w(' <span class="tc-ctl-finfo-layer-n">').f(t.getPath(!1,["features","length"]),t,"h").w('</span> </h4> <div class="tc-ctl-finfo-layer-content"><ul class="tc-ctl-finfo-features">').s(t.get(["features"],!1),t,{else:h,block:p},{}).w("</ul></div></li>")}l.__dustBody=!0;function c(e,t){return e.f(t.getPath(!0,[]),t,"h").h("sep",t,{block:u},{})}c.__dustBody=!0;function u(e,t){return e.w(" &bull; ")}u.__dustBody=!0;function h(e,t){return e.w('<li class="tc-ctl-finfo-empty">').h("i18n",t,{},{$key:"noDataInThisLayer"}).w("</li>")}h.__dustBody=!0;function p(e,t){return e.w("<li>").x(t.get(["rawContent"],!1),t,{else:d,block:v},{}).w("</li>")}p.__dustBody=!0;function d(e,t){return e.x(t.get(["error"],!1),t,{else:f,block:C},{})}d.__dustBody=!0;function f(e,t){return e.w("<h5>").f(t.get(["id"],!1),t,"h").w("</h5><table").x(t.get(["geometry"],!1),t,{block:m},{}).w("><tbody>").s(t.get(["attributes"],!1),t,{block:y},{}).w("</tbody></table>").x(t.get(["geometry"],!1),t,{block:g},{})}f.__dustBody=!0;function m(e,t){return e.w(' title="').h("i18n",t,{},{$key:"clickToCenter"}).w('"')}m.__dustBody=!0;function y(e,t){return e.w('<tr><th class="tc-ctl-finfo-attr">').f(t.get(["name"],!1),t,"h").w('</th><td class="tc-ctl-finfo-val">').f(t.get(["value"],!1),t,"h").w("</td></tr>")}y.__dustBody=!0;function g(e,t){return e.w('<div class="tc-ctl-finfo-tools"><button class="tc-ctl-finfo-tools-btn" title="').h("i18n",t,{},{$key:"download"}).w("/").h("i18n",t,{},{$key:"share"}).w('">').h("i18n",t,{},{$key:"download"}).w("/").h("i18n",t,{},{$key:"share"}).w("</button></div>")}g.__dustBody=!0;function C(e,t){return e.w('<span class="tc-ctl-finfo-errors">').h("i18n",t,{},{$key:"fi.error"}).w('<span class="tc-ctl-finfo-error-text">').f(t.get(["error"],!1),t,"h").w("</span></span>")}C.__dustBody=!0;function v(e,t){return e.w("<h5>").h("i18n",t,{},{$key:"feature"}).w("</h5>").h("eq",t,{else:T,block:L},{key:t.get(["rawFormat"],!1),value:"text/html"})}v.__dustBody=!0;function T(e,t){return e.w("<pre>").f(t.get(["rawContent"],!1),t,"h").w("</pre>")}T.__dustBody=!0;function L(e,t){return e.w(" ").x(t.get(["expandUrl"],!1),t,{block:w},{})}L.__dustBody=!0;function w(e,t){return e.h("ne",t,{else:b,block:S},{key:t.get(["expandUrl"],!1),value:""})}w.__dustBody=!0;function b(e,t){return e.w('<iframe src="').f(t.get(["rawUrl"],!1),t,"h").w('" />')}b.__dustBody=!0;function S(e,t){return e.w('<div class="tc-ctl-finfo-features-iframe-cnt"><iframe src="').f(t.get(["rawUrl"],!1),t,"h").w('" /><a class="tc-ctl-finfo-open" onclick="window.open(\'').f(t.get(["expandUrl"],!1),t,"h").w("', '_blank')\" title=\"").h("i18n",t,{},{$key:"expand"}).w('"></a></div>')}S.__dustBody=!0;function E(e,t){return e.w('<span class="tc-ctl-finfo-errors">').f(t.get(["hasLimits"],!1),t,"h").w("</span>")}E.__dustBody=!0;function O(e,t){return e.h("gt",t,{block:A},{key:t.get(["featureCount"],!1),value:"1",type:"number"})}O.__dustBody=!0;function A(e,t){return e.w('<a class="tc-ctl-btn tc-ctl-finfo-btn-prev">').h("i18n",t,{},{$key:"previous"}).w('</a><div class="tc-ctl-finfo-counter"><span class="tc-ctl-finfo-idx"></span>/').f(t.get(["featureCount"],!1),t,"h").w('</div><a class="tc-ctl-btn tc-ctl-finfo-btn-next">').h("i18n",t,{},{$key:"next"}).w("</a>")}A.__dustBody=!0;return t};e.template[e.CLASS+"-dialog"]=function(){dust.register(e.CLASS+"-dialog",t);function t(e,t){return e.w('<div class="tc-ctl-finfo-dialog tc-modal"><div class="tc-modal-background tc-modal-close"></div><div class="tc-modal-window"><div class="tc-modal-header"><h3>').h("i18n",t,{},{$key:"feature"}).w('</h3><div class="tc-ctl-popup-close tc-modal-close"></div></div><div class="tc-modal-body"><div class="tc-ctl-finfo-dialog-dl"><h2>').h("i18n",t,{},{$key:"download"}).w('</h2><div><button class="tc-button tc-ctl-finfo-dl-btn-kml" data-format="KML" title="KML">KML</button><button class="tc-button tc-ctl-finfo-dl-btn-gml" data-format="GML" title="GML">GML</button><button class="tc-button tc-ctl-finfo-dl-btn-geojson" data-format="GeoJSON" title="GeoJSON">GeoJSON</button><button class="tc-button tc-ctl-finfo-dl-btn-wkt" data-format="WKT" title="WKT">WKT</button></div></div><div class="tc-ctl-finfo-dialog-share"></div></div><div class="tc-modal-footer"><button type="button" class="tc-button tc-modal-close">').h("i18n",t,{},{$key:"close"}).w("</button></div></div></div>")}t.__dustBody=!0;return t}}}();TC.control=TC.control||{};TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control");TC.Consts.event.POPUP="popup.tc";TC.Consts.event.POPUPHIDE="popuphide.tc";TC.Consts.classes.DRAG=TC.Consts.classes.DRAG||"tc-drag";TC.Consts.classes.DRAGGED=TC.Consts.classes.DRAGGED||"tc-dragged";TC.Consts.classes.DRAGGABLE=TC.Consts.classes.DRAGGABLE||"tc-draggable";TC.control.Popup=function(){TC.Control.apply(this,arguments);this.currentFeature=null;this.wrap=new TC.wrap.control.Popup(this)};TC.inherit(TC.control.Popup,TC.Control);!function(){var e=TC.control.Popup.prototype;e.CLASS="tc-ctl-popup";e.render=function(){};e.register=function(e){var t=this;TC.Control.prototype.register.call(t,e);$.when(e.wrap.addPopup(t)).then(function(){e.on(TC.Consts.event.LAYERVISIBILITY,function(e){t.currentFeature&&t.currentFeature.layer===e.layer&&!e.layer.getVisibility()&&t.hide()});e.on(TC.Consts.event.LAYERREMOVE,function(e){t.currentFeature&&t.currentFeature.layer===e.layer&&t.hide()});e.on(TC.Consts.event.UPDATE,function(){t.currentFeature&&t.currentFeature._visibilityState!==TC.Consts.visibility.NOT_VISIBLE||t.hide()});e.on(TC.Consts.event.FEATUREREMOVE,function(e){t.currentFeature===e.feature&&t.hide()})})};e.fitToView=function(e){var t=this;e?setTimeout(function(){t.wrap.fitToView()},1e3):t.wrap.fitToView()};e.hide=function(){if(this.map){this.map.wrap.hidePopup(this);this.setDragged(!1);this.map.$events.trigger($.Event(TC.Consts.event.POPUPHIDE,{control:this}))}};e.setDragged=function(e){this.dragged=e;this.$popupDiv&&this.$popupDiv.toggleClass(TC.Consts.classes.DRAGGED,e);this.wrap.setDragged(e)};e.setDragging=function(e){e&&this.setDragged(!0);this.$popupDiv.toggleClass(TC.Consts.classes.DRAG,e)};e.isVisible=function(){return this.$popupDiv&&this.$popupDiv.hasClass(TC.Consts.classes.VISIBLE)}}();TC.control=TC.control||{};TC.Consts.classes.PRINTABLE="tc-printable";TC.control.Print=function(e){var t=this,i=e||{};t.ready=!1;t.title=i.title||TC.Util.getLocaleString(TC.Cfg.locale,"printPage");t.cssUrl=i.cssUrl||TC.apiLocation+"TC/css/print.css";if(i.target){for(var n in t.template)dust.cache[n]||t.template[n]();var r=$(i.target);r.addClass(TC.Consts.classes.PRINTABLE);var s=function(e){var i=open(null,t.CLASS),n=r.html();dust.render(t.CLASS+"-page",{title:t.title,content:n,cssUrl:t.cssUrl},function(e,t){i.document.write(t);i.document.close();i.focus();e&&TC.error(e)})};dust.render(t.CLASS,null,function(e,i){r.append(i);r.find("."+t.CLASS+"-btn").on("click",s)})}};!function(){var e=TC.control.Print.prototype;e.CLASS="tc-ctl-print";e.template={};e.template[e.CLASS]=function(){dust.register(e.CLASS,t);function t(e,t){return e.w('<a class="tc-ctl-print-btn" title="').h("i18n",t,{},{$key:"printThisWindow"}).w('">').h("i18n",t,{},{$key:"print"}).w("</a>")}t.__dustBody=!0;return t};e.template[e.CLASS+"-page"]=function(){dust.register(e.CLASS+"-page",t);function t(e,t){return e.w('<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml"><head><title>').f(t.get(["title"],!1),t,"h").w('</title><link rel="stylesheet" href="').f(t.get(["cssUrl"],!1),t,"h").w('" /></head><body onload="print()" class="tc-ctl-print-page"><h1>').f(t.get(["title"],!1),t,"h").w("</h1>").f(t.get(["content"],!1),t,"h",["s"]).w("</body></html>")}t.__dustBody=!0;return t}}();TC.control=TC.control||{};TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control");TC.control.PrintMap=function(){TC.Control.apply(this,arguments)};TC.inherit(TC.control.PrintMap,TC.Control);!function(){var e=TC.control.PrintMap.prototype;e.CLASS="tc-ctl-printMap";e.template={};TC.isDebug?e.template[e.CLASS]=TC.apiLocation+"TC/templates/PrintMap.html":e.template[e.CLASS]=function(){dust.register(e.CLASS,t);function t(e,t){return e.w("<h2>").h("i18n",t,{},{$key:"print"}).w('</h2><div><div class="tc-ctl-printMap-div"><div class="tc-group tc-ctl-printMap-cnt"><label>').h("i18n",t,{},{$key:"title"}).w(':</label><input type="text" class="tc-ctl-printMap-title tc-textbox" maxlength="30" placeholder="').h("i18n",t,{},{$key:"mapTitle"}).w('" /></div><div class="tc-group tc-ctl-printMap-cnt"><label>').h("i18n",t,{},{$key:"layout"}).w(':</label><select id="print-design" class="tc-combo"><option value="landscape">').h("i18n",t,{},{$key:"landscape"}).w('</option><option value="portrait">').h("i18n",t,{},{$key:"portrait"}).w('</option></select></div><div class="tc-group tc-ctl-printMap-cnt"><label>').h("i18n",t,{},{$key:"size"}).w(':</label><select id="print-size" class="tc-combo"><option value="a4">A4</option><option value="a3">A3</option></select></div><div class="tc-group tc-ctl-printMap-cnt"><button class="tc-ctl-printMap-btn tc-button tc-icon-button" title="').h("i18n",t,{},{$key:"printMap"}).w('">').h("i18n",t,{},{$key:"print"}).w("</button></div></div></div>")}t.__dustBody=!0;return t};e.register=function(e){var t=this;TC.Control.prototype.register.call(t,e);t._$div.on("click",".tc-ctl-printMap-btn",function(){var i,n="?";$.isEmptyObject(TC.Util.getQueryStringParams(window.location.href))||(n="&");n+="layout=layout/print&orientation="+$("#print-design").val()+"&title="+$("input.tc-ctl-printMap-title").val()+"&size="+$("#print-size").val();i=window.location.hash?window.location.href.replace(window.location.hash,n+window.location.hash):window.location.href+n;t.printWindow&&void 0!==t.printWindow&&t.printWindow.close();TC.printPreview={};TC.printPreview.refererMap=e;for(var r,s=[],a=0;a<e.workLayers.length;a++)if(((r=e.workLayers[a]).type===TC.Consts.layerType.VECTOR||r.type===TC.Consts.layerType.WFS)&&r.getVisibility()&&r.features.length>0)for(var o=r.features,l=0;l<o.length;l++){var c=o[l],u={};if(!(TC.feature.Marker&&c instanceof TC.feature.Marker&&c.options.noPrint)){if(c.layer.styles){var h=void 0==c.layer.styles[c.STYLETYPE]?c.layer.styles["polyline"===c.STYLETYPE?"line":c.STYLETYPE]:c.layer.styles["multipolygon"===c.STYLETYPE?"polygon":c.STYLETYPE];for(var p in h)u[p]="function"==typeof h[p]?h[p](c):h[p]}var d=function(e){return e>1?"pixels":"fraction"},f=c.getStyle(),m=$.isEmptyObject(f)?c.options:f;if(m.anchor&&$.isArray(m.anchor))var y={anchorXUnits:d(m.anchor[0]),anchorYUnits:d(m.anchor[1])};s.push({geometry:c.geometry,CLASSNAME:c.CLASSNAME,options:$.extend({},u,m,y,{layer:null})})}}TC.printPreview.mapFeatures=s;t.printWindow=window.open(i,"print");t.printWindow.onbeforeunload=function(){delete this.printWindow}.bind(this)})}}();TC.control=TC.control||{};TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control");TC.control.PrintPdf=function(){TC.Control.apply(this,arguments)};TC.inherit(TC.control.PrintPdf,TC.Control);!function(){var e=TC.control.PrintPdf.prototype;e.CLASS="tc-ctl-print-pdf";var t={marginTop:20,marginLeft:55,a4:{width:596,height:842},a3:{width:842,height:1191},qrCode:{sideLength:85},headerHeight:20},i="portrait",n="landscape",r="a4",s=TC.Util.getParameterByName("orientation"),a=TC.Util.getParameterByName("size");TC.isDebug?e.template=TC.apiLocation+"TC/templates/PrintPdf.html":e.template=function(){dust.register(e.CLASS,t);function t(e,t){return e.w('<button disabled class="disabled tc-button tc-ctl-print-pdf-btn" title="').h("i18n",t,{},{$key:"printpdf"}).w('"></button>')}t.__dustBody=!0;return t};var o=function(){var e=window.location.href,t=e.indexOf("?"),i=e.indexOf("#");t>0&&(e=t<i?e.replace(e.substring(t,i),""):e.replace(e.substring(t,e.length-1),""));return e},l=function(e){var i=$.Deferred();e?TC.loadJS(void 0===QRCode,[TC.apiLocation+"lib/qrcode/qrcode.min.js"],function(){e.length>150&&(e=TC.Util.shortenUrl(e));var n=$("#qrcode");n.empty();new QRCode(n.get(0),{text:e,width:t.qrCode.sideLength,height:t.qrCode.sideLength});setTimeout(function(){var e=n.find("img").attr("src");i.resolve(e)},100)}):i.resolve(imgBase64);return i.promise()};e.register=function(e){var t=this;TC.Control.prototype.register.call(t,e);t.map.mustBeExportable=!0;t.pdfLibPromise=function(){var e=$.Deferred();window.pdfMake?e.resolve():TC.loadJS(!window.pdfMake,[TC.Consts.url.PDFMAKE],function(){e.resolve()});return e.promise()}();var i=!0;e._$div.on("mouseover",function(){if(i){e.toast(t.getLocaleString("print.advice.title")+": "+t.getLocaleString("print.advice.desc"),{type:TC.Consts.msgType.INFO,duration:7e3});i=!1}});var n="."+t.CLASS+"-btn";t.map.$events.on(TC.Consts.event.STARTLOADING,function(){var e=t._$div.find(n);e.addClass("disabled");e.attr("disabled","disabled")});t.map.$events.on(TC.Consts.event.STOPLOADING,function(){var e=t._$div.find(n);e.removeClass("disabled");e.removeAttr("disabled")});t.getLayersFromOpener();t.options.qrCode&&l(o());t._$div.on("click","."+t.CLASS+"-btn",function(){t.createPdf()})};var c=function(){var e=$.Deferred(),i={pageOrientation:s||n,pageSize:a||r,pageMargins:[t.marginLeft,t.marginTop]};e.resolve(i);return e.promise()};e.createPdf=function(){var e=this,n=function(e,n){return e===i?t[n].width:t[n].height}(s,a),r=function(e,n){return e===i?t[n].height:t[n].width}(s,a);e.canvas=$(".tc-map .ol-viewport canvas")[0];e.mapSize=TC.Util.calculateAspectRatioFit(e.canvas.width,e.canvas.height,n-2*t.marginLeft,r-2*t.marginTop-t.headerHeight);var u=function(t){TC.error(e.getLocaleString("print.error"));TC.error("No se ha podido generar el base64 correspondiente a la imagen: "+t,TC.Consts.msgErrorMode.EMAIL,"Error en la impresi\xf3n")},h=e.map.getControlsByClass(TC.control.LoadingIndicator)[0],p=h.addWait(),d=function(){h.removeWait(p)};$.when(e.pdfLibPromise).then(c).then(function(i){i.content=i.content||[];var n=$.Deferred(),r=e.map.getControlsByClass(TC.control.ScaleBar)[0];if(r)var s=$(".tc-ctl-sb .ol-scale-line-inner"),a=e.canvas.width/e.mapSize.width,o=s.width()/a;var l=function(e){var t=[],s=e||{text:""};t.push(s);t.push({text:TC.Util.getParameterByName(TC.Cfg.titleURLParamName),alignment:"center",fontSize:11});r&&t.push({table:{widths:[o],body:[[{text:r.getText(),fontSize:10,alignment:"center"}]]},layout:{hLineWidth:function(e,t){return 0===e?0:1},paddingLeft:function(e,t){return 0},paddingRight:function(e,t){return 0},paddingTop:function(e,t){return 0},paddingBottom:function(e,t){return 0}}});i.content.push({table:{widths:[o,"*",o]},layout:"noBorders"});i.content[0].table.body=[t];n.resolve(i)};e.options.logo?$.when(TC.Util.imgToDataUrl(e.options.logo,"image/png")).then(function(e,i){i.width,i.height;var n=TC.Util.calculateAspectRatioFit(i.width,i.height,o,t.headerHeight);l({image:e,height:n.height,width:n.width})},function(){u(e.options.logo);n.reject()}):l();return n.promise()}).fail(d).then(function(i){var n=$.Deferred();i.content=i.content||[];var r=function(t){i.content.push({table:{widths:["*"],body:[[{image:TC.Util.toDataUrl(t),width:e.mapSize.width}]]},layout:{paddingLeft:function(e,t){return 0},paddingRight:function(e,t){return 0},paddingTop:function(e,t){return.1},paddingBottom:function(e,t){return 0}}});n.resolve(i)};e.options.qrCode?$.when(l(o())).then(function(i){if(i)$.when(TC.Util.addToCanvas(e.canvas,i,{x:e.canvas.width-t.qrCode.sideLength,y:e.canvas.height-t.qrCode.sideLength})).then(function(e){r(e)});else{TC.error(e.getLocaleString("print.qr.error"));r(e.canvas)}}):r(e.canvas);return n.promise()}).then(function(t){var i=$.Deferred(),n=function(e,t,i){if(t.isVisibleByScale(e.name)){var n,r;t.options&&t.options.params&&t.options.params.base64LegendSrc?r=t.options.params.base64LegendSrc:e.legend&&(n=e.legend.src);result.push({src:n,title:e.title,level:i,srcBase64:r})}},r=function(e,t,i,n){if(Array.isArray(e))for(var s=0;s<e.length;s++)r(e[s],t,i,n);else if(e&&e.hasOwnProperty("children")&&e.children.length>0){e.title&&e.name&&result.push({header:e.title,level:n});r(e.children,t,i,++n)}if(e&&e.hasOwnProperty("children")&&0==e.children.length){t.apply(this,[e,i,n]);n--}};if(e.options.legend&&e.options.legend.visible){var a=e.options.legend.orientation||s,o=e.map.workLayers,l=[];t.content=t.content||{};if(o.length>0){for(var c=o.length-1;c>=0;c--){var h=o[c];if(h.type===TC.Consts.layerType.WMS&&h.getVisibility()){result=[];r(h.getTree(),n,h,0);result.length>0&&l.push({title:h.title,layers:result})}}$.when.apply($,function(){for(var e=[],t=0;t<l.length;t++)for(var i=l[t].layers,n=0;n<i.length;n++)!function(i,n){var r=l[t].layers[n],s=r.src||r.srcBase64;if(s){TC.tool&&TC.tool.Proxification||TC.syncLoadJS(TC.apiLocation+"TC/tool/Proxification");e.push($.Deferred());var a=e[e.length-1];new TC.tool.Proxification(TC.proxify,{allowedMixedContent:!0}).getImage(s,!0).then(function(e){if(e.complete){var t=TC.Util.imgTagToDataUrl(e,"image/png");r.image={base64:t.base64,canvas:t.canvas}}else u(s);a.resolve()},function(e){u(s);a.reject()})}}(0,n);return e}()).then(function(){l.length>0&&t.content.push({text:" ",pageBreak:"before",pageOrientation:a});for(var e=0;e<l.length;e++){var n=l[e],r=10;t.content.push({text:n.title,fontSize:11,margin:[0,0,0,5]});for(var s=0;s<n.layers.length;s++){var o=n.layers[s];r=7*o.level;if(!o.header||o.header!==n.title)if(o.header)t.content.push({text:o.header,fontSize:10,margin:[r,0,0,3]});else{t.content.push({text:o.title,fontSize:9,margin:[r,0,0,2]});if(o.image){var c=o.image.canvas.width/2,u=c*o.image.canvas.height/o.image.canvas.width;t.content.push({image:o.image.base64,width:c,height:u,margin:[r,0,0,2]})}}}}i.resolve(t)},function(){i.reject()})}else i.resolve(t)}else i.resolve(t);return i.promise()}).fail(d).then(function(e){var t=window.location.host+"_",i=TC.Util.getParameterByName("title");t+=i||TC.Util.getFormattedDate((new Date).toString(),!0);pdfMake.createPdf(e).download(t.replace(/[\\\/:*?"<>\|]/g,"")+".pdf")}).then(d)};e.getLayersFromOpener=function(e){var t=this,i=window.opener;if(i){var n=i.TC,r=n.printPreview?n.printPreview.refererMap:null;r&&t.map.loaded(function(){for(var e=0;e<t.map.baseLayers.length;e++)t.map.removeLayer(t.map.baseLayers[e]);var i=r.getBaseLayer();t.map.addLayer({id:i.id,title:i.title,type:i.type,url:i.url,encoding:i.encoding,layerNames:i.layerNames,matrixSet:i.matrixSet,format:i.format,minResolution:i.minResolution,maxZoom:i.maxZoom,isBase:!0});var s,a=r.workLayers;for(e=0;e<a.length;e++)(s=a[e]).type===n.Consts.layerType.WMS&&s.options.stateless&&t.map.addLayer({id:s.id,title:s.title,type:s.type,method:s.method,url:s.url,format:s.format,stateless:s.stateless,params:s.params,layerNames:s.layerNames},function(e){e.setVisibility(s.getVisibility());e.setOpacity(s.getOpacity())});var o=n.printPreview.mapFeatures;o&&t.map.addLayer({id:t.getUID(),type:n.Consts.layerType.VECTOR},function(e){n.loadJS(!n.feature,[n.apiLocation+"TC/Feature",n.apiLocation+"TC/feature/Point",n.apiLocation+"TC/feature/Polyline",n.apiLocation+"TC/feature/Polygon",n.apiLocation+"TC/feature/MultiPolygon",n.apiLocation+"TC/feature/MultiPolyline",n.apiLocation+"TC/feature/Circle",n.apiLocation+"TC/feature/Marker"],function(){for(var t=0;t<o.length;t++){var i=o[t];switch(i.CLASSNAME){case"TC.feature.Point":e.addPoint(i.geometry,i.options);break;case"TC.feature.Polyline":e.addPolyline(i.geometry,i.options);break;case"TC.feature.Polygon":e.addPolygon(i.geometry,i.options);break;case"TC.feature.MultiPolygon":e.addMultiPolygon(i.geometry,i.options);break;case"TC.feature.MultiPolyline":e.addMultiPolyline(i.geometry,i.options);break;case"TC.feature.Circle":e.addCircle(i.geometry,i.options);break;case"TC.feature.Marker":e.addMarker(i.geometry,i.options)}}})})})}}}();TC.control=TC.control||{};TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control");TC.Consts.event.RESULTTOOLTIP="resulttooltip.tc";TC.Consts.event.RESULTTOOLTIPEND="resulttooltipend.tc";TC.Consts.event.DRAWCHART="drawchart.tc";TC.Consts.event.DRAWTABLE="drawtable.tc";TC.Consts.event.RESULTSPANELMIN="resultspanelmin.tc";TC.Consts.event.RESULTSPANELMAX="resultspanelmax.tc";TC.Consts.event.RESULTSPANELCLOSE="resultspanelclose.tc";TC.control.ResultsPanel=function(){TC.Control.apply(this,arguments);this.wrap=new TC.wrap.control.ResultsPanel(this);this.data={};this.classes={FA:"fa"};this.contentType={TABLE:{fnOpen:TC.control.ResultsPanel.prototype.openTable,collapsedClass:".fa-list-alt"},CHART:{fnOpen:TC.control.ResultsPanel.prototype.openChart,collapsedClass:".fa-area-chart"}};this.content=this.contentType.TABLE;if(this.options){this.options.content&&(this.content=this.contentType[this.options.content.toUpperCase()]);this.options.chart&&(this.chart=this.options.chart);this.options.table&&(this.table=this.options.table);this.options.save&&(this.save=this.options.save)}};TC.inherit(TC.control.ResultsPanel,TC.Control);!function(){const ctlProto=TC.control.ResultsPanel.prototype;ctlProto.CLASS="tc-ctl-p-results";ctlProto.template={};ctlProto.CHART_SIZE={MIN_HEIGHT:70,MAX_HEIGHT:128,MIN_WIDTH:215,MEDIUM_WIDTH:310,MAX_WIDTH:445};if(TC.isDebug){ctlProto.template[ctlProto.CLASS]=TC.apiLocation+"TC/templates/ResultsPanel.html";ctlProto.template[ctlProto.CLASS+"-table"]=TC.apiLocation+"TC/templates/ResultsPanelTable.html";ctlProto.template[ctlProto.CLASS+"-chart"]=TC.apiLocation+"TC/templates/ResultsPanelChart.html"}else{ctlProto.template[ctlProto.CLASS]=function(){dust.register(ctlProto.CLASS,e);function e(e,t){return e.w('<div class="prpanel-group prsidebar-body " style="display: none" data-no-cb><div class="prpanel prpanel-default"><div class="prpanel-heading"><h4 class="prpanel-title"><span class="prpanel-title-text"></span> <span class="prcollapsed-pull-right prcollapsed-slide-submenu prcollapsed-slide-submenu-close" title="').h("i18n",t,{},{$key:"close"}).w('"><i class="fa fa-times"></i></span><span class="prcollapsed-pull-right prcollapsed-slide-submenu prcollapsed-slide-submenu-min" title="').h("i18n",t,{},{$key:"hide"}).w('"><i class="fa fa-chevron-left"></i></span><span class="prcollapsed-pull-right prcollapsed-slide-submenu prcollapsed-slide-submenu-csv" hidden title="').h("i18n",t,{},{$key:"export.excel"}).w('"><i class="fa fa-file-excel-o"></i></span></h4></div><div id="results" class="prpanel-collapse collapse in"><div class="prpanel-body list-group tc-ctl-p-results-table"> </div><div class="prpanel-body list-group tc-ctl-p-results-chart"></div></div></div></div><div class="prcollapsed prcollapsed-max prcollapsed-pull-left" style="display: none;" title="').h("i18n",t,{},{$key:"expand"}).w('" data-no-cb><i class="fa-list-alt" hidden></i><i class="fa-area-chart" hidden></i></div>')}e.__dustBody=!0;return e};ctlProto.template[ctlProto.CLASS+"-table"]=function(){dust.register(ctlProto.CLASS+"-table",e);function e(e,n){return e.w('<table class="table" style="display:none;"><thead>').s(n.get(["columns"],!1),n,{block:t},{}).w("</thead><tbody>").s(n.get(["results"],!1),n,{block:i},{}).w("</tbody></table>")}e.__dustBody=!0;function t(e,t){return e.w("<th>").f(t.getPath(!0,[]),t,"h").w("</th>")}t.__dustBody=!0;function i(e,t){return e.w("<tr>").h("iterate",t,{block:n},{on:t.getPath(!0,[])}).w("</tr>")}i.__dustBody=!0;function n(e,t){return e.w("<td>").f(t.get(["value"],!1),t,"h").w("</td>")}n.__dustBody=!0;return e};ctlProto.template[ctlProto.CLASS+"-chart"]=function(){dust.register(ctlProto.CLASS+"-chart",e);function e(e,n){return e.w('<div id="track-chart">').x(n.get(["msg"],!1),n,{else:t,block:i},{}).w("</div>")}e.__dustBody=!0;function t(e,t){return e.w('<span id="elevationGain" >').h("i18n",t,{},{$key:"geo.trk.chart.elevationGain"}).w(": +").f(t.get(["upHill"],!1),t,"h").w("m, -").f(t.get(["downHill"],!1),t,"h").w('m</span><div id="chart"></div>')}t.__dustBody=!0;function i(e,t){return e.f(t.get(["msg"],!1),t,"h")}i.__dustBody=!0;return e}}ctlProto.isVisible=function(){this._$div.find(".prsidebar-body").is(":visible")||this._$div.find(".prcollapsed-max").is(":visible")};ctlProto.render=function(e){var t=this;TC.Control.prototype.render.call(t,function(){t.$mainTitle=t._$div.find(".prpanel-title-text");t.$minimize=t._$div.find(".prcollapsed-slide-submenu-min");t.$minimize.on("click",function(){t.minimize()});t.$close=t._$div.find(".prcollapsed-slide-submenu-close");t.$close.on("click",function(){t.close()});t.$maximize=t._$div.find(".prcollapsed-max");t.$maximize.on("click",function(){t.maximize()});if(t.save){t.$save=t._$div.find(".prcollapsed-slide-submenu-csv");t.$save.on("click",function(){t.exportToExcel()});t.$save.removeAttr("hidden")}if(t.content){t.content=t.content;if(t.options.titles){if(t.options.titles.main){t.$mainTitle.attr("title",t.options.titles.main);t.$mainTitle.html(t.options.titles.main)}t.options.titles.max&&t.$maximize.attr("title",t.options.titles.max)}}t._$div.find(t.content.collapsedClass).removeAttr("hidden").addClass(t.classes.FA);t.$divTable=t._$div.find("."+t.CLASS+"-table");t.$divChart=t._$div.find("."+t.CLASS+"-chart");TC.loadJS(Modernizr.touch,TC.apiLocation+"lib/jQuery/jquery.touchSwipe.min.js",function(){if(Modernizr.touch)t._$div.swipe({swipeLeft:function(){t.minimize()}})});e&&"function"==typeof e&&e.call()})};ctlProto.minimize=function(){var e=this;if(0==e._$div.find(e.content.collapsedClass+":visible").length){e._$div.find(e.content.collapsedClass).hasClass(e.classes.FA)||e._$div.find(e.content.collapsedClass).addClass(e.classes.FA);e._$div.find(e.content.collapsedClass).removeAttr("hidden");e._$div.find(".prsidebar-body").toggle("slide",function(){e._$div.find(".prcollapsed-max").fadeIn()});e.map.$events.trigger($.Event(TC.Consts.event.RESULTSPANELMIN),{})}};ctlProto.maximize=function(){if(0==this._$div.find(this.content.collapsedClass+":hidden").length){this._$div.find(this.content.collapsedClass).attr("hidden","hidden");this._$div.find(".prsidebar-body").toggle("slide");this._$div.find(".prcollapsed-max").hide();this.map.$events.trigger($.Event(TC.Consts.event.RESULTSPANELMAX),{})}};ctlProto.isMinimized=function(){return 1===this._$div.find(".prcollapsed-max:visible").length&&0===this._$div.find(".prsidebar-body:visible").length};ctlProto.close=function(){this._$div.find(".prsidebar-body").fadeOut("slide");this._$div.find(".prcollapsed-max").hide();this._$div.find(this.content.collapsedClass).attr("hidden","hidden").removeClass(this.classes.FA);this.chart&&this.chart.chart&&(this.chart.chart=this.chart.chart.destroy());this.map.$events.trigger($.Event(TC.Consts.event.RESULTSPANELCLOSE,{control:this}))};ctlProto.openChart=function(e){const t=this;if(e)if(e.msg)t.map.toast(e.msg);else{t.elevationProfileCoordinates=e.coords;t.renderElevationProfileChart({data:e,div:t._$div.find("."+ctlProto.CLASS+"-chart")})}else t.map.toast(options.msg);t.map.getLoadingIndicator().hide()};ctlProto.renderElevationProfileChart=function(options){const self=this;options=options||{};TC.loadJS(!window.c3,TC.Consts.url.D3C3||TC.apiLocation+"lib/d3c3/d3c3.min.js",function(){const data=options.data,$div=$(options.div);var locale=TC.Util.getMapLocale(self.map);self.getRenderedHtml(ctlProto.CLASS+"-chart",{upHill:data.upHill.toLocaleString(locale),downHill:data.downHill.toLocaleString(locale)},function(out){$div.html(out);$div.show();if(self.options.titles){if(self.options.titles.main){self._$div.find(".prpanel-title-text").attr("title",self.options.titles.main);self._$div.find(".prpanel-title-text").html(self.options.titles.main)}self.options.titles.max&&self._$div.find(".prcollapsed-max").attr("title",self.options.titles.max)}var chartOptions=$.extend({bindto:$div.find(".tc-chart")[0],padding:{top:0,right:15,bottom:0,left:45},legend:{show:!1}},self.createChartOptions(data));self.chart.tooltip&&(chartOptions.tooltip={contents:function(d){var fn=self.chart.tooltip;"function"!=typeof fn&&(fn=TC.Util.getFNFromString(self.chart.tooltip));return fn.call(eval(self.chart.ctx),d)}});self.chart&&self.chart.onmouseout&&(chartOptions.onmouseout=function(){var fn=self.chart.onmouseout;"function"!=typeof fn&&(fn=TC.Util.getFNFromString(self.chart.onmouseout));fn.call(eval(self.chart.ctx))});chartOptions.onrendered=function(){$.isFunction(chartOptions._onrendered)&&chartOptions._onrendered.call(this);self.map.$events.trigger($.Event(TC.Consts.event.DRAWCHART,{control:self,svg:this.svg[0][0],chart:this}))};if(window.c3){if(!c3._isOverriden){window.c3.chart.internal.fn.generateDrawLine=function(e,t){var i=this,n=i.config,r=i.d3.svg.line(),s=i.generateGetLinePoints(e,t),a=t?i.getSubYScale:i.getYScale,o=function(e){return(t?i.subxx:i.xx).call(i,e)},l=function(e,t){return n.data_groups.length>0?s(e,t)[0][1]:a.call(i,e.id)(e.value)};r=n.axis_rotated?r.x(l).y(o):r.x(o).y(l);n.line_connectNull||(r=r.defined(function(e){return null!=e.value}));return function(e){var s,o=n.line_connectNull?i.filterRemoveNull(e.values):e.values,l=t?i.x:i.subX,c=a.call(i,e.id),u=0,h=0;if(i.isLineType(e))if(n.data_regions[e.id])s=i.lineWithRegions(o,l,c,n.data_regions[e.id]);else{i.isStepType(e)&&(o=i.convertValuesToStep(o));s=r.interpolate("linear")(o)}else{if(o[0]){u=l(o[0].x);h=c(o[0].value)}s=n.axis_rotated?"M "+h+" "+u:"M "+u+" "+h}return s||"M 0 0"}};window.c3.chart.internal.fn.generateDrawArea=function(e,t){var i=this,n=i.config,r=i.d3.svg.area(),s=i.generateGetAreaPoints(e,t),a=t?i.getSubYScale:i.getYScale,o=function(e){return(t?i.subxx:i.xx).call(i,e)},l=function(e,t){return n.data_groups.length>0?s(e,t)[0][1]:a.call(i,e.id)(0)},c=function(e,t){return n.data_groups.length>0?s(e,t)[1][1]:a.call(i,e.id)(e.value)};r=n.axis_rotated?r.x0(l).x1(c).y(o):r.x(o).y0(l).y1(c);n.line_connectNull||(r=r.defined(function(e){return null!==e.value}));return function(e){var t,s=n.line_connectNull?i.filterRemoveNull(e.values):e.values,a=0,o=0;if(i.isAreaType(e)){i.isStepType(e)&&(s=i.convertValuesToStep(s));t=r.interpolate("linear")(s)}else{if(s[0]){a=i.x(s[0].x);o=i.getYScale(e.id)(s[0].value)}t=n.axis_rotated?"M "+o+" "+a:"M "+a+" "+o}return t||"M 0 0"}};c3._isOverriden=!0}self.chart.chart=c3.generate(chartOptions)}})})};ctlProto.openTable=function(){var e=this;if(i=arguments[0]){var t;i.css&&(t=i.css);var i,n=i.callback,r=i.columns;if((i=i.data)&&i.length>0){if(!r){r=[];for(var s in i[0])r.push(s)}e.tableData={columns:r,results:i,css:t,callback:n};e.getRenderedHtml(e.CLASS+"-table",e.tableData).then(function(t){var i=e._$div.find("."+e.CLASS+"-table"),n=i.parent();i.detach();i.append(t);n.append(i);e.tableData.callback&&e.tableData.callback(i)});e._$div.find("."+e.CLASS+"-chart").hide();e._$div.find(".prsidebar-body").fadeIn("slide")}}e.map.getLoadingIndicator().hide()};ctlProto.open=function(e){var t=this._$div.find("."+this.CLASS+"-table");this.requestIsRendered=window.requestAnimationFrame(function(){var e=t[0].getBoundingClientRect();if(e&&e.width>100){window.cancelAnimationFrame(this.requestIsRendered);this.map.$events.trigger($.Event(TC.Consts.event.DRAWTABLE),{})}}.bind(this));if(e){this._$div.find("."+this.CLASS+"-table").html(e);this._$div.find("."+this.CLASS+"-table").show()}this._$div.find("."+this.CLASS+"-chart").hide();if(this.options.titles){if(this.options.titles.main){this._$div.find(".prpanel-title-text").attr("title",this.options.titles.main);this._$div.find(".prpanel-title-text").html(this.options.titles.main)}this.options.titles.max&&this._$div.find(".prcollapsed-max").attr("title",this.options.titles.max)}1==this._$div.find(this.content.collapsedClass+":visible").length&&this.maximize();this._$div.find(".prsidebar-body").fadeIn("slide");this.map.getLoadingIndicator().hide()};ctlProto.createChartOptions=function(e){const t=this;var i={};const n=(e=e||{}).locale||TC.Util.getMapLocale(t.map);e.chartType;if(null!=e.ele){const a=function(){const i=document.documentElement.clientWidth/100*40;return{height:i>445?e.maxHeight||t.CHART_SIZE.MAX_HEIGHT:e.minHeight||t.CHART_SIZE.MIN_HEIGHT,width:i>445?e.maxWidth||t.CHART_SIZE.MAX_WIDTH:i>310?e.mediumWidth||t.CHART_SIZE.MEDIUM_WIDTH:e.minWidth||t.CHART_SIZE.MIN_WIDTH}};var r=Number.NEGATIVE_INFINITY,s=Number.POSITIVE_INFINITY;e.ele.forEach(function(e){if("number"==typeof e){r=Math.max(e,r);s=Math.min(e,s)}});const o="grad"+TC.getUID();i={data:{x:"x",columns:[["x"].concat(e.x),["ele"].concat(e.ele)],types:{ele:"area-spline"},colors:{ele:"url(#"+o+")"}},size:a(),point:{show:!1},axis:{x:{tick:{outer:!1,count:5,format:function(e){var t,i;if((e/=1e3)<1){t=Math.round(1e3*e);i=" m"}else{t=Math.round(100*e)/100;i=" km"}return(t=t.toLocaleString(n))+i}}},y:{padding:{top:0,bottom:0},max:r,min:s,tick:{count:2,format:function(e){return(parseInt(e.toFixed(0))||0).toLocaleString(n)+"m"}}}},onresize:function(){this.api.resize(a())}};e.time&&(i.time=("00000"+e.time.h).slice(-2)+":"+("00000"+e.time.m).slice(-2)+":"+("00000"+e.time.s).slice(-2));i._onrendered=function(){const e=this.svg[0][0];var i=e.getElementsByTagName("defs")[0],n="http://www.w3.org/2000/svg",r=document.createElementNS(n,"linearGradient");r.setAttributeNS(null,"id",o);r.setAttributeNS(null,"x1","0%");r.setAttributeNS(null,"x2","0%");r.setAttributeNS(null,"y1","0%");r.setAttributeNS(null,"y2","100%");r.setAttributeNS(null,"gradientUnits","userSpaceOnUse");const s=document.createElementNS(n,"stop");s.setAttributeNS(null,"offset","0%");s.setAttributeNS(null,"stop-color","red");s.setAttributeNS(null,"stop-opacity","0.7");r.appendChild(s);const a=document.createElementNS(n,"stop");a.setAttributeNS(null,"offset","50%");a.setAttributeNS(null,"stop-color","orange");a.setAttributeNS(null,"stop-opacity","0.9");r.appendChild(a);const l=document.createElementNS(n,"stop");l.setAttributeNS(null,"offset","100%");l.setAttributeNS(null,"stop-color","green");l.setAttributeNS(null,"stop-opacity","1");r.appendChild(l);i.appendChild(r);$(d3.select(".c3-brush").node()).remove();d3.select(".c3-event-rects,.c3-event-rects-single").selectAll("rect").style("cursor","pointer").on("click",function(e){d3.event.stopPropagation();const i=t.elevationProfileCoordinates[e.index].slice(0,2);i&&TC.loadJS(!TC.feature||TC.feature&&!TC.feature.Point,[TC.apiLocation+"TC/feature/Point"],function(){t.map.zoomToFeatures([new TC.feature.Point(i)])})});var c=d3.select(".c3-axis.c3-axis-x").select("path").attr("d");if(/^M\d\,(\d)V\dH\d{3}V(\d)$/i.exec(c)){c=c.replace(/(M\d\,)\d/i,"$10").replace(/(H\d{3}V)(\d)/i,"$10");d3.select(".c3-axis.c3-axis-x").select("path").attr("d",c)}else{if(/^M\s\d\s(\d)\sV\s\d\sH\s\d{3}\sV\s(\d)$/i.exec(c)){c=c.replace(/(M\s\d\s)\d/i,"$10").replace(/(H\s\d{3}\sV\s)(\d)/i,"$10");d3.select(".c3-axis.c3-axis-x").select("path").attr("d",c)}}const u=$(e),h={width:u.width(),height:u.height()};var p=function(){var e=d3.scale.ordinal().rangeRoundBands([0,h.width],.1,.3);d3.select(".c3-axis-x").selectAll("text:not(.c3-axis-x-label)").call(function(e,t){e.each(function(){e.each(function(e,t){if(0!=t){d3text=d3.select(this);if(!d3text.attr("edited")){d3text.attr("edited",!0);var i=d3text.select("tspan").node().cloneNode(),n=d3text.text().split(" ");d3text.select("tspan").text(n[0]);i.textContent=n[1];var r=i.getAttribute("dy");r=(r=r?parseFloat(i.getAttribute("dy")):.71)+.18+"em";i.setAttribute("dy",r);d3text.node().appendChild(i)}}})})},e.rangeBand())};if(d3.select(".c3-axis-x").node().getBoundingClientRect().width)(d3.select(".c3-axis-x").node().getBoundingClientRect().width>=h.width-d3.select(".c3-axis-y").node().getBoundingClientRect().width||100*d3.select(".c3-axis-x").node().getBoundingClientRect().width/(h.width-d3.select(".c3-axis-y").node().getBoundingClientRect().width)>90)&&p();else{if(t.elevationChartLabelsRAF){window.cancelAnimationFrame(t.elevationChartLabelsRAF);t.elevationChartLabelsRAF=void 0}t.elevationChartLabelsRAF=requestAnimationFrame(function e(){if(d3.select(".c3-axis-x").length&&!d3.select(".c3-axis-x").node())t.elevationChartLabelsRAF=requestAnimationFrame(e);else if(d3.select(".c3-axis-x").length&&d3.select(".c3-axis-x").node()&&!d3.select(".c3-axis-x").node().getBoundingClientRect().width)t.elevationChartLabelsRAF=requestAnimationFrame(e);else{window.cancelAnimationFrame(t.elevationChartLabelsRAF);t.elevationChartLabelsRAF=void 0;(d3.select(".c3-axis-x").node().getBoundingClientRect().width>=h.width-d3.select(".c3-axis-y").node().getBoundingClientRect().width||100*d3.select(".c3-axis-x").node().getBoundingClientRect().width/(h.width-d3.select(".c3-axis-y").node().getBoundingClientRect().width)>90)&&p()}})}t.isMinimized()||t._$div.find(".prsidebar-body").fadeIn("slide");t._$div.find("."+t.CLASS+"-table").hide()}}else i={msg:t.getLocaleString("geo.trk.chart.chpe.empty")};return i};const getTime=function(e,t){var i=t-e,n={s:Math.floor(i/1e3%60),m:Math.floor(i/6e4%60),h:Math.floor(i/36e5%24)};return $.extend({},n,{toString:("00000"+n.h).slice(-2)+":"+("00000"+n.m).slice(-2)+":"+("00000"+n.s).slice(-2)})};ctlProto.getElevationChartTooltip=function(e){const t=this.elevationProfileCoordinates;var i=e[0].x;i/=1e3;const n=t[e[0].index];var r;4==t[0].length&&t[0][3]>0&&(r=getTime(t[0][3],n[3]));const s=this.map.options.locale&&this.map.options.locale.replace("_","-")||void 0,a=parseInt(e[0].value.toFixed(0)).toLocaleString(s);var o,l;if(i<1){o=Math.round(1e3*i);l=" m"}else{o=Math.round(100*i)/100;l=" km"}return'<div class="track-elevation-tooltip"><div><span>'+a+" m </span><br><span>"+(o=o.toLocaleString(s))+l+" </span></div>"+(r?"<span>"+r.toString+"</span><div/>":"")};ctlProto.register=function(e){var t=this;TC.Control.prototype.register.call(t,e);t.wrap.register(e);t.openOn&&t.map.$events.one(t.openOn,function(e,i){t.content.fnOpen.call(t,i.data)});t.closeOn&&t.map.$events.one(t.closeOn,function(e,i){t.close()});t.options.openOn&&t.map.$events.on(t.options.openOn,function(e,i){t.content.fnOpen.call(t,i.data)});t.options.closeOn&&t.map.$events.on(t.options.closeOn,function(e,i){t.close()})};ctlProto.exportToExcel=function(){var e=this,t=[e.tableData.columns];$.each(e.tableData.results,function(e,i){var n=[];for(var r in i)i.hasOwnProperty(r)&&"Id"!==r&&"Geom"!==r&&n.push(i[r]);t.push(n)});var i=function(i){var n=e.save.fileName?e.save.fileName:"resultados.xls",r=e.options.titles&&e.options.titles.main?e.options.titles.main:null;i.Save(n,t,r)};TC.Util.ExcelExport?i(new TC.Util.ExcelExport):TC.loadJS(!0,TC.apiLocation+"TC/TC.Util.ExcelExport",function(){i(new TC.Util.ExcelExport)})}}();TC.control=TC.control||{};TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control");TC.control.ScaleBar=function(){TC.Control.apply(this,arguments)};TC.inherit(TC.control.ScaleBar,TC.Control);!function(){var e=TC.control.ScaleBar.prototype;e.CLASS="tc-ctl-sb";e.render=function(){this.wrap||(this.wrap=new TC.wrap.control.ScaleBar(this));this.wrap.render()};e.register=function(e){TC.Control.prototype.register.call(this,e);e.wrap.getMap().addControl(this.wrap.ctl)};e.getText=function(){return this.wrap.getText()}}();TC.control=TC.control||{};TC.control.Scale||TC.syncLoadJS(TC.apiLocation+"TC/control/Scale");TC.control.ScaleSelector=function(){TC.control.Scale.apply(this,arguments);this.scales=null};TC.inherit(TC.control.ScaleSelector,TC.control.Scale);!function(){var e=TC.control.ScaleSelector.prototype;e.CLASS="tc-ctl-ss";TC.isDebug?e.template=TC.apiLocation+"TC/templates/ScaleSelector.html":e.template=function(){dust.register(e.CLASS,t);function t(e,t){return e.w('<div class="ol-scale-line ol-unselectable"><nobr><select>').s(t.get(["scales"],!1),t,{block:i},{}).w('</select> <input type="button" value="').f(t.get(["screenSize"],!1),t,"h").w("''\" title=\"").h("i18n",t,{},{$key:"estimatedMapSize"}).w('" /></nobr></div>')}t.__dustBody=!0;function i(e,t){return e.w('<option value="').f(t.getPath(!0,[]),t,"h").w('"').h("eq",t,{block:n},{key:r,value:s}).w(">1:").h("math",t,{},{key:a,method:"round"}).w("</option>\n")}i.__dustBody=!0;function n(e,t){return e.w(' selected="true"')}n.__dustBody=!0;function r(e,t){return e.f(t.getPath(!0,[]),t,"h")}r.__dustBody=!0;function s(e,t){return e.f(t.get(["scale"],!1),t,"h")}s.__dustBody=!0;function a(e,t){return e.f(t.getPath(!0,[]),t,"h")}a.__dustBody=!0;return t};e.render=function(e){var t=this;if(t.map){!t.scales&&t.map.options.resolutions&&(t.scales=t.map.options.resolutions.map(t.getScale,t));var i=function(){t.scales=t.map.wrap.getResolutions().map(t.getScale,t);$("input[type=button]",t._$div).off();$("select",t._$div).off();t.renderData({scale:t.getScale(),screenSize:TC.Cfg.screenSize,scales:t.scales},function(){t._$div.find("option").each(function(e,i){$elm=$(i);$elm.text("1:"+t.format($elm.text().substr(2)))});t._$div.find('input[type="button"]').on(TC.Consts.event.CLICK,function(){t.setScreenSize.call(t)});$("select",t._$div).on("change",function(){t.setScale($(this).val())});$.isFunction(e)&&e()})};t.scales?i():$.when(t.map.wrap.getMap()).then(i)}};e.setScale=function(e){var t=.0254*e/this.getDpi(TC.Cfg.screenSize);window.devicePixelRatio&&(t/=window.devicePixelRatio);this.metersPerDegree&&(t/=this.metersPerDegree);this.map.wrap.setResolution(t);return t}}();!function(){if(window.performance){if(window.performance&&!window.performance.now){window.performance.offset=Date.now();window.performance.now=function(){return Date.now()-window.performance.offset}}}else window.performance={offset:Date.now(),now:function(){return Date.now()-this.offset}}}();TC.control=TC.control||{};TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control");var SearchType=function(e,t,i){var n=this;n.parent=i;n._featureTypes=[];$.extend(n,t);n.typeName=e;n._throwConfigError=function(){throw new Error("Error en la configuraci\xf3n de la b\xfasqueda: "+this.typeName)};n.getFeatureTypes=function(e){if(e)return this.featureType instanceof Array?this.featureType:[this.featureType];if(0===this._featureTypes.length){var t=this.featureType instanceof Array?this.featureType:[this.featureType],i=this.renderFeatureType?this.renderFeatureType instanceof Array?this.renderFeatureType:[this.renderFeatureType]:[];this._featureTypes=t.concat(i)}return this._featureTypes};n.isFeatureOfThisType=function(e){return this.getFeatureTypes().indexOf(e)>-1};n.getStyleByFeatureType=function(e){return this.getFeatureTypes().indexOf(e)>-1?this.styles[this.getFeatureTypes().indexOf(e)]:null};var r=function(e,t,i){var n=function(e,t,i){if(t){if(e.hasOwnProperty(t)&&e[t].hasOwnProperty(i))return e[t][i]}else for(var t in e)if(e[t].hasOwnProperty(i))return e[t][i]};if(i){return n(this.getStyleByFeatureType(i),t,e)}for(var r=0;r<this.styles.length;r++){var s=n(this.styles[r],t,e);if(s)return s}};n.getSuggestionListHead=function(){var e,t,i,n=this;if("function"==typeof n.suggestionListHead){e=n.suggestionListHead();t=e.label;i=[{color:e.color,title:e.label}]}else{e=n.suggestionListHead;t=n.parent.getLocaleString(e.label);if("string"==typeof e.color)i=[{color:r.call(n,e.color),title:t}];else if(e.color instanceof Array){var s=n.getFeatureTypes();e.color.length===s.length?i=e.color.map(function(e,i){return{color:r.call(n,e[s[i]].color.css,e[s[i]].color.geomType,s[i]),title:n.parent.getLocaleString(e[s[i]].title)||t}}):n._throwConfigError()}else"object"==typeof e.color&&(i=[{color:r.call(n,e.color.css,e.color.geomType),title:t}])}if(t&&i){var a='<li header><span class="header">'+t+"</span>";return a+=i.map(function(e){if(e.color)return'<span class="header-color" title="'+e.title+'" style="color: '+e.color+';"></span>'}).join("")+"</li>"}n._throwConfigError()};n.getSuggestionListElements=function(e){var t=this,i=[],n=function(e,t){switch(!0){case"number"==typeof e:if(e===t)return!0;break;case"string"==typeof e:if(isNaN(e)&&isNaN(t)){if(TC.Util.getSoundexDifference(e.trim().soundex(),t.trim().soundex())>=3)return!0}else if(e===t)return!0}return!1},r=function(e){for(var t=[],i=0;i<e.length;i++)-1==jQuery.inArray(e[i],t)&&t.push(e[i]);return t};t.parseFeatures(e).forEach(function(e){var s=[],a=[],o="",l=t.outputProperties,c=t.dataIdProperty,u=t.outputFormatLabel,h=e.id.split(".").slice(0,1).shift();if(!(t.outputProperties instanceof Array)){l=t.outputProperties[h];c=t.dataIdProperty[h];u=u[h]}for(var p=0;p<l.length;p++)s.push(e.data[l[p]]);for(p=0;p<c.length;p++)a.push(e.data[c[p]]);for(var d={},f=0;f<t.outputProperties.length;f++)d[t.outputProperties[f]]=s[f];s instanceof Array&&u&&r(s).length>1?o=u.tcFormat(s):s instanceof Array&&1==r(s).length&&(o=s[0]);var m=o.toCamelCase();(function(e){for(var t=0;t<i.length;t++){var r=0,s=[];for(var a in e){s.push(n(e[a],i[t].properties[a]));r++}if(s.filter(function(e){return e}).length===r)return!0}return!1})(d)||i.push({text:m,label:m,id:a.join("#"),dataRole:t.typeName,dataLayer:h,properties:d})});return i};n.parseFeatures=function(e){return(n.outputFormat===TC.Consts.format.JSON?new TC.wrap.parser.JSON:new TC.wrap.parser.WFS({featureNS:n.featurePrefix,featureType:n.featureType})).read(e)};n.getPattern=function(){return"function"==typeof this.pattern?this.pattern():this.pattern};n.filter=function(e){return{getPropertyValue:function(t,i){return e.getSearchTypeByRole(t)[i]},getIsLikeNode:function(t,i){var n=/([\-\"\.\\xba\(\)\/])/g;n.test(i)&&(i=i.replace(n,"\\$1"));return i.toString().indexOf(e.parent._LIKE_PATTERN)>-1?'<Or><PropertyIsLike escape="\\" singleChar="_" wildCard="*" matchCase="false"><PropertyName>'+t+"</PropertyName><Literal>"+i.toLowerCase().replace(/\</gi,"&lt;").replace(/\>/gi,"&gt;")+'</Literal></PropertyIsLike><PropertyIsLike escape="\\" singleChar="_" wildCard="*" matchCase="false"><PropertyName>'+t+"</PropertyName><Literal>"+i.toUpperCase().replace(/\</gi,"&lt;").replace(/\>/gi,"&gt;")+"</Literal></PropertyIsLike></Or>":"<PropertyIsEqualTo><PropertyName>"+t+"</PropertyName><Literal>"+i.replace(/\</gi,"&lt;").replace(/\>/gi,"&gt;")+"</Literal></PropertyIsEqualTo>"},getFunctionStrMatches:function(t,i){var n=/([\-\"\\xba\(\)\/])/g;n.test(i)&&(i=i.replace(n,"\\$1"));if(i.toString().indexOf(e.parent._LIKE_PATTERN)>-1){var r=i;return'<ogc:PropertyIsEqualTo> <ogc:Function name="strMatches"> <ogc:PropertyName>'+t+"</ogc:PropertyName> <ogc:Literal>(?i)"+(r=(r=(r=(r=(r=r.replace(/a/gi,"[a\xe1\xe0]")).replace(/e/gi,"[e\xe9\xe8]")).replace(/i/gi,"[i\xed\xec]")).replace(/o/gi,"[o\xf3\xf2]")).replace(/u/gi,"[u\xfa\xfc\xf9]")).replace(/\</gi,"&lt;").replace(/\>/gi,"&gt;")+"</ogc:Literal> </ogc:Function> <ogc:Literal>true</ogc:Literal> </ogc:PropertyIsEqualTo>"}return"<PropertyIsEqualTo><PropertyName>"+t+"</PropertyName><Literal>"+i.replace(/\</gi,"&lt;").replace(/\>/gi,"&gt;")+"</Literal></PropertyIsEqualTo>"},getFilterNode:function(t,i){var n,r=e.filter.getIsLikeNode;if(e.filterByMatch){r=e.filter.getFunctionStrMatches;var s=new RegExp("\\"+e.parent._LIKE_PATTERN,"gi");i=i.replace(s,e._MATCH_PATTERN)}if(t instanceof Array||"string"==typeof t){if(t instanceof Array&&t.length>1){n="<ogc:Or>";for(l=0;l<t.length;l++)n+=r($.trim(t[l]),i);return n+"</ogc:Or>"}return r(t instanceof Array&&1===t.length?$.trim(t[0]):$.trim(t),i)}var a=[];for(var o in t)if(t[o]instanceof Array&&t[o].length>1){n="<Or>";for(var l=0;l<t[o].length;l++)n+=r($.trim(t[o][l]),i);n+="</Or>";a.push('(<Filter xmlns="http://www.opengis.net/ogc">'+n+"</Filter>)")}else{var c=t[o];t[o]instanceof Array&&1==t[o].length&&(c=t[o][0]);a.push('(<Filter xmlns="http://www.opengis.net/ogc"><Or>'+r($.trim(c),i)+"</Or></Filter>)")}return a.join("")},getFilter:function(t){var i={multiL:!1,f:""},n=function(t,i){var n=[];if(i!=e.parent.rootCfg.active.root)for(var r=i.split("#"),s=0;s<e.parent.rootCfg.active.dataIdProperty.length;s++){0==s&&e.parent.rootCfg.active.dataIdProperty.length>1&&n.push("<ogc:And>");n.push(e.filter.getFilterNode(e.parent.rootCfg.active.dataIdProperty[s],r.length>s?r[s]:r[0]));s==e.parent.rootCfg.active.dataIdProperty.length-1&&e.parent.rootCfg.active.dataIdProperty.length>1&&n.push("</ogc:And>")}else{for(var a=0;a<e.parent.rootCfg.active.root.length;a++){r=e.parent.rootCfg.active.root[a];0==a&&e.parent.rootCfg.active.root.length>1&&n.push("<ogc:Or>");for(s=0;s<e.parent.rootCfg.active.dataIdProperty.length;s++){0==s&&e.parent.rootCfg.active.dataIdProperty.length>1&&n.push("<ogc:And>");n.push(e.filter.getFilterNode(e.parent.rootCfg.active.dataIdProperty[s],r.length>s?r[s]:r[0]));s==e.parent.rootCfg.active.dataIdProperty.length-1&&e.parent.rootCfg.active.dataIdProperty.length>1&&n.push("</ogc:And>")}}e.parent.rootCfg.active.root.length>1&&n.push("</ogc:Or>")}return t.concat(n)};switch(!0){case e.typeName===TC.Consts.searchType.NUMBER:s=[];if(e.parent.rootCfg.active||!/(\<|\>|\<\>)/gi.exec(t.t)&&!/(\<|\>|\<\>)/gi.exec(t.s)){e.parent.rootCfg.active?s=n(s,t.t):s.push(e.filter.getFilterNode(e.queryProperties.firstQueryWord,e.parent._LIKE_PATTERN+t.t+e.parent._LIKE_PATTERN));s.push(e.filter.getFilterNode(e.queryProperties.secondQueryWord,e.parent._LIKE_PATTERN+t.s+e.parent._LIKE_PATTERN))}else{(r=/(\<|\>|\<\>)/gi.exec(t.t))?s.push(e.filter.getFilterNode(e.queryProperties.firstQueryWord,e.parent._LIKE_PATTERN+t.t.substring(0,t.t.indexOf(r[0])).trim()+e.parent._LIKE_PATTERN)):e.parent.rootCfg.active?s=n(s,t.t):s.push(e.filter.getFilterNode(e.queryProperties.firstQueryWord,e.parent._LIKE_PATTERN+t.t+e.parent._LIKE_PATTERN));(r=/(\<|\>|\<\>)/gi.exec(t.s))?s.push(e.filter.getFilterNode(e.queryProperties.secondQueryWord,e.parent._LIKE_PATTERN+t.s.substring(0,t.s.indexOf(r[0])).trim()+e.parent._LIKE_PATTERN)):s.push(e.filter.getFilterNode(e.queryProperties.secondQueryWord,e.parent._LIKE_PATTERN+t.s+e.parent._LIKE_PATTERN))}s.push(e.filter.getFilterNode(e.queryProperties.thirdQueryWord,t.p+e.parent._LIKE_PATTERN));i.f='<ogc:Filter xmlns:ogc="http://www.opengis.net/ogc"><ogc:And>'+s.join("")+"</ogc:And></ogc:Filter>";break;case e.typeName===TC.Consts.searchType.STREET:s=[];if(e.parent.rootCfg.active||!/(\<|\>|\<\>)/gi.exec(t.t)&&!/(\<|\>|\<\>)/gi.exec(t.s)){e.parent.rootCfg.active?s=n(s,t.t):s.push(e.filter.getFilterNode(e.queryProperties.firstQueryWord,e.parent._LIKE_PATTERN+t.t+e.parent._LIKE_PATTERN));s.push(e.filter.getFilterNode(e.queryProperties.secondQueryWord,e.parent._LIKE_PATTERN+t.s+e.parent._LIKE_PATTERN))}else{var r;(r=/(\<|\>|\<\>)/gi.exec(t.t))?s.push(e.filter.getFilterNode(e.queryProperties.firstQueryWord,e.parent._LIKE_PATTERN+t.t.substring(0,t.t.indexOf(r[0])).trim()+e.parent._LIKE_PATTERN)):e.parent.rootCfg.active?s=n(s,t.t):s.push(e.filter.getFilterNode(e.queryProperties.firstQueryWord,e.parent._LIKE_PATTERN+t.t+e.parent._LIKE_PATTERN));(r=/(\<|\>|\<\>)/gi.exec(t.s))?s.push(e.filter.getFilterNode(e.queryProperties.secondQueryWord,e.parent._LIKE_PATTERN+t.s.substring(0,t.s.indexOf(r[0])).trim()+e.parent._LIKE_PATTERN)):s.push(e.filter.getFilterNode(e.queryProperties.secondQueryWord,e.parent._LIKE_PATTERN+t.s+e.parent._LIKE_PATTERN))}i.f='<ogc:Filter xmlns:ogc="http://www.opengis.net/ogc"><ogc:And>'+s.join("")+"</ogc:And></ogc:Filter>";break;case e.typeName===TC.Consts.searchType.LOCALITY:i.f=e.filter.getFilterNode(e.queryProperties.firstQueryWord,e.parent._LIKE_PATTERN+t.t+e.parent._LIKE_PATTERN);i.multiL=!0;break;case e.queryProperties.hasOwnProperty("secondQueryWord"):var s;(s=[]).push(e.filter.getFilterNode(e.queryProperties.firstQueryWord,e.parent._LIKE_PATTERN+t.t+e.parent._LIKE_PATTERN));s.push(e.filter.getFilterNode(e.queryProperties.secondQueryWord,e.parent._LIKE_PATTERN+t.s+e.parent._LIKE_PATTERN));i.f='<ogc:Filter xmlns:ogc="http://www.opengis.net/ogc"><ogc:And>'+s.join("")+"</ogc:And></ogc:Filter>";break;default:i.f='<ogc:Filter xmlns:ogc="http://www.opengis.net/ogc">'+e.filter.getFilterNode(e.queryProperties.firstQueryWord,e.parent._LIKE_PATTERN+t.t+e.parent._LIKE_PATTERN)+"</ogc:Filter>"}return i},getParams:function(t){var i=e.filter.getFilter(t),n={REQUEST:"GetFeature",SERVICE:"WFS",MAXFEATURES:500,VERSION:e.version,OUTPUTFORMAT:e.outputFormat},r=e.getFeatureTypes(!0);if(r instanceof Array){for(var s=[],a=0;a<r.length;a++)s.push(e.featurePrefix?e.featurePrefix+":"+$.trim(r[a]):$.trim(r[a]));n.TYPENAME=s.join(",")}else n.TYPENAME=e.featurePrefix?e.featurePrefix+":"+$.trim(r):$.trim(r);var o=function(e){if(""!==(e||"")){if(e instanceof Array)return e.join(",");var t=[];if(e instanceof Object)for(var i in e){var n=e[i][0];e[i].length>1&&(n=e[i].join(","));t.push(n)}return t}},l=o(e.outputProperties),c=o(e.dataIdProperty);if(l instanceof Array&&c instanceof Array){n.PROPERTYNAME="";for(a=0;a<l.length;a++)n.PROPERTYNAME+="("+l[a]+","+c[a]+")"}else n.PROPERTYNAME=l+","+c;n.FILTER=i.f;return $.param(n)},getGoToFilter:function(t){var i=[],n=t.split("#"),r=e.dataIdProperty,s=e.getFeatureTypes();if(r&&s)if(t.indexOf("#")>-1&&s instanceof Array&&s.length>1)for(var a=0;a<s.length;a++)for(var o=0;o<r[s[a]].length;o++)i.push({name:r[s[a]][o],value:n[o]});else if(-1==t.indexOf("#")&&s instanceof Array){var l=r;for(a=0;a<s.length;a++)if(!i.hasOwnProperty(s[a])){l instanceof Object&&r.hasOwnProperty(s[a])&&(l=r[s[a]]);for(o=0;o<l.length;o++)o<n.length&&i.push({name:l[o],value:n[o]})}}else{r instanceof Object&&r.hasOwnProperty(s)&&(r=r[s]);for(a=0;a<r.length;a++)i.push({name:r[a],value:n[a]})}return e.filter.transformFilter(i)},transformFilter:function(e){TC.filter||TC.syncLoadJS(TC.apiLocation+"TC/Filter");if(e&&e instanceof Array){var t=e.map(function(e){if(!e.hasOwnProperty("type"))return new TC.filter.equalTo(e.name,e.value);switch(!0){case e.type==TC.Consts.comparison.EQUAL_TO:return new TC.filter.equalTo(e.name,e.value)}});return t.length>1?TC.filter.and.apply(null,t):t[0]}}}}(n)};TC.control.Search=function(){var e=this;TC.Control.apply(e,arguments);TC.Consts.event.TOOLSCLOSE=TC.Consts.event.TOOLSCLOSE||"toolsclose.tc";e.url="//idena.navarra.es/ogc/wfs";e.version="1.1.0";e.featurePrefix="IDENA";e.layerPromise=$.Deferred();e.options&&e.options.url&&(e.url=e.options.url);e._LIKE_PATTERN="*";e._MATCH_PATTERN=".*";e.UTMX="X";e.UTMY="Y";e.LON="Lon";e.LAT="Lat";e.UTMX_LABEL="X: ";e.UTMY_LABEL="Y: ";e.LON_LABEL="Lon: ";e.LAT_LABEL="Lat: ";e.MUN="Mun";e.POL="Pol";e.PAR="Par";e.MUN_LABEL="Mun: ";e.POL_LABEL="Pol: ";e.PAR_LABEL="Par: ";e.availableSearchTypes={};e.availableSearchTypes[TC.Consts.searchType.CADASTRAL]={suggestionRoot:null,url:e.url||"//idena.navarra.es/ogc/wfs",version:e.version||"1.1.0",outputFormat:TC.Consts.format.JSON,featurePrefix:e.featurePrefix||"IDENA",geometryName:"the_geom",searchWeight:3,featureType:["CATAST_Pol_ParcelaUrba","CATAST_Pol_ParcelaRusti","CATAST_Pol_ParcelaMixta"],municipality:{featureType:"CATAST_Pol_Municipio",labelProperty:"MUNICIPIO",idProperty:"CMUNICIPIO"},queryProperties:{firstQueryWord:"CMUNICIPIO",secondQueryWord:"POLIGONO",thirdQueryWord:"PARCELA"},suggestionListHead:{label:"search.list.cadastral",color:[{CATAST_Pol_ParcelaUrba:{title:"search.list.cadastral.urban",color:{geomType:"polygon",css:"strokeColor"}}},{CATAST_Pol_ParcelaRusti:{title:"search.list.cadastral.rustic",color:{geomType:"polygon",css:"strokeColor"}}},{CATAST_Pol_ParcelaMixta:{title:"search.list.cadastral.mixed",color:{geomType:"polygon",css:"strokeColor"}}}]},styles:[{polygon:{fillColor:"#000000",fillOpacity:.1,strokeColor:"#136278",strokeWidth:2,strokeOpacity:1}},{polygon:{fillColor:"#000000",fillOpacity:.1,strokeColor:"#0c8b3d",strokeWidth:2,strokeOpacity:1}},{polygon:{fillColor:"#000000",fillOpacity:.1,strokeColor:"#e5475f",strokeWidth:2,strokeOpacity:1}}],parser:e.getCadastralRef,goTo:e.goToCadastralRef,goToIdFormat:e.MUN+"{0}"+e.POL+"{1}"+e.PAR+"{2}",idPropertiesIdentifier:"#"};e.availableSearchTypes[TC.Consts.searchType.COORDINATES]={parser:e.getCoordinates,goTo:e.goToCoordinates,searchWeight:4,label:null,suggestionListHead:function(t){return{label:e.availableSearchTypes[TC.Consts.searchType.COORDINATES].label||e.getLocaleString("search.list.coordinates")}}};e.queryProperties={QUERYWORD:"QueryWord",FIRST:"first",SECOND:"second",THIRD:"third"};e.availableSearchTypes[TC.Consts.searchType.MUNICIPALITY]={root:null,limit:!1,url:e.url||"//idena.navarra.es/ogc/wfs",version:e.version||"1.1.0",outputFormat:TC.Consts.format.JSON,url:"//idena.navarra.es/ogc/wfs",featurePrefix:"IDENA",geometryName:"the_geom",featureType:"CATAST_Pol_Municipio",dataIdProperty:["CMUNICIPIO"],queryProperties:{firstQueryWord:["MUNINOAC","MUNICIPIO"]},suggestionListHead:{label:"search.list.municipality",color:"strokeColor"},outputProperties:["MUNICIPIO"],outputFormatLabel:"{0}",searchWeight:1,styles:[{polygon:{fillColor:"#000000",fillOpacity:.1,strokeColor:"#fe06a5",strokeWidth:2,strokeOpacity:1}}],parser:e.getStringPattern.bind(this,[TC.Consts.searchType.MUNICIPALITY]),goTo:e.goToStringPattern};e.availableSearchTypes[TC.Consts.searchType.COUNCIL]={root:null,limit:!1,url:e.url||"//idena.navarra.es/ogc/wfs",version:e.version||"1.1.0",outputFormat:TC.Consts.format.JSON,featurePrefix:e.featurePrefix||"IDENA",geometryName:"the_geom",featureType:"CATAST_Pol_Concejo",renderFeatureType:"",dataIdProperty:["CMUNICIPIO","CCONCEJO"],queryProperties:{firstQueryWord:["CONCEJO"]},outputProperties:["MUNICIPIO","CONCEJO"],outputFormatLabel:"{1} ({0})",searchWeight:4,parser:e.getStringPattern.bind(this,[TC.Consts.searchType.COUNCIL]),goTo:e.goToStringPattern,idPropertiesIdentifier:"#",suggestionListHead:{label:"search.list.council",color:"strokeColor"},styles:[{polygon:{fillColor:"#000000",fillOpacity:.1,strokeColor:"#49006a",strokeWidth:2,strokeOpacity:1}}]};e.availableSearchTypes[TC.Consts.searchType.STREET]={root:null,limit:null,url:e.url||"//idena.navarra.es/ogc/wfs",version:e.version||"1.1.0",outputFormat:TC.Consts.format.JSON,featurePrefix:e.featurePrefix||"IDENA",geometryName:"the_geom",renderFeatureType:"CATAST_Txt_Calle",featureType:"CATAST_Lin_CalleEje",dataIdProperty:["CVIA"],searchWeight:5,queryProperties:{firstQueryWord:["ENTINOAC","ENTIDADC"],secondQueryWord:["VIA","VIANOAC"]},suggestionListHead:{label:"search.list.street",color:"strokeColor"},outputProperties:["ENTIDADC","VIA","CVIA","CENTIDADC","CMUNICIPIO"],outputFormatLabel:"{1}, {0}",styles:[{line:{strokeColor:"#CB0000",strokeOpacity:1,strokeWidth:2,strokeLinecap:"round",strokeDashstyle:"solid"}},{point:{label:"VIA",angle:"CADANGLE",fontColor:"#000000",fontSize:10,fontWeight:"bold",labelOutlineColor:"#FFFFFF",labelOutlineWidth:4}}],parser:e.getStringPattern.bind(this,[TC.Consts.searchType.STREET]),goTo:e.goToStringPattern};e.availableSearchTypes[TC.Consts.searchType.NUMBER]={root:null,limit:null,url:e.url||"//idena.navarra.es/ogc/wfs",version:e.version||"1.1.0",outputFormat:TC.Consts.format.JSON,featurePrefix:e.featurePrefix||"IDENA",geometryName:"the_geom",featureType:"CATAST_Txt_Portal",renderFeatureType:"",searchWeight:6,dataIdProperty:["CMUNICIPIO","CENTIDADC","CVIA","PORTAL"],queryProperties:{firstQueryWord:["ENTIDADC","ENTINOAC"],secondQueryWord:["VIA","VIANOAC"],thirdQueryWord:["PORTAL"]},suggestionListHead:{label:"search.list.number",color:"fontColor"},outputProperties:["ENTIDADC","VIA","PORTAL","CVIA","CENTIDADC","CMUNICIPIO"],outputFormatLabel:"{1} {2}, {0}",styles:[{point:{radius:0,label:"PORTAL",angle:"CADANGLE",fontColor:"#CB0000",fontSize:14,labelOutlineColor:"#FFFFFF",labelOutlineWidth:4}}],parser:e.getStringPattern.bind(this,[TC.Consts.searchType.NUMBER]),goTo:e.goToStringPattern};e.availableSearchTypes[TC.Consts.searchType.URBAN]={root:null,limit:!1,url:e.url||"//idena.navarra.es/ogc/wfs",version:e.version||"1.1.0",outputFormat:TC.Consts.format.JSON,featurePrefix:e.featurePrefix||"IDENA",geometryName:"the_geom",featureType:"ESTADI_Pol_EntidadPob",renderFeatureType:"",dataIdProperty:["CMUNICIPIO","CENTIDAD"],idPropertiesIdentifier:"#",queryProperties:{firstQueryWord:["ENTINOAC","ENTIDAD"]},suggestionListHead:{label:"search.list.urban",color:"strokeColor"},outputProperties:["MUNICIPIO","ENTIDAD"],outputFormatLabel:"{1} ({0})",searchWeight:2,styles:[{polygon:{fillColor:"#000000",fillOpacity:.1,strokeColor:"#feba1e",strokeWidth:2,strokeOpacity:1}}],parser:e.getStringPattern.bind(this,[TC.Consts.searchType.URBAN]),goTo:e.goToStringPattern};e.availableSearchTypes[TC.Consts.searchType.PLACENAME]={root:null,limit:!1,url:e.url||"//idena.navarra.es/ogc/wfs",version:e.version||"1.1.0",outputFormat:TC.Consts.format.JSON,featurePrefix:e.featurePrefix||"IDENA",geometryName:"the_geom",featureType:"TOPONI_Txt_Toponimos",renderFeatureType:"",dataIdProperty:["CTOPONIMO"],idPropertiesIdentifier:"#",queryProperties:{firstQueryWord:["TOPONIMO","TOPONINOAC"]},suggestionListHead:{label:"search.list.placeName",color:"fontColor"},outputProperties:["MUNICIPIO","TOPONIMO","CMUNICIPIO","CTOPONIMO"],outputFormatLabel:"{1} ({0})",searchWeight:7,styles:[{point:{radius:0,label:"CADTEXT",angle:"CADANGLE",fontColor:"#ff5722",fontSize:14,labelOutlineColor:"#FFFFFF",labelOutlineWidth:4}}],parser:e.getStringPattern.bind(this,[TC.Consts.searchType.PLACENAME]),goTo:e.goToStringPattern};e.availableSearchTypes[TC.Consts.searchType.PLACENAMEMUNICIPALITY]={root:null,limit:!1,url:e.url||"//idena.navarra.es/ogc/wfs",version:e.version||"1.1.0",outputFormat:TC.Consts.format.JSON,featurePrefix:e.featurePrefix||"IDENA",geometryName:"the_geom",featureType:"TOPONI_Txt_Toponimos",renderFeatureType:"",dataIdProperty:["CMUNICIPIO","CTOPONIMO"],idPropertiesIdentifier:"#",queryProperties:{firstQueryWord:["MUNICIPIO","MUNINOAC"],secondQueryWord:["TOPONIMO","TOPONINOAC"]},suggestionListHead:{label:"search.list.placeName",color:"fontColor"},outputProperties:["MUNICIPIO","TOPONIMO","CMUNICIPIO","CTOPONIMO"],outputFormatLabel:"{1} ({0})",searchWeight:8,styles:[{point:{radius:0,label:"CADTEXT",angle:"CADANGLE",fontColor:"#ff5722",fontSize:14,labelOutlineColor:"#FFFFFF",labelOutlineWidth:4}}],parser:e.getStringPattern.bind(this,[TC.Consts.searchType.PLACENAMEMUNICIPALITY]),goTo:e.goToStringPattern};e.availableSearchTypes[TC.Consts.searchType.COMMONWEALTH]={root:null,limit:!1,url:e.url||"//idena.navarra.es/ogc/wfs",version:e.version||"1.1.0",outputFormat:TC.Consts.format.JSON,featurePrefix:e.featurePrefix||"IDENA",geometryName:"the_geom",featureType:["POLUCI_Pol_MancoRSUg"],renderFeatureType:"",dataIdProperty:["CMANCOMUNI"],queryProperties:{firstQueryWord:["MANCOMUNID"]},outputProperties:["MANCOMUNID"],outputFormatLabel:"{0}",searchWeight:9,styles:[{polygon:{fillColor:"#000000",fillOpacity:.1,strokeColor:"#fc4e2a",strokeWidth:2,strokeOpacity:1}}]};e.availableSearchTypes[TC.Consts.searchType.ROAD]={root:null,limit:!1,url:e.url||"//idena.navarra.es/ogc/wfs",version:e.version||"1.1.0",outputFormat:TC.Consts.format.JSON,featurePrefix:e.featurePrefix||"IDENA",geometryName:"the_geom",featureType:"INFRAE_Lin_CtraEje",dataIdProperty:["DCARRETERA"],queryProperties:{firstQueryWord:["DCARRETERA"]},suggestionListHead:{label:"search.list.road",color:"strokeColor"},outputProperties:["DCARRETERA"],outputFormatLabel:e.getLocaleString("search.list.road.shorter")+": {0}",searchWeight:10,styles:[{polygon:{strokeColor:"#00b2fc",strokeOpacity:1,strokeWidth:5},line:{strokeColor:"#00b2fc",strokeOpacity:1,strokeWidth:5,strokeLinecap:"round",strokeDashstyle:"solid"}}],parser:e.getRoad,goTo:e.goToRoad,pattern:function(){return new RegExp("^(?:(?:"+e.getLocaleString("search.list.road")+"|"+e.getLocaleString("search.list.road.shorter")+")\\:?)?\\s*((A?|AP?|N?|R?|E?|[A-Z]{2}?|[A-Z]{1}?)\\s*\\-?\\s*(\\d{1,4})\\s*\\-?\\s*(A?|B?|C?|R?))$","i")}};e.availableSearchTypes[TC.Consts.searchType.ROADPK]={root:null,limit:!1,url:e.url||"//idena.navarra.es/ogc/wfs",version:e.version||"1.1.0",outputFormat:TC.Consts.format.JSON,featurePrefix:e.featurePrefix||"IDENA",geometryName:"the_geom",featureType:"INFRAE_Sym_CtraPK",dataIdProperty:["DCARRETERA","CPK"],queryProperties:{firstQueryWord:["DCARRETERA"],secondQueryWord:["PK"]},suggestionListHead:{label:"search.list.pk.larger",color:"fontColor"},outputProperties:["DCARRETERA","PK"],outputFormatLabel:e.getLocaleString("search.list.road.shorter")+": {0} "+e.getLocaleString("search.list.pk")+": {1}",searchWeight:11,styles:[{point:{label:["DCARRETERA","PK"],fontColor:"#00b2fc",fontSize:14,labelOutlineColor:"#ffffff",labelOutlineWidth:2}}],parser:e.getPK,goTo:e.goToPK,pattern:function(){return new RegExp("^(?:(?:"+e.getLocaleString("search.list.road")+"|"+e.getLocaleString("search.list.road.shorter")+")\\:?)?\\s*((A?|AP?|N?|R?|E?|[A-Z]{2}?|[A-Z]{1}?)\\s*\\-?\\s*(\\d{1,4})\\s*\\-?\\s*(A?|B?|C?|R?))\\s*\\,*\\s*(?:(?:"+e.getLocaleString("search.list.pk")+"\\:?)|(?:P\\:?)|(?:K\\:?)|(?:KM\\:?)|(?:\\s+|\\,+))\\s*(\\d{1,4})$","i")}};e.rootCfg={};e.rootCfg[TC.Consts.searchType.MUNICIPALITY]={root:null,limit:!1,url:e.url||"//idena.navarra.es/ogc/wfs",version:e.version||"1.1.0",outputFormat:TC.Consts.format.JSON,featurePrefix:e.featurePrefix||"IDENA",geometryName:"the_geom",featureType:"CATAST_Pol_Municipio",dataIdProperty:["CMUNICIPIO"],queryProperties:{firstQueryWord:["MUNICIPIO"]},outputProperties:["MUNICIPIO"],outputFormatLabel:"{0}",getRootLabel:function(){var t=new $.Deferred;if(e.rootCfg.active&&!e.rootCfg[TC.Consts.searchType.MUNICIPALITY].rootLabel){var i={SERVICE:"WFS"};i.VERSION=e.rootCfg[TC.Consts.searchType.MUNICIPALITY].version;i.REQUEST="GetFeature";i.TYPENAME=e.rootCfg[TC.Consts.searchType.MUNICIPALITY].featurePrefix+":"+e.rootCfg[TC.Consts.searchType.MUNICIPALITY].featureType;i.OUTPUTFORMAT=e.rootCfg[TC.Consts.searchType.MUNICIPALITY].outputFormat;i.PROPERTYNAME=["CMUNICIPIO"].concat(e.rootCfg[TC.Consts.searchType.MUNICIPALITY].outputProperties).join(",");i.CQL_FILTER=e.rootCfg[TC.Consts.searchType.MUNICIPALITY].root.map(function(e){return["CMUNICIPIO"].map(function(t,i){return t+"="+e[i]}).join(" AND ")});i.CQL_FILTER=i.CQL_FILTER.join(" OR ");$.ajax({url:e.rootCfg[TC.Consts.searchType.MUNICIPALITY].url+"?"+$.param(i),type:"GET"}).done(function(i){if(i.totalFeatures>0){e.rootCfg[TC.Consts.searchType.MUNICIPALITY].rootLabel=i.features.map(function(t){return{id:["CMUNICIPIO"].map(function(e){return t.properties[e]}).join("#"),label:t.properties[e.rootCfg[TC.Consts.searchType.MUNICIPALITY].outputProperties[0]].toLowerCase()}});t.resolve(e.rootCfg[TC.Consts.searchType.MUNICIPALITY].rootLabel)}else{e.rootCfg[TC.Consts.searchType.MUNICIPALITY].rootLabel=[];t.resolve(e.rootCfg[TC.Consts.searchType.MUNICIPALITY].rootLabel)}}).fail(function(){t.resolve([])})}else t.resolve(e.rootCfg[TC.Consts.searchType.MUNICIPALITY].rootLabel);return t}};e.rootCfg[TC.Consts.searchType.LOCALITY]={root:null,limit:!1,url:e.url||"//idena.navarra.es/ogc/wfs",version:e.version||"1.1.0",outputFormat:TC.Consts.format.JSON,featurePrefix:e.featurePrefix||"IDENA",geometryName:"the_geom",featureType:["ESTADI_Pol_EntidadPob"],renderFeatureType:"",dataIdProperty:["CMUNICIPIO","CENTIDADC"],queryProperties:{firstQueryWord:["ENTINOAC"]},outputProperties:["ENTINOAC"],getRootLabel:function(){var t=new $.Deferred;if(e.rootCfg.active&&!e.rootCfg[TC.Consts.searchType.LOCALITY].rootLabel){var i={SERVICE:"WFS"};i.VERSION=e.rootCfg[TC.Consts.searchType.LOCALITY].version;i.REQUEST="GetFeature";i.TYPENAME=e.rootCfg[TC.Consts.searchType.LOCALITY].featurePrefix+":"+e.rootCfg[TC.Consts.searchType.LOCALITY].featureType;i.OUTPUTFORMAT=e.rootCfg[TC.Consts.searchType.LOCALITY].outputFormat;i.PROPERTYNAME=["CMUNICIPIO","CENTIDAD"].concat(e.rootCfg[TC.Consts.searchType.LOCALITY].outputProperties).join(",");i.CQL_FILTER=e.rootCfg[TC.Consts.searchType.LOCALITY].root.map(function(e){return["CMUNICIPIO","CENTIDAD"].map(function(t,i){return t+"="+e[i]}).join(" AND ")});i.CQL_FILTER=i.CQL_FILTER.join(" OR ");$.ajax({url:e.rootCfg[TC.Consts.searchType.LOCALITY].url+"?"+$.param(i),type:"GET"}).done(function(i){if(i.totalFeatures>0){e.rootCfg[TC.Consts.searchType.LOCALITY].rootLabel=i.features.map(function(t){return{id:["CMUNICIPIO","CENTIDAD"].map(function(e){return t.properties[e]}).join("#"),label:t.properties[e.rootCfg[TC.Consts.searchType.LOCALITY].outputProperties[0]].toLowerCase()}});t.resolve(e.rootCfg[TC.Consts.searchType.LOCALITY].rootLabel)}else{e.rootCfg[TC.Consts.searchType.LOCALITY].rootLabel=[];t.resolve(e.rootCfg[TC.Consts.searchType.LOCALITY].rootLabel)}}).fail(function(){t.resolve([])})}else t.resolve(e.rootCfg[TC.Consts.searchType.LOCALITY].rootLabel);return t}};e.allowedSearchTypes=[];if(e.options.allowedSearchTypes)for(var t in e.options.allowedSearchTypes){if(e.availableSearchTypes[t]&&!$.isEmptyObject(e.options.allowedSearchTypes[t])){if(e.availableSearchTypes[t].renderFeatureType&&e.availableSearchTypes[t].renderFeatureType.length>0&&e.options.allowedSearchTypes[t].featureType&&!e.options.allowedSearchTypes[t].renderFeatureType){delete e.availableSearchTypes[t].renderFeatureType;e.availableSearchTypes[t].styles=e.availableSearchTypes[t].styles.slice(0,e.availableSearchTypes[t].styles.length-1)}$.extend(e.availableSearchTypes[t],e.options.allowedSearchTypes[t]);if(e.options.allowedSearchTypes[t].root&&t!=TC.Consts.searchType.MUNICIPALITY&&e.options.allowedSearchTypes[t].rootType==TC.Consts.searchType.MUNICIPALITY||t!=TC.Consts.searchType.LOCALITY&&e.options.allowedSearchTypes[t].rootType==TC.Consts.searchType.LOCALITY){e.rootCfg.active=e.rootCfg[e.options.allowedSearchTypes[t].rootType];e.rootCfg.active.root=e.options.allowedSearchTypes[t].root;e.rootCfg.active.limit=e.options.allowedSearchTypes[t].limit;e.availableSearchTypes[TC.Consts.searchType.STREET].queryProperties.firstQueryWord=e.availableSearchTypes[TC.Consts.searchType.NUMBER].queryProperties.firstQueryWord=e.rootCfg.active.dataIdProperty}}e.options.allowedSearchTypes[t]?e.addAllowedSearchType(t,e.availableSearchTypes[t]?e.availableSearchTypes[t]:e.options.allowedSearchTypes[t],e):delete e.options.allowedSearchTypes[t]}e.rootCfg.active&&e.rootCfg.active.getRootLabel();e.queryableFeatures=e.options.queryableFeatures||!1;e.UTMX_LEN=6;e.UTMY_LEN=7;e.wrap=new TC.wrap.control.Search(e);e.interval=500;e.NORMAL_PATTERNS={ROMAN_NUMBER:/M{0,4}(CM|CD|D?C{0,3})(XC|XL|L?X{0,3})(IX|IV|V?I{0,3}){1,}?\S?\./i,ABSOLUTE_NOT_DOT:/[`~!@#$%^&*_|+\=?;:'"\{\}\[\]\\]/gi,ABSOLUTE:/[`~!@#$%^&*_|+\=?;:'.\{\}\[\]\\]/gi}};TC.inherit(TC.control.Search,TC.Control);!function(){var e=TC.control.Search.prototype;e.CLASS="tc-ctl-search";TC.Consts.event.SEARCHQUERYEMPTY=TC.Consts.event.SEARCHQUERYEMPTY||"searchqueryempty.tc";TC.isDebug?e.template=TC.apiLocation+"TC/templates/Search.html":e.template=function(){dust.register(e.CLASS,t);function t(e,t){return e.w("<h2>").h("i18n",t,{},{$key:"search.1"}).w('</h2><div class="tc-ctl-search-content"><input type="search" class="tc-ctl-search-txt" placeholder="').h("i18n",t,{},{$key:"search.placeholder"}).w('" title="').h("i18n",t,{},{$key:"search.instructions"}).w('" /><a title="').h("i18n",t,{},{$key:"search.instructions"}).w('" class="tc-ctl-btn tc-ctl-search-btn">').h("i18n",t,{},{$key:"search.2"}).w('</a><ul class="tc-ctl-search-list"></ul></div>')}t.__dustBody=!0;return t};e.register=function(e){var t=this;TC.Control.prototype.register.call(t,e);t._search={data:[]};t.layerStyleFN=function(){function e(e){return e.indexOf(".")>-1?e.split(".")[0]:e}function i(i,n,r){var s=t.getSearchTypeByFeature(r);if(s){var a=s.getStyleByFeatureType(e(r));if(a&&a.hasOwnProperty(n))return a[n][i]}return TC.Cfg.styles[n][i]}return function(t,n,r,s){!TC.Feature||s instanceof TC.Feature||this.map.$events.trigger($.Event(TC.Consts.event.FEATURESADD,{layer:this.layer,geom:s.geom}));var a=i(n,t,e(s.id));if(r){if(a instanceof Array){var o=a.map(function(e){return s.getData().hasOwnProperty(e)?s.getData()[e]:""}),l=this.getSearchTypeByFeature(e(s.id));return l?l.outputFormatLabel.tcFormat(o):o.join(" ")}return s.getData().hasOwnProperty(a)?s.getData()[a]:""}return a}}();var i=t.layerStyleFN;e.addLayer({id:t.getUID(),title:"B\xfasquedas",stealth:!0,declutter:!0,type:TC.Consts.layerType.VECTOR,styles:{polygon:{fillColor:i.bind(t,"polygon","fillColor",!1),fillOpacity:i.bind(t,"polygon","fillOpacity",!1),strokeColor:i.bind(t,"polygon","strokeColor",!1),strokeOpacity:i.bind(t,"polygon","strokeOpacity",!1),strokeWidth:i.bind(t,"polygon","strokeWidth",!1)},line:{strokeColor:i.bind(t,"line","strokeColor",!1),strokeOpacity:i.bind(t,"line","strokeOpacity",!1),strokeWidth:i.bind(t,"line","strokeWidth",!1)},marker:{anchor:TC.Defaults.styles.marker.anchor,height:TC.Defaults.styles.marker.height,width:TC.Defaults.styles.marker.width},point:{radius:i.bind(t,"point","radius",!1),height:i.bind(t,"point","height",!1),width:i.bind(t,"point","width",!1),fillColor:i.bind(t,"point","fillColor",!1),fillOpacity:i.bind(t,"point","fillOpacity",!1),strokeColor:i.bind(t,"point","strokeColor",!1),strokeWidth:i.bind(t,"point","strokeWidth",!1),fontSize:i.bind(t,"point","fontSize",!1),fontColor:i.bind(t,"point","fontColor",!1),labelOutlineColor:i.bind(t,"point","labelOutlineColor",!1),labelOutlineWidth:i.bind(t,"point","labelOutlineWidth",!1),label:i.bind(t,"point","label",!0),angle:i.bind(t,"point","angle",!0)}}}).then(function(e){t.layer=e;t.layerPromise.resolve(e)},function(e){t.layerPromise.reject(e)});t.EMPTY_RESULTS_LABEL=t.getLocaleString("noResults");t.EMPTY_RESULTS_TITLE=t.getLocaleString("checkCriterion");t.OUTBBX_LABEL=t.getLocaleString("outsideOfLimits");t.WFS_TYPE_ATTRS=["url","version","geometryName","featurePrefix","featureType","properties","outputFormat"]};e.renderData=function(e,t){var i=this;i._search=i._search||{};var n=function(){i.search(i.$text.val(),function(e){if(1===e.length){i.$text.val(e[0].label);i._goToResult(e[0].id,i.$list.find("li:not([header])").attr("dataRole"));i.$list.hide("fast")}else 0===e.length&&i.$list.hide("fast")})};TC.Control.prototype.renderData.call(i,e,function(){var e=function(){i.$text.val(i.$list[0].label||i.$list.find("li:not([header]) > a > span").text());i.lastPattern=i.$text.val();i._goToResult(i.$list[0].id||unescape(i.$list.find("li:not([header]) > a").attr("href")).substring(1),i.$list.find("li:not([header])").attr("dataRole"));i.$list.hide("fast")};i.$text=i._$div.find("input.tc-ctl-search-txt");i.options&&i.options.placeHolder&&i.$text.attr("placeHolder",i.options.placeHolder.trim());i.$list=i._$div.find(".tc-ctl-search-list");i.$button=i._$div.find(".tc-ctl-search-btn");i.$button.on(TC.Consts.event.CLICK,function(){i.getLayer().then(function(t){i.$list.find("li > a:not(.tc-ctl-search-li-loading,.tc-ctl-search-li-empty)").length>1||(t.features.length>0?t.map.zoomToFeatures(t.features):1===i.$list.find("li > a:not(.tc-ctl-search-li-loading,.tc-ctl-search-li-empty)").length?e():i.$text.trigger("keyup.autocomplete"))})});if(i.options.instructions){i.$text.attr("title",i.options.instructions.trim());i.$button.attr("title",i.options.instructions.trim())}i.$list.on(TC.Consts.event.CLICK,"a.tc-ctl-search-li-empty",function(){i.$list.hide("fast");i.$text.focus()});try{if(i.$text.has($("::-ms-clear"))){i.$text.on("mouseup",function(e){""!==i.$text.val()&&setTimeout(function(){if(""===i.$text.val()){i.$list.hide("fast");n()}},1)})}}catch(e){}i.$text.on("keypress",function(t){if(13==t.which){t.preventDefault();t.stopPropagation();i.lastPattern="";1===i.$list.find("li > a:not(.tc-ctl-search-li-loading,.tc-ctl-search-li-empty)").length?e():n();return!1}}).on("search",function(){if(0===i.$text.val().length){i.$list.hide("fast");n()}}).on("input",function(){if(0===i.$text.val().length){i.$list.hide("fast");n()}}).on("targetCleared.autocomplete",function(){i.$list.hide("fast")}).on("targetUpdated.autocomplete",function(){i.$list.find("li").length>0&&i.$list.show("fast")});i.lastPattern="";i.retryTimeout=null;TC.loadJS(!i.$text.autocomplete,[TC.apiLocation+"lib/jQuery/autocomplete.js"],function(){var e;i.$text=i._$div.find("input.tc-ctl-search-txt");i.$text.autocomplete({link:"#",target:i.$list,minLength:2,ctx:i,source:function(t,n){i.lastpress=performance.now();if(!e){e=requestAnimationFrame(function t(){var r=i.$text.val().trim();if(r.length>0&&(!i.lastPattern||r!=i.lastPattern)&&performance.now()-i.lastpress>i.interval){window.cancelAnimationFrame(e);e=void 0;i.$list.hide("fast");i.lastPattern=r;i.search(r,n)}else e=requestAnimationFrame(t)})}},callback:function(e){var t=$(e.target);$(e.target).is("a")||(t=$(e.target).closest("a"));i.$text.val($(t).find("span[hidden]").text());i.lastPattern=i.$text.val();i._goToResult(unescape($(t).attr("href")).substring(1),$(t).parent().attr("dataRole"));i.$text.autocomplete("clear")},buildHTML:function(e){var t=[],n=[],r=/[^a-zA-Z]/g,s=/[^0-9]/g;function a(e,t){var i=parseInt(e,10),n=parseInt(t,10);if(isNaN(i)&&isNaN(n)){var a=e.replace(r,""),o=t.replace(r,"");if(a===o){var l=parseInt(e.replace(s,""),10),c=parseInt(t.replace(s,""),10);return l===c?0:l>c?1:-1}return a>o?1:-1}return isNaN(i)?1:isNaN(n)?-1:i>n?1:-1}var o=e.results.sort(function(e,t){return this.ctx.getSearchTypeByRole(e.dataRole).searchWeight&&this.ctx.getSearchTypeByRole(t.dataRole).searchWeight?(this.ctx.getSearchTypeByRole(e.dataRole).searchWeight||0)>(this.ctx.getSearchTypeByRole(t.dataRole).searchWeight||0)?1:(this.ctx.getSearchTypeByRole(e.dataRole).searchWeight||0)<(this.ctx.getSearchTypeByRole(t.dataRole).searchWeight||0)?-1:a(e.label,t.label):e.dataRole>t.dataRole?1:e.dataRole<t.dataRole?-1:a(e.label,t.label)}.bind(this));i.rootCfg.active&&(o=o.sort(function(e,t){const i=function(){var i,n,r=this.rootCfg.active.root[0]instanceof Array?this.rootCfg.active.root[0].join("-"):this.rootCfg.active.root[0];if(e.properties&&e.properties.length>0&&t.properties&&t.properties.length>0){i=this.rootCfg.active.dataIdProperty.map(function(t){return e.properties[t].toString()}).join("-");n=this.rootCfg.active.dataIdProperty.map(function(e){return t.properties[e].toString()}).join("-")}else{i=e.id;n=t.id}return i!==r&&n===r?1:i===r&&n!==r?-1:a(e.label,t.label)}.bind(this);return this.getSearchTypeByRole(e.dataRole).searchWeight&&this.getSearchTypeByRole(t.dataRole).searchWeight?(this.getSearchTypeByRole(e.dataRole).searchWeight||0)>(this.getSearchTypeByRole(t.dataRole).searchWeight||0)?1:(this.getSearchTypeByRole(e.dataRole).searchWeight||0)<(this.getSearchTypeByRole(t.dataRole).searchWeight||0)?-1:i():i()}.bind(i)));for(var l=0;l<o.length;l++){var c=o[l];if(-1==n.indexOf(c.dataRole)){var u=this.ctx.getSearchTypeByRole(c.dataRole);t[t.length]=u.getSuggestionListHead();n.push(c.dataRole)}const e=function(){c.label;var e=[],t=this.ctx.lastPattern,n=[],r=",";-1==(t=i.NORMAL_PATTERNS.ROMAN_NUMBER.test(t)?t.replace(i.NORMAL_PATTERNS.ABSOLUTE_NOT_DOT,""):t.replace(i.NORMAL_PATTERNS.ABSOLUTE,"")).indexOf(r)&&(r=" ");n=t.trim().split(r);if(c.label.indexOf(this.ctx.LAT_LABEL)>-1&&c.label.indexOf(this.ctx.LON_LABEL)>-1||c.label.indexOf(this.ctx.UTMX_LABEL)>-1&&c.label.indexOf(this.ctx.UTMY_LABEL)>-1){n=this.ctx.lastPattern.split(" ");for(var s=0;s<n.length;s++)","==n[s].trim().slice(-1)&&(n[s]=n[s].slice(0,-1))}for(var a=0;a<n.length;a++)if(n[a].trim().length>0){e.push("("+n[a].trim().replace(/\(/gi,"").replace(/\)/gi,"")+")");if(u=/((\<)|(\>)|(\<\>))/gi.exec(n[a].trim()))for(var o=n[a].trim().replace(/((\<)|(\>)|(\<\>))/gi,"").split(" "),l=0;l<o.length;l++)o[l].trim().length>0&&e.push("("+o[l].trim().replace(/\(/gi,"\\(").replace(/\)/gi,"\\)")+")")}if(c.dataRole==TC.Consts.searchType.ROAD||c.dataRole==TC.Consts.searchType.ROADPK){var u;if(u=i.getSearchTypeByRole(c.dataRole).getPattern().exec(this.ctx.lastPattern)){e=[];u[2]&&u[3]&&u[4]?e.push("("+u[2]+"-"+u[3]+"-"+u[4]+")"):u[2]&&u[3]?e.push("("+u[2]+"-"+u[3]+")"):u[3]&&u[4]?e.push("("+u[3]+"-"+u[4]+")"):(u[2]||u[3])&&e.push("("+(u[2]||u[3])+")");u[5]&&e.push("(?:"+i.getLocaleString("search.list.pk")+"\\:\\s\\d*)("+u[5]+")\\d*")}else u&&u[5]&&(e=[]).push("(?:"+i.getLocaleString("search.list.pk")+"\\:\\s\\d*)("+u[5]+")\\d*")}var h="("+e.join("|")+")";h=(h=(h=(h=(h=(h=(h=(h=(h=(h=(h=h.replace(/\xe1|\xe0/gi,"a")).replace(/\xe9|\xe8/gi,"e")).replace(/\xed|\xec/gi,"i")).replace(/\xf3|\xf2/gi,"o")).replace(/\xfa|\xf9/gi,"u")).replace(/\xfc/gi,"u")).replace(/a/gi,"[a|\xe1|\xe0]")).replace(/e/gi,"[e|\xe9|\xe8]")).replace(/i/gi,"[i|\xed|\xec]")).replace(/o/gi,"[o|\xf3|\xf2]")).replace(/u/gi,"[u|\xfa|\xfc|\xf9]");var p=new RegExp(h,"gi"),d=c.label;return c.dataRole!==TC.Consts.searchType.ROAD||c.dataRole!==TC.Consts.searchType.ROADPK?d.replace(p,function(){var e=Array.prototype.slice.call(arguments,0);return e[e.length-3]?e[0].replace(e[e.length-3],"<b>"+e[e.length-3]+"</b>"):"<b>"+e[0]+"</b>"}):d.replace(p,"<b>$1</b>")}.bind(this);t[t.length]='<li dataRole="'+c.dataRole+'"><a href="#'+encodeURIComponent(c.id)+'"><span hidden>'+c.label+"</span>"+e()+"</a></li>"}return t.join("")}});i.$text.add(i.$list).on("keydown",function(e){if(!e.ctrlKey&&!e.altKey&&!e.shiftKey)if(40===e.keyCode){i.$text[0]==document.activeElement?i.$list.find("li:not([header]):first a").focus():i.$list.find("li:not([header]):last a").is(":focus")?i.$text.focus():i.$list.find("li:not([header])").find("a:focus").parent("li:not([header])").nextAll("li:not([header]):first").find("a").focus();e.preventDefault();e.stopPropagation()}else if(38===e.keyCode){i.$text[0]==document.activeElement?i.$list.find("li:not([header]):last a").focus():document.activeElement==i.$list.find("li:not([header]):first a").get(0)?i.$list.find("li:not([header]):last a").focus():i.$list.find("li:not([header])").find("a:focus").parent("li:not([header])").prevAll("li:not([header]):first").find("a").focus();e.preventDefault();e.stopPropagation()}e.stopPropagation()})})});$.isFunction(t)&&t()};e.addAllowedSearchType=function(e,t){this.allowedSearchTypes.push(new SearchType(e,t,this))};e.getSearchTypeByRole=function(e){return this.allowedSearchTypes.filter(function(t){return t.typeName==e})[0]};e.getSearchTypeByFeature=function(e){var t=this.allowedSearchTypes.filter(function(t){return t.isFeatureOfThisType(e)});return t.length>0?t[0]:null};e.getElementOnSuggestionList=function(e,t){for(var i=0;i<self.parent._search.data.length;i++)if(self.parent._search.data[i].id==e&&(!t||t&&self.parent._search.data[i].dataRole===t))return self.parent._search.data[i]};e.getLayer=function(){return this.layerPromise};e.getFeatures=function(){return this.layer.features};e.cleanMap=function(){var e=this;e.getLayer().then(function(t){var i=t.features;t.clearFeatures();e.map.$events.trigger($.Event(TC.Consts.event.FEATUREREMOVE,{layer:t,feature:i}));for(var n=0;n<e.WFS_TYPE_ATTRS.length;n++)t.hasOwnProperty(e.WFS_TYPE_ATTRS[n])&&delete t[e.WFS_TYPE_ATTRS[n]]})};e.getMunicipalities=function(){var e=this;TC.cache.search=TC.cache.search||{};if(!TC.cache.search.municipalities){e._municipalitiesDeferred=new $.Deferred;var t=e.getSearchTypeByRole(TC.Consts.searchType.CADASTRAL);if(!(t.municipality&&t.municipality.featureType&&t.municipality.labelProperty&&t.municipality.idProperty))throw new Error("Error en la configuraci\xf3n de la b\xfasqueda: "+t.typeName+". Error en el objeto municipality");var i={REQUEST:"GetFeature",SERVICE:"WFS",TYPENAME:t.municipality.featureType,VERSION:t.version,PROPERTYNAME:t.municipality.labelProperty+","+t.municipality.idProperty,OUTPUTFORMAT:t.outputFormat};t.featurePrefix&&(i.TYPENAME=t.featurePrefix+":"+i.TYPENAME);var n=t.url+"?"+$.param(i);$.ajax({url:n,type:"GET",dataType:"text"}).done(function(i){var n=(t.outputFormat===TC.Consts.format.JSON?new TC.wrap.parser.JSON:new TC.wrap.parser.WFS({featureNS:t.municipality.featurePrefix,featureType:t.municipality.featureType})).read(i);TC.cache.search.municipalities=[];for(var r=0;r<n.length;r++){var s=n[r];TC.cache.search.municipalities.push({label:s.data[t.municipality.labelProperty],id:s.data[t.municipality.idProperty]})}TC.cache.search.municipalities.sort(function(e,t){return e.label<t.label?-1:e.label>t.label?1:0});e._municipalitiesDeferred.resolve(TC.cache.search.municipalities)}).fail(function(){e._municipalitiesDeferred.resolve()})}return TC.cache.search.municipalities||e._municipalitiesDeferred.promise()};e.getCoordinates=function(e){var t=new $.Deferred,i=e.match(new RegExp("^"+$.trim(this.UTMX_LABEL.toLowerCase())+"*\\s*([0-9]{"+this.UTMX_LEN+"}(?:[.,]\\d+)?)\\s*\\,?\\s*"+$.trim(this.UTMY_LABEL.toLowerCase())+"*\\s*([0-9]{"+this.UTMY_LEN+"}(?:[.,]\\d+)?)$"));i&&(e=i[1]+" "+i[2]);(i=e.match(new RegExp("^"+$.trim(this.LAT_LABEL.toLowerCase())+"*\\s*([-+]?\\d{1,3}([.,]\\d+)?)\\,?\\s*"+$.trim(this.LON_LABEL.toLowerCase())+"*\\s*([-+]?\\d{1,2}([.,]\\d+)?)$")))&&(e=i[1]+" "+i[3]);if(/\d/.test(e)&&(new RegExp("^([0-9]{"+this.UTMX_LEN+"}(?:[.,]\\d+)?)\\s*\\,?\\s*([0-9]{"+this.UTMY_LEN+"}(?:[.,]\\d+)?)$").test(e)||/^([-+]?\d{1,3}([.,]\d+)?)\,?\s*([-+]?\d{1,2}([.,]\d+)?)$/.test(e))){if((i=/^([-+]?\d{1,3}([.,]\d+)?)\,?\s*([-+]?\d{1,2}([.,]\d+)?)$/.exec(e))&&(i[1].indexOf(",")>-1||i[3].indexOf(",")>-1)){i[1]=i[1].replace(",",".");i[3]=i[3].replace(",",".");e=i[1]+" "+i[3]}if(!i||i&&(i[1].indexOf(",")>-1?i[1].replace(",","."):i[1])<=180&&(i[3].indexOf(",")>-1?i[3].replace(",","."):i[3])<=90){if((i=new RegExp("^([0-9]{"+this.UTMX_LEN+"}(?:[.,]\\d+)?)\\s*\\,?\\s*([0-9]{"+this.UTMY_LEN+"}(?:[.,]\\d+)?)$").exec(e))&&(i[1].indexOf(",")>-1||i[2].indexOf(",")>-1)){i[1]=i[1].replace(",",".");i[2]=i[2].replace(",",".");e=i[1]+" "+i[2]}e=e.replace(this.UTMX_LABEL,"").replace(this.UTMY_LABEL,"").replace(this.LON_LABEL,"").replace(this.LAT_LABEL,"");var n=TC.Util.parseCoords(e);if(n){var r=n[0].value,s=n[1].value,a=n[0].type===TC.Consts.UTM?this.UTMX:this.LAT,o=n[1].type===TC.Consts.UTM?this.UTMY:this.LON,l=a+r+o+s,c=this.getPoint(l);if(c&&!this.insideLimit(c)){r=n[1].value;s=n[0].value;l=(a=n[1].type===TC.Consts.UTM?this.UTMX:this.LAT)+r+(o=n[0].type===TC.Consts.UTM?this.UTMY:this.LON)+s;c=this.getPoint(l)}if(c){this.availableSearchTypes[TC.Consts.searchType.COORDINATES].label=/^X(\d+(?:\.\d+)?)Y(\d+(?:\.\d+)?)$/.test(l)?this.getLocaleString("search.list.coordinates.utm")+this.map.crs:this.getLocaleString("search.list.coordinates.geo");t.resolve([{id:l,label:this.getLabel(l),dataRole:TC.Consts.searchType.COORDINATES}])}else t.resolve([])}else t.resolve([])}else t.resolve([])}else t.resolve([]);return t.promise()};e.getCadastralRef=function(e){var t=this,i=new $.Deferred,n=e.match(new RegExp($.trim(t.MUN_LABEL.toLowerCase())+"?\\s(.*)\\,\\s?"+$.trim(t.POL_LABEL.toLowerCase())+"?\\s(\\d{1,2})\\,\\s?"+$.trim(t.PAR_LABEL.toLowerCase())+"?\\s(\\d{1,4})"));n&&(e=n[1]+", "+n[2]+", "+n[3]);var r=e;!/^(.*)\,(\s*\d{1,2}\s*)\,(\s*\d{1,4}\s*)$/.test(e)&&t.getSearchTypeByRole(TC.Consts.searchType.CADASTRAL).suggestionRoot&&(r=t.getSearchTypeByRole(TC.Consts.searchType.CADASTRAL).suggestionRoot+", "+e);/^(.*)\,(\s*\d{1,2}\s*)\,(\s*\d{1,4}\s*)$/.test(r)&&!new RegExp("^([0-9]{"+t.UTMX_LEN+"})\\s*\\,\\s*([0-9]{"+t.UTMY_LEN+"})$").test(e)?$.when(t.getMunicipalities()).then(function(e){var n=/^(.*)\,(\s*\d{1,2}\s*)\,(\s*\d{1,4}\s*)$/.exec(r);if(n){var s=new RegExp($.trim(n[1]).replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),"i"),a=[];const r=function(e,i,n,r){var s=[];s.push[t.MUN]=e;s.push[t.POL]=n;s.push[t.PAR]=r;return{id:t.MUN+e+t.POL+n+t.PAR+r,label:t.getLabel(t.MUN+i+t.POL+n+t.PAR+r),dataRole:TC.Consts.searchType.CADASTRAL,properties:s}};if((a=$.grep(e,function(e){e=e.label||e.id||e;return s.test(e)||s.test(t.removePunctuation(e))})).length>0)for(var o=0;o<a.length;o++)a[o]=r(a[o].id,a[o].label,$.trim(n[2]),$.trim(n[3]));if(/^[0-9]*$/g.test(n[1])){if(n[1].trim()===t.getSearchTypeByRole(TC.Consts.searchType.CADASTRAL).suggestionRoot){var l=e.filter(function(e){return parseInt(e.id)===parseInt(t.getSearchTypeByRole(TC.Consts.searchType.CADASTRAL).suggestionRoot)})[0];l&&i.resolve([r(l.id,l.label,$.trim(n[2]),$.trim(n[3]))])}a.push(r($.trim(n[1]),$.trim(n[1]),$.trim(n[2]),$.trim(n[3])))}i.resolve(a)}}):i.resolve([]);return i.promise()};e.getStringPattern=function(e,t){var i=this,n=new $.Deferred,r=[],s=function(e){for(var t=[function(e){return/^(\d{1,3})\s?\-?\s?([a-z]{0,4})\s?\-?\s?([a-z]{0,4})$/i.test(e)},function(e){return/^([a-z]{1,4})\s?\-?\s?(\d{1,3})$/i.test(e)},function(e){return/^(sn|S\/N|s\/n|s\-n)$/i.test(e)},function(e){return/^([a-z]{1,4}\s?\+\s?[a-z]{1,4})$/i.test(e)}],n=[function(e){var t=[],n=/^(\d{1,3})\s?\-?\s?([a-z]{0,4})\s?\-?\s?([a-z]{0,4})$/i.exec(e);if(n){for(var r=1;r<n.length;r++)n[r].trim().length>0&&t.push(n[r].trim());return t.join(i._LIKE_PATTERN)}return e},function(e){var t=[],n=/^([a-z]{1,4})\s?\-?\s?(\d{1,3})$/i.exec(e);if(n){for(var r=1;r<n.length;r++)n[r].trim().length>0&&t.push(n[r].trim());return t.join(i._LIKE_PATTERN)}return e},function(e){return/^(sn|S\/N|s\/n|s\-n)$/i.exec(e)?"s*n":e},function(e){/^([a-z]{1,4}\s?\+\s?[a-z]{1,4})$/i.exec(e);return e}],r=0;r<n.length&&!t[r].call(i,e);)r++;return r<n.length?n[r].call(i,e):e},a=function(e,t,n){var r=new $.Deferred;","==(e=e.trim()).charAt(e.length-1)&&(e=e.substring(0,e.length-1));var a=[],o=function(e){if(t)for(var i=e.length;i--;)if(n){if(e[i].t){var r=this.rootCfg.active.rootLabel.filter(function(t){return t.label.indexOf(this.removePunctuation(e[i].t).toLowerCase())>-1}.bind(this));1==r.length?e[i].t=r[0].id:r.length>1?r.map(function(t){var n=$.extend({},e[i]);n.t=t.id;e.push(n)}):0==r.length&&e.splice(i,1)}}else e.push($.extend({},e[i],{t:t}))}.bind(i),l=function(e,i){var n=/^([^\,][a-z\xf1\xe1\xe9\xed\xf3\xfa\xfc\xe0\xe8\xec\xf2\xf9\s*\-\.\(\)\/0-9\<\>]+)$/i.exec(e);if(n&&n[1]){if(t){i.push({t:n[1].trim()});i.push({t:t,s:n[1].trim()})}else i.push({t:n[1].trim()});return!0}return!1},c=function(e,i){var n=/^([^\,][a-z\xf1\xe1\xe9\xed\xf3\xfa\xfc\xe0\xe8\xec\xf2\xf9\s*\-\.\(\)\/]+)\s*\,?\s*((\d{1,3}\s?\-?\s?[a-z]{0,4}\s?\-?\s?[a-z]{0,4})|([a-z]{1,4}\s?\-?\s?\d{1,3})|(sn|S\/N|s\/n|s\-n)|([a-z]{1,4}\s?\+\s?[a-z]{1,4}))$/i.exec(e);if(n&&n[1]&&n[2]){t?i.push({t:t,s:n[1].trim(),p:s(n[2].trim())}):i.push({t:n[1].trim(),s:n[2].trim()});return!0}return!1},u=function(e,i){var n=/^([^\,][0-9\s*\-\.\(\)\/]+)\s*\,?\s*(\d{1,3}\s?\-?\s?[a-z]{0,4}\s?\-?\s?[a-z]{0,4})|([a-z]{1,4}\s?\-?\s?\d{1,3})|(sn|S\/N|s\/n|s\-n)|([a-z]{1,4}\s?\+\s?[a-z]{1,4})$/i.exec(e);if(n&&n[1]&&n[2]&&t){i.push({t:t,s:n[1].trim(),p:s(n[2].trim())});return!0}return!1};if(function(){for(var t=[function(e){return e.length>=3},function(e){return!/^\d+$/.test(e)&&!/^\d+\,\s*\d+$/.test(e)}],n=0;n<t.length;n++)if(!t[n].call(i,e))return!1;return!0}()){var h=[function(e,t){var i=/^([^0-9\,]+)(?:\s*\,\s*)(?:([^\,][a-z\xf1\xe1\xe9\xed\xf3\xfa\xfc\xe0\xe8\xec\xf2\xf9\s*\-\.\(\)\/0-9]+))(?:\s*\,\s*)(?:(\d{1,3}\s?\-?\s?[a-z]{0,4}\s?\-?\s?[a-z]{0,4})|([a-z]{1,4}\s?\-?\s?\d{1,3})|(sn|S\/N|s\/n|s\-n)|([a-z]{1,4}\s?\+\s?[a-z]{1,4}))$/i.exec(e);if(i&&i[1]&&i[2]){var n=function(){return s((i[3]||i[4]||i[5]||i[6]).trim())};if(/^([^0-9]+)$/i.test(i[1].trim())&&/^([^0-9]+)$/i.test(i[2].trim())){t.push({t:i[1].trim(),s:i[2].trim(),p:n()});t.push({t:i[2].trim(),s:i[1].trim(),p:n()})}else/^([^0-9]+)$/i.test(i[1].trim())?t.push({t:i[1].trim(),s:i[2].trim(),p:n()}):t.push({s:i[1].trim(),t:i[2].trim(),p:n()});o(t);return!0}return!1},function(e,t){var i=/^(?:([^\,][a-z\xf1\xe1\xe9\xed\xf3\xfa\xfc\xe0\xe8\xec\xf2\xf9\s*\-\.\(\)\/0-9]+))(?:\s*\,\s*)(?:(\d{1,3}\s?\-?\s?[a-z]{0,4}\s?\-?\s?[a-z]{0,4})|([a-z]{1,4}\s?\-?\s?\d{1,3})|(sn|S\/N|s\/n|s\-n)|([a-z]{1,4}\s?\+\s?[a-z]{1,4}))(?:\s*\,\s*)([^0-9\,]+)$/i.exec(e);if(i&&i[6]&&i[1]){var n=function(){return s((i[2]||i[3]||i[4]||i[5]).trim())};if(/^([^0-9]+)$/i.test(i[6].trim())&&/^([^0-9]+)$/i.test(i[1].trim())){t.push({t:i[6].trim(),s:i[1].trim(),p:n()});t.push({t:i[1].trim(),s:i[6].trim(),p:n()})}else/^([^0-9]+)$/i.test(i[6].trim())?t.push({t:i[6].trim(),s:i[1].trim(),p:n()}):t.push({s:i[6].trim(),t:i[1].trim(),p:n()});o(t);return!0}return!1},function(e,t){var i=/^(?:([^\,][a-z\xf1\xe1\xe9\xed\xf3\xfa\xfc\xe0\xe8\xec\xf2\xf9\s*\-\.\(\)\/0-9]+))(?:\s*\,\s*)([^0-9\,]+)(?:\s*\,\s*)(?:(\d{1,3}\s?\-?\s?[a-z]{0,4}\s?\-?\s?[a-z]{0,4})|([a-z]{1,4}\s?\-?\s?\d{1,3})|(sn|S\/N|s\/n|s\-n)|([a-z]{1,4}\s?\+\s?[a-z]{1,4}))$/i.exec(e);if(i&&i[1]&&i[2]){t.push({t:i[2].trim(),s:i[1].trim(),p:s((i[3]||i[4]||i[5]||i[6]).trim())});o(t);return!0}return!1},function(e,t){var n=/^([^0-9\,]+)(?:\s*\,\s*)(?:([^\,][a-z\xf1\xe1\xe9\xed\xf3\xfa\xfc\xe0\xe8\xec\xf2\xf9"\s*\-\.\(\)\/0-9]+))$/i.exec(e);if(!n&&/^[^0-9]*$/i.test(e.trim())){var r=e.split(",").reverse();n=/^([^0-9\,]+)(?:\s*\,\s*)(?:([^\,][a-z\xf1\xe1\xe9\xed\xf3\xfa\xfc\xe0\xe8\xec\xf2\xf9"\s*\-\.\(\)\/0-9]+))$/i.exec(r.join(","))}if(n&&n[1]&&n[2]){if(/^([^0-9]+)$/i.test(n[1].trim())&&/^([^0-9]+)$/i.test(n[2].trim())){t.push({t:n[1].trim(),s:n[2].trim()});t.push({s:n[1].trim(),t:n[2].trim()})}else{var s=function(e){for(var t=e.split(" ").reverse(),n=[],r=0;r<t.length;r++)if(1==t[r].length){n.push(t[r]);t[r]=""}return n.length>0?t.reverse().join(" ").trim()+i._LIKE_PATTERN+n.reverse().join(i._LIKE_PATTERN):t.reverse().join(" ").trim()};/^([^0-9]+)$/i.test(n[1].trim())?t.push({t:n[1].trim(),s:s(n[2].trim())}):t.push({s:s(n[1].trim()),t:n[2].trim()})}o(t);return!0}return!1},function(e,t){var n=/^(?:([^\,][a-z\xf1\xe1\xe9\xed\xf3\xfa\xfc\xe0\xe8\xec\xf2\xf9\s*\-\.\(\)\/0-9]+))(?:\s*\,\s*)([^0-9\,]+)$/i.exec(e);if(!n){var r=e.split(",").reverse();n=/^([^0-9\,]+)(?:\s*\,\s*)(?:([^\,][a-z\xf1\xe1\xe9\xed\xf3\xfa\xfc\xe0\xe8\xec\xf2\xf9"\s*\-\.\(\)\/0-9]+))$/i.exec(r.join(","))}if(n){for(var a={},l=(r=e.split(",").reverse(),0);l<r.length;l++)if(/^([^0-9\,]+)$/i.test(r[l].trim()))a.t=r[l].trim();else if(/(\s*\d+)/i.test(r[l].trim()))if(-1==r[l].trim().indexOf(" "))a.s=r[l].trim();else{for(var c=r[l].trim().split(" ").reverse(),u=function(e){if(/^(?:(\d{1,3}\s?\-?\s?[a-z]{0,4}\s?\-?\s?[a-z]{0,4})|([a-z]{1,4}\s?\-?\s?\d{1,3})|(sn|S\/N|s\/n|s\-n)|([a-z]{1,4}\s?\+\s?[a-z]{1,4}))$/i.exec(e.trim())){a.p=s(e.trim());return!0}return!1},h=0,p=c[h].trim();h<c.length&&!u(p);)++h<c.length&&(p+=c[h]);if(a.p){for(var d=c,f=0;f<d.length;f++){for(var m=!1,y=0;y<d[f].split("").length;y++)a.p.indexOf(d[f][y])>-1&&(m=!0);if(m){d[f];d[f]="";if(a.p==s(p))break}}if(/^([^\,][a-z\xf1\xe1\xe9\xed\xf3\xfa\xfc\xe0\xe8\xec\xf2\xf9\s*\-\.\(\)\/0-9]+)$/i.test(c.reverse().join(" ").trim())){for(var g=[],C=c.reverse(),v=0;v<C.length;v++)if(1==C[v].trim().length){g.push(C[v].trim());C[v]=""}a.s=g.length>0?C.reverse().join(" ").trim()+i._LIKE_PATTERN+g.reverse().join(i._LIKE_PATTERN):C.reverse().join(" ").trim()}t.push({t:a.t,s:a.s+" "+a.p})}else a.s=r[l].trim()}t.push(a);o(t);return!0}return!1}];h=t&&e.split(",").length<3?[c,u,l].concat(h):h.concat([c,u,l]);var p=0;try{for(;p<h.length&&!h[p].call(i,e,a);)p++}catch(t){TC.error("Error seg\xfan el patr\xf3n: "+e,TC.Consts.msgErrorMode.EMAIL,"Error en la b\xfasqueda del callejero")}}r.resolve(a);return r},o=function(t){if(t){i._search.data=r;i.request||(i.request=[]);function s(e,t){var s=i.getSearchTypeByRole(t);return $.ajax({url:s.url,type:"POST",contentType:"application/x-www-form-urlencoded;charset=UTF-8",dataType:"text",data:s.filter.getParams(e),beforeSend:function(){i.$list.html('<li><a class="tc-ctl-search-li-loading" href="#">'+i.getLocaleString("searching")+'<span class="tc-ctl-search-loading-spinner tc-ctl-search-loading"></span></a></li>');i.$text.trigger("targetUpdated.autocomplete")}}).done(function(e){r=r.concat(s.getSuggestionListElements(e))}).fail(function(e){"abort"!==e.statusText&&alert("error");n.resolve(r)})}$.map(t,function(t,n){var r=function(t){return e.map(function(e){var n=i.getSearchTypeByRole(e);if(Object.keys(n.queryProperties).length===Object.keys(t).length)return n.typeName})}(t);for(n=0;n<r.length;n++){var a=r[n];a&&i.getSearchTypeByRole(a)&&i.request.push(s(t,a))}});$.when.apply($,i.request).then(function(){n.resolve(r)})}else n.resolve(r)};t=function(e){e=i.removePunctuation(e);return(e=i.NORMAL_PATTERNS.ROMAN_NUMBER.test(e)?e.replace(i.NORMAL_PATTERNS.ABSOLUTE_NOT_DOT,""):e.replace(i.NORMAL_PATTERNS.ABSOLUTE,"")).toLowerCase()}(t);var l=/(.*)\((.*)\)/.exec(t);if(l&&l.length>2){var c=[];a(l[1],i.rootCfg.active&&i.rootCfg.active.root||"",i.rootCfg.active&&i.rootCfg.active.limit||!1).then(function(e){c=e||[];a(l[1]+","+l[2],i.rootCfg.active&&i.rootCfg.active.root||"",i.rootCfg.active&&i.rootCfg.active.limit||!1).then(function(e){c=c.concat(e);o(c)})});return n.promise()}a(t,i.rootCfg.active&&i.rootCfg.active.root||"",i.rootCfg.active&&i.rootCfg.active.limit||!1).then(o);return n.promise()};e.getRoad=function(e){var t=this,i=new $.Deferred;if((e=e.trim()).length<2)i.resolve([]);else{var n=t.getSearchTypeByRole(TC.Consts.searchType.ROAD),r=n.getPattern().exec(e);if(r&&r[3]){var s=r[2]?r[2].trim()+"-"+r[3].trim():r[3].trim();r[4]&&r[4].length>0&&(s=s+"-"+r[4].trim());$.ajax({url:n.url+"?"+n.filter.getParams({t:s}),type:"GET",contentType:"application/x-www-form-urlencoded;charset=UTF-8",beforeSend:function(){t.$list.html('<li><a class="tc-ctl-search-li-loading" href="#">'+t.getLocaleString("searching")+'<span class="tc-ctl-search-loading-spinner tc-ctl-search-loading"></span></a></li>');t.$text.trigger("targetUpdated.autocomplete")}}).done(function(e){var t=[];if(e.totalFeatures>0){e.features.map(function(e){var i=n.outputProperties;if(!t.some(function(t){return t.text==e.properties[i[0]]})){var r=n.outputFormatLabel.tcFormat(n.outputProperties.map(function(t){return e.properties[t]})),s=n.outputProperties.map(function(t){return e.properties[t]}).join("-");t.push({id:n.dataIdProperty.map(function(t){return e.properties[t]}).join("#"),label:r,text:s,dataLayer:e.id.split(".")[0],dataRole:n.typeName})}});i.resolve(t)}else i.resolve([])}).fail(function(e){i.resolve([])})}else i.resolve([])}return i.promise()};e.getPK=function(e){var t=this,i=new $.Deferred;if((e=e.trim()).length<3)i.resolve([]);else{var n=t.getSearchTypeByRole(TC.Consts.searchType.ROADPK),r=n.getPattern().exec(e);if(r&&r[3]&&r[5]){var s=r[2]?r[2].trim()+"-"+r[3].trim():r[3].trim();r[4]&&r[4].length>0&&(s=s+"-"+r[4].trim());$.ajax({url:n.url+"?"+n.filter.getParams({t:s,s:r[5].trim()}),type:"GET",contentType:"application/x-www-form-urlencoded;charset=UTF-8",beforeSend:function(){t.$list.html('<li><a class="tc-ctl-search-li-loading" href="#">'+t.getLocaleString("searching")+'<span class="tc-ctl-search-loading-spinner tc-ctl-search-loading"></span></a></li>');t.$text.trigger("targetUpdated.autocomplete")}}).done(function(e){var t=[];if(e.totalFeatures>0){e.features.map(function(e){var i=n.outputProperties;if(!t.some(function(t){return t.label==e.properties[i[0]]})){var r=n.outputFormatLabel.tcFormat(n.outputProperties.map(function(t){return e.properties[t]}));t.push({id:n.dataIdProperty.map(function(t){return e.properties[t]}).join("#"),label:r,text:r,dataLayer:e.id.split(".")[0],dataRole:n.typeName})}});i.resolve(t)}else i.resolve([])}).fail(function(e){i.resolve([])})}else i.resolve([])}return i.promise()};e.search=function(e,t){var i=this,n=[];if(i.request){for(var r=0;r<i.request.length;r++){console.log("new criteria: search promise/s aborted");i.request[r].abort()}i.request=[]}if((e=$.trim(e)).length>0){e=e.toLowerCase();var s=[];i.allowedSearchTypes.forEach(function(t){t.parser?function(t){var r=new $.Deferred;s.push(r);$.when(t.call(i,e)).then(function(e){n=n.concat(e);r.resolve(n)})}(t.parser):console.log("Falta implementaci\xf3n del m\xe9todo parser")});$.when.apply(i,s).then(function(){n&&(i._search.data=n=n.sort(function(e,t){var i,n=/(\d+)/,r="";if(n.test(e.label)&&n.test(t.label)){i=e.label.match(n)[1];r=t.label.match(n)[1]}else{i=e.label;r=t.label}return i>r?1:i<r?-1:0}.bind(i)));t&&t(n);if(0===n.length){i.cleanMap();if(!i.layer||i.layer&&0===i.layer.features.length&&i.request&&i.request.length>0||0==i.request.length||!i.request){i.$list.html('<li><a title="'+i.EMPTY_RESULTS_TITLE+'" class="tc-ctl-search-li-empty">'+i.EMPTY_RESULTS_LABEL+"</a></li>");i.$text.trigger("targetUpdated.autocomplete")}}i.lastPattern=""})}else i.cleanMap()};var t=function(e){if(e&&e.length>0)for(var t=0;t<e.length;t++)e[t].showsPopup!=this.queryableFeatures&&(e[t].showsPopup=this.queryableFeatures)};e._goToResult=function(e,i){var n=this,r=null;const s=$.Deferred();n.loading||(n.loading=n.map.getControlsByClass("TC.control.LoadingIndicator")[0]);var a;a=n.loading.addWait();if(Modernizr.mq("(max-width: 30em)")){n.$text.blur();n.map.$events.trigger($.Event(TC.Consts.event.TOOLSCLOSE),{})}n.cleanMap();var o=!1,l=!0;n.allowedSearchTypes.forEach(function(t){if(l)if(n.availableSearchTypes[t.typeName]){var s=i||n.getElementOnSuggestionList(e).dataRole;if(s){var a=n.getSearchTypeByRole(s);if(n.availableSearchTypes[s]&&a&&a.goTo)null!==(r=a.goTo.call(n,e,s))&&(l=!1);else if(!n.availableSearchTypes[s]&&a&&a.goTo){o=!0;null!==(r=a.goTo.call(n,e,s))&&(l=!1)}else console.log("Falta implementaci\xf3n del m\xe9todo goTo")}}else if(t.goTo){o=!0;null!==(r=t.goTo.call(n,e))&&(l=!1)}else console.log("Falta implementaci\xf3n del m\xe9todo goTo")});n.loading.removeWait(a);if(r){n.getLayer().then(function(e){switch(!0){case r.params.type==TC.Consts.layerType.VECTOR:for(var i=0;i<n.WFS_TYPE_ATTRS.length;i++)e.hasOwnProperty(n.WFS_TYPE_ATTRS[i])&&delete e[n.WFS_TYPE_ATTRS[i]];break;case r.params.type==TC.Consts.layerType.WFS:for(i=0;i<n.WFS_TYPE_ATTRS.length;i++)e[n.WFS_TYPE_ATTRS[i]]=r.params[n.WFS_TYPE_ATTRS[i]];a=n.loading.addWait()}e.type=r.params.type;e.refresh().then(function(){n.map.one(TC.Consts.event.LAYERUPDATE,function(i){if(i.layer==e){n.map.one(TC.Consts.event.FEATURESADD,function(i){if(i.layer==e){if(!i.layer.features||0==i.layer.features.length&&i.layer.wrap.layer.getSource().getFeatures()){n.$list.hide("fast");var s=i.layer.wrap.layer.getSource().getExtent(),o=i.layer.map.options.pointBoundsRadius;if(s[2]-s[0]==0){s[0]=s[0]-o;s[2]=s[2]+o}if(s[3]-s[1]==0){s[1]=s[1]-o;s[3]=s[3]+o}i.layer.map.setExtent(s);n.map.$events.trigger($.Event(TC.Consts.event.ZOOMTO,{extent:s,layer:i.layer}))}else if(i.layer.features&&i.layer.features.length>0){n.$list.hide("fast");t.call(n,i.layer.features);n.layer.map.zoomToFeatures(i.layer.features);n.map.$events.trigger($.Event(TC.Consts.event.FEATURESADD,{layer:n.layer,features:n.layer.features}))}else if(i.layer.features&&0==i.layer.features.length&&r.params.type==TC.Consts.layerType.WFS){n.$list.html(r.emptyResultHTML);n.$text.trigger("targetUpdated.autocomplete");n.map.$events.trigger($.Event(TC.Consts.event.SEARCHQUERYEMPTY))}n.loading.removeWait(a)}});if(i.layer.features&&i.layer.features.length>0){n.$list.hide("fast");t.call(n,i.layer.features);n.layer.map.zoomToFeatures(n.layer.features);n.map.$events.trigger($.Event(TC.Consts.event.FEATURESADD,{layer:n.layer,features:n.layer.features}));n.loading.removeWait(a)}else if(i.layer.features&&0==i.layer.features.length&&r.params.type==TC.Consts.layerType.WFS){n.$list.html(r.emptyResultHTML);n.$text.trigger("targetUpdated.autocomplete");i.newData&&i.newData.features&&i.newData.features.length>0||n.map.$events.trigger($.Event(TC.Consts.event.SEARCHQUERYEMPTY));n.loading.removeWait(a)}}})})});s.resolve(r)}else{s.reject();o||n.map.$events.trigger($.Event(TC.Consts.event.SEARCHQUERYEMPTY))}return s.promise()};e.goToResult=function(e,t){if(this.getSearchTypeByRole(t))return this._goToResult(e,t);if(this.availableSearchTypes[t]){this.addAllowedSearchType(t,this.availableSearchTypes[t],this);return this._goToResult(e,t)}alert("No se reconoce el tipo de b\xfasqueda: "+t)};e.goToCoordinates=function(e){var t={};if(/^X(\d+(?:[\.\,]\d+)?)Y(\d+(?:[\.\,]\d+)?)$/.test(e)||/^Lat((?:[+-]?)\d+(?:[.,]\d+)?)Lon((?:[+-]?)\d+(?:[.,]\d+)?)$/.test(e)){t.params={type:TC.Consts.layerType.VECTOR,styles:{marker:{url:this.layerStyleFN.bind(this,"marker","url",!0)}}};t.emptyResultHTML='<li><a class="tc-ctl-search-li-empty">'+this.OUTBBX_LABEL+"</a></li>";(function(e){var t=this;wait=t.loading.addWait();var i,n,r,s=t.getPoint(e);if(s){n=t.getLabel(e);r=t.layer.addMarker(s,$.extend({},t.map.options.styles.point,{title:n,group:n}));i=t.map.options.pointBoundsRadius;t.map.setExtent([s[0]-i,s[1]-i,s[0]+i,s[1]+i])}else{var a=/^Lat((?:[+-]?)\d+(?:\.\d+)?)Lon((?:[+-]?)\d+(?:\.\d+)?)$/.exec(e);e=t.LAT+a[2]+t.LON+a[1];if(s=t.getPoint(e)){n=t.getLabel(e);r=t.layer.addMarker(s,$.extend({},t.map.options.styles.point,{title:n,group:n}));i=t.map.options.pointBoundsRadius;t.map.setExtent([s[0]-i,s[1]-i,s[0]+i,s[1]+i]);t.$text.val(n)}}$.when(r).then(function(e){t.map.$events.trigger($.Event(TC.Consts.event.FEATURESADD,{layer:t.layer,features:[e]}));t.loading.removeWait(wait)})}).call(this,e);return t}return null};e.goToCadastralRef=function(e){var t={},i=new RegExp("^"+this.MUN+"(\\d+)"+this.POL+"(\\d{1,2})"+this.PAR+"{1}(\\d{1,4})");if(i.test(e)){var n=i.exec(e);TC.filter||TC.syncLoadJS(TC.apiLocation+"TC/Filter");var r=this.getSearchTypeByRole(TC.Consts.searchType.CADASTRAL);t.params={type:TC.Consts.layerType.WFS,url:r.url,version:r.version,geometryName:r.geometryName,featurePrefix:r.featurePrefix,featureType:r.featureType,properties:new TC.filter.and(new TC.filter.equalTo(r.queryProperties.firstQueryWord,$.trim(n[1])),new TC.filter.equalTo(r.queryProperties.secondQueryWord,$.trim(n[2])),new TC.filter.equalTo(r.queryProperties.thirdQueryWord,$.trim(n[3]))),outputFormat:r.outputFormat,styles:r.styles};t.emptyResultHTML='<li><a title="'+this.EMPTY_RESULTS_TITLE+'" class="tc-ctl-search-li-empty">'+this.EMPTY_RESULTS_LABEL+"</a></li>";return t}return null};e.goToRoad=function(e){var t={},i=this.getSearchTypeByRole(TC.Consts.searchType.ROAD);t.params={type:TC.Consts.layerType.WFS,url:i.url,version:i.version,geometryName:i.geometryName,featurePrefix:i.featurePrefix,featureType:i.getFeatureTypes(),maxFeatures:3e3,properties:i.filter.getGoToFilter(e),outputFormat:i.outputFormat,styles:i.styles};t.emptyResultHTML='<li><a title="'+this.EMPTY_RESULTS_TITLE+'" class="tc-ctl-search-li-empty">'+this.EMPTY_RESULTS_LABEL+"</a></li>";return t};e.goToPK=function(e){var t={},i=this.getSearchTypeByRole(TC.Consts.searchType.ROADPK);t.params={type:TC.Consts.layerType.WFS,url:i.url,version:i.version,geometryName:i.geometryName,featurePrefix:i.featurePrefix,featureType:i.getFeatureTypes(),maxFeatures:3e3,properties:i.filter.getGoToFilter(e),outputFormat:i.outputFormat,styles:i.styles};t.emptyResultHTML='<li><a title="'+this.EMPTY_RESULTS_TITLE+'" class="tc-ctl-search-li-empty">'+this.EMPTY_RESULTS_LABEL+"</a></li>";return t};e.goToStringPattern=function(e,t){var i={},n=this.getSearchTypeByRole(t);i.params={type:TC.Consts.layerType.WFS,url:n.url,version:n.version,geometryName:n.geometryName,featurePrefix:n.featurePrefix,featureType:n.getFeatureTypes(),maxFeatures:3e3,properties:n.filter.getGoToFilter(e),outputFormat:n.outputFormat,styles:n.styles};return i};e.getPoint=function(e){var t,i=this.map.wrap.isGeo(),n=/^X(\d+(?:\.\d+)?)Y(\d+(?:\.\d+)?)$/.exec(e);if(n&&3===n.length){t=[parseFloat(n[1]),parseFloat(n[2])];i&&(t=TC.Util.reproject(t,this.map.options.utmCrs,this.map.crs))}else{if((n=/^Lat((?:[+-]?)\d+(?:[.,]\d+)?)Lon((?:[+-]?)\d+(?:[.,]\d+)?)$/.exec(e))&&3===n.length){t=[parseFloat(n[2]),parseFloat(n[1])];if(!i)return TC.Util.reproject(t,this.map.options.geoCrs,this.map.crs)}if((n=/^Lon((?:[+-]?)\d+(?:[.,]\d+)?)Lat((?:[+-]?)\d+(?:[.,]\d+)?)$/.exec(e))&&3===n.length){t=[parseFloat(n[2]),parseFloat(n[1])];if(!i)return TC.Util.reproject(t,this.map.options.geoCrs,this.map.crs)}}return t};e.insideLimit=function(e){return!!function(e,t){return!(e instanceof Array)||t[0]>=e[0]&&t[0]<=e[2]&&t[1]>=e[1]&&t[1]<=e[3]}(this.map.options.maxExtent,e)};e.getPattern=function(){return this.$text.val()};e.getLabel=function(e){var t=e,i=TC.Util.getMapLocale(this.map);if(e.match(new RegExp("^(?:"+this.LAT+"[-\\d])|(?:"+this.UTMX+"[\\d])"))){(r=(t=t.replace(this.LAT,this.LAT_LABEL).replace(this.LON," "+this.LON_LABEL).replace(this.UTMX,this.UTMX_LABEL).replace(this.UTMY," "+this.UTMY_LABEL)).match(new RegExp("^"+$.trim(this.LAT_LABEL)+"*\\s*([-+]?\\d{1,3}([.,]\\d+)?)\\,?\\s*"+$.trim(this.LON_LABEL)+"*\\s*([-+]?\\d{1,2}([.,]\\d+)?)$")))&&(t=(t=t.replace(r[1],parseFloat(r[1]).toLocaleString(i))).replace(r[3],parseFloat(r[3]).toLocaleString(i)));var n=1.1.toLocaleString(i).substring(1,2);if(r=t.match(new RegExp("^"+$.trim(this.UTMX_LABEL)+"*\\s*([0-9]{"+this.UTMX_LEN+"}(?:[.,]\\d+)?)\\s*\\,?\\s*"+$.trim(this.UTMY_LABEL)+"*\\s*([0-9]{"+this.UTMY_LEN+"}(?:[.,]\\d+)?)$"))){Number.isInteger(parseFloat(r[1]))||(t=t.replace(r[1],r[1].replace(".",n)));Number.isInteger(parseFloat(r[2]))||(t=t.replace(r[2],r[2].replace(".",n)))}}else if(e.match(new RegExp("^(?:"+this.LON+"[-\\d])"))){(r=(t=t.replace(this.LON,this.LON_LABEL).replace(this.LAT," "+this.LAT_LABEL)).match(new RegExp("^"+$.trim(this.LON_LABEL)+"*\\s*([-+]?\\d{1,3}([.,]\\d+)?)\\,?\\s*"+$.trim(this.LAT_LABEL)+"*\\s*([-+]?\\d{1,2}([.,]\\d+)?)$")))&&(t=(t=t.replace(r[1],parseFloat(r[1]).toLocaleString(i))).replace(r[3],parseFloat(r[3]).toLocaleString(i)))}else if(e.match(new RegExp("^(?:(\\"+this.MUN+"{1})(.*)(\\"+this.POL+"{1})(\\d{1,2})(\\"+this.PAR+"{1})(\\d{1,4}))"))){var r=e.match(new RegExp("^(?:(\\"+this.MUN+"{1})(.*)(\\"+this.POL+"{1})(\\d{1,2})(\\"+this.PAR+"{1})(\\d{1,4}))"));t=this.MUN_LABEL+r[2]+", "+this.POL_LABEL+r[4]+", "+this.PAR_LABEL+r[6]}return t};e.removePunctuation=function(e){e=e||"";for(var t=new Array(e.length),i={"\xe1":"a","\xe0":"a","\xc1":"A","\xc0":"A","\xe9":"e","\xe8":"e","\xc9":"E","\xc8":"E","\xed":"i","\xec":"i","\xcd":"I","\xcc":"I","\xf3":"o","\xf2":"o","\xd3":"O","\xd2":"O","\xfa":"u","\xf9":"u","\xfc":"u","\xda":"U","\xd9":"U","\xdc":"U"},n=0,r=e.length;n<r;n++)t[n]=i[e.charAt(n)]||e.charAt(n);return t.join("")};e.decodeEntities=function(e){return $("<div/>").html(e).text()};e.exportState=function(){return{id:this.id,searchText:this.$text.val(),layer:this.layer.exportState({exportStyles:!1})}};e.importState=function(e){const t=this;t.$text.val(e.searchText);t.layer.importState(e.layer).then(function(){t.layer.features.forEach(function(e){e.setStyle(null)})})}}();String.prototype.tcFormat||(String.prototype.tcFormat=function(){var e=(arguments||[""])[0];return this.replace(/{(\d+)}/g,function(t,i){return void 0!==e[i]?e[i]:t})});String.prototype.splitRemoveWhiteSpaces||(String.prototype.splitRemoveWhiteSpaces=function(e){for(var t=[],i=this.split(e),n=0;n<i.length;n++)$.trim(i[n]).length>0&&t.push($.trim(i[n]));return t});String.prototype.toCamelCase||(String.prototype.toCamelCase=function(){var e=this.toLowerCase(),t=this.toLowerCase().match(/[^A-Z\xc1\xc9\xcd\xd3\xda\xdc\xc0\xc8\xcc\xd2\xd9\xe1\xe9\xed\xf3\xfa\xfc\xe0\xe8\xec\xf2\xf9a-z0-9_]+(.)/g);if(t)for(var i=0;i<t.length;i++)/[;:.<>\{\}\[\]\/\s()]/g.test(t[i])&&(e=e.replace(t[i],t[i].toUpperCase()));return e.charAt(0).toUpperCase()+e.substring(1)});Array.prototype.hasOwnProperty("findByProperty")||Object.defineProperty(Array.prototype,"findByProperty",{enumerable:!1,writable:!0,value:function(e,t){for(var i=0;i<this.length;i++)if(this[i][e]==t)return this[i]}});String.prototype.endsWith||(String.prototype.endsWith=function(e,t){var i=this.toString();("number"!=typeof t||!isFinite(t)||Math.floor(t)!==t||t>i.length)&&(t=i.length);t-=e.length;var n=i.indexOf(e,t);return-1!==n&&n===t});TC.control=TC.control||{};TC.control.TabContainer||TC.syncLoadJS(TC.apiLocation+"TC/control/TabContainer");TC.control.SelectContainer=TC.control.TabContainer;TC.control=TC.control||{};TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control");TC.control.Share=function(e){this._classSelector="."+this.CLASS;TC.Control.apply(this,arguments);var t=e||{};this._$dialogDiv=$(TC.Util.getDiv(t.dialogDiv));t.dialogDiv||this._$dialogDiv.appendTo("body");this.render()};TC.inherit(TC.control.Share,TC.Control);!function(){var e=TC.control.Share.prototype;e.CLASS="tc-ctl-share";e.QR_MAX_LENGTH=150;e.MAILTO_MAX_LENGTH=256;e.IFRAME_WIDTH="600px";e.IFRAME_HEIGHT="450px";e.MOBILEFAV="Siga las instrucciones del navegador del dispositivo m\xf3vil para a\xf1adir como favorito. Se guardar\xe1 el estado actual del mapa.";e.NAVALERT=" +D para guardar en marcadores.";e.render=function(e){var t=this;t.getRenderedHtml(t.CLASS+"-dialog",null,function(e){t._$dialogDiv.html(e)}).then(function(){TC.Control.prototype.render.call(t,function(){if(TC.Util.detectChrome()||TC.Util.detectIE()>=10||TC.Util.detectFirefox()>=41){t._$div.find("button").removeClass("hide");t._$div.find("input[type=text]").removeAttr("data-original-title")}TC.Util.detectMobile()||t._$div.find(".share-whatsapp").addClass(TC.Consts.classes.HIDDEN);var i=t._$div.find("."+t.CLASS+"-url-box");t._$div.find("span:not(.tc-beta)").on(TC.Consts.event.CLICK,function(e){var t=$(this).closest("label").find("input[type=radio][name=format]").val();i.removeClass(TC.Consts.classes.HIDDEN);i.not(".tc-"+t).addClass(TC.Consts.classes.HIDDEN)});$.isFunction(e)&&e()})})};e.getLocation=function(){var e=window.location.href;window.location.hash&&(e=e.substr(0,e.indexOf(window.location.hash)));return e};e.generateLink=function(){var e=window.location.href,t=e.indexOf("#");t>0&&(e=e.substring(0,t));if(this.extraParams){var i=TC.Util.getQueryStringParams(e);$.extend(i,this.extraParams);var n=e.indexOf("?");n>=0&&(e=e.substring(0,n));e=e.concat("?",$.param(i))}TC.Util.getParameterByName("lang").length>0&&(e=e.indexOf("&")>-1?e.replace("lang="+TC.Util.getParameterByName("lang")+"&",""):e.replace("?lang="+TC.Util.getParameterByName("lang"),""));const r=this.exportControlStates(),s=r.length?{ctl:r}:void 0;var a=this.map.getMapState(s),o=e.concat("#",a);this._$div.find("."+this.CLASS+"-alert").toggleClass(TC.Consts.classes.HIDDEN,o.length<=TC.Consts.URL_MAX_LENGTH);return o};e.generateIframe=function(e){var t=e||this.generateLink();if(t)return'<iframe style="width:'+this.IFRAME_WIDTH+";height:"+this.IFRAME_HEIGHT+';" src="'+t+'"></iframe>'};e.exportControlStates=function(){const e=this;return e.map?e.map.controls.map(function(e){return e.exportState()}).filter(function(e){return e}):[]};e.importControlStates=function(e){const t=this;t.map&&e.forEach(function(e){const i=t.map.getControlById(e.id);i&&i.importState(e)})};e.register=function(t){var i=this;TC.Control.prototype.register.call(i,t);i.MOBILEFAV=i.getLocaleString("mobileBookmarks.instructions");i.NAVALERT=i.getLocaleString("bookmarks.instructions");var n=function(e){var t=$(e).parent().find("input[type=text]");t.val(t.hasClass("tc-url")?i.generateLink():i.generateIframe());t.select()};i._$div.on("click","h2",function(e){i._$div.find(".tc-url input[type=text]").val(i.generateLink());i._$div.find(".tc-iframe input[type=text]").val(i.generateIframe())});i._$div.on("click",".tc-ctl-share-url-box button",function(e){n(e.target);document.execCommand("copy");var t=$(this);t.text(i.getLocaleString("copied"));setTimeout(function(){t.text(i.getLocaleString("copy"));!function(){document.getSelection().removeAllRanges();document.getSelection().addRange(document.createRange())}()},1e3)});i._$div.on("click","input[type=text]",function(e){n(e.target)});i._$div.on("click",".ga-share-icon.disabled",function(e){e.stopImmediatePropagation();e.preventDefault();return!1});i._$div.on("click","a.share-email",function(e){e.preventDefault();var n=i.generateLink();if(n){const e=encodeURIComponent(n+"\n");e.length>i.MAILTO_MAX_LENGTH&&t.toast(i.getLocaleString("urlTooLongForMailto"),{type:TC.Consts.msgType.WARNING});window.location.href="mailto:?body="+e}});i._$div.on("click","a.qr-generator",function(e){e.preventDefault();var t=i.generateLink();t&&TC.loadJS(void 0===QRCode,[TC.apiLocation+"lib/qrcode/qrcode.min.js"],function(){t.length>i.QR_MAX_LENGTH&&(t=TC.Util.shortenUrl(t));if(void 0!==t){TC.Util.showModal(i._$dialogDiv.find(i._classSelector+"-qr-dialog"));var e=i._$dialogDiv.find(".qrcode");e.empty();new QRCode(e[0],t)}else TC.error(i.getLocaleString("urlTooLongForShortener"))})});i._$div.on("click","a.share-fb",function(e){e.preventDefault();var t=i.generateLink();if(t){var n=TC.Util.shortenUrl(t);void 0!==n?window.open("https://www.facebook.com/sharer/sharer.php?u="+encodeURIComponent(n)):TC.error(i.getLocaleString("urlTooLongForShortener"));return!1}});i._$div.on("click","a.share-twitter",function(e){e.preventDefault();var t=i.generateLink();if(t){var n=TC.Util.shortenUrl(t);if(void 0!==n){var r=encodeURIComponent(window.document.title?window.document.title:"Visor API SITNA");window.open("https://twitter.com/intent/tweet?text="+r+"&amp;url="+encodeURIComponent(n))}else TC.error(i.getLocaleString("urlTooLongForShortener"));return!1}});TC.Util.detectMobile()&&i._$div.on("click","a.share-whatsapp",function(e){e.preventDefault();var t=i.generateLink();if(t){var n=TC.Util.shortenUrl(t),r="whatsapp://send?text=";location.href=void 0!==n?r+encodeURIComponent(n):r+encodeURIComponent(t);return!1}});i._$div.on("click","a.share-star",function(t){t.preventDefault();var n=i.generateLink(),r=document.title;if(TC.Util.detectMobile())alert(e.MOBILEFAV);else if(window.sidebar&&window.sidebar.addPanel)window.sidebar.addPanel(r,n,"");else if(window.sidebar&&/Firefox/i.test(navigator.userAgent)||window.opera&&window.print){window.location.href=n;alert((/Mac/i.test(navigator.userAgent)?"Cmd":"Ctrl")+e.NAVALERT)}else if(window.external&&"AddFavorite"in window.external)window.external.AddFavorite(n,r);else{window.location.href=n;alert((/Mac/i.test(navigator.userAgent)?"Cmd":"Ctrl")+e.NAVALERT)}return!1});t.loaded(function(){const e=t.state&&t.state.ctl;e&&i.importControlStates(e)})};e.template={};if(TC.isDebug){e.template[e.CLASS]=TC.apiLocation+"TC/templates/Share.html";e.template[e.CLASS+"-dialog"]=TC.apiLocation+"TC/templates/ShareDialog.html"}else{e.template[e.CLASS]=function(){dust.register(e.CLASS,t);function t(e,t){return e.w("<h2>").h("i18n",t,{},{$key:"share"}).w(' <span class="tc-beta tc-hidden">').h("i18n",t,{},{$key:"beta"}).w('</span></h2><div><div class="ga-share-icons"><a class="ga-share-icon share-email" target="_blank" data-toggle="tooltip" data-placement="top" title="').h("i18n",t,{},{$key:"sendMapByEmail"}).w('"href="#"><i class="icon-envelope-alt"></i></a><a class="ga-share-icon qr-generator" target="_blank" data-toggle="tooltip" data-placement="top" title="').h("i18n",t,{},{$key:"createQrCode"}).w('"href="#"><i class="icon-qrcode"></i></a><a class="ga-share-icon share-fb" target="_blank" data-toggle="tooltip" data-placement="top" title="').h("i18n",t,{},{$key:"shareMapToFacebook"}).w('"href="#"><i class="icon-facebook"></i></a><a class="ga-share-icon share-twitter" target="_blank" data-toggle="tooltip" data-placement="top" title="').h("i18n",t,{},{$key:"shareMapToTwitter"}).w('"href="#"><i class="icon-twitter"></i></a><a class="ga-share-icon share-whatsapp" target="_blank" data-toggle="tooltip" data-placement="top" title="').h("i18n",t,{},{$key:"shareMapToWhatsapp"}).w('"href="#"><i class="icon-whatsapp"></i></a><a class="ga-share-icon share-star" target="_blank" data-toggle="tooltip" data-placement="top" title="').h("i18n",t,{},{$key:"addToBookmarks"}).w('"href="#"><i class="icon-star"></i></a></div><div class="tc-ctl-share-select"><form><label class="tc-ctl-share-btn-url"><input type="radio" checked="checked" name="format" value="url" /><span>').h("i18n",t,{},{$key:"shareLink"}).w('</span></label><label class="tc-ctl-share-btn-iframe"><input type="radio" name="format" value="iframe" /><span>').h("i18n",t,{},{$key:"embedMap"}).w('</span></label></form></div><div class="tc-ctl-share-url-box tc-group tc-url"><input type="text" class="tc-textbox tc-url" readonly data-toggle="tooltip" data-placement="top" title="').h("i18n",t,{},{$key:"shareLink.tip.1"}).w('" /><button class="tc-button hide" title="').h("i18n",t,{},{$key:"shareLink.tip.2"}).w('">').h("i18n",t,{},{$key:"copy"}).w('</button></div><div class="tc-ctl-share-url-box tc-group tc-iframe tc-hidden"><input type="text" class="tc-textbox tc-iframe" readonly data-toggle="tooltip" data-placement="top" title="').h("i18n",t,{},{$key:"embedMap.tip.1"}).w('" /><button class="tc-button hide" title="').h("i18n",t,{},{$key:"embedMap.tip.2"}).w('">').h("i18n",t,{},{$key:"copy"}).w('</button></div><div class="tc-ctl-share-alert tc-alert alert-warning tc-hidden"><p>').h("i18n",t,{},{$key:"tooManyLayersLoaded|s"}).w("</p> </div></div>")}t.__dustBody=!0;return t};e.template[e.CLASS+"-dialog"]=function(){dust.register(e.CLASS+"-dialog",t);function t(e,t){return e.w('<div class="tc-ctl-share-qr-dialog tc-modal"><div class="tc-modal-background tc-modal-close"></div><div class="tc-modal-window"><div class="tc-modal-header"><h3>').h("i18n",t,{},{$key:"qrCode"}).w('</h3><div class="tc-ctl-popup-close tc-modal-close"></div></div><div class="tc-modal-body"><div class="qrcode"></div></div><div class="tc-modal-footer"><button type="button" class="tc-button tc-modal-close">').h("i18n",t,{},{$key:"close"}).w("</button></div></div></div>")}t.__dustBody=!0;return t}}}();TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control");!function(){TC.Consts.url.GOOGLEMAPS="//maps.googleapis.com/maps/api/js?v=3";var e=TC.Consts.url.GOOGLEMAPS;TC.Cfg.proxyExceptions=TC.Cfg.proxyExceptions||[];TC.Cfg.proxyExceptions.push(TC.Consts.url.GOOGLEMAPS);TC.control.StreetView=function(){this._templatePromise=$.Deferred();this._sv=null;this._mapActiveControl=null;TC.Control.apply(this,arguments);this.options.googleMapsKey&&(e+="&key="+this.options.googleMapsKey);this.viewDiv=null;this._$viewDiv=null;this._startLonLat=null};TC.inherit(TC.control.StreetView,TC.Control);var t=TC.control.StreetView.prototype;t.CLASS="tc-ctl-sv";t.template={};if(TC.isDebug){t.template[t.CLASS]=TC.apiLocation+"TC/templates/StreetView.html";t.template[t.CLASS+"-view"]=TC.apiLocation+"TC/templates/StreetViewView.html"}else{t.template[t.CLASS]=function(){dust.register(t.CLASS,e);function e(e,t){return e.w('<div class="tc-ctl-sv-btn" title="').h("i18n",t,{},{$key:"sv.tip"}).w('"><div class="tc-ctl-sv-drag"></div></div>')}e.__dustBody=!0;return e};t.template[t.CLASS+"-view"]=function(){dust.register(t.CLASS+"-view",e);function e(e,t){return e.w('<div class="tc-ctl-sv-btn-close" title="').h("i18n",t,{},{$key:"closeStreetView"}).w('"></div>')}e.__dustBody=!0;return e}}var i=function(e){e.layer.clearFeatures();e._$div.find("."+e.CLASS+"-btn").removeClass(TC.Consts.classes.CHECKED);e._$div.find("."+e.CLASS+"-drag").removeClass(TC.Consts.classes.HIDDEN);$(e.map.div).removeClass(e.CLASS+"-active");e._startLonLat=null};t.register=function(e){var t=this;if(!t._$viewDiv){t.viewDiv=TC.Util.getDiv(t.options.viewDiv);t._$viewDiv=$(t.viewDiv).addClass(t.CLASS+"-view "+TC.Consts.classes.HIDDEN);t.options.viewDiv||t._$viewDiv.insertBefore(e.div)}TC.Control.prototype.register.call(t,e);t.layer=null;for(var n=t.getUID(),r=0;r<e.workLayers.length;r++){var s=e.workLayers[r];if(s.type===TC.Consts.layerType.VECTOR&&s.id===n){t.layer=s;break}}t.layer||e.loaded(function(){e.addLayer({id:n,stealth:!0,type:TC.Consts.layerType.VECTOR}).then(function(e){t.layer=e})});t._templatePromise.then(function(){TC.loadJS(!$.fn.drag,[TC.apiLocation+"lib/jquery/jquery.event.drag.js",TC.apiLocation+"lib/jquery/jquery.event.drop.js"],function(){var e=t._$div.find("."+t.CLASS+"-drag");e.drag(function(t,i){e.css({transform:"translate("+i.deltaX+"px, "+i.deltaY+"px)"})}).drag("start",function(e,i){!function(e){e._$div.find("."+e.CLASS+"-btn").addClass(TC.Consts.classes.CHECKED);$(e.map.div).addClass(e.CLASS+"-active")}(t);e.preventDefault();e.stopPropagation()}).drag("end",function(n,r){!function(e){var t=!1,n=e._$div.find("."+e.CLASS+"-btn"),r=e._$div.find("."+e.CLASS+"-drag"),s=n[0].getBoundingClientRect(),a=r[0].getBoundingClientRect();r.addClass(TC.Consts.classes.HIDDEN);if(a.top<s.top||a.top>s.bottom||a.left<s.left||a.left>s.right){t=!0;for(var o=e.map.getExtent(),l=[o[2],o[3]],c=(new Array(16),0);c<16;c++)e.layer.addMarker(l,{cssClass:"tc-marker-sv-"+c,width:48,height:48,anchor:[0,1]});var u=e.map.div.getBoundingClientRect(),h=(a.left+a.right)/2-u.left,p=a.bottom-u.top,d=e.map.wrap.getCoordinateFromPixel([h,p]);e.callback(d)}else i(e)}(t);e.css({transform:"none"})})});var e=t._$viewDiv;e.find("."+t.CLASS+"-btn-close").on("mouseup",function(n){$(t.map.div).removeClass(TC.Consts.classes.COLLAPSED).trigger("resize");e.addClass(TC.Consts.classes.HIDDEN).removeClass(TC.Consts.classes.VISIBLE);t._$div.find("."+t.CLASS+"-drag").removeClass(TC.Consts.classes.HIDDEN);t.layer.wrap.setDraggable(!1);i(t);t._sv.setVisible(!1);n.stopPropagation();var r=t._$div.parents("body").find("header");r.length>0&&r.css("display","");t._previousActiveControl&&t._previousActiveControl.activate()})},function(e,t,i){TC.error("Error de renderizado Streetview")})};t.render=function(){var e=this;TC.Control.prototype.render.call(e,function(){dust.cache[e.CLASS+"-view"]?dust.render(e.CLASS+"-view",null,function(t,i){setTimeout(function(){e._$viewDiv.html(i);t&&TC.error(t);e._templatePromise.resolve()},300)}):TC.error("No hay dust.cache para StreetView")})};var n=0;t.callback=function(t){var r=this,s=function(e){if(r._sv){var t=e.getBounds();lonLat=TC.Util.reproject([(t[0]+t[2])/2,(t[1]+t[3])/2],r.map.crs,"EPSG:4326");r._sv.setPosition({lng:lonLat[0],lat:lonLat[1]})}},a=function(e){if(r._sv){var t=e.getBounds();r._startLonLat=[(t[0]+t[2])/2,(t[1]+t[3])/2]}},o=r.map.getLoadingIndicator();o&&(n=o.addWait(n));var l=$(r.map.div),c=function(e,i){r.layer.clearFeatures();var n,o;if(e){var c=e.getPosition();n=TC.Util.reproject([c.lng(),c.lat()],"EPSG:4326",r.map.crs);o=e.getPov().heading}else{n=t;o=0}r.map.addMarker(n,{cssClass:"tc-marker-sv-"+(Math.round(16*o/360)+16)%16,width:48,height:48,anchor:[.4791666666666667,.7083333333333333],layer:r.layer,showsPopup:!1});$.when.apply(this,r.map._markerDeferreds).then(function(e){r.layer.wrap.setDraggable(!0,s,a)});if(i){var u=function(){r.map.setCenter(n)};l.hasClass(TC.Consts.classes.COLLAPSED)?u():setTimeout(u,1200)}};TC.loadJS(!window.google||!google.maps,e,function(){if(window.google){c();var e=r._$viewDiv,s=TC.Util.reproject(t,r.map.crs,"EPSG:4326"),a=e.hasClass(TC.Consts.classes.VISIBLE);e.off("transitionend.tc").on("transitionend.tc",function(e){if(("width"===e.originalEvent.propertyName||"height"===e.originalEvent.propertyName)&&!a){a=!0;google.maps.event.trigger(r._sv,"resize");l.addClass(TC.Consts.classes.COLLAPSED).trigger("resize")}});var u={position:new google.maps.LatLng(s[1],s[0]),pov:{heading:0,pitch:0},zoom:1,zoomControlOptions:{position:google.maps.ControlPosition.LEFT_TOP},panControlOptions:{position:google.maps.ControlPosition.LEFT_TOP}};if(r._sv)r._sv.setOptions(u);else{r._sv=new google.maps.StreetViewPanorama(e[0],u);google.maps.event.addListener(r._sv,"position_changed",function(){c(r._sv,e.hasClass(TC.Consts.classes.VISIBLE))});google.maps.event.addListener(r._sv,"pov_changed",function(){if(r.layer.features&&r.layer.features.length>0){var e=r.layer.features[0];delete e.options.url;e.options.cssClass="tc-marker-sv-"+(Math.round(16*r._sv.getPov().heading/360)+16)%16;e.setStyle(e.options);r.layer.refresh()}});google.maps.event.addListener(r._sv,"status_changed",function(){var t=r._sv.getStatus();o&&o.removeWait(n);if(t===google.maps.StreetViewStatus.OK){if(!e.hasClass(TC.Consts.classes.VISIBLE)){r._sv.setVisible(!0);c(r._sv,!0);if(r.map.activeControl){r._previousActiveControl=r.map.activeControl;r.map.activeControl.deactivate(!0)}setTimeout(function(){e.css("left","").css("top","");e.removeClass(TC.Consts.classes.HIDDEN).addClass(TC.Consts.classes.VISIBLE)},200);var s=r._$div.parents("body").find("header");s.length>0&&s.css("display","none")}}else{TC.alert(t===google.maps.StreetViewStatus.ZERO_RESULTS?r.getLocaleString("noStreetView"):r.getLocaleString("streetViewUnknownError"));if(r._startLonLat)r.callback(r._startLonLat);else{r.layer.wrap.setDraggable(!1);i(r)}}})}c(r._sv)}else i(r)})}}();TC.control=TC.control||{};TC.control.MapContents||TC.syncLoadJS(TC.apiLocation+"TC/Control");!function(){for(var e=0,t=["ms","moz","webkit","o"],i=!(!window.performance||!window.performance.now),n=0,r=t.length;n<r&&!window.requestAnimationFrame;n+=1){window.requestAnimationFrame=window[t[n]+"RequestAnimationFrame"];window.cancelAnimationFrame=window[t[n]+"CancelAnimationFrame"]||window[t[n]+"CancelRequestAnimationFrame"]}window.requestAnimationFrame||(window.requestAnimationFrame=function(t,i){var n=(new Date).getTime(),r=Math.max(0,16-(n-e)),s=window.setTimeout(function(){t(n+r)},r);e=n+r;return s});window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)});if(!i){var s=window.requestAnimationFrame,a=+new Date;window.requestAnimationFrame=function(e,t){s(function(t){return e(t<1e12?t:t-a)},t)}}}();!function(){TC.Consts.classes.THREED=TC.Consts.classes.THREED||"tc-threed";TC.Consts.classes.THREED_HIDDEN=TC.Consts.classes.THREED_HIDDEN||"tc-threed-hidden";TC.Consts.event.TERRAINLOADED=TC.Consts.event.TERRAINLOADED||"terrainloaded.tc.threed";TC.Consts.event.TERRAINRECEIVING=TC.Consts.event.TERRAINRECEIVING||"terrainreceiving.tc.threed";TC.Consts.event.TERRAIN404=TC.Consts.event.TERRAIN404||"terrain404.tc.threed";TC.control.ThreeD=function(){TC.Control.apply(this,arguments);this.$events=$(this);this._manageResultsPanel={};this.selectors={divThreedMap:this.options.divMap};this.Consts={BLANK_BASE:"blank",DEFAULT_TILE_SIZE:256,TERRAIN_URL:"https://pmpwvinet18.tcsa.local/customcesiumterrain/qm"};this.options.terrainURL&&(this.Consts.TERRAIN_URL=this.options.terrainURL);this.options.isDebug&&(TC.Consts.url.CESIUM=TC.apiLocation+"lib/cesium/debug/Cesium.js")};TC.inherit(TC.control.ThreeD,TC.Control);var e=TC.control.ThreeD.prototype;e.CLASS="tc-ctl-threed";e.classes={MAPTHREED:"tc-map-threed",LOADING:"tc-loading",BTNACTIVE:"active",CAMERACTRARROWDISABLED:"disabled-arrow",BETA:"tc-beta-button",FOCUS:"focus",HIGHLIGHTED:"highlighted",DISABLED:"disabled",OUTFOCUS:"outfocus",COORDSTHREEDMARKER:"tc-ctl-coords-threed"};e.direction={TO_TWO_D:"two_d",TO_THREE_D:"three_d"};e.allowedControls=["search","attribution","basemapSelector","workLayerManager","tabContainer","externalWMS","fileImport","layerCatalog","click","fullScreen","loadingIndicator","navBar","overviewMap","legend","fullScreen","threeD","coordinates","geolocation","resultsPanel","share"];e.template={};if(TC.isDebug){e.template[e.CLASS]=TC.apiLocation+"TC/templates/ThreeD.html";e.template[e.CLASS+"-overlay"]=TC.apiLocation+"TC/templates/ThreeDOverlay.html";e.template[e.CLASS+"-cm-ctls"]=TC.apiLocation+"TC/templates/ThreeDCameraControls.html"}else{e.template[e.CLASS+"-cm-ctls"]=function(){dust.register(e.CLASS+"-cm-ctls",t);function t(e,t){return e.w('<div><svg xmlns:dc="http://purl.org/dc/elements/1.1/"xmlns:cc="http://creativecommons.org/ns#"xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"xmlns:svg="http://www.w3.org/2000/svg"xmlns="http://www.w3.org/2000/svg"xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd"xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"width="220"height="135"viewBox="0 0 63.40233 35.531682"version="1.1"id="threedControls"><g inkscape:groupmode="layer"id="backgroundLayer"inkscape:label="backgroundLayer"transform="translate(-2.3693123,-42.387899)"><path style="fill:#ffffff;fill-opacity:0.23999999;stroke:none;stroke-width:0.2;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:4;stroke-dasharray:none;stroke-dashoffset:0;stroke-opacity:0.3169643;paint-order:stroke fill markers"d="M 48.005285,42.387899 A 17.766048,17.766048 0 0 0 34.067635,49.16888 17.754217,17.754217 0 0 0 20.123267,42.399784 17.754217,17.754217 0 0 0 2.3693123,60.153739 a 17.754217,17.754217 0 0 0 17.7539547,17.75447 17.754217,17.754217 0 0 0 13.923699,-6.76961 17.766048,17.766048 0 0 0 13.958319,6.78098 17.766048,17.766048 0 0 0 17.766357,-17.76584 17.766048,17.766048 0 0 0 -17.766357,-17.76584 z"id="background"inkscape:connector-curvature="0" /></g><g inkscape:label="tiltLayer"inkscape:groupmode="layer"id="tiltLayer"transform="translate(-26.69084,-42.254264)"style="display:inline"><g class="tc-ctl-threed-cm-tilt-indicator"><path class="tc-ctl-threed-cm-tilt-inner"id="tiltInner"d="m 44.44423,52.861576 c 3.959106,0 7.167321,3.203889 7.167321,7.168124 0,3.964234 -3.208215,7.174892 -7.167321,7.174892 -3.959106,0 -7.160559,-3.210658 -7.160559,-7.174892 0,-3.964235 3.201453,-7.168124 7.160559,-7.168124 z"inkscape:connector-curvature="0"><title>').h("i18n",t,{},{$key:"threed.tilt.reset"}).w('</title></path><path class="tc-ctl-threed-cm-tilt-inner-image"d="m 40.116095,64.124648 c -0.12075,-0.119221 -0.171366,-0.928328 -0.171366,-2.739326 0,-2.143319 0.03709,-2.606753 0.223349,-2.79065 0.19727,-0.194769 0.269957,-0.196719 0.622509,-0.01671 0.219537,0.112088 0.761654,0.542242 1.204705,0.955894 l 0.805547,0.752098 v 0.939855 c 0,0.51692 -0.06955,1.085596 -0.154558,1.263727 -0.173436,0.363428 -1.919571,1.804317 -2.186551,1.804317 -0.09475,0 -0.249383,-0.07614 -0.343635,-0.169192 z m 3.287741,-0.05029 c -0.307698,-0.212789 -0.317387,-0.295835 -0.317387,-2.721198 0,-1.757783 0.05096,-2.552024 0.171366,-2.670904 0.120776,-0.119243 0.941399,-0.169194 2.779684,-0.169194 2.432612,0 2.618273,0.01838 2.756146,0.27272 0.08484,0.156511 0.147831,1.267987 0.147831,2.608402 0,3.088986 0.189068,2.899662 -2.895738,2.899662 -1.872744,0 -2.3862,-0.04266 -2.641902,-0.219488 z m 0.586357,-6.180807 c -0.314529,-0.267117 -0.397432,-0.458143 -0.397432,-0.915756 0,-0.785501 0.427643,-1.207722 1.223233,-1.207722 1.162181,0 1.675866,1.23538 0.851939,2.048861 -0.522115,0.515494 -1.126934,0.542392 -1.67774,0.07462 z m 2.780604,-0.09201 c -0.374474,-0.369724 -0.423284,-0.501051 -0.3506,-0.943285 0.118405,-0.72038 0.53618,-1.088187 1.236028,-1.088187 0.699848,0 1.117624,0.367807 1.236028,1.088187 0.07269,0.442234 0.02388,0.573561 -0.3506,0.943285 -0.300932,0.297119 -0.573881,0.429526 -0.885428,0.429526 -0.311544,0 -0.584496,-0.132407 -0.885428,-0.429526 z"id="tiltImage"inkscape:connector-curvature="0"><title>').h("i18n",t,{},{$key:"threed.tilt.reset"}).w('</title></path><path class="tc-ctl-threed-cm-tilt-outer tc-ctl-threed-cm-tilt-outer-circle"id="tiltOuter"d="m 44.44423,48.705554 c -6.246102,0 -11.312196,5.070128 -11.312196,11.324146 0,6.254017 5.066094,11.330914 11.312196,11.330914 6.246102,0 11.312196,-5.076897 11.312196,-11.330914 0,-6.254018 -5.066094,-11.324146 -11.312196,-11.324146 z m 0,4.156022 c 3.959106,0 7.167321,3.203889 7.167321,7.168124 0,3.964234 -3.208215,7.174892 -7.167321,7.174892 -3.959106,0 -7.160559,-3.210658 -7.160559,-7.174892 0,-3.964235 3.201453,-7.168124 7.160559,-7.168124 z"inkscape:connector-curvature="0"><title>').h("i18n",t,{},{$key:"threed.tilt.drag"}).w('</title></path><path class="tc-ctl-threed-cm-tilt-outer tc-ctl-threed-cm-tilt-outer-shell-circle"sodipodi:nodetypes="ssssssccccsccccssccsssccscccccccsccssscsssssccccccccccccccc"inkscape:connector-curvature="0"id="tiltShell"d="m 44.44423,48.705554 c -6.246102,0 -11.312196,5.070128 -11.312196,11.324146 0,6.254017 5.066094,11.330914 11.312196,11.330914 6.246102,0 11.312196,-5.076897 11.312196,-11.330914 0,-6.254018 -5.066094,-11.324146 -11.312196,-11.324146 z m 0,0.379051 c 2.995132,0 5.705501,1.203885 7.681205,3.154245 l -2.386853,2.382605 0.135232,0.135376 2.386853,-2.382606 c 1.930016,1.972963 3.12387,4.674054 3.12387,7.655475 0,2.981421 -1.193854,5.680844 -3.12387,7.655474 l -2.386853,-2.382605 -0.135232,0.135375 2.386853,2.382606 c -1.975664,1.951759 -4.686314,3.161013 -7.681205,3.161013 -1.94179,0 -3.766282,-0.506879 -5.347316,-1.395323 -0.850442,-0.477894 -1.630441,-1.06619 -2.320365,-1.745384 l 2.407138,-2.402912 c 1.358381,1.325983 3.214811,2.145699 5.260543,2.145699 4.163407,0 7.545972,-3.385283 7.545972,-7.553943 0,-4.168661 -3.382565,-7.547175 -7.545972,-7.547175 -2.045732,0 -3.902162,0.81461 -5.260543,2.13893 l -2.407138,-2.402912 c 1.972594,-1.940536 4.681097,-3.133938 7.667681,-3.133938 z m -0.189325,0.182756 v 3.01887 h 0.378651 v -3.01887 z m -7.606826,3.086558 2.400376,2.402912 C 37.721509,56.11715 36.90502,57.97796 36.90502,60.0297 c 0,2.05174 0.816489,3.910884 2.143435,5.272869 l -2.400376,2.402912 c -0.435151,-0.44326 -0.832923,-0.923297 -1.188195,-1.435068 -0.462681,-0.666492 -0.853281,-1.386809 -1.160484,-2.149815 -0.508689,-1.263436 -0.788715,-2.64392 -0.788715,-4.090898 0,-2.99182 1.197141,-5.70104 3.137394,-7.675781 z m 7.796151,0.507657 c 3.959106,0 7.167321,3.203889 7.167321,7.168124 0,3.964234 -3.208215,7.174892 -7.167321,7.174892 -3.959106,0 -7.160559,-3.210658 -7.160559,-7.174892 0,-3.964235 3.201453,-7.168124 7.160559,-7.168124 z m -10.744219,6.978598 v 0.379051 h 3.022445 v -0.379051 z m 18.513325,0 v 0.379051 h 3.029207 v -0.379051 z m -7.931385,7.932994 v 3.01887 h 0.37189 v -3.01887 z"><title>').h("i18n",t,{},{$key:"threed.tilt.drag"}).w('</title></path></g></g><g id="rotateLayer"inkscape:groupmode="layer"inkscape:label="rotateLayer"style="display:inline"transform="translate(-2.3693123,-42.387899)"><path class="tc-ctl-threed-cm-rotate-right"sodipodi:nodetypes="cccccccc"inkscape:connector-curvature="0"id="right"d="m 53.241331,72.907368 0.900176,1.930847 c 3.602027,-1.827343 6.291427,-4.493353 8.092762,-8.066897 l 0.969844,0.452626 -0.663464,-4.788009 -3.222445,2.974451 0.983506,0.459005 c -1.447339,3.107391 -3.949649,5.598011 -7.060379,7.037977 z"><title>').h("i18n",t,{},{$key:"threed.rotate.right"}).w('</title></path><path class="tc-ctl-threed-cm-rotate-left"sodipodi:nodetypes="cccccccc"inkscape:connector-curvature="0"id="left"d="m 42.795431,72.906221 -0.900176,1.930846 c -3.602027,-1.827342 -6.291427,-4.493352 -8.092762,-8.066896 l -0.969844,0.452626 0.663465,-4.788009 3.222444,2.974451 -0.983506,0.459005 c 1.44734,3.107391 3.949649,5.598011 7.060379,7.037977 z"><title>').h("i18n",t,{},{$key:"threed.rotate.left"}).w('</title></path><path class="tc-ctl-threed-cm-tilt-up"sodipodi:nodetypes="cccccccc"inkscape:connector-curvature="0"id="up"d="M 7.737296,54.610066 5.80645,53.70989 c 1.827342,-3.602027 4.493352,-6.291427 8.066896,-8.092762 l -0.452626,-0.969844 4.788009,0.663465 -2.974451,3.222444 -0.459005,-0.983506 c -3.107391,1.44734 -5.598011,3.949649 -7.037977,7.060379 z"><title>').h("i18n",t,{},{$key:"threed.tilt.left"}).w('</title></path><path class="tc-ctl-threed-cm-tilt-down"sodipodi:nodetypes="cccccccc"inkscape:connector-curvature="0"id="down"d="m 7.684579,65.708846 -1.930847,0.900176 c 1.827343,3.602027 4.493353,6.291427 8.066897,8.092762 l -0.452626,0.969844 4.788009,-0.663464 -2.974451,-3.222445 -0.459005,0.983506 C 11.615165,71.321886 9.124545,68.819576 7.684579,65.708846 Z"><title>').h("i18n",t,{},{$key:"threed.tilt.right"}).w('</title></path><g class="tc-ctl-threed-cm-rotate-indicator"><path class="tc-ctl-threed-cm-rotate-inner"inkscape:connector-curvature="0"d="m 48.010487,52.995444 c 3.959106,0 7.167321,3.203889 7.167321,7.168124 0,3.964234 -3.208215,7.174892 -7.167321,7.174892 -3.959106,0 -7.160559,-3.210658 -7.160559,-7.174892 0,-3.964235 3.201453,-7.168124 7.160559,-7.168124 z"id="rotateInner"><title>').h("i18n",t,{},{$key:"threed.rotate.reset"}).w('</title></path><path class="tc-ctl-threed-cm-rotate-inner-image"d="m 45.461645,60.604061 c 0.860585,-1.857231 1.777009,-3.864779 2.036499,-4.461218 0.471802,-1.084433 0.471802,-1.084433 0.66474,-0.667935 2.070474,4.46957 3.86201,8.443545 3.825603,8.485934 -0.02561,0.02982 -0.943964,-0.165127 -2.040793,-0.433206 -1.994234,-0.487419 -1.994234,-0.487419 -3.881098,-0.01711 -1.037775,0.258673 -1.950491,0.470314 -2.028258,0.470314 -0.07777,0 0.562721,-1.519553 1.423307,-3.376784 z m 1.23418,2.027617 c 1.353421,-0.310159 1.353421,-0.310159 1.353421,-2.998288 0,-1.534227 -0.05572,-2.627602 -0.129797,-2.547123 -0.101525,0.110295 -2.316061,4.831583 -2.659547,5.670031 -0.09645,0.23543 -0.15884,0.240844 1.435923,-0.12462 z"id="rotateImage"inkscape:connector-curvature="0"><title>').h("i18n",t,{},{$key:"threed.rotate.reset"}).w('</title></path><path class="tc-ctl-threed-cm-rotate-outer tc-ctl-threed-cm-rotate-outer-circle"inkscape:connector-curvature="0"d="m 48.010487,48.839422 c -6.246102,0 -11.312196,5.070128 -11.312196,11.324146 0,6.254017 5.066094,11.330914 11.312196,11.330914 6.246102,0 11.312196,-5.076897 11.312196,-11.330914 0,-6.254018 -5.066094,-11.324146 -11.312196,-11.324146 z m 0,4.156022 c 3.959106,0 7.167321,3.203889 7.167321,7.168124 0,3.964234 -3.208215,7.174892 -7.167321,7.174892 -3.959106,0 -7.160559,-3.210658 -7.160559,-7.174892 0,-3.964235 3.201453,-7.168124 7.160559,-7.168124 z"id="rotateOuter"><title>').h("i18n",t,{},{$key:"threed.rotate.drag"}).w('</title></path><path class="tc-ctl-threed-cm-rotate-outer tc-ctl-threed-cm-rotate-outer-shell-circle"d="m 48.010487,48.839422 c -6.246102,0 -11.312196,5.070128 -11.312196,11.324146 0,6.254017 5.066094,11.330914 11.312196,11.330914 6.246102,0 11.312196,-5.076897 11.312196,-11.330914 0,-6.254018 -5.066094,-11.324146 -11.312196,-11.324146 z m 0,0.379051 c 2.995132,0 5.705501,1.203885 7.681205,3.154245 l -2.386853,2.382605 0.135232,0.135376 2.386853,-2.382606 c 1.930016,1.972963 3.12387,4.674054 3.12387,7.655475 0,2.981421 -1.193854,5.680844 -3.12387,7.655474 l -2.386853,-2.382605 -0.135232,0.135375 2.386853,2.382606 c -1.975664,1.951759 -4.686314,3.161013 -7.681205,3.161013 -1.94179,0 -3.766282,-0.506879 -5.347316,-1.395323 -0.850442,-0.477894 -1.630441,-1.06619 -2.320365,-1.745384 l 2.407138,-2.402912 c 1.358381,1.325983 3.214811,2.145699 5.260543,2.145699 4.163407,0 7.545972,-3.385283 7.545972,-7.553943 0,-4.168661 -3.382565,-7.547175 -7.545972,-7.547175 -2.045732,0 -3.902162,0.81461 -5.260543,2.13893 l -2.407138,-2.402912 c 1.972594,-1.940536 4.681097,-3.133938 7.667681,-3.133938 z m -0.189325,0.182756 v 3.01887 h 0.378651 v -3.01887 z m -7.606826,3.086558 2.400376,2.402912 c -1.326946,1.360319 -2.143435,3.221129 -2.143435,5.272869 0,2.05174 0.816489,3.910884 2.143435,5.272869 l -2.400376,2.402912 c -0.435151,-0.44326 -0.832923,-0.923297 -1.188195,-1.435068 -0.462681,-0.666492 -0.853281,-1.386809 -1.160484,-2.149815 -0.508689,-1.263436 -0.788715,-2.64392 -0.788715,-4.090898 0,-2.99182 1.197141,-5.70104 3.137394,-7.675781 z m 7.796151,0.507657 c 3.959106,0 7.167321,3.203889 7.167321,7.168124 0,3.964234 -3.208215,7.174892 -7.167321,7.174892 -3.959106,0 -7.160559,-3.210658 -7.160559,-7.174892 0,-3.964235 3.201453,-7.168124 7.160559,-7.168124 z m -10.744219,6.978598 v 0.379051 h 3.022445 v -0.379051 z m 18.513325,0 v 0.379051 H 58.8088 v -0.379051 z m -7.931385,7.932994 v 3.01887 h 0.37189 v -3.01887 z"id="rotateShell"inkscape:connector-curvature="0"sodipodi:nodetypes="ssssssccccsccccssccsssccscccccccsccssscsssssccccccccccccccc"><title>').h("i18n",t,{},{$key:"threed.rotate.drag"}).w("</title></path></g></g></svg></div>")}t.__dustBody=!0;return t};e.template[e.CLASS+"-overlay"]=function(){dust.register(e.CLASS+"-overlay",t);function t(e,t){return e.w('<div class="tc-ctl-threed-overlay" hidden><svg class="tc-ctl-threed-overlay-svg"><defs><filter id="fGaussian" x="0" y="0"><feGaussianBlur in="SourceGraphic" stdDeviation="3" /></filter></defs><rect width="100%" height="100%" fill="white" fill-opacity="0.5" filter="url(#fGaussian)" /> </svg> </div>')}t.__dustBody=!0;return t};e.template[e.CLASS]=function(){dust.register(e.CLASS,t);function t(e,t){return e.w('<button class="tc-ctl-threed-btn tc-beta-button" title="').h("i18n",t,{},{$key:"threed.tip"}).w('"></button>')}t.__dustBody=!0;return t}}e.viewer;e.mapView;e.terrainProvider;e.register=function(e){var t=this;TC.Control.prototype.register.call(t,e);t.mapView=new i(e,t);e.on(TC.Consts.event.PROJECTIONCHANGE,function(e){t.mapView.metersPerUnit=t.map.getMetersPerUnit()})};var t=function(e,t){var i=this;i.waiting||(i.waiting=i.map.getLoadingIndicator().addWait());for(var n=[],r=0,s=i.allowedControls.length;r<s;r++){var a=i.allowedControls[r];a=a.substr(0,1).toUpperCase()+a.substr(1);n=n.concat(i.map.getControlsByClass("TC.control."+a))}i.ctrlsToMng=n;if(i.mapIs3D){i.deactivate();i.map3D.cameraControls.resetRotation({duration:1e3}).then(function(){var e=h(i.viewer.scene),t=Cesium.Matrix4.fromTranslation(e),n=f(i.viewer.scene,e);i.map3D.rotateAroundAxis(i.viewer.scene.camera,-n,i.viewer.scene.camera.right,t,{duration:1500,callback:function(){i.mapIs3D=!1;i.map._$div.removeClass(TC.Consts.classes.THREED);i.$button.attr("title",i.getLocaleString("threed.tip"));i.map3D.destroy.call(i);i.map3D.setViewFromCameraView.call(i).then(function(){i.$divThreedMap.removeClass(i.classes.MAPTHREED);i.$divThreedMap.removeClass("tc-ctl-threed-divMap-fadeIn").addClass("tc-ctl-threed-divMap-fadeOut");$(i.mapView.viewHTML).removeClass("tc-ctl-threed-divMap-fadeOut").addClass("tc-ctl-threed-divMap-fadeIn");i.viewer.destroy();i.viewer=null;i.$button.removeAttr("disabled");i.$button.toggleClass(i.classes.BTNACTIVE);i.map.getLoadingIndicator().removeWait(i.waiting);delete i.waiting});i.mapView.setRotation(0);i._ovMap.wrap.draw3DCamera(null)}})});i.map.activeControl=i.map.previousActiveControl;i.map.activeControl.activate();i.map.previousActiveControl=i}else{i.activate();if(i.browserSupportWebGL.call(i)||!i.browserSupportWebGL.call(i)){i.mapIs3D=!0;i.overlay.removeAttr("hidden");i.overlay.appendTo(i.map._$div.parent());i.map._$div.addClass(TC.Consts.classes.THREED);i.$divThreedMap=$("#"+i.selectors.divThreedMap);i.$divThreedMap.addClass(i.classes.MAPTHREED);i.$divThreedMap.addClass(i.classes.LOADING);i.$button.attr("title",i.getLocaleString("threed.two.tip"));i.$button.removeClass(i.classes.BETA);i.map3D.loadViewer.call(i).then(function(){i.$divThreedMap.removeClass("tc-ctl-threed-divMap-fadeOut").addClass("tc-ctl-threed-divMap-fadeIn");$(i.mapView.viewHTML).removeClass("tc-ctl-threed-divMap-fadeIn").addClass("tc-ctl-threed-divMap-fadeOut");i.$divThreedMap.removeClass(i.classes.LOADING);i.$button.toggleClass(i.classes.BTNACTIVE);i.map3D.setCameraFromMapView.call(i);i.map3D.setBaseLayer.call(i,i.map.baseLayer);i.map.workLayers.filter(function(e){return e.type===TC.Consts.layerType.WMTS||e.type===TC.Consts.layerType.WMS}).reverse().forEach(function(e){i.map3D.addLayer.call(i,e)});$.when(i.viewer.readyPromise).then(function(){i.map3D.cameraControls?i.map3D.cameraControls.render.call(i.map3D.cameraControls):i.map3D.cameraControls=new m(i);if(t){i.map3D.cameraControls.getCamera().flyTo({destination:Cesium.Cartesian3.fromRadians(t.cp[0],t.cp[1],t.cp[2]),orientation:{heading:t.chpr[0],pitch:t.chpr[1],roll:t.chpr[2]},complete:function(){i.$button.removeAttr("disabled");i.overlay.attr("hidden","hidden");i.map.getLoadingIndicator().removeWait(i.waiting);delete i.waiting}})}else if(e){var n=Cesium.Math.toRadians(50),r=h(i.viewer.scene);r=Cesium.Matrix4.fromTranslation(r);i.map3D.rotateAroundAxis(i.viewer.scene.camera,-n,i.viewer.scene.camera.right,r,{duration:2e3,callback:function(){Cesium.Camera.DEFAULT_VIEW_RECTANGLE=i.map3D.initialRectangle=i.viewer.camera.computeViewRectangle();Cesium.Camera.DEFAULT_VIEW_FACTOR=0;i.$button.removeAttr("disabled");i.overlay.attr("hidden","hidden");i.map.getLoadingIndicator().removeWait(i.waiting);delete i.waiting}})}else{i.$button.removeAttr("disabled");i.overlay.attr("hidden","hidden");i.map.getLoadingIndicator().removeWait(i.waiting);delete i.waiting}i.$events.on(TC.Consts.event.TERRAINLOADED,function(){if(i.viewer.billboardCollection){for(var e=0;e<i.viewer.billboardCollection.length;e++){var t=Cesium.Ellipsoid.WGS84.cartesianToCartographic(i.viewer.billboardCollection.get(e).position),n=i.viewer.scene.globe.getHeight(t),r={longitude:t.longitude,latitude:t.latitude,height:t.height+n};i.viewer.billboardCollection.get(e).position=Cesium.Ellipsoid.WGS84.cartographicToCartesian(r)}i.viewer.scene.requestRender()}})}.bind(i))})}}};e.renderData=function(e,i){var n=this;TC.Control.prototype.renderData.call(n,e,function(){n.getRenderedHtml(n.CLASS+"-overlay",{},function(e){n.overlay=$(e)});n.$button=n._$div.find("."+n.CLASS+"-btn");n.$button.on(TC.Consts.event.CLICK,function(){n.$button.attr("disabled","disabled");t.call(n,!0)})});$.isFunction(i)&&i()};e.activate=function(){if(TC.Util.detectIE()){var e=document.createEvent("UIEvents");e.initUIEvent("resize",!0,!1,window,0);window.dispatchEvent(e)}else window.dispatchEvent(new Event("resize"));TC.Control.prototype.activate.call(this)};e.deactivate=function(){window.dispatchEvent(new Event("resize"));TC.Control.prototype.deactivate.call(this)};e.setMapState=function(e){this.map.toast(this.getLocaleString("threed.apply3DState"),{type:TC.Consts.msgType.INFO});t.call(this,!1,e)};var i=function(e,t){var i=this;i.map=e;i.parent=t;$.when(i.map.getViewHTML()).then(function(e){i.viewHTML=e}.bind(i));i.metersPerUnit=e.getMetersPerUnit();i.maxResolution;i._oldMapSetCenter=e.setCenter;e.setCenter=function(n,r){t.mapIs3D?t.map3D.flyToMapCoordinates.call(t,n):i._oldMapSetCenter.call(e,n,r)}};i.prototype.getCenter=function(){return this.map.getCenter()};i.prototype.getExtent=function(){return this.map.getExtent()};i.prototype.getResolution=function(){return this.map.getResolution()};i.prototype.getRotation=function(){return this.map.getRotation()};i.prototype.getMaxResolution=function(){if(this.maxResolution)return this.maxResolution;if(null!==this.map.getResolutions())this.maxResolution=this.map.getResolutions()[0];else{var e=this.map.options.baselayerExtent;this.maxResolution=(e[2]-e[0])/this.parent.Consts.DEFAULT_TILE_SIZE}return this.maxResolution};i.prototype.getPixelFromCoordinate=function(e){return this.map.getPixelFromCoordinate(e)};i.prototype.setCenter=function(e){this._oldMapSetCenter.call(this.map,e)};i.prototype.setExtent=function(e){this.map.setExtent(e)};i.prototype.setResolution=function(e){this.map.setResolution(e)};i.prototype.setRotation=function(e){this.map.setRotation(e)};var n=function(e,t){return e.type===TC.Consts.layerType.WMTS?e.wrap.getCompatibleMatrixSets(t).length>0:e.isCompatible(t)},r=function(e,t){var i=t[0]-e[0],n=t[1]-e[1];return i*i+n*n},s=function(e){if((e=e||{}).nearMapCoords){var t=e.bottomPixel.clone();t.y=Math.round(9*t.y/10);var i=a.call(this,t);if(i){var n=[e.nearMapCoords,i].sort(function(t,i){return r(e.cameraPosition,t)-r(e.cameraPosition,i)});return function(e,t){var i=t[0]-e[0],n=t[1]-e[1],r=Math.atan(n/i);i<0&&(r+=Math.PI);return[e[0]+1e6*Math.cos(r),e[1]+1e6*Math.sin(r)]}.apply(this,n)}}return null},a=function(e){var t=c(this.viewer.scene,e);if(t){t=Cesium.Cartographic.fromCartesian(t);return TC.Util.reproject([Cesium.Math.toDegrees(t.longitude),Cesium.Math.toDegrees(t.latitude)],this.map3D.crs,this.map.crs)}return null},o=function(e,t){var i=this.viewer.scene.canvas,n=this.viewer.camera.frustum.fovy,r=2*e*Math.tan(n/2),s=Math.cos(Math.abs(t)),a=r/this.mapView.metersPerUnit/s/i.clientHeight,o=this.map.getResolutions();if(null==o)for(var l=0,c=(o=new Array(22)).length;l<c;++l)o[l]=this.mapView.getMaxResolution()/Math.pow(2,l);for(l=0;l<o.length;l++){if(o[l]<Math.abs(a)){a=o[l-1];break}if(o[l]===Math.abs(a)){a=o[l];break}l===o.length-1&&(a=o[l])}return a},l=function(e,t,i,n,r){var s,a=Cesium.Math.clamp,o=Cesium.defaultValue,l=r||{},c=o(l.duration,500),u=o(l.easing,function(e){return e}),h=l.callback,p=0,d=new Cesium.Matrix4,f=new $.Deferred;requestAnimationFrame(function r(o){s||(s=o);var l=u(a((o-s)/c,0,1));e.transform.clone(d);var m=(l-p)*t;p=l;e.lookAtTransform(n);e.rotate(i,m);e.lookAtTransform(d);if(l<1)requestAnimationFrame(r);else{h&&h();f.resolve()}});return f},c=function(e,t){var i=e.camera.getPickRay(t);return e.globe.pick(i,e)||e.camera.pickEllipsoid(t)},u=function(e){var t=e.canvas,i=new Cesium.Cartesian2(t.clientWidth/2,t.clientHeight/2);return c(e,i)},h=function(e){var t=e.canvas,i=new Cesium.Cartesian2(t.clientWidth/2,t.clientHeight);return c(e,i)},p=function(e,t,i,n){var r=e.camera,s=f(e,i),a=r.right,o=Cesium.Quaternion.fromAxisAngle(a,s),c=Cesium.Matrix3.fromQuaternion(o),u=new Cesium.Cartesian3;Cesium.Cartesian3.subtract(r.position,i,u);var h=new Cesium.Cartesian3;Cesium.Matrix3.multiplyByVector(c,u,h);Cesium.Cartesian3.add(h,i,h);var p=Cesium.Matrix4.fromTranslation(h);l(r,t,h,p,n)},d=function(e,t,i){var n=new Cesium.Cartesian3,r=new Cesium.Cartesian3,s=new Cesium.Cartesian3;Cesium.Cartesian3.normalize(e,n);Cesium.Cartesian3.normalize(t,r);Cesium.Cartesian3.cross(n,r,s);var a=Cesium.Cartesian3.dot(n,r),o=Cesium.Cartesian3.magnitude(s),l=Cesium.Cartesian3.dot(i,s),c=Math.atan2(o,a);return l>=0?c:-c},f=function(e,t){var i=e.camera,n=i.frustum.fovy/2,r=function(e){var t=e.camera,i=t.frustum.fovy/2,n=t.direction,r=Cesium.Quaternion.fromAxisAngle(t.right,i),s=Cesium.Matrix3.fromQuaternion(r),a=new Cesium.Cartesian3;Cesium.Matrix3.multiplyByVector(s,n,a);return new Cesium.Ray(t.position,a)}(e),s=Cesium.Cartesian3.clone(r.direction);Cesium.Cartesian3.negate(s,s);var a=new Cesium.Cartesian3;Cesium.Ellipsoid.WGS84.geocentricSurfaceNormal(t,a);var o=new Cesium.Cartesian3;Cesium.Cartesian3.negate(i.right,o);return d(a,s,o)+n},m=function(e){this.parent=e;var t=function(e,t){var i=$(e)[0].getBBox();value="rotate("+Cesium.Math.toDegrees(t)+" "+(i.x+i.width/2)+" "+(i.y+i.height/2)+")";document.getElementsByClassName(e[0].className.baseVal)[0].setAttribute("transform",value)};this.outControlsEvents=TC.Util.detectMouse()?"mouseleave":"touchleave, touchend";this.outControls=function(e){this.isFocusingCameraCtrls=!1}.bind(this);this.inControlsEvents=TC.Util.detectMouse()?"mouseenter":"touchmove, touchstart";this.inControls=function(){this.isFocusingCameraCtrls=!0;this.lastFocused=performance.now();if(this.$div.hasClass(this.parent.classes.OUTFOCUS)){this.$div.removeClass(this.parent.classes.OUTFOCUS);this.$tiltIndicatorOuterCircle.attr("class",this.$tiltIndicatorOuterCircle.attr("class").replace(this.parent.classes.OUTFOCUS,""));this.$tiltIndicatorOuterShellCircle.attr("class",this.$tiltIndicatorOuterShellCircle.attr("class").replace(this.parent.classes.OUTFOCUS,""));this.$rotateIndicatorOuterCircle.attr("class",this.$rotateIndicatorOuterCircle.attr("class").replace(this.parent.classes.OUTFOCUS,""));this.$rotateIndicatorOuterShellCircle.attr("class",this.$rotateIndicatorOuterShellCircle.attr("class").replace(this.parent.classes.OUTFOCUS,""))}}.bind(this);this.moveStart=function(){this.moving=!0}.bind(this);this.moveEnd=function(){this.moving=!1}.bind(this);this.postRender=function(){var e=this.parent;this.parent.map3D.isLoadingTiles.call(this.parent)&&this.customCollisionDetection();var i=this.getCamera(),n=i.positionCartographic;if(this.moving){t(this.$tiltIndicator,i.pitch);t(this.$rotateIndicator,-i.heading);this.disableRotate();this.disableTilt(5);this._coordsXY=TC.Util.reproject([Cesium.Math.toDegrees(n.longitude),Cesium.Math.toDegrees(n.latitude)],e.map3D.crs,e.map.crs);e.mapView.setCenter(this._coordsXY);e.mapView.setResolution(o.call(e,n.height,n.latitude))}if(this._coordsXY){e._ovMap=e._ovMap||e.map.getControlsByClass("TC.control.OverviewMap")[0];if(e._ovMap){var r=e.viewer.scene.canvas,l=new Cesium.Cartesian2(0,r.clientHeight-1),c=new Cesium.Cartesian2(r.clientWidth-1,r.clientHeight-1),u=[l,c,new Cesium.Cartesian2(r.clientWidth-1,0),new Cesium.Cartesian2(0,0)].map(function(t){return a.call(e,t)}).filter(function(e){return null!==e});if(u.length&&u.length<4){var h=s.call(e,{nearMapCoords:u[0],bottomPixel:l,cameraPosition:this._coordsXY}),p=s.call(e,{nearMapCoords:u[1],bottomPixel:c,cameraPosition:this._coordsXY});if(h&&p){u[2]=p;u[3]=h}}e._ovMap.wrap.draw3DCamera({position:this._coordsXY,heading:i.heading,fov:u})}}}.bind(this);this.selectors={tilt:"-cm-tilt",rotate:"-cm-rotate",indicator:"-indicator",leftArrow:"-left",rightArrow:"-right",downArrow:"-down",upArrow:"-up"};this.MIN_TILT=Cesium.Math.toRadians(-89);this.MAX_TILT=Cesium.Math.toRadians(-1);this.render()};m.prototype.bind=function(){var e=this;e.getCamera().moveStart.addEventListener(e.moveStart);e.getCamera().moveEnd.addEventListener(e.moveEnd);e.parent.viewer.scene.postRender.addEventListener(e.postRender);e.$div.on(e.outControlsEvents,e.outControls);e.$div.on(e.inControlsEvents,e.inControls);e.rAFInOutControls=requestAnimationFrame(function t(){e.lastFocused||(e.lastFocused=performance.now());if(performance.now()-e.lastFocused>5e3&&!0!==e.isFocusingCameraCtrls&&!e.$div.hasClass(e.parent.classes.OUTFOCUS)){e.$div.addClass(e.parent.classes.OUTFOCUS);e.$tiltIndicatorOuterCircle.attr("class",e.$tiltIndicatorOuterCircle.attr("class")+" "+e.parent.classes.OUTFOCUS);e.$tiltIndicatorOuterShellCircle.attr("class",e.$tiltIndicatorOuterShellCircle.attr("class")+" "+e.parent.classes.OUTFOCUS);e.$rotateIndicatorOuterCircle.attr("class",e.$rotateIndicatorOuterCircle.attr("class")+" "+e.parent.classes.OUTFOCUS);e.$rotateIndicatorOuterShellCircle.attr("class",e.$rotateIndicatorOuterShellCircle.attr("class")+" "+e.parent.classes.OUTFOCUS)}e.rAFInOutControls=requestAnimationFrame(t)})};m.prototype.unbind=function(){this.$div.addClass(TC.Consts.classes.HIDDEN);this.getCamera().moveStart.removeEventListener(this.moveStart);this.getCamera().moveEnd.removeEventListener(this.moveEnd);this.parent.viewer.scene.postRender.removeEventListener(this.postRender);this.$div.off(this.outControlsEvents,this.outControls);this.$div.off(this.inControlsEvents,this.inControls);window.cancelAnimationFrame(this.rAFInOutControls);this.lastFocused=void 0;this.rAFInOutControls=void 0};m.prototype.getCamera=function(){return this.parent.viewer.scene.camera};m.prototype.getCameraState=function(){if(this.parent.viewer){var e=this.parent.viewer.scene.camera,t=e.positionCartographic,i=h(this.parent.viewer.scene),n=Cesium.Cartesian3.distance(e.position,i);return{cp:[t.longitude,t.latitude,t.height],chpr:[e.heading,e.pitch,e.roll],bcpd:n}}};m.prototype.render=function(){var e=this;if(e.$div){e.$div.removeClass(TC.Consts.classes.HIDDEN);e.bind()}else e.parent.getRenderedHtml(e.parent.CLASS+"-cm-ctls",{},function(t){e.$div=$('<div class="'+e.parent.CLASS+'-cm-ctls"></div>');e.$div.appendTo(e.parent.map._$div);$(t).appendTo(e.$div);var i="."+e.parent.CLASS+e.selectors.tilt;e.$tiltIndicatorInner=e.$div.find("[class^="+i.replace(".","")+"-inner]");e.$tiltIndicatorInner.on(TC.Consts.event.CLICK,e.resetTilt.bind(e));e.$tiltIndicator=e.$div.find(i+"-indicator");e.$tiltIndicatorOuterCircle=e.$div.find(i+"-outer-circle");e.$tiltIndicatorOuterShellCircle=e.$div.find(i+"-outer-shell-circle");e.$tiltIndicatorCircle=e.$div.find("[class^="+i.replace(".","")+"-outer]");e.$tiltIndicatorCircle.on("mousedown",function(e){e.stopPropagation&&e.stopPropagation();e.preventDefault&&e.preventDefault();var t=new Cesium.Cartesian2,i=e.currentTarget,n=e.currentTarget.getBoundingClientRect(),r=new Cesium.Cartesian2((n.right-n.left)/2,(n.bottom-n.top)/2),s=new Cesium.Cartesian2(e.clientX-n.left,e.clientY-n.top),a=Cesium.Cartesian2.subtract(s,r,t);this.draggingTilt.call(this,i,a);e.cancelBubble=!0;e.returnValue=!1;return!1}.bind(e));e.$tiltUp=e.$div.find(i+e.selectors.upArrow);e.$tiltUp.on(TC.Util.detectMouse()?"mousedown":"touchstart",function(t){if(void 0!==$(t.target).attr("disabled")){t.stopPropagation&&t.stopPropagation();t.preventDefault&&t.preventDefault();t.cancelBubble=!0;t.returnValue=!1;return!1}t.stopPropagation&&t.stopPropagation();t.preventDefault&&t.preventDefault();e.inControls(t);var i=TC.Util.detectMouse()?"mouseup":"touchend";document.removeEventListener(i,e.tiltUpMouseUpFunction,!1);e.tiltUpMouseUpFunction=void 0;e.tilt.call(e,5);e.tiltUpInterval=setInterval(function(){e.isTiltUpDisabled?e.tiltUpMouseUpFunction():e.tilt.call(e,5)}.bind(e),101);e.tiltUpMouseUpFunction=function(){clearInterval(e.tiltUpInterval);e.tiltUpInterval=void 0;document.removeEventListener(i,e.tiltUpMouseUpFunction,!1);e.tiltUpMouseUpFunction=void 0};document.addEventListener(i,e.tiltUpMouseUpFunction,!1);t.cancelBubble=!0;t.returnValue=!1;return!1}.bind(e));e.$tiltDown=e.$div.find(i+e.selectors.downArrow);e.$tiltDown.on(TC.Util.detectMouse()?"mousedown":"touchstart",function(t){if(void 0!==$(t.target).attr("disabled")){t.stopPropagation&&t.stopPropagation();t.preventDefault&&t.preventDefault();t.cancelBubble=!0;t.returnValue=!1;return!1}t.stopPropagation&&t.stopPropagation();t.preventDefault&&t.preventDefault();e.inControls(t);var i=TC.Util.detectMouse()?"mouseup":"touchend";document.removeEventListener(i,e.tiltDownMouseUpFunction,!1);e.tiltDownMouseUpFunction=void 0;e.tilt.call(e,-5);e.tiltDownInterval=setInterval(function(){e.isTiltDownDisabled?e.tiltDownMouseUpFunction():e.tilt.call(e,-5)}.bind(e),101);e.tiltDownMouseUpFunction=function(){clearInterval(e.tiltDownInterval);e.tiltDownInterval=void 0;document.removeEventListener(i,e.tiltDownMouseUpFunction,!1);e.tiltDownMouseUpFunction=void 0};document.addEventListener(i,e.tiltDownMouseUpFunction,!1);t.cancelBubble=!0;t.returnValue=!1;return!1}.bind(e));var n="."+e.parent.CLASS+e.selectors.rotate;e.$rotateIndicatorInner=e.$div.find("[class^="+n.replace(".","")+"-inner]");e.$rotateIndicatorInner.on(TC.Consts.event.CLICK,e.resetRotation.bind(e));e.$rotateIndicator=e.$div.find(n+"-indicator");e.$rotateIndicatorOuterCircle=e.$div.find(n+"-outer-circle");e.$rotateIndicatorOuterShellCircle=e.$div.find(n+"-outer-shell-circle");e.$rotateIndicatorCircle=e.$div.find("[class^="+n.replace(".","")+"-outer]");e.$rotateIndicatorCircle.on("mousedown",function(e){e.stopPropagation&&e.stopPropagation();e.preventDefault&&e.preventDefault();var t=new Cesium.Cartesian2,i=e.currentTarget,n=e.currentTarget.getBoundingClientRect(),r=new Cesium.Cartesian2((n.right-n.left)/2,(n.bottom-n.top)/2),s=new Cesium.Cartesian2(e.clientX-n.left,e.clientY-n.top),a=Cesium.Cartesian2.subtract(s,r,t);this.draggingRotate.call(this,i,a);e.cancelBubble=!0;e.returnValue=!1;return!1}.bind(e));e.$rotateLeft=e.$div.find(n+e.selectors.leftArrow);e.$rotateLeft.on(TC.Util.detectMouse()?"mousedown":"touchstart",function(t){t.stopPropagation&&t.stopPropagation();t.preventDefault&&t.preventDefault();e.inControls(t);var i=TC.Util.detectMouse()?"mouseup":"touchend";document.removeEventListener(i,e.rotateLeftMouseUpFunction,!1);e.rotateLeftMouseUpFunction=void 0;e.rotate.call(e,-15);e.rotateLeftInterval=setInterval(function(){e.rotate.call(e,-15)}.bind(e),101);e.rotateLeftMouseUpFunction=function(){clearInterval(e.rotateLeftInterval);e.rotateLeftInterval=void 0;document.removeEventListener(i,e.rotateLeftMouseUpFunction,!1);e.rotateLeftMouseUpFunction=void 0};document.addEventListener(i,e.rotateLeftMouseUpFunction,!1);t.cancelBubble=!0;t.returnValue=!1;return!1}.bind(e));e.$rotateRight=e.$div.find(n+e.selectors.rightArrow);e.$rotateRight.on(TC.Util.detectMouse()?"mousedown":"touchstart",function(t){t.stopPropagation&&t.stopPropagation();t.preventDefault&&t.preventDefault();e.inControls(t);var i=TC.Util.detectMouse()?"mouseup":"touchend";document.removeEventListener(i,e.rotateRightMouseUpFunction,!1);e.rotateRightMouseUpFunction=void 0;e.rotate.call(e,15);e.rotateRightInterval=setInterval(function(){e.rotate.call(e,15)}.bind(e),101);e.rotateRightMouseUpFunction=function(){clearInterval(e.rotateRightInterval);e.rotateRightInterval=void 0;document.removeEventListener(i,e.rotateRightMouseUpFunction,!1);e.rotateRightMouseUpFunction=void 0};document.addEventListener(i,e.rotateRightMouseUpFunction,!1);t.cancelBubble=!0;t.returnValue=!1;return!1}.bind(e));e.bind()}.bind(this))};m.prototype.disableTilt=function(e){var t=Cesium.Math.toRadians(e),i=this.getCamera().pitch;this.isTiltDownDisabled=i+-t<this.MIN_TILT;this.isTiltUpDisabled=i+t>this.MAX_TILT;this.$tiltUp.attr("disabled",this.isTiltUpDisabled);this.isTiltUpDisabled?-1==this.$tiltUp.attr("class").indexOf(this.parent.classes.CAMERACTRARROWDISABLED)&&this.$tiltUp.attr("class",this.$tiltUp.attr("class")+" "+this.parent.classes.CAMERACTRARROWDISABLED):this.$tiltUp.attr("class",this.$tiltUp.attr("class").replace(" "+this.parent.classes.CAMERACTRARROWDISABLED,""));this.$tiltDown.attr("disabled",this.isTiltDownDisabled);this.isTiltDownDisabled?-1==this.$tiltDown.attr("class").indexOf(this.parent.classes.CAMERACTRARROWDISABLED)&&this.$tiltDown.attr("class",this.$tiltDown.attr("class")+" "+this.parent.classes.CAMERACTRARROWDISABLED):this.$tiltDown.attr("class",this.$tiltDown.attr("class").replace(" "+this.parent.classes.CAMERACTRARROWDISABLED,""))};m.prototype.disableRotate=function(){var e=!0,t=this.parent.viewer.scene.canvas,i=[new Cesium.Cartesian2(0,t.clientHeight-1),new Cesium.Cartesian2(t.clientWidth-1,t.clientHeight-1),new Cesium.Cartesian2(t.clientWidth-1,0),new Cesium.Cartesian2(0,0)].map(function(e){return a.call(this,e)}.bind(this.parent)).filter(function(e){return null!==e});i.length&&i.length>=2&&(e=!1);this.$rotateIndicatorInner.attr("disabled",e);this.$rotateLeft.attr("disabled",e);e?-1==this.$rotateLeft.attr("class").indexOf(this.parent.classes.CAMERACTRARROWDISABLED)&&this.$rotateLeft.attr("class",this.$rotateLeft.attr("class")+" "+this.parent.classes.CAMERACTRARROWDISABLED):this.$rotateLeft.attr("class",this.$rotateLeft.attr("class").replace(" "+this.parent.classes.CAMERACTRARROWDISABLED,""));this.$rotateRight.attr("disabled",e);e?-1==this.$rotateRight.attr("class").indexOf(this.parent.classes.CAMERACTRARROWDISABLED)&&this.$rotateRight.attr("class",this.$rotateRight.attr("class")+" "+this.parent.classes.CAMERACTRARROWDISABLED):this.$rotateRight.attr("class",this.$rotateRight.attr("class").replace(" "+this.parent.classes.CAMERACTRARROWDISABLED,""));return e};m.prototype.tilt=function(e){this.disableTilt(e);if(this.parent.viewer&&this.parent.viewer.trackedEntity)this.getCamera().rotateUp(Cesium.Math.toRadians(e));else{void 0==u(this.parent.viewer.scene)&&(e>0?this.getCamera().lookUp():this.getCamera().lookDown());if(e>=Cesium.Math.PI_OVER_TWO&&this.isTiltUpDisabled||e<=-Cesium.Math.PI_OVER_TWO&&this.isTiltDownDisabled)return;var t=Cesium.Math.toRadians(e),i=u(this.parent.viewer.scene);if(i){var n=Cesium.Matrix4.fromTranslation(i);this.parent.map3D.rotateAroundAxis(this.getCamera(),-t,this.getCamera().right,n,{duration:100})}}};m.prototype.rotate=function(e){e=Cesium.Math.toRadians(e);if(this.parent.viewer&&this.parent.viewer.trackedEntity)this.getCamera().rotateRight(-e);else{var t=h(this.parent.viewer.scene);t&&p(this.parent.viewer.scene,e,t,{duration:100})}};m.prototype.draggingTilt=function(e,t){var i=this;i.$tiltIndicatorOuterCircle.attr("class",i.$tiltIndicatorOuterCircle.attr("class")+" "+i.parent.classes.HIGHLIGHTED);var n=new Cesium.Matrix4,r=new Cesium.Matrix4,s=new Cesium.Cartesian2;document.removeEventListener("mousemove",i.tiltMouseMoveFunction,!1);document.removeEventListener("mouseup",i.tiltMouseUpFunction,!1);i.tiltMouseMoveFunction=void 0;i.tiltMouseUpFunction=void 0;i.isTilting=!0;var a=i.parent.viewer.scene,o=a.camera,l=u(a);if(l){i.tiltFrame=Cesium.Transforms.northUpEastToFixedFrame(l,Cesium.Ellipsoid.WGS84,r);i.tiltIsLook=!1}else{i.tiltFrame=Cesium.Transforms.northUpEastToFixedFrame(o.positionWC,Cesium.Ellipsoid.WGS84,r);i.tiltIsLook=!0}i.startCursorAngle=Math.atan2(-t.y,t.x);var c=Cesium.Matrix4.clone(o.transform,n);o.lookAtTransform(i.tiltFrame);i.initialCameraAngle=Math.atan2(o.position.y,o.position.x);o.lookAtTransform(c);i.tiltMouseMoveFunction=function(t){a=this.parent.viewer.scene;o=a.camera;var i=e.getBoundingClientRect();center=new Cesium.Cartesian2((i.right-i.left)/2,(i.bottom-i.top)/2);var r=new Cesium.Cartesian2(t.clientX-i.left,t.clientY-i.top),l=Cesium.Cartesian2.subtract(r,center,s);console.log("Entra: "+l.toString());var u=Math.atan2(-l.y,l.x)-this.startCursorAngle,h=Cesium.Math.zeroToTwoPi(this.initialCameraAngle-u);try{c=Cesium.Matrix4.clone(o.transform,n);o.lookAtTransform(this.tiltFrame);var p=h-Math.atan2(o.position.y,o.position.x),d=o.pitch;(d+=p)<this.MIN_TILT?o.rotate(o.right,o.pitch-this.MIN_TILT):d>this.MAX_TILT?o.rotate(o.right,o.pitch-this.MAX_TILT):o.rotate(o.right,-p);this.disableTilt(5);o.lookAtTransform(c)}catch(t){this.tiltMouseUpFunction()}}.bind(i);i.tiltMouseUpFunction=function(e){i.$tiltIndicatorOuterCircle.attr("class",i.$tiltIndicatorOuterCircle.attr("class").replace(i.parent.classes.HIGHLIGHTED,""));i.isTilting=!1;document.removeEventListener("mousemove",i.tiltMouseMoveFunction,!1);document.removeEventListener("mouseup",i.tiltMouseUpFunction,!1);i.tiltMouseMoveFunction=void 0;i.tiltMouseUpFunction=void 0};document.addEventListener("mousemove",i.tiltMouseMoveFunction,!1);document.addEventListener("mouseup",i.tiltMouseUpFunction,!1)};m.prototype.draggingRotate=function(e,t){var i=this;document.removeEventListener("mousemove",i.rotateMouseMoveFunction,!1);document.removeEventListener("mouseup",i.rotateMouseUpFunction,!1);i.rotateMouseMoveFunction=void 0;i.rotateMouseUpFunction=void 0;i.rotateMouseMoveFunction=function(t){var r=e.getBoundingClientRect(),o=new Cesium.Cartesian2((r.right-r.left)/2,(r.bottom-r.top)/2),c=new Cesium.Cartesian2(t.clientX-r.left,t.clientY-r.top),u=Cesium.Cartesian2.subtract(c,o,s),h=Math.atan2(-u.y,u.x)-i.rotateInitialCursorAngle,p=Cesium.Math.zeroToTwoPi(i.rotateInitialCameraAngle-h);a=i.parent.viewer.scene.camera;try{l=Cesium.Matrix4.clone(a.transform,n);a.lookAtTransform(i.rotateFrame);var d=Math.atan2(a.position.y,a.position.x);a.rotateRight(p-d);a.lookAtTransform(l)}catch(t){i.rotateMouseUpFunction()}};i.rotateMouseUpFunction=function(e){i.isRotating=!1;i.$rotateIndicatorOuterCircle.attr("class",i.$rotateIndicatorOuterCircle.attr("class").replace(i.parent.classes.HIGHLIGHTED,""));document.removeEventListener("mousemove",i.rotateMouseMoveFunction,!1);document.removeEventListener("mouseup",i.rotateMouseUpFunction,!1);i.rotateMouseMoveFunction=void 0;i.rotateMouseUpFunction=void 0};if(i.disableRotate())i.rotateMouseUpFunction();else{i.$rotateIndicatorOuterCircle.attr("class",i.$rotateIndicatorOuterCircle.attr("class")+" "+i.parent.classes.HIGHLIGHTED);var n=new Cesium.Matrix4,r=new Cesium.Matrix4,s=new Cesium.Cartesian2;i.isRotating=!0;i.rotateInitialCursorAngle=Math.atan2(-t.y,t.x);var a=i.parent.viewer.scene.camera,o=u(i.parent.viewer.scene);if(null==o||void 0==o)if(null==(o=h(i.parent.viewer.scene))||void 0==o){i.rotateFrame=Cesium.Transforms.eastNorthUpToFixedFrame(a.positionWC,Cesium.Ellipsoid.WGS84,r);i.rotateIsLook=!0}else{i.rotateFrame=Cesium.Transforms.eastNorthUpToFixedFrame(o,Cesium.Ellipsoid.WGS84,r);i.rotateIsLook=!1}else{i.rotateFrame=Cesium.Transforms.eastNorthUpToFixedFrame(o,Cesium.Ellipsoid.WGS84,r);i.rotateIsLook=!1}try{var l=Cesium.Matrix4.clone(a.transform,n);a.lookAtTransform(i.rotateFrame);i.rotateInitialCameraAngle=Math.atan2(a.position.y,a.position.x);i.rotateInitialCameraDistance=Cesium.Cartesian3.magnitude(new Cesium.Cartesian3(a.position.x,a.position.y,0));a.lookAtTransform(l)}catch(e){i.rotateMouseUpFunction()}document.addEventListener("mousemove",i.rotateMouseMoveFunction,!1);document.addEventListener("mouseup",i.rotateMouseUpFunction,!1)}};m.prototype.resetTilt=function(){var e=-this.getCamera().pitch-Cesium.Math.toRadians(50);this.tilt(Cesium.Math.toDegrees(e))};m.prototype.resetRotation=function(e){var t,i=new $.Deferred;t=-this.getCamera().heading;for(;t<-Math.PI;)t+=2*Math.PI;for(;t>Math.PI;)t-=2*Math.PI;e?e.callback=function(){i.resolve()}:i.resolve();if(this.parent.viewer&&this.parent.viewer.trackedEntity){this.getCamera().rotate(Cesium.Cartesian3.fromDegrees(0,90),t)}else{var n=h(this.parent.viewer.scene);n&&p(this.parent.viewer.scene,t,n,e)}return i};m.prototype.customCollisionDetection=function(){var e,t,i=new Cesium.Matrix4,n=new Cesium.Cartographic,r=this.parent.viewer.scene,s=this.parent.viewer.scene.camera,a=r.screenSpaceCameraController,o=(a.enableCollisionDetection,a.minimumCollisionTerrainHeight),l=a.minimumZoomDistance,c=r.globe,u=c.ellipsoid;r.mapProjection;if(!Cesium.Matrix4.equals(s.transform,Cesium.Matrix4.IDENTITY)){e=Cesium.Matrix4.clone(s.transform,i);t=Cesium.Cartesian3.magnitude(s.position);s._setTransform(Cesium.Matrix4.IDENTITY)}var h=n;u.cartesianToCartographic(s.position,h);var p=!1;if(h.height<o){var d=c.getHeight(h);if(void 0!==d&&null!==d){d+=l;if(h.height<d){h.height=d;u.cartographicToCartesian(h,s.position);p=!0}}}if(void 0!==e&&null!==e){s._setTransform(e);if(p){Cesium.Cartesian3.normalize(s.position,s.position);Cesium.Cartesian3.negate(s.position,s.direction);Cesium.Cartesian3.multiplyByScalar(s.position,Math.max(t,l),s.position);Cesium.Cartesian3.normalize(s.direction,s.direction);Cesium.Cartesian3.cross(s.direction,s.up,s.right);Cesium.Cartesian3.cross(s.right,s.direction,s.up)}}};m.prototype.limitCameraToInitExtent=function(){var e=this.viewer.camera.positionCartographic.clone();if(!(e.longitude>=this.initExtent.west&&e.longitude<=this.initExtent.east&&e.latitude>=this.initExtent.south&&e.latitude<=this.initExtent.north)){var t=this.viewer.scene.screenSpaceCameraController.maximumZoomDistance,i=.05*e.height/t;e.longitude=Math.max(this.initExtent.west-i,e.longitude);e.latitude=Math.max(this.initExtent.south-i,e.latitude);e.longitude=Math.min(this.initExtent.east+i,e.longitude);e.latitude=Math.min(this.initExtent.north+i,e.latitude);this.viewer.camera.setView({destination:Cesium.Ellipsoid.WGS84.cartographicToCartesian(e),orientation:{heading:this.viewer.camera.heading,pitch:this.viewer.camera.pitch}})}this.viewer.scene.screenSpaceCameraController.minimumZoomDistance=e.height>1800?400:200};var y=function(e,t,i){this.map2D=e;this.listentTo=[TC.Consts.event.LAYERADD,TC.Consts.event.LAYERORDER,TC.Consts.event.LAYERREMOVE,TC.Consts.event.LAYEROPACITY,TC.Consts.event.LAYERVISIBILITY,TC.Consts.event.ZOOM,TC.Consts.event.BASELAYERCHANGE,TC.Consts.event.FEATUREADD,TC.Consts.event.FEATUREREMOVE,TC.Consts.event.LAYERUPDATE,TC.Consts.event.TERRAINLOADED,TC.Consts.event.ZOOMTO].join(" ");this.map3D=t;this.scene_=this.map3D.scene;this.verboseRendering=i;this._boundNotifyRepaintRequired=this.notifyRepaintRequired.bind(this);this.lastCameraViewMatrix_=new Cesium.Matrix4;this.lastCameraMoveTime_=0;this.stoppedRendering=!1;this._removeTileLoadProgressListener=this.scene_.globe.tileLoadProgressEvent.addEventListener(function(e){this.tilesWaiting=0!==e}.bind(this));this._removePostRenderListener=this.scene_.postRender.addEventListener(this.postRender.bind(this));this._wheelEvent="";"onwheel"in this.scene_.canvas?this._wheelEvent="wheel":document.onmousewheel?this._wheelEvent="mousewheel":this._wheelEvent="DOMMouseScroll";this._originalLoadWithXhr=Cesium.loadWithXhr.load;this._originalScheduleTask=Cesium.TaskProcessor.prototype.scheduleTask;this._originalCameraSetView=Cesium.Camera.prototype.setView;this._originalCameraMove=Cesium.Camera.prototype.move;this._originalCameraRotate=Cesium.Camera.prototype.rotate;this._originalCameraLookAt=Cesium.Camera.prototype.lookAt;this._originalCameraFlyTo=Cesium.Camera.prototype.flyTo;this.enable()};y.prototype.repaintOn_=function(e,t){this.scene_.canvas.addEventListener(e,this._boundNotifyRepaintRequired,t)};y.prototype.removeRepaintOn_=function(e,t){this.scene_.canvas.removeEventListener(e,this._boundNotifyRepaintRequired,t)};y.prototype.enable=function(){this.repaintOn_("mousemove",!1);this.repaintOn_("mousedown",!1);this.repaintOn_("mouseup",!1);this.repaintOn_("touchstart",!1);this.repaintOn_("touchend",!1);this.repaintOn_("touchmove",!1);if(window.PointerEvent){this.repaintOn_("pointerdown",!1);this.repaintOn_("pointerup",!1);this.repaintOn_("pointermove",!1)}this.repaintOn_(this._wheelEvent,!1);window.addEventListener("resize",this._boundNotifyRepaintRequired,!1);var e=this;Cesium.loadWithXhr.load=function(t,i,n,r,s,a,o,l,c){a.promise.always(e._boundNotifyRepaintRequired);e._originalLoadWithXhr(t,i,n,r,s,a,o,l,c)};Cesium.TaskProcessor.prototype.scheduleTask=function(t,i){var n=e._originalScheduleTask.call(this,t,i),r=this;if(!r._originalWorkerMessageSinkRepaint){var s=r._worker;r._originalWorkerMessageSinkRepaint=s.onmessage;s.onmessage=function(t){r._originalWorkerMessageSinkRepaint(t);e.notifyRepaintRequired()}}return n};Cesium.Camera.prototype.setView=function(){e._originalCameraSetView.apply(this,arguments);e.notifyRepaintRequired()};Cesium.Camera.prototype.move=function(){e._originalCameraMove.apply(this,arguments);e.notifyRepaintRequired()};Cesium.Camera.prototype.rotate=function(){e._originalCameraRotate.apply(this,arguments);e.notifyRepaintRequired()};Cesium.Camera.prototype.lookAt=function(){e._originalCameraLookAt.apply(this,arguments);e.notifyRepaintRequired()};Cesium.Camera.prototype.flyTo=function(){e._originalCameraFlyTo.apply(this,arguments);e.notifyRepaintRequired()};this.map2D.on(this.listentTo,this._boundNotifyRepaintRequired)};y.prototype.disable=function(){if(this._removePostRenderListener){this._removePostRenderListener();this._removePostRenderListener=void 0}if(this._removeTileLoadProgressListener){this._removeTileLoadProgressListener();this._removeTileLoadProgressListener=void 0}this.removeRepaintOn_("mousemove",!1);this.removeRepaintOn_("mousedown",!1);this.removeRepaintOn_("mouseup",!1);this.removeRepaintOn_("touchstart",!1);this.removeRepaintOn_("touchend",!1);this.removeRepaintOn_("touchmove",!1);if(window.PointerEvent){this.removeRepaintOn_("pointerdown",!1);this.removeRepaintOn_("pointerup",!1);this.removeRepaintOn_("pointermove",!1)}this.removeRepaintOn_(this._wheelEvent,!1);window.removeEventListener("resize",this._boundNotifyRepaintRequired,!1);Cesium.loadWithXhr.load=this._originalLoadWithXhr;Cesium.TaskProcessor.prototype.scheduleTask=this._originalScheduleTask;Cesium.Camera.prototype.setView=this._originalCameraSetView;Cesium.Camera.prototype.move=this._originalCameraMove;Cesium.Camera.prototype.rotate=this._originalCameraRotate;Cesium.Camera.prototype.lookAt=this._originalCameraLookAt;Cesium.Camera.prototype.flyTo=this._originalCameraFlyTo;this.map2D.off(this.listentTo,this._boundNotifyRepaintRequired)};y.prototype.postRender=function(e){var t=Date.now(),i=this.scene_,n=i.camera;Cesium.Matrix4.equalsEpsilon(this.lastCameraViewMatrix_,n.viewMatrix,1e-5)||(this.lastCameraMoveTime_=t);var r=t-this.lastCameraMoveTime_<3e3,s=i.tweens;if(!r&&!this.tilesWaiting&&0==s.length){this.verboseRendering&&console.log("stopping rendering @ "+Date.now());this.parent.setBlockRendering(!0);this.stoppedRendering=!0}Cesium.Matrix4.clone(n.viewMatrix,this.lastCameraViewMatrix_)};y.prototype.restart=function(){this.notifyRepaintRequired()};y.prototype.notifyRepaintRequired=function(){this.verboseRendering&&this.stoppedRendering&&console.log("starting rendering @ "+Date.now());this.lastCameraMoveTime_=Date.now();this.parent.setBlockRendering(!1);this.stoppedRendering=!1};y.prototype.setDebug=function(e){this.verboseRendering=e};var g=function(e,t,i){this.idRequestAnimationFrame=null;this._blockRendering=!1;this._canvasClientWidth=0;this._canvasClientHeight=0;this._resolutionScale=1;this._viewer=t;this._canvas=t.scene.canvas;this._clock=t.clock||new Cesium.Clock;this._handleResize=function(e){var t=this._canvas.clientWidth,i=this._canvas.clientHeight;if(!(0===t|0===i||t===this._canvasClientWidth&&i===this._canvasClientHeight)){var n=this._resolutionScale;this._canvasClientWidth=t;this._canvasClientHeight=i;t*=n;i*=n;this._canvas.width=t;this._canvas.height=i;e.scene.camera.frustum.aspectRatio=t/i}};this._renderingAnimation=function(){this.idRequestAnimationFrame=requestAnimationFrame(function e(){if(!this._blockRendering){this._viewer.scene.initializeFrame();this._handleResize(this._viewer);var t=this._clock.tick()||Cesium.JulianDate.now();this._viewer.scene.render(t)}this.idRequestAnimationFrame=requestAnimationFrame(e.bind(this))}.bind(this))};i&&(this._resolutionScale=.5);this.renderLoop=new y(e,t,!1);this.renderLoop.parent=this};g.prototype.start=function(e){this.renderLoop.setDebug(e||!1);this._renderingAnimation()};g.prototype.stop=function(){window.cancelAnimationFrame(this.idRequestAnimationFrame)};g.prototype.restart=function(){this.renderLoop.restart()};g.prototype.setBlockRendering=function(e){this._blockRendering=e};g.prototype.getCanvas=function(){return this._canvas};var C,v,T,L,w,b,S,O,A,x,P=function(e){var t,i=!1,n=null,r=null,s=null,a=e.map.getResolution,o=function(){var t=new $.Deferred;if(r)t.resolve();else{TC.control.ResultsPanel||TC.syncLoadJS(TC.apiLocation+"TC/control/ResultsPanel");const i=e.map.getControlsByClass(TC.control.ResultsPanel).filter(function(e){return"chart"===e.options.content})[0],n=i?i._$div:$("<div>").appendTo(e.map._$div);e.map.addControl("ResultsPanel",{div:n,content:"table",titles:{main:e.getLocaleString("threed.rs.panel.gfi"),max:e.getLocaleString("threed.rs.panel.gfi")}}).then(function(i){r=i;e.ctlResultsPanel=r;t.resolve()})}return t},l=function(){e.map3D.removeFeature.call(e,n);n=null};if(s=e.map.getControlsByClass(TC.control.FeatureInfo)[0]){t=s.displayMode;$.when(o()).then(function(){s.setDisplayMode(TC.control.FeatureInfoCommons.displayMode.RESULTS_PANEL);e.map.on(TC.Consts.event.RESULTSPANELCLOSE,function(e){e.control===s.getDisplayControl()&&(s.querying||l())})})}this.clear=function(){s.closeResults();l();e.ctlResultsPanel.close()};this.reset=function(){this.clear();s.setDisplayMode(t);e.map.getResolution=a};this.send=function(t){var r=new $.Deferred;i=!0;s.displayMode!==TC.control.FeatureInfoCommons.displayMode.RESULTS_PANEL&&s.setDisplayMode(TC.control.FeatureInfoCommons.displayMode.RESULTS_PANEL);s.resultsPanel&&s.resultsPanel.close();e.waiting||(e.waiting=e.map.getLoadingIndicator().addWait());!function(t){if(n)n.position=t;else{TC.control.FeatureInfoCommons.prototype.markerStyle;var i={position:t,billboard:{image:TC.Util.getBackgroundUrlFromCss(e.CLASS+"-marker"),eyeOffset:new Cesium.Cartesian3(0,0,-100),verticalOrigin:Cesium.VerticalOrigin.BOTTOM,heightReference:Cesium.HeightReference.CLAMP_TO_GROUND}};n=e.map3D.addNativeFeature.call(e,i)}e.viewer.scene.requestRender()}(t);$.when(o()).then(function(){for(var n,a=Cesium.Ellipsoid.WGS84.cartesianToCartographic(t),o=TC.Util.reproject([Cesium.Math.toDegrees(a.longitude),Cesium.Math.toDegrees(a.latitude)],e.map3D.crs,e.map.crs),l=(e.map.options.pixelTolerance||TC.Cfg.pixelTolerance,e.viewer.scene.globe._surface._tilesToRender),c=0;!n&&c<l.length;++c){var u=l[c];Cesium.Rectangle.contains(u.rectangle,a)&&(n=u)}if(!n)return r;for(var h=n.data.imagery,p=h.length-1;p>=0;--p){if(!h[p].readyImagery)return r}var d=n.tilingScheme.tileXYToNativeRectangle(n.x,n.y,n.level),f=(h.filter(function(e){return e.readyImagery.imageryLayer.isBaseLayer()})[0]||{}).readyImagery;e.map.getResolution=function(){var t=TC.Util.reproject([d.west,d.south],e.map3D.crs,e.map.crs),i=TC.Util.reproject([d.east,d.north],e.map3D.crs,e.map.crs),n=(i[0]-t[0])/(f&&f.imageryLayer.imageryProvider.tileWidth||256),r=(i[1]-t[1])/(f&&f.imageryLayer.imageryProvider.tileHeight||256);return Math.max(n,r)}.bind(e,f,d);var m=e;e.map.one(TC.Consts.event.NOFEATUREINFO,function(e){i=!1;m.map3D.linked2DControls.geolocation.track&&m.map3D.linked2DControls.geolocation.track.$info.addClass(TC.Consts.classes.HIDDEN);m.map3D.linked2DControls.geolocation.resultsPanelChart&&m.map3D.linked2DControls.geolocation.resultsPanelChart.close();r.resolve(e)});e.map.one(TC.Consts.event.FEATUREINFO,function(e){i=!1;m.map3D.linked2DControls.geolocation.track&&m.map3D.linked2DControls.geolocation.track.$info.addClass(TC.Consts.classes.HIDDEN);m.map3D.linked2DControls.geolocation.resultsPanelChart&&m.map3D.linked2DControls.geolocation.resultsPanelChart.close();r.resolve(e)});s.isActive;s.isActive=!0;s.beforeRequest({xy:[0,0]});s.callback(o)});return r};this.get2DMarker=function(){return s.filterFeature};this.isPending=function(){return i}},_=function(e){this.layerCrs=null;var t,i=["Contents","TileMatrixSet"],n=function(e,t,i){if(i<t.length-1)return e.hasOwnProperty(t[i])?n(e[t[i]],t,++i):null;if(e instanceof Array){for(var r=[],s=0;s<e.length;s++)e[s].hasOwnProperty(t[i])&&r.push(e[s][t[i]]);return r}return e[t[i]]},r=function(e){var r=new $.Deferred,s=function(e,t){if((capsURL=TC.Util.isOnCapabilities(e.url))&&(caps=TC.capabilities[capsURL]))for(var r=n(caps,i,0),s=0;s<r.length;s++)if(r[s].Identifier===t)return n(r[s],["TileMatrix","Identifier"],0);return null}(e,this.layerCrs),a={url:new t({url:e.options.urlPattern},e),layer:e.layerNames,style:"default",format:e.format||e.options.format,tileMatrixSetID:this.layerCrs,tileMatrixLabels:s,tilingScheme:new Cesium.GeographicTilingScheme};r.resolve(new Cesium.WebMapTileServiceImageryProvider(a));return r},s=function(){try{var e=new XMLHttpRequest;e.open("GET","#",!0);e.responseType="blob";return"blob"===e.responseType}catch(e){return!1}}();function a(e,t){var i=e.request;i.url=e.url;i.requestFunction=function(){var i=e.url,n=!1;e.isDataUri||e.isBlobUri||(n=e.isCrossOriginUrl);var r=Cesium.when.defer();!function(e,t,i,n){var r=function(e){var t=new Image;t.onload=function(){n.resolve(t)};t.onerror=function(e){n.reject(e)};i&&(Cesium.TrustedServers.contains(e)?t.crossOrigin="use-credentials":t.crossOrigin="");t.src=e};e.getWebGLUrl===TC.layer.Raster.prototype.getWebGLUrl?e.getWebGLUrl.call(e,t).then(r):r(e.getWebGLUrl(t))}(e.layer,i,n&&t,r);return r.promise};var n=Cesium.RequestScheduler.request(i);if(Cesium.defined(n))return n.otherwise(function(n){return i.state!==Cesium.RequestState.FAILED?Cesium.when.reject(n):e.retryOnError(n).then(function(r){if(r){i.state=Cesium.RequestState.UNISSUED;i.deferred=void 0;return a(e,t)}return Cesium.when.reject(n)})})}var o=function(e,t){Cesium.defined(t)&&Cesium.deprecationWarning("Resource.fetchImage.allowCrossOrigin","The allowCrossOrigin parameter has been deprecated and will be removed in Cesium 1.44. It no longer needs to be specified.");e=Cesium.defaultValue(e,!1);t=Cesium.defaultValue(t,!0);!function(e){if(e.state===Cesium.RequestState.ISSUED||e.state===Cesium.RequestState.ACTIVE)throw new Cesium.RuntimeError("The Resource is already being fetched.");e.state=Cesium.RequestState.UNISSUED;e.deferred=void 0}(this.request);if(!s||this.isDataUri||this.isBlobUri||!this.hasHeaders&&!e)return a(this,t);var i=this.fetchBlob();if(Cesium.defined(i)){var n,r;return i.then(function(e){if(Cesium.defined(e)){r=e;var t=window.URL.createObjectURL(e);return a(n=new Cesium.Resource({url:t}))}}).then(function(e){if(Cesium.defined(e)){window.URL.revokeObjectURL(n.url);e.blob=r;return e}}).otherwise(function(e){Cesium.defined(n)&&window.URL.revokeObjectURL(n.url);return Cesium.when.reject(e)})}};this.convert=function(e,i){this.layerCrs=i;t||function(){(t=function(e,t){Cesium.Resource.call(this,e);this.layer=t}).prototype.constructor=t;t.prototype=Object.create(Cesium.Resource.prototype,{});t.prototype.clone=function(e){var i=Cesium.Resource.prototype.clone.call(this,e);Cesium.defined(e)||(e=new t({url:this._url},this.layer));e._url=i._url;e._queryParameters=i._queryParameters;e._templateValues=i._templateValues;e.headers=i.headers;e.proxy=i.proxy;e.retryCallback=i.retryCallback;e.retryAttempts=i.retryAttempts;e._retryCount=0;e.request=i.request;return e};t.prototype.fetchImage=o}();switch(!0){case TC.Consts.layerType.WMTS==e.type:return r.call(this,e);case TC.Consts.layerType.WMS==e.type:return function(e){var i=new $.Deferred,n={url:new t({url:e.url},e),layers:e.layerNames,parameters:{version:"1.3.0",transparent:!0,format:e.format||e.options.format}};i.resolve(new Cesium.WebMapServiceImageryProvider(n));return i}.call(this,e)}}},N=function(){var e=null,t=function(e,t){e instanceof Array&&(e="rgba("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")");var i=Cesium.Color.fromCssColorString(e);return t?i.withAlpha(t):i},i=function(e,t,i){for(var n in t){var r=e[t[n].prop];if(r)if("function"==typeof r){var s=r(i);s&&(t[n].val=s)}else t[n].val=r}},n=function(e){var t;t=void 0==(t=e.layer.hasOwnProperty("styles")?e.layer.styles:TC.Defaults.styles)[e.STYLETYPE]?t["polyline"===e.STYLETYPE?"line":e.STYLETYPE]:t["multipolygon"===e.STYLETYPE?"polygon":e.STYLETYPE];return t=$.extend({},t,e.options,e.getStyle())};function r(e){return Cesium.sampleTerrainMostDetailed(this.provider,e.map(function(e){return Cesium.Cartographic.fromCartesian(e)}))}function s(e,t,i,n){n(new Cesium.Entity({id:e,polyline:{positions:Cesium.Ellipsoid.WGS84.cartographicArrayToCartesianArray(t),material:i.material,width:i.width,granularity:Cesium.Math.toRadians(.1)}}))}var a=function(e){var a={},o=n(e);a.options=function(){var n,r={},s={color:{prop:"fillColor"},opacity:{prop:"fillOpacity"},outlineColor:{prop:"strokeColor"},outlineOpacity:{prop:"strokeOpacity"},width:{prop:"strokeWidth"}};i(o,s,e);s.color.hasOwnProperty("val")&&(n=s.opacity.hasOwnProperty("val")?t(s.color.val,s.opacity.val):t(s.color.val));r.color=Cesium.ColorGeometryInstanceAttribute.fromColor(n);s.outlineColor.hasOwnProperty("val")&&(n=s.outlineOpacity.hasOwnProperty("val")?t(s.outlineColor.val,s.outlineOpacity.val):t(s.outlineColor.val));r.outlineColor=n;s.width.hasOwnProperty("val")&&(r.width=s.width.val);return r};TC.feature.MultiPolygon&&e instanceof TC.feature.MultiPolygon?a.geometryType=function(t,i){for(var n,a=new $.Deferred,o=[],l=[],c=[],u=function(t){var n=new $.Deferred;Cesium.when(r.call(this,t),function(t){s(e.id+"outLine"+c.length,t,{material:i.outlineColor,width:i.width},function(e){c.push(e);n.resolve()})});return n},h=0;h<t.length;h++){for(var p=0;p<t[h].length;p++){var d;if(0==p){o.push(u.call(this,t[h][0]));d=new Cesium.PolygonHierarchy(t[h][0])}else{o.push(u.call(this,t[h][p]));d.holes.push(new Cesium.PolygonHierarchy(t[h][p]))}}l.push((n=d,new Cesium.GeometryInstance({id:e.id,geometry:new Cesium.PolygonGeometry({polygonHierarchy:n}),attributes:{color:i.color}})))}$.when.apply($,o).then(function(){o=[];a.resolve([new Cesium.GroundPrimitive({geometryInstances:l}),c])});return a}:TC.feature.Polygon&&e instanceof TC.feature.Polygon&&(a.geometryType=function(t,i){var n=new $.Deferred;$.isArray(t)&&1===t.length&&$.isArray(t[0])&&(t=t[0]);Cesium.when(r.call(this,t),function(r){s(e.id+"outLine",r,{material:i.outlineColor,width:i.width},function(r){n.resolve([new Cesium.GroundPrimitive({geometryInstances:new Cesium.GeometryInstance({id:e.id,geometry:new Cesium.PolygonGeometry({polygonHierarchy:new Cesium.PolygonHierarchy(t)}),attributes:{color:i.color}})}),r])})});return n});return a},o=function(a){var o={},l=n(a);o.options=function(){var e,n={},r={color:{prop:"strokeColor"},opacity:{prop:"strokeOpacity"},width:{prop:"strokeWidth"}};i(l,r,a);r.width.hasOwnProperty("val")&&(n.width=r.width.val);r.color.hasOwnProperty("val")&&(e=r.opacity.hasOwnProperty("val")?t(r.color.val,r.opacity.val):t(r.color.val));n.color=e;return n};TC.feature.MultiPolyline&&a instanceof TC.feature.MultiPolyline?o.geometryType=function(t,i){var n=[],o=new $.Deferred,l=[];if(1==t.length){t=t[0];var c=new $.Deferred;l.push(c);Cesium.when(r.call(this,t),function(e){s(a.id,e,{material:i.color,width:i.width},function(e){n.push(e);c.resolve()})})}else{(function(t){var i;if(1==t.length){var n,r,s,a,o=t[0];n=new Cesium.Cartesian3(o.x-1e3,o.y,o.z);r=new Cesium.Cartesian3(o.x,o.y-1e3,o.z);s=new Cesium.Cartesian3(o.x+1e3,o.y,o.z);a=new Cesium.Cartesian3(o.x,o.y+1e3,o.z);i=Cesium.Rectangle.fromCartesianArray([n,r,s,a],Cesium.Ellipsoid.WGS84)}else i=Cesium.Rectangle.fromCartesianArray(t,Cesium.Ellipsoid.WGS84);var l=e.camera.getRectangleCameraCoordinates(i),c=Cesium.Cartesian3.distance(l,Cesium.BoundingSphere.fromPoints(t).center),u=e.camera.frustum.getPixelDimensions(e.drawingBufferWidth,e.drawingBufferHeight,c,new Cesium.Cartesian2);u=Math.max(u.x,u.y);Math.round(u)})((t=t.sort(function(e,t){return e.length>t.length?-1:e.length<t.length?1:0}))[0]);for(var u=0;u<t.length;u++){c=new $.Deferred;l.push(c);Cesium.when(r.call(this,t[u]),function(e){s(a.id,e,{material:i.color,width:i.width},function(e){n.push(e);c.resolve()})})}}$.when.apply($,l).then(function(){l=[];o.resolve(n)});return o}:TC.feature.Polyline&&a instanceof TC.feature.Polyline&&(o.geometryType=function(e,t){var i=new $.Deferred;Cesium.when(r.call(this,e),function(e){s(a.id,e,{material:t.color,width:t.width},function(e){i.resolve(e)})});return i});return o},l=function(e){var r={},s=n(e);r.options=function(){var n={},r={rotation:{prop:"angle"},label:{prop:"label"},fontSize:{prop:"fontSize"},fontColor:{prop:"fontColor"},outlineLabelColor:{prop:"labelOutlineColor"},outlineLabelWidth:{prop:"labelOutlineWidth"},anchor:{prop:"anchor"},height:{prop:"height"},width:{prop:"width"},url:{prop:"url"},color:{prop:"fillColor"},opacity:{prop:"fillOpacity"},outlineColor:{prop:"strokeColor"},outlineOpacity:{prop:"strokeOpacity"},outlineWidth:{prop:"strokeWidth"},radius:{prop:"radius"}};i(s,r,e);if(r.anchor.hasOwnProperty("val")){!r.url.hasOwnProperty("val")&&e.options.url?n.url=e.options.url:n.url=r.url.val;n.anchor=r.anchor.val}r.height.hasOwnProperty("val")&&(n.height=r.height.val);r.width.hasOwnProperty("val")&&(n.width=r.width.val);r.rotation.hasOwnProperty("val")&&(n.rotation=r.rotation.val);r.label.hasOwnProperty("val")&&(n.label=r.label.val);r.fontSize.hasOwnProperty("val")&&(n.fontSize=r.fontSize.val);r.fontColor.hasOwnProperty("val")&&(n.fontColor=t(r.fontColor.val));r.outlineLabelColor.hasOwnProperty("val")&&(n.outlineLabelColor=t(r.outlineLabelColor.val));r.outlineLabelWidth.hasOwnProperty("val")&&(n.outlineLabelWidth=r.outlineLabelWidth.val);r.color.hasOwnProperty("val")&&(r.opacity.hasOwnProperty("val")?n.color=t(r.color.val,r.opacity.val):n.color=t(r.color.val));r.outlineColor.hasOwnProperty("val")&&(r.outlineOpacity.hasOwnProperty("val")?n.outlineColor=t(r.outlineColor.val,r.outlineOpacity.val):n.outlineColor=t(r.outlineColor.val));r.outlineWidth.hasOwnProperty("val")&&(n.outlineWidth=r.outlineWidth.val);r.radius.hasOwnProperty("val")&&(n.radius=r.radius.val);return n};if(TC.feature.Marker&&e instanceof TC.feature.Marker)r.geometryType=function(t,i){var n={id:e.id,name:e.id,position:t[0],billboard:{image:i.url,width:i.width,height:i.height,eyeOffset:new Cesium.Cartesian3(0,0,-100),pixelOffset:new Cesium.Cartesian2(i.anchor[0],i.anchor[1]),verticalOrigin:Cesium.VerticalOrigin.BOTTOM,heightReference:Cesium.HeightReference.CLAMP_TO_GROUND}};return i.label?[n,{id:e.id,name:e.id,position:t[0],label:{text:i.label,font:"14pt sans-serif",heightReference:Cesium.HeightReference.CLAMP_TO_GROUND,horizontalOrigin:Cesium.HorizontalOrigin.CENTER,verticalOrigin:Cesium.VerticalOrigin.BOTTOM,fillColor:i.fontColor,showBackground:!0,eyeOffset:new Cesium.Cartesian3(0,0,-100)}}]:n};else if(TC.feature.Point&&e instanceof TC.feature.Point){var a=new Cesium.PinBuilder;r.geometryType=function(t,i){var n=i.label;switch(!0){case n&&/^([A-Z])\w+$/gi.test(n):case n&&!/^[0-9]*\-{0,1}[a-z]{0,4}$/gi.test(n):return{id:e.id,name:e.id,position:t[0],label:{text:i.label,font:"14px san-serif Arial",showBackground:!0,eyeOffset:new Cesium.Cartesian3(0,0,-100),heightReference:Cesium.HeightReference.CLAMP_TO_GROUND,horizontalOrigin:Cesium.HorizontalOrigin.CENTER,verticalOrigin:Cesium.VerticalOrigin.BASELINE,fillColor:Cesium.Color.WHITE}};case/^[0-9]*\-{0,1}[a-z]{0,4}$/gi.test(n):return{id:e.id,name:e.id,position:t[0],billboard:{image:a.fromText(n,i.fontColor,48).toDataURL(),eyeOffset:new Cesium.Cartesian3(0,0,-100),verticalOrigin:Cesium.VerticalOrigin.BOTTOM,heightReference:Cesium.HeightReference.CLAMP_TO_GROUND}};default:return{id:e.id,name:e.id,position:t[0],billboard:{image:a.fromColor(e.options.fillColor?new Cesium.Color(e.options.fillColor):Cesium.Color.fromCssColorString(TC.Cfg.styles.point.fillColor),32).toDataURL(),eyeOffset:new Cesium.Cartesian3(0,0,-100),verticalOrigin:Cesium.VerticalOrigin.BOTTOM,horizontalOrigin:Cesium.HorizontalOrigin.CENTER,heightReference:Cesium.HeightReference.CLAMP_TO_GROUND}}}}}return r};this.convert=function(r,s,c,u){e=r;var h,p,d,f,m,y=!1,g=[],C=function(e,t){if($.isArray(e)){e=TC.Util.reproject(e,c,u);t.push(e.length>2?Cesium.Cartesian3.fromDegrees(e[0],e[1],e[2]):Cesium.Cartesian3.fromDegrees(e[0],e[1]))}},v=s.geometry,T=function(e,t){if($.isArray(e))for(var i=0;i<e.length;i++)C(e[i],t)},L=function(e,t){if($.isArray(e))for(var i=0;i<e.length;i++){t.push([]);T(e[i],t[t.length-1])}};switch(!0){case TC.feature.Circle&&s instanceof TC.feature.Circle:T(v,g);p=function(e){var r={},s=n(e);r.options=function(){var n,r={},a={color:{prop:"strokeColor"},opacity:{prop:"fillOpacity"},outlineColor:{prop:"fillColor"},outlineOpacity:{prop:"strokeOpacity"},width:{prop:"strokeWidth"}};i(s,a,e);a.color.hasOwnProperty("val")&&(n=a.opacity.hasOwnProperty("val")?t(a.color.val,a.opacity.val):t(a.color.val));r.color=Cesium.ColorGeometryInstanceAttribute.fromColor(n);a.outlineColor.hasOwnProperty("val")&&(n=a.outlineOpacity.hasOwnProperty("val")?t(a.outlineColor.val,a.outlineOpacity.val):t(a.outlineColor.val));r.outlineColor=Cesium.ColorGeometryInstanceAttribute.fromColor(n);a.width.hasOwnProperty("val")&&(r.width=a.width.val);return r};r.geometryType=function(t,i){return new Cesium.GroundPrimitive({geometryInstances:new Cesium.GeometryInstance({id:e.id,geometry:new Cesium.CircleGeometry({center:t[0],radius:e.geometry[1]}),attributes:{color:i.color}})})};return r}.call(self,s);break;case TC.feature.MultiPolygon&&s instanceof TC.feature.MultiPolygon:m=v;if($.isArray(m)){!function(e){if($.isArray(e))for(var t=0;t<e.length;t++){g.push([]);L(e[t],g[g.length-1])}}(m);p=a.call(self,s);y=!0}break;case TC.feature.Polygon&&s instanceof TC.feature.Polygon||TC.feature.MultiPolyline&&s instanceof TC.feature.MultiPolyline:f=v;if($.isArray(f)){L(f,g);if(s instanceof TC.feature.Polygon){p=a(s);y=!0}else if(s instanceof TC.feature.MultiPolyline){p=o(s);y=!0}}break;case TC.feature.Polyline&&s instanceof TC.feature.Polyline:d=v;if($.isArray(d)){T(d,g);p=o(s);y=!0}break;case TC.feature.Marker&&s instanceof TC.feature.Marker:case TC.feature.Point&&s instanceof TC.feature.Point:T(d=[v],g);p=l(s)}if(0==g.length)return null;(h={id:s.id,attributes:s.data,boundigSphere:Cesium.BoundingSphere.fromPoints(g)}).geometry=y?function(e){p.provider=e;return p.geometryType(g,p.options())}:p.geometryType(g,p.options());return h}};e.map3D=(C={baseMap:"",baseMaps:[],baseVector:""},v=new _(/(EPSG\:?4326)/i),T=new N,L=function(e){var t=e;switch(!0){case e instanceof Cesium.GroundPrimitive:this.viewer.scene.groundPrimitives.add(e);break;case e instanceof Object&&e.hasOwnProperty("billboard"):this.viewer.billboardCollection||(this.viewer.billboardCollection=this.viewer.scene.primitives.add(new Cesium.BillboardCollection({scene:this.viewer.scene})));t=this.viewer.billboardCollection.add({position:e.position,image:e.billboard.image,verticalOrigin:e.billboard.verticalOrigin,heightReference:e.billboard.heightReference});break;case e instanceof Object:t=this.viewer.entities.add(e)}this.viewer.scene.requestRender();return t},w=function(e,t,i){e.vector2DFeatures.hasOwnProperty(t)?e.vector2DFeatures[t].push(i):e.vector2DFeatures[t]=[i]},b=[TC.Consts.event.BEFOREBASELAYERCHANGE,TC.Consts.event.BASELAYERCHANGE,TC.Consts.event.LAYERADD,TC.Consts.event.LAYERREMOVE,TC.Consts.event.LAYERVISIBILITY,TC.Consts.event.LAYEROPACITY,TC.Consts.event.LAYERORDER,TC.Consts.event.FEATUREADD,TC.Consts.event.FEATUREREMOVE,TC.Consts.event.FEATURESCLEAR,TC.Consts.event.ZOOMTO],S=function(){if(!this.map3D.trackingEntity){var e=this.map3D.linked2DControls.geolocation,t=e.layerTracking.features.filter(function(e){return e instanceof TC.feature.Polyline});if(t&&t.length>0){var i=[],n=new Cesium.Entity({id:"trackingEntity",polyline:{positions:new Cesium.CallbackProperty(function(e,n){if(t[0].geometry.length>i.length){var r=t[0].geometry.slice(i.length).map(function(e){var t=TC.Util.reproject(e,this.map.crs,this.map3D.crs);return Cesium.Cartographic.fromDegrees(t[0],t[1],e[2])}.bind(this));Cesium.when(Cesium.sampleTerrainMostDetailed(this.viewer.scene.globe.terrainProvider,r),function(e){e=e instanceof Array?Cesium.Ellipsoid.WGS84.cartographicArrayToCartesianArray(e):[Cesium.Ellipsoid.WGS84.cartographicToCartesian(e)];return i=i.concat(e)})}return i}.bind(this),!1),width:3,material:new Cesium.PolylineDashMaterialProperty({color:new Cesium.CallbackProperty(function(t,i){return Cesium.Color.fromAlpha(new Cesium.Color(0,255,209),e.track.renderTrack.is(":checked")?1:0)}.bind(this),!1),gapColor:Cesium.Color.TRANSPARENT})}});this.map3D.trackingEntity=this.viewer.entities.add(n);this.viewer.scene.requestRender()}}},O=function(e){var t=this.map3D.linked2DControls.geolocation;switch(!0){case t.Const.Event.IMPORTEDTRACK.indexOf(e.type)>-1:case e.target.className.indexOf("draw")>-1&&$(e.target).parent().hasClass(t.Const.Classes.SELECTEDTRACK):case!$(e.target).parent().hasClass(t.Const.Classes.SELECTEDTRACK):case e.target.className.indexOf("stop")>-1:if(this.mapIs3D){this.viewer.clock.shouldAnimate=!1;this.viewer.clock.currentTime=Cesium.JulianDate.fromDate(new Date)}if(this.map3D.trackDataSource){if(this.map3D.trackDataSource.length>0){var i=this.map3D.trackDataSource.get(0).entities.values[0];this.viewer.entities.removeById(i.id)}this.map3D.trackDataSource.destroy();delete this.map3D.trackDataSource}t.chartProgressClear();e.custom&&t.getSelectedTrack().find(t.Const.Selector.STOP).click();break;case e.target.className.indexOf("play")>-1:this.viewer.clock.shouldAnimate=!1;break;case e.target.className.indexOf("pause")>-1:this.viewer.clock.shouldAnimate=!0;break;case e.target.className.indexOf("back")>-1:case e.target.className.indexOf("for")>-1:this.viewer.clock.multiplier=t.simulate_speed}},A=function(e){var t,i=this;i.map.controls.map(function(t){if(i.ctrlsToMng.indexOf(t)<0)switch(!0){case i.direction.TO_TWO_D==e:t.enable();break;case i.direction.TO_THREE_D==e:t.disable()}});switch(!0){case i.direction.TO_TWO_D==e:$("[data-no-3d]").removeClass(TC.Consts.classes.THREED_HIDDEN);i.ctrlsToMng.forEach(function(e){e._$div.removeClass(TC.Consts.classes.THREED)});break;case i.direction.TO_THREE_D==e:$("[data-no-3d]").addClass(TC.Consts.classes.THREED_HIDDEN);i.ctrlsToMng.forEach(function(e){e._$div.addClass(TC.Consts.classes.THREED)})}!i.map3D.linked2DControls.coordinates&&i.allowedControls.indexOf("coordinates")>-1&&(i.map3D.linked2DControls.coordinates=i.ctrlsToMng.filter(function(e){return e instanceof TC.control.Coordinates})[0]);if(t=i.map3D.linked2DControls.coordinates){$viewport=$(t.map.wrap.getViewport());if(i.direction.TO_THREE_D===e){$viewport.off(TC.Consts.event.MOUSEMOVE+".coords");t.isGeo=!0;t.crs=i.map3D.crs}else{t.isGeo=i.map.wrap.isGeo();t.crs=i.map.crs;$viewport.on(TC.Consts.event.MOUSEMOVE+".coords",function(e){t.onMouseMove(e)})}t.geoCrs=i.map3D.crs;t.render();new Cesium.ScreenSpaceEventHandler(i.viewer.scene.canvas,!1).setInputAction(function(e){if(i.viewer){var n=i.viewer.camera.getPickRay(e.endPosition||e.position),r=i.viewer.scene.globe.pick(n,i.viewer.scene);if(r){var s,a,o,l=Cesium.Ellipsoid.WGS84.cartesianToCartographic(r);s=Cesium.Math.toDegrees(l.latitude);a=Cesium.Math.toDegrees(l.longitude);var c=TC.Util.getMapLocale(i.map);o=Math.round(l.height).toLocaleString(c);if(TC.Util.detectMobile()){var u=TC.Util.reproject([a,s],i.map3D.crs,i.map.crs);o>0&&u.push(o);t.clear();t.coordsToClick({coordinate:u,cssClass:i.classes.COORDSTHREEDMARKER});t.latLon=[s,a];o>0&&t.latLon.push(o+" m");t.update()}else{t.latLon=[s,a];o>0&&t.latLon.push(o+" m");t.update()}}else t.clear()}},TC.Util.detectMobile()?Cesium.ScreenSpaceEventType.LEFT_CLICK:Cesium.ScreenSpaceEventType.MOUSE_MOVE);$("."+i.classes.MAPTHREED).on("mouseout.tc",function(e){t.isPointerOver(e)||t.clear()})}if(i.direction.TO_THREE_D===e){i.map3D.linked2DControls.legend=new function(e){var t=e.map.getControlsByClass(TC.control.Legend)[0];this.refresh=function(){t&&e.map3D.workLayers.length>0&&t.loadGraphics()}}(i);i.map3D.linked2DControls.featureInfo||(i.map3D.linked2DControls.featureInfo=new P(i));new Cesium.ScreenSpaceEventHandler(i.viewer.canvas,!1).setInputAction(function(e){if(!i.viewer.trackedEntity){var t=i.viewer.camera.getPickRay(e.position),n=i.viewer.scene.globe.pick(t,i.viewer.scene);n&&i.map3D.getInfoOnPickedPosition.call(i,n)}},Cesium.ScreenSpaceEventType.LEFT_CLICK)}!i.map3D.linked2DControls.geolocation&&i.allowedControls.indexOf("geolocation")>-1&&(i.map3D.linked2DControls.geolocation=i.ctrlsToMng.filter(function(e){return e instanceof TC.control.Geolocation})[0]);if(i.map3D.linked2DControls.geolocation){var n=i.map3D.linked2DControls.geolocation;if(i.direction.TO_THREE_D===e){n._CHART_SIZE=$.extend({},n.CHART_SIZE);n.CHART_SIZE.MIN_HEIGHT=80;n.CHART_SIZE.MIN_WIDTH=300;var r=[n.Const.Selector.STOP,n.Const.Selector.PAUSE,n.Const.Selector.BACKWARD,n.Const.Selector.FORWARD,n.Const.Selector.DRAW],s=O.bind(i);n.reset=function(){n.CHART_SIZE=n._CHART_SIZE;TC.wrap.control.Geolocation.prototype.setTracking=n._setTracking;TC.wrap.control.Geolocation.prototype.simulateTrack=n._wrap_simulateTrack;TC.wrap.control.Geolocation.prototype.showElevationMarker=n._wrap_showElevationMarker;TC.wrap.control.Geolocation.prototype.hideElevationMarker=n._wrap_hideElevationMarker;n.renderInfoNewPosition=n._renderInfoNewPosition;n.setFormatInfoNewPosition=n._setFormatInfoNewPosition;n.simulateTrack=n._simulateTrack;n.elevationTrack=n._elevationTrack;r.forEach(function(e){$(document).off("click",i.map3D.linked2DControls.geolocation._classSelector+" "+e,s)});n.$events.off(n.Const.Event.IMPORTEDTRACK,s)};r.forEach(function(e){$(document).on("click",i.map3D.linked2DControls.geolocation._classSelector+" "+e,s)});n.$events.on(n.Const.Event.IMPORTEDTRACK,s);var a,o=i,l=!1;n._setTracking=TC.wrap.control.Geolocation.prototype.setTracking;TC.wrap.control.Geolocation.prototype.setTracking=function(e){n._setTracking.call(n.wrap,e);if(e)n.$events.on(n.Const.Event.POSITIONCHANGE,S.bind(i));else{l=!1;n.$events.off(n.Const.Event.POSITIONCHANGE,S.bind(i));if(i.map3D.trackingEntity){i.viewer.entities.removeById(i.map3D.trackingEntity.id);delete i.map3D.trackingEntity}}};n._elevationTrack=n.elevationTrack;n.elevationTrack=function(e,t){o.map3D.linked2DControls.featureInfo&&o.map3D.linked2DControls.featureInfo.clear();o.map3D.linked2DControls.geolocation.track.$info.hasClass(TC.Consts.classes.HIDDEN);t&&O.call(i,{target:{className:"stop"},custom:!0});n._elevationTrack.call(n,e,t)};n.getSelectedTrack().length>0&&n.hasElevation&&n.elevationTrack.call(i,n.getSelectedTrack().first(),!0);n._simulateTrack=n.simulateTrack;n.simulateTrack=function(e){var t=this.map3D.linked2DControls.geolocation;t.map.toast(t.getLocaleString("threed.interactionSimulation"),{type:TC.Consts.msgType.INFO});if(this.viewer.clock.shouldAnimate&&this.map3D.trackDataSource){a();O.call(this,{target:{className:"stop"},custom:!0})}t.simulate_speed=1;t.drawTrack(e,!1);if(t.hasElevation){t.elevationTrack(e);t.chartProgressInit()}if(t.layerTrack&&t.layerTrack.features){var i=t.layerTrack.features.filter(function(e){return e instanceof TC.feature.Polyline})[0];i&&function(e,t,i,n,r,s){var a=$.Deferred(),o=e.map(function(e){var t=TC.Util.reproject(e,this.map.crs,this.map3D.crs);return Cesium.Cartographic.fromDegrees(t[0],t[1])}.bind(this));Cesium.when(Cesium.sampleTerrainMostDetailed(this.viewer.scene.globe.terrainProvider,o),function(r){var o,l,c=0;if(t===ol.geom.GeometryLayout.XYZM){o=e[0][3];l=e[e.length-1][3]}else if(t===ol.geom.GeometryLayout.XYM){o=e[0][2];l=e[e.length-1][2]}else{e[0][3]=r[0].time=Date.now();for(var u=1;u<r.length;u++){var h,p=[];r[u].time=0;p=u+1<r.length?r.slice(u-1,u+1):r.slice(u-1);c+=h=new Cesium.EllipsoidGeodesic(p[0],p[1]).surfaceDistance;e[u][3]=r[u].time=r[u-1].time+36e5*h/s}o=r[0].time;l=r[r.length-1].time}if(0===c)for(u=1;u<r.length;u++){p=[];p=u+1<r.length?r.slice(u-1,u+1):r.slice(u-1);c+=new Cesium.EllipsoidGeodesic(p[0],p[1]).surfaceDistance}o=new Date(o).toISOString();l=new Date(l).toISOString();var d=[{id:"document",name:"CZML Model",version:"1.0"},{id:"path",name:i,availability:o+"/"+l,position:{epoch:o,cartographicRadians:r.map(function(i,n){return t===ol.geom.GeometryLayout.XYZM?[new Date(e[n][3]).toISOString(),i.longitude,i.latitude,i.height]:t===ol.geom.GeometryLayout.XYM?[new Date(e[n][2]).toISOString(),i.longitude,i.latitude,i.height]:[new Date(i.time).toISOString(),i.longitude,i.latitude,i.height]}).reduce(function(e,t){return e.concat(t)})},point:{heightReference:"NONE",pixelSize:n.radius,color:{rgba:n.fillColor},outlineColor:{rgba:n.strokeColor},outlineWidth:n.strokeWidth}}];a.resolve(d,c,e)});return a}.call(this,i.geometry,i.wrap.feature.getGeometry().layout,"track",t.markerStyle,t.lineStyle,t.walkingSpeed).then(function(t,n,r){this.map3D.trackDataSource=new Cesium.DataSourceCollection;var s=new Cesium.DataSourceDisplay({scene:this.viewer.scene,dataSourceCollection:this.map3D.trackDataSource});this.viewer.scene.preRender.addEventListener(function(e,t){s.update(t)});this.map3D.trackDataSource.add(Cesium.CzmlDataSource.load(t)).then(function(t,i,r){this.viewer.clock.shouldAnimate=!1;var s,o;s=r.clock.startTime;o=r.clock.stopTime;this.viewer.clock.startTime=s.clone();this.viewer.clock.stopTime=o.clone();this.viewer.clock.currentTime=s.clone();this.viewer.clock.clockStep=Cesium.ClockStep.TICK_DEPENDENT;this.viewer.clock.clockRange=Cesium.ClockRange.CLAMPED;this.viewer.clock.multiplier=1;var l=r.entities.values[0];l.layout=t;l.tagLI=e;l.availability=new Cesium.TimeIntervalCollection([new Cesium.TimeInterval({start:s,stop:o})]);this.viewer.entities.add(l);this.viewer.flyTo(l).then(function(){this.viewer.trackedEntity=l;var e,t=0;a=this.viewer.scene.preUpdate.addEventListener(function(r,s){if(0===this.map3D.linked2DControls.geolocation.getSelectedTrack().length||this.map3D.linked2DControls.geolocation.getSelectedTrack().length>0&&this.map3D.linked2DControls.geolocation.getSelectedTrack()&&this.map3D.linked2DControls.geolocation.getSelectedTrack().attr("data-id")!==l.tagLI.attr("data-id")||Cesium.JulianDate.greaterThanOrEquals(s,l.availability.stop)){a();O.call(this,{target:{className:"stop"},custom:!0})}else if(this.viewer.clock.shouldAnimate&&l.isAvailable(s)){e||(e=Cesium.Cartographic.fromCartesian(Cesium.Property.getValueOrUndefined(l.position,l.availability.start)));currentPosition=Cesium.Cartographic.fromCartesian(Cesium.Property.getValueOrUndefined(l.position,s));if(this.map3D.linked2DControls.geolocation.hasElevation){l.layout===ol.geom.GeometryLayout.XYZM||(l.layout,ol.geom.GeometryLayout.XYM);this.map3D.linked2DControls.geolocation.chartSetProgress({p:[e.longitude,e.latitude,e.height],d:t},[currentPosition.longitude,currentPosition.latitude,function(e,t){for(var i,n=0,r=TC.Util.reproject(e[0],this.map.crs,this.map3D.crs),s=new Cesium.Cartographic.fromDegrees(r[0],r[1]),a=1;a<e.length;a++){r=TC.Util.reproject(e[a],this.map.crs,this.map3D.crs);var o=new Cesium.Cartographic.fromDegrees(r[0],r[1]);n+=new Cesium.EllipsoidGeodesic(s,o).surfaceDistance;s=o;if(n>t){i=e[a-1];break}}if(i){var c=l.layout===ol.geom.GeometryLayout.XYZM?2:l.layout===ol.geom.GeometryLayout.XYZ?2:-1;if(c>-1)return i[c]}return 0}.call(this,i,t)],n,(l.layout===ol.geom.GeometryLayout.XYZM||l.layout===ol.geom.GeometryLayout.XYM)&&this.map3D.linked2DControls.geolocation._getTime(Cesium.JulianDate.toDate(l.availability.start),Cesium.JulianDate.toDate(s)))}t+=new Cesium.EllipsoidGeodesic(e,currentPosition).surfaceDistance;e=currentPosition}}.bind(this));this.viewer.clock.shouldAnimate=!0}.bind(this));this.viewer.scene.requestRender()}.bind(this,i.wrap.feature.getGeometry().layout,r))}.bind(this))}}.bind(i);n._wrap_simulateTrack=TC.wrap.control.Geolocation.prototype.simulateTrack;TC.wrap.control.Geolocation.prototype.simulateTrack=function(){this.parent.hasElevation&&this.parent.chartProgressInit()};n._wrap_showElevationMarker=TC.wrap.control.Geolocation.prototype.showElevationMarker;TC.wrap.control.Geolocation.prototype.showElevationMarker=function(e){const t=this.map3D.linked2DControls.geolocation,i=t.chart.coordinates;if(t.layerTrack.getVisibility()&&t.layerTrack.getOpacity()>0){var n=this.viewer.camera,r=TC.Util.reproject(i[e[0].index],this.map.crs,this.map3D.crs);if(t.elevationMarker){t.elevationMarker.position=Cesium.Cartesian3.fromDegrees(r[0],r[1],n.positionCartographic.height);this.viewer.scene.requestRender()}else{var s=new Cesium.Entity({position:Cesium.Cartesian3.fromDegrees(r[0],r[1]),billboard:{image:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4AcdDDMq7Am38gAAAaFJREFUWMPtlj9rwkAYh3+R0lgKRSi4FCFmczBzp2i+gaMgmK0I3Tq0Y6HDDd0L0tJBSyGbAT9AxI+goFskumUUrDq9XVRi6WkS/xXquyRc7nie++XuOOBYx/rvJYQdqKoqNE1barMsC81mc/cCqqri+eWVfvt2f3sjBJE4CSMwn/kkXVpqj7bL0DQtUAqRTf9hhixkyAo9PnLoRbhWQNd1KIoSGqAoysrxkXXwh8cnMsw6McYCwxljMMw6GWadeBIrBSRJwnA0hivryOULgSQYY8jlC+TKOoajMWKx2Ga7wJV15OwKARCm06lv+FYX4TwJURS5fURR9A0PJBC3q0sSvH5eeLRd3t5BlEomALsKVy6CN7tJuoSJR3g4+tpeAt3eAKlkYpHEurRSycTmArVaDRfnZ7Poi74k5vBub4DT6zsAwFX8Eo7jBBdotVowjU8hbld8SXjhrlyctVXw8f4m8AR87+mO7VADWWogSx27T0S0eHrfO3bf088JdYAFkvDWzuB+JHYOXyWxNzhPYq9wfhJ7hP+UOAjc74XjWH++vgFLJ1bBWXZtUAAAAABJRU5ErkJggg==",eyeOffset:new Cesium.Cartesian3(0,0,-100),verticalOrigin:Cesium.VerticalOrigin.BOTTOM,heightReference:Cesium.HeightReference.CLAMP_TO_GROUND}});t.elevationMarker=this.map3D.addNativeFeature.call(this,s)}}}.bind(i);n._wrap_hideElevationMarker=TC.wrap.control.Geolocation.prototype.hideElevationMarker;TC.wrap.control.Geolocation.prototype.hideElevationMarker=function(){const e=this.map3D.linked2DControls.geolocation;this.map3D.removeFeature.call(this,e.elevationMarker);e.elevationMarker=null}.bind(i);n._renderInfoNewPosition=n.renderInfoNewPosition;n.renderInfoNewPosition=function(e){var t=this;t.getRenderedHtml(t.CLASS+"-tracking-toast",t.setFormatInfoNewPosition(e.pd),function(e){t.track.$info.find(".prpanel-body").html(e);t.trackingActive.set(!0);if(!l){o.map3D.linked2DControls.featureInfo&&o.map3D.linked2DControls.featureInfo.clear();o.map3D.linked2DControls.geolocation.track&&o.map3D.linked2DControls.geolocation.track.$info.removeClass(TC.Consts.classes.HIDDEN);o.map3D.linked2DControls.geolocation.resultsPanelChart&&o.map3D.linked2DControls.geolocation.resultsPanelChart.close()}l||(l=!0)})};n._setFormatInfoNewPosition=n.setFormatInfoNewPosition;n.setFormatInfoNewPosition=function(e){var t={},i=TC.Util.getMapLocale(this.map),n=TC.Util.reproject(e.position,this.map.crs,this.map3D.crs);t.x=n[0].toLocaleString(i);t.y=n[1].toLocaleString(i);t.z=Math.round(e.altitude).toLocaleString(i);t.accuracy=Math.round(e.accuracy).toLocaleString(i);t.speed=e.speed.toLocaleString(i,{minimumFractionDigits:1,maximumFractionDigits:1});var r=new Cesium.Cartographic(Cesium.Math.toRadians(n[0]),Cesium.Math.toRadians(n[1])),s=this.viewer.scene.globe.getHeight(r);s&&(t.mdt=Math.round(s).toLocaleString(i));t.isGeo=!0;return t}.bind(i)}else if(i.map3D.linked2DControls.geolocation.getSelectedTrack().length>0&&i.map3D.linked2DControls.geolocation.hasElevation){n.CHART_SIZE.MIN_HEIGHT=n._CHART_SIZE.MIN_HEIGHT;n.CHART_SIZE.MIN_WIDTH=n._CHART_SIZE.MIN_WIDTH;n._elevationTrack.call(i.map3D.linked2DControls.geolocation,i.map3D.linked2DControls.geolocation.getSelectedTrack().first(),!0)}}},x=function(e){var t,i,n,r=this,s=function(e){var t=new Cesium.Cartesian2(this.viewer.scene.canvas.clientWidth/2,this.viewer.scene.canvas.clientHeight/2);this.map3D.zoomToCartesian.call(this,{endPosition:t},e)};if(e){t=function(e){e.stopPropagation&&e.stopPropagation();e.preventDefault&&e.preventDefault();var t=TC.Util.reproject(this.map.options.initialExtent.slice(0,2),this.map.crs,this.map3D.crs),i=TC.Util.reproject(this.map.options.initialExtent.slice(2),this.map.crs,this.map3D.crs),n=Cesium.Rectangle.fromDegrees(t[0],t[1],i[0],i[1]);this.map3D.flyToRectangle.call(this,n,{duration:.1});return!1}.bind(r);i=function(e){s.call(r,200)}.bind(r);n=function(e){s.call(r,-200)}.bind(r);$("."+TC.control.NavBar.prototype.CLASS+"-btn-home").on("click",t);$("."+TC.control.NavBar.prototype.CLASS+"-btn-zoomin").on("click",i);$("."+TC.control.NavBar.prototype.CLASS+"-btn-zoomout").on("click",n)}else{$("."+TC.control.NavBar.prototype.CLASS+"-btn-home").off("click",t);$("."+TC.control.NavBar.prototype.CLASS+"-btn-zoomin").off("click",i);$("."+TC.control.NavBar.prototype.CLASS+"-btn-zoomout").off("click",n)}},{crs:"EPSG:4326",crsPattern:/(EPSG\:?4326)/i,customRender:null,baseLayer:null,workLayers:[],vector2DLayers:[],vector2DFeatures:{},linked2DControls:{},isLoadingTiles:function(){var e=this.viewer.scene.globe._surface;return!e._tileProvider.ready||e._tileLoadQueueHigh.length>0||e._tileLoadQueueMedium.length>0||e._tileLoadQueueLow.length>0||e._debug.tilesWaitingForChildren>0},loadViewer:function(){var e=this,t=new $.Deferred;e.viewer?t.resolve(e.viewer):TC.loadJS(!window.Cesium,TC.Consts.url.CESIUM,function(){var i=new Cesium.Globe;i.baseColor=Cesium.Color.WHITE;i.enableLighting=!0;i.tileCacheSize=1e3;i.maximumScreenSpaceError=5;e.viewer=e.map3D.viewer=new Cesium.Viewer(e.selectors.divThreedMap,{terrainProvider:new Cesium.CesiumTerrainProvider({url:e.Consts.TERRAIN_URL}),terrainExaggeration:1,terrainShadows:Cesium.ShadowMode.DISABLED,animation:!1,timeline:!1,fullscreenButton:!1,baseLayerPicker:!1,imageryProvider:!1,navigationInstructionsInitiallyVisible:!1,navigationHelpButton:!1,geocoder:!1,homeButton:!1,infoBox:!1,sceneModePicker:!1,selectionIndicator:!1,globe:i,requestRenderMode:!0,maximumRenderTimeChange:1/0});e.viewer.readyPromise=new $.Deferred;e.viewer.scene.backgroundColor=Cesium.Color.WHITE;e.viewer.scene.screenSpaceCameraController.enableCollisionDetection=!0;e.viewer.scene.screenSpaceCameraController.maximumZoomDistance=1e6;e.viewer.scene.globe.depthTestAgainstTerrain=!1;e.viewer.scene.imageryLayers.removeAll();e.viewer.terrainProvider.errorEvent.addEventListener(function(e){if(e.error)switch(e.error.statusCode){case 403:case 404:console.log("es un 404 de terreno")}},e);e.viewer.scene.renderError.addEventListener(function(e,t){if(t&&18===t.code);else{this.$divThreedMap.removeClass(this.classes.LOADING);this.map.toast(this.getLocaleString("fi.error"),{type:TC.Consts.msgType.ERROR});this.$button.click()}},e);e.map3D.tileLoadingHandler=new Cesium.EventHelper;e.map3D.tileLoadingHandler.add(e.viewer.scene.globe.tileLoadProgressEvent,function(t){e.waiting||(e.waiting=e.map.getLoadingIndicator().addWait());if(e.viewer.scene.terrainProvider.ready&&0===t){e.map.getLoadingIndicator().removeWait(e.waiting);delete e.waiting;e.viewer.readyPromise.resolve();e.$events.trigger(TC.Consts.event.TERRAINLOADED,{})}else e.$events.trigger(TC.Consts.event.TERRAINRECEIVING,{})}.bind(e));x.call(e,!0);$(".cesium-viewer-bottom").remove();e.map3D._event2DHandler=function(e){var t=e.type+".tc";switch(!0){case t==TC.Consts.event.BEFOREBASELAYERCHANGE:this.waiting||(this.waiting=this.map.getLoadingIndicator().addWait());break;case t==TC.Consts.event.BASELAYERCHANGE:this.map3D.setBaseLayer.call(this,e.layer);break;case t==TC.Consts.event.LAYERADD:this.map3D.addLayer.call(this,e.layer);break;case t==TC.Consts.event.LAYERREMOVE:this.map3D.removeLayer.call(this,e.layer);break;case t==TC.Consts.event.LAYERVISIBILITY:this.map3D.setRenderOptionsLayer.call(this,e.layer,{visibility:e.layer.getVisibility()});break;case t==TC.Consts.event.LAYEROPACITY:this.map3D.setRenderOptionsLayer.call(this,e.layer,{opacity:e.layer.getOpacity()});break;case t==TC.Consts.event.LAYERORDER:for(var i=0;i<this.map3D.workLayers.length;i++)if(this.map3D.workLayers[i].imageryProvider&&this.map3D.workLayers[i].imageryProvider.layers.join(",")===e.layer.names.join(",")){if(e.oldIndex>e.newIndex)for(var n=e.oldIndex-e.newIndex,r=0;r<n;r++)this.viewer.scene.imageryLayers.lower(this.map3D.workLayers[i]);else for(n=e.newIndex-e.oldIndex,r=0;r<n;r++)this.viewer.scene.imageryLayers.raise(this.map3D.workLayers[i]);this.map3D.workLayers.splice(e.newIndex,0,this.map3D.workLayers.splice(e.oldIndex,1)[0]);break}break;case t==TC.Consts.event.FEATUREADD:this.map3D.addFeature.call(this,e.feature);break;case t==TC.Consts.event.FEATUREREMOVE:case t==TC.Consts.event.FEATURESCLEAR:if(this.map3D.vector2DFeatures&&this.map3D.vector2DFeatures.hasOwnProperty(e.layer.id)){var s=this.map3D.vector2DFeatures[e.layer.id];for(i=0;i<s.length;i++)this.map3D.removeFeature.call(this,s[i]);delete this.map3D.vector2DFeatures[e.layer.id]}break;case t==TC.Consts.event.ZOOM:if(this.map3D.cameraControls&&!this.map3D.cameraControls.moving){var a=this.map3D.viewer.scene.canvas.clientWidth,o=this.map3D.viewer.scene.canvas.clientHeight;if(!this.map3D._canvasClientHeight||!this.map3D._canvasClientWidth||a!==this.map3D._canvasClientWidth||o!==this.map3D._canvasClientHeight){this.map3D._canvasClientWidth||(this.map3D._canvasClientWidth=this.map3D.viewer.scene.canvas.clientWidth);this.map3D._canvasClientHeight||(this.map3D._canvasClientHeight=this.map3D.viewer.scene.canvas.clientHeight);this.map3D._canvasClientWidth=a;this.map3D._canvasClientHeight=o;return}this.map3D.flyToMapCoordinates.call(this,this.mapView.getCenter())}break;case t==TC.Consts.event.ZOOMTO:if(this.lastZoom&&performance.now()-this.lastZoom<50)return;this.lastZoom=performance.now();var l=TC.Util.reproject(e.extent.slice(0,2),this.map.crs,this.map3D.crs),c=TC.Util.reproject(e.extent.slice(2),this.map.crs,this.map3D.crs),u=Cesium.Rectangle.fromDegrees(l[0],l[1],c[0],c[1]);this.map3D.flyToRectangle.call(this,u)}}.bind(e);e.map.on(b.join(" "),e.map3D._event2DHandler);A.call(e,e.direction.TO_THREE_D);(function(){var e=this;e.map.workLayers.filter(function(e){return e instanceof TC.layer.Vector}).forEach(function(t){t.features.forEach(function(t){e.map3D.addFeature.call(e,t)})})}).call(e);t.resolve(e.viewer)});return t},setBaseLayer:function(e){var t=this,i=function(e){if(!n(e,t.map3D.crs))if(null!==e.getFallbackLayer()&&n(e.getFallbackLayer(),t.map3D.crs))e=e.getFallbackLayer();else{t.map.toast(t.getLocaleString("threed.crsNoCompatible",{name:e.layerNames}));e=null}return e};if(t.map3D.baseLayer){if(t.map3D.baseLayer!==t.Consts.BLANK_BASE){t.viewer.scene.imageryLayers.raiseToTop(t.map3D.baseLayer);t.viewer.scene.imageryLayers.remove(t.map3D.baseLayer,!0)}if(e instanceof TC.layer.Vector){t.map3D.baseLayer=t.Consts.BLANK_BASE;t.map.getLoadingIndicator().removeWait(t.waiting);delete t.waiting}else if(e=i(e)){e.map=t.map;e.isBase=!0;t.map3D.addLayer.call(t,e)}}else{(function(e){var t=this,i=e.baseLayer instanceof TC.layer.Raster;if(i){if(!n(e.baseLayer,t.map3D.crs)){var r=e.baseLayer.getFallbackLayer();r&&!n(r,t.map3D.crs)&&e.toast(t.getLocaleString("threed.baseLayerNoCompatible",{name:e.baseLayer.layerNames}))}}else C.baseVector=e.baseLayer;if(0===C.baseMaps.length){var s=e.baseLayers.filter(function(e){return!n(e,t.map3D.crs)}).filter(function(e,i){return!e.getFallbackLayer()||!n(e.getFallbackLayer(),t.map3D.crs)});if(s.length>0)for(var a=0;a<e.baseLayers.length;a++)s.indexOf(e.baseLayers[a])>-1&&C.baseMaps.push({l:e.baseLayers[a],i:a})}C.baseMap=i?e.baseLayer:t.Consts.BLANK_BASE}).call(t,t.map);(function(e){var t=!1;if(C.baseMaps&&C.baseMaps.length){for(var i=0;i<C.baseMaps.length;i++)for(var n=0;n<e.baseLayers.length;n++)if(e.baseLayers[n]===C.baseMaps[i].l){C.baseMap==e.baseLayers[n]&&(t=!0);e.$events.trigger($.Event(TC.Consts.event.LAYERREMOVE,{layer:e.baseLayers[n]}));e.baseLayers.splice(n,1);break}if(t){e.baseLayer=e.baseLayers[0];e.$events.trigger($.Event(TC.Consts.event.BASELAYERCHANGE,{layer:e.baseLayer}))}}}).call(t,t.map);if(e.type===TC.Consts.layerType.WMTS||e.type===TC.Consts.layerType.WMS){if(e.options.relatedWMTS){t.map.baseLayer=e=t.map.getLayer(e.options.relatedWMTS);t.map.$events.trigger($.Event(TC.Consts.event.BASELAYERCHANGE,{layer:t.map.baseLayer}))}else if(e=i(e)){e.isBase||(e.isBase=!0);t.map3D.addLayer.call(t,e)}}else t.map3D.baseLayer=t.Consts.BLANK_BASE}C.baseMap=t.map.baseLayer},addLayer:function(e){var t=this;switch(!0){case TC.Consts.layerType.VECTOR==e.type:t.map3D.vector2DLayers.push(e);break;case TC.Consts.layerType.WMTS==e.type:case TC.Consts.layerType.WMS==e.type:e.isBase||e.isCompatible(t.map3D.crs)?v.convert(e,t.map3D.crs).then(function(i){if(i){if(void 0!==i.enablePickFeatures){i.enablePickFeatures=!1;i.tcLayer=e}var n=t.viewer.scene.imageryLayers.addImageryProvider(i);if(e.isBase){t.map3D.baseLayer=n;t.viewer.scene.imageryLayers.lowerToBottom(n)}else{n.show=e.getVisibility();n.alpha=e.getOpacity();t.map3D.workLayers.push(n);t.map3D.linked2DControls.legend.refresh()}}}):t.map.toast(t.getLocaleString("threed.crsNoCompatible",{name:e.layerNames}))}},removeLayer:function(e){switch(!0){case TC.Consts.layerType.VECTOR==e.type:if(this.map3D.vector2DFeatures&&this.map3D.vector2DFeatures.hasOwnProperty(e.id)){for(var t=this.map3D.vector2DFeatures[e.id],i=0;i<t.length;i++)this.map3D.removeFeature.call(this,t[i]);delete this.map3D.vector2DFeatures[e.id]}break;case TC.Consts.layerType.WMTS==e.type:case TC.Consts.layerType.WMS==e.type:for(i=0;i<this.map3D.workLayers.length;i++)if(e.names&&this.map3D.workLayers[i].imageryProvider.layers.join(",")===e.names.join(",")||e.title&&this.map3D.workLayers[i].imageryProvider.layers.join(",")===e.title){this.viewer.scene.imageryLayers.raiseToTop(this.map3D.workLayers[i]);this.viewer.scene.imageryLayers.remove(this.map3D.workLayers[i],!0);this.map3D.workLayers.splice(i,1);break}}},setRenderOptionsLayer:function(e,t){switch(!0){case TC.Consts.layerType.VECTOR==e.type:if(this.map3D.vector2DFeatures[e.id])for(var i=this.map3D.vector2DFeatures[e.id],n=0;n<i.length;n++)this.map3D.setRenderOptionsFeature(i[n],{show:e.getVisibility()});break;case TC.Consts.layerType.WMTS==e.type:case TC.Consts.layerType.WMS==e.type:for(n=0;n<this.map3D.workLayers.length;n++)if(e.names&&this.map3D.workLayers[n].imageryProvider.layers.join(",")===e.names.join(",")||e.title&&this.map3D.workLayers[n].imageryProvider.layers.join(",")===e.title){t.hasOwnProperty("visibility")&&(this.map3D.workLayers[n].show=t.visibility);t.hasOwnProperty("opacity")&&(this.map3D.workLayers[n].alpha=t.opacity);break}}},flyToMapCoordinates:function(e){var t=TC.Util.reproject(e,this.map.crs,this.map3D.crs),i=Cesium.Cartesian3.fromDegrees(t[0],t[1],this.viewer.camera.positionCartographic.height),n=this.viewer.camera;n.flyTo({destination:i,orientation:{heading:n.heading,pitch:n.pitch}})},flyToRectangle:function(e,t){var i=this;i.viewer.scene.camera.cancelFlight();var n=$.Deferred();t=t||{};var r=Cesium.Math.EPSILON3;if(e.east===e.west){e.east+=r;e.west-=r}if(e.north===e.south){e.north+=r;e.south-=r}var s=.2*e.width/2,a=.2*e.height/2;e.east-=s;e.west+=a;e.north+=a;e.south-=a;var o=i.viewer.scene,l=o.camera,c=l.getRectangleCameraCoordinates(e),u=Cesium.Ellipsoid.WGS84.cartesianToCartographic(c);Cesium.when(Cesium.sampleTerrainMostDetailed(o.globe.terrainProvider,[Cesium.Rectangle.center(e)]),function(e){var r={longitude:u.longitude,latitude:u.latitude,height:u.height+e[0].height};l.flyTo({duration:t.duration||1,destination:Cesium.Ellipsoid.WGS84.cartographicToCartesian(r),complete:function(){var e=Cesium.Math.toRadians(50),t=h(this.viewer.scene);t=Cesium.Matrix4.fromTranslation(t);this.map3D.rotateAroundAxis(this.viewer.scene.camera,-e,this.viewer.scene.camera.right,t,{duration:250,callback:function(){n.resolve()}})}.bind(i)})});return n},zoomToCartesian:function(e,t){var i=this,n=i.viewer.scene;if(!e||!e.endPosition){var r=n.canvas,s=new Cesium.Cartesian2(r.clientWidth/2,r.clientHeight/2);e={endPosition:s}}var a=n.camera.getPickRay(e.endPosition),o=n.globe.pick(a,n);if(o){var l=Cesium.Cartesian3.distance(a.origin,o);if(l<1)return;i.map3D._zoomTo||(i.map3D._zoomTo={amount:0});i.map3D._zoomTo.direction=t>0?1:0;i.map3D._zoomTo.amount+=5*l/100;i.map3D._zoomTo.endPosition=e.endPosition}setTimeout(function(){(function(t){var i=this.viewer.scene,n=i.camera.getPickRay(e.endPosition||t.endPosition),r=i.globe.pick(n,i);if(r){if(Cesium.Cartesian3.distance(n.origin,r)<1)return;var s=i.camera.position,a=(i.camera.direction,toGo=new Cesium.Cartesian3);Cesium.Cartesian3.multiplyByScalar(n.direction,1==t.direction?t.amount:-t.amount,a);Cesium.Cartesian3.add(s,a,toGo);var o=new Cesium.Ray(toGo,n.direction),l=i.globe.pick(o,i);l&&(Cesium.Cartesian3.distance(toGo,l)<1||Math.abs(Cesium.Ellipsoid.WGS84.cartesianToCartographic(toGo).height)<i.screenSpaceCameraController.minimumZoomDistance?function(){this.map3D._zoomTo={direction:1,amount:0,endPosition:{}}}.call(this):this.viewer.camera.flyTo({destination:toGo,orientation:{heading:i.camera.heading,pitch:i.camera.pitch,roll:i.camera.roll},duration:1,easingFunction:Cesium.EasingFunction.LINEAR_NONE,complete:function(e){this.map3D._zoomTo={direction:1,amount:0,endPosition:{}}}.bind(this,Cesium.Cartesian3.distance(toGo,l))}))}}).call(i,i.map3D._zoomTo)}.bind(i),50)},rotateAroundAxis:function(e,t,i,n,r){return l(e,t,i,n,r)},addFeature:function(e,t){var i=this,n=function(){var t=T.convert(i.viewer.scene,e,i.map.crs,i.map3D.crs);if(t)if("function"==typeof t.geometry)t.geometry(i.viewer.terrainProvider).then(function(t){if(t instanceof Array)t.forEach(function(t){if(t instanceof Array)t.forEach(function(t){t=L.call(i,t);w(i.map3D,e.layer.id,t)});else{t=L.call(i,t);w(i.map3D,e.layer.id,t)}});else{var n=L.call(i,t);w(i.map3D,e.layer.id,n)}});else if(t.geometry instanceof Array)t.geometry.forEach(function(t){t=L.call(i,t);w(i.map3D,e.layer.id,t)});else{var n=L.call(i,t.geometry);w(i.map3D,e.layer.id,n)}};if(!i.map3D.linked2DControls.coordinates||i.map3D.linked2DControls.coordinates.layer!=e.layer)if(i.map3D.linked2DControls.featureInfo&&i.map3D.linked2DControls.featureInfo.get2DMarker()===e||i.map3D.linked2DControls.featureInfo&&i.map3D.linked2DControls.featureInfo.isPending())setTimeout(function(){i.map3D.linked2DControls.featureInfo.get2DMarker()!==e&&n()},5);else{if(i.map3D.linked2DControls.geolocation&&i.map3D.linked2DControls.geolocation.layerTracking===e.layer&&e instanceof TC.feature.Polyline)return;n()}},removeFeature:function(e){if(e){switch(!0){case e instanceof Cesium.GroundPrimitive:this.viewer.scene.groundPrimitives.remove(e);break;case e instanceof Cesium.Billboard:this.viewer.billboardCollection.remove(e);break;case e instanceof Object:this.viewer.entities.removeById(e.id)}this.viewer.scene.requestRender()}},setRenderOptionsFeature:function(e,t){e&&(e.show=t.show)},addNativeFeature:function(e){return L.call(this,e)},setCameraFromMapView:function(){var e=this;e.viewer.scene.globe.terrainProvider.readyPromise.then(function(){var t=e.mapView.getCenter();if(t){var i=TC.Util.reproject(t,e.map.crs,e.map3D.crs),n=function(e,t){var i=this.viewer.camera.frustum.fovy,n=e*this.mapView.viewHTML.getBoundingClientRect().height,r=Math.cos(Math.abs(t));return n*this.mapView.metersPerUnit*r/2/Math.tan(i/2)}.call(e,e.mapView.getResolution()||0,Cesium.Math.toRadians(i[0])),r=(i=TC.Util.reproject(t,e.map.crs,e.map3D.crs),new Cesium.Cartographic(Cesium.Math.toRadians(i[0]),Cesium.Math.toRadians(i[1])));e.viewer.scene.globe&&(r.height=e.viewer.scene.globe.getHeight(r)||0);var s=function(){var t=Cesium.Ellipsoid.WGS84.cartographicToCartesian(r),i={pitch:Cesium.Math.toRadians(-90),heading:-e.mapView.getRotation(),roll:0};e.viewer.camera.setView({destination:t,orientation:i});e.viewer.camera.moveBackward(n)};0===r.height?TC.loadJS(!TC.tool||!TC.tool.Elevation,TC.apiLocation+"TC/tool/Elevation",function(){e.map3D.elevationTool=new TC.tool.Elevation;e.map3D.elevationTool.getElevation({crs:e.map3D.crs,coordinates:i}).then(function(e){r.height=e[0][2]?e[0][2]:0;s()})}):s()}})},setViewFromCameraView:function(){if(!this.setViewFromCameraViewInProgress||"resolved"==this.setViewFromCameraViewInProgress.state()){this.setViewFromCameraViewInProgress=new $.Deferred;var e=Cesium.Ellipsoid.WGS84,t=this.viewer.scene;target_=u(t);if(!target_){var i=this.viewer.scene.globe,n=this.viewer.camera.positionCartographic.clone(),r=i.getHeight(n);n.height=r||0;target_=Cesium.Ellipsoid.WGS84.cartographicToCartesian(n)}var s=Cesium.Cartesian3.distance(target_,this.viewer.camera.position),a=e.cartesianToCartographic(target_),l=TC.Util.reproject([Cesium.Math.toDegrees(a.longitude),Cesium.Math.toDegrees(a.latitude)],this.map3D.crs,this.map.crs);this.mapView.setCenter(l);this.mapView.setResolution(o.call(this,s,a?a.latitude:0));this.setViewFromCameraViewInProgress.resolve()}return this.setViewFromCameraViewInProgress},getInfoOnPickedPosition:function(e){var t=this;if(e){t.map.one(TC.Consts.event.DRAWTABLE,function(e){t.map.getLoadingIndicator().removeWait(t.waiting);delete t.waiting});t.map3D.linked2DControls.featureInfo.send.call(t,e).then(function(e){t.map.getLoadingIndicator().removeWait(t.waiting);delete t.waiting})}},destroy:function(){this.map3D.vector2DLayers=[];this.map3D.vector2DFeatures={};this.map.off(b.join(" "),this.map3D._event2DHandler);A.call(this,this.direction.TO_TWO_D);x.call(this,!1);(function(e){if(C.baseMaps&&C.baseMaps.length)for(var t=0;t<C.baseMaps.length;t++){this.map.$events.trigger($.Event(TC.Consts.event.LAYERADD,{layer:C.baseMaps[t].l}));this.map.baseLayers.splice(C.baseMaps[t].i,0,C.baseMaps[t].l)}}).call(this);this.map.baseLayer=C.baseMap==this.Consts.BLANK_BASE?C.baseVector:C.baseMap;this.map.$events.trigger($.Event(TC.Consts.event.BASELAYERCHANGE,{layer:this.map.baseLayer}));C.baseMap="";this.map3D.baseLayer=null;this.map3D.workLayers=[];this.map3D.cameraControls.unbind();this.map3D.linked2DControls.featureInfo&&this.map3D.linked2DControls.featureInfo.reset();this.map3D.linked2DControls.coordinates&&this.map3D.linked2DControls.coordinates.clear();if(this.map3D.linked2DControls.geolocation){this.map3D.linked2DControls.geolocation.isGeo=!1;this.map3D.linked2DControls.geolocation.reset()}this.map3D.tileLoadingHandler.removeAll();delete this.map3D.tileLoadingHandler}});e.browserSupportWebGL=function(){var e=!1;if(window.WebGLRenderingContext){var t=document.createElement("canvas"),i={alpha:!1,stencil:!1,failIfMajorPerformanceCaveat:!0};try{var n=t.getContext("webgl",i)||t.getContext("experimental-webgl",i)||t.getContext("webkit-3d",i)||t.getContext("moz-webgl",i);if(n)e=!0;else{i.failIfMajorPerformanceCaveat=!1;if(n=t.getContext("webgl",i)||t.getContext("experimental-webgl",i)||t.getContext("webkit-3d",i)||t.getContext("moz-webgl",i)){e="slow";this.isSlower=!0}else e=!1}}catch(e){console.log(E)}if("slow"===e||!e){var r="slow"===e?"threed.slowSupport.supported":"threed.not.supported";this.map.toast(this.getLocaleString(r),{type:TC.Consts.msgType.WARNING,duration:1e4})}return e}e=!1}}();TC.layer=TC.layer||{};TC.Layer||TC.syncLoadJS(TC.apiLocation+"TC/Layer");TC.Consts.BLANK_IMAGE="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAQAIBRAA7";!function(){var e={},t=!TC.isLegacy&&window.hasOwnProperty("Worker"),i=$.Deferred();if(t){var n=TC.apiLocation+"TC/workers/tc-caps-web-worker.js";TC.Util.isSameOrigin(TC.apiLocation)?i.resolve(n):$.ajax({url:n,type:"GET",dataType:"text"}).then(function(e){var t=new Blob([e],{type:"text/javascript"}),n=window.URL.createObjectURL(t);i.resolve(n)},function(e){i.reject()})}var r=function(e,i){TC._capabilitiesRequests=TC._capabilitiesRequests||[];return TC._capabilitiesRequests[e]=!i&&TC._capabilitiesRequests[e]||$.ajax({url:i?TC.proxify(e):e,type:"GET",dataType:t?"text":"xml"})},s=function(e,t){var i="No se pudo obtener el documento de capacidades de servicio "+e.url+": ["+t+"]";e._capabilitiesPromise.reject(i);TC.error(i);e.map&&e.map.$events.trigger($.Event(TC.Consts.event.LAYERERROR,{layer:e,reason:"couldNotGetCapabilities"}));e.wrap.setLayer(null)},a=function(e,t){TC.loadJS(!window.localforage,[TC.Consts.url.LOCALFORAGE],function(){var i=e.CAPABILITIES_STORE_KEY_PREFIX+e.options.url,n=function(){t.hasOwnProperty("error")||$.when(e._capabilitiesPromise).then(function(){var e=t._capabilitiesURL;delete t._capabilitiesURL;localforage.setItem(i,t).then(function(){t._capabilitiesURL=e}).catch(function(e){console.log(e)})})};e.map?e.map.loaded(n):n()})},o=function(n,r){var s;if(r.documentElement){if($(r).find("ServiceException").length>0)s={error:$(r).find("ServiceException").text()};else{var o=n.type===TC.Consts.layerType.WMTS?new n.wrap.WmtsParser:new n.wrap.WmsParser;s=o.read(r);n.type===TC.Consts.layerType.WMTS&&s.Contents&&s.Contents.Layer&&$("Layer",r).each(function(e,t){var i=TC.Util.getElementByNodeName(t,"ows:Identifier")[0].firstChild.data,n=$(t),r=s.Contents.Layer.filter(function(e){return e.Identifier==i});if(r.length){r=r[0];for(var a=0;a<r.TileMatrixSetLink.length;a++){var o=r.TileMatrixSetLink[a];matrixId=o.TileMatrixSet;xmlLink=n.find("TileMatrixSetLink").each(function(e,t){return $(t).find("TileMatrixSet:first").text()==matrixId});if(xmlLink.length){xmlLink=xmlLink[0];o.TileMatrixSetLimits=[];$(xmlLink).find("TileMatrixLimits").each(function(e,t){var i=$(t);o.TileMatrixSetLimits.push({TileMatrix:i.find("TileMatrix").text(),MinTileRow:parseInt(i.find("MinTileRow").text()),MinTileCol:parseInt(i.find("MinTileCol").text()),MaxTileRow:parseInt(i.find("MaxTileRow").text()),MaxTileCol:parseInt(i.find("MaxTileCol").text())})})}}}})}e[n.url].resolve(s);a(n,s)}else if(t&&"string"==typeof r)i.then(function(t){var i=new Worker(t);i.onmessage=function(t){if("success"===t.data.state){s=t.data.capabilities;a(n,s)}else s={error:"Web worker error"};e[n.url].resolve(s);i.terminate()};i.postMessage({type:n.type,text:r})});else{s=r;e[n.url].resolve(s)}},l=function(e){var t;if(!e.wrap.layer){switch(e.type){case TC.Consts.layerType.GROUP:break;case TC.Consts.layerType.WMTS:t=u(e);break;default:t=c(e)}e.wrap.setLayer(t)}},c=function(e){var t=$.isArray(e.names)?e.names.join(","):e.names,i=e.options.format,n=e.options,r={LAYERS:t,FORMAT:i,TRANSPARENT:e.transparent,VERSION:e.capabilities.version||"1.3.0"};e.params&&$.extend(r,e.params);e.queryParams&&$.extend(r,e.queryParams);var s=e.getPreferredInfoFormat();null!==s&&(r.INFO_FORMAT=s);return e.wrap.createWMSLayer(e.getGetMapUrl(),r,n)},u=function(e){return e.wrap.createWMTSLayer(e.options)},h=function e(t,i){var n=$.inArray(i.name,t.availableNames);if(-1===n)for(var r=0,s=i.children.length;r<s&&-1===(n=e(t,i.children[r]));r++);return n},p=function e(t,i,n){var r=!1;n.count=n.count+1;if(t.name===i)r=!0;else for(var s=t.children.length-1;s>=0;s--)if(e(t.children[s],i,n)){r=!0;break}return r},d=function(e,t,i){var n=$.Deferred();r(e,!1).done(function(e){n.resolve(!0);t&&$.isFunction(t)&&t(e)}).fail(function(e){n.resolve(!1);i&&$.isFunction(i)&&i(e)});return n.promise()},f=function(e,t,i){return d(e.replace(this.PROTOCOL_REGEX,"https://"),t,i)},m=function(e,t,i){return d(e,t,i)},y=function(e,t){var i,n,r=$.Deferred(),s=document.createElement("img");s.crossOrigin="anonymous";$.isFunction(s.onload)&&(i=s.onload);s.onload=function(){try{var e=function(e){var t=document.createElement("CANVAS"),i=t.getContext("2d");t.height=e.height;t.width=e.width;i.drawImage(e,0,0);return t}(s);result=e.toDataURL("image/png");if(t){t.image_=s;t.state=ol.ImageState.LOADED;t.changed()}r.resolve(!0)}catch(e){if(18===e.code)r.resolve(!1);else{if(t){t.image_=s;t.state=ol.ImageState.LOADED;t.changed()}r.resolve(!0)}}s.onload=void 0;s.onerror=void 0;i&&$.isFunction(i)&&i()};$.isFunction(s.onerror)&&(n=s.onerror);s.onerror=function(){s.onload=void 0;s.onerror=void 0;r.resolve(!1);n&&$.isFunction(n)&&n()};s.src=e;return r.promise()};TC.layer.Raster=function(){this._capabilitiesPromise=null;TC.Layer.apply(this,arguments);this.wrap=new TC.wrap.layer.Raster(this);this.transparent=!1!==this.options.transparent;this.url=this.options.url;this.params=this.options.params;if("string"==typeof this.options.layerNames)this.names=this.availableNames=this.options.layerNames.split(",");else{this.names=[];this.availableNames=[];if($.isArray(this.options.layerNames))for(var t=0;t<this.options.layerNames.length;t++){if("string"==typeof(u=this.options.layerNames[t])){this.names.push(u);this.availableNames.push(u)}else if(u.hasOwnProperty("name")){this.availableNames.push(u.name);(void 0===u.isVisible||u.isVisible)&&this.names.push(u.name)}}else{var i=this.options.params?this.options.params.sld_body:null;if(i){var n=$.parseXML(i),a=TC.Util.getElementByNodeName(n,"sld:NamedLayer");if(a&&a.length>0){var c=TC.Util.getElementByNodeName(a[0],"sld:Name");if(c&&c.length>0){var u=$(c[0]).text();this.names.push(u);this.availableNames.push(u)}}}}}this.ignorePrefixes=void 0===this.options.ignorePrefixes||this.options.ignorePrefixes;this._capabilitiesNodes={};!function(t,i,n){var a=t.url;t._capabilitiesPromise=$.Deferred();var o=e[a];o||(o=e[a]=$.Deferred());var c,u=function(e){if(e.error){s(t,e.error);t._capabilitiesPromise.reject()}else{t.capabilities=t.capabilities||e;t.capabilitiesUrl_?e._capabilitiesURL=t.capabilitiesUrl_:t.capabilitiesUrl_=e._capabilitiesURL;var i=t.getGetMapUrl();TC.capabilities[t.options.url]=TC.capabilities[t.options.url]||e;TC.capabilities[i]=TC.capabilities[i]||e;l(t);t._capabilitiesPromise.resolve(e)}},h={};if(t.type===TC.Consts.layerType.WMTS)if(t.options.encoding===TC.Consts.WMTSEncoding.RESTFUL){var p="/1.0.0/WMTSCapabilities.xml";const e=a.indexOf(p);if(e<0||e<a.length-p.length){"/"===a[a.length-1]&&(p=p.substr(1));c=a+p}else c=a}else{c=a;h.SERVICE="WMTS";h.VERSION="1.0.0";h.REQUEST="GetCapabilities"}else{c=a;h.SERVICE="WMS";h.VERSION="1.3.0";h.REQUEST="GetCapabilities"}c=c+"?"+$.param($.extend(h,t.queryParams));TC._capabilitiesRequests=TC._capabilitiesRequests||{};var d=t.setCapabilitiesUrl_(c,i,n);TC.loadJS(!window.localforage,[TC.Consts.url.LOCALFORAGE],function(){localforage.getItem(t.CAPABILITIES_STORE_KEY_PREFIX+a).then(function(i){if(i){e[t.url].then(u);d.then(function(){e[t.url].resolve(i)})}})});d.then(function(e){e===t.capabilitiesState_.PENDING&&r(t.capabilitiesUrl_(c)).then(function(e){i(t,e)},function(e,s,a){r(c,!0).then(function(e){i(t,e)},function(e){n(t,e.responseText)})})});$.when(d,o).done(function(e,i){e===t.capabilitiesState_.DONE&&i?u(i):i&&u(i)})}(this,o,s);this._disgregatedLayerNames=null;TC.Consts.layerType.WMTS==this.type&&this.wrap.setWMTSUrl()};TC.inherit(TC.layer.Raster,TC.Layer);var g=TC.layer.Raster.prototype;g.PROTOCOL_REGEX=/^(f|ht)tp?:\/\//i;g.capabilitiesState_={PENDING:0,DONE:1};g.getByProxy_=function(e){return TC.proxify(e)};g.getBySSL_=function(e){return e.replace(this.PROTOCOL_REGEX,"https://")};g.getByUrl_=function(e){return e};g.getCapabilitiesUrl_promise_=function(){this.capabilitiesUrl_promise_||(this.capabilitiesUrl_promise_=$.Deferred());return this.capabilitiesUrl_promise_};g.getCapabilitiesUrl_ServiceWorker_=function(e){var t=this,i=e&&e.trim()||t.url.trim();TC.Util.consoleRegister("Escenario: Visor en HTTPS + ServiceWorker");TC.Util.consoleRegister("Service worker nos obliga a estar en HTTPS");TC.Util.consoleRegister("Comprobamos si el servicio a solicitar es HTTPS, si no lo es producir\xe1 contenido mixto y el service worker no lo acepta");if(TC.Util.isSecureURL(i)){TC.Util.consoleRegister("S\xed lo es: validamos si cuenta con CORS");m(i,t.capabilitiesLoad_).then(function(e){if(e){TC.Util.consoleRegister("Tiene cabeceras CORS");t.capabilitiesUrl_=t.getByUrl_;t.getCapabilitiesUrl_promise_().resolve(t.capabilitiesState_.DONE)}else{TC.Util.consoleRegister("NO tiene cabeceras CORS -> proxificamos:");TC.Util.consoleRegister("GetCapabilities, GFI, 3D");TC.Util.consoleRegister("GetMap");t.capabilitiesUrl_=t.getByProxy_;t.getCapabilitiesUrl_promise_().resolve(t.capabilitiesState_.PENDING)}})}else{TC.Util.consoleRegister("No lo es: validamos si soporta SSL, ya que: aunque cuente con cabeceras CORS si el protocolo es distinto, el navegador bloquear\xe1 la petici\xf3n");t.getCapabilitiesUrl_MixedContent_FromHTTPS_(i)}};g.getCapabilitiesUrl_MixedContent_FromHTTPS_=function(e){var t=this,i=e&&e.trim()||t.url.trim();TC.Util.consoleRegister("Escenario: Visor en HTTPS y servicio en HTTP");TC.Util.consoleRegister("Validamos si soporta SSL, ya que: aunque cuente con cabeceras CORS si el protocolo es distinto, el navegador bloquea la petici\xf3n");f.call(t,i,t.capabilitiesLoad_).then(function(e){if(e){TC.Util.consoleRegister("Dado que estamos en un escenario de cross origin y si la petici\xf3n/comprobaci\xf3n de SSL ha funcionado correctamente: podemos afirmar que el servicio cuenta con cabeceras CORS");t.capabilitiesUrl_=t.getBySSL_;t.getCapabilitiesUrl_promise_().resolve(t.capabilitiesState_.DONE)}else{TC.Util.consoleRegister("Realmente no sabemos si el error se produce por no soportar HTTPS o porque no tiene CORS, sea como sea: es necesario proxificar");t.capabilitiesUrl_=t.getByProxy_;t.getCapabilitiesUrl_promise_().resolve(t.capabilitiesState_.PENDING)}})};g.getCapabilitiesUrl_MixedContent_FromHTTP_=function(e){var t=e&&e.trim()||this.url.trim();TC.Util.consoleRegister("Escenario: Visor en HTTP y servicio en HTTPS");this.getCapabilitiesUrl_CORSSupport_.call(this,t)};g.getCapabilitiesUrl_MixedContent_=function(e,t){var i=e&&e.trim()||this.url.trim(),n=t||document.location.href;TC.Util.consoleRegister("\xbfEstamos en HTTPS?");if(TC.Util.isSecureURL(n)){TC.Util.consoleRegister("Al ser un sitio seguro, validamos si existe un service worker (es m\xe1s restrictivo)");if(TC.Util.isServiceWorker()){TC.Util.consoleRegister("S\xed hay ServiceWorker");this.getCapabilitiesUrl_ServiceWorker_.call(this,i)}else{TC.Util.consoleRegister("No hay ServiceWorker");this.getCapabilitiesUrl_MixedContent_FromHTTPS_.call(this,i)}}else{TC.Util.consoleRegister("No lo estamos");this.getCapabilitiesUrl_MixedContent_FromHTTP_.call(this,i)}};g.getCapabilitiesUrl_ProtocolSiblings_=function(e,t){var i=e&&e.trim()||this.url.trim(),n=t||document.location.href;TC.Util.consoleRegister("Validamos si estamos en HTTPS y si hay ServiceWorker (es m\xe1s restrictivo)");if(TC.Util.isSecureURL(n)&&TC.Util.isServiceWorker()){TC.Util.consoleRegister("S\xed hay ServiceWorker");this.getCapabilitiesUrl_ServiceWorker_.call(this,i)}else{TC.Util.consoleRegister("No hay ServiceWorker");this.getCapabilitiesUrl_CORSSupport_.call(this,i)}};g.getCapabilitiesUrl_CORSSupport_=function(e){var t=this,i=e&&e.trim()||t.url.trim();TC.Util.consoleRegister("Validamos si soporta CORS");m(i,t.capabilitiesLoad_).then(function(e){if(e){TC.Util.consoleRegister("Cuenta con cabeceras CORS");t.capabilitiesUrl_=t.getByUrl_;t.getCapabilitiesUrl_promise_().resolve(t.capabilitiesState_.DONE)}else{TC.Util.consoleRegister("NO tiene cabeceras CORS -> proxificamos:");TC.Util.consoleRegister("Capabilities");t.capabilitiesUrl_=t.getByProxy_;t.getCapabilitiesUrl_promise_().resolve(t.capabilitiesState_.PENDING)}})};g.setCapabilitiesUrl_=function(e,t,i,n){var r=this;r.capabilitiesUrl_promise_=$.Deferred();var s=e&&e.trim()||r.url.trim(),a=n||document.location.href;r.capabilitiesLoad_||(r.capabilitiesLoad_=function(e){t(r,e)});r.capabilitiesLoadError_||(r.capabilitiesLoadError_=function(e){i(r,e)});TC.Util.consoleRegister("No hay capa hermana");TC.Util.consoleRegister("Validamos si existe cross origin");if(TC.Util.isSameOriginByLocation(s,a)){TC.Util.consoleRegister("Tenemos mismo origen, cargamos directamente");r.capabilitiesUrl_=r.getByUrl_;r.getCapabilitiesUrl_promise_().resolve(r.capabilitiesState_.PENDING)}else if(TC.Util.isSameProtocol(s,a)){TC.Util.consoleRegister("Hay cross origin");TC.Util.consoleRegister("Sin contenido mixto");r.getCapabilitiesUrl_ProtocolSiblings_.call(r,s)}else{TC.Util.consoleRegister("Tenemos contenido mixto");r.getCapabilitiesUrl_MixedContent_.call(r,s)}return r.getCapabilitiesUrl_promise_()};g.CAPABILITIES_STORE_KEY_PREFIX="TC.capabilities.";g.setVisibility=function(e){this.tree=null;this._cache.visibilityStates={};TC.Layer.prototype.setVisibility.call(this,e)};var C=function e(t,i,n){var r=!1,s=t.wrap.getLayerNodes(n);if(s.length){for(var a=0,o=s.length;a<o;a++)e(t,i,s[a])&&(r=!0);var l,c,u=$.map(s,function(e){return t.wrap.getName(e)}).reverse(),h=!1;c=l=$.inArray(u[0],i);if(l<0)h=!0;else for(a=1,o=u.length;a<o;a++)if(u[a]!=i[++l]){h=!0;break}if(!h){var p=t.wrap.getName(n);if(p&&u.length>1){i.splice(c,u.length,p);r=!0}}}return r},v=function(e,t){for(var i=[],n=t.slice(),r=e.wrap.getRootLayerNode(),s=0,a=n.length;s<a;s++)i=i.concat(T(e,n[s],r));return i},T=function e(t,i,n,r){for(var s=[],a=t.wrap.getName(n),o=t.compareNames(i,a),l=!1,c=t.wrap.getLayerNodes(n),u=0;u<c.length;u++){var h=e(t,i,c[u],r||o);h.length?s=s.concat(h):l=!0}c.length&&!l||(r||o)&&(s=[a]);return s},L=function(e){return $.extend({aggregate:!0,lazy:!1},e)},w=function(e,t,i){var n,r,s=[];n=t||[];r=i||[];for(var a=(e||[]).concat(n),o=0;o<a.length;o++)$.inArray(a[o],a)===o&&-1===$.inArray(a[o],r)&&(s[s.length]=a[o]);return s},b=function(e,t){var i="string"==typeof t?t.split(","):t;if(e.capabilities){var n=e.getTree();i.sort(function(e,t){var i={count:0},r={count:0};p(n,e,i);p(n,t,r);return i.count-r.count})}return i},S=function(e,t,i,n){return $.grep(i,function(i){return e.compareNames(t,i,n)}).length>0};g.getLimitedMatrixSet=function(){return function(e){var t=e.layerNames,i=e.matrixSet,n=e.capabilities,r=[],s=n.Contents.TileMatrixSet.filter(function(e){return e.Identifier==i});if(s.length){s=s[0];var a=n.Contents.Layer.filter(function(e){return e.Identifier==t})[0];if(a.TileMatrixSetLink&&a.TileMatrixSetLink.length&&a.TileMatrixSetLink[0].TileMatrixSetLimits){for(var o,l=a.TileMatrixSetLink[0].TileMatrixSetLimits,c=0;c<l.length;c++){o=l[c];var u=s.TileMatrix.filter(function(e){return e.Identifier==o.TileMatrix});if(u.length){var h=$.extend({matrixIndex:s.TileMatrix.indexOf(u[0])},u[0],o);r.push(h)}}return r}return s.TileMatrix}return null}(this)};g.setLayerNames=function(e,t){var i=this,n=new $.Deferred;$.when(i.wrap.getLayer()).then(function(){var r=$.isArray(e)?e:e.split(",");i.names=r;var s=L(t);s.aggregate&&(r=function(e,t){if(e.type!==TC.Consts.layerType.WMS)return t;var i=t.slice();C(e,i,e.wrap.getRootLayerNode());return i}(i,r));i._disgregatedLayerNames=null;var a={LAYERS:r.join(","),TRANSPARENT:!0};r.length||i.setVisibility(!1);if(s.lazy){var o=i._newParams||i.wrap.getParams();i._newParams=$.extend(o,a)}else{i.map&&i.map.$events.trigger($.Event(TC.Consts.event.BEFOREUPDATEPARAMS,{layer:i}));i.tree=null;i._cache.visibilityStates={};i.wrap.setParams(a);!s.reset&&i.map||(i.availableNames=i.names);i.map&&i.map.$events.trigger($.Event(TC.Consts.event.UPDATEPARAMS,{layer:i}))}n.resolve(i.names)});return n};g.addLayerNames=function(e,t){var i=this,n=new $.Deferred;$.when(i.wrap.getLayer()).then(function(){var r=L(t),s=$.isArray(e)?e:e.split(","),a=i.wrap.getParams().LAYERS;if(r.aggregate){s=v(i,s);a=i.getDisgregatedLayerNames()}$.when(i.setLayerNames(b(i,w(a,s,null)),t)).then(function(e){n.resolve(e)})});return n};g.removeLayerNames=function(e,t){var i=this,n=new $.Deferred;$.when(i.wrap.getLayer()).then(function(){var r=L(t),s=$.isArray(e)?e:e.split(","),a=i.wrap.getParams().LAYERS;if(r.aggregate){s=v(i,s);a=i.getDisgregatedLayerNames()}$.when(i.setLayerNames(b(i,w(a,null,s)),t)).then(function(e){n.resolve(e)})});return n};g.toggleLayerNames=function(e,t){var i=this,n=new $.Deferred;$.when(i.wrap.getLayer()).then(function(){var r=L(t),s=$.isArray(e)?e:e.split(","),a=i.wrap.getParams().LAYERS;if(r.aggregate){s=v(i,s);a=i.getDisgregatedLayerNames()}for(var o=[],l=[],c=0;c<s.length;c++){var u=s[c];$.inArray(u,a)<0?o[o.length]=u:l[l.length]=u}var h=[];o.length>0&&h.push(i.addLayerNames(o,r));l.length>0&&h.push(i.removeLayerNames(l,r));$.when.apply(this,h).then(function(e,t){e?t?n.resolve(e.concat(t)):n.resolve(e):n.resolve([])})});return n};g.getDisgregatedLayerNames=function(){var e=this.wrap.getLayer();if(this.wrap.isNative(e)&&this.type===TC.Consts.layerType.WMS){if(!this._disgregatedLayerNames){var t=this.wrap.getParams().LAYERS;t=$.isArray(t)?t:t.split(",");this._disgregatedLayerNames=v(this,t)}}else this._disgregatedLayerNames=this.names;return this._disgregatedLayerNames.slice()};g.isValidFromNames=function(){for(var e=!0,t=0,i=this.names.length;t<i;t++)if(!this.getLayerNodeByName(this.names[t])){e=!1;break}return e};g.isCompatible=function(e){var t=!1;switch(this.type){case TC.Consts.layerType.WMTS:case TC.Consts.layerType.WMS:t=this.wrap.isCompatible(e)}return t};g.getCompatibleCRS=function(e){const t=this;e=e||{};var i=t.wrap.getCompatibleCRS();if(e.includeFallback&&t.fallbackLayer){const e=t.getFallbackLayer();e instanceof TC.Layer&&(i=i.concat(e.wrap.getCompatibleCRS()))}e.normalized&&(i=i.map(function(e){return TC.Util.getCRSCode(e)}).filter(function(e){return null!==e}).reduce(function(e,t){e.indexOf(t)<0&&(e[e.length]=t);return e},[]).map(function(e){return"EPSG:"+e}));return i};g.setProjection=function(e){if((e=e||{}).crs)switch(this.type){case TC.Consts.layerType.WMTS:var t=this.wrap.getCompatibleMatrixSets(e.crs)[0];if(t){this.matrixSet=t;this.wrap.setMatrixSet(t)}else this.wrap.setProjection(e);this.mustReproject=!t;break;case TC.Consts.layerType.WMS:this.wrap.setProjection(e);this.mustReproject=!this.isCompatible(e.crs)}};g.isVisibleByScale=function(e,t){var i,n,r,s=this,a=function(){return s.map.wrap.getResolution()*s.map.getMetersPerUnit()/28e-5};switch(s.type){case TC.Consts.layerType.WMTS:i=!1;var o=s.wrap.getTileMatrix(s.options.matrixSet);if(o){n=a();for(r=0;r<o.length;r++){if((h=s.wrap.getScaleDenominators(o[r]))[0]===n){i=!0;break}}}break;case TC.Consts.layerType.WMS:i=!0;var l=s.wrap.getAllLayerNodes();if(l.length>0){n=a();var c;if("number"==typeof e)c=s._capabilitiesNodes[e];else for(r=0;r<l.length;r++){var u=l[r];if(s.compareNames(s.wrap.getName(u),e,t)){c=u;break}}if(c){var h=s.wrap.getScaleDenominators(c);i=!(parseFloat(h[1])>n||parseFloat(h[0])<n)}}break;default:i=!0}return i};g.isVisibleByName=function(e,t){var i=this,n=!1;switch(i.type){case TC.Consts.layerType.WMTS:if(i.wrap.getWMTSLayer()){n=!0;break}break;case TC.Consts.layerType.WMS:var r=function e(n,r){var s=null,a=i.wrap.getName(r);if(i.compareNames(a,n,t))s=[a];else for(var o=i.wrap.getLayerNodes(r),l=0;l<o.length;l++){var c=e(n,o[l]);if(c){TC.Util.fastUnshift(c,a);s=c;break}}return s},s=function(e){return r(e,i.wrap.getRootLayerNode())}(e);if(s)for(var a=0;a<s.length;a++)if(S(i,s[a],i.names)){n=!0;break}break;default:n=!0}return n};g.getTree=function(){var e=this,t=e.tree;if(!t){var i,n=function t(n,r,s){var a;for(var o in e._capabilitiesNodes)if(e._capabilitiesNodes[o]===n){a=o;break}if(!a){a=TC.getUID();e._capabilitiesNodes[a]=n}var l,c,u={name:e.wrap.getName(n),title:n.title||n.Title,uid:a,children:[]};s&&(i=u);S(e,u.name,e.availableNames)&&(r=!0);if(e.options.isBase){u.name=e.names.join(",");u.title=e.title||u.title;u.isBase=e.isDefault;e.options.thumbnail&&(u.legend={src:e.options.thumbnail})}else{u.isVisible=u===i?e.getVisibility():e.isVisibleByName(u.name);var h,p=e.wrap.getLayerNodes(n);for(h=0;h<p.length;h++){var d=t(p[h],r);d&&(l=u,c=d,e.options.inverseTree?TC.Util.fastUnshift(l.children,c):l.children[l.children.length]=c)}u.legend=e.wrap.getLegend(n);if(!r&&!s){i.children=i.children.concat(u.children);u=null}}return u};switch(e.type){case TC.Consts.layerType.WMTS:t=n(e.wrap.getWMTSLayer(),!e.options.hideTree,!0);break;case TC.Consts.layerType.WMS:if(e.capabilities){t=n(e.wrap.getRootLayerNode(),!e.options.hideTree,!0);var r=e._cache.visibilityStates;!function e(t){var i=TC.Consts.visibility.NOT_VISIBLE;if(t){if(void 0!==r[t.uid])i=r[t.uid];else{if(t.children)for(var n=!1,s=!1,a=0,o=t.children.length;a<o;a++){switch(e(t.children[a])){case TC.Consts.visibility.VISIBLE:n=!0;break;case TC.Consts.visibility.NOT_VISIBLE:s=!0;break;case TC.Consts.visibility.HAS_VISIBLE:n=!0;s=!0}n&&(i=s?TC.Consts.visibility.HAS_VISIBLE:TC.Consts.visibility.VISIBLE)}t.isVisible&&(i=TC.Consts.visibility.VISIBLE);r[t.uid]=i}t.visibilityState=i}return i}(t);e.options.hideTree&&function e(t,i){i.children.sort(function(e,i){return h(t,i)-h(t,e)});for(var n=0,r=i.children.length;n<r;n++)e(t,i.children[n])}(e,t)}}t||(t={name:e.name,title:e.title});t.title=e.title||t.title;t.customLegend=e.customLegend||t.customLegend;e.tree=t}return t};g.setNodeVisibility=function(e,t){var i=this;i.tree||(i.tree=i.getTree());var n=i.findNode(e,i.tree);if(n===i.tree)t&&0===i.names.length?i.addLayerNames(i.availableNames).then(function(){i.setVisibility(!0)}):i.setVisibility(t);else{var r=function e(t){var i=[];if(t.name)i[0]=t.name;else for(var n=0;n<t.children.length;n++)i=i.concat(e(t.children[n]));return i}(n);t?i.addLayerNames(r):i.removeLayerNames(r)}};g.getNodeVisibility=function(e){this.tree||(this.tree=this.getTree());return this._cache.visibilityStates[e]};g.getNodePath=function(e,t){var i=this,n=[];if(i.type===TC.Consts.layerType.WMS&&i.capabilities){e=e||i.names[0];n=function n(r){var s=[],a=i.wrap.getName(r);if(i.compareNames(a,e,t))s.push(r);else for(var o=i.wrap.getLayerNodes(r),l=0;l<o.length;l++){var c=n(o[l]);if(c.length){s=c;TC.Util.fastUnshift(s,r);break}}return s}(i.wrap.getRootLayerNode())}return n};g.getPath=function(e,t){return $.map(this.getNodePath(e,t),function(e){return e.title||e.Title})};g.getLayerNodeByName=function(e){for(var t=null,i=this.wrap.getServiceType()===TC.Consts.layerType.WMTS?this.wrap.getIdentifier:this.wrap.getName,n=this.wrap.getAllLayerNodes(),r=0,s=n.length;r<s;r++)if(this.compareNames(i(n[r]),e)){t=n[r];break}return t};g.getChildrenLayers=function(e){var t=[],i=function(e,t){if(e&&e.Layer&&e.Layer.length)for(var n=0;n<e.Layer.length;n++){t[t.length]=e.Layer[n];i(e.Layer[n],t)}};i(e,t);return t};g.compareNames=function(e,t,i){var n=e===t,r=void 0!==i?i:this.ignorePrefixes;if(!n&&r&&e&&t){var s=e.indexOf(":"),a=t.indexOf(":");s>=0&&a<0?n=e.substr(s+1)===t:a>=0&&s<0&&(n=e===t.substr(a+1))}return n};g.getCapabilitiesPromise=function(){return this._capabilitiesPromise};g.getResolutions=function(){return this.wrap.getResolutions()};g.searchSubLayers=function(e){this.patternFn||(this.patternFn=function(e){return e=(e=(e=(e=(e=(e=(e=e.replace(/[^a-z\d\xe1\xe9\xed\xf3\xfa\xfc\xf1]/gi,"\\$&")).replace(/(a|\xe1)/gi,"(a|\xe1)")).replace(/(e|\xe9)/gi,"(e|\xe9)")).replace(/(i|\xed)/gi,"(i|\xed)")).replace(/(o|\xf3)/gi,"(o|\xf3)")).replace(/(u|\xfa|\xfc)/gi,"(u|\xfa|\xfc)")).replace(/n/gi,"(n|\xf1)")});if(e&&e.length&&e.length>=3){var t=this,i=null;if(this.lastPattern&&e.indexOf(this.lastPattern)>=0)i=this.lastMatches;else if(t.availableNames&&t.availableNames.length>0){i=[];for(var n=0;n<t.availableNames.length;n++){var r=t.getLayerNodeByName(t.availableNames[n]);if(r){i[i.length]=r;i=i.concat(t.getChildrenLayers(r))}}}else i=t.wrap.getAllLayerNodes();var s=this.patternFn(e),a=new RegExp(s,"i"),o=i.map(function(e,i){delete e.tcScore;e.tcPosition=i;t.wrap.normalizeLayerNode(e);var n=e.Title.trim(),r=a.exec(n),s=r?r.index:-1,o=-1;if(e.Abstract){var l=e.Abstract.trim(),c=a.exec(l);o=c?c.index:-1}r&&n==r[0]?e.tcScore=20:0==s?e.tcScore=15:s>-1?e.tcScore=10:0==o?e.tcScore=5:o>-1&&(e.tcScore=1);return e.tcScore?e:null}).filter(function(e){return null!=e}).sort(function(e,t){if(t.tcScore===e.tcScore){var i=TC.Util.replaceAccent(e.Title),n=TC.Util.replaceAccent(t.Title);return i<n?-1:i>n?1:0}return t.tcScore-e.tcScore});this.lastPattern=e;this.lastMatches=o;return o}return[]};g.getGetMapUrl=function(){return function(e){var t=e;if(e){var i=e.match(/\??SERVICE=\w+&/i);i&&(t=t.replace(i[0],""))}return t}(this.wrap.getGetMapUrl())};g.getPreferredInfoFormat=function(){for(var e=null,t=this.wrap.getInfoFormats(),i=0;i<TC.wrap.layer.Raster.infoFormatPreference.length;i++){var n=TC.wrap.layer.Raster.infoFormatPreference[i];if($.inArray(n,t)>=0){e=n;break}}return e};g.getLegendGraphicImage=function(){var e=this,t=$.Deferred();if(e.options.params.base64LegendSrc)return t.resolve(e.options.params.base64LegendSrc);if("function"==typeof window.btoa){for(var i=e.names[0],n=e.wrap.getInfo(i),r=new XMLHttpRequest,s=n.legend[0].src.split("?"),a=s[1].split("&"),o=e.options.params.sld_body?"sld_body="+e.options.params.sld_body:"",l=0;l<a.length;l++){var c=a[l].split("=");c&&c.length>1&&c[1]&&(o+="&"+a[l])}e.options.params.env&&(o+="&"+e.options.params.env);r.open("POST",s[0],!0);r.setRequestHeader("Content-Type","application/x-www-form-urlencoded");r.responseType="arraybuffer";r.onload=function(i){if(200===this.status){for(var n=new Uint8Array(this.response),s=n.length,a=new Array(s);s--;)a[s]=String.fromCharCode(n[s]);var o=a.join(""),l=r.getResponseHeader("content-type");if(0===l.indexOf("image")){var c;c="data:"+l+";base64,"+window.btoa(o);e.options.params.base64LegendSrc=c;t.resolve(c)}}};r.send(o)}else t.reject("Funci\xf3n window.btoa no soportada por el navegador");return t.promise()};g.getUrl=function(e){return e};g.getWebGLUrl=function(e,t){var i=this,n=new $.Deferred;if(i.getWebGLUrl!==g.getWebGLUrl)n.resolve(i.getWebGLUrl.call(i,e));else{TC.Util.consoleRegister("Buscamos en las capas de trabajo si exite alguna del mismo servicio.");TC.Util.consoleRegister("Si hay capa hermana asignamos la misma funci\xf3n de carga de im\xe1genes sin validar nada.");var r=i.getSiblingLoadedLayer.call(i,function(e){return e.getWebGLUrl.toString()!==g.getWebGLUrl.toString()});if(r){TC.Util.consoleRegister("Tenemos capa hermana, no validamos nada m\xe1s.");i.getWebGLUrl=r.getWebGLUrl;n.resolve(i.getWebGLUrl.call(i,e))}else if(TC.Util.detectIE()){i.getWebGLUrl=i.capabilitiesUrl_;n.resolve(i.capabilitiesUrl_.call(i,!TC.Util.isSecureURL(e)&&TC.Util.isSecureURL(TC.Util.toAbsolutePath(i.url))?i.getBySSL_(e):e))}else{TC.Util.consoleRegister("No hay capa hermana.");var s=t||document.location.href;if(TC.Util.isSameOrigin(e)){TC.Util.consoleRegister("Escenario mismo origen");i.getWebGLUrl=i.getByUrl_;n.resolve(i.getByUrl_(e))}else{TC.Util.consoleRegister("Escenario cross origin");TC.Util.consoleRegister("Comprobamos si existe service worker");if(TC.Util.isSecureURL(s)&&TC.Util.isServiceWorker()){TC.Util.consoleRegister("Hay serviceworker");TC.Util.consoleRegister("Comprobar si tenemos contenido mixto, ya que en la comprobaci\xf3n de CORS el service worker bloquear\xe1 la petici\xf3n si tenemos contenido mixto");if(TC.Util.isSameProtocol(e,s)){TC.Util.consoleRegister("No hay contenido mixto");TC.Util.consoleRegister("Validamos si tiene CORS");y(e).then(function(t){if(t){TC.Util.consoleRegister("Tiene CORS");i.getWebGLUrl=i.getByUrl_;n.resolve(i.getByUrl_(e))}else{TC.Util.consoleRegister("No tiene CORS");i.getWebGLUrl=i.getByProxy_;n.resolve(i.getByProxy_(e))}})}else{TC.Util.consoleRegister("Comprobamos si soporta SSL: si no, habr\xe1 que proxificar");f.call(i,e,function(){TC.Util.consoleRegister("Validamos si tiene CORS");y(e).then(function(t){if(t){TC.Util.consoleRegister("Tiene CORS");i.getWebGLUrl=i.getBySSL_;n.resolve(i.getBySSL_(e))}else{TC.Util.consoleRegister("No tiene CORS");i.getWebGLUrl=i.getByProxy_;n.resolve(i.getByProxy_(e))}})},function(){TC.Util.consoleRegister("Al no soportar SSL tenemos contenido mixto, que bloquear\xe1 el service worker: proxificamos");i.getWebGLUrl=i.getByProxy_;n.resolve(i.getByProxy_(e))})}}else{TC.Util.consoleRegister("No hay serviceworker");y(e).then(function(t){if(t){TC.Util.consoleRegister("Tiene cabeceras CORS");i.getWebGLUrl=i.getByUrl_;n.resolve(i.getByUrl_(e))}else{TC.Util.consoleRegister("NO tiene cabeceras CORS");i.getWebGLUrl=i.getByProxy_;n.resolve(i.getByProxy_(e))}})}}}}return n};g.getLegendUrl=function(e,t){var i=this,n=t||document.location.href,r=/^(https?:\/\/)/i,s=function(e){return!TC.Util.isSameProtocol(e,i.url)&&r.test(e)&&r.test(i.url)&&TC.Util.isSecureURL(i.url.match(r)[1])?e.replace(e.match(r)[1],i.url.match(r)[1]):TC.Util.isServiceWorker()?TC.Util.isSecureURL(e)?e:i.getBySSL_(e):e};return TC.Util.isServiceWorker()?s(e):TC.Util.isSameProtocol(e,n)?/^(https?:)?\/\//i.test(e)?e.substr(e.indexOf("//")):e:TC.Util.isSecureURL(n)&&!TC.Util.isSecureURL(e)?s(e):e};g.getFeatureInfoUrl=function(e){return this.capabilitiesUrl_.call(this,!TC.Util.isSecureURL(e)&&TC.Util.isSecureURL(TC.Util.toAbsolutePath(this.url))?this.getBySSL_(e):e)};g.getFeatureUrl=function(e){return this.capabilitiesUrl_.call(this,!TC.Util.isSecureURL(e)&&TC.Util.isSecureURL(TC.Util.toAbsolutePath(this.url))?this.getBySSL_(e):e)};g.getSiblingLoadedLayer=function(e){var t=this;if(t.map){return t.map.baseLayers.slice(0).concat(t.map.workLayers.slice(0)).filter(function(i){return(i.type===TC.Consts.layerType.WMS||i.type===TC.Consts.layerType.WMTS)&&(i.capabilities===t.capabilities||i.url===t.url)&&(!e||!$.isFunction(e)||e(i))})[0]||null}return null};g.getImageLoad=function(e,t,i){var n=i||document.location.href,r="POST"===this.options.method;if(this.imageLoad_)this.imageLoad_.call(this,e,t);else{TC.Util.consoleRegister("Buscamos en las capas de trabajo si exite alguna del mismo servicio.");TC.Util.consoleRegister("Si hay capa hermana asignamos la misma funci\xf3n de carga de im\xe1genes sin validar nada.");var s=this.getSiblingLoadedLayer.call(this,function(e){return $.isFunction(e.imageLoad_)});if(!r&&s){TC.Util.consoleRegister("Hay capa hermana cargada, asignamos mismo m\xe9todo de carga");this.imageLoad_=s.imageLoad_;this.getUrl=s.getUrl;this.imageLoad_.call(this,e,t)}else{TC.Util.consoleRegister("No hay capa hermana, pasamos a gestionar");if(TC.Util.isSameOrigin(t)){TC.Util.consoleRegister("Escenario mismo origen");this.imageLoad_=r?g.imageLoadHttpRequest_:g.imageLoad;this.imageLoad_.call(this,e,t)}else{TC.Util.consoleRegister("Escenario cross origin");if(r){this.imageLoad_=g.imageLoad_POST;this.imageLoad_.call(this,e,t);return}TC.Util.consoleRegister("Comprobamos si existe service worker");if(TC.Util.isSecureURL(n)&&TC.Util.isServiceWorker())this.imageLoad_ServiceWorkerCrossOrigin.call(this,e,t);else{TC.Util.consoleRegister("No hay serviceworker");TC.Util.consoleRegister("Siguiente paso: valoramos si el canvas debe mantenerse exportable");if(!this.map||this.map&&!this.map.mustBeExportable){TC.Util.consoleRegister("No hay exportaci\xf3n: no importa un tainted canvas, mantenemos la misma funci\xf3n que si no hubiese cross origin");this.imageLoad_=g.imageLoad;this.imageLoad_.call(this,e,t)}else this.imageLoad_ExportableCrossOrigin.call(this,e,t)}}}}};g.imageLoad_POST=function(e,t){this.getUrl=this.capabilitiesUrl_;this.imageLoadHttpRequest_.call(this,e,!TC.Util.isSecureURL(t)&&TC.Util.isSecureURL(TC.Util.toAbsolutePath(this.url))?this.getBySSL_(t):t)};g.imageLoad_ServiceWorkerCrossOrigin=function(e,t,i){var n=this,r=i||document.location.href;TC.Util.consoleRegister("Hay serviceworker");TC.Util.consoleRegister("Comprobar si tenemos contenido mixto, ya que en la comprobaci\xf3n de CORS el service worker bloquear\xe1 la petici\xf3n si tenemos contenido mixto");if(TC.Util.isSameProtocol(t,r)){TC.Util.consoleRegister("No tenemos contenido mixto");TC.Util.consoleRegister("Valoramos si el canvas debe mantenerse exportable");if(!n.map||n.map&&!n.map.mustBeExportable){TC.Util.consoleRegister("No hay exportaci\xf3n: no importa un tainted canvas, mantenemos la misma funci\xf3n que si no hubiese cross origin");n.imageLoad_=g.imageLoad;n.imageLoad_.call(n,e,t)}else{TC.Util.consoleRegister("Hay exportaci\xf3n a imagen");TC.Util.consoleRegister("Validamos si tiene CORS");$.when(y(n.names.length?n.getUrl(t):TC.Consts.BLANK_IMAGE,e)).then(function(i){if(i){TC.Util.consoleRegister("Tiene cabeceras CORS");n.imageLoad_=g.imageLoad_CrossOrigin;n.imageLoad_.call(n,e,t)}else{TC.Util.consoleRegister("No tiene cabeceras CORS");n.imageLoad_=g.imageLoad_CrossOriginNoCORS;n.imageLoad_.call(n,e,t)}})}}else{TC.Util.consoleRegister("Comprobamos si soporta SSL: si no, habr\xe1 que proxificar");f.call(n,t,function(){TC.Util.consoleRegister("Validamos si debemos mantener un canvas limpio");if(!n.map||n.map&&!n.map.mustBeExportable){TC.Util.consoleRegister("No hay exportaci\xf3n: no importa un tainted canvas, mantenemos la misma funci\xf3n que si no hubiese cross origin");n.imageLoad_=g.imageLoad;n.imageLoad_.call(n,e,t)}else{TC.Util.consoleRegister("Hay exportaci\xf3n a imagen");TC.Util.consoleRegister("Validamos si tiene CORS");$.when(y(n.names.length?n.getBySSL_(t):TC.Consts.BLANK_IMAGE,e)).then(function(i){if(i){TC.Util.consoleRegister("Tiene CORS");n.getUrl=n.getBySSL_;n.imageLoad_=g.imageLoad_CrossOrigin;n.imageLoad_.call(n,e,t)}else{TC.Util.consoleRegister("No tiene CORS");n.imageLoad_=g.imageLoad_CrossOriginNoCORS;n.imageLoad_.call(n,e,t)}})}},function(){TC.Util.consoleRegister("Al no soportar SSL tenemos contenido mixto, que bloquear\xe1 el service worker: proxificamos");n.imageLoad_=g.imageLoad_CrossOriginNoCORS;n.imageLoad_.call(n,e,t)})}};g.imageLoad_ExportableCrossOrigin=function(e,t){var i=this;TC.Util.consoleRegister("El canvas debe manternerse exportable");TC.Util.consoleRegister("Primer paso: validamos si navegamos mediante InternetExplorer. IE es m\xe1s restrictivo en cuanto a la exportaci\xf3n en casos de cross origin");if(TC.Util.detectIE()){TC.Util.consoleRegister("Segundo paso: al navegar mediante IE y haber crossOrigin comprobamos si el servicio cuenta con cabeceras CORS o no");$.when(y(i.names.length?i.getUrl(t):TC.Consts.BLANK_IMAGE,e)).then(function(n){if(n){TC.Util.consoleRegister("Tiene cabeceras CORS");i.imageLoad_=g.imageLoad_CrossOrigin;i.imageLoad_.call(i,e,t)}else{TC.Util.consoleRegister("No tiene cabeceras CORS");i.imageLoad_=g.imageLoad_IE_CrossOriginNoCORS;i.imageLoad_.call(i,e,t)}})}else{TC.Util.consoleRegister("No es IE");i.imageLoad_=g.imageLoad_CrossOrigin;i.imageLoad_.call(i,e,t)}};g.imageLoad_CrossOriginNoCORS=function(e,t){TC.Util.consoleRegister("Proxificamos la url de la imagen para esta petici\xf3n y las siguientes.");this.getUrl=this.getByProxy_;this.imageLoadHttpRequest_.call(this,e,t)};g.imageLoad_IE_CrossOriginNoCORS=function(e,t){this.imageLoad_CrossOriginNoCORS.call(this,e,t)};g.imageLoad_CrossOrigin=function(e,t){var i=this,n=e.getImage();n.crossOrigin="anonymous";n.onerror=function(){TC.Util.consoleRegister("La carga de imagen ha dado un error, verificamos si se trata de un 404 u otro tipo de error, tenemos que repetir la petici\xf3n por ajax para poder conocer el status del error, la carga por src no muestra el tipo de error");$.when(d(t,function(e){TC.Util.consoleRegister("Habr\xe1 sido algo moment\xe1neo, no hago nada")},function(r){if(r&&404===r.status){TC.Util.consoleRegister("Se trata de un 404, cargo imagen en blanco y nada m\xe1s.");i.imageLoad_blank_.call(i,e)}else if(400===r.status);else{TC.Util.consoleRegister("No es un 404");i.getUrl=i.getByProxy_;n.onerror=i.imageLoadingError_.bind(i,e,"blob",i.imageLoadedBlob_);n.src=i.names.length?i.getUrl(t):TC.Consts.BLANK_IMAGE;e.load()}}))};n.src=i.names.length?i.getUrl(t):TC.Consts.BLANK_IMAGE};g.imageLoad=function(e,t){var i=this,n=e.getImage();n.onerror=function(){n.crossOrigin="anonymous";n.onerror=i.imageLoadingError_.bind(i,e,"blob",i.imageLoadedBlob_);n.src=i.names.length?i.getUrl(t):TC.Consts.BLANK_IMAGE};n.src=i.names.length?i.getUrl(t):TC.Consts.BLANK_IMAGE};var E=function(){return this.wrap&&this.wrap.$events?this.wrap.$events:$(this)};g.imageLoadHttpRequest_=function(e,t){var i="",n="POST"===this.options.method;if(n){E.call(this).trigger($.Event(TC.Consts.event.BEFORETILELOAD,{tile:e}));for(var r=t.split("?"),s=r[1].split("&"),a=0;a<s.length;a++){var o=s[a].split("=");o&&o.length>1&&o[1]&&"LAYERS"!==o[0]&&(i+="&"+s[a])}t=r[0]}var l=new XMLHttpRequest;try{l.open(n?this.options.method:"GET",this.names.length?this.getUrl(t):TC.Consts.BLANK_IMAGE);n&&l.setRequestHeader("Content-Type","application/x-www-form-urlencoded");l.responseType="blob";l.onload=this.imageLoadedBlob_.bind(this,l,e);l.onerror=this.imageLoadingError_.bind(this,e,"blob",this.imageLoadedBlob_);i?l.send(i):l.send()}catch(t){this.imageLoadingError_.call(this,e,"blob",this.imageLoadedBlob_)}};g.imageLoadingError_=function(e,t,i){var n=this;e.getImage().onerror=void 0;TC.Util.consoleRegister("Se ha producido un error en la petici\xf3n de imagen. Proxificamos la url de la imagen para esta petici\xf3n y las siguientes.");n.getUrl=n.getByProxy_;var r=new XMLHttpRequest;r.open("GET",n.getUrl(e.getImage().getAttribute("src")||e.src_));r.responseType=t;TC.Util.consoleRegister("Si en la gesti\xf3n del error vuelve a dar error, no intentamos nada m\xe1s, cargamos una imagen en blanco y lanzamos el evento de error.");r.onerror=function(){E.call(n).trigger($.Event(TC.Consts.event.TILELOADERROR,{tile:e,error:{code:this.status,text:this.statusText}}));n.imageLoad_blank_.call(n,e)};r.onload=i.bind(n,r,e);r.send()};g.imageLoadedBlob_=function(e,t){var i=this;if(i.imageLoad_!==g.imageLoadHttpRequest_){TC.Util.consoleRegister("Si hemos llegado hasta aqu\xed es que hemos gestionado un error, por lo tanto: modificamos el m\xe9todo de carga layerProto.imageLoadHttpRequest_");i.imageLoad_=g.imageLoadHttpRequest_}var n=t.getImage();if(e.status>=400&&e.status<=500){E.call(i).trigger($.Event(TC.Consts.event.TILELOADERROR,{tile:t,error:{code:e.status,text:e.statusText}}));i.imageLoad_blank_.call(i,t)}else if(e.response&&e.response.type&&-1===e.response.type.indexOf("image"))i.imageLoad_blank_.call(i,t);else if(200===e.status){var r=URL.createObjectURL(e.response);n.onload=function(e){URL.revokeObjectURL(e.target.src);E.call(i).trigger($.Event(TC.Consts.event.TILELOAD,{tile:t}))};n.setAttribute("src",r)}};g.imageLoad_blank_=function(e){var t=e.getImage();t.crossOrigin="anonymous";t.src=TC.Consts.BLANK_IMAGE};g.getWFSCapabilitiesPromise=function(){void 0===WFSCapabilities&&TC.syncLoadJS(TC.apiLocation+"TC/layer/WFSCapabilitiesParser");var e=this.options.url.replace(/service=wms/i,"service=wfs").replace(/\/wms(\/|\?|\b)/i,"$'/wfs/"),t=$.Deferred(),i=e.substring(e.indexOf("://")<0?0:e.indexOf("://")+3);if(TC.WFScapabilities[i]){setTimeout(function(){t.resolve(TC.WFScapabilities[i])},100);return t}var n={SERVICE:"WFS",VERSION:"2.0.0",REQUEST:"GetCapabilities"};$.ajax({url:this.getUrl(e+"?"+$.param(n)),type:"GET"}).then(function(){var e,n;n=jQuery.isXMLDoc(arguments[0])?arguments[0]:(new DOMParser).parseFromString(arguments[0],"text/xml");var r=$(n).find("ServiceException");0===r.length&&(r=$(n).find("ExceptionText"));if(r.length>0)t.reject(null,"error",r.html());else{try{e=WFSCapabilities.Parse(n)}catch(e){t.reject(e);return}if(e.Operations){var s=e.Operations.GetCapabilities.DCP&&e.Operations.GetCapabilities.DCP.HTTP.Get["xlink:href"]||e.Operations.GetCapabilities.DCPType[0].HTTP.Get.onlineResource;TC.WFScapabilities[s]=e;TC.WFScapabilities[i]=e;t.resolve(e)}else t.reject(null)}},function(e,i,n){t.reject(e,i,n)});return t};g.getFallbackLayer=function(){const e=this;if(e.fallbackLayer instanceof TC.Layer)return e.fallbackLayer;if(e.options.fallbackLayer){var t=e.options.fallbackLayer;if("string"==typeof t){(e.map?e.map.options.availableBaseLayers:TC.Cfg.availableBaseLayers).forEach(function(t){if(e.options.fallbackLayer===t.id){e.fallbackLayer=new TC.layer.Raster($.extend({},t,{isBase:!0,stealth:!0,map:e.map}));e.fallbackLayer.firstOption=e}})}else if(t instanceof TC.Layer){e.fallbackLayer=t;e.fallbackLayer.firstOption=e}else{e.fallbackLayer=new TC.layer.Raster($.extend({},t,{id:TC.getUID(),isBase:!0,stealth:!0,title:layer.title,map:e.map}));e.fallbackLayer.firstOption=e}return e.fallbackLayer}return null}}();var esriParser={parse:function(e){var t=[],i=(new DOMParser).parseFromString(e,"text/xml");if("FeatureInfoResponse"===i.documentElement.tagName)for(var n=i.documentElement.getElementsByTagName("FeatureInfoCollection"),r=0,s=n.length;r<s;r++)for(var a=n[r],o=a.getAttribute("layername"),l=a.getElementsByTagName("FeatureInfo"),c=0,u=l.length;c<u;c++){for(var h=l[c].getElementsByTagName("Field"),p={},d=0,f=h.length;d<f;d++){var m=h[d];p[getElementText(m.getElementsByTagName("FieldName")[0])]=getElementText(m.getElementsByTagName("FieldValue")[0])}var y=new ol.Feature(p);y.setId(o+"."+TC.getUID());t[t.length]=y}return t}};TC.layer=TC.layer||{};TC.Layer||TC.syncLoadJS(TC.apiLocation+"TC/Layer");TC.layer.Vector=function(){TC.Layer.apply(this,arguments);this.type=this.options.type||TC.Consts.layerType.VECTOR;this.features=[];this.selectedFeatures=[];const e=function(e){var t=(e=e||"").indexOf("?");t>=0?e=e.substr(0,t):(t=e.indexOf("#"))>=0&&(e=e.substr(0,t));return e.substr(e.lastIndexOf(".")).toLowerCase()}(this.url),t=function(e){switch(e){case TC.Consts.mimeType.KML:return TC.Consts.format.KML;case TC.Consts.mimeType.GPX:return TC.Consts.format.GPX;case TC.Consts.mimeType.JSON:case TC.Consts.mimeType.GEOJSON:return TC.Consts.format.GEOJSON;case TC.Consts.mimeType.GML:return TC.Consts.format.GML;default:return null}}(this.options.format)||function(e){switch(e){case".kml":return TC.Consts.format.KML;case".gpx":return TC.Consts.format.GPX;case".json":case".geojson":return TC.Consts.format.GEOJSON;case".gml":return TC.Consts.format.GML;case".wkt":return TC.Consts.format.WKT;case".topojson":return TC.Consts.format.TOPOJSON;default:return null}}(e);if(t||this.type===TC.Consts.layerType.KML){t===TC.Consts.format.KML&&(this.type=TC.Consts.layerType.KML);this.title=this.options.title||function(t){for(var i=t=t||"",n=new RegExp("([^/]+"+e+")","i"),r=0;r<3;r++){t=decodeURIComponent(t);var s=n.exec(t);if(s.length>1){i=s[1];break}}return i}(this.url)}this.wrap=new TC.wrap.layer.Vector(this);var i=this.wrap.createVectorLayer();this.wrap.setLayer(i)};TC.inherit(TC.layer.Vector,TC.Layer);!function(){var e=TC.layer.Vector.prototype;e.getTree=function(){var e=null;if(!this.options.stealth){(e={}).children=[];for(var t=0;t<this.features.length;t++){var i=this.features[t].getPath();if(i.length){var n=TC.Util.addArrayToTree(i,e);n&&(n.legend=this.features[t].getLegend())}}e.name=this.name||e.name;e.customLegend=this.options.customLegend;e.title=this.title||e.title;e.uid=this.id}return e};var t=function(e,t,i,n){var r=new $.Deferred;$.when(t.call(e,[i],n)).then(function(t){r.resolve(t[0]);e.map&&e.map.$events.trigger($.Event(TC.Consts.event.FEATUREADD,{layer:e,feature:t[0]}))});return r},i=function(e,t,i,n,r){var s=new $.Deferred,a=e.options.styles&&e.options.styles[n]||TC.Cfg.styles[n],o=$.extend(!0,{},a,r);TC.loadJS(!TC.feature||TC.feature&&!TC.feature[i],[TC.apiLocation+"TC/feature/"+i],function(){for(var n=TC.feature[i],r=new Array(t.length),a=[],l=0,c=t.length;l<c;l++){var u,h=t[l];const i=TC.wrap.Feature.prototype.isNative(h);if(h instanceof n)u=h;else{o.layer=e;i&&(u=h._wrap&&h._wrap.parent);u||(u=new n(h,o))}u.layer=e;r[l]=u;e.features[e.features.length]=u;i||(a[a.length]=u.wrap.feature);u.options.showPopup&&u.showPopup()}a.length&&e.wrap.addFeatures(a);s.resolve(r)});return s};e.addPoint=function(e,i){return t(this,this.addPoints,e,i)};e.addPoints=function(e,t){return i(this,e,"Point",TC.Consts.geom.POINT,t)};e.addMarker=function(e,i){return t(this,this.addMarkers,e,i)};e.addMarkers=function(e,t){return i(this,e,"Marker","marker",t)};e.addPolyline=function(e,i){return t(this,this.addPolylines,e,i)};e.addPolylines=function(e,t){return i(this,e,"Polyline",TC.Consts.geom.POLYLINE,t)};e.addMultiPolyline=function(e,i){return t(this,this.addMultiPolylines,e,i)};e.addMultiPolylines=function(e,t){return i(this,e,"MultiPolyline",TC.Consts.geom.POLYLINE,t)};e.addPolygon=function(e,i){return t(this,this.addPolygons,e,i)};e.addPolygons=function(e,t){return i(this,e,"Polygon",TC.Consts.geom.POLYGON,t)};e.addMultiPolygon=function(e,i){return t(this,this.addMultiPolygons,e,i)};e.addMultiPolygons=function(e,t){return i(this,e,"MultiPolygon",TC.Consts.geom.POLYGON,t)};e.addCircle=function(e,i){return t(this,this.addCircles,e,i)};e.addCircles=function(e,t){return i(this,e,"Circle",TC.Consts.geom.POLYGON,t)};e.addFeature=function(e){var t;TC.feature&&(TC.feature.Point&&e instanceof TC.feature.Point?t=this.addPoint(e):TC.feature.Polyline&&e instanceof TC.feature.Polyline?t=this.addPolyline(e):TC.feature.Polygon&&e instanceof TC.feature.Polygon?t=this.addPolygon(e):TC.feature.MultiPolygon&&e instanceof TC.feature.MultiPolygon?t=this.addMultiPolygon(e):TC.feature.MultiPolyline&&e instanceof TC.feature.MultiPolyline?t=this.addMultiPolyline(e):TC.feature.Circle&&e instanceof TC.feature.Circle&&(t=this.addCircle(e)));return t};e.removeFeature=function(e){const t=this;if(t.map){t.map.getControlsByClass("TC.control.Popup").forEach(function(t){t.isVisible()&&t.currentFeature===e&&t.hide()})}t.wrap.removeFeature(e)};e.getFeatureById=function(e){var t=null,i=this.wrap.getFeatureById(e);i&&(t=i._wrap.parent);return t};e.clearFeatures=function(){var e=this;if(e.features&&e.wrap){if(e.map){e.map.getControlsByClass("TC.control.Popup").forEach(function(t){t.isVisible()&&e.features.indexOf(t.currentFeature)>=0&&t.hide()})}e.features.length=0;e.wrap.clearFeatures()}};e.describeFeatureType=function(e,t){var i=$.Deferred();$.ajax({url:this.wrap.getDescribeFeatureTypeUrl(),type:"GET",dataType:"xml"}).then(function(e){var t="http://www.w3.org/2001/XMLSchema",n=e.getElementsByTagNameNS(t,"complexType")[0];if(n){for(var r=n.getElementsByTagNameNS(t,"element"),s=new Array(r.length),a=0,o=r.length;a<o;a++){var l=r[a];s[a]={name:l.getAttribute("name"),type:l.getAttribute("type"),nillable:"true"===l.getAttribute("nillable"),minOccurs:parseInt(l.getAttribute("minOccurs")),maxOccurs:parseInt(l.getAttribute("maxOccurs"))}}i.resolve(s)}else{var c=e.getElementsByTagName("Exception")[0];c&&i.reject(c.getElementsByTagName("ExceptionText")[0].innerHTML)}},function(e,t,n){i.reject(n)});i.then(function(t){$.isFunction(e)&&e(t)},function(e){$.isFunction(t)&&t(e)});return i.promise()};e.import=function(e){this.wrap.import(e)};e.setNodeVisibility=function(e,t){this.state=TC.Layer.state.LOADING;this.map.$events.trigger($.Event(TC.Consts.event.BEFOREUPDATE));this.map.$events.trigger($.Event(TC.Consts.event.BEFORELAYERUPDATE,{layer:this}));this.tree||(this.tree=this.getTree());if(this.findNode(e,this.tree)===this.tree)this.setVisibility(t);else{this._cache.visibilityStates[e]=t?TC.Consts.visibility.VISIBLE:TC.Consts.visibility.NOT_VISIBLE;var i,n,r=!1;for(i=0;i<this.features.length;i++)if((n=this.features[i]).id==e){r=!0;n.setVisibility(t);break}if(!r)for(i=0;i<this.features.length;i++){void 0===(n=this.features[i])._path&&(n._path="/"+n.getPath().join("/"));n._path===e&&n.setVisibility(t)}}this.state=TC.Layer.state.IDLE;this.map.$events.trigger($.Event(TC.Consts.event.LAYERUPDATE,{layer:this}));this.map.$events.trigger($.Event(TC.Consts.event.UPDATE))};e.getNodeVisibility=function(e){var t=TC.Layer.prototype.getNodeVisibility.call(this,e);this.tree||(this.tree=this.getTree());if(this.findNode(e,this.tree)===this.tree)t=this.getVisibility()?TC.Consts.visibility.VISIBLE:TC.Consts.visibility.NOT_VISIBLE;else{var i=this._cache.visibilityStates[e];void 0!==i&&(t=i)}return t};e.setModifiable=function(e){this.wrap.setModifiable(e)};e.applyEdits=function(e,t,i){return this.wrap.sendTransaction(e,t,i)};e.refresh=function(){return this.wrap.reloadSource()};e.getFeaturesInCurrentExtent=function(e){var t=this.map.getExtent();return this.getFeaturesInExtent(t,e)};e.getFeaturesInExtent=function(e,t){return this.wrap.getFeaturesInExtent(e,t)};e.setProjection=function(e){const t=this;t.wrap.setProjection(e);if(e.crs&&e.oldCrs){t.map.$events.trigger($.Event(TC.Consts.event.BEFORELAYERUPDATE,{layer:t}));t.features.forEach(function(t){t.wrap.setGeometry(TC.Util.reproject(t.geometry,e.oldCrs,e.crs));t.geometry=t.wrap.getGeometry()});t.map.$events.trigger($.Event(TC.Consts.event.LAYERUPDATE,{layer:t}))}};const n=function(e){return $.isArray(e)?e.map(n):e};e.exportState=function(e){const t=this;e=e||{};const i={id:t.id};t.map&&t.map.crs!==t.map.options.crs&&(i.crs=t.map.crs);var r=Math.pow(10,(t.map.wrap.isGeo()?TC.Consts.DEGREE_PRECISION:TC.Consts.METER_PRECISION)+1);i.features=t.features.map(function(i){const s={};var a;switch(!0){case TC.feature.Point&&i instanceof TC.feature.Point:s.type=TC.Consts.geom.POINT;a=t.options.styles&&t.options.styles.point;break;case TC.feature.Marker&&i instanceof TC.feature.Marker:s.type=TC.Consts.geom.POINT;a=t.options.styles&&t.options.styles.marker;break;case TC.feature.Polyline&&i instanceof TC.feature.Polyline:s.type=TC.Consts.geom.POLYLINE;a=t.options.styles&&t.options.styles.line;break;case TC.feature.MultiPolyline&&i instanceof TC.feature.MultiPolyline:s.type=TC.Consts.geom.MULTIPOLYLINE;a=t.options.styles&&t.options.styles.line;break;case TC.feature.Polygon&&i instanceof TC.feature.Polygon:s.type=TC.Consts.geom.POLYGON;a=t.options.styles&&t.options.styles.polygon;break;case TC.feature.MultiPolygon&&i instanceof TC.feature.MultiPolygon:s.type=TC.Consts.geom.MULTIPOLYGON;a=t.options.styles&&t.options.styles.polygon;break;case TC.feature.Circle&&i instanceof TC.feature.Circle:s.type=TC.Consts.geom.CIRCLE;a=t.options.styles&&t.options.styles.polygon}s.id=i.id;s.geom=function(e,t){const i=[Number.MAX_VALUE,Number.MAX_VALUE],r=e.map(n),s=function(e,t){$.isArray(e)?e.forEach(s):0===t&&e<i[0]?i[0]=e:1===t&&e<i[1]&&(i[1]=e)};r.forEach(s);const a=function(e){return Math.round(e*t)/t};i[0]=a(i[0]);i[1]=a(i[1]);const o=function(e,t,n){if($.isArray(e))e.forEach(o);else{0===t&&(n[0]=a(e-i[0]));1===t&&(n[1]=a(e-i[1]))}};r.forEach(o);return{origin:i,geom:r}}(i.geometry,r);s.data=i.getData();s.showsPopup=i.showsPopup;if(void 0===e.exportStyles||e.exportStyles){a=$.extend({},a);for(var o in a){var l=a[o];$.isFunction(l)&&(a[o]=l(i))}s.style=$.extend(a,i.getStyle())}return s});return i};e.importState=function(e){const t=this,i=$.Deferred(),n=new Array(e.features.length);e.features.forEach(function(i,r){const s=$.extend(i.style,{data:i.data,id:i.id,showsPopup:i.showsPopup});var a;switch(i.type){case TC.Consts.geom.POLYGON:a=t.addPolygon;break;case TC.Consts.geom.MULTIPOLYGON:a=t.addMultiPolygon;break;case TC.Consts.geom.POLYLINE:a=t.addPolyline;break;case TC.Consts.geom.MULTIPOLYLINE:a=t.addMultiPolyline;break;case TC.Consts.geom.CIRCLE:a=t.addCircle;break;case TC.Consts.geom.POINT:a=i.style&&(i.style.url||i.style.className)?t.addMarker:t.addPoint}if(a){var o=function(e){const t=e.origin,i=function(e,n,r){if($.isArray(e))e.forEach(i);else{0===n&&(r[0]=e+t[0]);1===n&&(r[1]=e+t[1])}};e.geom.forEach(i);return e.geom}(i.geom);e.crs&&t.map.crs!==e.crs&&(o=TC.Util.reproject(o,e.crs,t.map.crs));n[r]=a.call(t,o,s)}});$.when.apply($,n).then(function(){i.resolve()},function(){i.reject()});return i.promise()}}();function xml2json(e){var t={toObj:function(e){var i={};if(1==e.nodeType){if(e.attributes.length)for(var n=0;n<e.attributes.length;n++)"name"!==e.attributes[n].nodeName&&(i[e.attributes[n].nodeName]=(e.attributes[n].nodeValue||"").toString());if(e.firstChild){for(var r=0,s=0,a=!1,o=e.firstChild;o;o=o.nextSibling)1==o.nodeType?a=!0:3==o.nodeType&&o.nodeValue.match(/[^ \f\n\r\t\v]/)?r++:4==o.nodeType&&s++;if(a)if(2>r&&2>s){t.removeWhite(e);for(o=e.firstChild;o;o=o.nextSibling){var l=t.removePrefix(o.nodeName);if(3==o.nodeType)i["#text"]=t.escape(o.nodeValue);else if(4==o.nodeType)i["#cdata"]=t.escape(o.nodeValue);else if(i[l])i[l]instanceof Array?i[l][i[l].length]=t.toObj(o):i[l]=[i[l],t.toObj(o)];else{var c=null;o.attributes.getNamedItem("name")&&(c=o.attributes.getNamedItem("name").nodeValue),i[c||l]=t.toObj(o)}}}else e.attributes.length?i["#text"]=t.escape(t.innerXml(e)):i=t.escape(t.innerXml(e));else if(r)e.attributes.length?i["#text"]=t.escape(t.innerXml(e)):i=t.escape(t.innerXml(e));else if(s)if(s>1)i=t.escape(t.innerXml(e));else for(o=e.firstChild;o;o=o.nextSibling)i["#cdata"]=t.escape(o.nodeValue)}e.attributes.length||e.firstChild||(i=null)}else 9==e.nodeType?i=t.toObj(e.documentElement):8==e.nodeType?console.log(e.textContent):alert("unhandled node type: "+e.nodeType);return i},toJson:function(e,i,n){var r=i?'"'+i+'"':"";if(e instanceof Array){for(var s=0,a=e.length;a>s;s++)e[s]=t.toJson(e[s],"",n+"\t");r+=(i?":[":"[")+(e.length>1?"\n"+n+"\t"+e.join(",\n"+n+"\t")+"\n"+n:e.join(""))+"]"}else if(null==e)r+=(i&&":")+"null";else if("object"==typeof e){var o=[];for(var l in e)o[o.length]=t.toJson(e[l],l,n+"\t");r+=(i?":{":"{")+(o.length>1?"\n"+n+"\t"+o.join(",\n"+n+"\t")+"\n"+n:o.join(""))+"}"}else r+="string"==typeof e?(i&&":")+'"'+e.toString()+'"':(i&&":")+e.toString();return r},innerXml:function(e){var t="";if("innerHTML"in e)t=e.innerHTML;else for(var i=function(e){var t="";if(1==e.nodeType){t+="<"+e.nodeName;for(var n=0;n<e.attributes.length;n++)t+=" "+e.attributes[n].nodeName+'="'+(e.attributes[n].nodeValue||"").toString()+'"';if(e.firstChild){t+=">";for(var r=e.firstChild;r;r=r.nextSibling)t+=i(r);t+="</"+e.nodeName+">"}else t+="/>"}else 3==e.nodeType?t+=e.nodeValue:4==e.nodeType&&(t+="<![CDATA["+e.nodeValue+"]]>");return t},n=e.firstChild;n;n=n.nextSibling)t+=i(n);return t},escape:function(e){return e.replace(/[\\]/g,"\\\\").replace(/[\"]/g,'\\"').replace(/[\n]/g,"\\n").replace(/[\r]/g,"\\r")},removeWhite:function(e){e.normalize();for(var i=e.firstChild;i;)if(3==i.nodeType)if(i.nodeValue.match(/[^ \f\n\r\t\v]/))i=i.nextSibling;else{var n=i.nextSibling;e.removeChild(i),i=n}else 1==i.nodeType?(t.removeWhite(i),i=i.nextSibling):i=i.nextSibling;return e},removePrefix:function(e){return e.substring(e.indexOf(":")+1)}};return 9==e.nodeType&&(e=e.documentElement),t.toObj(t.removeWhite(e))}var WFSCapabilities=function(){var e="1.0.0",t="1.1.0",i="2.0.0",n=function(n,r){switch(r){case e:var s=n.Capability.Request;if(s.GetFeature){var a=[];for(var o in s.GetFeature.ResultFormat)a.push(o.toLowerCase());s.GetFeature.outputFormat=a,delete s.GetFeature.ResultFormat,s.GetFeature.Operations=n.FeatureTypeList.Operations}return s;case t:return{};case i:var l={};for(var o in n.OperationsMetadata){var c={};c[o]=n.OperationsMetadata[o];for(var u in c[o])c[o][u]&&c[o][u].hasOwnProperty("AllowedValues")&&(c[o][u]=c[o][u].AllowedValues.Value);$.extend(l,c)}return l}return null},r=function(n,r){switch(r){case e:for(var s={},a=0;a<n.FeatureTypeList.FeatureType.length;a++){s[(o=n.FeatureTypeList.FeatureType[a].Name).substring(o.indexOf(":")+1)]=n.FeatureTypeList.FeatureType[a]}return s;case t:return{};case i:for(s={},a=0;a<n.FeatureTypeList.FeatureType.length;a++){var o;s[(o=n.FeatureTypeList.FeatureType[a].Name).substring(o.indexOf(":")+1)]=n.FeatureTypeList.FeatureType[a]}return s}return null},s=function(n,r){switch(r){case e:return n.Filter_Capabilities;case t:return{};case i:return n.Filter_Capabilities}return null},a=function(n,r){switch(r){case e:var s={};for(var a in n)"string"==typeof n[a]&&(s[a]=n[a]);return s;case t:return{};case i:s={};for(var a in n)"string"==typeof n[a]&&(s[a]=n[a]);return s}return{}};return{Promises:function(e){e=e;var t=$.Deferred(),i=e.substring(e.indexOf("://")<0?0:e.indexOf("://")+3);if(TC.capabilities[i])return t.resolve(TC.capabilities[i]),t;var n={SERVICE:"WFS",VERSION:"2.0.0",REQUEST:"GetCapabilities"};return $.ajax({url:TC.proxify(e)+"?"+$.param(n),type:"GET"}).then(function(){var e=WFSCapabilities.Parse(arguments[0]),n=e.Operations.GetCapabilities.DCP&&e.Operations.GetCapabilities.DCP.HTTP.Get["xlink:href"]||e.Operations.GetCapabilities.DCPType[0].HTTP.Get.onlineResource;TC.capabilities[n]=e,TC.capabilities[i]=e,t.resolve(WFSCapabilities.Parse(arguments[0]))}),t},Parse:function(){var o,l,c,u,h=xml2json(arguments[0]);switch(h.version){case e:o=e;break;case t:o=t;break;case i:o=i}l=n(h,o),c=r(h,o),u=s(h,o);var p=a(h,o),d={Operations:l,FeatureTypes:c,Filters:u};return $.extend(d,p),d}}}(),TC=TC||{};TC.Geometry=TC.Geometry||{isPoint:function(e){return $.isArray(e)&&e.length>=2&&"number"==typeof e[0]&&"number"==typeof e[1]},isRing:function(e){return $.isArray(e)&&(0===e.length||TC.Geometry.isPoint(e[0]))},isRingCollection:function(e){return $.isArray(e)&&(0===e.length||TC.Geometry.isRing(e[0]))},isMultiRingCollection:function(e){return $.isArray(e)&&(0===e.length||TC.Geometry.isRingCollection(e[0]))},getNearest:function(e,t){return TC.wrap.Geometry.getNearest(e,t)},isInside:function e(t,i){var n=!1;if(TC.Geometry.isPoint(t))if(TC.Geometry.isPoint(i))n=t[0]===i[0]&&t[1]===i[1];else if(TC.Geometry.isRing(i))for(var r=0,s=i.length-1;r<i.length;s=r++){var a=i[r][0],o=i[r][1],l=i[s][0],c=i[s][1];o>t[1]!=c>t[1]&&t[0]<(l-a)*(t[1]-o)/(c-o)+a&&(n=!n)}else if(TC.Geometry.isRingCollection(i)&&i.length>0){if(e(t,i[0])){var u=!1;for(r=1;r<i.length;r++)if(e(t,i[r])){u=!0;break}u||(n=!0)}}else if(TC.Geometry.isMultiRingCollection(i)&&i.length>0){r=0;for(var h=i.length;r<h;r++)if(e(t,i[r])){n=!0;break}}return n}};var SITNA=window.SITNA||{},TC=window.TC||{};TC.isDebug=!1;!function(){if(!window.TC||!window.TC.Cfg){if(document.currentScript)r=document.currentScript;else{var e=document.getElementsByTagName("script");r=e[e.length-1]}var t=r.getAttribute("src");TC.apiLocation=t.substr(0,t.lastIndexOf("/")+1);var i=TC.apiLocation+(TC.isDebug?"tcmap.js":"tcmap.min.js"),n=new XMLHttpRequest;n.open("GET",i,!1);n.send(null);var r,s=document.getElementsByTagName("head")[0];(r=document.createElement("script")).type="text/javascript";r.text=n.responseText;s.appendChild(r)}}();SITNA.Consts=TC.Consts;SITNA.Cfg=TC.Cfg;SITNA.Cfg.layout=TC.apiLocation+"TC/layout/responsive";SITNA.Map=function(e,t){var i=this;TC.Cfg.controls.search.allowedSearchTypes=$.extend(TC.Cfg.controls.search.allowedSearchTypes,{urban:{},street:{},number:{},cadastral:{}});if(t&&t.controls&&t.controls.search){var n=Object.keys(t.controls.search),r=$.extend(t.controls.search,{allowedSearchTypes:{}});n.forEach(function(e){if("boolean"==typeof t.controls.search[e]||$.isPlainObject(t.controls.search[e])){if(t.controls.search[e])switch(!0){case"postalAddress"===e:r.allowedSearchTypes[TC.Consts.searchType.NUMBER]=$.isPlainObject(t.controls.search[e])?t.controls.search[e]:{};break;case"cadastralParcel"===e:r.allowedSearchTypes[TC.Consts.searchType.CADASTRAL]=$.isPlainObject(t.controls.search[e])?t.controls.search[e]:{};break;case"town"===e:r.allowedSearchTypes[TC.Consts.searchType.URBAN]=$.isPlainObject(t.controls.search[e])?t.controls.search[e]:{};break;default:r.allowedSearchTypes[e]=$.isPlainObject(t.controls.search[e])?t.controls.search[e]:{}}delete r[e]}});t.controls.search=r}var s,a,o=new TC.Map(e,t);i.addLayer=function(e,t){o.addLayer(e,t)};i.setBaseLayer=function(e,t){o.setBaseLayer(e,t)};i.addMarker=function(e,t){o.addMarker(e,t)};i.zoomToMarkers=function(e){o.zoomToMarkers(e)};i.loaded=function(e){o.loaded(e)};o.loaded(function(){TC.loadJS(!TC.control.Search,TC.apiLocation+"TC/control/Search",function(){(s=new TC.control.Search).register(o);s.getLayer().then(function(e){a=e})});if(!o.activeControl){var e=o.getControlsByClass("TC.control.FeatureInfo")[0];e&&e.activate()}});i.getQueryableData=function(e,t){var i=s.availableSearchTypes[e];if(i.queryableData)t&&t(i.queryableData);else{var n={request:"GetFeature",service:"WFS",typename:i.featurePrefix+":"+i.featureType,version:i.version,propertyname:(i.dataIdProperty instanceof Array?i.dataIdProperty:[i.dataIdProperty]).concat(i.outputProperties instanceof Array?i.outputProperties:[i.outputProperties]).join(","),outputformat:TC.Consts.format.JSON},r=i.url+"?"+$.param(n);$.ajax({url:r}).done(function(e){i.queryableData=[];if(e.features)for(var n=e.features,r=0;r<n.length;r++){var a=n[r];e={id:[]};i.dataIdProperty instanceof Array||(i.dataIdProperty=[i.dataIdProperty]);for(var o=0;o<i.dataIdProperty.length;o++)a.properties.hasOwnProperty(i.dataIdProperty[o])&&e.id.push(a.properties[i.dataIdProperty[o]]);e.id=i.idPropertiesIdentifier?e.id.join(i.idPropertiesIdentifier):e.id.join("");e.label=[];i.outputProperties instanceof Array||(i.outputProperties=[i.outputProperties]);for(var l=0;l<i.outputProperties.length;l++)a.properties.hasOwnProperty(i.outputProperties[l])&&e.label.push(a.properties[i.outputProperties[l]]);var c=e.label instanceof Array&&e.label.join("").trim().length>0||!(e.label instanceof Array)&&e.label.trim().length>0;e.label=i.outputFormatLabel?i.outputFormatLabel.tcFormat(e.label):e.label.join("-");c&&i.queryableData.push(e)}i.queryableData=i.queryableData.sort(function(e,t){return i.idPropertiesIdentifier&&-1==e.id.indexOf(i.idPropertiesIdentifier)?s.removePunctuation(e.label)<s.removePunctuation(t.label)?-1:s.removePunctuation(e.label)>s.removePunctuation(t.label)?1:0:s.removePunctuation(e.label.split(" ")[0])<s.removePunctuation(t.label.split(" ")[0])?-1:s.removePunctuation(e.label.split(" ")[0])>s.removePunctuation(t.label.split(" ")[0])?1:0});i.queryableData=i.queryableData.filter(function(e,t,i){return t<1||e.id!==i[t-1].id&&e.label!==i[t-1].label});t&&t(i.queryableData)})}};i.getMunicipalities=function(e){i.getQueryableData(SITNA.Consts.mapSearchType.MUNICIPALITY,e)};i.getUrbanAreas=function(e){i.getQueryableData(SITNA.Consts.mapSearchType.URBAN,e)};i.getCommonwealths=function(e){i.getQueryableData(SITNA.Consts.mapSearchType.COMMONWEALTH,e)};i.getCouncils=function(e){i.getQueryableData(SITNA.Consts.mapSearchType.COUNCIL,e)};i.searchCommonwealth=function(e,t){i.searchTyped(SITNA.Consts.mapSearchType.COMMONWEALTH,e,t)};i.searchCouncil=function(e,t){i.searchTyped(SITNA.Consts.mapSearchType.COUNCIL,e,t)};i.searchUrbanArea=function(e,t){i.searchTyped(SITNA.Consts.mapSearchType.URBAN,e,t)};i.searchMunicipality=function(e,t){i.searchTyped(SITNA.Consts.mapSearchType.MUNICIPALITY,e,t)};i.searchTyped=function(e,t,n){var r=TC.getUID(),l=s.availableSearchTypes[e];t instanceof Array&&l.goToIdFormat&&(t=l.goToIdFormat.tcFormat(t));s._search.data=s._search.data||[];s._search.data.push({dataLayer:l.featureType,dataRole:e,id:t,label:"",text:""});i.removeSearch();if(s.availableSearchTypes[e]&&!s.getSearchTypeByRole(e)){s.availableSearchTypes[e].goTo||(s.availableSearchTypes[e].goTo=function(e){var t=function(e){TC.filter||TC.syncLoadJS(TC.apiLocation+"TC/Filter");var t=[];l.idPropertiesIdentifier&&(e=e.split(l.idPropertiesIdentifier));e instanceof Array||(e=[e]);for(var i=0;i<l.dataIdProperty.length;i++)t.push(new TC.filter.equalTo(l.dataIdProperty[i],$.trim(e[i])));return t=t.length>1?new TC.filter.and(t):t[0]}(e);return{params:{type:TC.Consts.layerType.WFS,url:this.url,version:this.version,geometryName:this.geometryName,featurePrefix:this.featurePrefix,featureType:this.featureType,properties:t,outputFormat:this.outputFormat,styles:this.styles}}}.bind(l));s.addAllowedSearchType(e,s.availableSearchTypes[e],s)}o.one(TC.Consts.event.SEARCHQUERYEMPTY,function(e){o.toast(s.EMPTY_RESULTS_LABEL,{type:TC.Consts.msgType.INFO,duration:5e3});n&&n(null)});o.one(TC.Consts.event.FEATURESADD,function(t){t.layer==a&&t.layer.features&&t.layer.features.length>0&&o.zoomToFeatures(t.layer.features);i.search={layer:t.layer,type:e};n&&n(t.layer.id!==r?t.layer.id:r)});s.goToResult(t,e)};i.searchFeature=function(e,t,n,r){var a=TC.getUID(),l=s.featurePrefix;i.removeSearch();e=(e||"").trim();t=(t||"").trim();n=(n||"").trim();if(0==e.length||0==t.length||0==n.length){o.toast(s.EMPTY_RESULTS_LABEL,{type:TC.Consts.msgType.INFO,duration:5e3});r&&r(null)}else{if(e.indexOf(":")>-1){l=e.split(":")[0];e=e.split(":")[1]}var c,u={id:a,type:SITNA.Consts.layerType.WFS,url:s.url,version:s.version,stealth:!0,geometryName:"the_geom",featurePrefix:l,featureType:e,maxFeatures:1,properties:function(e){TC.filter||TC.syncLoadJS(TC.apiLocation+"TC/Filter");if(e&&e instanceof Array){var t=e.map(function(e){if(!e.hasOwnProperty("type"))return new TC.filter.equalTo(e.name,e.value);switch(!0){case e.type==TC.Consts.comparison.EQUAL_TO:return new TC.filter.equalTo(e.name,e.value)}});return t.length>1?TC.filter.and.apply(null,t):t[0]}}([{name:t,value:n,type:TC.Consts.comparison.EQUAL_TO}]),outputFormat:TC.Consts.format.JSON};o.addLayer(u).then(function(e){c=e;i.search={layer:e,type:SITNA.Consts.mapSearchType.GENERIC}});o.on(TC.Consts.event.FEATURESADD,function(e){if(e.layer==c&&e.layer.features&&e.layer.features.length>0){for(var t=0;t<e.layer.features.length;t++)e.layer.features[t].showsPopup!=s.queryableFeatures&&(e.layer.features[t].showsPopup=s.queryableFeatures);o.zoomToFeatures(e.layer.features)}});o.on(TC.Consts.event.LAYERUPDATE,function(e){e.layer==c&&e.newData&&e.newData.features&&0==e.newData.features.length&&o.toast(s.EMPTY_RESULTS_LABEL,{type:TC.Consts.msgType.INFO,duration:5e3});r&&r(e.layer==c&&e.newData&&e.newData.features&&0==e.newData.features.length?null:a)})}};i.removeSearch=function(e){if(i.search)if(s.availableSearchTypes[i.search.type]&&s.availableSearchTypes[i.search.type].hasOwnProperty("goTo")){for(var t=0;t<i.search.layer.features.length;t++)i.search.layer.removeFeature(i.search.layer.features[t]);i.search=null}else o.removeLayer(i.search.layer).then(function(){i.search=null});e&&e()};i.exportImage=function(){return o.exportImage()};i.search=null};