TC.tool=TC.tool||{};TC.tool.Proxification=function(t,e){this.Consts={url:{SPLIT_REGEX:/([^:]*:)?\/\/([^:]*:?[^@]*@)?([^:\/\?]*):?([^\/\?]*)/}};if(void 0===t)throw new TypeError('"proxy" parameter is undefined',"TC.tool.Proxification.js");this.proxy="function"==typeof t?t:function(e){var r=t;"http"!=e.substr(0,4)&&(r+=window.location.protocol);return r+=encodeURIComponent(e)};e=e||{};this._location=e.location||window.location;this.preventMixedContent=void 0===e.allowedMixedContent||!e.allowedMixedContent};!function(){"undefined"==typeof Promise&&(t=this,e=function(){"use strict";function t(t){return"function"==typeof t}function e(){var t=setTimeout;return function(){return t(r,1)}}function r(){for(var t=0;t<_;t+=2){(0,x[t])(x[t+1]),x[t]=void 0,x[t+1]=void 0}_=0}function n(t,e){var r=this,n=new this.constructor(i);void 0===n[S]&&m(n);var o=r._state;if(o){var s=arguments[o-1];w(function(){return y(o,n,s,r._result)})}else l(r,n,t,e);return n}function o(t){if(t&&"object"==typeof t&&t.constructor===this)return t;var e=new this(i);return u(e,t),e}function i(){}function s(t){try{return t.then}catch(t){return I.error=t,I}}function a(e,r,i){r.constructor===e.constructor&&i===n&&r.constructor.resolve===o?function(t,e){e._state===U?f(t,e._result):e._state===C?h(t,e._result):l(e,void 0,function(e){return u(t,e)},function(e){return h(t,e)})}(e,r):i===I?(h(e,I.error),I.error=null):void 0===i?f(e,r):t(i)?function(t,e,r){w(function(t){var n=!1,o=function(t,e,r,n){try{t.call(e,r,n)}catch(t){return t}}(r,e,function(r){n||(n=!0,e!==r?u(t,r):f(t,r))},function(e){n||(n=!0,h(t,e))},t._label);!n&&o&&(n=!0,h(t,o))},t)}(e,r,i):f(e,r)}function u(t,e){t===e?h(t,new TypeError("You cannot resolve a promise with itself")):function(t){var e=typeof t;return null!==t&&("object"===e||"function"===e)}(e)?a(t,e,s(e)):f(t,e)}function c(t){t._onerror&&t._onerror(t._result),d(t)}function f(t,e){t._state===B&&(t._result=e,t._state=U,0!==t._subscribers.length&&w(d,t))}function h(t,e){t._state===B&&(t._state=C,t._result=e,w(c,t))}function l(t,e,r,n){var o=t._subscribers,i=o.length;t._onerror=null,o[i]=e,o[i+U]=r,o[i+C]=n,0===i&&t._state&&w(d,t)}function d(t){var e=t._subscribers,r=t._state;if(0!==e.length){for(var n=void 0,o=void 0,i=t._result,s=0;s<e.length;s+=3)n=e[s],o=e[s+r],n?y(r,n,o,i):o(i);t._subscribers.length=0}}function p(){this.error=null}function y(e,r,n,o){var i=t(n),s=void 0,a=void 0,c=void 0,l=void 0;if(i){if((s=function(t,e){try{return t(e)}catch(t){return D.error=t,D}}(n,o))===D?(l=!0,a=s.error,s.error=null):c=!0,r===s)return void h(r,new TypeError("A promises callback cannot return that same promise."))}else s=o,c=!0;r._state!==B||(i&&c?u(r,s):l?h(r,a):e===U?f(r,s):e===C&&h(r,s))}function m(t){t[S]=j++,t._state=void 0,t._result=void 0,t._subscribers=[]}var v=Array.isArray?Array.isArray:function(t){return"[object Array]"===Object.prototype.toString.call(t)},_=0,g=void 0,b=void 0,w=function(t,e){x[_]=t,x[_+1]=e,2===(_+=2)&&(b?b(r):R())},T="undefined"!=typeof window?window:void 0,E=T||{},A=E.MutationObserver||E.WebKitMutationObserver,P="undefined"==typeof self&&"undefined"!=typeof process&&"[object process]"==={}.toString.call(process),O="undefined"!=typeof Uint8ClampedArray&&"undefined"!=typeof importScripts&&"undefined"!=typeof MessageChannel,x=new Array(1e3),R=void 0;R=P?function(){return process.nextTick(r)}:A?function(){var t=0,e=new A(r),n=document.createTextNode("");return e.observe(n,{characterData:!0}),function(){n.data=t=++t%2}}():O?function(){var t=new MessageChannel;return t.port1.onmessage=r,function(){return t.port2.postMessage(0)}}():void 0===T&&"function"==typeof require?function(){try{var t=require("vertx");return void 0!==(g=t.runOnLoop||t.runOnContext)?function(){g(r)}:e()}catch(t){return e()}}():e();var S=Math.random().toString(36).substring(16),B=void 0,U=1,C=2,I=new p,D=new p,j=0,L=function(){function t(t,e){this._instanceConstructor=t,this.promise=new t(i),this.promise[S]||m(this.promise),v(e)?(this.length=e.length,this._remaining=e.length,this._result=new Array(this.length),0===this.length?f(this.promise,this._result):(this.length=this.length||0,this._enumerate(e),0===this._remaining&&f(this.promise,this._result))):h(this.promise,new Error("Array Methods must be provided an Array"))}return t.prototype._enumerate=function(t){for(var e=0;this._state===B&&e<t.length;e++)this._eachEntry(t[e],e)},t.prototype._eachEntry=function(t,e){var r=this._instanceConstructor,u=r.resolve;if(u===o){var c=s(t);if(c===n&&t._state!==B)this._settledAt(t._state,e,t._result);else if("function"!=typeof c)this._remaining--,this._result[e]=t;else if(r===F){var f=new r(i);a(f,t,c),this._willSettleAt(f,e)}else this._willSettleAt(new r(function(e){return e(t)}),e)}else this._willSettleAt(u(t),e)},t.prototype._settledAt=function(t,e,r){var n=this.promise;n._state===B&&(this._remaining--,t===C?h(n,r):this._result[e]=r),0===this._remaining&&f(n,this._result)},t.prototype._willSettleAt=function(t,e){var r=this;l(t,void 0,function(t){return r._settledAt(U,e,t)},function(t){return r._settledAt(C,e,t)})},t}(),F=function(){function t(e){this[S]=j++,this._result=this._state=void 0,this._subscribers=[],i!==e&&("function"!=typeof e&&function(){throw new TypeError("You must pass a resolver function as the first argument to the promise constructor")}(),this instanceof t?function(t,e){try{e(function(e){u(t,e)},function(e){h(t,e)})}catch(e){h(t,e)}}(this,e):function(){throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.")}())}return t.prototype.catch=function(t){return this.then(null,t)},t.prototype.finally=function(t){var e=this.constructor;return this.then(function(r){return e.resolve(t()).then(function(){return r})},function(r){return e.resolve(t()).then(function(){throw r})})},t}();return F.prototype.then=n,F.all=function(t){return new L(this,t).promise},F.race=function(t){var e=this;return new e(v(t)?function(r,n){for(var o=t.length,i=0;i<o;i++)e.resolve(t[i]).then(r,n)}:function(t,e){return e(new TypeError("You must pass an array to race."))})},F.resolve=o,F.reject=function(t){var e=new this(i);return h(e,t),e},F._setScheduler=function(t){b=t},F._setAsap=function(t){w=t},F._asap=w,F.polyfill=function(){var t=void 0;if("undefined"!=typeof global)t=global;else if("undefined"!=typeof self)t=self;else try{t=Function("return this")()}catch(t){throw new Error("polyfill failed because global object is unavailable in this environment")}var e=t.Promise;if(e){var r=null;try{r=Object.prototype.toString.call(e.resolve())}catch(t){}if("[object Promise]"===r&&!e.cast)return}t.Promise=F},F.Promise=F,F},"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.ES6Promise=e());var t,e;window.fetch||function(t){"use strict";if(!t.fetch){var e={searchParams:"URLSearchParams"in t,iterable:"Symbol"in t&&"iterator"in Symbol,blob:"FileReader"in t&&"Blob"in t&&function(){try{new Blob;return!0}catch(t){return!1}}(),formData:"FormData"in t,arrayBuffer:"ArrayBuffer"in t};if(e.arrayBuffer)var r=["[object Int8Array]","[object Uint8Array]","[object Uint8ClampedArray]","[object Int16Array]","[object Uint16Array]","[object Int32Array]","[object Uint32Array]","[object Float32Array]","[object Float64Array]"],n=function(t){return t&&DataView.prototype.isPrototypeOf(t)},o=ArrayBuffer.isView||function(t){return t&&r.indexOf(Object.prototype.toString.call(t))>-1};f.prototype.append=function(t,e){t=a(t);e=u(e);var r=this.map[t];this.map[t]=r?r+","+e:e};f.prototype.delete=function(t){delete this.map[a(t)]};f.prototype.get=function(t){t=a(t);return this.has(t)?this.map[t]:null};f.prototype.has=function(t){return this.map.hasOwnProperty(a(t))};f.prototype.set=function(t,e){this.map[a(t)]=u(e)};f.prototype.forEach=function(t,e){for(var r in this.map)this.map.hasOwnProperty(r)&&t.call(e,this.map[r],r,this)};f.prototype.keys=function(){var t=[];this.forEach(function(e,r){t.push(r)});return c(t)};f.prototype.values=function(){var t=[];this.forEach(function(e){t.push(e)});return c(t)};f.prototype.entries=function(){var t=[];this.forEach(function(e,r){t.push([r,e])});return c(t)};e.iterable&&(f.prototype[Symbol.iterator]=f.prototype.entries);var i=["DELETE","GET","HEAD","OPTIONS","POST","PUT"];m.prototype.clone=function(){return new m(this,{body:this._bodyInit})};y.call(m.prototype);y.call(_.prototype);_.prototype.clone=function(){return new _(this._bodyInit,{status:this.status,statusText:this.statusText,headers:new f(this.headers),url:this.url})};_.error=function(){var t=new _(null,{status:0,statusText:""});t.type="error";return t};var s=[301,302,303,307,308];_.redirect=function(t,e){if(-1===s.indexOf(e))throw new RangeError("Invalid status code");return new _(null,{status:e,headers:{location:t}})};t.Headers=f;t.Request=m;t.Response=_;t.fetch=function(t,r){return new Promise(function(n,o){var i=new m(t,r),s=new XMLHttpRequest;s.onload=function(){var t={status:s.status,statusText:s.statusText,headers:function(t){var e=new f;t.replace(/\r?\n[\t ]+/g," ").split(/\r?\n/).forEach(function(t){var r=t.split(":"),n=r.shift().trim();if(n){var o=r.join(":").trim();e.append(n,o)}});return e}(s.getAllResponseHeaders()||"")};t.url="responseURL"in s?s.responseURL:t.headers.get("X-Request-URL");var e="response"in s?s.response:s.responseText;n(new _(e,t))};s.onerror=function(){o(new TypeError("Network request failed"))};s.ontimeout=function(){o(new TypeError("Network request failed"))};s.open(i.method,i.url,!0);"include"===i.credentials?s.withCredentials=!0:"omit"===i.credentials&&(s.withCredentials=!1);"responseType"in s&&e.blob&&(s.responseType="blob");i.headers.forEach(function(t,e){s.setRequestHeader(e,t)});s.send(void 0===i._bodyInit?null:i._bodyInit)})};t.fetch.polyfill=!0}function a(t){"string"!=typeof t&&(t=String(t));if(/[^a-z0-9\-#$%&'*+.\^_`|~]/i.test(t))throw new TypeError("Invalid character in header field name");return t.toLowerCase()}function u(t){"string"!=typeof t&&(t=String(t));return t}function c(t){var r={next:function(){var e=t.shift();return{done:void 0===e,value:e}}};e.iterable&&(r[Symbol.iterator]=function(){return r});return r}function f(t){this.map={};t instanceof f?t.forEach(function(t,e){this.append(e,t)},this):Array.isArray(t)?t.forEach(function(t){this.append(t[0],t[1])},this):t&&Object.getOwnPropertyNames(t).forEach(function(e){this.append(e,t[e])},this)}function h(t){if(t.bodyUsed)return Promise.reject(new TypeError("Already read"));t.bodyUsed=!0}function l(t){return new Promise(function(e,r){t.onload=function(){e(t.result)};t.onerror=function(){r(t.error)}})}function d(t){var e=new FileReader,r=l(e);e.readAsArrayBuffer(t);return r}function p(t){if(t.slice)return t.slice(0);var e=new Uint8Array(t.byteLength);e.set(new Uint8Array(t));return e.buffer}function y(){this.bodyUsed=!1;this._initBody=function(t){this._bodyInit=t;if(t)if("string"==typeof t)this._bodyText=t;else if(e.blob&&Blob.prototype.isPrototypeOf(t))this._bodyBlob=t;else if(e.formData&&FormData.prototype.isPrototypeOf(t))this._bodyFormData=t;else if(e.searchParams&&URLSearchParams.prototype.isPrototypeOf(t))this._bodyText=t.toString();else if(e.arrayBuffer&&e.blob&&n(t)){this._bodyArrayBuffer=p(t.buffer);this._bodyInit=new Blob([this._bodyArrayBuffer])}else{if(!e.arrayBuffer||!ArrayBuffer.prototype.isPrototypeOf(t)&&!o(t))throw new Error("unsupported BodyInit type");this._bodyArrayBuffer=p(t)}else this._bodyText="";this.headers.get("content-type")||("string"==typeof t?this.headers.set("content-type","text/plain;charset=UTF-8"):this._bodyBlob&&this._bodyBlob.type?this.headers.set("content-type",this._bodyBlob.type):e.searchParams&&URLSearchParams.prototype.isPrototypeOf(t)&&this.headers.set("content-type","application/x-www-form-urlencoded;charset=UTF-8"))};if(e.blob){this.blob=function(){var t=h(this);if(t)return t;if(this._bodyBlob)return Promise.resolve(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(new Blob([this._bodyArrayBuffer]));if(this._bodyFormData)throw new Error("could not read FormData body as blob");return Promise.resolve(new Blob([this._bodyText]))};this.arrayBuffer=function(){return this._bodyArrayBuffer?h(this)||Promise.resolve(this._bodyArrayBuffer):this.blob().then(d)}}this.text=function(){var t=h(this);if(t)return t;if(this._bodyBlob)return function(t){var e=new FileReader,r=l(e);e.readAsText(t);return r}(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(function(t){for(var e=new Uint8Array(t),r=new Array(e.length),n=0;n<e.length;n++)r[n]=String.fromCharCode(e[n]);return r.join("")}(this._bodyArrayBuffer));if(this._bodyFormData)throw new Error("could not read FormData body as text");return Promise.resolve(this._bodyText)};e.formData&&(this.formData=function(){return this.text().then(v)});this.json=function(){return this.text().then(JSON.parse)};return this}function m(t,e){var r,n,o=(e=e||{}).body;if(t instanceof m){if(t.bodyUsed)throw new TypeError("Already read");this.url=t.url;this.credentials=t.credentials;e.headers||(this.headers=new f(t.headers));this.method=t.method;this.mode=t.mode;if(!o&&null!=t._bodyInit){o=t._bodyInit;t.bodyUsed=!0}}else this.url=String(t);this.credentials=e.credentials||this.credentials||"omit";!e.headers&&this.headers||(this.headers=new f(e.headers));this.method=(r=e.method||this.method||"GET",n=r.toUpperCase(),i.indexOf(n)>-1?n:r);this.mode=e.mode||this.mode||null;this.referrer=null;if(("GET"===this.method||"HEAD"===this.method)&&o)throw new TypeError("Body not allowed for GET or HEAD requests");this._initBody(o)}function v(t){var e=new FormData;t.trim().split("&").forEach(function(t){if(t){var r=t.split("="),n=r.shift().replace(/\+/g," "),o=r.join("=").replace(/\+/g," ");e.append(decodeURIComponent(n),decodeURIComponent(o))}});return e}function _(t,e){e||(e={});this.type="default";this.status=void 0===e.status?200:e.status;this.ok=this.status>=200&&this.status<300;this.statusText="statusText"in e?e.statusText:"OK";this.headers=new f(e.headers);this.url=e.url||"";this._initBody(t)}}("undefined"!=typeof self?self:this);var r=function(t){if(window.URL)try{var e=new URL(t);if(e.origin)return e}catch(t){}var r=document.createElement("a");r.href=t;r.origin||(r.origin=r.protocol+"//"+r.hostname+(r.port&&t.indexOf(r.port)>-1?":"+r.port:""));return r},n=TC.tool.Proxification.prototype;n.cacheHost=new function(){var t=function(t){var e=r(t);return e?e.origin:null};this._hosts=[];this.is=function(e){var r=t(e);return null!==this.get(r)};this.get=function(t){if(0===this._hosts.length)return null;var e=this._hosts.filter(function(e){return e.key===t});return 0===e.length?null:e[0]};this.addKey=function(e){var r=t(e);this._hosts.push({key:r,action:null});return this._hosts[this._hosts.length-1]};this.getAction=function(e){var r=t(e);return this.get(r)._actionPromise}};n._isServiceWorker=function(){return!!navigator.serviceWorker&&!(!navigator.serviceWorker.controller||"activated"!==navigator.serviceWorker.controller.state)};n._isSameOrigin=function(t){var e=0!==t.indexOf("http")&&0!==t.indexOf("//"),r=!e&&t.match(this.Consts.url.SPLIT_REGEX);if(r){var n=r[1];e=(n==this._location.protocol||void 0==n)&&r[3]==this._location.hostname;var o=r[4],i=this._location.port;(80!=o&&""!==o||"80"!=i&&""!==i)&&(e=e&&o==i)}return e};n._isSameProtocol=function(t){var e=/^(https?:\/\/)/i,r=t.match(e);if(r&&r.length>1){var n=self._location.match(e);if(n&&n.length>1)return r[0].trim()===n[0].trim()}return!1};n._isSecureURL=function(t){return!/^(f|ht)tps?:\/\//i.test(t)||/^(f|ht)tps:\/\//i.test(t)};var o=function(t,e){var n=r(t);return t.replace(n.protocol,e)},i=function(t){return o(t,"https:")},s=function(t){return o(t,"http:")},a=function(t,e,r,n){var o=this;t=i(t);(e?o._image.getImgTag(t,e):o._image.getImgTag(t)).then(function(t){r(t,o._actionHTTPS)},function(i){c.call(o,s(t),e,r,n)})},u=function(t,e,r,n){var o=this;t=s(t);fn=e?o._image.getImgTag(t,e):o._image.getImgTag(t);fn.then(function(t){r(t,o._actionHTTP)},function(s){c.call(o,i(t),e,r,n)})},c=function(t,e,r,n){var o=this;fn=e?o._image.getImgTagByAction(t,e,o._actionProxy.bind(o)):o._image.getImgTagByAction(t,!1,o._actionProxy.bind(o));fn.then(function(t){r(t,o._actionProxy)},function(t){n(t)})};n._actionDirect=function(t){return t};n._actionHTTP=function(t){return o(t,"http:")};n._actionHTTPS=function(t){return o(t,"https:")};n._actionProxy=function(t){return this.proxy(t)};n._image={ErrorType:{CORS:"cors",NOTFOUNDED:"notfounded",UNEXPECTED:"unexpected"},getImgTag:function(t,e){return new Promise(function(r,n){var o=this,i=document.createElement("img");if(e){i.dataset.checkCORSHeaders=!0;i.crossOrigin="anonymous"}i.onload=function(){console.log("Load OK: "+i.src);i.onload=i.onerror=void 0;if(e){try{var t=function(t){var e=document.createElement("CANVAS"),r=e.getContext("2d");e.height=t.height;e.width=t.width;r.drawImage(t,0,0);return e}(i);result=t.toDataURL("image/png");r(i)}catch(t){18===t.code?n(o.ErrorType.CORS):r(i)}}else r(i)};i.onerror=function(){console.log("Load crossOrigin ERROR: "+i.src);if(i.dataset.checkCORSHeaders){i.crossOrigin=null;i.onerror=void 0;i.onerror=function(){console.log("Load ERROR: "+i.src);i.onload=i.onerror=void 0;n(o.ErrorType.NOTFOUNDED)};i.src=t}else{console.log("Load ERROR: "+i.src);i.onload=i.onerror=void 0;n(o.ErrorType.NOTFOUNDED)}};try{i.src=t}catch(t){console.log("Load ERROR: "+i.src);n(o.ErrorType.UNEXPECTED)}}.bind(n._image))},getImgTagByAction:function(t,e,r){return new Promise(function(n,o){var i=this,s=document.createElement("img");e&&(s.crossOrigin="anonymous");s.onload=function(){s.onload=s.onerror=void 0;n(s)};s.onerror=function(){console.log("Load ERROR: "+s.src);s.onload=s.onerror=void 0;o(i.ErrorType.NOTFOUNDED)};s.src=r(t)}.bind(n._image))}};n.getImage=function(t,e){var r=this;return new Promise(function(n,o){if(r.cacheHost.is(t))r.cacheHost.getAction(t).then(function(i){r._image.getImgTagByAction(t,e,i).then(function(t){n(t)},function(t){o(t)})});else{var i=r.cacheHost.addKey(t);i._actionPromise=new Promise(function(s,f){var h=function(t,e){i.action=e.bind(r);s(i.action);n(t)};if(r._isSameOrigin(t))r._image.getImgTag(t,e).then(function(t){h(t,r._actionDirect)},function(t){o(t)});else if(r._isSecureURL(t)){(e?r._image.getImgTag(t,e):r._image.getImgTag(t)).then(function(t){h(t,r._actionDirect)},function(n){e&&n===r._image.ErrorType.CORS||r._isServiceWorker()||r._isSecureURL(r._location)&&r.preventMixedContent?c.call(r,t,e,h,o):u.call(r,t,e,h,o)})}else if(r._isServiceWorker()||r._isSecureURL(r._location)&&r.preventMixedContent)a.call(r,t,e,h,o);else{(e?r._image.getImgTag(t,e):r._image.getImgTag(t)).then(function(t){h(t,r._actionDirect)},function(n){e&&n===r._image.ErrorType.CORS||!r._isSecureURL(r._location)?c.call(r,t,e,h,o):a.call(r,t,e,h,o)})}})}})}}();