TC.control=TC.control||{};TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control");TC.Consts.event.POINT="point.tc";TC.control.Measure=function(){var e=this;TC.Control.apply(e,arguments);e.drawControls=[];e.persistentDrawControls=!1;e.NOMEASURE="-";this.renderPromise().then(function(){e.measureMode=e.options.mode;e.history=[];e.historyIndex=0;e.reset=!0;e.wrap=new TC.wrap.control.Measure(e);e._$len=e._$div.find(".tc-ctl-meas-val-len");e._$area=e._$div.find(".tc-ctl-meas-val-area");e._$peri=e._$div.find(".tc-ctl-meas-val-peri");e.setMode(e.options.mode)})};TC.inherit(TC.control.Measure,TC.Control);!function(){var e=TC.control.Measure.prototype;e.CLASS="tc-ctl-meas";TC.isDebug?e.template=TC.apiLocation+"TC/templates/Measure.html":e.template=function(){dust.register(e.CLASS,t);function t(e,t){return e.w("<h2>").h("i18n",t,{},{$key:"measure"}).w('</h2><div class="tc-ctl-meas-select"><form><label class="tc-ctl-meas-btn-len"><input type="radio" name="mode" value="polyline" /><span>').h("i18n",t,{},{$key:"length"}).w('</span></label><label class="tc-ctl-meas-btn-area"><input type="radio" name="mode" value="polygon" /><span>').h("i18n",t,{},{$key:"areaAndPerimeter"}).w('</span></label></form></div><div class="tc-ctl-meas-mode tc-ctl-meas-len tc-hidden"><div class="tc-ctl-meas-line"></div><div class="tc-ctl-meas-txt">').h("i18n",t,{},{$key:"length"}).w(': <span class="tc-ctl-meas-val-len"></span></div></div><div class="tc-ctl-meas-mode tc-ctl-meas-area tc-hidden"><div class="tc-ctl-meas-polygon"></div><div class="tc-ctl-meas-txt">').h("i18n",t,{},{$key:"area"}).w(': <span class="tc-ctl-meas-val-area"></span>, ').h("i18n",t,{},{$key:"perimeter"}).w(': <span class="tc-ctl-meas-val-peri"></span></div></div>')}t.__dustBody=!0;return t};e.render=function(e){var t=this;TC.Control.prototype.render.call(t,function(){TC.loadJS(!TC.control.Draw,TC.apiLocation+"TC/control/Draw",function(){t.options.mode&&t._$div.find(".tc-ctl-meas-select").addClass(TC.Consts.classes.HIDDEN);t._$div.find("span").on(TC.Consts.event.CLICK,function(e){var s=$(this).closest("label").find("input[type=radio][name=mode]"),n=s.val();s.prop("checked",!0);t.setMode(n,!0)});$.isFunction(e)&&e()})})};e.register=function(e){const t=this;TC.Control.prototype.register.call(t,e);const s=t.getUID(),n=t.getUID(),o=t.getUID();t.layerPromise=e.addLayer({id:s,title:t.getLocaleString("measure"),stealth:!0,type:TC.Consts.layerType.VECTOR,styles:{point:e.options.styles.point,line:e.options.styles.line,polygon:e.options.styles.polygon}});$.when(t.layerPromise,t.renderPromise()).then(function(s){t.layer=s;t.layer.map.putLayerOnTop(t.layer);t._drawLinesPromise=e.addControl("draw",{id:n,div:t._$div.find(".tc-ctl-meas-line"),mode:TC.Consts.geom.POLYLINE,measure:!0,persistent:t.persistentDrawControls,styleTools:t.persistentDrawControls,layer:t.layer});t._drawPolygonsPromise=e.addControl("draw",{id:o,div:t._$div.find(".tc-ctl-meas-polygon"),mode:TC.Consts.geom.POLYGON,measure:!0,persistent:t.persistentDrawControls,styleTools:t.persistentDrawControls,layer:t.layer});$.when(t._drawLinesPromise,t._drawPolygonsPromise).then(function(e,s){t.drawLines=e;t.drawPolygons=s;[e,s].forEach(function(e){e.containerControl=t;t.drawControls.push(e);e.$events.on(TC.Consts.event.MEASURE+" "+TC.Consts.event.MEASUREPARTIAL,function(e){t.showMeasures(e)}).on(TC.Consts.event.DRAWCANCEL,function(e){t.cancel()});e.exportsState=!1});t.setMode(t.options.mode)})})};e.displayMode=function(e){const t=this,s=t._$div.find(".tc-ctl-meas-mode");switch(e){case TC.Consts.geom.POLYLINE:t._$activeMode=s.filter(".tc-ctl-meas-len");break;case TC.Consts.geom.POLYGON:t._$activeMode=s.filter(".tc-ctl-meas-area");break;case null:case void 0:t._$activeMode=$()}const n=s.not(t._$activeMode);e?t._$div.find("input[type=radio][name=mode][value="+e+"]").prop("checked",!0).addClass(TC.Consts.classes.CHECKED).next().addClass(TC.Consts.classes.CHECKED):t._$div.find("input[type=radio][name=mode]").prop("checked",!1).removeClass(TC.Consts.classes.CHECKED).next().removeClass(TC.Consts.classes.CHECKED);t._$activeMode.removeClass(TC.Consts.classes.HIDDEN);t._$activeMode.find(".tc-ctl").removeClass(TC.Consts.classes.COLLAPSED);n.addClass(TC.Consts.classes.HIDDEN);return t};e.setMode=function(e){const t=this;t.mode=e;t.displayMode(e);var s;switch(e){case TC.Consts.geom.POLYLINE:t.drawLines.activate();s=TC.Consts.event.CONTROLACTIVATE;break;case TC.Consts.geom.POLYGON:t.drawPolygons.activate();s=TC.Consts.event.CONTROLACTIVATE;break;case null:case void 0:t.drawControls.forEach(function(e){e.isActive&&e.cancel()});s=TC.Consts.event.CONTROLDEACTIVATE;break;default:s=TC.Consts.event.CONTROLACTIVATE}t.resetValues();s&&t.map&&t.map.$events.trigger($.Event(s,{control:t}));return t};e.cancel=function(){this.setMode(null,!1);return this};e.showMeasures=function(e){const t=this;var s,n=(e=e||{}).units;const o=t.map.options.locale||TC.Cfg.locale;if(e.area){var a=e.area;if(a>1e4){a/=1e6;n="km"}s="m"===n?0:3;t._$area.html(TC.Util.formatNumber(a.toFixed(s),o)+" "+n+"&sup2;")}if(e.perimeter){var r=e.perimeter;if(r>1e3){r/=1e3;n="km"}s="m"===n?0:3;t._$peri.html(TC.Util.formatNumber(r.toFixed(s),o)+" "+n)}if(e.length){var i=e.length;if(i>1e3){i/=1e3;n="km"}s="m"===n?0:3;t._$len.html(TC.Util.formatNumber(i.toFixed(s),o)+" "+n)}return t};e.resetValues=function(){const e=this;if(e._$len){e._$len.text(e.NOMEASURE);e._$area.text(e.NOMEASURE);e._$peri.text(e.NOMEASURE)}return e};e.getDrawLines=function(){};e.exportState=function(){return{id:this.id,layer:this.layer.exportState()}};e.importState=function(e){this.layerPromise.then(function(t){t.importState(e.layer)})}}();