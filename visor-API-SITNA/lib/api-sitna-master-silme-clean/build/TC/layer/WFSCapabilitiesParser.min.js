function xml2json(e){var t={toObj:function(e){var r={};if(1==e.nodeType){if(e.attributes.length)for(var n=0;n<e.attributes.length;n++)"name"!==e.attributes[n].nodeName&&(r[e.attributes[n].nodeName]=(e.attributes[n].nodeValue||"").toString());if(e.firstChild){for(var i=0,a=0,s=!1,o=e.firstChild;o;o=o.nextSibling)1==o.nodeType?s=!0:3==o.nodeType&&o.nodeValue.match(/[^ \f\n\r\t\v]/)?i++:4==o.nodeType&&a++;if(s)if(2>i&&2>a){t.removeWhite(e);for(o=e.firstChild;o;o=o.nextSibling){var l=t.removePrefix(o.nodeName);if(3==o.nodeType)r["#text"]=t.escape(o.nodeValue);else if(4==o.nodeType)r["#cdata"]=t.escape(o.nodeValue);else if(r[l])r[l]instanceof Array?r[l][r[l].length]=t.toObj(o):r[l]=[r[l],t.toObj(o)];else{var u=null;o.attributes.getNamedItem("name")&&(u=o.attributes.getNamedItem("name").nodeValue),r[u||l]=t.toObj(o)}}}else e.attributes.length?r["#text"]=t.escape(t.innerXml(e)):r=t.escape(t.innerXml(e));else if(i)e.attributes.length?r["#text"]=t.escape(t.innerXml(e)):r=t.escape(t.innerXml(e));else if(a)if(a>1)r=t.escape(t.innerXml(e));else for(o=e.firstChild;o;o=o.nextSibling)r["#cdata"]=t.escape(o.nodeValue)}e.attributes.length||e.firstChild||(r=null)}else 9==e.nodeType?r=t.toObj(e.documentElement):8==e.nodeType?console.log(e.textContent):alert("unhandled node type: "+e.nodeType);return r},toJson:function(e,r,n){var i=r?'"'+r+'"':"";if(e instanceof Array){for(var a=0,s=e.length;s>a;a++)e[a]=t.toJson(e[a],"",n+"\t");i+=(r?":[":"[")+(e.length>1?"\n"+n+"\t"+e.join(",\n"+n+"\t")+"\n"+n:e.join(""))+"]"}else if(null==e)i+=(r&&":")+"null";else if("object"==typeof e){var o=[];for(var l in e)o[o.length]=t.toJson(e[l],l,n+"\t");i+=(r?":{":"{")+(o.length>1?"\n"+n+"\t"+o.join(",\n"+n+"\t")+"\n"+n:o.join(""))+"}"}else i+="string"==typeof e?(r&&":")+'"'+e.toString()+'"':(r&&":")+e.toString();return i},innerXml:function(e){var t="";if("innerHTML"in e)t=e.innerHTML;else for(var r=function(e){var t="";if(1==e.nodeType){t+="<"+e.nodeName;for(var n=0;n<e.attributes.length;n++)t+=" "+e.attributes[n].nodeName+'="'+(e.attributes[n].nodeValue||"").toString()+'"';if(e.firstChild){t+=">";for(var i=e.firstChild;i;i=i.nextSibling)t+=r(i);t+="</"+e.nodeName+">"}else t+="/>"}else 3==e.nodeType?t+=e.nodeValue:4==e.nodeType&&(t+="<![CDATA["+e.nodeValue+"]]>");return t},n=e.firstChild;n;n=n.nextSibling)t+=r(n);return t},escape:function(e){return e.replace(/[\\]/g,"\\\\").replace(/[\"]/g,'\\"').replace(/[\n]/g,"\\n").replace(/[\r]/g,"\\r")},removeWhite:function(e){e.normalize();for(var r=e.firstChild;r;)if(3==r.nodeType)if(r.nodeValue.match(/[^ \f\n\r\t\v]/))r=r.nextSibling;else{var n=r.nextSibling;e.removeChild(r),r=n}else 1==r.nodeType?(t.removeWhite(r),r=r.nextSibling):r=r.nextSibling;return e},removePrefix:function(e){return e.substring(e.indexOf(":")+1)}};return 9==e.nodeType&&(e=e.documentElement),t.toObj(t.removeWhite(e))}var WFSCapabilities=function(){var e="1.0.0",t="1.1.0",r="2.0.0",n=function(n,i){switch(i){case e:var a=n.Capability.Request;if(a.GetFeature){var s=[];for(var o in a.GetFeature.ResultFormat)s.push(o.toLowerCase());a.GetFeature.outputFormat=s,delete a.GetFeature.ResultFormat,a.GetFeature.Operations=n.FeatureTypeList.Operations}return a;case t:return{};case r:var l={};for(var o in n.OperationsMetadata){var u={};u[o]=n.OperationsMetadata[o];for(var f in u[o])u[o][f]&&u[o][f].hasOwnProperty("AllowedValues")&&(u[o][f]=u[o][f].AllowedValues.Value);$.extend(l,u)}return l}return null},i=function(n,i){switch(i){case e:for(var a={},s=0;s<n.FeatureTypeList.FeatureType.length;s++){a[(o=n.FeatureTypeList.FeatureType[s].Name).substring(o.indexOf(":")+1)]=n.FeatureTypeList.FeatureType[s]}return a;case t:return{};case r:for(a={},s=0;s<n.FeatureTypeList.FeatureType.length;s++){var o;a[(o=n.FeatureTypeList.FeatureType[s].Name).substring(o.indexOf(":")+1)]=n.FeatureTypeList.FeatureType[s]}return a}return null},a=function(n,i){switch(i){case e:return n.Filter_Capabilities;case t:return{};case r:return n.Filter_Capabilities}return null},s=function(n,i){switch(i){case e:var a={};for(var s in n)"string"==typeof n[s]&&(a[s]=n[s]);return a;case t:return{};case r:a={};for(var s in n)"string"==typeof n[s]&&(a[s]=n[s]);return a}return{}};return{Promises:function(e){e=e;var t=$.Deferred(),r=e.substring(e.indexOf("://")<0?0:e.indexOf("://")+3);if(TC.capabilities[r])return t.resolve(TC.capabilities[r]),t;var n={SERVICE:"WFS",VERSION:"2.0.0",REQUEST:"GetCapabilities"};return $.ajax({url:TC.proxify(e)+"?"+$.param(n),type:"GET"}).then(function(){var e=WFSCapabilities.Parse(arguments[0]),n=e.Operations.GetCapabilities.DCP&&e.Operations.GetCapabilities.DCP.HTTP.Get["xlink:href"]||e.Operations.GetCapabilities.DCPType[0].HTTP.Get.onlineResource;TC.capabilities[n]=e,TC.capabilities[r]=e,t.resolve(WFSCapabilities.Parse(arguments[0]))}),t},Parse:function(){var o,l,u,f,p=xml2json(arguments[0]);switch(p.version){case e:o=e;break;case t:o=t;break;case r:o=r}l=n(p,o),u=i(p,o),f=a(p,o);var c=s(p,o),d={Operations:l,FeatureTypes:u,Filters:f};return $.extend(d,c),d}}}();