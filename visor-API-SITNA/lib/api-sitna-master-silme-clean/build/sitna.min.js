var SITNA=window.SITNA||{},TC=window.TC||{};TC.isDebug=!1;!function(){if(!window.TC||!window.TC.Cfg){if(document.currentScript)o=document.currentScript;else{var e=document.getElementsByTagName("script");o=e[e.length-1]}var a=o.getAttribute("src");TC.apiLocation=a.substr(0,a.lastIndexOf("/")+1);var t=TC.apiLocation+(TC.isDebug?"tcmap.js":"tcmap.min.js"),r=new XMLHttpRequest;r.open("GET",t,!1);r.send(null);var o,n=document.getElementsByTagName("head")[0];(o=document.createElement("script")).type="text/javascript";o.text=r.responseText;n.appendChild(o)}}();SITNA.Consts=TC.Consts;SITNA.Cfg=TC.Cfg;SITNA.Cfg.layout=TC.apiLocation+"TC/layout/responsive";SITNA.Map=function(e,a){var t=this;TC.Cfg.controls.search.allowedSearchTypes=$.extend(TC.Cfg.controls.search.allowedSearchTypes,{urban:{},street:{},number:{},cadastral:{}});if(a&&a.controls&&a.controls.search){var r=Object.keys(a.controls.search),o=$.extend(a.controls.search,{allowedSearchTypes:{}});r.forEach(function(e){if("boolean"==typeof a.controls.search[e]||$.isPlainObject(a.controls.search[e])){if(a.controls.search[e])switch(!0){case"postalAddress"===e:o.allowedSearchTypes[TC.Consts.searchType.NUMBER]=$.isPlainObject(a.controls.search[e])?a.controls.search[e]:{};break;case"cadastralParcel"===e:o.allowedSearchTypes[TC.Consts.searchType.CADASTRAL]=$.isPlainObject(a.controls.search[e])?a.controls.search[e]:{};break;case"town"===e:o.allowedSearchTypes[TC.Consts.searchType.URBAN]=$.isPlainObject(a.controls.search[e])?a.controls.search[e]:{};break;default:o.allowedSearchTypes[e]=$.isPlainObject(a.controls.search[e])?a.controls.search[e]:{}}delete o[e]}});a.controls.search=o}var n,s,l=new TC.Map(e,a);t.addLayer=function(e,a){l.addLayer(e,a)};t.setBaseLayer=function(e,a){l.setBaseLayer(e,a)};t.addMarker=function(e,a){l.addMarker(e,a)};t.zoomToMarkers=function(e){l.zoomToMarkers(e)};t.loaded=function(e){l.loaded(e)};l.loaded(function(){TC.loadJS(!TC.control.Search,TC.apiLocation+"TC/control/Search",function(){(n=new TC.control.Search).register(l);n.getLayer().then(function(e){s=e})});if(!l.activeControl){var e=l.getControlsByClass("TC.control.FeatureInfo")[0];e&&e.activate()}});t.getQueryableData=function(e,a){var t=n.availableSearchTypes[e];if(t.queryableData)a&&a(t.queryableData);else{var r={request:"GetFeature",service:"WFS",typename:t.featurePrefix+":"+t.featureType,version:t.version,propertyname:(t.dataIdProperty instanceof Array?t.dataIdProperty:[t.dataIdProperty]).concat(t.outputProperties instanceof Array?t.outputProperties:[t.outputProperties]).join(","),outputformat:TC.Consts.format.JSON},o=t.url+"?"+$.param(r);$.ajax({url:o}).done(function(e){t.queryableData=[];if(e.features)for(var r=e.features,o=0;o<r.length;o++){var s=r[o];e={id:[]};t.dataIdProperty instanceof Array||(t.dataIdProperty=[t.dataIdProperty]);for(var l=0;l<t.dataIdProperty.length;l++)s.properties.hasOwnProperty(t.dataIdProperty[l])&&e.id.push(s.properties[t.dataIdProperty[l]]);e.id=t.idPropertiesIdentifier?e.id.join(t.idPropertiesIdentifier):e.id.join("");e.label=[];t.outputProperties instanceof Array||(t.outputProperties=[t.outputProperties]);for(var i=0;i<t.outputProperties.length;i++)s.properties.hasOwnProperty(t.outputProperties[i])&&e.label.push(s.properties[t.outputProperties[i]]);var c=e.label instanceof Array&&e.label.join("").trim().length>0||!(e.label instanceof Array)&&e.label.trim().length>0;e.label=t.outputFormatLabel?t.outputFormatLabel.tcFormat(e.label):e.label.join("-");c&&t.queryableData.push(e)}t.queryableData=t.queryableData.sort(function(e,a){return t.idPropertiesIdentifier&&-1==e.id.indexOf(t.idPropertiesIdentifier)?n.removePunctuation(e.label)<n.removePunctuation(a.label)?-1:n.removePunctuation(e.label)>n.removePunctuation(a.label)?1:0:n.removePunctuation(e.label.split(" ")[0])<n.removePunctuation(a.label.split(" ")[0])?-1:n.removePunctuation(e.label.split(" ")[0])>n.removePunctuation(a.label.split(" ")[0])?1:0});t.queryableData=t.queryableData.filter(function(e,a,t){return a<1||e.id!==t[a-1].id&&e.label!==t[a-1].label});a&&a(t.queryableData)})}};t.getMunicipalities=function(e){t.getQueryableData(SITNA.Consts.mapSearchType.MUNICIPALITY,e)};t.getUrbanAreas=function(e){t.getQueryableData(SITNA.Consts.mapSearchType.URBAN,e)};t.getCommonwealths=function(e){t.getQueryableData(SITNA.Consts.mapSearchType.COMMONWEALTH,e)};t.getCouncils=function(e){t.getQueryableData(SITNA.Consts.mapSearchType.COUNCIL,e)};t.searchCommonwealth=function(e,a){t.searchTyped(SITNA.Consts.mapSearchType.COMMONWEALTH,e,a)};t.searchCouncil=function(e,a){t.searchTyped(SITNA.Consts.mapSearchType.COUNCIL,e,a)};t.searchUrbanArea=function(e,a){t.searchTyped(SITNA.Consts.mapSearchType.URBAN,e,a)};t.searchMunicipality=function(e,a){t.searchTyped(SITNA.Consts.mapSearchType.MUNICIPALITY,e,a)};t.searchTyped=function(e,a,r){var o=TC.getUID(),i=n.availableSearchTypes[e];a instanceof Array&&i.goToIdFormat&&(a=i.goToIdFormat.tcFormat(a));n._search.data=n._search.data||[];n._search.data.push({dataLayer:i.featureType,dataRole:e,id:a,label:"",text:""});t.removeSearch();if(n.availableSearchTypes[e]&&!n.getSearchTypeByRole(e)){n.availableSearchTypes[e].goTo||(n.availableSearchTypes[e].goTo=function(e){var a=function(e){TC.filter||TC.syncLoadJS(TC.apiLocation+"TC/Filter");var a=[];i.idPropertiesIdentifier&&(e=e.split(i.idPropertiesIdentifier));e instanceof Array||(e=[e]);for(var t=0;t<i.dataIdProperty.length;t++)a.push(new TC.filter.equalTo(i.dataIdProperty[t],$.trim(e[t])));return a=a.length>1?new TC.filter.and(a):a[0]}(e);return{params:{type:TC.Consts.layerType.WFS,url:this.url,version:this.version,geometryName:this.geometryName,featurePrefix:this.featurePrefix,featureType:this.featureType,properties:a,outputFormat:this.outputFormat,styles:this.styles}}}.bind(i));n.addAllowedSearchType(e,n.availableSearchTypes[e],n)}l.one(TC.Consts.event.SEARCHQUERYEMPTY,function(e){l.toast(n.EMPTY_RESULTS_LABEL,{type:TC.Consts.msgType.INFO,duration:5e3});r&&r(null)});l.one(TC.Consts.event.FEATURESADD,function(a){a.layer==s&&a.layer.features&&a.layer.features.length>0&&l.zoomToFeatures(a.layer.features);t.search={layer:a.layer,type:e};r&&r(a.layer.id!==o?a.layer.id:o)});n.goToResult(a,e)};t.searchFeature=function(e,a,r,o){var s=TC.getUID(),i=n.featurePrefix;t.removeSearch();e=(e||"").trim();a=(a||"").trim();r=(r||"").trim();if(0==e.length||0==a.length||0==r.length){l.toast(n.EMPTY_RESULTS_LABEL,{type:TC.Consts.msgType.INFO,duration:5e3});o&&o(null)}else{if(e.indexOf(":")>-1){i=e.split(":")[0];e=e.split(":")[1]}var c,u={id:s,type:SITNA.Consts.layerType.WFS,url:n.url,version:n.version,stealth:!0,geometryName:"the_geom",featurePrefix:i,featureType:e,maxFeatures:1,properties:function(e){TC.filter||TC.syncLoadJS(TC.apiLocation+"TC/Filter");if(e&&e instanceof Array){var a=e.map(function(e){if(!e.hasOwnProperty("type"))return new TC.filter.equalTo(e.name,e.value);switch(!0){case e.type==TC.Consts.comparison.EQUAL_TO:return new TC.filter.equalTo(e.name,e.value)}});return a.length>1?TC.filter.and.apply(null,a):a[0]}}([{name:a,value:r,type:TC.Consts.comparison.EQUAL_TO}]),outputFormat:TC.Consts.format.JSON};l.addLayer(u).then(function(e){c=e;t.search={layer:e,type:SITNA.Consts.mapSearchType.GENERIC}});l.on(TC.Consts.event.FEATURESADD,function(e){if(e.layer==c&&e.layer.features&&e.layer.features.length>0){for(var a=0;a<e.layer.features.length;a++)e.layer.features[a].showsPopup!=n.queryableFeatures&&(e.layer.features[a].showsPopup=n.queryableFeatures);l.zoomToFeatures(e.layer.features)}});l.on(TC.Consts.event.LAYERUPDATE,function(e){e.layer==c&&e.newData&&e.newData.features&&0==e.newData.features.length&&l.toast(n.EMPTY_RESULTS_LABEL,{type:TC.Consts.msgType.INFO,duration:5e3});o&&o(e.layer==c&&e.newData&&e.newData.features&&0==e.newData.features.length?null:s)})}};t.removeSearch=function(e){if(t.search)if(n.availableSearchTypes[t.search.type]&&n.availableSearchTypes[t.search.type].hasOwnProperty("goTo")){for(var a=0;a<t.search.layer.features.length;a++)t.search.layer.removeFeature(t.search.layer.features[a]);t.search=null}else l.removeLayer(t.search.layer).then(function(){t.search=null});e&&e()};t.exportImage=function(){return l.exportImage()};t.search=null};